<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel åœ–æ¸¬è©¦é é¢</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .image-container {
            margin: 10px 0;
            padding: 10px;
            background: #fafafa;
            border: 1px dashed #ccc;
        }
        img {
            max-width: 100%;
            border: 1px solid #ddd;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        .info {
            background: #e3f2fd;
            padding: 10px;
            border-left: 4px solid #2196F3;
            margin: 10px 0;
        }
        select, input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        pre {
            background: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .controls {
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š Panel è£æ¿åœ–æ¸¬è©¦é é¢</h1>

        <div class="info">
            <strong>æ¸¬è©¦ç›®çš„ï¼š</strong>é€æ­¥é©—è­‰ Panel åœ–çš„ MapData è§£æå’Œæ¸²æŸ“åŠŸèƒ½
        </div>

        <div class="controls">
            <h3>é¸æ“‡æ¸¬è©¦æ–™è™Ÿï¼š</h3>
            <select id="partNumSelect">
                <option value="A03270008A/0">A03270008A/0 (æœ‰å®Œæ•´3ç¨®åœ–)</option>
                <option value="A041G0127C/0">A041G0127C/0 (æœ‰2ç¨®åœ–)</option>
            </select>

            <h3>åœ–ç‰‡å°ºå¯¸ï¼š</h3>
            <label>å¯¬åº¦: <input type="number" id="width" value="1200" min="400" max="2000" step="100"></label>
            <label>é«˜åº¦: <input type="number" id="height" value="800" min="300" max="1500" step="100"></label>

            <br><br>
            <button onclick="loadTestImage()">ğŸ”„ é‡æ–°è¼‰å…¥æ¸¬è©¦åœ–</button>
            <button onclick="loadCurrentImage()">ğŸ–¼ï¸ è¼‰å…¥ç•¶å‰å¯¦ä½œçš„åœ–</button>
            <button onclick="analyzeMapData()">ğŸ” åˆ†æ MapData</button>
        </div>

        <div class="test-section">
            <h2>1ï¸âƒ£ æ¸¬è©¦ç”¨è£æ¿åœ– (ç†æƒ³æ•ˆæœ)</h2>
            <p>é€™æ˜¯ç”¨ç¡¬ç·¨ç¢¼è³‡æ–™ç”¢ç”Ÿçš„æ¸¬è©¦åœ–ï¼Œé¡¯ç¤ºæ¸²æŸ“å¼•æ“æ˜¯æ­£å¸¸çš„</p>
            <div class="image-container">
                <img id="testImage" src="/test/panel" alt="æ¸¬è©¦åœ–">
            </div>
        </div>

        <div class="test-section">
            <h2>2ï¸âƒ£ ç•¶å‰å¯¦ä½œçš„åœ– (å¾è³‡æ–™åº«è®€å–)</h2>
            <p id="currentImageStatus">è¼‰å…¥ä¸­...</p>
            <div class="image-container">
                <img id="currentImage" alt="ç•¶å‰å¯¦ä½œ">
            </div>
        </div>

        <div class="test-section">
            <h2>3ï¸âƒ£ MapData åˆ†æçµæœ</h2>
            <button onclick="toggleAnalysis()">é¡¯ç¤º/éš±è— è©³ç´°åˆ†æ</button>
            <div id="analysisResult" style="display:none;">
                <pre id="analysisContent">é»æ“Šã€Œåˆ†æ MapDataã€æŒ‰éˆ•ä¾†æŸ¥çœ‹è©³ç´°è³‡è¨Š</pre>
            </div>
        </div>

        <div class="test-section">
            <h2>4ï¸âƒ£ MapData åŸå§‹è³‡æ–™é è¦½</h2>
            <button onclick="toggleRawData()">é¡¯ç¤º/éš±è— åŸå§‹è³‡æ–™</button>
            <div id="rawDataResult" style="display:none;">
                <pre id="rawDataContent">é»æ“Šã€Œåˆ†æ MapDataã€å¾Œæœƒé¡¯ç¤ºåŸå§‹è³‡æ–™</pre>
            </div>
        </div>
    </div>

    <script>
        let currentPartNum = 'A03270008A';
        let currentRevision = '0';

        // è§£æé¸æ“‡çš„æ–™è™Ÿ
        document.getElementById('partNumSelect').addEventListener('change', function() {
            const selected = this.value.split('/');
            currentPartNum = selected[0];
            currentRevision = selected[1];
            loadCurrentImage();
        });

        // è¼‰å…¥æ¸¬è©¦åœ–
        function loadTestImage() {
            const img = document.getElementById('testImage');
            img.src = '/test/panel?' + new Date().getTime(); // åŠ ä¸Šæ™‚é–“æˆ³é¿å…å¿«å–
        }

        // è¼‰å…¥ç•¶å‰å¯¦ä½œçš„åœ–
        function loadCurrentImage() {
            const width = document.getElementById('width').value;
            const height = document.getElementById('height').value;
            const img = document.getElementById('currentImage');
            const status = document.getElementById('currentImageStatus');

            const url = `/api/mappreview/${currentPartNum}/${currentRevision}/panel?width=${width}&height=${height}`;

            status.textContent = `è¼‰å…¥ä¸­... (${currentPartNum}/${currentRevision})`;
            img.src = url + '&t=' + new Date().getTime();

            img.onload = function() {
                status.textContent = `âœ… å·²è¼‰å…¥ ${currentPartNum}/${currentRevision} - ${width}x${height}`;
            };

            img.onerror = function() {
                status.textContent = `âŒ è¼‰å…¥å¤±æ•—`;
            };
        }

        // åˆ†æ MapData
        async function analyzeMapData() {
            try {
                const url = `/api/mappreview/analyze/${currentPartNum}/${currentRevision}/panel`;
                const response = await fetch(url);
                const data = await response.json();

                // é¡¯ç¤ºåˆ†æçµæœ
                document.getElementById('analysisContent').textContent = JSON.stringify(data.report, null, 2);

                // é¡¯ç¤ºåŸå§‹è³‡æ–™é è¦½
                document.getElementById('rawDataContent').textContent =
                    `å®Œæ•´è³‡æ–™é•·åº¦: ${data.report.Length}\nè¡Œæ•¸: ${data.report.LineCount}\n\n` +
                    `é è¦½ (å‰ 500 å­—å…ƒ):\n${data.report.Preview}`;

                alert('âœ… MapData åˆ†æå®Œæˆï¼è«‹æŸ¥çœ‹ä¸‹æ–¹è©³ç´°è³‡è¨Š');
            } catch (error) {
                alert('âŒ åˆ†æå¤±æ•—: ' + error.message);
            }
        }

        function toggleAnalysis() {
            const div = document.getElementById('analysisResult');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        function toggleRawData() {
            const div = document.getElementById('rawDataResult');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥
        window.onload = function() {
            loadTestImage();
            loadCurrentImage();
        };
    </script>
</body>
</html>
