@page
@model PcbErpApi.Pages.PaperInfoModel
@{
    ViewData["Title"] = "單據設定-單據資訊-表單設定";
    Layout = "_Layout";
}

<style>
  .paper-container {
    display: flex;
    gap: 20px;
    height: calc(100vh - 80px);
    padding: 16px;
  }

  .system-tree {
    width: 240px;
    background: white;
    padding: 16px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow-y: auto;
  }

  .system-tree h4 {
    margin-bottom: 12px;
    color: #1f3a8a;
    font-size: 16px;
  }

  .system-tree .filter-check {
    margin-bottom: 12px;
    padding: 6px 8px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
  }

  .system-tree .filter-check label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #475569;
    cursor: pointer;
    margin: 0;
  }

  .system-tree .filter-check input[type="checkbox"] {
    width: 14px;
    height: 14px;
    cursor: pointer;
  }

  .system-tree ul {
    list-style: none;
    padding-left: 0;
  }

  .system-tree ul ul {
    margin-left: 12px;
    display: none;
  }

  .system-tree ul ul.show {
    display: block;
  }

  .system-tree a {
    text-decoration: none;
    color: #334155;
    padding: 4px 6px;
    display: block;
    border-radius: 4px;
    transition: background 0.2s;
    font-size: 13px;
  }

  .system-tree a:hover {
    background: #f1f5f9;
    color: #1f3a8a;
  }

  .system-tree a.active {
    background: #e0e7ff;
    color: #1f3a8a;
    font-weight: 600;
  }

  .toggle-icon {
    display: inline-block;
    margin-right: 4px;
    transition: transform 0.2s;
    font-size: 11px;
  }

  .toggle-icon.expanded {
    transform: rotate(90deg);
  }

  .paper-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .paper-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
  }

  .paper-toolbar h4 {
    margin: 0;
    color: #1f3a8a;
    font-size: 18px;
  }

  .paper-table-container {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
  }

  .paper-table {
    width: auto;
    min-width: 60%;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .paper-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #f1f5f9;
  }

  .paper-table th {
    padding: 0 8px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    color: #1e293b;
    border-bottom: 2px solid #cbd5e1;
    border-right: 1px solid #e2e8f0;
    white-space: nowrap;
  }

  .paper-table th:last-child {
    border-right: none;
  }

  .paper-table tbody tr {
    cursor: pointer;
    transition: background-color 0.15s;
  }

  .paper-table tbody tr:hover {
    background-color: #f8fafc;
  }

  .paper-table tbody tr.active,
  .paper-table tbody tr.selected-print {
    background-color: #eff6ff;
    border-left: 3px solid #3b82f6;
  }

  .paper-table td {
    padding: 0 8px;
    border-bottom: 1px solid #e2e8f0;
    border-right: 1px solid #f1f5f9;
    font-size: 13px;
    color: #334155;
  }

  .paper-table td:last-child {
    border-right: none;
  }

  .paper-table tbody tr:last-child td {
    border-bottom: none;
  }

  .paper-table .text-center {
    text-align: center;
  }

  .paper-table .bi-check-square-fill {
    font-size: 16px;
  }

  .paper-table .bi-square {
    font-size: 16px;
    color: #94a3b8;
  }

  .modal-xl {
    max-width: 1200px;
  }

  .tab-content {
    padding: 20px;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }

  .form-grid .full-width {
    grid-column: 1 / -1;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
  }

  .data-table th {
    background: #f1f5f9;
    padding: 8px;
    text-align: left;
    font-weight: 600;
    border: 1px solid #e2e8f0;
    font-size: 13px;
  }

  .data-table td {
    padding: 6px 8px;
    border: 1px solid #e2e8f0;
  }

  .data-table input,
  .data-table select {
    width: 100%;
    padding: 4px 8px;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    font-size: 13px;
  }

  .data-table input:focus,
  .data-table select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
  }

  /* 確保非active的tab不會阻擋點擊 */
  .tab-pane:not(.show) {
    display: none !important;
  }

  /* 表格內的輸入框無邊框樣式 */
  .paper-table input[type="text"],
  .paper-table input[type="number"],
  .paper-table .form-control {
    border: none !important;
    background: transparent !important;
    padding: 0 !important;
    width: 100%;
    outline: none;
    font-size: 13px;
    color: #334155;
    box-shadow: none !important;
  }

  .paper-table input[type="text"]:focus,
  .paper-table input[type="number"]:focus,
  .paper-table .form-control:focus {
    background: #f8fafc !important;
    outline: 1px solid #3b82f6;
    outline-offset: -1px;
  }
</style>

<div class="paper-container">
  <!-- 左側系統模組樹 -->
  <div class="system-tree">
    <h4>系統模組</h4>
    <div class="filter-check">
      <label>
        <input type="checkbox" id="chkFilterBySystem" @(Model.SelectedSystemId != null ? "checked" : "") onchange="toggleSystemFilter()">
        系統查詢
      </label>
    </div>
    <ul>
      @foreach (var module in Model.Modules)
      {
        var level1Id = "level1-" + module.ModuleId;
        var hasChildren = Model.SystemMap.ContainsKey(module.ModuleId);
        var shouldExpand = hasChildren && Model.SystemMap[module.ModuleId].Any(x => x.SystemId == Model.SelectedSystemId);

        <li>
          @if (hasChildren)
          {
            <a href="javascript:void(0)" onclick="toggleSystemChildren('@level1Id', this)">
              <span class="toggle-icon @(shouldExpand ? "expanded" : "")">▶</span>
              @module.DisplayName
            </a>
            <ul id="@level1Id" class="@(shouldExpand ? "show" : "")">
              @foreach (var system in Model.SystemMap[module.ModuleId])
              {
                var isActive = system.SystemId == Model.SelectedSystemId;
                <li>
                  <a href="/PaperInfo?SelectedSystemId=@system.SystemId" class="@(isActive ? "active" : "")">
                    @system.DisplayName
                  </a>
                </li>
              }
            </ul>
          }
          else
          {
            <a href="javascript:void(0)">@module.DisplayName</a>
          }
        </li>
      }
    </ul>
  </div>

  <!-- 右側主要內容 -->
  <div class="paper-main">
    <!-- 頁籤導航 -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist" style="padding: 12px 16px 0 16px; background: white;">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="encode-tab" data-bs-toggle="tab" data-bs-target="#encode-pane" type="button">
          單據編碼設定
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="print-tab" data-bs-toggle="tab" data-bs-target="#print-pane" type="button">
          單據列印設定
        </button>
      </li>
    </ul>

    <div class="tab-content" style="flex: 1; background: white; position: relative;">
      <!-- 第一個頁籤：單據編碼設定 -->
      <div class="tab-pane fade show active" id="encode-pane" role="tabpanel" style="height: 100%; display: flex; flex-direction: column; position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
        <div class="paper-toolbar">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addPaperInfo()" title="新增">
              <i class="bi bi-plus"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deletePaperInfo()" title="刪除">
              <i class="bi bi-dash"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="savePaperChanges()" title="儲存">
              <i class="bi bi-check"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cancelPaperChanges()" title="取消">
              <i class="bi bi-x"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshPaperList()" title="重整">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
        </div>

        <div class="paper-table-container">
      @if (Model.PaperInfos.Any())
      {
        <table class="paper-table" id="paperTable">
          <thead>
            <tr>
              <th style="width: 140px;">單據代碼</th>
              <th style="width: 180px;">單據名稱</th>
              <th style="width: 90px;">鎖定單據日期</th>
              <th style="width: 90px;">鎖定單據人</th>
              <th style="width: 80px;">作廢原因</th>
              <th style="width: 80px;">選擇類別</th>
            </tr>
          </thead>
          <tbody>
            @foreach (var paper in Model.PaperInfos)
            {
              <tr class="paper-row" data-paper-id="@paper.PaperId" onclick="selectPaperRow('@paper.PaperId', this)">
                <td>@paper.PaperId</td>
                <td>
                  <input type="text" class="form-control form-control-sm" value="@paper.PaperName"
                         data-field="paperName"
                         onclick="event.stopPropagation();"
                         onfocus="autoSelectPaperRow(this);" />
                </td>
                <td class="text-center">
                  <input type="checkbox" class="form-check-input"
                         @(paper.LockPaperDate == 1 ? "checked" : "")
                         data-field="lockPaperDate"
                         onclick="event.stopPropagation(); autoSelectPaperRow(this);" />
                </td>
                <td class="text-center">
                  <input type="checkbox" class="form-check-input"
                         @(paper.LockUserEdit == 1 ? "checked" : "")
                         data-field="lockUserEdit"
                         onclick="event.stopPropagation(); autoSelectPaperRow(this);" />
                </td>
                <td class="text-center">
                  <input type="checkbox" class="form-check-input"
                         @(paper.MustNotes == 1 ? "checked" : "")
                         data-field="mustNotes"
                         onclick="event.stopPropagation(); autoSelectPaperRow(this);" />
                </td>
                <td class="text-center">
                  <input type="checkbox" class="form-check-input"
                         @(paper.SelectType == 1 ? "checked" : "")
                         data-field="selectType"
                         onclick="event.stopPropagation(); autoSelectPaperRow(this);" />
                </td>
              </tr>
            }
          </tbody>
        </table>
      }
      else
      {
        <div class="text-center text-muted py-5">
          <i class="bi bi-inbox" style="font-size: 48px;"></i>
          <p class="mt-3">尚無單據資料</p>
        </div>
      }
        </div>
      </div>

      <!-- 第二個頁籤：單據列印設定 -->
      <div class="tab-pane fade" id="print-pane" role="tabpanel" style="height: 100%; display: flex; flex-direction: column; position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
        <div class="paper-toolbar">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addPrintSetting()" title="新增">
              <i class="bi bi-plus"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deletePrintSetting()" title="刪除">
              <i class="bi bi-dash"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="savePrintSettings()" title="儲存">
              <i class="bi bi-check"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cancelPrintChanges()" title="取消">
              <i class="bi bi-x"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshPrintSettings()" title="重整">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
        </div>

        <div class="paper-table-container">
          <table class="paper-table" id="printTable" style="width: auto;">
            <thead>
              <tr>
                <th style="width: 80px;">序號</th>
                <th style="width: 200px;">格式名稱</th>
                <th style="width: 80px;">啟用</th>
                <th style="width: 200px;">指定功能項目</th>
                <th style="width: 180px;">報表檔名</th>
                <th style="width: 180px;">報表程序</th>
              </tr>
            </thead>
            <tbody id="printTableBody">
              <!-- 將在 JavaScript 中動態填充 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 單據詳細資料 Modal -->
<div class="modal fade" id="paperDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">單據設定 - <span id="modalPaperId"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" id="paperTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic-pane" type="button">
              單據編碼設定
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="print-tab" data-bs-toggle="tab" data-bs-target="#print-pane" type="button">
              單據列印設定
            </button>
          </li>
        </ul>

        <div class="tab-content" id="paperTabContent">
          <!-- Tab 1: 基本資料 -->
          <div class="tab-pane fade show active" id="basic-pane" role="tabpanel">
            <div class="form-grid">
              <div>
                <label class="form-label">單據代號</label>
                <input type="text" class="form-control" id="editPaperId" readonly>
              </div>
              <div>
                <label class="form-label">單據名稱</label>
                <input type="text" class="form-control" id="editPaperName">
              </div>
              <div>
                <label class="form-label">系統別</label>
                <input type="text" class="form-control" id="editSystemId" readonly>
              </div>
              <div>
                <label class="form-label">編號方式</label>
                <select class="form-select" id="editEncodeWay">
                  <option value="0">方式 0</option>
                  <option value="1">方式 1</option>
                  <option value="2">方式 2</option>
                </select>
              </div>
              <div>
                <label class="form-label">單頭</label>
                <input type="text" class="form-control" id="editHeadFirst" maxlength="4">
              </div>
              <div>
                <label class="form-label">日期格式</label>
                <input type="text" class="form-control" id="editHeadDateFormat" maxlength="8">
              </div>
              <div>
                <label class="form-label">長度</label>
                <input type="number" class="form-control" id="editNumLength" min="1" max="10">
              </div>
              <div>
                <label class="form-label">年差</label>
                <input type="number" class="form-control" id="editYearDiff">
              </div>
              <div class="full-width">
                <label class="form-label">表單主檔</label>
                <input type="text" class="form-control" id="editTableName">
              </div>
              <div class="full-width">
                <label class="form-label">主鍵欄位</label>
                <input type="text" class="form-control" id="editPKName">
              </div>
              <div>
                <label class="form-check-label">
                  <input type="checkbox" class="form-check-input" id="editLockPaperDate">
                  鎖定單據日期
                </label>
              </div>
              <div>
                <label class="form-check-label">
                  <input type="checkbox" class="form-check-input" id="editLockUserEdit">
                  鎖定建單人
                </label>
              </div>
              <div>
                <label class="form-check-label">
                  <input type="checkbox" class="form-check-input" id="editMustNotes">
                  作廢原因必填
                </label>
              </div>
              <div>
                <label class="form-check-label">
                  <input type="checkbox" class="form-check-input" id="editRunFlow">
                  審核流程
                </label>
              </div>
              <div>
                <label class="form-check-label">
                  <input type="checkbox" class="form-check-input" id="editSelectType">
                  選取類型
                </label>
              </div>
            </div>

            <!-- 單據類型設定 -->
            <h6 class="mt-4 mb-3">單據類型</h6>
            <table class="data-table" id="paperTypeTable">
              <thead>
                <tr>
                  <th style="width: 80px;">類型</th>
                  <th>類型名稱</th>
                  <th style="width: 100px;">單頭</th>
                  <th style="width: 80px;">操作</th>
                </tr>
              </thead>
              <tbody id="paperTypeBody">
                <!-- 動態填充 -->
              </tbody>
            </table>
            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="addPaperTypeRow()">
              <i class="bi bi-plus"></i> 新增類型
            </button>
          </div>

          <!-- Tab 2: 列印設定 -->
          <div class="tab-pane fade" id="print-pane" role="tabpanel">
            <table class="data-table" id="paperPrintTable">
              <thead>
                <tr>
                  <th style="width: 80px;">序號</th>
                  <th style="width: 200px;">格式名稱</th>
                  <th style="width: 80px;">啟用</th>
                  <th>指定功能項目</th>
                </tr>
              </thead>
              <tbody id="paperPrintBody">
                <!-- 動態填充 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
        <button type="button" class="btn btn-primary" onclick="savePaperInfo()">儲存</button>
      </div>
    </div>
  </div>
</div>

<script>
  let selectedPaperId = null;

  // 切換系統模組子項目
  function toggleSystemChildren(id, linkEl) {
    const ul = document.getElementById(id);
    const icon = linkEl.querySelector('.toggle-icon');
    if (ul) {
      ul.classList.toggle('show');
      if (icon) icon.classList.toggle('expanded');
    }
  }

  // 切換系統篩選
  function toggleSystemFilter() {
    const checked = document.getElementById('chkFilterBySystem').checked;
    if (!checked) {
      // 取消篩選，顯示所有單據
      location.href = '/PaperInfo';
    }
  }

  // 選擇單據列
  function selectPaperRow(paperId, rowEl) {
    selectedPaperId = paperId;

    // 移除其他列的 active 狀態
    document.querySelectorAll('.paper-row').forEach(r => r.classList.remove('active'));

    // 添加當前列的 active 狀態
    rowEl.classList.add('active');

    // 載入該單據的列印設定到第二個頁籤
    loadPrintSettings(paperId);
  }

  // 當編輯欄位時自動選中該行
  function autoSelectPaperRow(element) {
    const row = element.closest('tr');
    if (row && row.classList.contains('paper-row')) {
      const paperId = row.getAttribute('data-paper-id');
      if (paperId && paperId !== selectedPaperId) {
        selectPaperRow(paperId, row);
      }
    }
  }

  // 載入單據詳細資料
  async function loadPaperDetail(paperId) {
    try {
      window.showBusy && window.showBusy('載入中...');

      const fetcher = window.busyFetch || fetch;
      const res = await fetcher(`/api/PaperInfo/${encodeURIComponent(paperId)}`);

      if (!res.ok) throw new Error('載入失敗');

      const data = await res.json();

      // 填充基本資料
      document.getElementById('modalPaperId').textContent = data.paperId;
      document.getElementById('editPaperId').value = data.paperId || '';
      document.getElementById('editPaperName').value = data.paperName || '';
      document.getElementById('editSystemId').value = data.systemId || '';
      document.getElementById('editEncodeWay').value = data.encodeWay || 0;
      document.getElementById('editHeadFirst').value = data.headFirst || '';
      document.getElementById('editHeadDateFormat').value = data.headDateFormat || '';
      document.getElementById('editNumLength').value = data.numLength || 0;
      document.getElementById('editYearDiff').value = data.yearDiff || 0;
      document.getElementById('editTableName').value = data.tableName || '';
      document.getElementById('editPKName').value = data.pkName || '';
      document.getElementById('editLockPaperDate').checked = (data.lockPaperDate === 1);
      document.getElementById('editLockUserEdit').checked = (data.lockUserEdit === 1);
      document.getElementById('editMustNotes').checked = (data.mustNotes === 1);
      document.getElementById('editRunFlow').checked = (data.runFlow === 1);
      document.getElementById('editSelectType').checked = (data.selectType === 1);

      // 載入單據類型
      loadPaperTypes(paperId);

      // 載入列印設定
      loadPaperPrint(paperId);

      // 顯示 Modal
      const modal = new bootstrap.Modal(document.getElementById('paperDetailModal'));
      modal.show();

    } catch (ex) {
      alert('載入單據資料失敗：' + (ex.message || ex));
    } finally {
      window.hideBusy && window.hideBusy();
    }
  }

  // 載入單據類型
  async function loadPaperTypes(paperId) {
    try {
      const res = await fetch(`/api/PaperInfo/${encodeURIComponent(paperId)}/Types`);
      if (!res.ok) return;

      const types = await res.json();
      const tbody = document.getElementById('paperTypeBody');
      tbody.innerHTML = '';

      types.forEach(type => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="number" class="form-control form-control-sm" value="${type.paperType || ''}" /></td>
          <td><input type="text" class="form-control form-control-sm" value="${type.paperTypeName || ''}" /></td>
          <td><input type="text" class="form-control form-control-sm" value="${type.headFirst || ''}" maxlength="4" /></td>
          <td>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (ex) {
      console.error('載入單據類型失敗:', ex);
    }
  }

  // 載入列印設定（用於主頁面第二個頁籤）
  let selectedPrintRow = null;
  let originalPrintData = {}; // 保存原始資料

  async function loadPrintSettings(paperId) {
    if (!paperId) {
      console.warn('loadPrintSettings: paperId is empty');
      return;
    }

    try {
      console.log('Loading print settings for paperId:', paperId);
      const res = await fetch(`/api/PaperInfo/${encodeURIComponent(paperId)}/Paper`);

      if (!res.ok) {
        console.error('Failed to load print settings:', res.status, res.statusText);
        document.getElementById('printTableBody').innerHTML = `<tr><td colspan="6" class="text-center text-muted">載入失敗 (${res.status})</td></tr>`;
        return;
      }

      const papers = await res.json();
      console.log('Print settings loaded:', papers.length, 'items');

      const tbody = document.getElementById('printTableBody');
      tbody.innerHTML = '';
      originalPrintData = {}; // 清空原始資料

      if (papers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">尚無列印設定資料</td></tr>';
        return;
      }

      papers.forEach((paper, index) => {
        const tr = document.createElement('tr');
        tr.className = 'print-row';
        tr.setAttribute('data-serial-num', paper.serialNum || '');
        tr.setAttribute('data-paper-id', paper.paperId);
        tr.onclick = function() { selectPrintRow(this); };

        // 保存原始資料
        const rowKey = `${paper.paperId}_${paper.serialNum}`;
        originalPrintData[rowKey] = {
          paperId: paper.paperId,
          serialNum: paper.serialNum,
          itemName: paper.itemName || '',
          enabled: paper.enabled,
          printItemId: paper.printItemId || '',
          className: paper.className || '',
          objectName: paper.objectName || ''
        };

        const checkedAttr = paper.enabled === 1 ? 'checked' : '';
        tr.innerHTML = `
          <td style="text-align: center;">
            <input type="number" class="form-control form-control-sm" value="${paper.serialNum || ''}"
                   style="width: 70px; text-align: center;" data-field="serialNum"
                   onclick="event.stopPropagation(); autoSelectPrintRow(this);"
                   onfocus="autoSelectPrintRow(this);"
                   onchange="markRowAsModified(this)" />
          </td>
          <td>
            <input type="text" class="form-control form-control-sm" value="${paper.itemName || ''}"
                   data-field="itemName"
                   onclick="event.stopPropagation();"
                   onfocus="autoSelectPrintRow(this);"
                   onchange="markRowAsModified(this)" />
          </td>
          <td style="text-align: center;">
            <input type="checkbox" class="form-check-input" ${checkedAttr} data-field="enabled"
                   onclick="event.stopPropagation(); autoSelectPrintRow(this);"
                   onchange="markRowAsModified(this)" />
          </td>
          <td>
            <input type="text" class="form-control form-control-sm" value="${paper.printItemId || ''}"
                   data-field="printItemId"
                   onclick="event.stopPropagation();"
                   onfocus="autoSelectPrintRow(this);"
                   onchange="markRowAsModified(this)" />
          </td>
          <td>
            <input type="text" class="form-control form-control-sm" value="${paper.className || ''}"
                   data-field="className"
                   onclick="event.stopPropagation();"
                   onfocus="autoSelectPrintRow(this);"
                   onchange="markRowAsModified(this)" />
          </td>
          <td>
            <input type="text" class="form-control form-control-sm" value="${paper.objectName || ''}"
                   data-field="objectName"
                   onclick="event.stopPropagation();"
                   onfocus="autoSelectPrintRow(this);"
                   onchange="markRowAsModified(this)" />
          </td>
        `;
        tbody.appendChild(tr);
      });

      selectedPrintRow = null;
    } catch (ex) {
      console.error('載入列印設定失敗:', ex);
      document.getElementById('printTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-muted">載入失敗</td></tr>';
    }
  }

  // 標記行為已修改
  function markRowAsModified(inputElement) {
    const row = inputElement.closest('tr');
    if (row) {
      row.setAttribute('data-modified', 'true');
    }
  }

  // 選擇列印設定行
  function selectPrintRow(rowEl) {
    // 移除其他列的選中狀態
    document.querySelectorAll('.print-row').forEach(r => r.classList.remove('selected-print'));

    // 添加當前列的選中狀態
    rowEl.classList.add('selected-print');
    selectedPrintRow = rowEl;
  }

  // 當編輯列印設定欄位時自動選中該行
  function autoSelectPrintRow(element) {
    const row = element.closest('tr');
    if (row && row.classList.contains('print-row')) {
      if (row !== selectedPrintRow) {
        selectPrintRow(row);
      }
    }
  }

  // 載入列印設定（用於 Modal）
  async function loadPaperPrint(paperId) {
    try {
      const res = await fetch(`/api/PaperInfo/${encodeURIComponent(paperId)}/Paper`);
      if (!res.ok) return;

      const papers = await res.json();
      const tbody = document.getElementById('paperPrintBody');
      tbody.innerHTML = '';

      papers.forEach(paper => {
        const tr = document.createElement('tr');
        const checkedAttr = paper.enabled === 1 ? 'checked' : '';
        tr.innerHTML = `
          <td style="text-align: center;">${paper.serialNum || ''}</td>
          <td>${paper.itemName || ''}</td>
          <td style="text-align: center;"><input type="checkbox" class="form-check-input" ${checkedAttr} disabled /></td>
          <td>${paper.printItemId || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    } catch (ex) {
      console.error('載入列印設定失敗:', ex);
    }
  }

  // 舊的載入列表設定函數（已不使用）
  async function loadPaperList_old(paperId) {
    try {
      const res = await fetch(`/api/PaperInfo/${encodeURIComponent(paperId)}/List`);
      if (!res.ok) return;

      const lists = await res.json();
      const tbody = document.getElementById('paperListBody_old');
      tbody.innerHTML = '';

      lists.forEach(list => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="number" class="form-control form-control-sm" value="${list.serialNum || ''}" /></td>
          <td><input type="text" class="form-control form-control-sm" value="${list.itemName || ''}" /></td>
          <td><input type="number" class="form-control form-control-sm" value="${list.enabled || 0}" min="0" max="1" /></td>
          <td><input type="text" class="form-control form-control-sm" value="${list.className || ''}" /></td>
          <td><input type="text" class="form-control form-control-sm" value="${list.objectName || ''}" /></td>
          <td><input type="number" class="form-control form-control-sm" value="${list.linkType || 0}" /></td>
          <td><input type="number" class="form-control form-control-sm" value="${list.displayType || 0}" /></td>
          <td><input type="number" class="form-control form-control-sm" value="${list.outputType || 0}" /></td>
          <td>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (ex) {
      console.error('載入列表設定失敗:', ex);
    }
  }

  // 新增單據類型列
  function addPaperTypeRow() {
    const tbody = document.getElementById('paperTypeBody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="number" class="form-control form-control-sm" value="" /></td>
      <td><input type="text" class="form-control form-control-sm" value="" /></td>
      <td><input type="text" class="form-control form-control-sm" value="" maxlength="4" /></td>
      <td>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  }


  // 新增單據
  function addPaperInfo() {
    alert('新增單據功能：\n請使用系統管理功能新增單據，或聯絡系統管理員。');
  }

  // 刪除單據
  async function deletePaperInfo() {
    if (!selectedPaperId) {
      alert('請先選擇一筆單據');
      return;
    }
    if (!confirm(`確定要刪除單據 ${selectedPaperId} 嗎？\n注意：此操作將同時刪除相關的類型和列印設定。`)) {
      return;
    }

    try {
      window.showBusy && window.showBusy('刪除中...');

      const fetcher = window.busyFetch || fetch;
      const res = await fetcher(`/api/PaperInfo/${encodeURIComponent(selectedPaperId)}`, {
        method: 'DELETE'
      });

      if (!res.ok) {
        const result = await res.json().catch(() => ({ message: '刪除失敗' }));
        throw new Error(result.message || '刪除失敗');
      }

      // 刪除成功，重新載入頁面
      location.reload();

    } catch (ex) {
      alert('刪除失敗：' + (ex.message || ex));
    } finally {
      window.hideBusy && window.hideBusy();
    }
  }

  // 儲存單據變更
  async function savePaperChanges() {
    if (!selectedPaperId) {
      alert('請先選擇一筆單據');
      return;
    }

    try {
      window.showBusy && window.showBusy('儲存中...');

      // 收集當前選中行的資料
      const row = document.querySelector(`.paper-row[data-paper-id="${selectedPaperId}"]`);
      if (!row) {
        throw new Error('找不到選中的單據資料');
      }

      // 先載入完整的單據資料
      const fetcher = window.busyFetch || fetch;
      const getRes = await fetcher(`/api/PaperInfo/${encodeURIComponent(selectedPaperId)}`);
      if (!getRes.ok) throw new Error('載入單據資料失敗');

      const paperData = await getRes.json();

      // 更新變更的欄位
      paperData.paperName = row.querySelector('[data-field="paperName"]').value;
      paperData.lockPaperDate = row.querySelector('[data-field="lockPaperDate"]').checked ? 1 : 0;
      paperData.lockUserEdit = row.querySelector('[data-field="lockUserEdit"]').checked ? 1 : 0;
      paperData.mustNotes = row.querySelector('[data-field="mustNotes"]').checked ? 1 : 0;
      paperData.selectType = row.querySelector('[data-field="selectType"]').checked ? 1 : 0;

      // 載入現有的 papers 資料，避免儲存時被刪除
      let existingPapers = null;
      try {
        const papersRes = await fetcher(`/api/PaperInfo/${encodeURIComponent(selectedPaperId)}/Paper`);
        if (papersRes.ok) {
          existingPapers = await papersRes.json();
          console.log('載入現有的 papers 資料:', existingPapers.length, '筆');
        }
      } catch (ex) {
        console.warn('載入 papers 資料失敗，將以 null 傳送:', ex);
      }

      // 儲存（保留現有的 papers 資料）
      const saveRes = await fetcher('/api/PaperInfo/Save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          basicData: paperData,
          types: null,
          papers: existingPapers,  // 保留現有的 papers 資料，避免被刪除
          lists: null
        })
      });

      const result = await saveRes.json();

      if (!saveRes.ok || !result.success) {
        throw new Error(result.message || '儲存失敗');
      }

      // 儲存成功，重新載入頁面
      location.reload();

    } catch (ex) {
      alert('儲存失敗：' + (ex.message || ex));
    } finally {
      window.hideBusy && window.hideBusy();
    }
  }

  // 取消單據變更
  function cancelPaperChanges() {
    if (confirm('確定要取消變更嗎？')) {
      location.reload();
    }
  }

  // 重整單據列表
  function refreshPaperList() {
    location.reload();
  }

  // 新增列印設定
  function addPrintSetting() {
    if (!selectedPaperId) {
      alert('請先選擇一筆單據');
      return;
    }

    const tbody = document.getElementById('printTableBody');

    // 如果表格是空的提示訊息，先清空
    if (tbody.children.length === 1 && tbody.children[0].cells.length === 1) {
      tbody.innerHTML = '';
    }

    // 計算新的序號
    const existingRows = tbody.querySelectorAll('.print-row');
    let maxSerialNum = 0;
    existingRows.forEach(row => {
      const serialInput = row.querySelector('[data-field="serialNum"]');
      if (serialInput) {
        const num = parseInt(serialInput.value) || 0;
        if (num > maxSerialNum) maxSerialNum = num;
      }
    });

    // 建立新的行
    const tr = document.createElement('tr');
    tr.className = 'print-row';
    tr.setAttribute('data-new', 'true');
    tr.onclick = function() { selectPrintRow(this); };

    tr.innerHTML = `
      <td style="text-align: center;">
        <input type="number" class="form-control form-control-sm" value="${maxSerialNum + 1}"
               style="width: 70px; text-align: center;" data-field="serialNum"
               onclick="event.stopPropagation(); autoSelectPrintRow(this);"
               onfocus="autoSelectPrintRow(this);"
               onchange="markRowAsModified(this)" />
      </td>
      <td>
        <input type="text" class="form-control form-control-sm" value=""
               data-field="itemName"
               onclick="event.stopPropagation();"
               onfocus="autoSelectPrintRow(this);"
               onchange="markRowAsModified(this)" />
      </td>
      <td style="text-align: center;">
        <input type="checkbox" class="form-check-input" checked data-field="enabled"
               onclick="event.stopPropagation(); autoSelectPrintRow(this);"
               onchange="markRowAsModified(this)" />
      </td>
      <td>
        <input type="text" class="form-control form-control-sm" value=""
               data-field="printItemId"
               onclick="event.stopPropagation();"
               onfocus="autoSelectPrintRow(this);"
               onchange="markRowAsModified(this)" />
      </td>
      <td>
        <input type="text" class="form-control form-control-sm" value=""
               data-field="className"
               onclick="event.stopPropagation();"
               onfocus="autoSelectPrintRow(this);"
               onchange="markRowAsModified(this)" />
      </td>
      <td>
        <input type="text" class="form-control form-control-sm" value=""
               data-field="objectName"
               onclick="event.stopPropagation();"
               onfocus="autoSelectPrintRow(this);"
               onchange="markRowAsModified(this)" />
      </td>
    `;

    tbody.appendChild(tr);

    // 自動選中新增的行
    selectPrintRow(tr);

    // 聚焦到格式名稱欄位
    const itemNameInput = tr.querySelector('[data-field="itemName"]');
    if (itemNameInput) itemNameInput.focus();
  }

  // 刪除列印設定
  async function deletePrintSetting() {
    if (!selectedPaperId) {
      alert('請先選擇一筆單據');
      return;
    }

    if (!selectedPrintRow) {
      alert('請先選擇要刪除的列印設定');
      return;
    }

    if (!confirm('確定要刪除此列印設定嗎？\n此操作會立即儲存到資料庫。')) {
      return;
    }

    try {
      window.showBusy && window.showBusy('刪除中...');

      // 移除選中的行
      selectedPrintRow.remove();
      selectedPrintRow = null;

      // 收集剩餘的所有資料
      const tbody = document.getElementById('printTableBody');
      const rows = tbody.querySelectorAll('.print-row');
      const papers = [];

      rows.forEach(row => {
        const serialNum = parseInt(row.querySelector('[data-field="serialNum"]').value) || 0;
        const itemName = row.querySelector('[data-field="itemName"]').value || '';
        const enabled = row.querySelector('[data-field="enabled"]').checked ? 1 : 0;
        const printItemId = row.querySelector('[data-field="printItemId"]').value || '';
        const className = row.querySelector('[data-field="className"]').value || '';
        const objectName = row.querySelector('[data-field="objectName"]').value || '';

        papers.push({
          paperId: selectedPaperId,
          serialNum: serialNum,
          itemName: itemName,
          enabled: enabled,
          printItemId: printItemId,
          className: className,
          objectName: objectName,
          notes: null,
          linkType: 0,
          displayType: 0,
          outputType: 0,
          showTitle: 0,
          showTree: 0,
          tableIndex: null,
          itemCount: 0
        });
      });

      // 載入基本資料
      const fetcher = window.busyFetch || fetch;
      const getRes = await fetcher(`/api/PaperInfo/${encodeURIComponent(selectedPaperId)}`);
      if (!getRes.ok) throw new Error('載入單據資料失敗');

      const paperData = await getRes.json();

      // 儲存（傳送刪除後剩餘的資料）
      const saveRes = await fetcher('/api/PaperInfo/Save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          basicData: paperData,
          types: null,
          papers: papers,  // 傳送剩餘的資料，已刪除的不在列表中
          lists: null
        })
      });

      const result = await saveRes.json();

      if (!saveRes.ok || !result.success) {
        throw new Error(result.message || '刪除失敗');
      }

      console.log('刪除成功，剩餘', papers.length, '筆資料');

      // 重新載入列印設定
      loadPrintSettings(selectedPaperId);

    } catch (ex) {
      alert('刪除失敗：' + (ex.message || ex));
      // 刪除失敗時重新載入資料
      loadPrintSettings(selectedPaperId);
    } finally {
      window.hideBusy && window.hideBusy();
    }
  }

  // 儲存列印設定
  async function savePrintSettings() {
    if (!selectedPaperId) {
      alert('請先選擇一筆單據');
      return;
    }

    try {
      window.showBusy && window.showBusy('儲存中...');

      // 收集所有列印設定資料（因為後端 API 使用完全替換策略）
      const tbody = document.getElementById('printTableBody');
      const rows = tbody.querySelectorAll('.print-row');

      // 收集所有資料（包括未修改的）
      const papers = [];
      let hasChanges = false;

      rows.forEach(row => {
        const isNew = row.getAttribute('data-new') === 'true';
        const isModified = row.getAttribute('data-modified') === 'true';

        // 記錄是否有變更
        if (isNew || isModified) {
          hasChanges = true;
        }

        const serialNum = parseInt(row.querySelector('[data-field="serialNum"]').value) || 0;
        const itemName = row.querySelector('[data-field="itemName"]').value || '';
        const enabled = row.querySelector('[data-field="enabled"]').checked ? 1 : 0;
        const printItemId = row.querySelector('[data-field="printItemId"]').value || '';
        const className = row.querySelector('[data-field="className"]').value || '';
        const objectName = row.querySelector('[data-field="objectName"]').value || '';

        papers.push({
          paperId: selectedPaperId, // PaperId 是鍵值，不修改
          serialNum: serialNum,
          itemName: itemName,
          enabled: enabled,
          printItemId: printItemId,
          className: className,
          objectName: objectName,
          notes: null,
          linkType: 0,
          displayType: 0,
          outputType: 0,
          showTitle: 0,
          showTree: 0,
          tableIndex: null,
          itemCount: 0
        });
      });

      if (!hasChanges) {
        alert('沒有資料被修改，無需儲存');
        return;
      }

      // 載入基本資料
      const fetcher = window.busyFetch || fetch;
      const getRes = await fetcher(`/api/PaperInfo/${encodeURIComponent(selectedPaperId)}`);
      if (!getRes.ok) throw new Error('載入單據資料失敗');

      const paperData = await getRes.json();

      // 儲存
      const saveRes = await fetcher('/api/PaperInfo/Save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          basicData: paperData,
          types: null,
          papers: papers, // 傳送所有資料（包括未修改的）
          lists: null
        })
      });

      const result = await saveRes.json();

      if (!saveRes.ok || !result.success) {
        throw new Error(result.message || '儲存失敗');
      }

      // 重新載入列印設定
      loadPrintSettings(selectedPaperId);

    } catch (ex) {
      alert('儲存失敗：' + (ex.message || ex));
    } finally {
      window.hideBusy && window.hideBusy();
    }
  }

  // 取消列印變更
  function cancelPrintChanges() {
    if (!selectedPaperId) {
      alert('請先選擇一筆單據');
      return;
    }
    if (confirm('確定要取消變更嗎？')) {
      // 重新載入列印設定
      loadPrintSettings(selectedPaperId);
    }
  }

  // 重整列印設定
  function refreshPrintSettings() {
    if (!selectedPaperId) {
      alert('請先選擇一筆單據');
      return;
    }
    loadPrintSettings(selectedPaperId);
  }

  // 儲存單據資訊
  async function savePaperInfo() {
    if (!selectedPaperId) {
      alert('請先選擇一筆單據');
      return;
    }

    try {
      window.showBusy && window.showBusy('儲存中...');

      // 收集基本資料
      const basicData = {
        paperId: document.getElementById('editPaperId').value,
        paperName: document.getElementById('editPaperName').value,
        systemId: document.getElementById('editSystemId').value,
        encodeWay: parseInt(document.getElementById('editEncodeWay').value) || 0,
        headFirst: document.getElementById('editHeadFirst').value || null,
        headDateFormat: document.getElementById('editHeadDateFormat').value || null,
        numLength: parseInt(document.getElementById('editNumLength').value) || 0,
        yearDiff: parseInt(document.getElementById('editYearDiff').value) || null,
        tableName: document.getElementById('editTableName').value || null,
        pkName: document.getElementById('editPKName').value || null,
        lockPaperDate: document.getElementById('editLockPaperDate').checked ? 1 : 0,
        lockUserEdit: document.getElementById('editLockUserEdit').checked ? 1 : 0,
        mustNotes: document.getElementById('editMustNotes').checked ? 1 : 0,
        runFlow: document.getElementById('editRunFlow').checked ? 1 : 0,
        selectType: document.getElementById('editSelectType').checked ? 1 : 0
      };

      // 收集單據類型
      const types = [];
      document.querySelectorAll('#paperTypeBody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input');
        types.push({
          paperId: selectedPaperId,
          paperType: parseInt(inputs[0].value) || 0,
          paperTypeName: inputs[1].value || null,
          headFirst: inputs[2].value || null
        });
      });

      // 送出儲存請求（只儲存基本資料和單據類型）
      const fetcher = window.busyFetch || fetch;
      const res = await fetcher('/api/PaperInfo/Save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          basicData,
          types,
          papers: null,
          lists: null
        })
      });

      const result = await res.json();

      if (!res.ok || !result.success) {
        throw new Error(result.message || '儲存失敗');
      }

      alert('儲存成功！');

      // 關閉 Modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('paperDetailModal'));
      if (modal) modal.hide();

      // 重新載入頁面
      location.reload();

    } catch (ex) {
      alert('儲存失敗：' + (ex.message || ex));
    } finally {
      window.hideBusy && window.hideBusy();
    }
  }

  // 頁面載入完成後自動選中第一筆資料
  document.addEventListener('DOMContentLoaded', function() {
    // 等待一小段時間確保 DOM 完全載入
    setTimeout(function() {
      const firstRow = document.querySelector('.paper-row');
      if (firstRow) {
        const paperId = firstRow.getAttribute('data-paper-id');
        if (paperId) {
          // 觸發點擊事件來選中第一筆
          selectPaperRow(paperId, firstRow);
        }
      }
    }, 100);

    // 監聽頁籤切換事件
    const printTab = document.getElementById('print-tab');
    if (printTab) {
      printTab.addEventListener('shown.bs.tab', function (e) {
        console.log('Switched to print tab, selectedPaperId:', selectedPaperId);
        // 當切換到列印設定頁籤時，確保資料已載入
        if (selectedPaperId) {
          const tbody = document.getElementById('printTableBody');
          // 如果表格是空的或只有提示訊息，重新載入
          if (!tbody || tbody.children.length === 0 ||
              (tbody.children.length === 1 && tbody.children[0].cells.length === 1)) {
            console.log('Reloading print settings on tab switch');
            loadPrintSettings(selectedPaperId);
          }
        }
      });
    }
  });
</script>
