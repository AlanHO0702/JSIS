@page "/CPN/{itemId}"
@model PcbErpApi.Pages.CPN.MatInfoComModel
@{
    Layout = "_Layout";
    ViewData["Title"] = $"{Model.ItemId} {Model.ItemName}";
}

<style>
  .matinfo-page {
    padding: 8px 12px 24px 12px;
  }
  .matinfo-toolbar {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
  }
  .matinfo-toolbar .toolbar-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #2564b3;
    color: #fff;
    border: none;
    border-radius: 11px;
    font-size: var(--top-toolbar-font-size);
    font-weight: 500;
    padding: 6px 14px;
    box-shadow: 0 2px 10px 0 #c5d9f1;
    transition: background 0.18s, transform 0.11s;
    cursor: pointer;
  }
  .matinfo-toolbar .toolbar-btn.success {
    background: #0e9f4b;
  }
  .matinfo-toolbar .toolbar-btn.danger {
    background: #df3c4b;
  }
  .matinfo-toolbar .toolbar-btn:hover,
  .matinfo-toolbar .toolbar-btn:focus {
    transform: translateY(-1px) scale(1.03);
  }
  .matinfo-browse {
    border: 1px solid #d8e0ee;
    border-radius: 8px;
    background: #fff;
    overflow: hidden;
  }
  .matinfo-browse table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.92rem;
  }
  .matinfo-browse thead th {
    background: #f2f6ff;
    color: #204a87;
    text-align: left;
    padding: 6px 8px;
    border-bottom: 1px solid #d8e0ee;
  }
  .matinfo-browse tbody td {
    padding: 6px 8px;
    border-bottom: 1px solid #eef2f8;
    white-space: nowrap;
  }
  .matinfo-browse tbody tr:hover {
    background: #f9fbff;
    cursor: pointer;
  }
  .matinfo-browse tbody tr.active {
    background: #ffecec;
  }
  .matinfo-tabs {
    margin-top: 10px;
  }
  .matinfo-form {
    border: 1px solid #d8e0ee;
    border-top: none;
    padding: 12px 14px 16px 14px;
    background: #fff;
  }
  .matinfo-grid {
    display: grid;
    grid-template-columns: 110px 220px 110px 220px 110px 220px;
    gap: 8px 12px;
  }
  .matinfo-grid label {
    text-align: right;
    color: #1d3b6b;
    font-size: 0.9rem;
    align-self: center;
  }
  .matinfo-grid input,
  .matinfo-grid select {
    width: 100%;
    height: 28px;
    padding: 2px 6px;
    border: 1px solid #cfd7e6;
    border-radius: 4px;
    font-size: 0.9rem;
  }
  .matinfo-grid .field-wide {
    grid-column: span 5;
  }
  .matinfo-grid .field-full {
    grid-column: span 5;
  }
  .matinfo-checks {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  .matinfo-checks label {
    text-align: left;
    color: #1d3b6b;
  }
  @@media (max-width: 1100px) {
    .matinfo-grid {
      grid-template-columns: 110px 1fr 110px 1fr;
    }
  }
  @@media (max-width: 760px) {
    .matinfo-grid {
      grid-template-columns: 110px 1fr;
    }
    .matinfo-grid .field-wide,
    .matinfo-grid .field-full {
      grid-column: span 1;
    }
  }
</style>

<div class="matinfo-page">
  <div class="matinfo-toolbar">
    <button type="button" class="toolbar-btn" id="btnMatInfoQuery">查詢</button>
    <button type="button" class="toolbar-btn" id="btnMatInfoAdd">新增</button>
    <button type="button" class="toolbar-btn danger" id="btnMatInfoDelete">刪除</button>
    <button type="button" class="toolbar-btn success" id="btnMatInfoSave">儲存</button>
  </div>

  <div class="matinfo-browse">
    <table>
      <thead>
        <tr>
          <th style="width: 140px;">料號</th>
          <th style="width: 260px;">品名</th>
          <th style="width: 80px;">單位</th>
          <th style="width: 240px;">規格</th>
          <th style="width: 80px;">等級</th>
          <th style="width: 100px;">分類</th>
        </tr>
      </thead>
      <tbody id="matinfo-browse-body"></tbody>
    </table>
  </div>

  <ul class="nav nav-tabs matinfo-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-basic" type="button" role="tab">基本資料</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link disabled" type="button" role="tab">庫存設定</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link disabled" type="button" role="tab">屬性及備註</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link disabled" type="button" role="tab">工程圖</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link disabled" type="button" role="tab">規格表</button>
    </li>
  </ul>

  <div class="tab-content matinfo-form">
    <div class="tab-pane fade show active" id="tab-basic" role="tabpanel">
      <div class="matinfo-grid">
        <label>料號</label>
        <input data-field="Partnum" readonly>
        <label>版次</label>
        <input data-field="Revision" readonly>
        <label>等級</label>
        <input data-field="Grade">

        <label>品名</label>
        <input class="field-wide" data-field="MatName">

        <label>單位</label>
        <input data-field="Unit">
        <label>用途</label>
        <input data-field="UseIn">
        <label>分類</label>
        <input data-field="MatClass">

        <label>長(英吋)</label>
        <input data-field="Length">
        <label>寬(英吋)</label>
        <input data-field="Width">
        <label>LLPCS</label>
        <input data-field="LLPCS">

        <label>圖號</label>
        <input class="field-wide" data-field="MapNo">

        <label>舊料號</label>
        <input class="field-wide" data-field="OldPartNum">

        <label>規格/機種</label>
        <input class="field-wide" data-field="EngGauge">

        <label>正式料號</label>
        <input data-field="NewPartNum" readonly>
        <label>建立者</label>
        <input data-field="Build_UserId" readonly>
        <label>建立日</label>
        <input data-field="Build_Date" readonly>

        <label>報價單位</label>
        <input data-field="UnitQuote">
        <label>換算式</label>
        <input data-field="ChangRate">
        <label>QC類型</label>
        <input data-field="QCType">

        <label>併版料號A</label>
        <input data-field="MergePartNum">
        <label>併版料號M</label>
        <input data-field="MerMPartNum">
        <label>來源料號</label>
        <input data-field="FromTmpPartNum" readonly>

        <label>寄銷廠商</label>
        <input data-field="AgentCompanyId">
        <label>HDI</label>
        <input data-field="HDI">
        <label>文字代碼</label>
        <input data-field="WordNum">

        <label>產品類別</label>
        <input data-field="ProdStyle">
        <label>轉廠別</label>
        <input data-field="TranFacType">
        <label>狀態</label>
        <input data-field="iPNStatus">

        <label>終端客戶</label>
        <input class="field-wide" data-field="YsLayer_s5">

        <label>狀態勾選</label>
        <div class="matinfo-checks field-wide">
          <label><input type="checkbox" data-field="MB"> 購入</label>
          <label><input type="checkbox" data-field="IsTrans"> 已轉正式</label>
          <label><input type="checkbox" data-field="IsEMO"> 已轉工程</label>
          <label><input type="checkbox" data-field="Status"> 正式料號</label>
          <label><input type="checkbox" data-field="StopOrder"> 停止下單</label>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
<script>
(() => {
  const tbody = document.getElementById('matinfo-browse-body');
  const form = document.querySelector('.matinfo-form');
  const btnQuery = document.getElementById('btnMatInfoQuery');
  const btnAdd = document.getElementById('btnMatInfoAdd');
  const btnDelete = document.getElementById('btnMatInfoDelete');
  const btnSave = document.getElementById('btnMatInfoSave');

  let currentRecord = null;
  let currentKey = null;
  let isNew = false;

  const notify = (type, message) => {
    if (window.Swal) {
      const icon = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
      return window.Swal.fire({ icon, title: message });
    }
    alert(message);
  };

  function setValue(el, value) {
    if (!el) return;
    if (el.type === 'checkbox') {
      el.checked = value === true || value === 1 || value === '1';
      return;
    }
    el.value = value ?? '';
  }

  function fillForm(record) {
    if (!record) return;
    form.querySelectorAll('[data-field]').forEach((el) => {
      const field = el.getAttribute('data-field');
      if (!field) return;
      setValue(el, record[field] ?? record[field.toLowerCase()] ?? record[field.toUpperCase()]);
    });
  }

  function clearForm() {
    form.querySelectorAll('[data-field]').forEach((el) => {
      if (el.type === 'checkbox') {
        el.checked = false;
      } else {
        el.value = '';
      }
    });
  }

  function getFormData() {
    const data = {};
    form.querySelectorAll('[data-field]').forEach((el) => {
      const field = el.getAttribute('data-field');
      if (!field) return;
      if (el.type === 'checkbox') {
        data[field] = el.checked ? 1 : 0;
      } else {
        data[field] = (el.value ?? '').toString().trim();
      }
    });
    return data;
  }

  function setKeyFieldsEditable(enabled) {
    const partnum = form.querySelector('[data-field="Partnum"]');
    const revision = form.querySelector('[data-field="Revision"]');
    if (partnum) partnum.readOnly = !enabled;
    if (revision) revision.readOnly = !enabled;
  }

  function buildRow(item) {
    const tr = document.createElement('tr');
    tr.dataset.partnum = item.Partnum ?? '';
    tr.dataset.revision = item.Revision ?? '';
    tr.innerHTML = `
      <td>${item.Partnum ?? ''}</td>
      <td>${item.MatName ?? ''}</td>
      <td>${item.Unit ?? ''}</td>
      <td>${item.EngGauge ?? ''}</td>
      <td>${item.Grade ?? ''}</td>
      <td>${item.MatClass ?? ''}</td>
    `;
    tr.addEventListener('click', () => {
      tbody.querySelectorAll('tr').forEach(row => row.classList.remove('active'));
      tr.classList.add('active');
      fillForm(item);
      currentRecord = item;
      currentKey = { partnum: item.Partnum ?? '', revision: item.Revision ?? '' };
      isNew = false;
      setKeyFieldsEditable(false);
    });
    return tr;
  }

  async function loadData() {
    try {
      const res = await fetch('/api/MindMatInfo/paged?page=1&pageSize=200');
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      const rows = Array.isArray(data?.data) ? data.data : [];
      tbody.innerHTML = '';
      rows.forEach((row) => tbody.appendChild(buildRow(row)));
      if (rows.length > 0) {
        tbody.querySelector('tr')?.click();
      } else {
        clearForm();
        currentRecord = null;
        currentKey = null;
        isNew = false;
        setKeyFieldsEditable(false);
      }
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="6">載入失敗：${err.message ?? err}</td></tr>`;
    }
  }

  async function saveRecord() {
    const data = getFormData();
    const partnum = (data.Partnum || '').trim();
    const revision = (data.Revision || '').trim();
    if (!partnum) {
      notify('error', '請輸入料號');
      return;
    }
    if (!revision) {
      notify('error', '請輸入版次');
      return;
    }

    if (isNew) {
      const resp = await fetch('/api/MindMatInfo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!resp.ok) {
        notify('error', await resp.text());
        return;
      }
      notify('success', '新增完成');
      await loadData();
      return;
    }

    if (!currentKey) {
      notify('error', '請先選擇一筆資料');
      return;
    }

    const url = `/api/MindMatInfo/${encodeURIComponent(currentKey.partnum)}/${encodeURIComponent(currentKey.revision)}`;
    const resp = await fetch(url, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!resp.ok) {
      notify('error', await resp.text());
      return;
    }
    notify('success', '儲存完成');
    await loadData();
  }

  async function deleteRecord() {
    if (!currentKey || !currentKey.partnum || !currentKey.revision) {
      notify('error', '請先選擇一筆資料');
      return;
    }
    const ok = window.Swal
      ? (await window.Swal.fire({ icon: 'warning', title: '確定要刪除?', showCancelButton: true })).isConfirmed
      : confirm('確定要刪除?');
    if (!ok) return;

    const url = `/api/MindMatInfo/${encodeURIComponent(currentKey.partnum)}/${encodeURIComponent(currentKey.revision)}`;
    const resp = await fetch(url, { method: 'DELETE' });
    if (!resp.ok) {
      notify('error', await resp.text());
      return;
    }
    notify('success', '刪除完成');
    await loadData();
  }

  btnQuery?.addEventListener('click', () => {
    loadData();
  });

  btnAdd?.addEventListener('click', () => {
    clearForm();
    currentRecord = null;
    currentKey = null;
    isNew = true;
    setKeyFieldsEditable(true);
  });

  btnSave?.addEventListener('click', () => {
    saveRecord();
  });

  btnDelete?.addEventListener('click', () => {
    deleteRecord();
  });

  loadData();
})();
</script>
}
