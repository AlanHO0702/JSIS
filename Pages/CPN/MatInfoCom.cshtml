@page "/CPN/{itemId}"
@model PcbErpApi.Pages.CPN.MatInfoComModel
@{
    Layout = "_Layout";
    ViewData["Title"] = $"{Model.ItemId} {Model.ItemName}";
}

<style>
  .matinfo-page {
    padding: 8px 12px 24px 12px;
  }
  .matinfo-toolbar {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
  }
  .matinfo-toolbar-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .matinfo-count {
    font-size: 0.9rem;
    color: #1d3b6b;
    font-weight: 600;
  }
  .matinfo-toolbar .toolbar-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #2564b3;
    color: #fff;
    border: none;
    border-radius: 11px;
    font-size: var(--top-toolbar-font-size);
    font-weight: 500;
    padding: 6px 14px;
    box-shadow: 0 2px 10px 0 #c5d9f1;
    transition: background 0.18s, transform 0.11s;
    cursor: pointer;
  }
  .matinfo-toolbar .toolbar-btn.success {
    background: #0e9f4b;
  }
  .matinfo-toolbar .toolbar-btn.danger {
    background: #df3c4b;
  }
  .matinfo-toolbar .toolbar-btn:hover,
  .matinfo-toolbar .toolbar-btn:focus {
    transform: translateY(-1px) scale(1.03);
  }
  .matinfo-browse {
    border: 1px solid #d8e0ee;
    border-radius: 8px;
    background: #fff;
    overflow: hidden;
  }
  .matinfo-scroll-top {
    overflow-x: auto;
    overflow-y: hidden;
    height: 14px;
    border-bottom: 1px solid #eef2f8;
  }
  .matinfo-scroll-top > div {
    height: 1px;
  }
  .matinfo-scroll-body {
    overflow-x: auto;
    overflow-y: hidden;
  }
  .matinfo-browse table {
    width: max-content;
    border-collapse: collapse;
    font-size: 0.92rem;
    min-width: 1200px;
  }
  .matinfo-browse thead th {
    background: #f2f6ff;
    color: #204a87;
    text-align: left;
    padding: 6px 8px;
    border-bottom: 1px solid #d8e0ee;
  }
  .matinfo-browse tbody td {
    padding: 6px 8px;
    border-bottom: 1px solid #eef2f8;
    white-space: nowrap;
  }
  .matinfo-browse tbody tr:hover {
    background: #f9fbff;
    cursor: pointer;
  }
  .matinfo-browse tbody tr.active {
    background: #ffecec;
  }
  .matinfo-tabs {
    margin-top: 10px;
    flex-wrap: nowrap;
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
  }
  .matinfo-tabs .nav-item {
    flex: 0 0 auto;
  }
  .matinfo-tabs .nav-link {
    padding: 4px 10px;
    font-size: 0.86rem;
  }
  .matinfo-form {
    border: 1px solid #d8e0ee;
    border-top: none;
    padding: 12px 14px 16px 14px;
    background: #fff;
    overflow-x: auto;
  }
  .matinfo-form .tab-pane {
    min-width: 1200px;
  }
  .matinfo-section {
    margin-bottom: 12px;
  }
  .matinfo-section-title {
    font-weight: 700;
    color: #1d3b6b;
    margin-bottom: 8px;
  }
  .matinfo-grid {
    display: grid;
    grid-template-columns: 110px 220px 110px 220px 110px 220px;
    gap: 8px 12px;
  }
  .matinfo-grid.compact {
    grid-template-columns: 120px 1fr 120px 1fr;
  }
  .matinfo-grid label {
    text-align: right;
    color: #1d3b6b;
    font-size: 0.9rem;
    align-self: center;
  }
  .matinfo-grid input,
  .matinfo-grid select {
    width: 100%;
    height: 28px;
    padding: 2px 6px;
    border: 1px solid #cfd7e6;
    border-radius: 4px;
    font-size: 0.9rem;
  }
  .matinfo-grid .field-wide {
    grid-column: span 5;
  }
  .matinfo-grid .field-full {
    grid-column: span 5;
  }
  .matinfo-checks {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  .matinfo-checks label {
    text-align: left;
    color: #1d3b6b;
  }
  .matinfo-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .matinfo-box {
    border: 1px solid #d8e0ee;
    border-radius: 8px;
    background: #fff;
    padding: 8px;
    overflow-x: auto;
  }
  .matinfo-box table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
    min-width: 1200px;
  }
  .matinfo-box th,
  .matinfo-box td {
    border-bottom: 1px solid #eef2f8;
    padding: 6px 8px;
    text-align: left;
    white-space: nowrap;
  }
  .matinfo-box thead th {
    background: #f7f9ff;
    color: #1d3b6b;
    font-weight: 600;
  }
  .matinfo-textarea {
    width: 100%;
    min-height: 180px;
    padding: 8px;
    border: 1px solid #cfd7e6;
    border-radius: 6px;
    resize: vertical;
  }
  .matinfo-image-box {
    border: 1px solid #d8e0ee;
    border-radius: 8px;
    background: #fafcff;
    min-height: 220px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    font-weight: 600;
  }
  @@media (max-width: 1100px) {
    .matinfo-grid {
      grid-template-columns: 110px 1fr 110px 1fr;
    }
    .matinfo-split {
      grid-template-columns: 1fr;
    }
  }
  @@media (max-width: 760px) {
    .matinfo-grid {
      grid-template-columns: 110px 1fr;
    }
    .matinfo-grid .field-wide,
    .matinfo-grid .field-full {
      grid-column: span 1;
    }
  }
</style>

<div class="matinfo-page">
  <div class="matinfo-toolbar">
    <div class="matinfo-toolbar-actions">
      <button type="button" class="toolbar-btn" id="btnMatInfoQuery">查詢</button>
      <button type="button" class="toolbar-btn" id="btnMatInfoAdd">新增</button>
      <button type="button" class="toolbar-btn danger" id="btnMatInfoDelete">刪除</button>
      <button type="button" class="toolbar-btn success" id="btnMatInfoSave">儲存</button>
    </div>
    <div class="matinfo-count" id="matinfo-count">0 / 0</div>
  </div>

  <div class="matinfo-browse" id="matinfo-browse">
    <div class="matinfo-scroll-top" id="matinfo-browse-scroll-top"><div></div></div>
    <div class="matinfo-scroll-body" id="matinfo-browse-scroll-body">
      <table>
        <thead>
          <tr id="matinfo-browse-head"></tr>
        </thead>
        <tbody id="matinfo-browse-body"></tbody>
      </table>
    </div>
  </div>

  <ul class="nav nav-tabs matinfo-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-basic" type="button" role="tab">基本資料</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-cust" type="button" role="tab">客戶料號</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-stock" type="button" role="tab">庫存設定</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-prop" type="button" role="tab">屬性及備註</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-map" type="button" role="tab">工程圖</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-glyph" type="button" role="tab">圖檔</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-demand" type="button" role="tab">成品要求</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-spec" type="button" role="tab">規格表</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-unit" type="button" role="tab">替代單位設定</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-common" type="button" role="tab">共用件</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-avl" type="button" role="tab">廠商AVL</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-cusprice" type="button" role="tab">客戶價格表</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-price" type="button" role="tab">價格</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-notes" type="button" role="tab">其他備註</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-packing" type="button" role="tab">Packing</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-kit" type="button" role="tab">組合商品</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-delivery" type="button" role="tab">廠商送貨明細檔</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-depart" type="button" role="tab">部門領料倉別明細檔</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-engrave" type="button" role="tab">射出紀錄</button>
    </li>
  </ul>

  <div class="matinfo-scroll-top" id="matinfo-form-scroll-top"><div></div></div>
  <div class="tab-content matinfo-form" id="matinfo-form-scroll-body">
    <div class="tab-pane fade show active" id="tab-basic" role="tabpanel">
      <div class="matinfo-grid">
        <label>料號</label>
        <input data-field="Partnum" readonly>
        <label>版次</label>
        <input data-field="Revision" readonly>
        <label>等級</label>
        <input data-field="Grade">

        <label>品名</label>
        <input class="field-wide" data-field="MatName">

        <label>單位</label>
        <input data-field="Unit">
        <label>用途</label>
        <input data-field="UseIn">
        <label>分類</label>
        <input data-field="MatClass">

        <label>長(英吋)</label>
        <input data-field="Length">
        <label>寬(英吋)</label>
        <input data-field="Width">
        <label>LLPCS</label>
        <input data-field="LLPCS">

        <label>圖號</label>
        <input class="field-wide" data-field="MapNo">

        <label>舊料號</label>
        <input class="field-wide" data-field="OldPartNum">

        <label>規格/機種</label>
        <input class="field-wide" data-field="EngGauge">

        <label>正式料號</label>
        <input data-field="NewPartNum" readonly>
        <label>建立者</label>
        <input data-field="Build_UserId" readonly>
        <label>建立日</label>
        <input data-field="Build_Date" readonly>

        <label>報價單位</label>
        <input data-field="UnitQuote">
        <label>換算式</label>
        <input data-field="ChangRate">
        <label>QC類型</label>
        <input data-field="QCType">

        <label>併版料號A</label>
        <input data-field="MergePartNum">
        <label>併版料號M</label>
        <input data-field="MerMPartNum">
        <label>來源料號</label>
        <input data-field="FromTmpPartNum" readonly>

        <label>寄銷廠商</label>
        <input data-field="AgentCompanyId">
        <label>HDI</label>
        <input data-field="HDI">
        <label>文字代碼</label>
        <input data-field="WordNum">

        <label>產品類別</label>
        <input data-field="ProdStyle">
        <label>轉廠別</label>
        <input data-field="TranFacType">
        <label>狀態</label>
        <input data-field="iPNStatus">

        <label>終端客戶</label>
        <input class="field-wide" data-field="YsLayer_s5">

        <label>狀態勾選</label>
        <div class="matinfo-checks field-wide">
          <label><input type="checkbox" data-field="MB"> 購入</label>
          <label><input type="checkbox" data-field="IsTrans"> 已轉正式</label>
          <label><input type="checkbox" data-field="IsEMO"> 已轉工程</label>
          <label><input type="checkbox" data-field="Status"> 正式料號</label>
          <label><input type="checkbox" data-field="StopOrder"> 停止下單</label>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-cust" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">客戶料號</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 120px;">客戶代碼</th>
                <th style="width: 140px;">客戶簡稱</th>
                <th style="width: 200px;">客戶品號</th>
                <th style="width: 200px;">物品說明</th>
                <th style="width: 160px;">材質</th>
                <th style="width: 140px;">尺寸</th>
                <th style="width: 160px;">機械性質</th>
                <th style="width: 160px;">貿易條款</th>
                <th style="width: 160px;">交貨狀態</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="9">尚未接客戶料號資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
          <div class="tab-pane fade" id="tab-stock" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">庫存設定</div>
        <div class="matinfo-grid">
          <label>最小包裝量</label>
          <input data-field="LeastBag">
          <label>最小訂購量</label>
          <input data-field="OrderQnty">
          <label>超收%</label>
          <input data-field="Accept">

          <label>Lead Time</label>
          <input data-field="LeadTime">
          <label>安全庫存</label>
          <input data-field="SafeQnty">
          <label>固定補足量</label>
          <input data-field="FixQnty">

          <label>固定補足時間</label>
          <input data-field="FixDate">
          <label>安全點天數</label>
          <input data-field="SafeDay">
          <label>耗損率%</label>
          <input data-field="ScrapRate">

          <label>保存天數</label>
          <input data-field="KeepTime">
          <label>平均月用量</label>
          <input data-field="AvgMonQnty" readonly>
          <label>平均日用量</label>
          <input data-field="AvgDayQnty" readonly>

          <label>記錄平均用量起</label>
          <input data-field="SetFromDate">
          <label>迄</label>
          <input data-field="SetDueDate">
          <label>現有庫存</label>
          <input data-field="StockQnty" readonly>

          <label>物料型態</label>
          <input data-field="MatClassType">
          <label>耗用分類</label>
          <input data-field="AccountType">
          <label>倉別</label>
          <input data-field="StockId">

          <label>庫位</label>
          <input data-field="PosId">
          <label>自訂分類一</label>
          <input data-field="MatClass1">
          <label>自訂分類二</label>
          <input data-field="MatClass2">

          <label>管理</label>
          <div class="matinfo-checks field-wide">
            <label><input type="checkbox" data-field="iNeedBatchNum"> 批號管理</label>
            <label><input type="checkbox" data-field="iNeedDateCode"> DateCode 管理</label>
            <label><input type="checkbox" data-field="iNeedExpiredDate"> 效期管制</label>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-prop" role="tabpanel">
      <div class="matinfo-split">
        <div class="matinfo-box">
          <div class="matinfo-section-title">屬性清單</div>
          <table>
            <thead>
              <tr>
                <th style="width: 70px;">屬性</th>
                <th style="width: 140px;">屬性名</th>
                <th style="width: 140px;">項目</th>
                <th style="width: 180px;">項目名</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="4">尚未接屬性明細資料</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="matinfo-box">
          <div class="matinfo-section-title">備註</div>
          <textarea class="matinfo-textarea" data-field="Notes"></textarea>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-map" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">工程圖清單</div>
        <div class="matinfo-toolbar" style="justify-content: flex-start; margin-bottom: 8px;">
          <button type="button" class="toolbar-btn" disabled>檢視圖檔 (開視窗)</button>
          <button type="button" class="toolbar-btn" disabled>檢視圖檔 (跳至圖檔頁籤)</button>
          <button type="button" class="toolbar-btn" disabled>指定路徑及檔名</button>
        </div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 70px;">序號</th>
                <th>圖檔完整路徑及檔名</th>
                <th style="width: 220px;">說明</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3">尚未接工程圖資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-glyph" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">圖檔</div>
        <div class="matinfo-grid">
          <label>料號</label>
          <input data-field="Partnum" readonly>
          <label>品名</label>
          <input data-field="MatName" readonly>
          <label>圖檔序號</label>
          <input data-field="SerialNum" readonly>
        </div>
      </div>
      <div class="matinfo-image-box">無 圖 檔</div>
    </div>

    <div class="tab-pane fade" id="tab-demand" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">成品要求</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 70px;">代號</th>
                <th style="width: 200px;">要求名稱</th>
                <th style="width: 120px;">需要有值</th>
                <th>要求內容</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="4">尚未接成品要求資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-spec" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">規格表</div>
        <div class="matinfo-toolbar" style="justify-content: flex-start; margin-bottom: 8px;">
          <button type="button" class="toolbar-btn" disabled>重新匯入</button>
          <button type="button" class="toolbar-btn" disabled>全部清除</button>
          <button type="button" class="toolbar-btn" disabled>列印</button>
        </div>
        <div class="matinfo-grid">
          <label>單號</label>
          <input data-field="PaperNum" readonly>
          <label>種類</label>
          <input data-field="SpecType">
          <label>種類名</label>
          <input data-field="Lk_SpecTypeName" readonly>
        </div>
      </div>
      <div class="matinfo-box">
        <table>
          <thead>
            <tr>
              <th style="width: 70px;">代號</th>
              <th style="width: 180px;">屬性名</th>
              <th>屬性內容</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="3">尚未接規格表資料</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-unit" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">替代單位設定</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 120px;">替代單位</th>
                <th style="width: 120px;">換算比</th>
                <th style="width: 140px;">用途類型</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="4">尚未接替代單位資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-common" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">共用件</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 70px;">序號</th>
                <th style="width: 140px;">共用料號</th>
                <th style="width: 200px;">品名</th>
                <th style="width: 120px;">使用量</th>
                <th style="width: 120px;">基礎用量</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5">尚未接共用件資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-avl" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">廠商 AVL</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 70px;">序號</th>
                <th style="width: 120px;">供應商</th>
                <th style="width: 140px;">供應商名稱</th>
                <th style="width: 100px;">UOM</th>
                <th style="width: 120px;">UOM數量</th>
                <th style="width: 120px;">數量</th>
                <th style="width: 120px;">單價</th>
                <th style="width: 120px;">幣別</th>
                <th style="width: 100px;">匯率</th>
                <th style="width: 140px;">付款方式</th>
                <th style="width: 140px;">發票種類</th>
                <th style="width: 140px;">報價日</th>
                <th style="width: 140px;">有效日</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="13">尚未接廠商 AVL 資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-cusprice" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">客戶價格表</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 70px;">序號</th>
                <th style="width: 120px;">客戶</th>
                <th style="width: 140px;">客戶名稱</th>
                <th style="width: 100px;">UOM</th>
                <th style="width: 120px;">UOM數量</th>
                <th style="width: 120px;">數量</th>
                <th style="width: 120px;">單價</th>
                <th style="width: 120px;">幣別</th>
                <th style="width: 100px;">匯率</th>
                <th style="width: 140px;">付款方式</th>
                <th style="width: 140px;">發票種類</th>
                <th style="width: 140px;">報價日</th>
                <th style="width: 140px;">有效日</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="13">尚未接客戶價格表資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-price" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">價格</div>
        <div class="matinfo-grid compact">
          <label>標準成本單價</label>
          <input data-field="STDCostUp">
          <label>價格1</label>
          <input data-field="UnitPrice1">
          <label>價格2</label>
          <input data-field="UnitPrice2">
          <label>價格3</label>
          <input data-field="UnitPrice3">
          <label>價格4</label>
          <input data-field="UnitPrice4">
          <label>價格5</label>
          <input data-field="UnitPrice5">
          <label>價格6</label>
          <input data-field="UnitPrice6">
          <label>價格7</label>
          <input data-field="UnitPrice7">
          <label>價格8</label>
          <input data-field="UnitPrice8">
          <label>價格9</label>
          <input data-field="UnitPrice9">
          <label>價格10</label>
          <input data-field="UnitPrice10">
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-notes" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">其他備註 (文字)</div>
        <div class="matinfo-grid compact">
          <label>備註1(文字)</label>
          <input data-field="NotesVarch1">
          <label>備註2(文字)</label>
          <input data-field="NotesVarch2">
          <label>備註3(文字)</label>
          <input data-field="NotesVarch3">
          <label>備註4(文字)</label>
          <input data-field="NotesVarch4">
          <label>備註5(文字)</label>
          <input data-field="NotesVarch5">
          <label>備註6(文字)</label>
          <input data-field="NotesVarch6">
          <label>備註7(文字)</label>
          <input data-field="NotesVarch7">
          <label>備註8(文字)</label>
          <input data-field="NotesVarch8">
          <label>備註9(文字)</label>
          <input data-field="NotesVarch9">
          <label>備註10(文字)</label>
          <input data-field="NotesVarch10">
        </div>
      </div>
      <div class="matinfo-section">
        <div class="matinfo-section-title">其他備註 (數字)</div>
        <div class="matinfo-grid compact">
          <label>備註11(數字)</label>
          <input data-field="NotesDecim1">
          <label>備註12(數字)</label>
          <input data-field="NotesDecim2">
          <label>備註13(數字)</label>
          <input data-field="NotesDecim3">
          <label>備註14(數字)</label>
          <input data-field="NotesDecim4">
          <label>備註15(數字)</label>
          <input data-field="NotesDecim5">
          <label>備註16(數字)</label>
          <input data-field="NotesDecim6">
          <label>備註17(數字)</label>
          <input data-field="NotesDecim7">
          <label>備註18(數字)</label>
          <input data-field="NotesDecim8">
          <label>備註19(數字)</label>
          <input data-field="NotesDecim9">
          <label>備註20(數字)</label>
          <input data-field="NotesDecim10">
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-packing" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">Packing</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 70px;">項次</th>
                <th style="width: 120px;">箱型</th>
                <th style="width: 120px;">數量</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="4">尚未接 Packing 資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-kit" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">組合商品</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 80px;">項次</th>
                <th style="width: 160px;">組合料號</th>
                <th style="width: 200px;">品名</th>
                <th style="width: 100px;">單位</th>
                <th style="width: 120px;">數量</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="6">尚未接組合商品資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-delivery" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">廠商送貨明細檔</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 70px;">項次</th>
                <th style="width: 160px;">標題</th>
                <th style="width: 120px;">倉別</th>
                <th style="width: 120px;">庫位</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5">尚未接送貨明細資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-depart" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">部門領料倉別明細檔</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 120px;">部門代碼</th>
                <th style="width: 160px;">部門名稱</th>
                <th style="width: 120px;">倉別</th>
                <th style="width: 120px;">庫位</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5">尚未接部門領料資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-engrave" role="tabpanel">
      <div class="matinfo-section">
        <div class="matinfo-section-title">射出紀錄</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 120px;">項次</th>
                <th style="width: 200px;">內容</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3">尚未接射出紀錄資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", null, ViewData)

@section Scripts {
<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>
<script>
(() => {
  const tbody = document.getElementById('matinfo-browse-body');
  const theadRow = document.getElementById('matinfo-browse-head');
  const form = document.querySelector('.matinfo-form');
  const countEl = document.getElementById('matinfo-count');
  const browseScrollTop = document.getElementById('matinfo-browse-scroll-top');
  const browseScrollBody = document.getElementById('matinfo-browse-scroll-body');
  const formScrollTop = document.getElementById('matinfo-form-scroll-top');
  const formScrollBody = document.getElementById('matinfo-form-scroll-body');
  const btnQuery = document.getElementById('btnMatInfoQuery');
  const btnAdd = document.getElementById('btnMatInfoAdd');
  const btnDelete = document.getElementById('btnMatInfoDelete');
  const btnSave = document.getElementById('btnMatInfoSave');

  let currentRecord = null;
  let currentKey = null;
  let isNew = false;
  let lastTotalCount = 0;
  let currentIndex = 0;
  let columns = [];
  const itemId = '@Model.ItemId';
  const dictTableName = (() => {
    const id = (itemId || '').toUpperCase();
    if (id === 'MG000008' || id === 'CPN00006') return 'MGN_MINdMatInfo2';
    if (id === 'MG000002' || id === 'CPN00007') return 'MGN_MINdMatInfo40';
    return 'MINdMatInfo';
  })();

  window._dictTableName = dictTableName;
  const dictCache = { fields: null };

  const preferredColumns = [
    'Partnum', 'MatName', 'Unit', 'EngGauge', 'Grade', 'MatClass', 'Revision',
    'StockId', 'PosId', 'UseIn', 'Build_UserId', 'Build_Date', 'Update_UserId',
    'Update_Date', 'Status', 'IsTrans', 'IsEMO'
  ];

  const columnLabels = {
    Partnum: '料號',
    MatName: '品名',
    Unit: '單位',
    EngGauge: '規格',
    Grade: '等級',
    MatClass: '分類',
    Revision: '版次',
    StockId: '倉別',
    PosId: '庫位',
    UseIn: '用途',
    Build_UserId: '建檔者',
    Build_Date: '建檔日期',
    Update_UserId: '更新者',
    Update_Date: '更新日期',
    Status: '狀態',
    IsTrans: '已轉正式',
    IsEMO: '已轉工程'
  };

  const notify = (type, message) => {
    if (window.Swal) {
      const icon = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
      return window.Swal.fire({ icon, title: message });
    }
    alert(message);
  };

  function setValue(el, value) {
    if (!el) return;
    if (el.type === 'checkbox') {
      el.checked = value === true || value === 1 || value === '1';
      return;
    }
    el.value = value ?? '';
  }

  function fillForm(record) {
    if (!record) return;
    form.querySelectorAll('[data-field]').forEach((el) => {
      const field = el.getAttribute('data-field');
      if (!field) return;
      setValue(el, record[field] ?? record[field.toLowerCase()] ?? record[field.toUpperCase()]);
    });
  }

  function clearForm() {
    form.querySelectorAll('[data-field]').forEach((el) => {
      if (el.type === 'checkbox') {
        el.checked = false;
      } else {
        el.value = '';
      }
    });
  }

  function getFormData() {
    const data = {};
    form.querySelectorAll('[data-field]').forEach((el) => {
      const field = el.getAttribute('data-field');
      if (!field) return;
      if (el.type === 'checkbox') {
        data[field] = el.checked ? 1 : 0;
      } else {
        data[field] = (el.value ?? '').toString().trim();
      }
    });
    return data;
  }

  function setKeyFieldsEditable(enabled) {
    const partnum = form.querySelector('[data-field="Partnum"]');
    const revision = form.querySelector('[data-field="Revision"]');
    if (partnum) partnum.readOnly = !enabled;
    if (revision) revision.readOnly = !enabled;
  }

  function formatValue(value) {
    if (value === null || value === undefined) return '';
    if (typeof value === 'object') return JSON.stringify(value);
    return `${value}`;
  }

  function getValue(item, key) {
    if (!item || !key) return '';
    if (item[key] !== undefined) return item[key];
    const keyLower = key.toLowerCase();
    for (const k of Object.keys(item)) {
      if (k.toLowerCase() === keyLower) return item[k];
    }
    return '';
  }

  async function loadDict() {
    if (dictCache.fields) return dictCache.fields;
    try {
      const res = await fetch(`/api/TableFieldLayout/GetTableFieldsFull?table=${encodeURIComponent(dictTableName)}&lang=TW`);
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      dictCache.fields = Array.isArray(data) ? data : [];
      return dictCache.fields;
    } catch (err) {
      dictCache.fields = [];
      return dictCache.fields;
    }
  }

  const scrollSyncState = new WeakMap();
  function syncScroll(topEl, bodyEl) {
    if (!topEl || !bodyEl) return;
    const inner = topEl.firstElementChild;
    if (!inner) return;
    const bodyTable = () => bodyEl.querySelector('table') || bodyEl;
    const updateWidth = () => {
      inner.style.width = `${bodyTable().scrollWidth}px`;
      topEl.scrollLeft = bodyEl.scrollLeft;
    };

    if (!scrollSyncState.has(topEl)) {
      let lock = false;
      topEl.addEventListener('scroll', () => {
        if (lock) return;
        lock = true;
        bodyEl.scrollLeft = topEl.scrollLeft;
        lock = false;
      });
      bodyEl.addEventListener('scroll', () => {
        if (lock) return;
        lock = true;
        topEl.scrollLeft = bodyEl.scrollLeft;
        lock = false;
      });
      window.addEventListener('resize', updateWidth);
      scrollSyncState.set(topEl, updateWidth);
    }
    updateWidth();
  }

  function buildColumnsFromData(rows) {
    const keySet = new Set();
    rows.forEach((row) => {
      if (!row) return;
      Object.keys(row).forEach((key) => keySet.add(key));
    });

    const ordered = preferredColumns.filter((key) => keySet.has(key));
    const rest = [...keySet].filter((key) => !ordered.includes(key));
    rest.sort((a, b) => a.localeCompare(b));
    return [...ordered, ...rest].map((key) => ({
      key,
      label: columnLabels[key] ?? key,
      width: null
    }));
  }

  async function buildColumns(rows) {
    const dict = await loadDict();
    const keySet = new Set();
    rows.forEach((row) => {
      if (!row) return;
      Object.keys(row).forEach((key) => keySet.add(key));
    });

    if (dict && dict.length) {
      const dictCols = dict
        .filter(d => (d.Visible ?? d.visible ?? 1) == 1)
        .sort((a, b) => (a.SerialNum ?? a.serialNum ?? 9999) - (b.SerialNum ?? b.serialNum ?? 9999))
        .map(d => {
          const key = d.FieldName || d.fieldName;
          const ds = d.DisplaySize ?? d.displaySize;
          const widthRaw = d.iFieldWidth ?? d.iLabWidth ?? ds;
          const widthVal = d.iFieldWidth ? `${widthRaw}px`
                         : ds ? `${ds}ch`
                         : null;
          return {
            key,
            label: d.DisplayLabel || d.displayLabel || columnLabels[key] || key,
            width: widthVal
          };
        })
        .filter(c => c.key);

      columns = dictCols;
    } else {
      columns = buildColumnsFromData(rows);
    }

    theadRow.innerHTML = columns
      .map((col) => {
        const style = col.width ? ` style="width:${col.width}"` : '';
        return `<th${style}>${col.label ?? col.key}</th>`;
      })
      .join('');
  }

  function updateCount() {
    if (!countEl) return;
    const total = lastTotalCount || 0;
    countEl.textContent = `${currentIndex || 0} / ${total}`;
  }

  function buildRow(item, index) {
    const tr = document.createElement('tr');
    tr.dataset.partnum = getValue(item, 'Partnum') ?? '';
    tr.dataset.revision = getValue(item, 'Revision') ?? '';
    tr.innerHTML = columns
      .map((col) => `<td>${formatValue(getValue(item, col.key))}</td>`)
      .join('');
    tr.addEventListener('click', () => {
      tbody.querySelectorAll('tr').forEach(row => row.classList.remove('active'));
      tr.classList.add('active');
      fillForm(item);
      currentRecord = item;
      currentKey = { partnum: getValue(item, 'Partnum') ?? '', revision: getValue(item, 'Revision') ?? '' };
      isNew = false;
      setKeyFieldsEditable(false);
      currentIndex = (index ?? 0) + 1;
      updateCount();
    });
    return tr;
  }

  async function loadData() {
    try {
      const res = await fetch('/api/MindMatInfo/paged?page=1&pageSize=30');
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      const rows = Array.isArray(data?.data) ? data.data : [];
      await buildColumns(rows);
      lastTotalCount = data?.totalCount ?? rows.length;
      currentIndex = rows.length ? 1 : 0;
      updateCount();
      tbody.innerHTML = '';
      rows.forEach((row, idx) => tbody.appendChild(buildRow(row, idx)));
      syncScroll(browseScrollTop, browseScrollBody);
      if (rows.length > 0) {
        tbody.querySelector('tr')?.click();
      } else {
        theadRow.innerHTML = '';
        currentIndex = 0;
        lastTotalCount = 0;
        updateCount();
        clearForm();
        currentRecord = null;
        currentKey = null;
        isNew = false;
        setKeyFieldsEditable(false);
      }
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="6">載入失敗：${err.message ?? err}</td></tr>`;
    }
  }

  async function saveRecord() {
    const data = getFormData();
    const partnum = (data.Partnum || '').trim();
    const revision = (data.Revision || '').trim();
    if (!partnum) {
      notify('error', '請輸入料號');
      return;
    }
    if (!revision) {
      notify('error', '請輸入版次');
      return;
    }

    if (isNew) {
      const resp = await fetch('/api/MindMatInfo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!resp.ok) {
        notify('error', await resp.text());
        return;
      }
      notify('success', '新增完成');
      await loadData();
      return;
    }

    if (!currentKey) {
      notify('error', '請先選擇一筆資料');
      return;
    }

    const url = `/api/MindMatInfo/${encodeURIComponent(currentKey.partnum)}/${encodeURIComponent(currentKey.revision)}`;
    const resp = await fetch(url, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!resp.ok) {
      notify('error', await resp.text());
      return;
    }
    notify('success', '儲存完成');
    await loadData();
  }

  async function deleteRecord() {
    if (!currentKey || !currentKey.partnum || !currentKey.revision) {
      notify('error', '請先選擇一筆資料');
      return;
    }
    const ok = window.Swal
      ? (await window.Swal.fire({ icon: 'warning', title: '確定要刪除?', showCancelButton: true })).isConfirmed
      : confirm('確定要刪除?');
    if (!ok) return;

    const url = `/api/MindMatInfo/${encodeURIComponent(currentKey.partnum)}/${encodeURIComponent(currentKey.revision)}`;
    const resp = await fetch(url, { method: 'DELETE' });
    if (!resp.ok) {
      notify('error', await resp.text());
      return;
    }
    notify('success', '刪除完成');
    await loadData();
  }

  btnQuery?.addEventListener('click', () => {
    loadData();
  });

  btnAdd?.addEventListener('click', () => {
    clearForm();
    currentRecord = null;
    currentKey = null;
    isNew = true;
    setKeyFieldsEditable(true);
  });

  btnSave?.addEventListener('click', () => {
    saveRecord();
  });

  btnDelete?.addEventListener('click', () => {
    deleteRecord();
  });

  syncScroll(browseScrollTop, browseScrollBody);
  syncScroll(formScrollTop, formScrollBody);

  document.querySelectorAll('[data-bs-toggle="tab"]').forEach((btn) => {
    btn.addEventListener('shown.bs.tab', () => {
      syncScroll(formScrollTop, formScrollBody);
    });
  });

  const openFieldDict = () => {
    const el = document.getElementById('fieldDictModal');
    if (!el) return;
    if (typeof window.initFieldDictModal === 'function') {
      window.initFieldDictModal(dictTableName, 'fieldDictModal');
    } else if (typeof window.loadFieldDict === 'function') {
      window.loadFieldDict(dictTableName);
    }
  };

  document.addEventListener('keydown', (e) => {
    if (e.key !== 'F3') return;
    const target = e.target;
    const inText = target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable);
    if (inText) return;
    e.preventDefault();
    openFieldDict();
  });

  loadData();
})();
</script>
}






