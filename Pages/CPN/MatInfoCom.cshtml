@page "/CPN/{itemId}"
@model PcbErpApi.Pages.CPN.MatInfoComModel
@{
    Layout = "_Layout";
    ViewData["Title"] = $"{Model.ItemId} {Model.ItemName}";
}

<style>
  .matinfo-page {
    padding: 8px 12px 24px 12px;
  }
  .matinfo-toolbar {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
  }
  .matinfo-toolbar-actions {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .matinfo-count {
    font-size: 0.9rem;
    color: #1d3b6b;
    font-weight: 600;
  }
  .matinfo-page .toolbar-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    background: #2564b3;
    color: #fff;
    border: none;
    border-radius: 11px;
    font-size: var(--top-toolbar-font-size);
    font-weight: 500;
    padding: 5px 10px;
    box-shadow: 0 2px 10px 0 #c5d9f1;
    transition: background 0.18s, transform 0.11s;
    cursor: pointer;
  }
  .matinfo-page .toolbar-btn.success {
    background: #0e9f4b;
  }
  .matinfo-page .toolbar-btn.warning {
    background: #f59e0b;
  }
  .matinfo-page .toolbar-btn.danger {
    background: #df3c4b;
  }
  .matinfo-page .toolbar-btn:hover,
  .matinfo-page .toolbar-btn:focus {
    transform: translateY(-1px) scale(1.03);
  }
  .matinfo-page .toolbar-btn i {
    font-size: 1.08em;
  }
  .matinfo-toolbar .toolbar-btn-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: var(--top-toolbar-btn-height, 36px);
    min-height: var(--top-toolbar-btn-height, 36px);
    padding: 0;
    width: 30px;
    border-radius: 8px;
    font-size: var(--top-toolbar-icon-font-size, 16px);
    line-height: 1;
  }
  .matinfo-toolbar .toolbar-btn-icon .toolbar-icon {
    display: inline-block;
  }
  .matinfo-toolbar #btnMatInfoTabPrev .toolbar-icon,
  .matinfo-toolbar #btnMatInfoTabNext .toolbar-icon {
    transform: translateY(-3px);
  }
  .matinfo-browse {
    border: 1px solid #d8e0ee;
    border-radius: 8px;
    background: #fff;
    overflow: hidden;
    --browse-row-height: 24px;
    --browse-head-height: 30px;
  }
  .matinfo-browse.is-hidden {
    display: none;
  }
  .matinfo-scroll-top {
    overflow-x: auto;
    overflow-y: hidden;
    height: 14px;
    border-bottom: 1px solid #eef2f8;
  }
  .matinfo-scroll-top > div {
    height: 1px;
  }
  .matinfo-scroll-body {
    overflow-x: auto;
    overflow-y: auto;
    height: calc(var(--browse-head-height) + (var(--browse-row-height) + 2px) * 11 + 34px);
  }
  .matinfo-browse table {
    width: max-content;
    border-collapse: collapse;
    font-size: 0.92rem;
    min-width: 1200px;
  }
  .matinfo-browse thead th {
    background: #f2f6ff;
    color: #204a87;
    text-align: left;
    padding: 4px 8px;
    border-bottom: 1px solid #b7c2d4;
    border-right: 1px solid #b7c2d4;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 2;
    height: var(--browse-head-height);
  }
  .matinfo-browse thead th.sortable {
    cursor: pointer;
  }
  .matinfo-browse thead th.sorted-asc::after {
    content: " ▲";
    font-size: 0.75em;
  }
  .matinfo-browse thead th.sorted-desc::after {
    content: " ▼";
    font-size: 0.75em;
  }
  .matinfo-browse tbody td {
    padding: 2px 8px;
    border-bottom: 1px solid #c4cede;
    border-right: 1px solid #c4cede;
    border-top: 1px solid #c4cede;
    white-space: nowrap;
    height: var(--browse-row-height);
  }
  .matinfo-browse thead th:last-child,
  .matinfo-browse tbody td:last-child {
    border-right: none;
  }
  .matinfo-browse tbody td input[type="checkbox"] {
    pointer-events: none;
    width: 14px;
    height: 14px;
  }
  .matinfo-browse .col-checkbox {
    text-align: center;
  }
  .matinfo-browse tbody .col-readonly {
    background: #f3f4f6;
  }
  .matinfo-browse tbody tr:hover {
    background: #f9fbff;
    cursor: pointer;
  }
  .matinfo-browse tbody tr.active {
    background: #cfe8ff;
  }
  .matinfo-browse tbody tr.active td {
    background: #cfe8ff;
  }
  .matinfo-browse tbody tr.matinfo-spacer td {
    padding: 0;
    border: none;
  }
  .matinfo-browse tbody tr.matinfo-loading td {
    color: #6b7280;
    font-style: italic;
  }
  .matinfo-tabs {
    margin-top: 8px;
    flex-wrap: nowrap;
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
  }
  .matinfo-tabs .nav-item {
    flex: 0 0 auto;
  }
  .matinfo-tabs .nav-link {
    padding: 3px 8px;
    font-size: 0.82rem;
  }
  .matinfo-form {
    border: 1px solid #d8e0ee;
    border-top: none;
    padding: 8px 10px 12px 10px;
    background: #fff;
    overflow-x: auto;
  }
  .matinfo-form .tab-pane {
    min-width: 1200px;
  }
  .matinfo-page.is-edit-mode .matinfo-form input[data-field]:not([readonly]):not([disabled]),
  .matinfo-page.is-edit-mode .matinfo-form textarea[data-field]:not([readonly]):not([disabled]),
  .matinfo-page.is-edit-mode .matinfo-form select[data-field]:not([disabled]) {
    background: #fff7cc;
    border-color: #f59e0b;
  }
  .matinfo-section {
    margin-bottom: 8px;
  }
  .matinfo-section-title {
    display: none;
  }
  .matinfo-grid {
    display: grid;
    grid-template-columns: 90px 210px 90px 210px 90px 210px;
    gap: 6px 16px;
    align-items: center;
  }
  .matinfo-grid.compact {
    grid-template-columns: 90px 260px 90px 260px;
  }
  .matinfo-grid label {
    text-align: right;
    color: #1d3b6b;
    font-size: 0.86rem;
    align-self: center;
    white-space: nowrap;
  }
  .matinfo-grid input,
  .matinfo-grid select {
    width: 100%;
    height: 24px;
    padding: 1px 4px;
    border: 1px solid #cfd7e6;
    border-radius: 4px;
    font-size: 0.86rem;
    box-sizing: border-box;
  }
  .matinfo-grid .field-wide {
    grid-column: span 5;
  }
  .matinfo-grid .field-full {
    grid-column: span 5;
  }
  .matinfo-abs-layout {
    position: relative;
    min-height: 200px;
  }
  .matinfo-abs-layout .abs-item {
    position: absolute;
    box-sizing: border-box;
  }
  .matinfo-abs-layout label {
    text-align: right;
    color: #1d3b6b;
    font-size: 0.86rem;
    white-space: nowrap;
  }
  .matinfo-abs-layout input,
  .matinfo-abs-layout select,
  .matinfo-abs-layout textarea {
    width: 100%;
    height: 24px;
    padding: 1px 4px;
    border: 1px solid #cfd7e6;
    border-radius: 4px;
    font-size: 0.86rem;
    box-sizing: border-box;
  }
  .matinfo-abs-layout .abs-checkbox-label {
    text-align: left;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .matinfo-checks {
    display: flex;
    gap: 10px 16px;
    align-items: center;
    flex-wrap: wrap;
  }
  .matinfo-checks label {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    min-width: 90px;
    white-space: nowrap;
    margin: 0;
  }
  .matinfo-checks label {
    text-align: left;
    color: #1d3b6b;
  }
  .matinfo-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .matinfo-box {
    border: 1px solid #d8e0ee;
    border-radius: 8px;
    background: #fff;
    padding: 8px;
    overflow-x: auto;
  }
  .matinfo-grid-toolbar {
    display: flex;
    gap: 6px;
    align-items: center;
    margin-bottom: 6px;
  }
  .matinfo-grid-toolbar .btn {
    padding: 2px 8px;
    font-size: 0.78rem;
  }
  .matinfo-grid-toolbar .btn-icon {
    width: 28px;
    height: 26px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .matinfo-grid-table table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.84rem;
  }
  .matinfo-grid-table th,
  .matinfo-grid-table td {
    border: 1px solid #e5e7eb;
    padding: 4px 6px;
    white-space: nowrap;
  }
  .matinfo-grid-table tbody tr.is-selected {
    background: #fff3cd;
  }
  .matinfo-grid-table tbody tr.is-deleted {
    opacity: 0.6;
    text-decoration: line-through;
  }
  .matinfo-grid-table input,
  .matinfo-grid-table select {
    width: 100%;
    height: 24px;
    padding: 1px 4px;
    border: 1px solid #cfd7e6;
    border-radius: 4px;
    font-size: 0.84rem;
    box-sizing: border-box;
  }
  .matinfo-box table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.84rem;
    min-width: 1200px;
  }
  .matinfo-box th,
  .matinfo-box td {
    border-bottom: 1px solid #eef2f8;
    padding: 4px 6px;
    text-align: left;
    white-space: nowrap;
  }
  .matinfo-box thead th {
    background: #f7f9ff;
    color: #1d3b6b;
    font-weight: 600;
  }
  .matinfo-textarea {
    width: 100%;
    min-height: 140px;
    padding: 8px;
    border: 1px solid #cfd7e6;
    border-radius: 6px;
    resize: vertical;
  }
  .matinfo-image-box {
    border: 1px solid #d8e0ee;
    border-radius: 8px;
    background: #fafcff;
    min-height: 220px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    font-weight: 600;
  }
  .lookup-dropdown-list {
    background: #fff;
    border: 1px solid #d8e0ee;
    border-radius: 8px;
    box-shadow: 0 8px 18px rgba(15, 23, 42, 0.18);
    padding: 6px;
    overflow: auto;
    z-index: 1060;
  }
  .lookup-dropdown-item {
    display: block;
    width: 100%;
    text-align: left;
    border: none;
    background: transparent;
    padding: 6px 10px;
    border-radius: 6px;
    color: #1f2937;
    cursor: pointer;
  }
  .lookup-dropdown-item:hover,
  .lookup-dropdown-item:focus {
    background: #eff6ff;
    outline: none;
  }
  .lookup-dropdown-item.is-selected {
    background: #dbe9ff;
    font-weight: 600;
  }
  @@media (max-width: 1100px) {
    .matinfo-grid {
      grid-template-columns: 110px 1fr 110px 1fr;
    }
    .matinfo-split {
      grid-template-columns: 1fr;
    }
  }
  @@media (max-width: 760px) {
    .matinfo-grid {
      grid-template-columns: 110px 1fr;
    }
    .matinfo-grid .field-wide,
    .matinfo-grid .field-full {
      grid-column: span 1;
    }
  }
</style>

<div class="matinfo-page">
  <div class="matinfo-toolbar">
    <div class="btn-toolbar matinfo-toolbar-actions" role="group" aria-label="料號主檔操作">
      <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btnMatInfoTabPrev" title="上一筆" aria-label="上一筆"><span class="toolbar-icon">&laquo;</span></button>
      <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btnMatInfoTabNext" title="下一筆" aria-label="下一筆"><span class="toolbar-icon">&raquo;</span></button>
      <button type="button" class="btn toolbar-btn" id="btnMatInfoQuery"><i class="bi bi-search"></i>查詢</button>
      <button type="button" class="btn toolbar-btn" id="btnMatInfoEdit"><i class="bi bi-pencil-square"></i>修改</button>
      <button type="button" class="btn toolbar-btn warning" id="btnMatInfoCancel" hidden><i class="bi bi-x-circle"></i>取消</button>
      <button type="button" class="btn toolbar-btn" id="btnMatInfoAdd"><i class="bi bi-plus-lg"></i>新增</button>
      <button type="button" class="btn toolbar-btn warning" id="btnMatInfoToFormal"><i class="bi bi-arrow-right-circle"></i>轉正式</button>
      <button type="button" class="btn toolbar-btn" id="btnMatInfoDetail"><i class="bi bi-list-ul"></i>明細</button>
      <button type="button" class="btn toolbar-btn" id="btnMatInfoHistory"><i class="bi bi-clock-history"></i>歷史</button>
      <button type="button" class="btn toolbar-btn warning" id="btnMatInfoToEmo"><i class="bi bi-arrow-repeat"></i>轉工程</button>
      <button type="button" class="btn toolbar-btn danger" id="btnMatInfoDelete"><i class="bi bi-trash3"></i>刪除</button>
      <button type="button" class="btn toolbar-btn success" id="btnMatInfoSave"><i class="bi bi-check2-circle"></i>儲存</button>
    </div>
    <div class="matinfo-count" id="matinfo-count">0 / 0</div>
  </div>

  <div class="matinfo-browse" id="matinfo-browse">
    <div class="matinfo-scroll-top" id="matinfo-browse-scroll-top"><div></div></div>
    <div class="matinfo-scroll-body" id="matinfo-browse-scroll-body">
      <table>
        <thead>
          <tr id="matinfo-browse-head"></tr>
        </thead>
        <tbody id="matinfo-browse-body"></tbody>
      </table>
    </div>
  </div>

  <ul class="nav nav-tabs matinfo-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-basic" type="button" role="tab" data-tab-name="基本資料">基本資料</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-basic2" type="button" role="tab" data-tab-name="基本資料2">基本資料2</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-cust" type="button" role="tab" data-tab-name="廠商料號">廠商料號</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-prop" type="button" role="tab" data-tab-name="屬性及備註">屬性及備註</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-map" type="button" role="tab" data-tab-name="工程圖">工程圖</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-glyph" type="button" role="tab" data-tab-name="圖檔">圖檔</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-unit" type="button" role="tab" data-tab-name="替代單位設定">替代單位設定</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-common" type="button" role="tab" data-tab-name="共用件">共用件</button>
    </li>
  </ul>

  <div class="matinfo-scroll-top" id="matinfo-form-scroll-top"><div></div></div>
  <div class="tab-content matinfo-form" id="matinfo-form-scroll-body">
    <div class="tab-pane fade show active" id="tab-basic" role="tabpanel" data-tab-name="基本資料">
      <div class="matinfo-abs-layout" id="matinfo-basic1-abs"></div>
      <div class="matinfo-grid">
        <label>料號</label>
        <input data-field="Partnum" readonly>
        <label>版次</label>
        <input data-field="Revision" readonly>
        <label>等級</label>
        <input data-field="Grade">

        <label>品名</label>
        <input class="field-wide" data-field="MatName">

        <label>單位</label>
        <input data-field="Unit">
        <label>用途</label>
        <input data-field="UseIn">
        <label>分類</label>
        <input data-field="MatClass">

        <label>長(英吋)</label>
        <input data-field="Length">
        <label>寬(英吋)</label>
        <input data-field="Width">
        <label>LLPCS</label>
        <input data-field="LLPCS">

        <label>圖號</label>
        <input class="field-wide" data-field="MapNo">

        <label>舊料號</label>
        <input class="field-wide" data-field="OldPartNum">

        <label>規格/機種</label>
        <input class="field-wide" data-field="EngGauge">

        <label>正式料號</label>
        <input data-field="NewPartNum" readonly>
        <label>建立者</label>
        <input data-field="Build_UserId" readonly>
        <label>建立日</label>
        <input data-field="Build_Date" readonly>

        <label>報價單位</label>
        <input data-field="UnitQuote">
        <label>換算式</label>
        <input data-field="ChangRate">
        <label>QC類型</label>
        <input data-field="QCType">

        <label>併版料號A</label>
        <input data-field="MergePartNum">
        <label>併版料號M</label>
        <input data-field="MerMPartNum">
        <label>來源料號</label>
        <input data-field="FromTmpPartNum" readonly>

        <label>寄銷廠商</label>
        <input data-field="AgentCompanyId">
        <label>HDI</label>
        <input data-field="HDI">
        <label>文字代碼</label>
        <input data-field="WordNum">

        <label>產品類別</label>
        <input data-field="ProdStyle">
        <label>轉廠別</label>
        <input data-field="TranFacType">
        <label>狀態</label>
        <input data-field="iPNStatus">

        <label>終端客戶</label>
        <input class="field-wide" data-field="YsLayer_s5">

        <label>狀態勾選</label>
        <div class="matinfo-checks field-wide">
          <label><input type="checkbox" data-field="MB"> 購入</label>
          <label><input type="checkbox" data-field="IsTrans"> 已轉正式</label>
          <label><input type="checkbox" data-field="IsEMO"> 已轉工程</label>
          <label><input type="checkbox" data-field="Status"> 正式料號</label>
          <label><input type="checkbox" data-field="StopOrder"> 停止下單</label>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-basic2" role="tabpanel" data-tab-name="基本資料2">
      <div class="matinfo-section">
        <div class="matinfo-section-title">基本資料2</div>
        <div class="matinfo-box">
          <div class="matinfo-abs-layout" id="matinfo-basic2-abs"></div>
          <div class="matinfo-grid" id="matinfo-basic2-grid"></div>
          <div class="text-muted" id="matinfo-basic2-empty">沒有可顯示欄位</div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-cust" role="tabpanel" data-tab-name="廠商料號">
      <div class="matinfo-section">
        <div class="matinfo-section-title">廠商料號</div>
        <div class="matinfo-box" id="matinfo-cust-wrap">
          <div class="matinfo-grid-toolbar">
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnCustFirst" title="第一筆" aria-label="第一筆"><i class="bi bi-chevron-bar-left"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnCustPrev" title="上一筆" aria-label="上一筆"><i class="bi bi-chevron-left"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnCustNext" title="下一筆" aria-label="下一筆"><i class="bi bi-chevron-right"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnCustLast" title="最後一筆" aria-label="最後一筆"><i class="bi bi-chevron-bar-right"></i></button>
            <button type="button" class="btn btn-outline-success btn-icon" id="btnCustAdd" title="新增" aria-label="新增"><i class="bi bi-plus-lg"></i></button>
            <button type="button" class="btn btn-outline-danger btn-icon" id="btnCustDelete" title="刪除" aria-label="刪除"><i class="bi bi-dash-lg"></i></button>
            <button type="button" class="btn btn-outline-primary btn-icon" id="btnCustSave" title="儲存" aria-label="儲存"><i class="bi bi-check-lg"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnCustCancel" title="取消" aria-label="取消"><i class="bi bi-x-lg"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnCustRefresh" title="重新整理" aria-label="重新整理"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
          <div class="matinfo-grid-table">
            <table id="matinfo-cust-table">
            <thead>
              <tr>
                <th style="width: 120px;">客戶代碼</th>
                <th style="width: 140px;">客戶簡稱</th>
                <th style="width: 200px;">客戶品號</th>
                <th style="width: 200px;">物品說明</th>
                <th style="width: 160px;">材質</th>
                <th style="width: 140px;">尺寸</th>
                <th style="width: 160px;">機械性質</th>
                <th style="width: 160px;">貿易條款</th>
                <th style="width: 160px;">交貨狀態</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="9">尚未接廠商料號資料</td>
              </tr>
            </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
          <div class="tab-pane fade" id="tab-stock" role="tabpanel" data-tab-name="庫存設定">
      <div class="matinfo-section">
        <div class="matinfo-section-title">庫存設定</div>
        <div class="matinfo-grid">
          <label>最小包裝量</label>
          <input data-field="LeastBag">
          <label>最小訂購量</label>
          <input data-field="OrderQnty">
          <label>超收%</label>
          <input data-field="Accept">

          <label>Lead Time</label>
          <input data-field="LeadTime">
          <label>安全庫存</label>
          <input data-field="SafeQnty">
          <label>固定補足量</label>
          <input data-field="FixQnty">

          <label>固定補足時間</label>
          <input data-field="FixDate">
          <label>安全點天數</label>
          <input data-field="SafeDay">
          <label>耗損率%</label>
          <input data-field="ScrapRate">

          <label>保存天數</label>
          <input data-field="KeepTime">
          <label>平均月用量</label>
          <input data-field="AvgMonQnty" readonly>
          <label>平均日用量</label>
          <input data-field="AvgDayQnty" readonly>

          <label>記錄平均用量起</label>
          <input data-field="SetFromDate">
          <label>迄</label>
          <input data-field="SetDueDate">
          <label>現有庫存</label>
          <input data-field="StockQnty" readonly>

          <label>物料型態</label>
          <input data-field="MatClassType">
          <label>耗用分類</label>
          <input data-field="AccountType">
          <label>倉別</label>
          <input data-field="StockId">

          <label>庫位</label>
          <input data-field="PosId">
          <label>自訂分類一</label>
          <input data-field="MatClass1">
          <label>自訂分類二</label>
          <input data-field="MatClass2">

          <label>管理</label>
          <div class="matinfo-checks field-wide">
            <label><input type="checkbox" data-field="iNeedBatchNum"> 批號管理</label>
            <label><input type="checkbox" data-field="iNeedDateCode"> DateCode 管理</label>
            <label><input type="checkbox" data-field="iNeedExpiredDate"> 效期管制</label>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-prop" role="tabpanel" data-tab-name="屬性及備註">
      <div class="matinfo-split">
        <div class="matinfo-box" id="matinfo-prop-wrap">
          <div class="matinfo-section-title">屬性清單</div>
          <table id="matinfo-prop-table">
            <thead>
              <tr>
                <th style="width: 70px;">屬性</th>
                <th style="width: 140px;">屬性名</th>
                <th style="width: 140px;">項目</th>
                <th style="width: 180px;">項目名</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="4">尚未接屬性明細資料</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="matinfo-box">
          <div class="matinfo-section-title">備註</div>
          <textarea class="matinfo-textarea" data-field="Notes"></textarea>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-map" role="tabpanel" data-tab-name="工程圖">
      <div class="matinfo-section">
        <div class="matinfo-section-title">工程圖清單</div>
        <div class="matinfo-toolbar" style="justify-content: flex-start; margin-bottom: 8px;">
          <button type="button" class="btn toolbar-btn" disabled>檢視圖檔 (開視窗)</button>
          <button type="button" class="btn toolbar-btn" disabled>檢視圖檔 (跳至圖檔頁籤)</button>
          <button type="button" class="btn toolbar-btn" disabled>指定路徑及檔名</button>
        </div>
        <div class="matinfo-box" id="matinfo-map-wrap">
          <div class="matinfo-grid-toolbar">
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnMapFirst" title="第一筆" aria-label="第一筆"><i class="bi bi-chevron-bar-left"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnMapPrev" title="上一筆" aria-label="上一筆"><i class="bi bi-chevron-left"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnMapNext" title="下一筆" aria-label="下一筆"><i class="bi bi-chevron-right"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnMapLast" title="最後一筆" aria-label="最後一筆"><i class="bi bi-chevron-bar-right"></i></button>
            <button type="button" class="btn btn-outline-success btn-icon" id="btnMapAdd" title="新增" aria-label="新增"><i class="bi bi-plus-lg"></i></button>
            <button type="button" class="btn btn-outline-danger btn-icon" id="btnMapDelete" title="刪除" aria-label="刪除"><i class="bi bi-dash-lg"></i></button>
            <button type="button" class="btn btn-outline-primary btn-icon" id="btnMapSave" title="儲存" aria-label="儲存"><i class="bi bi-check-lg"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnMapCancel" title="取消" aria-label="取消"><i class="bi bi-x-lg"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnMapRefresh" title="重新整理" aria-label="重新整理"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
          <div class="matinfo-grid-table">
            <table id="matinfo-map-table">
            <thead>
              <tr>
                <th style="width: 70px;">序號</th>
                <th>圖檔完整路徑及檔名</th>
                <th style="width: 220px;">說明</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3">尚未接工程圖資料</td>
              </tr>
            </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-glyph" role="tabpanel" data-tab-name="圖檔">
      <div class="matinfo-section">
        <div class="matinfo-section-title">圖檔</div>
        <div class="matinfo-grid">
          <label>料號</label>
          <input data-field="Partnum" readonly>
          <label>品名</label>
          <input data-field="MatName" readonly>
          <label>圖檔序號</label>
          <input data-field="SerialNum" readonly>
        </div>
      </div>
      <div class="matinfo-image-box">無 圖 檔</div>
    </div>

    <div class="tab-pane fade" id="tab-entrust" role="tabpanel" data-tab-name="承委製作資料表">
      <div class="matinfo-section">
        <div class="matinfo-section-title">承委製作資料表</div>
        <div class="matinfo-box">
          <div class="text-muted">尚未設定顯示欄位</div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-demand" role="tabpanel" data-tab-name="成品要求">
      <div class="matinfo-section">
        <div class="matinfo-section-title">成品要求</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 70px;">代號</th>
                <th style="width: 200px;">要求名稱</th>
                <th style="width: 120px;">需要有值</th>
                <th>要求內容</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="4">尚未接成品要求資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-spec" role="tabpanel" data-tab-name="規格表">
      <div class="matinfo-section">
        <div class="matinfo-section-title">規格表</div>
        <div class="matinfo-toolbar" style="justify-content: flex-start; margin-bottom: 8px;">
          <button type="button" class="btn toolbar-btn" disabled>重新匯入</button>
          <button type="button" class="btn toolbar-btn" disabled>全部清除</button>
          <button type="button" class="btn toolbar-btn" disabled>列印</button>
        </div>
        <div class="matinfo-grid">
          <label>單號</label>
          <input data-field="PaperNum" readonly>
          <label>種類</label>
          <input data-field="SpecType">
          <label>種類名</label>
          <input data-field="Lk_SpecTypeName" readonly>
        </div>
      </div>
      <div class="matinfo-box">
        <table>
          <thead>
            <tr>
              <th style="width: 70px;">代號</th>
              <th style="width: 180px;">屬性名</th>
              <th>屬性內容</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="3">尚未接規格表資料</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-unit" role="tabpanel" data-tab-name="替代單位設定">
      <div class="matinfo-section">
        <div class="matinfo-section-title">替代單位設定</div>
        <div class="matinfo-box" id="matinfo-unit-wrap">
          <div class="matinfo-grid-toolbar">
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnUnitFirst" title="第一筆" aria-label="第一筆"><i class="bi bi-chevron-bar-left"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnUnitPrev" title="上一筆" aria-label="上一筆"><i class="bi bi-chevron-left"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnUnitNext" title="下一筆" aria-label="下一筆"><i class="bi bi-chevron-right"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnUnitLast" title="最後一筆" aria-label="最後一筆"><i class="bi bi-chevron-bar-right"></i></button>
            <button type="button" class="btn btn-outline-success btn-icon" id="btnUnitAdd" title="新增" aria-label="新增"><i class="bi bi-plus-lg"></i></button>
            <button type="button" class="btn btn-outline-danger btn-icon" id="btnUnitDelete" title="刪除" aria-label="刪除"><i class="bi bi-dash-lg"></i></button>
            <button type="button" class="btn btn-outline-primary btn-icon" id="btnUnitSave" title="儲存" aria-label="儲存"><i class="bi bi-check-lg"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnUnitCancel" title="取消" aria-label="取消"><i class="bi bi-x-lg"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" id="btnUnitRefresh" title="重新整理" aria-label="重新整理"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
          <div class="matinfo-grid-table">
            <table id="matinfo-unit-table">
            <thead>
              <tr>
                <th style="width: 120px;">替代單位</th>
                <th style="width: 120px;">換算比</th>
                <th style="width: 140px;">用途類型</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="4">尚未接替代單位資料</td>
              </tr>
            </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-common" role="tabpanel" data-tab-name="共用件">
      <div class="matinfo-section">
        <div class="matinfo-section-title">共用件</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 70px;">序號</th>
                <th style="width: 140px;">共用料號</th>
                <th style="width: 200px;">品名</th>
                <th style="width: 120px;">使用量</th>
                <th style="width: 120px;">基礎用量</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5">尚未接共用件資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-avl" role="tabpanel" data-tab-name="廠商AVL">
      <div class="matinfo-section">
        <div class="matinfo-section-title">廠商 AVL</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 70px;">序號</th>
                <th style="width: 120px;">供應商</th>
                <th style="width: 140px;">供應商名稱</th>
                <th style="width: 100px;">UOM</th>
                <th style="width: 120px;">UOM數量</th>
                <th style="width: 120px;">數量</th>
                <th style="width: 120px;">單價</th>
                <th style="width: 120px;">幣別</th>
                <th style="width: 100px;">匯率</th>
                <th style="width: 140px;">付款方式</th>
                <th style="width: 140px;">發票種類</th>
                <th style="width: 140px;">報價日</th>
                <th style="width: 140px;">有效日</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="13">尚未接廠商 AVL 資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-cusprice" role="tabpanel" data-tab-name="客戶價格表">
      <div class="matinfo-section">
        <div class="matinfo-section-title">客戶價格表</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 70px;">序號</th>
                <th style="width: 120px;">客戶</th>
                <th style="width: 140px;">客戶名稱</th>
                <th style="width: 100px;">UOM</th>
                <th style="width: 120px;">UOM數量</th>
                <th style="width: 120px;">數量</th>
                <th style="width: 120px;">單價</th>
                <th style="width: 120px;">幣別</th>
                <th style="width: 100px;">匯率</th>
                <th style="width: 140px;">付款方式</th>
                <th style="width: 140px;">發票種類</th>
                <th style="width: 140px;">報價日</th>
                <th style="width: 140px;">有效日</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="13">尚未接客戶價格表資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-price" role="tabpanel" data-tab-name="價格">
      <div class="matinfo-section">
        <div class="matinfo-section-title">價格</div>
        <div class="matinfo-grid compact">
          <label>標準成本單價</label>
          <input data-field="STDCostUp">
          <label>價格1</label>
          <input data-field="UnitPrice1">
          <label>價格2</label>
          <input data-field="UnitPrice2">
          <label>價格3</label>
          <input data-field="UnitPrice3">
          <label>價格4</label>
          <input data-field="UnitPrice4">
          <label>價格5</label>
          <input data-field="UnitPrice5">
          <label>價格6</label>
          <input data-field="UnitPrice6">
          <label>價格7</label>
          <input data-field="UnitPrice7">
          <label>價格8</label>
          <input data-field="UnitPrice8">
          <label>價格9</label>
          <input data-field="UnitPrice9">
          <label>價格10</label>
          <input data-field="UnitPrice10">
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-notes" role="tabpanel" data-tab-name="其他備註">
      <div class="matinfo-section">
        <div class="matinfo-section-title">其他備註 (文字)</div>
        <div class="matinfo-grid compact">
          <label>備註1(文字)</label>
          <input data-field="NotesVarch1">
          <label>備註2(文字)</label>
          <input data-field="NotesVarch2">
          <label>備註3(文字)</label>
          <input data-field="NotesVarch3">
          <label>備註4(文字)</label>
          <input data-field="NotesVarch4">
          <label>備註5(文字)</label>
          <input data-field="NotesVarch5">
          <label>備註6(文字)</label>
          <input data-field="NotesVarch6">
          <label>備註7(文字)</label>
          <input data-field="NotesVarch7">
          <label>備註8(文字)</label>
          <input data-field="NotesVarch8">
          <label>備註9(文字)</label>
          <input data-field="NotesVarch9">
          <label>備註10(文字)</label>
          <input data-field="NotesVarch10">
        </div>
      </div>
      <div class="matinfo-section">
        <div class="matinfo-section-title">其他備註 (數字)</div>
        <div class="matinfo-grid compact">
          <label>備註11(數字)</label>
          <input data-field="NotesDecim1">
          <label>備註12(數字)</label>
          <input data-field="NotesDecim2">
          <label>備註13(數字)</label>
          <input data-field="NotesDecim3">
          <label>備註14(數字)</label>
          <input data-field="NotesDecim4">
          <label>備註15(數字)</label>
          <input data-field="NotesDecim5">
          <label>備註16(數字)</label>
          <input data-field="NotesDecim6">
          <label>備註17(數字)</label>
          <input data-field="NotesDecim7">
          <label>備註18(數字)</label>
          <input data-field="NotesDecim8">
          <label>備註19(數字)</label>
          <input data-field="NotesDecim9">
          <label>備註20(數字)</label>
          <input data-field="NotesDecim10">
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-packing" role="tabpanel" data-tab-name="Packing">
      <div class="matinfo-section">
        <div class="matinfo-section-title">Packing</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 70px;">項次</th>
                <th style="width: 120px;">箱型</th>
                <th style="width: 120px;">數量</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="4">尚未接 Packing 資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-kit" role="tabpanel" data-tab-name="組合商品">
      <div class="matinfo-section">
        <div class="matinfo-section-title">組合商品</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 80px;">項次</th>
                <th style="width: 160px;">組合料號</th>
                <th style="width: 200px;">品名</th>
                <th style="width: 100px;">單位</th>
                <th style="width: 120px;">數量</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="6">尚未接組合商品資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-delivery" role="tabpanel" data-tab-name="廠商送貨明細檔">
      <div class="matinfo-section">
        <div class="matinfo-section-title">廠商送貨明細檔</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 70px;">項次</th>
                <th style="width: 160px;">標題</th>
                <th style="width: 120px;">倉別</th>
                <th style="width: 120px;">庫位</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5">尚未接送貨明細資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-depart" role="tabpanel" data-tab-name="部門領料倉別明細檔">
      <div class="matinfo-section">
        <div class="matinfo-section-title">部門領料倉別明細檔</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 120px;">部門代碼</th>
                <th style="width: 160px;">部門名稱</th>
                <th style="width: 120px;">倉別</th>
                <th style="width: 120px;">庫位</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5">尚未接部門領料資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-engrave" role="tabpanel" data-tab-name="射出紀錄">
      <div class="matinfo-section">
        <div class="matinfo-section-title">射出紀錄</div>
        <div class="matinfo-box">
          <table>
            <thead>
              <tr>
                <th style="width: 120px;">項次</th>
                <th style="width: 200px;">內容</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3">尚未接射出紀錄資料</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="matinfo-log-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">歷史紀錄</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="matinfo-section">
          <div class="matinfo-section-title">更新記錄</div>
          <div class="matinfo-box">
            <table id="matinfo-log-master">
              <thead></thead>
              <tbody>
                <tr><td>尚無更新記錄</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="matinfo-section">
          <div class="matinfo-section-title">歷史</div>
          <div class="matinfo-box">
            <table id="matinfo-log-history">
              <thead></thead>
              <tbody>
                <tr><td>尚無歷史記錄</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@await Html.PartialAsync("~/Pages/CustomButton/MatInfoAdd.cshtml", null, ViewData)
@await Html.PartialAsync("~/Pages/CustomButton/MatInfoSearch.cshtml", null, ViewData)
@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", null, ViewData)

@section Scripts {
<script src="~/js/editableGrid.js" asp-append-version="true"></script>
<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>
<script>
(() => {
  const tbody = document.getElementById('matinfo-browse-body');
  const theadRow = document.getElementById('matinfo-browse-head');
  const form = document.querySelector('.matinfo-form');
    const countEl = document.getElementById('matinfo-count');
  const browseScrollTop = document.getElementById('matinfo-browse-scroll-top');
  const browseScrollBody = document.getElementById('matinfo-browse-scroll-body');
  const formScrollTop = document.getElementById('matinfo-form-scroll-top');
  const formScrollBody = document.getElementById('matinfo-form-scroll-body');
    const btnQuery = document.getElementById('btnMatInfoQuery');
    const btnEdit = document.getElementById('btnMatInfoEdit');
    const btnCancel = document.getElementById('btnMatInfoCancel');
    const btnAdd = document.getElementById('btnMatInfoAdd');
  const btnToFormal = document.getElementById('btnMatInfoToFormal');
  const btnDetail = document.getElementById('btnMatInfoDetail');
  const btnHistory = document.getElementById('btnMatInfoHistory');
  const btnToEmo = document.getElementById('btnMatInfoToEmo');
  const btnDelete = document.getElementById('btnMatInfoDelete');
  const btnSave = document.getElementById('btnMatInfoSave');
  const btnTabPrev = document.getElementById('btnMatInfoTabPrev');
  const btnTabNext = document.getElementById('btnMatInfoTabNext');
  const unitTable = document.getElementById('matinfo-unit-table');
  const unitWrap = document.getElementById('matinfo-unit-wrap');
  const custTable = document.getElementById('matinfo-cust-table');
  const custWrap = document.getElementById('matinfo-cust-wrap');
  const propTable = document.getElementById('matinfo-prop-table');
  const propWrap = document.getElementById('matinfo-prop-wrap');
  const mapTable = document.getElementById('matinfo-map-table');
  const mapWrap = document.getElementById('matinfo-map-wrap');
  const btnUnitFirst = document.getElementById('btnUnitFirst');
  const btnUnitPrev = document.getElementById('btnUnitPrev');
  const btnUnitNext = document.getElementById('btnUnitNext');
  const btnUnitLast = document.getElementById('btnUnitLast');
  const btnUnitAdd = document.getElementById('btnUnitAdd');
  const btnUnitDelete = document.getElementById('btnUnitDelete');
  const btnUnitSave = document.getElementById('btnUnitSave');
  const btnUnitCancel = document.getElementById('btnUnitCancel');
  const btnUnitRefresh = document.getElementById('btnUnitRefresh');
  const btnCustFirst = document.getElementById('btnCustFirst');
  const btnCustPrev = document.getElementById('btnCustPrev');
  const btnCustNext = document.getElementById('btnCustNext');
  const btnCustLast = document.getElementById('btnCustLast');
  const btnCustAdd = document.getElementById('btnCustAdd');
  const btnCustDelete = document.getElementById('btnCustDelete');
  const btnCustSave = document.getElementById('btnCustSave');
  const btnCustCancel = document.getElementById('btnCustCancel');
  const btnCustRefresh = document.getElementById('btnCustRefresh');
  const btnMapFirst = document.getElementById('btnMapFirst');
  const btnMapPrev = document.getElementById('btnMapPrev');
  const btnMapNext = document.getElementById('btnMapNext');
  const btnMapLast = document.getElementById('btnMapLast');
  const btnMapAdd = document.getElementById('btnMapAdd');
  const btnMapDelete = document.getElementById('btnMapDelete');
  const btnMapSave = document.getElementById('btnMapSave');
  const btnMapCancel = document.getElementById('btnMapCancel');
  const btnMapRefresh = document.getElementById('btnMapRefresh');
  const browseBox = document.getElementById('matinfo-browse');
  const logModalEl = document.getElementById('matinfo-log-modal');
  const logModal = window.bootstrap?.Modal ? window.bootstrap.Modal.getOrCreateInstance(logModalEl, { backdrop: "static" }) : null;
  let logBackdrop = null;
  const logMasterTable = document.getElementById('matinfo-log-master');
  const logHistoryTable = document.getElementById('matinfo-log-history');
  const basic2Grid = document.getElementById('matinfo-basic2-grid');
  const basic2Empty = document.getElementById('matinfo-basic2-empty');
  const basic1Grid = document.querySelector('#tab-basic .matinfo-grid');
  const basic1Abs = document.getElementById('matinfo-basic1-abs');
  const basic2Abs = document.getElementById('matinfo-basic2-abs');

  let currentRecord = null;
  let currentKey = null;
    let isNew = false;
    let isEditMode = false;
    let cancelSnapshot = null;
    let preserveCancelSnapshot = false;
    let totalCount = 0;
    let currentIndex = 0;
    let columns = [];
    let dataCache = [];
    let loadedPages = new Set();
    let isSearchMode = false;
    let pendingSelectIndex = null;
    let rowHeight = 24;
    let sortKey = null;
    let sortDir = 'asc';
    let renderScheduled = false;
    const pageSize = 200;
    const bufferRows = 8;
  const detailGrids = [];
  let unitGrid = null;
  let custGrid = null;
  let propGrid = null;
  let mapGrid = null;
  const itemId = '@Model.ItemId';
    const dictTableName = (() => {
      const id = (itemId || '').toUpperCase();
      if (id === 'MG000008' || id === 'CPN00006') return 'MGN_MINdMatInfo2';
      if (id === 'MG000002' || id === 'CPN00007') return 'MGN_MINdMatInfo40';
      return 'MINdMatInfo';
    })();

    const dictSearchTableName = (() => {
      const id = (itemId || '').toUpperCase();
      if (id === 'MG000008' || id === 'CPN00006') return 'MGN_MINdMatInfo21';
      if (id === 'MG000002' || id === 'CPN00007') return 'MGN_MINdMatInfo41';
      return dictTableName;
    })();

  const dictPanelTableName = (() => {
    const id = (itemId || '').toUpperCase();
    if (id === 'MG000008' || id === 'CPN00006') return 'MGN_MINdMatInfo2PNL';
    if (id === 'MG000002' || id === 'CPN00007') return 'MGN_MINdMatInfo40PNL';
    return dictTableName;
  })();
  const custTabLabel = (() => {
    const id = (itemId || '').toUpperCase();
    return (id === 'MG000008' || id === 'CPN00006') ? '客戶料號' : '廠商料號';
  })();
  const useCommonTable = dictTableName.trim().toLowerCase() !== 'mindmatinfo';
  const commonKeyFields = ['PartNum', 'Revision'];

  const tabDictTableMap = new Map([
    ['基本資料', dictPanelTableName],
    ['基本資料2', dictPanelTableName],
    ['廠商料號', 'MGNdCustPartNum'],
    ['屬性及備註', 'MGNdMatInfoDtl'],
    ['工程圖', 'MGNdProdMap'],
    ['圖檔', 'MGNdProdMap'],
    ['替代單位設定', 'MINdMatUnit']
  ]);

  window._dictTableName = dictTableName;
  document.querySelectorAll('.matinfo-form, .matinfo-tabs').forEach((el) => {
    el.dataset.dictTable = dictPanelTableName;
  });
  document.querySelectorAll('#matinfo-browse, #matinfo-browse-scroll-top, #matinfo-browse-scroll-body').forEach((el) => {
    el.dataset.dictTable = dictTableName;
  });
  const dictCache = { fields: null };
  const dictTypeMap = new Map();
  const formDictCache = { fields: null };
  const formDictTypeMap = new Map();
  const numericTypes = new Set(['int', 'smallint', 'tinyint', 'bigint', 'decimal', 'numeric', 'float', 'real', 'money', 'smallmoney']);
  const dateTypes = new Set(['date', 'datetime', 'smalldatetime', 'datetime2', 'datetimeoffset', 'time']);
  const forcedNumericFields = new Set([
    'llpcs', 'scraprate', 'accept', 'avgdayqnty', 'avgmonqnty', 'leastbag',
    'length', 'width', 'orderqnty', 'stockqnty', 'safeqnty', 'fixqnty',
    'fixdate', 'safeday', 'leadtime', 'usein', 'matclasstype', 'accounttype',
    'mb', 'status', 'istrans', 'isemo', 'ipnstatus', 'tranfactype',
    'stoporder', 'minlot', 'maxqnty', 'minqnty', 'stdusage', 'stdcostup',
    'unitprice1', 'unitprice2', 'unitprice3', 'unitprice4', 'unitprice5',
    'unitprice6', 'unitprice7', 'unitprice8', 'unitprice9', 'unitprice10',
    'notesdecim1', 'notesdecim2', 'notesdecim3', 'notesdecim4', 'notesdecim5',
    'notesdecim6', 'notesdecim7', 'notesdecim8', 'notesdecim9', 'notesdecim10',
    'weight', 'keeptime', 'scrapqnty', 'onwayqnty', 'bakfree', 'minorderqnty',
    'allowxoutrate', 'allowxoutqnty', 'boardarea', 'dheight', 'dvolume',
    'dlengthmax', 'dwidthmax', 'dheightmax', 'dvolumemax', 'dpackqntymax',
    'dvolumeaddon'
  ]);

  const layoutFieldKeys = [
    'iLayRow', 'iLayColumn', 'iLabHeight', 'iLabTop', 'iLabLeft', 'iLabWidth',
    'iFieldHeight', 'iFieldTop', 'iFieldLeft', 'iFieldWidth'
  ];
  const layoutShowWhereKey = 'iShowWhere';

  function getFieldKey(row) {
    return (row?.FieldName || row?.fieldName || '').toString().trim().toLowerCase();
  }

  function mergePanelFields(baseRows, panelRows) {
    const baseList = Array.isArray(baseRows) ? baseRows : [];
    const panelList = Array.isArray(panelRows) ? panelRows : [];
    if (!panelList.length) return baseList;

    const shouldApplyLayoutValue = (val) => {
      if (val === null || val === undefined || val === '') return false;
      const num = Number(val);
      return Number.isFinite(num) && num > 0;
    };

    const panelMap = new Map();
    panelList.forEach((row) => {
      const key = getFieldKey(row);
      if (key) panelMap.set(key, row);
    });

    const seen = new Set();
    const merged = baseList.map((row) => {
      const key = getFieldKey(row);
      if (!key) return row;
      seen.add(key);
      const panel = panelMap.get(key);
      if (!panel) return row;
      const next = { ...row };
      layoutFieldKeys.forEach((k) => {
        const v = getRowValue(panel, k);
        if (shouldApplyLayoutValue(v)) next[k] = v;
      });
      const showWhere = getRowValue(panel, layoutShowWhereKey);
      if (showWhere !== null && showWhere !== undefined && showWhere !== '') {
        next[layoutShowWhereKey] = showWhere;
      }
      const baseLabel = (getRowValue(next, 'DisplayLabel') ?? '').toString().trim();
      const panelLabel = (getRowValue(panel, 'DisplayLabel') ?? '').toString().trim();
      if (!baseLabel && panelLabel) next.DisplayLabel = panelLabel;
      if (getRowValue(next, 'Visible') == null && getRowValue(panel, 'Visible') != null)
        next.Visible = getRowValue(panel, 'Visible');
      if (getRowValue(next, 'ReadOnly') == null && getRowValue(panel, 'ReadOnly') != null)
        next.ReadOnly = getRowValue(panel, 'ReadOnly');
      return next;
    });

    return merged;
  }

  const preferredColumns = [
    'Partnum', 'MatName', 'Unit', 'EngGauge', 'Grade', 'MatClass', 'Revision',
    'StockId', 'PosId', 'UseIn', 'Build_UserId', 'Build_Date', 'Update_UserId',
    'Update_Date', 'Status', 'IsTrans', 'IsEMO'
  ];

  const columnLabels = {
    Partnum: '料號',
    MatName: '品名',
    Unit: '單位',
    EngGauge: '規格',
    Grade: '等級',
    MatClass: '分類',
    Revision: '版次',
    StockId: '倉別',
    PosId: '庫位',
    UseIn: '用途',
    Build_UserId: '建檔者',
    Build_Date: '建檔日期',
    Update_UserId: '更新者',
    Update_Date: '更新日期',
    Status: '狀態',
    IsTrans: '已轉正式',
    IsEMO: '已轉工程'
  };

  const notify = (type, message) => {
    if (window.Swal) {
      const icon = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
      return window.Swal.fire({ icon, title: message });
    }
    alert(message);
  };

  const withJwtHeaders = (init = {}) => {
    const jwt = localStorage.getItem('jwtId');
    const headers = Object.assign({}, init.headers || {});
    if (jwt) headers['X-JWTID'] = jwt;
    return { ...init, headers };
  };

  const applyTabDictTables = () => {
    document.querySelectorAll('.matinfo-form .tab-pane').forEach((pane) => {
      const name = pane.dataset.tabName || '';
      const table = tabDictTableMap.get(name);
      if (table) {
        pane.dataset.dictTable = table;
      } else if (!pane.dataset.dictTable) {
        pane.dataset.dictTable = dictPanelTableName;
      }
    });
    document.querySelectorAll('.matinfo-tabs .nav-link').forEach((btn) => {
      const name = btn.dataset.tabName || btn.textContent?.trim();
      const table = tabDictTableMap.get(name || '');
      if (table) btn.dataset.dictTable = table;
    });
  };

  const applyCustTabLabel = () => {
    const btn = document.querySelector('.matinfo-tabs [data-bs-target="#tab-cust"]');
    if (btn) {
      btn.textContent = custTabLabel;
      btn.setAttribute('aria-label', custTabLabel);
    }
    const pane = document.querySelector('#tab-cust');
    if (pane) {
      const title = pane.querySelector('.matinfo-section-title');
      if (title) title.textContent = custTabLabel;
    }
    const emptyCell = document.querySelector('#tab-cust tbody td');
    if (emptyCell && (emptyCell.textContent || '').includes('尚未接')) {
      emptyCell.textContent = `尚未接${custTabLabel}資料`;
    }
  };

  const setActiveTabContext = (btn) => {
    document.querySelectorAll('.matinfo-form .tab-pane.ctx-current').forEach((pane) => {
      pane.classList.remove('ctx-current');
    });
    const target = btn?.dataset?.bsTarget;
    if (!target) return;
    const pane = document.querySelector(target);
    if (pane) pane.classList.add('ctx-current');
  };

  const createDetailGridManager = (cfg) => {
    const state = {
      rows: [],
      selectedIndex: -1,
      grid: null,
      loading: false
    };

    const getKey = () => ({
      partnum: currentKey?.partnum ?? '',
      revision: currentKey?.revision ?? ''
    });

    const setToolbarEnabled = () => {
      const hasKey = !!getKey().partnum;
      const hasRows = state.rows.length > 0;
      const inEdit = !!isEditMode;
      const navDisabled = !hasKey || !hasRows;
      const setDisabled = (btn, disabled) => { if (btn) btn.disabled = disabled; };
      setDisabled(cfg.toolbar.first, navDisabled);
      setDisabled(cfg.toolbar.prev, navDisabled);
      setDisabled(cfg.toolbar.next, navDisabled);
      setDisabled(cfg.toolbar.last, navDisabled);
      setDisabled(cfg.toolbar.add, !hasKey || !inEdit);
      setDisabled(cfg.toolbar.del, !hasKey || !inEdit || state.selectedIndex < 0);
      setDisabled(cfg.toolbar.save, !hasKey || !inEdit);
      setDisabled(cfg.toolbar.cancel, !hasKey || !inEdit);
      setDisabled(cfg.toolbar.refresh, !hasKey);
    };

    const selectRow = (index) => {
      const rows = Array.from(cfg.table.querySelectorAll('tbody tr'));
      if (!rows.length) return;
      const next = Math.max(0, Math.min(index, rows.length - 1));
      rows.forEach((tr) => tr.classList.remove('is-selected'));
      const target = rows[next];
      target.classList.add('is-selected');
      state.selectedIndex = next;
      target.scrollIntoView({ block: 'nearest' });
      setToolbarEnabled();
    };

    const buildCell = (name, value, readonly, type) => {
      const td = document.createElement('td');
      const span = document.createElement('span');
      span.className = 'cell-view';
      if (type === 'checkbox') {
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.disabled = true;
        chk.checked = value === 1 || value === true || value === '1';
        span.appendChild(chk);
      } else {
        span.textContent = value ?? '';
      }
      const input = document.createElement('input');
      input.className = 'cell-edit d-none';
      input.name = name;
      if (type === 'checkbox') {
        input.type = 'checkbox';
        input.checked = value === 1 || value === true || value === '1';
      } else {
        input.value = value ?? '';
      }
      if (readonly) input.dataset.readonly = '1';
      td.appendChild(span);
      td.appendChild(input);
      return td;
    };

    const renderRows = () => {
      const tbodyEl = cfg.table.querySelector('tbody');
      if (!tbodyEl) return;
      tbodyEl.innerHTML = '';
      if (!state.rows.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="${cfg.columns.length}">沒有資料</td>`;
        tbodyEl.appendChild(tr);
        state.selectedIndex = -1;
        setToolbarEnabled();
        return;
      }

      state.rows.forEach((row, idx) => {
        const tr = document.createElement('tr');
        tr.dataset.index = String(idx);
        if (row.__state === 'deleted') tr.classList.add('is-deleted');
        if (row.__state === 'added') {
          tr.dataset.state = 'added';
          tr.classList.add('table-warning');
        }

        const hiddenPart = document.createElement('input');
        hiddenPart.type = 'hidden';
        hiddenPart.name = 'PartNum';
        hiddenPart.value = getKey().partnum;
        hiddenPart.className = 'mmd-fk-hidden';
        tr.appendChild(hiddenPart);

        const hiddenRev = document.createElement('input');
        hiddenRev.type = 'hidden';
        hiddenRev.name = 'Revision';
        hiddenRev.value = getKey().revision;
        hiddenRev.className = 'mmd-fk-hidden';
        tr.appendChild(hiddenRev);

        cfg.columns.forEach((col) => {
          tr.appendChild(buildCell(col.name, getRowValue(row, col.name), col.readonly, col.type));
        });

        tr.addEventListener('click', () => selectRow(idx));
        tbodyEl.appendChild(tr);
      });

      if (state.selectedIndex < 0) {
        selectRow(0);
      } else {
        selectRow(state.selectedIndex);
      }

      if (!state.grid && typeof window.makeEditableGrid === 'function') {
        state.grid = window.makeEditableGrid({
          wrapper: cfg.wrap,
          table: cfg.table,
          tableName: cfg.tableName,
          keyFields: cfg.keyFields
        });
      }
      if (state.grid) state.grid.toggleEdit(isEditMode);
      setToolbarEnabled();
    };

    const loadRows = async () => {
      if (!getKey().partnum) {
        state.rows = [];
        renderRows();
        return;
      }
      state.loading = true;
      try {
        const params = new URLSearchParams();
        params.set('table', cfg.tableName);
        params.append('keyNames', 'PartNum');
        params.append('keyValues', getKey().partnum);
        params.append('keyNames', 'Revision');
        params.append('keyValues', getKey().revision || '');
        const res = await fetch(`/api/CommonTable/ByKeys?${params.toString()}`);
        if (!res.ok) {
          state.rows = [];
          renderRows();
          return;
        }
        const data = await res.json();
        const rows = Array.isArray(data) ? data : [];
        state.rows = cfg.mapRows ? await cfg.mapRows(rows) : rows;
        renderRows();
      } finally {
        state.loading = false;
      }
    };

    const addRow = () => {
      if (!isEditMode || !getKey().partnum) return;
      const row = { PartNum: getKey().partnum, Revision: getKey().revision || '' };
      if (cfg.autoIncField) {
        const max = Math.max(0, ...state.rows.map((r) => Number(r[cfg.autoIncField]) || 0));
        row[cfg.autoIncField] = max + 1;
      }
      cfg.columns.forEach((col) => {
        if (row[col.name] === undefined) row[col.name] = col.default ?? '';
      });
      row.__state = 'added';
      state.rows.push(row);
      renderRows();
      selectRow(state.rows.length - 1);
    };

    const deleteRow = () => {
      if (!isEditMode) return;
      const idx = state.selectedIndex;
      if (idx < 0) return;
      const tr = cfg.table.querySelector(`tbody tr[data-index="${idx}"]`);
      if (!tr) return;
      if (tr.dataset.state === 'added') {
        state.rows.splice(idx, 1);
        renderRows();
        return;
      }
      tr.dataset.state = 'deleted';
      tr.classList.add('is-deleted');
      setToolbarEnabled();
    };

    const saveRows = async () => {
      if (!state.grid) return;
      const tbodyEl = cfg.table.querySelector('tbody');
      if (!tbodyEl) return;
      const missing = [];
      tbodyEl.querySelectorAll('tr').forEach((tr) => {
        if (tr.dataset.state === 'deleted') return;
        cfg.keyFields.forEach((key) => {
          if (key === 'PartNum' || key === 'Revision') return;
          const inp = tr.querySelector(`.cell-edit[name="${key}"]`);
          if (inp && !String(inp.value ?? '').trim()) missing.push(key);
        });
      });
      if (missing.length) {
        notify('error', `請先填寫：${Array.from(new Set(missing)).join(', ')}`);
        return;
      }
      const result = await state.grid.saveChanges();
      if (!result.ok) {
        notify('error', result.text || '儲存失敗');
        return;
      }
      await loadRows();
    };

    const cancelChanges = async () => {
      await loadRows();
    };

    const toggleEdit = (enabled) => {
      if (state.grid) state.grid.toggleEdit(enabled);
      setToolbarEnabled();
    };

    return {
      loadRows,
      addRow,
      deleteRow,
      saveRows,
      cancelChanges,
      selectRow,
      toggleEdit,
      setToolbarEnabled,
      getSelectedIndex: () => state.selectedIndex
    };
  };

  const custLookupState = {
    map: null,
    loading: null
  };

  const propLookupState = {
    data: null,
    loading: null
  };

  function positionLookupList(list, anchor) {
    if (!list || !anchor) return;
    const rect = anchor.getBoundingClientRect();
    const spaceBelow = window.innerHeight - rect.bottom;
    const maxHeight = Math.max(140, Math.min(260, spaceBelow - 8));
    const placeBelow = spaceBelow >= 140;
    list.style.position = 'fixed';
    list.style.left = `${Math.max(6, rect.left)}px`;
    list.style.top = placeBelow ? `${rect.bottom}px` : `${Math.max(6, rect.top - maxHeight)}px`;
    list.style.minWidth = `${Math.max(140, rect.width)}px`;
    list.style.maxHeight = `${maxHeight}px`;
  }

  async function buildLookupMapFromApi(table, key, result) {
    if (!table || !key || !result) return new Map();
    const resp = await fetch(`/api/TableFieldLayout/LookupData?table=${encodeURIComponent(table)}&key=${encodeURIComponent(key)}&result=${encodeURIComponent(result)}`);
    if (!resp.ok) return new Map();
    const data = await resp.json();
    const map = new Map();
    (data || []).forEach((row) => {
      const rawKey = row?.key;
      if (rawKey == null) return;
      const keyStr = String(rawKey);
      if (!keyStr) return;
      const labelParts = Object.keys(row || {})
        .filter((p) => p.startsWith('result'))
        .map((p) => row[p])
        .filter((v) => v != null && typeof v !== 'object' && String(v).trim() !== '')
        .map((v) => String(v));
      const label = labelParts.join(' - ');
      map.set(keyStr, label || keyStr);
      const trimmed = keyStr.trim();
      if (trimmed && trimmed !== keyStr) map.set(trimmed, label || trimmed);
    });
    return map;
  }

  async function loadCustCompanyLookup() {
    if (custLookupState.map) return custLookupState.map;
    if (custLookupState.loading) return custLookupState.loading;
    custLookupState.loading = (async () => {
      const res = await fetch(`/api/TableFieldLayout/GetTableFieldsFull?table=${encodeURIComponent('MGNdCustPartNum')}&lang=TW`);
      if (!res.ok) return new Map();
      const rows = await res.json();
      const meta = (rows || []).find((r) => {
        const field = (r.FieldName || r.fieldName || '').toString().trim().toLowerCase();
        return field === 'companyid';
      });
      const table = (meta?.LookupTable || meta?.lookupTable || '').toString();
      const key = (meta?.LookupKeyField || meta?.lookupKeyField || '').toString();
      const result = (meta?.LookupResultField || meta?.lookupResultField || '').toString();
      if (!table || !key || !result) return new Map();
      const map = await buildLookupMapFromApi(table, key, result);
      custLookupState.map = map;
      return map;
    })();
    const result = await custLookupState.loading;
    custLookupState.loading = null;
    return result;
  }

  async function loadPropLookups() {
    if (propLookupState.data) return propLookupState.data;
    if (propLookupState.loading) return propLookupState.loading;
    propLookupState.loading = (async () => {
      const res = await fetch(`/api/TableFieldLayout/GetTableFieldsFull?table=${encodeURIComponent('MGNdMatInfoDtl')}&lang=TW`);
      if (!res.ok) return { numMap: new Map(), dtlMap: new Map() };
      const rows = await res.json();
      const findMeta = (name) => (rows || []).find((r) => {
        const field = (r.FieldName || r.fieldName || '').toString().trim().toLowerCase();
        return field === name;
      });
      const numMeta = findMeta('numid');
      const dtlMeta = findMeta('dtlnumid');
      const numTable = (numMeta?.LookupTable || numMeta?.lookupTable || '').toString();
      const numKey = (numMeta?.LookupKeyField || numMeta?.lookupKeyField || '').toString();
      const numResult = (numMeta?.LookupResultField || numMeta?.lookupResultField || '').toString();
      const dtlTable = (dtlMeta?.LookupTable || dtlMeta?.lookupTable || '').toString();
      const dtlKey = (dtlMeta?.LookupKeyField || dtlMeta?.lookupKeyField || '').toString();
      const dtlResult = (dtlMeta?.LookupResultField || dtlMeta?.lookupResultField || '').toString();
      const numMap = await buildLookupMapFromApi(numTable, numKey, numResult);
      const dtlMap = await buildLookupMapFromApi(dtlTable, dtlKey, dtlResult);
      const payload = { numMap, dtlMap };
      propLookupState.data = payload;
      return payload;
    })();
    const result = await propLookupState.loading;
    propLookupState.loading = null;
    return result;
  }

  function openCustCompanyLookup(td, input, lookupMap) {
    if (!td || !input || !lookupMap || lookupMap.size === 0) return;
    const existing = document.querySelector('.lookup-dropdown-list');
    if (existing) existing.remove();
    const isReadOnly = input.dataset.readonly === '1' || input.readOnly;
    if (isReadOnly || !isEditMode) return;

    const currentKey = (input.value ?? '').toString().trim();
    const list = document.createElement('div');
    list.className = 'lookup-dropdown-list';

    const addItem = (key, label) => {
      const item = document.createElement('button');
      item.type = 'button';
      item.className = 'lookup-dropdown-item';
      item.dataset.key = key == null ? '' : String(key);
      const suffix = label && label !== key ? ` ${label}` : '';
      item.textContent = `${key ?? ''}${suffix}`.trim() || '(空白)';
      if ((currentKey ?? '') === (key ?? '')) item.classList.add('is-selected');
      list.appendChild(item);
    };

    addItem('', '');
    lookupMap.forEach((label, key) => addItem(key, label));

    const cleanup = () => {
      list.remove();
      document.removeEventListener('mousedown', onDocDown, true);
      window.removeEventListener('resize', onResize, true);
    };

    const applySelection = (key, label) => {
      const tr = td.closest('tr');
      const keyValue = key ?? '';
      input.value = keyValue;
      const view = td.querySelector('.cell-view');
      if (view) view.textContent = keyValue;
      const shortInput = tr?.querySelector('.cell-edit[name="ShortName"]');
      if (shortInput) {
        shortInput.value = label ?? '';
        const shortView = shortInput.closest('td')?.querySelector('.cell-view');
        if (shortView) shortView.textContent = label ?? '';
      }
      if (tr && tr.dataset.state !== 'added') tr.dataset.state = 'modified';
      cleanup();
    };

    const onPick = (e) => {
      const item = e.target.closest('.lookup-dropdown-item');
      if (!item) return;
      e.preventDefault();
      e.stopPropagation();
      const key = item.dataset.key ?? '';
      const label = lookupMap.get(key) ?? '';
      applySelection(key, label);
    };

    const onDocDown = (e) => {
      if (list.contains(e.target)) return;
      cleanup();
    };
    const onResize = () => cleanup();

    list.addEventListener('pointerdown', onPick);
    list.addEventListener('mousedown', onPick);
    list.addEventListener('click', onPick);
    document.body.appendChild(list);
    positionLookupList(list, td);
    document.addEventListener('mousedown', onDocDown, true);
    window.addEventListener('resize', onResize, true);
  }

  if (unitWrap && unitTable) {
    unitGrid = createDetailGridManager({
      tableName: 'MINdMatUnit',
      wrap: unitWrap,
      table: unitTable,
      keyFields: ['PartNum', 'Revision', 'ReplaceUnit', 'UseType'],
      columns: [
        { name: 'ReplaceUnit' },
        { name: 'Ratio' },
        { name: 'UseType' },
        { name: 'Notes' }
      ],
      toolbar: {
        first: btnUnitFirst,
        prev: btnUnitPrev,
        next: btnUnitNext,
        last: btnUnitLast,
        add: btnUnitAdd,
        del: btnUnitDelete,
        save: btnUnitSave,
        cancel: btnUnitCancel,
        refresh: btnUnitRefresh
      }
    });
    detailGrids.push(unitGrid);
  }

  if (custWrap && custTable) {
    custGrid = createDetailGridManager({
      tableName: 'MGNdCustPartNum',
      wrap: custWrap,
      table: custTable,
      keyFields: ['PartNum', 'Revision', 'CompanyId'],
      columns: [
        { name: 'CompanyId' },
        { name: 'ShortName', readonly: true },
        { name: 'CustomerPartNum' },
        { name: 'Description' },
        { name: 'Material' },
        { name: 'EngGauge' },
        { name: 'Specificity' },
        { name: 'TradeNotes' },
        { name: 'ShipNotes' }
      ],
      mapRows: async (rows) => {
        if (!rows.length) return rows;
        const lookupMap = await loadCustCompanyLookup();
        if (!lookupMap || lookupMap.size === 0) return rows;
        return rows.map((row) => {
          const next = { ...row };
          const companyIdRaw = getRowValue(row, 'CompanyId');
          const shortNameRaw = getRowValue(row, 'ShortName');
          const companyId = companyIdRaw == null ? '' : String(companyIdRaw).trim();
          const shortName = shortNameRaw == null ? '' : String(shortNameRaw).trim();
          if (!shortName && companyId && lookupMap.has(companyId)) {
            next.ShortName = lookupMap.get(companyId);
          }
          return next;
        });
      },
      toolbar: {
        first: btnCustFirst,
        prev: btnCustPrev,
        next: btnCustNext,
        last: btnCustLast,
        add: btnCustAdd,
        del: btnCustDelete,
        save: btnCustSave,
        cancel: btnCustCancel,
        refresh: btnCustRefresh
      }
    });
    detailGrids.push(custGrid);

    custTable.addEventListener('dblclick', async (e) => {
      const td = e.target.closest('td');
      if (!td) return;
      const input = td.querySelector('.cell-edit[name="CompanyId"]');
      if (!input) return;
      const lookupMap = await loadCustCompanyLookup();
      if (!lookupMap || lookupMap.size === 0) return;
      openCustCompanyLookup(td, input, lookupMap);
    });
  }

  if (propWrap && propTable) {
    propGrid = createDetailGridManager({
      tableName: 'MGNdMatInfoDtl',
      wrap: propWrap,
      table: propTable,
      keyFields: ['PartNum', 'Revision', 'NumId', 'DtlNumId'],
      columns: [
        { name: 'NumId', readonly: true },
        { name: 'NumName', readonly: true },
        { name: 'DtlNumId', readonly: true },
        { name: 'DtlNumName', readonly: true }
      ],
      mapRows: async (rows) => {
        if (!rows.length) return rows;
        const lookups = await loadPropLookups();
        const numMap = lookups?.numMap || new Map();
        const dtlMap = lookups?.dtlMap || new Map();
        return rows.map((row) => {
          const next = { ...row };
          const numIdRaw = getRowValue(row, 'NumId');
          const dtlIdRaw = getRowValue(row, 'DtlNumId');
          const numId = numIdRaw == null ? '' : String(numIdRaw).trim();
          const dtlId = dtlIdRaw == null ? '' : String(dtlIdRaw).trim();
          const numName = getRowValue(row, 'NumName');
          const dtlName = getRowValue(row, 'DtlNumName');
          if ((!numName || String(numName).trim() === '') && numId && numMap.has(numId)) {
            next.NumName = numMap.get(numId);
          }
          if ((!dtlName || String(dtlName).trim() === '') && dtlId && dtlMap.has(dtlId)) {
            next.DtlNumName = dtlMap.get(dtlId);
          }
          return next;
        });
      },
      toolbar: {}
    });
    detailGrids.push(propGrid);
  }

  if (mapWrap && mapTable) {
    mapGrid = createDetailGridManager({
      tableName: 'MGNdProdMap',
      wrap: mapWrap,
      table: mapTable,
      keyFields: ['PartNum', 'Revision', 'SerialNum'],
      autoIncField: 'SerialNum',
      columns: [
        { name: 'SerialNum', readonly: true },
        { name: 'CrossName' },
        { name: 'Notes' }
      ],
      toolbar: {
        first: btnMapFirst,
        prev: btnMapPrev,
        next: btnMapNext,
        last: btnMapLast,
        add: btnMapAdd,
        del: btnMapDelete,
        save: btnMapSave,
        cancel: btnMapCancel,
        refresh: btnMapRefresh
      }
    });
    detailGrids.push(mapGrid);
  }

  const getUserId = () => {
    return (localStorage.getItem('erpLoginUserId') || window._userId || 'Admin').toString().trim();
  };

  const showLogModal = () => {
    if (!logModalEl) return;
    if (logModal) {
      logModal.show();
      return;
    }
    logModalEl.classList.add('show');
    logModalEl.style.display = 'block';
    logModalEl.removeAttribute('aria-hidden');
    logModalEl.setAttribute('aria-modal', 'true');
    if (!logBackdrop) {
      logBackdrop = document.createElement('div');
      logBackdrop.className = 'modal-backdrop fade show';
      document.body.appendChild(logBackdrop);
    }
  };

  const hideLogModal = () => {
    if (!logModalEl) return;
    if (logModal) {
      logModal.hide();
      return;
    }
    logModalEl.classList.remove('show');
    logModalEl.style.display = 'none';
    logModalEl.setAttribute('aria-hidden', 'true');
    logModalEl.removeAttribute('aria-modal');
    if (logBackdrop) {
      logBackdrop.remove();
      logBackdrop = null;
    }
  };

  function setValue(el, value) {
    if (!el) return;
    if (el.type === 'checkbox') {
      el.checked = value === true || value === 1 || value === '1';
      return;
    }
    el.value = value ?? '';
  }

  function fillForm(record) {
    if (!record) return;
    form.querySelectorAll('[data-field]').forEach((el) => {
      const field = el.getAttribute('data-field');
      if (!field) return;
      setValue(el, record[field] ?? record[field.toLowerCase()] ?? record[field.toUpperCase()]);
    });
  }

  function clearForm() {
    form.querySelectorAll('[data-field]').forEach((el) => {
      if (el.type === 'checkbox') {
        el.checked = false;
      } else {
        el.value = '';
      }
    });
  }

  function setFormEditable(enabled) {
    form.querySelectorAll('[data-field]').forEach((el) => {
      if (el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement) {
        if (el.readOnly || el.hasAttribute('readonly')) return;
        el.disabled = !enabled;
        return;
      }
      if (el instanceof HTMLSelectElement) {
        el.disabled = !enabled;
      }
    });
  }

  function setEditMode(enabled) {
    isEditMode = !!enabled;
    setFormEditable(isEditMode);
    setButtonText(btnEdit, isEditMode ? '保留' : '修改');
    if (isEditMode) {
      if (!preserveCancelSnapshot) {
        cancelSnapshot = getFormData();
      }
      preserveCancelSnapshot = false;
    } else {
      cancelSnapshot = null;
      preserveCancelSnapshot = false;
    }
    if (btnSave) btnSave.hidden = isEditMode;
    if (btnCancel) btnCancel.hidden = !isEditMode;
    const lockButtons = [btnQuery, btnAdd, btnToFormal, btnDetail, btnHistory, btnToEmo, btnDelete, btnSave, btnTabPrev, btnTabNext];
    lockButtons.forEach((btn) => { if (btn) btn.disabled = isEditMode; });
    document.querySelector('.matinfo-page')?.classList.toggle('is-edit-mode', isEditMode);
    detailGrids.forEach((grid) => grid.toggleEdit(isEditMode));
  }

  function parseNumber(input) {
    const cleaned = (input ?? '').toString().trim().replace(/,/g, '');
    if (!cleaned) return null;
    if (!/^-?\d+(\.\d+)?$/.test(cleaned)) return null;
    const num = Number(cleaned);
    return Number.isFinite(num) ? num : null;
  }

  function coerceFormValue(field, rawValue, isCheckbox, recordValue) {
    if (isCheckbox) return rawValue ? 1 : 0;
    const value = (rawValue ?? '').toString().trim();
    const key = (field || '').toLowerCase();
    const type = formDictTypeMap.get(key) || '';
    const isRecordNumber = typeof recordValue === 'number' && !Number.isNaN(recordValue);
    const isNumeric = numericTypes.has(type) || forcedNumericFields.has(key) || isRecordNumber;
    const isDate = dateTypes.has(type);
    if (!value) {
      if (isNumeric || isDate) return null;
      return '';
    }
    if (isNumeric) {
      return parseNumber(value);
    }
    return value;
  }

  function getFormData() {
    const data = {};
    form.querySelectorAll('[data-field]').forEach((el) => {
      const field = el.getAttribute('data-field');
      if (!field) return;
      const recordValue = currentRecord ? getValue(currentRecord, field) : null;
      if (el.type === 'checkbox') {
        data[field] = coerceFormValue(field, el.checked, true, recordValue);
        return;
      }
      data[field] = coerceFormValue(field, el.value ?? '', false, recordValue);
    });
    return data;
  }

  function setKeyFieldsEditable(enabled) {
    const partnum = form.querySelector('[data-field="Partnum"]');
    const revision = form.querySelector('[data-field="Revision"]');
    if (partnum) partnum.readOnly = !enabled;
    if (revision) revision.readOnly = !enabled;
  }

  function formatValue(value) {
    if (value === null || value === undefined) return '';
    if (typeof value === 'object') return JSON.stringify(value);
    return `${value}`;
  }

  function formatDateByPattern(date, pattern) {
    if (!(date instanceof Date) || isNaN(date.getTime())) return '';
    const pad = (n) => `${n}`.padStart(2, '0');
    return pattern
      .replace(/yyyy/g, `${date.getFullYear()}`)
      .replace(/MM/g, pad(date.getMonth() + 1))
      .replace(/dd/g, pad(date.getDate()))
      .replace(/HH/g, pad(date.getHours()))
      .replace(/mm/g, pad(date.getMinutes()))
      .replace(/ss/g, pad(date.getSeconds()));
  }

  function formatByFormatStr(value, fmt) {
    if (!fmt) return null;
    const raw = value ?? '';
    if (!raw) return null;
    const dt = new Date(raw);
    if (isNaN(dt.getTime())) return null;
    return formatDateByPattern(dt, fmt);
  }

  const checkboxFields = new Set(['IsTrans', 'IsEMO', 'Status', 'MB', 'StopOrder']);
  function isCheckboxColumn(col) {
    return col?.comboStyle === 1 || (col?.comboStyle == null && checkboxFields.has(col?.key));
  }
  function formatCellHtml(col, value) {
    if (isCheckboxColumn(col)) {
      const checked = value === true || value === 1 || value === '1' || value === 'Y' || value === 'y';
      return `<input type="checkbox" disabled ${checked ? 'checked' : ''}>`;
    }
    const formatted = formatByFormatStr(value, col?.formatStr);
    if (formatted !== null) return formatted;
    return formatValue(value);
  }

  function getValue(item, key) {
    if (!item || !key) return '';
    if (item[key] !== undefined) return item[key];
    const keyLower = key.toLowerCase();
    for (const k of Object.keys(item)) {
      if (k.toLowerCase() === keyLower) return item[k];
    }
    return '';
  }

  function setButtonText(btn, text) {
    if (!btn) return;
    const icon = btn.querySelector('i');
    btn.textContent = text;
    if (icon) {
      btn.prepend(icon);
      btn.insertBefore(document.createTextNode(' '), icon.nextSibling);
    }
  }

  function renderLogTable(tableEl, rows, emptyText) {
    if (!tableEl) return;
    const thead = tableEl.querySelector('thead');
    const tbodyEl = tableEl.querySelector('tbody');
    const list = Array.isArray(rows) ? rows : [];
    if (!list.length) {
      if (thead) thead.innerHTML = '';
      if (tbodyEl) tbodyEl.innerHTML = `<tr><td>${emptyText}</td></tr>`;
      return;
    }
    const keys = Object.keys(list[0] || {});
    if (thead) {
      thead.innerHTML = `<tr>${keys.map(k => `<th>${k}</th>`).join('')}</tr>`;
    }
    if (tbodyEl) {
      tbodyEl.innerHTML = '';
      list.forEach((row) => {
        const tr = document.createElement('tr');
        keys.forEach((key) => {
          const td = document.createElement('td');
          td.textContent = formatValue(getValue(row, key));
          tr.appendChild(td);
        });
        tbodyEl.appendChild(tr);
      });
    }
  }

  async function loadDict() {
    if (dictCache.fields) return dictCache.fields;
    try {
      const res = await fetch(`/api/TableFieldLayout/GetTableFieldsFull?table=${encodeURIComponent(dictTableName)}&lang=TW`);
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      dictCache.fields = Array.isArray(data) ? data : [];
      dictTypeMap.clear();
      dictCache.fields.forEach((f) => {
        const key = (f.FieldName || f.fieldName || '').toString().trim().toLowerCase();
        const type = (f.DataType || f.dataType || '').toString().trim().toLowerCase();
        if (key) dictTypeMap.set(key, type);
      });
      return dictCache.fields;
    } catch (err) {
      dictCache.fields = [];
      dictTypeMap.clear();
      return dictCache.fields;
    }
  }

  async function loadFormDict() {
    if (formDictCache.fields && formDictCache.fields.length) return formDictCache.fields;
    try {
      const res = await fetch(`/api/TableFieldLayout/GetTableFieldsFull?table=${encodeURIComponent(dictPanelTableName)}&lang=TW`);
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      const fields = Array.isArray(data) ? data : [];
      if (!fields.length) return fields;
      formDictCache.fields = fields;
      formDictTypeMap.clear();
      formDictCache.fields.forEach((f) => {
        const key = (f.FieldName || f.fieldName || '').toString().trim().toLowerCase();
        const type = (f.DataType || f.dataType || '').toString().trim().toLowerCase();
        if (key) formDictTypeMap.set(key, type);
      });
      renderBasic2Fields(formDictCache.fields);
      applyPanelDict(formDictCache.fields);
      return formDictCache.fields;
    } catch (err) {
      formDictTypeMap.clear();
      return [];
    }
  }

  function buildDictMap(rows) {
    const map = new Map();
    (rows || []).forEach((f) => {
      const key = (f.FieldName || f.fieldName || '').toString().trim();
      if (!key) return;
      map.set(key.toLowerCase(), {
        name: key,
        label: (f.DisplayLabel || f.displayLabel || key).toString(),
        visible: Number(f.Visible ?? f.visible ?? 1) === 1,
        readOnly: Number(f.ReadOnly ?? f.readOnly ?? 0) === 1,
        serial: Number(f.SerialNum ?? f.serialNum ?? 9999),
        layRow: Number(f.iLayRow ?? f.iLayrow ?? f.iLayRow ?? 0),
        layCol: Number(f.iLayColumn ?? f.iLaycolumn ?? f.iLayCol ?? 0),
        combo: Number(f.ComboStyle ?? f.comboStyle ?? 0) === 1
      });
    });
    return map;
  }

  function findLabelForField(input) {
    if (!input) return null;
    const parent = input.parentElement;
    if (!parent) return null;
    const prev = input.previousElementSibling;
    if (prev && prev.tagName === 'LABEL') return prev;
    return null;
  }

  function setCheckboxLabelText(labelEl, text) {
    if (!labelEl) return;
    const inputEl = labelEl.querySelector('input[type="checkbox"]');
    labelEl.textContent = '';
    if (inputEl) labelEl.appendChild(inputEl);
    labelEl.appendChild(document.createTextNode(` ${text}`));
  }

  function getRowValue(row, key) {
    if (!row || !key) return null;
    if (row[key] !== undefined) return row[key];
    const lower = key.toLowerCase();
    const hit = Object.keys(row).find(k => k.toLowerCase() === lower);
    return hit ? row[hit] : null;
  }

  function readNum(row, key) {
    const v = getRowValue(row, key);
    if (v === null || v === undefined || v === '') return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function getLayoutPair(row) {
    const fieldTop = readNum(row, 'iFieldTop');
    const fieldLeft = readNum(row, 'iFieldLeft');
    const fieldWidth = readNum(row, 'iFieldWidth');
    const fieldHeight = readNum(row, 'iFieldHeight');
    const labTop = readNum(row, 'iLabTop');
    const labLeft = readNum(row, 'iLabLeft');
    const labWidth = readNum(row, 'iLabWidth');
    const labHeight = readNum(row, 'iLabHeight');
    const showWhere = readNum(row, 'iShowWhere');
    return {
      field: {
        top: fieldTop,
        left: fieldLeft,
        width: fieldWidth,
        height: fieldHeight
      },
      label: {
        top: labTop,
        left: labLeft,
        width: labWidth,
        height: labHeight
      },
      showWhere
    };
  }

  const panelLayoutTweaks = {
    MGN_MINdMatInfo2PNL: {
      rowGap: 10,
      fieldLeftPad: 8,
      fieldWidthPad: 10,
      labelWidthPad: 8,
      checkboxLeftShift: -70
    }
  };

  function adjustPanelLayout(row, layout, isCheckbox) {
    if (!layout) return layout;
    const tweaks = panelLayoutTweaks[dictPanelTableName];
    if (!tweaks) return layout;
    const adjusted = {
      field: { ...layout.field },
      label: { ...layout.label },
      showWhere: layout.showWhere
    };
    const rowIndex = readNum(row, 'iLayRow');
    if (rowIndex && rowIndex > 0 && tweaks.rowGap) {
      const rowOffset = (rowIndex - 1) * tweaks.rowGap;
      if (adjusted.field.top != null) adjusted.field.top += rowOffset;
      if (adjusted.label.top != null) adjusted.label.top += rowOffset;
    }
    if (tweaks.fieldLeftPad && adjusted.field.left != null) adjusted.field.left += tweaks.fieldLeftPad;
    if (tweaks.fieldWidthPad && adjusted.field.width != null) adjusted.field.width += tweaks.fieldWidthPad;
    if (tweaks.labelWidthPad && adjusted.label.width != null) adjusted.label.width += tweaks.labelWidthPad;
    if (isCheckbox && tweaks.checkboxLeftShift && adjusted.field.left != null) {
      adjusted.field.left += tweaks.checkboxLeftShift;
    }
    return adjusted;
  }

  function isLayoutBlank(layout) {
    if (!layout) return true;
    const vals = [
      layout.field.top, layout.field.left, layout.field.width, layout.field.height,
      layout.label.top, layout.label.left, layout.label.width, layout.label.height
    ];
    return vals.every(v => {
      const n = Number(v ?? 0);
      return !Number.isFinite(n) || n <= 0;
    });
  }

  function compareByLay(a, b) {
    const ar = readNum(a, 'iLayRow');
    const br = readNum(b, 'iLayRow');
    const ac = readNum(a, 'iLayColumn');
    const bc = readNum(b, 'iLayColumn');
    if (ar != null && br != null && ar !== br) return ar - br;
    if (ac != null && bc != null && ac !== bc) return ac - bc;
    if (ar != null && br == null) return -1;
    if (ar == null && br != null) return 1;
    if (ac != null && bc == null) return -1;
    if (ac == null && bc != null) return 1;
    return (a.SerialNum ?? a.serialNum ?? 9999) - (b.SerialNum ?? b.serialNum ?? 9999);
  }

  function buildFieldElements(row) {
    const fieldName = (row.FieldName || row.fieldName || '').toString().trim();
    const labelText = (row.DisplayLabel || row.displayLabel || fieldName).toString();
    const isCheck = Number(row.ComboStyle ?? row.comboStyle ?? 0) === 1;
    const readOnly = Number(row.ReadOnly ?? row.readOnly ?? 0) === 1;
    const label = document.createElement('label');
    label.textContent = labelText;
    const input = document.createElement('input');
    input.setAttribute('data-field', fieldName);
    if (isCheck) input.type = 'checkbox';
    if (readOnly) {
      if (input.type === 'checkbox') input.disabled = true;
      else input.readOnly = true;
    }
    return { label, input, isCheck };
  }

  function applyAbsStyle(el, pos, extraClass, topPad = 4) {
    if (!el || !pos) return null;
    if (pos.top === null && pos.left === null && pos.width === null && pos.height === null) return null;
    el.classList.add('abs-item');
    if (extraClass) el.classList.add(extraClass);
    el.style.position = 'absolute';
    if (pos.top !== null) el.style.top = `${pos.top + topPad}px`;
    if (pos.left !== null) el.style.left = `${pos.left}px`;
    if (pos.width !== null) el.style.width = `${pos.width}px`;
    if (pos.height !== null) el.style.height = `${pos.height}px`;
    const estHeight = pos.height ?? (el.tagName === 'LABEL' ? 22 : 24);
    const estTop = (pos.top ?? 0) + topPad;
    return estTop + estHeight;
  }

  function splitPanelFields(rows) {
    const list = (rows || []).filter(r => (r.Visible ?? r.visible ?? 1) == 1);
    const hasShowWhere = list.some(r => (readNum(r, 'iShowWhere') ?? 0) > 1);
    const basic1Fields = new Set();
    basic1Grid?.querySelectorAll('[data-field]').forEach((el) => {
      const field = (el.getAttribute('data-field') || '').toLowerCase();
      if (field) basic1Fields.add(field);
    });

    if (hasShowWhere) {
      const basic1 = list.filter(r => (readNum(r, 'iShowWhere') ?? 0) <= 1);
      const basic2 = list.filter(r => (readNum(r, 'iShowWhere') ?? 0) === 2);
      return { basic1, basic2 };
    }

    const basic1 = list.filter((r) => {
      const fieldName = (r.FieldName || r.fieldName || '').toString().trim().toLowerCase();
      return fieldName && basic1Fields.has(fieldName);
    });
    const basic2 = list.filter((r) => {
      const fieldName = (r.FieldName || r.fieldName || '').toString().trim().toLowerCase();
      return fieldName && !basic1Fields.has(fieldName);
    });
    return { basic1, basic2 };
  }

  function resetBasic1Abs() {
    if (!basic1Grid || !basic1Abs) return;
    while (basic1Abs.firstChild) {
      basic1Grid.appendChild(basic1Abs.firstChild);
    }
  }

  function applyBasic1AbsLayout(rows) {
    if (!basic1Grid || !basic1Abs) return;
    resetBasic1Abs();
    basic1Abs.innerHTML = '';
    basic1Abs.style.minHeight = '';
    basic1Grid.style.display = '';
    const map = new Map();
    const existing = new Set();
    basic1Grid.querySelectorAll('[data-field]').forEach((el) => {
      const field = (el.getAttribute('data-field') || '').toLowerCase();
      if (field) existing.add(field);
    });
    (rows || []).forEach((row) => {
      const name = (row.FieldName || row.fieldName || '').toString().trim().toLowerCase();
      if (name) map.set(name, row);
    });

    let maxBottom = 0;
    let movedControls = 0;
    let gridAdded = 0;
    const moved = new Set();
    basic1Grid.querySelectorAll('[data-field]').forEach((el) => {
      const field = (el.getAttribute('data-field') || '').toLowerCase();
      if (!field) return;
      const row = map.get(field);
      if (!row) return;
      const layout = adjustPanelLayout(row, getLayoutPair(row), el.type === 'checkbox');
      if (isLayoutBlank(layout)) return;
      const isCheckbox = el.type === 'checkbox';
      const labelEl = isCheckbox ? el.closest('label') : findLabelForField(el);
      if (labelEl && !moved.has(labelEl)) {
        if (isCheckbox && !labelEl.contains(el)) labelEl.appendChild(el);
        const usePos = isCheckbox ? layout.field : layout.label;
        const bottom = applyAbsStyle(labelEl, usePos);
        if (bottom) maxBottom = Math.max(maxBottom, bottom);
        basic1Abs.appendChild(labelEl);
        moved.add(labelEl);
      }
      if (!isCheckbox && !moved.has(el)) {
        const bottom = applyAbsStyle(el, layout.field);
        if (bottom) maxBottom = Math.max(maxBottom, bottom);
        basic1Abs.appendChild(el);
        moved.add(el);
        movedControls += 1;
      } else if (isCheckbox && labelEl) {
        labelEl.classList.add('abs-checkbox-label');
        movedControls += 1;
      }
    });

    const missingRows = (rows || [])
      .filter((row) => {
        const fieldName = (row.FieldName || row.fieldName || '').toString().trim().toLowerCase();
        return fieldName && !existing.has(fieldName);
      })
      .sort(compareByLay);

    missingRows.forEach((row) => {
      const { label, input, isCheck } = buildFieldElements(row);
      const layout = adjustPanelLayout(row, getLayoutPair(row), isCheck);
      if (isLayoutBlank(layout)) {
        basic1Grid.appendChild(label);
        basic1Grid.appendChild(input);
        if (isCheck) label.classList.add('abs-checkbox-label');
        gridAdded += 1;
        return;
      }
      if (isCheck) {
        const text = label.textContent;
        label.textContent = '';
        label.appendChild(input);
        label.appendChild(document.createTextNode(` ${text || ''}`));
        label.classList.add('abs-checkbox-label');
        const labelBottom = applyAbsStyle(label, layout.field);
        basic1Abs.appendChild(label);
        maxBottom = Math.max(maxBottom, labelBottom || 0);
      } else {
        const labelBottom = applyAbsStyle(label, layout.label);
        const inputBottom = applyAbsStyle(input, layout.field);
        basic1Abs.appendChild(label);
        basic1Abs.appendChild(input);
        maxBottom = Math.max(maxBottom, labelBottom || 0, inputBottom || 0);
      }
      movedControls += 1;
    });

    if (basic1Abs.children.length > 0) {
      const totalControls = basic1Grid.querySelectorAll('[data-field]').length;
      if (movedControls >= totalControls && gridAdded === 0) {
        basic1Grid.style.display = 'none';
      }
      if (maxBottom > 0) basic1Abs.style.minHeight = `${maxBottom + 12}px`;
    }
  }

  function renderBasic2Fields(rows) {
    if (!basic2Grid || !basic2Abs) return;
    basic2Grid.innerHTML = '';
    basic2Abs.innerHTML = '';
    basic2Abs.style.minHeight = '';

    const { basic1, basic2 } = splitPanelFields(rows);
    applyBasic1AbsLayout(basic1);

    let maxBottom = 0;
    let absAdded = 0;
    let gridAdded = 0;
    let added = 0;
    const list = (basic2 || []).sort(compareByLay);
      list.forEach((row) => {
        const fieldName = (row.FieldName || row.fieldName || '').toString().trim();
        if (!fieldName) return;
        const { label, input, isCheck } = buildFieldElements(row);
        const layout = adjustPanelLayout(row, getLayoutPair(row), isCheck);
        if (isLayoutBlank(layout)) {
          basic2Grid.appendChild(label);
          basic2Grid.appendChild(input);
          if (isCheck) label.classList.add('abs-checkbox-label');
          added += 1;
          gridAdded += 1;
          return;
        }
        if (isCheck) {
          const text = label.textContent;
          label.textContent = '';
        label.appendChild(input);
        label.appendChild(document.createTextNode(` ${text || ''}`));
        label.classList.add('abs-checkbox-label');
        const labelBottom = applyAbsStyle(label, layout.field);
        basic2Abs.appendChild(label);
        maxBottom = Math.max(maxBottom, labelBottom || 0);
      } else {
        const labelBottom = applyAbsStyle(label, layout.label);
        const inputBottom = applyAbsStyle(input, layout.field);
        basic2Abs.appendChild(label);
        basic2Abs.appendChild(input);
        maxBottom = Math.max(maxBottom, labelBottom || 0, inputBottom || 0);
      }
      absAdded += 1;
      added += 1;
    });
    if (basic2Empty) basic2Empty.style.display = added ? 'none' : '';
    if (absAdded > 0 && maxBottom > 0) basic2Abs.style.minHeight = `${maxBottom + 12}px`;
  }

  function applyPanelDict(rows) {
    const map = buildDictMap(rows);
    const panel = document.querySelector('.matinfo-form');
    if (!panel) return;

    panel.querySelectorAll('[data-field]').forEach((el) => {
      const field = (el.getAttribute('data-field') || '').toLowerCase();
      if (!field) return;
      const cfg = map.get(field);
      if (!cfg) return;
      const label = findLabelForField(el);
      if (label) label.textContent = cfg.label;
      if (el.type === 'checkbox') {
        const checkboxLabel = el.closest('label') || label;
        if (checkboxLabel) setCheckboxLabelText(checkboxLabel, cfg.label);
      }
      if (cfg.readOnly) {
        if (el instanceof HTMLSelectElement) el.disabled = true;
        else if (el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement) el.readOnly = true;
      }
      if (!cfg.visible) {
        if (label) label.style.display = 'none';
        el.style.display = 'none';
      } else {
        if (label) label.style.display = '';
        el.style.display = '';
      }
    });

    panel.querySelectorAll('.matinfo-checks').forEach((box) => {
      const labels = Array.from(box.querySelectorAll('label'));
      labels.forEach((label) => {
        const input = label.querySelector('[data-field]');
        const key = (input?.getAttribute('data-field') || '').toLowerCase();
        const cfg = map.get(key);
        label.style.display = cfg?.visible === false ? 'none' : '';
      });
    });

    panel.querySelectorAll('.matinfo-grid').forEach((grid) => {
      const children = Array.from(grid.children);
      for (let i = 0; i < children.length; i += 1) {
        const label = children[i];
        const fieldEl = children[i + 1];
        if (!label || !fieldEl || label.tagName !== 'LABEL') continue;
        const dataEl = fieldEl.matches('[data-field]')
          ? fieldEl
          : fieldEl.querySelector?.('[data-field]');
        const field = (dataEl?.getAttribute('data-field') || '').toLowerCase();
        const cfg = map.get(field);
        label.style.display = cfg?.visible === false ? 'none' : '';
        fieldEl.style.display = cfg?.visible === false ? 'none' : '';
        if (cfg?.layRow > 0 && cfg?.layCol > 0) {
          const labelCol = (cfg.layCol - 1) * 2 + 1;
          const fieldCol = labelCol + 1;
          label.style.gridColumn = `${labelCol} / ${labelCol + 1}`;
          fieldEl.style.gridColumn = `${fieldCol} / ${fieldCol + 1}`;
          label.style.gridRow = `${cfg.layRow}`;
          fieldEl.style.gridRow = `${cfg.layRow}`;
        }
        i += 1;
      }
    });
  }

  const scrollSyncState = new WeakMap();
  function syncScroll(topEl, bodyEl) {
    if (!topEl || !bodyEl) return;
    const inner = topEl.firstElementChild;
    if (!inner) return;
    const bodyTable = () => bodyEl.querySelector('table') || bodyEl;
    const updateWidth = () => {
      inner.style.width = `${bodyTable().scrollWidth}px`;
      topEl.scrollLeft = bodyEl.scrollLeft;
    };

    if (!scrollSyncState.has(topEl)) {
      let lock = false;
      topEl.addEventListener('scroll', () => {
        if (lock) return;
        lock = true;
        bodyEl.scrollLeft = topEl.scrollLeft;
        lock = false;
      });
      bodyEl.addEventListener('scroll', () => {
        if (lock) return;
        lock = true;
        topEl.scrollLeft = bodyEl.scrollLeft;
        lock = false;
      });
      window.addEventListener('resize', updateWidth);
      scrollSyncState.set(topEl, updateWidth);
    }
    updateWidth();
  }

  function buildColumnsFromData(rows) {
    const keySet = new Set();
    rows.forEach((row) => {
      if (!row) return;
      Object.keys(row).forEach((key) => keySet.add(key));
    });

    const ordered = preferredColumns.filter((key) => keySet.has(key));
    const rest = [...keySet].filter((key) => !ordered.includes(key));
    rest.sort((a, b) => a.localeCompare(b));
    return [...ordered, ...rest].map((key) => ({
      key,
      label: columnLabels[key] ?? key,
      width: null,
      comboStyle: checkboxFields.has(key) ? 1 : 0,
      formatStr: null,
      readOnly: false
    }));
  }

  async function buildColumns(rows) {
    const dict = await loadDict();
    const keySet = new Set();
    rows.forEach((row) => {
      if (!row) return;
      Object.keys(row).forEach((key) => keySet.add(key));
    });

    if (dict && dict.length) {
      const dictCols = dict
        .filter(d => (d.Visible ?? d.visible ?? 1) == 1)
        .sort((a, b) => (a.SerialNum ?? a.serialNum ?? 9999) - (b.SerialNum ?? b.serialNum ?? 9999))
        .map(d => {
          const key = d.FieldName || d.fieldName;
          const ds = d.DisplaySize ?? d.displaySize;
          const widthRaw = d.iFieldWidth ?? d.iLabWidth ?? ds;
          const widthVal = d.iFieldWidth ? `${widthRaw}px`
                         : ds ? `${ds}ch`
                         : null;
          return {
            key,
            label: d.DisplayLabel || d.displayLabel || columnLabels[key] || key,
            width: widthVal,
            comboStyle: Number(d.ComboStyle ?? d.comboStyle ?? 0),
            formatStr: d.FormatStr || d.formatStr || null,
            readOnly: Number(d.ReadOnly ?? d.readOnly ?? 0) === 1
          };
        })
        .filter(c => c.key);

      columns = dictCols;
    } else {
      columns = buildColumnsFromData(rows);
    }

    theadRow.innerHTML = columns
      .map((col) => {
        const style = col.width ? ` style="width:${col.width}"` : '';
        const cls = [
          isCheckboxColumn(col) ? 'col-checkbox' : '',
          col.key ? 'sortable' : ''
        ].filter(Boolean).join(' ');
        const classAttr = cls ? ` class="${cls}"` : '';
        const keyAttr = col.key ? ` data-key="${col.key}"` : '';
        return `<th${classAttr}${style}${keyAttr}>${col.label ?? col.key}</th>`;
      })
      .join('');
    applySortIndicators();
  }

  function applySortIndicators() {
    if (!theadRow) return;
    theadRow.querySelectorAll('th').forEach((th) => {
      th.classList.remove('sorted-asc', 'sorted-desc');
      const key = th.dataset.key;
      if (key && sortKey && key.toLowerCase() === sortKey.toLowerCase()) {
        th.classList.add(sortDir === 'desc' ? 'sorted-desc' : 'sorted-asc');
      }
    });
  }

  function compareSort(a, b) {
    if (a == null && b == null) return 0;
    if (a == null) return sortDir === 'asc' ? -1 : 1;
    if (b == null) return sortDir === 'asc' ? 1 : -1;
    const na = Number(a);
    const nb = Number(b);
    const bothNum = Number.isFinite(na) && Number.isFinite(nb);
    if (bothNum) return sortDir === 'asc' ? na - nb : nb - na;
    const sa = String(a);
    const sb = String(b);
    const cmp = sa.localeCompare(sb, 'zh-Hant');
    return sortDir === 'asc' ? cmp : -cmp;
  }

  function sortSearchRows() {
    if (!sortKey) return;
    const key = sortKey;
    dataCache.sort((a, b) => compareSort(getValue(a, key), getValue(b, key)));
    scheduleRender();
  }

  function updateCount() {
    if (!countEl) return;
    const total = totalCount || 0;
    countEl.textContent = `${currentIndex || 0} / ${total}`;
  }

  function resetVirtualState() {
    totalCount = 0;
    currentIndex = 0;
    dataCache = [];
    loadedPages = new Set();
    isSearchMode = false;
    pendingSelectIndex = null;
    rowHeight = 24;
    columns = [];
    updateCount();
  }

  function scheduleRender() {
    if (renderScheduled) return;
    renderScheduled = true;
    requestAnimationFrame(() => {
      renderScheduled = false;
      renderVirtual();
    });
  }

  async function fetchCommonRecord(partnum, revision) {
    if (!partnum || !revision) return null;
    const params = new URLSearchParams();
    params.set('table', dictTableName);
    params.append('keyNames', commonKeyFields[0]);
    params.append('keyValues', partnum);
    params.append('keyNames', commonKeyFields[1]);
    params.append('keyValues', revision);
    const res = await fetch(`/api/CommonTable/ByKeys?${params.toString()}`);
    if (!res.ok) return null;
    const rows = await res.json();
    return Array.isArray(rows) ? rows[0] : null;
  }

  async function refreshCommonRecord(partnum, revision) {
    const row = await fetchCommonRecord(partnum, revision);
    if (!row) return;
    fillForm(row);
    currentRecord = row;
  }

  function selectRecord(item, index) {
    if (!item) return;
    fillForm(item);
    currentRecord = item;
    currentKey = { partnum: getValue(item, 'Partnum') ?? '', revision: getValue(item, 'Revision') ?? '' };
    isNew = false;
    setKeyFieldsEditable(false);
    setEditMode(false);
    detailGrids.forEach((grid) => grid.loadRows());
    currentIndex = (index ?? 0) + 1;
    updateCount();
    scheduleRender();
    if (useCommonTable) {
      refreshCommonRecord(currentKey.partnum, currentKey.revision);
    }
  }

  function ensureIndexLoaded(index) {
    if (isSearchMode) return;
    const page = Math.floor(index / pageSize) + 1;
    loadPage(page);
  }

  function selectRowAt(index) {
    if (!Number.isFinite(index)) return;
    const clamped = Math.max(0, Math.min(index, Math.max(0, totalCount - 1)));
    ensureIndexLoaded(clamped);
    if (dataCache[clamped]) {
      selectRecord(dataCache[clamped], clamped);
      return;
    }
    pendingSelectIndex = clamped;
  }

  function renderVirtual() {
    if (!tbody || !theadRow || !browseScrollBody) return;
    if (!columns.length || totalCount <= 0) {
      theadRow.innerHTML = '';
      tbody.innerHTML = '<tr><td colspan="1">沒有資料</td></tr>';
      return;
    }

    const viewportHeight = browseScrollBody.clientHeight || 1;
    const scrollTop = browseScrollBody.scrollTop || 0;
    const startIndex = Math.max(0, Math.floor(scrollTop / rowHeight) - bufferRows);
    const endIndex = Math.min(totalCount - 1, Math.ceil((scrollTop + viewportHeight) / rowHeight) + bufferRows);

    if (!isSearchMode) {
      const startPage = Math.floor(startIndex / pageSize) + 1;
      const endPage = Math.floor(endIndex / pageSize) + 1;
      for (let page = startPage; page <= endPage; page += 1) {
        loadPage(page);
      }
    }

    const topSpace = Math.max(0, startIndex * rowHeight);
    const bottomSpace = Math.max(0, (totalCount - endIndex - 1) * rowHeight);
    const colCount = Math.max(1, columns.length);
    let html = `<tr class="matinfo-spacer"><td colspan="${colCount}" style="height:${topSpace}px"></td></tr>`;
    for (let i = startIndex; i <= endIndex; i += 1) {
      const item = dataCache[i];
      if (!item) {
        html += `<tr class="matinfo-loading"><td colspan="${colCount}">載入中...</td></tr>`;
        continue;
      }
      const activeClass = currentIndex === i + 1 ? ' active' : '';
      html += `<tr class="matinfo-row${activeClass}" data-index="${i}">` +
        columns.map((col) => {
          const cls = [
            isCheckboxColumn(col) ? 'col-checkbox' : '',
            col.readOnly ? 'col-readonly' : ''
          ].filter(Boolean).join(' ');
          const classAttr = cls ? ` class="${cls}"` : '';
          return `<td${classAttr}>${formatCellHtml(col, getValue(item, col.key))}</td>`;
        }).join('') +
        `</tr>`;
    }
    html += `<tr class="matinfo-spacer"><td colspan="${colCount}" style="height:${bottomSpace}px"></td></tr>`;
    tbody.innerHTML = html;

    const firstRow = tbody.querySelector('tr.matinfo-row');
    if (firstRow) {
      const h = firstRow.getBoundingClientRect().height;
      if (h > 0 && Math.abs(h - rowHeight) > 1) {
        rowHeight = h;
        scheduleRender();
      }
    }
  }

  async function loadPage(page) {
    if (page < 1 || loadedPages.has(page)) return;
    loadedPages.add(page);
    try {
      const url = (() => {
        if (useCommonTable) {
          const params = new URLSearchParams();
          params.set('table', dictTableName);
          params.set('page', String(page));
          params.set('pageSize', String(pageSize));
          if (sortKey) {
            params.set('orderBy', sortKey);
            params.set('orderDir', sortDir);
          }
          return `/api/CommonTable/Paged?${params.toString()}`;
        }
        return `/api/MindMatInfo/paged?page=${page}&pageSize=${pageSize}`;
      })();
      const res = await fetch(url);
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      const rows = Array.isArray(data?.data) ? data.data : [];
      totalCount = data?.totalCount ?? rows.length;
      updateCount();
      if (dataCache.length !== totalCount) dataCache.length = totalCount;
      const start = (page - 1) * pageSize;
      rows.forEach((row, idx) => {
        dataCache[start + idx] = row;
      });
      if (!columns.length) {
        await buildColumns(rows);
        syncScroll(browseScrollTop, browseScrollBody);
      }
      scheduleRender();
      if (pendingSelectIndex !== null && dataCache[pendingSelectIndex]) {
        const idx = pendingSelectIndex;
        pendingSelectIndex = null;
        selectRowAt(idx);
      }
    } catch (err) {
      loadedPages.delete(page);
      tbody.innerHTML = `<tr><td colspan="6">載入失敗：${err.message ?? err}</td></tr>`;
    }
  }

  async function renderRows(rows, total) {
    const list = Array.isArray(rows) ? rows : [];
    resetVirtualState();
    isSearchMode = true;
    totalCount = total ?? list.length;
    dataCache = list.slice();
    if (list.length) {
      await buildColumns(list);
      syncScroll(browseScrollTop, browseScrollBody);
    }
    updateCount();
    if (sortKey) {
      sortSearchRows();
    } else {
      scheduleRender();
    }
    if (list.length > 0) {
      selectRowAt(0);
    } else {
      theadRow.innerHTML = '';
      clearForm();
      currentRecord = null;
      currentKey = null;
      isNew = false;
      setKeyFieldsEditable(false);
      setEditMode(false);
    }
  }

  async function loadData() {
    resetVirtualState();
    isSearchMode = false;
    try {
      await Promise.all([loadPage(1), loadFormDict()]);
      if (totalCount > 0) {
        selectRowAt(0);
      } else {
        clearForm();
        currentRecord = null;
        currentKey = null;
        isNew = false;
        setKeyFieldsEditable(false);
        setEditMode(false);
        detailGrids.forEach((grid) => grid.loadRows());
      }
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="6">載入失敗：${err.message ?? err}</td></tr>`;
    }
  }

  tbody?.addEventListener('click', (e) => {
    const row = e.target.closest('tr.matinfo-row');
    if (!row) return;
    const idx = Number(row.dataset.index ?? '-1');
    if (!Number.isFinite(idx) || idx < 0 || idx >= totalCount) return;
    const item = dataCache[idx];
    if (!item) return;
    selectRecord(item, idx);
  });

  browseScrollBody?.addEventListener('scroll', () => {
    scheduleRender();
  });

  theadRow?.addEventListener('click', (e) => {
    const th = e.target.closest('th');
    const key = th?.dataset?.key;
    if (!key) return;
    if (sortKey && sortKey.toLowerCase() === key.toLowerCase()) {
      sortDir = sortDir === 'asc' ? 'desc' : 'asc';
    } else {
      sortKey = key;
      sortDir = 'asc';
    }
    applySortIndicators();
    if (isSearchMode) {
      sortSearchRows();
      selectRowAt(0);
      return;
    }
    if (!useCommonTable) return;
    resetVirtualState();
    loadPage(1);
  });

  async function saveRecord() {
    await loadFormDict();
    const data = getFormData();
    const partnum = (data.Partnum || '').trim();
    const revision = (data.Revision || '').trim();
    if (!partnum) {
      notify('error', '請輸入料號');
      return false;
    }
    if (!revision) {
      notify('error', '請輸入版次');
      return false;
    }

    if (useCommonTable) {
      if (isNew) {
        const exists = await fetchCommonRecord(partnum, revision);
        if (exists) {
          notify('error', '料號已存在');
          return false;
        }
      }
      const resp = await fetch('/api/CommonTable/SaveTableChanges', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          TableName: dictTableName,
          KeyFields: commonKeyFields,
          Data: [data]
        })
      });
      if (!resp.ok) {
        notify('error', await resp.text());
        return false;
      }
      const result = await resp.json();
      const failed = (result?.results || []).find(r => r && r.ok === false);
      if (failed) {
        notify('error', failed.reason || failed.error || '儲存失敗');
        return false;
      }
      notify('success', isNew ? '新增完成' : '儲存完成');
      await loadData();
      return true;
    }

    if (isNew) {
      const resp = await fetch('/api/MindMatInfo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!resp.ok) {
        notify('error', await resp.text());
        return false;
      }
      notify('success', '新增完成');
      await loadData();
      return true;
    }

    if (!currentKey) {
      notify('error', '請先選擇一筆資料');
      return false;
    }

    const url = `/api/MindMatInfo/${encodeURIComponent(currentKey.partnum)}/${encodeURIComponent(currentKey.revision)}`;
    const resp = await fetch(url, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!resp.ok) {
      notify('error', await resp.text());
      return false;
    }
    notify('success', '儲存完成');
    await loadData();
    return true;
  }

  async function deleteRecord() {
    if (!currentKey || !currentKey.partnum || !currentKey.revision) {
      notify('error', '請先選擇一筆資料');
      return;
    }
    const ok = window.Swal
      ? (await window.Swal.fire({ icon: 'warning', title: '確定要刪除?', showCancelButton: true })).isConfirmed
      : confirm('確定要刪除?');
    if (!ok) return;

    if (useCommonTable) {
      const resp = await fetch('/api/CommonTable/SaveTableChanges', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          TableName: dictTableName,
          KeyFields: commonKeyFields,
          Data: [{
            PartNum: currentKey.partnum,
            Revision: currentKey.revision,
            __delete: true
          }]
        })
      });
      if (!resp.ok) {
        notify('error', await resp.text());
        return;
      }
      const result = await resp.json();
      const failed = (result?.results || []).find(r => r && r.ok === false);
      if (failed) {
        notify('error', failed.reason || failed.error || '刪除失敗');
        return;
      }
      notify('success', '刪除完成');
      await loadData();
      return;
    }

    const url = `/api/MindMatInfo/${encodeURIComponent(currentKey.partnum)}/${encodeURIComponent(currentKey.revision)}`;
    const resp = await fetch(url, { method: 'DELETE' });
    if (!resp.ok) {
      notify('error', await resp.text());
      return;
    }
    notify('success', '刪除完成');
    await loadData();
  }

  btnQuery?.addEventListener('click', () => {
    if (window.MatInfoSearchHandler?.open) {
      window.MatInfoSearchHandler.open({ itemId, dictTableName: dictSearchTableName });
      return;
    }
    loadData();
  });

  btnEdit?.addEventListener('click', async () => {
    if (isEditMode) {
      const ok = await saveRecord();
      if (ok) setEditMode(false);
      return;
    }
    if (!currentKey || !currentKey.partnum) {
      notify('error', '請先選擇一筆資料');
      return;
    }
    setEditMode(true);
  });

  btnCancel?.addEventListener('click', () => {
    if (cancelSnapshot) {
      fillForm(cancelSnapshot);
    } else if (currentRecord) {
      fillForm(currentRecord);
    } else {
      clearForm();
    }
    isNew = false;
    setKeyFieldsEditable(false);
    setEditMode(false);
  });

  btnAdd?.addEventListener('click', () => {
    if (window.MatInfoAddHandler?.open) {
      window.MatInfoAddHandler.open({ itemId, dictTableName });
      return;
    }
    cancelSnapshot = getFormData();
    preserveCancelSnapshot = true;
    clearForm();
    currentRecord = null;
    currentKey = null;
    isNew = true;
    setKeyFieldsEditable(true);
    setEditMode(true);
  });

  btnToFormal?.addEventListener('click', async () => {
    if (!currentKey || !currentKey.partnum || !currentKey.revision) {
      notify('error', '請先選擇一筆資料');
      return;
    }
    const isTrans = getValue(currentRecord, 'IsTrans');
    const status = getValue(currentRecord, 'Status');
    if (isTrans === 1 || isTrans === '1') {
      notify('error', '已轉正式');
      return;
    }
    if (status === 1 || status === '1') {
      notify('error', '已是正式料號');
      return;
    }
    if (window.MatInfoAddHandler?.open) {
      window.MatInfoAddHandler.open({
        itemId,
        dictTableName,
        mode: 'tmpToFormal',
        currOldPN: currentKey.partnum,
        setClass: getValue(currentRecord, 'MatClass'),
        mb: getValue(currentRecord, 'MB'),
        matName: getValue(currentRecord, 'MatName'),
        unit: getValue(currentRecord, 'Unit')
      });
      return;
    }
    notify('error', '轉正式視窗尚未載入');
  });

  btnDetail?.addEventListener('click', () => {
    if (!browseBox) return;
    const hidden = browseBox.classList.toggle('is-hidden');
    setButtonText(btnDetail, hidden ? '瀏覽' : '明細');
  });

  const getTabButtons = () => Array.from(document.querySelectorAll('.matinfo-tabs .nav-link'));
  const openTabAt = (idx) => {
    const tabs = getTabButtons();
    if (!tabs.length) return;
    const target = tabs[Math.max(0, Math.min(idx, tabs.length - 1))];
    if (!target) return;
    if (window.bootstrap?.Tab) {
      const tab = window.bootstrap.Tab.getOrCreateInstance(target);
      tab.show();
      return;
    }
    target.click();
  };
  const moveTab = (dir) => {
    const tabs = getTabButtons();
    if (!tabs.length) return;
    const activeIdx = Math.max(0, tabs.findIndex((btn) => btn.classList.contains('active')));
    const nextIdx = dir === 'prev' ? activeIdx - 1 : activeIdx + 1;
    openTabAt(nextIdx);
  };

  const moveRow = (dir) => {
    if (totalCount <= 0) return;
    const activeIdx = Math.max(0, Math.min((currentIndex || 1) - 1, totalCount - 1));
    const nextIdx = dir === 'prev' ? activeIdx - 1 : activeIdx + 1;
    selectRowAt(nextIdx);
  };

  btnTabPrev?.addEventListener('click', () => moveRow('prev'));
  btnTabNext?.addEventListener('click', () => moveRow('next'));

  btnHistory?.addEventListener('click', async () => {
    if (!currentKey || !currentKey.partnum) {
      notify('error', '請先選擇一筆資料');
      return;
    }
    const userId = getUserId();
    const qs = `paperId=${encodeURIComponent(itemId)}&paperNum=${encodeURIComponent(currentKey.partnum)}&userId=${encodeURIComponent(userId)}`;
    const [masterResp, historyResp] = await Promise.all([
      fetch(`/api/UpdateLog/Master?${qs}`, withJwtHeaders()),
      fetch(`/api/UpdateLog/History?${qs}`, withJwtHeaders())
    ]);
    if (!masterResp.ok || !historyResp.ok) {
      notify('error', '讀取歷史失敗');
      return;
    }
    const masterData = await masterResp.json();
    const historyData = await historyResp.json();
    renderLogTable(logMasterTable, masterData?.rows ?? [], '尚無更新記錄');
    renderLogTable(logHistoryTable, historyData?.rows ?? [], '尚無歷史記錄');
    showLogModal();
  });

  logModalEl?.querySelectorAll('[data-bs-dismiss="modal"], .btn-close').forEach((btn) => {
    btn.addEventListener('click', () => {
      hideLogModal();
    });
  });

  btnSave?.addEventListener('click', () => {
    saveRecord();
  });

  btnToEmo?.addEventListener('click', async () => {
    if (!currentKey || !currentKey.partnum || !currentKey.revision) {
      notify('error', '請先選擇一筆資料');
      return;
    }
    const ok = window.Swal
      ? (await window.Swal.fire({ icon: 'warning', title: '確定要轉工程?', showCancelButton: true })).isConfirmed
      : confirm('確定要轉工程?');
    if (!ok) return;

    const chk = await fetch(`/api/MatInfoEmo/Check?partNum=${encodeURIComponent(currentKey.partnum)}`, withJwtHeaders());
    if (chk.ok) {
      const data = await chk.json();
      if (data?.exists) {
        notify('error', '已轉工程');
        return;
      }
    }

    const resp = await fetch('/api/MatInfoEmo/Convert', withJwtHeaders({
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ PartNum: currentKey.partnum, Revision: currentKey.revision })
    }));
    if (!resp.ok) {
      notify('error', await resp.text());
      return;
    }
    notify('success', '轉工程資料成功');
    await loadData();
  });

  btnDelete?.addEventListener('click', () => {
    deleteRecord();
  });

  btnUnitFirst?.addEventListener('click', () => unitGrid?.selectRow(0));
  btnUnitPrev?.addEventListener('click', () => unitGrid?.selectRow((unitGrid?.getSelectedIndex() ?? 0) - 1));
  btnUnitNext?.addEventListener('click', () => unitGrid?.selectRow((unitGrid?.getSelectedIndex() ?? 0) + 1));
  btnUnitLast?.addEventListener('click', () => unitGrid?.selectRow(Number.MAX_SAFE_INTEGER));
  btnUnitAdd?.addEventListener('click', () => unitGrid?.addRow());
  btnUnitDelete?.addEventListener('click', () => unitGrid?.deleteRow());
  btnUnitSave?.addEventListener('click', () => unitGrid?.saveRows());
  btnUnitCancel?.addEventListener('click', () => unitGrid?.cancelChanges());
  btnUnitRefresh?.addEventListener('click', () => unitGrid?.loadRows());

  btnCustFirst?.addEventListener('click', () => custGrid?.selectRow(0));
  btnCustPrev?.addEventListener('click', () => custGrid?.selectRow((custGrid?.getSelectedIndex() ?? 0) - 1));
  btnCustNext?.addEventListener('click', () => custGrid?.selectRow((custGrid?.getSelectedIndex() ?? 0) + 1));
  btnCustLast?.addEventListener('click', () => custGrid?.selectRow(Number.MAX_SAFE_INTEGER));
  btnCustAdd?.addEventListener('click', () => custGrid?.addRow());
  btnCustDelete?.addEventListener('click', () => custGrid?.deleteRow());
  btnCustSave?.addEventListener('click', () => custGrid?.saveRows());
  btnCustCancel?.addEventListener('click', () => custGrid?.cancelChanges());
  btnCustRefresh?.addEventListener('click', () => custGrid?.loadRows());

  btnMapFirst?.addEventListener('click', () => mapGrid?.selectRow(0));
  btnMapPrev?.addEventListener('click', () => mapGrid?.selectRow((mapGrid?.getSelectedIndex() ?? 0) - 1));
  btnMapNext?.addEventListener('click', () => mapGrid?.selectRow((mapGrid?.getSelectedIndex() ?? 0) + 1));
  btnMapLast?.addEventListener('click', () => mapGrid?.selectRow(Number.MAX_SAFE_INTEGER));
  btnMapAdd?.addEventListener('click', () => mapGrid?.addRow());
  btnMapDelete?.addEventListener('click', () => mapGrid?.deleteRow());
  btnMapSave?.addEventListener('click', () => mapGrid?.saveRows());
  btnMapCancel?.addEventListener('click', () => mapGrid?.cancelChanges());
  btnMapRefresh?.addEventListener('click', () => mapGrid?.loadRows());

  syncScroll(browseScrollTop, browseScrollBody);
  syncScroll(formScrollTop, formScrollBody);

  document.querySelectorAll('[data-bs-toggle="tab"]').forEach((btn) => {
    btn.addEventListener('shown.bs.tab', () => {
      syncScroll(formScrollTop, formScrollBody);
      setActiveTabContext(btn);
    });
  });

  const openFieldDict = () => {
    const el = document.getElementById('fieldDictModal');
    if (!el) return;
    const target = document.activeElement?.closest?.('[data-dict-table]')?.dataset?.dictTable
      || document.querySelector('.ctx-current[data-dict-table]')?.dataset?.dictTable
      || window._dictTableName
      || dictPanelTableName;
    if (typeof window.showDictModal === 'function') {
      window.showDictModal('fieldDictModal', target);
      return;
    }
    if (typeof window.initFieldDictModal === 'function') {
      window.initFieldDictModal(target, 'fieldDictModal');
    } else if (typeof window.loadFieldDict === 'function') {
      window.loadFieldDict(target);
    }
  };

  document.addEventListener('keydown', (e) => {
    if (e.key !== 'F3') return;
    const target = e.target;
    const inText = target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable);
    if (inText) return;
    e.preventDefault();
    openFieldDict();
  });

  window.matinfoReload = loadData;
  window.addEventListener('field-dict-saved', () => {
    formDictCache.fields = null;
    formDictTypeMap.clear();
    loadFormDict();
  });

  function applyTabVisibility() {
    const id = (itemId || '').toUpperCase();
    if (id !== 'MG000008' && id !== 'CPN00006') return;
    const allowed = new Set([
      '基本資料', '基本資料2', '廠商料號', '屬性及備註',
      '工程圖', '圖檔', '替代單位設定', '共用件'
    ]);
    const tabs = Array.from(document.querySelectorAll('.matinfo-tabs .nav-link'));
    tabs.forEach((btn) => {
      const name = btn.dataset.tabName || btn.textContent?.trim();
      const show = allowed.has(name || '');
      const li = btn.closest('li');
      if (li) li.style.display = show ? '' : 'none';
      const target = btn.getAttribute('data-bs-target');
      if (target) {
        const pane = document.querySelector(target);
        if (pane) pane.style.display = show ? '' : 'none';
      }
    });
    const activeVisible = document.querySelector('.matinfo-tabs .nav-link.active')?.closest('li')?.style.display !== 'none';
    if (!activeVisible) {
      const first = tabs.find((btn) => {
        const name = btn.dataset.tabName || btn.textContent?.trim();
        return allowed.has(name || '');
      });
      if (first) {
        if (window.bootstrap?.Tab) {
          window.bootstrap.Tab.getOrCreateInstance(first).show();
        } else {
          first.click();
        }
      }
    }
  }
  document.addEventListener('matinfo:add:done', () => {
    loadData();
  });
  document.addEventListener('matinfo:search:done', (e) => {
    const rows = e.detail?.rows;
    if (Array.isArray(rows)) {
      renderRows(rows, rows.length);
      return;
    }
    loadData();
  });

  setEditMode(false);
  applyTabDictTables();
  applyCustTabLabel();
  applyTabVisibility();
  setActiveTabContext(document.querySelector('.matinfo-tabs .nav-link.active'));
  loadData();
})();
</script>
}






