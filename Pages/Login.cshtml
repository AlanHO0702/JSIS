@page
@{
    ViewData["Title"] = "ç™»å…¥";
    Layout = "_Layout";
}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"]</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
      /* ====== ä½ çš„åŸæœ¬æ¨£å¼ï¼ˆç¯€éŒ„ï¼‰ ====== */
      body { min-height: 100vh; background:#fff; font-family:'Segoe UI','Noto Sans TC',Arial,sans-serif; }
      .login-logo{
        width:300px;
        max-width:70%;
        height:auto;
        display:block;
        margin:0 auto 16px;
      }
      .login-glass{ background:rgba(255,255,255,.85); border-radius:20px; box-shadow:0 8px 40px 0 #2766b522, 0 2px 8px #0001;
                    padding:30px 70px 50px; backdrop-filter:blur(4px); min-width:450px; min-height:520px; max-width:96vw; }
      .login-title{ color:#2766b5; font-weight:800; font-size:2.3rem; letter-spacing:3px; }
      .login-subtitle{ color:#6a85b6; font-size:1.09rem; margin-bottom:34px; letter-spacing:1px; }
      .login-input-group{ position:relative; margin-bottom:1.35rem; }
      .login-input-group .bi{ position:absolute; left:14px; top:53%; transform:translateY(-50%); color:#b1c6e4; font-size:1.24rem; }
      .login-input{ padding-left:2.2rem; border-radius:9px; border:1.5px solid #d2d9e6; background:#f5f8fd; height:48px; font-size:1.08rem; color:#24345a; transition:border-color .18s, box-shadow .18s; }
      .login-input:focus{ border-color:#2766b5; box-shadow:0 0 0 2px #2766b540; background:#f7fbff; color:#17467e; }
      .login-meta-row{ display:flex; align-items:center; gap:10px; margin:8px 0 16px; }
      .login-meta-row .label{ color:#64748b; font-weight:600; min-width:48px; }
      .login-meta-row .value-box{
        padding: 4px 10px;
        border: 1px solid #cbd5f5;
        border-radius: 6px;
        background: #f8fafc;
        color: #1f2937;
        font-weight: 600;
      }
      .login-meta-row .login-select{
        height: 40px;
        padding: 4px 10px;
        border: 1.5px solid #d2d9e6;
        border-radius: 6px;
        background: #f5f8fd;
        color: #24345a;
        font-weight: 600;
        min-width: 160px;
      }
      .login-btn{ background:linear-gradient(90deg,#2766b5 0%,#4198f7 100%); color:#fff; font-weight:bold; font-size:1.13rem; border-radius:9px; width:100%; border:none; box-shadow:0 3px 16px #2766b527; margin-top:14px; transition:background .22s, box-shadow .14s; }
      .login-btn:hover{ background:linear-gradient(90deg,#17467e 0%,#2766b5 100%); box-shadow:0 6px 24px #2766b540; }
      #login-error{ font-size:1rem; padding:.7rem 1rem; }
      .login-footer{ color:#9aa7bb; font-size:.96rem; margin-top:24px; text-align:center; }

      .company-marquee{
        position:fixed; bottom:0; width:100%; max-width:100vw; background:#81a5d2; color:#fff; font-size:.95rem; padding:0;
        z-index:999; text-align:center; font-weight:500; letter-spacing:1px; overflow:hidden;
      }

      /* ====== å…±ç”¨ Loading Overlayï¼ˆå’Œ _Layout ä¸€è‡´ï¼‰ ====== */
      .app-loading-overlay{
        position:fixed; inset:0; display:none; align-items:center; justify-content:center;
        background:rgba(255,255,255,.65); backdrop-filter:blur(1px); z-index:11000; /* é«˜æ–¼è·‘é¦¬ç‡ˆ */
      }
      .app-loading-overlay.show{ display:flex; }
      .app-loading-overlay .box{
        display:flex; align-items:center; gap:.75rem; background:#fff; padding:14px 18px; border-radius:12px;
        box-shadow:0 6px 24px rgba(0,0,0,.12); color:#0d6efd; font-weight:600;
      }
    </style>
</head>
<body>

  <div class="container vh-100 d-flex align-items-center justify-content-center">
    <div class="login-glass mx-auto">
      <div class="text-center mb-4">
        <img class="login-logo" src="/images/LOGO.jpg" alt="JSIS" />
        <div class="login-title">ç³»çµ±ç™»å…¥</div>
        <div class="login-subtitle">è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼</div>
      </div>

      <div id="login-error" class="alert alert-danger d-none"></div>

      <form id="login-form" autocomplete="off">
        <div class="login-input-group">
          <span class="bi bi-person"></span>
          <select id="userid" class="form-control login-input" autocomplete="username"></select>
        </div>
        <div class="login-input-group">
          <span class="bi bi-lock"></span>
          <input id="password" type="password" class="form-control login-input" autocomplete="current-password" placeholder="å¯†ç¢¼" />
        </div>
        <div class="login-meta-row">
          <span class="label">å…¬å¸åˆ¥</span>
          <select id="loginBuSelect" class="login-select"></select>
        </div>
        <button type="submit" class="login-btn">ç™»å…¥</button>
      </form>

      <div class="login-footer">&copy; 2025 JSIS INFORMATION SYS</div>
    </div>
  </div>

  <!-- âœ… æ–°ç‰ˆå…±ç”¨ overlayï¼ˆå–ä»£èˆŠçš„ div#loadingOverlayï¼‰ -->
  <div id="loadingOverlay" class="app-loading-overlay" aria-live="polite" aria-busy="true" style="display:none">
    <div class="box">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <div class="msg" id="loadingMsg">ç™»å…¥ä¸­â€¦</div>
    </div>
  </div>

  <div class="company-marquee">
    <marquee behavior="scroll" direction="left" scrollamount="4"
             onmouseover="this.stop();" onmouseout="this.start();">
      å‚‘å²è³‡è¨Šè‚¡ä»½æœ‰é™å…¬å¸ &nbsp;&nbsp;&nbsp;&nbsp;
      JS Information System &nbsp;&nbsp;&nbsp;&nbsp;
      å®¢æœE-mail: <a href="mailto:james@jsis.com.tw">james@jsis.com.tw</a> &nbsp;&nbsp;&nbsp;&nbsp;
      å®˜æ–¹ç¶²ç«™: <a href="http://www.jsis.com.tw/" target="_blank">jsis.com.tw</a>
    </marquee>
  </div>

  <!-- Bootstrap JSï¼ˆå¯æœ‰å¯ç„¡ï¼›spinner ä¸éœ€è¦ JSï¼Œä½†ä½ é é¢è‹¥ç”¨åˆ° Popper/Toast æ‰éœ€è¦ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


  <!-- âœ… èˆ‡ _Layout åŒæ­¥çš„ busy helpers -->
  <script>
    (() => {
      const overlay = document.getElementById('loadingOverlay');
      const msgEl   = document.getElementById('loadingMsg');
      let counter = 0, lastShowAt = 0;
      const MIN_SHOW = 150;

      function openOverlay(msg){
        if (msgEl) msgEl.textContent = msg || 'è™•ç†ä¸­â€¦';
        overlay.classList.add('show');
        overlay.style.display = 'flex';
        lastShowAt = Date.now();
      }
      function closeOverlay(){
        const wait = Math.max(0, MIN_SHOW - (Date.now() - lastShowAt));
        setTimeout(() => {
          overlay.classList.remove('show');
          overlay.style.display = 'none';
        }, wait);
      }

      window.showBusy = (msg) => { if (++counter === 1) openOverlay(msg); };
      window.hideBusy = ()     => { if (counter > 0 && --counter === 0) closeOverlay(); };
      window.busyFetch = async (input, init = {}, msg = 'è™•ç†ä¸­â€¦') => {
          showBusy(msg);

          init.headers = init.headers || {};
          const jwtId = localStorage.getItem("jwtId");
          if (jwtId) init.headers["X-JWTID"] = jwtId;

          try {
              return await fetch(input, init);
          }
          finally { hideBusy(); }
      };
    })();
  </script>

  <!-- â­â­â­ æ–°å¢ï¼šå–å¾— HostName + IP + ç™»å…¥ API â­â­â­ -->
  <script>
    // ğŸ”¥ å»ºç«‹å›ºå®š HostNameï¼ˆè£ç½®è­˜åˆ¥ç¢¼ï¼‰
    function getHostName() {

        const randomUUID = (window.crypto && window.crypto.randomUUID)
        ? () => window.crypto.randomUUID()
        : (window.crypto && window.crypto.getRandomValues)
        ? () => {
            const bytes = new Uint8Array(16);
            window.crypto.getRandomValues(bytes);
            bytes[6] = (bytes[6] & 0x0f) | 0x40; // version 4
            bytes[8] = (bytes[8] & 0x3f) | 0x80; // variant
            const hex = Array.from(bytes, b => b.toString(16).padStart(2, '0')).join('');
            return `${hex.substr(0,8)}-${hex.substr(8,4)}-${hex.substr(12,4)}-${hex.substr(16,4)}-${hex.substr(20)}`;
          }
        : () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
          });

        let id = localStorage.getItem("erpHostName");
        if (!id) {
            id = "HOST-" + randomUUID();
            localStorage.setItem("erpHostName", id);
        }
        return id;
    }

    document.addEventListener("DOMContentLoaded", function () {
        const uidEl = document.getElementById("userid");
        const pwdEl = document.getElementById("password");
        const errDiv = document.getElementById("login-error");
        const buSelectEl = document.getElementById("loginBuSelect");

        const lastUser = localStorage.getItem("erpLoginUserId");

        const populateUserOptions = async () => {
            if (!uidEl) return;
            uidEl.innerHTML = "";

            try {
                const resp = await fetch("/api/Login/UserList");
                if (!resp.ok) throw new Error("load failed");
                const items = await resp.json();
                if (Array.isArray(items) && items.length > 0) {
                    items.forEach(item => {
                        const optId = document.createElement("option");
                        optId.value = item.userId || "";
                        const displayName = item.userName ? ` ${item.userName}` : "";
                        optId.textContent = `${item.userId || ""}${displayName}`;
                        uidEl.appendChild(optId);
                    });
                    uidEl.value = lastUser || uidEl.options[0]?.value || "";
                } else {
                    const opt = document.createElement("option");
                    opt.value = "";
                    opt.textContent = "ç„¡å¯ç”¨ä½¿ç”¨è€…";
                    uidEl.appendChild(opt);
                }
            } catch {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "è¼‰å…¥å¤±æ•—";
                uidEl.appendChild(opt);
            }
        };

        const populateBuOptions = async () => {
            if (!buSelectEl) return;
            const lastBuId = localStorage.getItem("erpLoginBUId");
            buSelectEl.innerHTML = "";

            try {
                const resp = await fetch("/api/Login/BuList");
                if (!resp.ok) throw new Error("load failed");
                const items = await resp.json();
                if (Array.isArray(items)) {
                    items.forEach(item => {
                        const opt = document.createElement("option");
                        opt.value = item.buId || "";
                        opt.textContent = item.buName || item.buId || "";
                        if (lastBuId && opt.value === lastBuId) opt.selected = true;
                        buSelectEl.appendChild(opt);
                    });
                }
            } catch {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "æœªæŒ‡å®š";
                buSelectEl.appendChild(opt);
            }
        };

        populateUserOptions();
        populateBuOptions();

        document.getElementById("login-form").addEventListener("submit", async function (e) {
            e.preventDefault();

            const userid = uidEl.value.trim();
            const password = pwdEl.value;

            // ğŸ”¥ ä½¿ç”¨å›ºå®š HostNameï¼ˆè£ç½®è­˜åˆ¥ç¢¼ï¼‰
            const hostName = getHostName();

            // Public IPï¼ˆç§»é™¤å°å¤–éƒ¨æœå‹™çš„ä¾è³´ï¼Œé¿å…è¢«é˜»æ“‹é€ æˆå¡ä½ï¼‰
            const clientIp = null;

            localStorage.setItem("erpLoginUserId", userid);
            errDiv.classList.add("d-none");

            try {
                const resp = await busyFetch('/api/Login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userid,
                        password: password,
                        hostName: hostName,   // â˜… å›ºå®šè£ç½®è­˜åˆ¥ç¢¼
                        clientIp: clientIp
                      
                    })
                }, 'ç™»å…¥ä¸­â€¦');

                if (resp.ok) {
                    const result = await resp.json();
                    localStorage.setItem("jwtId", result.jwtId);
                    if (buSelectEl && buSelectEl.selectedOptions.length > 0) {
                        const opt = buSelectEl.selectedOptions[0];
                        localStorage.setItem("erpLoginBUId", opt.value || "");
                        localStorage.setItem("erpLoginBUName", opt.textContent || "");
                    } else if (result.buName) {
                        localStorage.setItem("erpLoginBUName", result.buName);
                    } else {
                        localStorage.removeItem("erpLoginBUName");
                    }
                    window.location.href = "/FontIndex";
                } else {
                    const result = await resp.json().catch(() => ({}));
                    errDiv.textContent = result.error || "ç™»å…¥å¤±æ•—";
                    errDiv.classList.remove("d-none");
                }
            } catch {
                errDiv.textContent = "ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
                errDiv.classList.remove("d-none");
            }
        });
    });


</script>



</body>
</html>
