@page
@{
    ViewData["Title"] = "ÁôªÂÖ•";
    Layout = "_Layout";
}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"]</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" />

    <style>
      /* ====== ‰Ω†ÁöÑÂéüÊú¨Ê®£ÂºèÔºàÁØÄÈåÑÔºâ ====== */
      body { min-height: 100vh; background:#fff; font-family:'Segoe UI','Noto Sans TC',Arial,sans-serif; }
      .login-logo{
        width:300px;
        max-width:70%;
        height:auto;
        display:block;
        margin:0 auto 16px;
      }
      .login-glass{ background:rgba(255,255,255,.85); border-radius:20px; box-shadow:0 8px 40px 0 #2766b522, 0 2px 8px #0001;
                    padding:30px 70px 50px; backdrop-filter:blur(4px); min-width:450px; min-height:520px; max-width:96vw; }
      .login-title{ color:#2766b5; font-weight:800; font-size:2.3rem; letter-spacing:3px; }
      .login-subtitle{ color:#6a85b6; font-size:1.09rem; margin-bottom:34px; letter-spacing:1px; }
      .login-input-group{ position:relative; margin-bottom:1.35rem; }
      .login-input-group .bi{ position:absolute; left:14px; top:53%; transform:translateY(-50%); color:#b1c6e4; font-size:1.24rem; }
      .login-input{ padding-left:2.2rem; border-radius:9px; border:1.5px solid #d2d9e6; background:#f5f8fd; height:48px; font-size:1.08rem; color:#24345a; transition:border-color .18s, box-shadow .18s; }
      .login-input:focus{ border-color:#2766b5; box-shadow:0 0 0 2px #2766b540; background:#f7fbff; color:#17467e; }
      .login-meta-row{ display:flex; align-items:center; gap:10px; margin:8px 0 16px; }
      .login-meta-row .label{ color:#64748b; font-weight:600; min-width:48px; }
      .login-meta-row .value-box{
        padding: 4px 10px;
        border: 1px solid #cbd5f5;
        border-radius: 6px;
        background: #f8fafc;
        color: #1f2937;
        font-weight: 600;
      }
      .login-meta-row .login-select{
        height: 40px;
        padding: 4px 10px;
        border: 1.5px solid #d2d9e6;
        border-radius: 6px;
        background: #f5f8fd;
        color: #24345a;
        font-weight: 600;
        min-width: 160px;
      }
      .login-btn{ background:linear-gradient(90deg,#2766b5 0%,#4198f7 100%); color:#fff; font-weight:bold; font-size:1.13rem; border-radius:9px; width:100%; border:none; box-shadow:0 3px 16px #2766b527; margin-top:14px; transition:background .22s, box-shadow .14s; }
      .login-btn:hover{ background:linear-gradient(90deg,#17467e 0%,#2766b5 100%); box-shadow:0 6px 24px #2766b540; }
      #login-error{ font-size:1rem; padding:.7rem 1rem; }
      .login-footer{ color:#9aa7bb; font-size:.96rem; margin-top:24px; text-align:center; }

      .company-marquee{
        position:fixed; bottom:0; width:100%; max-width:100vw; background:#81a5d2; color:#fff; font-size:.95rem; padding:0;
        z-index:999; text-align:center; font-weight:500; letter-spacing:1px; overflow:hidden;
      }

      /* ====== ÂÖ±Áî® Loading OverlayÔºàÂíå _Layout ‰∏ÄËá¥Ôºâ ====== */
      .app-loading-overlay{
        position:fixed; inset:0; display:none; align-items:center; justify-content:center;
        background:rgba(255,255,255,.65); backdrop-filter:blur(1px); z-index:11000; /* È´òÊñºË∑ëÈ¶¨Ááà */
      }
      .app-loading-overlay.show{ display:flex; }
      .app-loading-overlay .box{
        display:flex; align-items:center; gap:.75rem; background:#fff; padding:14px 18px; border-radius:12px;
        box-shadow:0 6px 24px rgba(0,0,0,.12); color:#0d6efd; font-weight:600;
      }
    </style>
    <style>
      :root{
        --ink-900:#0f1f3a;
        --ink-700:#2a3c5f;
        --ink-500:#5d6b82;
        --brand-700:#1f5fa9;
        --brand-500:#2e8ad8;
        --accent-500:#27b0aa;
        --line:#dbe3f2;
        --card:#ffffff;
      }

      body.login-body{
        min-height:100vh;
        background:
          radial-gradient(1000px 600px at 10% 10%, #e7f3ff 0%, transparent 55%),
          radial-gradient(900px 520px at 90% 15%, #ffe8d6 0%, transparent 50%),
          linear-gradient(180deg, #f7f9fd 0%, #eef2f8 100%);
        font-family:"Manrope","Noto Sans TC",sans-serif;
        color:var(--ink-900);
        position:relative;
      }

      .login-scene{
        min-height:100vh;
        display:flex;
        align-items:center;
        justify-content:center;
        position:relative;
        padding:32px 16px 84px;
      }
      .login-scene::before,
      .login-scene::after{
        content:"";
        position:absolute;
        border-radius:50%;
        filter:blur(0.5px);
        opacity:.55;
        pointer-events:none;
      }
      .login-scene::before{
        width:320px; height:320px;
        background:radial-gradient(circle at 30% 30%, #b8e3ff 0%, #8fbef6 45%, transparent 70%);
        top:6%; left:6%;
        animation:floatOrb 10s ease-in-out infinite;
      }
      .login-scene::after{
        width:260px; height:260px;
        background:radial-gradient(circle at 40% 40%, #ffd3b6 0%, #f7a977 45%, transparent 70%);
        bottom:12%; right:8%;
        animation:floatOrb 12s ease-in-out infinite reverse;
      }

      .login-shell{
        width:min(1040px, 100%);
        display:grid;
        grid-template-columns:1.05fr 0.95fr;
        gap:26px;
        align-items:stretch;
        position:relative;
        z-index:1;
      }

      .login-panel{
        position:relative;
        border-radius:26px;
        padding:34px 32px;
        color:#f8fbff;
        background:linear-gradient(135deg, #0b2c52 0%, #2b6cb0 55%, #2bb4ad 100%);
        box-shadow:0 26px 60px rgba(11, 45, 86, .35);
        overflow:hidden;
        animation:panelIn .7s ease;
      }
      .login-panel::before,
      .login-panel::after{
        content:"";
        position:absolute;
        width:220px; height:220px;
        border-radius:50%;
        background:radial-gradient(circle at 40% 40%, rgba(255,255,255,.35) 0%, transparent 65%);
        opacity:.6;
      }
      .login-panel::before{ top:-60px; right:-40px; }
      .login-panel::after{ bottom:-80px; left:-40px; }
      .login-panel-content{ position:relative; z-index:1; }
      .brand-mark{
        font-size:2.6rem;
        font-weight:800;
        letter-spacing:6px;
      }
      .brand-sub{
        margin-top:8px;
        font-size:1.05rem;
        letter-spacing:2px;
        color:rgba(255,255,255,.78);
      }
      .brand-desc{
        margin-top:16px;
        font-size:.98rem;
        color:rgba(255,255,255,.7);
      }
      .brand-tags{
        display:flex;
        flex-wrap:wrap;
        gap:8px;
        margin-top:24px;
      }
      .brand-tags span{
        display:inline-flex;
        align-items:center;
        padding:6px 12px;
        border-radius:999px;
        background:rgba(255,255,255,.18);
        color:#f4fbff;
        font-size:.85rem;
        letter-spacing:1px;
      }

      .login-card{
        position:relative;
        background:var(--card);
        border-radius:22px;
        padding:34px 38px 32px;
        border:1px solid rgba(13, 52, 102, .08);
        box-shadow:0 16px 40px rgba(15, 38, 70, .14);
        animation:cardIn .6s ease;
      }
      .login-card::before{
        content:"";
        position:absolute;
        top:0; left:0; right:0;
        height:6px;
        background:linear-gradient(90deg, var(--brand-700), var(--accent-500));
        border-radius:22px 22px 0 0;
      }

      .login-logo{
        width:190px;
        max-width:75%;
        height:auto;
        display:block;
        margin:4px auto 12px;
        filter:drop-shadow(0 10px 18px rgba(11, 34, 62, .15));
      }
      .login-title{
        color:var(--brand-700);
        font-weight:800;
        font-size:2rem;
        letter-spacing:4px;
      }
      .login-subtitle{
        color:var(--ink-500);
        font-size:1.02rem;
        margin-bottom:26px;
        letter-spacing:1px;
      }

      .login-input-group{ position:relative; margin-bottom:1rem; }
      .login-input-group .bi{
        position:absolute; left:14px; top:50%;
        transform:translateY(-50%);
        color:#9bb3d1; font-size:1.2rem;
        transition:color .18s;
      }
      .login-input{
        padding-left:2.4rem;
        border-radius:12px;
        border:1.5px solid var(--line);
        background:#f7f9fd;
        height:48px;
        font-size:1.02rem;
        color:var(--ink-900);
        transition:border-color .18s, box-shadow .18s, background .18s;
      }
      .login-input:focus{
        border-color:var(--brand-500);
        box-shadow:0 0 0 3px rgba(46, 138, 216, .18);
        background:#ffffff;
        color:var(--ink-900);
      }
      .login-input-group:focus-within .bi{ color:var(--brand-500); }

      .login-meta-row{
        display:flex;
        align-items:center;
        gap:12px;
        margin:8px 0 16px;
      }
      .login-meta-row .label{
        color:var(--ink-700);
        font-weight:700;
        min-width:48px;
        letter-spacing:2px;
      }
      .login-meta-row .login-select{
        height:42px;
        padding:4px 10px;
        border:1.5px solid var(--line);
        border-radius:10px;
        background:#f7f9fd;
        color:var(--ink-900);
        font-weight:600;
        min-width:160px;
        transition:border-color .18s, box-shadow .18s, background .18s;
      }
      .login-meta-row .login-select:focus{
        border-color:var(--brand-500);
        box-shadow:0 0 0 3px rgba(46, 138, 216, .18);
        background:#ffffff;
      }

      .login-btn{
        background:linear-gradient(120deg, #1f66b2 0%, #2eb0da 100%);
        color:#fff;
        font-weight:700;
        font-size:1.05rem;
        border-radius:12px;
        width:100%;
        border:none;
        box-shadow:0 14px 28px rgba(31, 102, 178, .25);
        margin-top:10px;
        letter-spacing:2px;
        transition:transform .16s, box-shadow .16s, filter .16s;
      }
      .login-btn:hover{
        transform:translateY(-1px);
        box-shadow:0 18px 34px rgba(31, 102, 178, .35);
        filter:saturate(1.05);
      }
      .login-btn:active{ transform:translateY(0); }

      #login-error{
        font-size:1rem;
        padding:.7rem 1rem;
        border-radius:12px;
      }
      .login-footer{
        color:var(--ink-500);
        font-size:.92rem;
        margin-top:20px;
        text-align:center;
        letter-spacing:1px;
      }

      .company-marquee{
        position:fixed; bottom:0; width:100%; max-width:100vw;
        background:rgba(18, 54, 102, .85);
        color:#e9f2ff; font-size:.95rem; padding:0;
        z-index:999; text-align:center; font-weight:600; letter-spacing:1px;
        overflow:hidden; backdrop-filter:blur(6px);
      }
      .company-marquee a{ color:#e9f2ff; text-decoration:none; }
      .company-marquee a:hover{ text-decoration:underline; }

      .login-card form .login-input-group,
      .login-card form .login-meta-row,
      .login-card form .login-btn{
        opacity:0;
        transform:translateY(8px);
        animation:riseIn .6s ease forwards;
      }
      .login-card form .login-input-group:nth-of-type(1){ animation-delay:.08s; }
      .login-card form .login-input-group:nth-of-type(2){ animation-delay:.16s; }
      .login-card form .login-meta-row{ animation-delay:.24s; }
      .login-card form .login-btn{ animation-delay:.32s; }

      @@keyframes cardIn{
        from{ opacity:0; transform:translateY(10px) scale(.98); }
        to{ opacity:1; transform:translateY(0) scale(1); }
      }
      @@keyframes panelIn{
        from{ opacity:0; transform:translateY(12px); }
        to{ opacity:1; transform:translateY(0); }
      }
      @@keyframes floatOrb{
        0%,100%{ transform:translateY(0); }
        50%{ transform:translateY(-14px); }
      }
      @@keyframes riseIn{
        to{ opacity:1; transform:translateY(0); }
      }

      @@media (max-width: 992px){
        .login-shell{ grid-template-columns:1fr; }
        .login-panel{ display:none; }
        .login-card{ margin:0 auto; max-width:520px; }
      }
      @@media (max-width: 520px){
        .login-card{ padding:28px 22px; }
        .login-title{ font-size:1.6rem; letter-spacing:2px; }
        .login-subtitle{ font-size:.96rem; }
      }
    </style>
</head>
<body class="login-body">

  <div class="login-scene">
    <div class="login-shell">
      <div class="login-panel">
        <div class="login-panel-content">
          <div class="brand-mark">JSIS</div>
          <div class="brand-sub">INFORMATION SYSTEM</div>
          <div class="brand-desc">Enterprise Resource Planning Portal</div>
          <div class="brand-tags">
            <span>Manufacturing</span>
            <span>Inventory</span>
            <span>Finance</span>
            <span>Quality</span>
          </div>
        </div>
      </div>
      <div class="login-card">
      <div class="text-center mb-4">
        <img class="login-logo" src="/images/LOGO.jpg" alt="JSIS" />
        <div class="login-title">Á≥ªÁµ±ÁôªÂÖ•</div>
        <div class="login-subtitle">Ë´ãËº∏ÂÖ•Â∏≥ËôüËàáÂØÜÁ¢º</div>
      </div>

      <div id="login-error" class="alert alert-danger d-none"></div>

      <form id="login-form" autocomplete="off">
        <div class="login-input-group">
          <span class="bi bi-person"></span>
          <input id="userid" type="text" class="form-control login-input" autocomplete="username" placeholder="Â∏≥Ëôü" />
        </div>
        <div class="login-input-group">
          <span class="bi bi-lock"></span>
          <input id="password" type="password" class="form-control login-input" autocomplete="current-password" placeholder="ÂØÜÁ¢º" />
        </div>
        <div class="login-meta-row">
          <span class="label">ÂÖ¨Âè∏Âà•</span>
          <select id="loginBuSelect" class="login-select"></select>
        </div>
        <button type="submit" class="login-btn">ÁôªÂÖ•</button>
      </form>

      <div class="login-footer">&copy; 2025 JSIS INFORMATION SYS</div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Êñ∞ÁâàÂÖ±Áî® overlayÔºàÂèñ‰ª£ËàäÁöÑ div#loadingOverlayÔºâ -->
  <div id="loadingOverlay" class="app-loading-overlay" aria-live="polite" aria-busy="true" style="display:none">
    <div class="box">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <div class="msg" id="loadingMsg">ÁôªÂÖ•‰∏≠‚Ä¶</div>
    </div>
  </div>

  <div class="company-marquee">
    <marquee behavior="scroll" direction="left" scrollamount="4"
             onmouseover="this.stop();" onmouseout="this.start();">
      ÂÇëÂÅ≤Ë≥áË®äËÇ°‰ªΩÊúâÈôêÂÖ¨Âè∏ &nbsp;&nbsp;&nbsp;&nbsp;
      JS Information System &nbsp;&nbsp;&nbsp;&nbsp;
      ÂÆ¢ÊúçE-mail: <a href="mailto:james@jsis.com.tw">james@jsis.com.tw</a> &nbsp;&nbsp;&nbsp;&nbsp;
      ÂÆòÊñπÁ∂≤Á´ô: <a href="http://www.jsis.com.tw/" target="_blank">jsis.com.tw</a>
    </marquee>
  </div>

  <!-- Bootstrap JSÔºàÂèØÊúâÂèØÁÑ°Ôºõspinner ‰∏çÈúÄË¶Å JSÔºå‰ΩÜ‰Ω†È†ÅÈù¢Ëã•Áî®Âà∞ Popper/Toast ÊâçÈúÄË¶ÅÔºâ -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


  <!-- ‚úÖ Ëàá _Layout ÂêåÊ≠•ÁöÑ busy helpers -->
  <script>
    (() => {
      const overlay = document.getElementById('loadingOverlay');
      const msgEl   = document.getElementById('loadingMsg');
      let counter = 0, lastShowAt = 0;
      const MIN_SHOW = 150;

      function openOverlay(msg){
        if (msgEl) msgEl.textContent = msg || 'ËôïÁêÜ‰∏≠‚Ä¶';
        overlay.classList.add('show');
        overlay.style.display = 'flex';
        lastShowAt = Date.now();
      }
      function closeOverlay(){
        const wait = Math.max(0, MIN_SHOW - (Date.now() - lastShowAt));
        setTimeout(() => {
          overlay.classList.remove('show');
          overlay.style.display = 'none';
        }, wait);
      }

      window.showBusy = (msg) => { if (++counter === 1) openOverlay(msg); };
      window.hideBusy = ()     => { if (counter > 0 && --counter === 0) closeOverlay(); };
      window.busyFetch = async (input, init = {}, msg = 'ËôïÁêÜ‰∏≠‚Ä¶') => {
          showBusy(msg);

          init.headers = init.headers || {};
          const jwtId = localStorage.getItem("jwtId");
          if (jwtId) init.headers["X-JWTID"] = jwtId;

          try {
              return await fetch(input, init);
          }
          finally { hideBusy(); }
      };
    })();
  </script>

  <!-- ‚≠ê‚≠ê‚≠ê Êñ∞Â¢ûÔºöÂèñÂæó HostName + IP + ÁôªÂÖ• API ‚≠ê‚≠ê‚≠ê -->
  <script>
    // üî• Âª∫Á´ãÂõ∫ÂÆö HostNameÔºàË£ùÁΩÆË≠òÂà•Á¢ºÔºâ
    function getHostName() {

        const randomUUID = (window.crypto && window.crypto.randomUUID)
        ? () => window.crypto.randomUUID()
        : (window.crypto && window.crypto.getRandomValues)
        ? () => {
            const bytes = new Uint8Array(16);
            window.crypto.getRandomValues(bytes);
            bytes[6] = (bytes[6] & 0x0f) | 0x40; // version 4
            bytes[8] = (bytes[8] & 0x3f) | 0x80; // variant
            const hex = Array.from(bytes, b => b.toString(16).padStart(2, '0')).join('');
            return `${hex.substr(0,8)}-${hex.substr(8,4)}-${hex.substr(12,4)}-${hex.substr(16,4)}-${hex.substr(20)}`;
          }
        : () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
          });

        let id = localStorage.getItem("erpHostName");
        if (!id) {
            id = "HOST-" + randomUUID();
            localStorage.setItem("erpHostName", id);
        }
        return id;
    }

    document.addEventListener("DOMContentLoaded", function () {
        const uidEl = document.getElementById("userid");
        const pwdEl = document.getElementById("password");
        const errDiv = document.getElementById("login-error");
        const buSelectEl = document.getElementById("loginBuSelect");

        const lastUser = localStorage.getItem("erpLoginUserId");
        if (uidEl) uidEl.value = lastUser || "";

        const populateBuOptions = async () => {
            if (!buSelectEl) return;
            const lastBuId = localStorage.getItem("erpLoginBUId");
            buSelectEl.innerHTML = "";

            try {
                const resp = await fetch("/api/Login/BuList");
                if (!resp.ok) throw new Error("load failed");
                const items = await resp.json();
                if (Array.isArray(items)) {
                    items.forEach(item => {
                        const opt = document.createElement("option");
                        opt.value = item.buId || "";
                        opt.textContent = item.buName || item.buId || "";
                        if (lastBuId && opt.value === lastBuId) opt.selected = true;
                        buSelectEl.appendChild(opt);
                    });
                }
            } catch {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "Êú™ÊåáÂÆö";
                buSelectEl.appendChild(opt);
            }
        };

        populateBuOptions();

        document.getElementById("login-form").addEventListener("submit", async function (e) {
            e.preventDefault();

            const userid = uidEl.value.trim();
            const password = pwdEl.value;

            // üî• ‰ΩøÁî®Âõ∫ÂÆö HostNameÔºàË£ùÁΩÆË≠òÂà•Á¢ºÔºâ
            const hostName = getHostName();

            // Public IPÔºàÁßªÈô§Â∞çÂ§ñÈÉ®ÊúçÂãôÁöÑ‰æùË≥¥ÔºåÈÅøÂÖçË¢´ÈòªÊìãÈÄ†ÊàêÂç°‰ΩèÔºâ
            const clientIp = null;

            localStorage.setItem("erpLoginUserId", userid);
            errDiv.classList.add("d-none");

            try {
                const resp = await busyFetch('/api/Login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userid,
                        password: password,
                        hostName: hostName,   // ‚òÖ Âõ∫ÂÆöË£ùÁΩÆË≠òÂà•Á¢º
                        clientIp: clientIp
                      
                    })
                }, 'ÁôªÂÖ•‰∏≠‚Ä¶');

                if (resp.ok) {
                    const result = await resp.json();
                    localStorage.setItem("jwtId", result.jwtId);
                    if (buSelectEl && buSelectEl.selectedOptions.length > 0) {
                        const opt = buSelectEl.selectedOptions[0];
                        localStorage.setItem("erpLoginBUId", opt.value || "");
                        localStorage.setItem("erpLoginBUName", opt.textContent || "");
                    } else if (result.buName) {
                        localStorage.setItem("erpLoginBUName", result.buName);
                    } else {
                        localStorage.removeItem("erpLoginBUName");
                    }
                    window.location.href = "/FontIndex";
                } else {
                    const result = await resp.json().catch(() => ({}));
                    errDiv.textContent = result.error || "ÁôªÂÖ•Â§±Êïó";
                    errDiv.classList.remove("d-none");
                }
            } catch {
                errDiv.textContent = "Á∂≤Ë∑ØÊàñ‰º∫ÊúçÂô®ÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶";
                errDiv.classList.remove("d-none");
            }
        });
    });


</script>



</body>
</html>
