@using System.Text.Json
@{
    // PageModel ç«¯å…ˆæŠŠ ViewData["ReportConfig"], ["Fields"], ["FieldDictList"] éƒ½æº–å‚™å¥½äº†
    var cfg = (ReportConfig)ViewData["ReportConfig"];
    var json = JsonSerializer.Serialize(cfg, new JsonSerializerOptions { PropertyNamingPolicy = null });
        // ğŸ”§ æŠŠè¾­å…¸è¡¨åä¹Ÿä¸Ÿçµ¦ partial
    ViewData["DictTableName"] = cfg.DictTableName ?? "";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<style>
  #resultTable th, #resultTable td {
    writing-mode: horizontal-tb !important;
    text-orientation: mixed !important;
    transform: none !important;
    white-space: nowrap;
    vertical-align: middle;
  }
  #resultTable thead th {
    background: #f5f8ff;
    font-weight: 700;
    letter-spacing: 1px;
  }
</style>

<div class="container my-4">
  <h3 class="text-primary fw-bold mb-3">@cfg.Title</h3>

  <!-- æŸ¥è©¢æ¢ä»¶ -->
  <div class="card p-3 mb-4 shadow-sm" id="queryPanel">
    <div class="row g-3 align-items-end" id="paramRows">
      @foreach (var def in cfg.ParamDefs)
      {
        <div class="col-md-3">
          <label class="form-label">@def.Label</label>

          @if (def.Ui == ParamUiType.Date)
          {
            <input type="date" class="form-control"
                   id="@def.Name" name="@def.Name"
                   value="" data-default="@def.DefaultValue" />
          }
          else if (def.Ui == ParamUiType.Select)
          {
            var lookupAttr = string.IsNullOrWhiteSpace(def.LookupKey)
                ? ""
                : $"data-lookup=\"{def.LookupKey}\"";

            <select class="form-select"
                    id="@def.Name" name="@def.Name"
                    @Html.Raw(lookupAttr)
                    data-default="@def.DefaultValue">
              <option value=""></option>
              @if (def.Options != null)
              {
                foreach (var (value, text) in def.Options)
                {
                  <option value="@value">@text</option>
                }
              }
            </select>
          }
          else if (def.Ui == ParamUiType.Number)
          {
            <input type="number" class="form-control"
                   id="@def.Name" name="@def.Name"
                   value="" data-default="@def.DefaultValue" />
          }
          else
          {
            <input type="text" class="form-control"
                   id="@def.Name" name="@def.Name"
                   value="" data-default="@def.DefaultValue" />
          }
        </div>
      }

      <div class="col-12 text-end">
        <button id="btnSearch" class="btn btn-primary px-4">æŸ¥è©¢</button>
      </div>
    </div>
  </div>

    <!-- âœ… çµæœå€å¡Šï¼šæ–°å¢åˆ†é  -->
    <div id="resultTabs" class="card shadow-sm p-3" style="display:none;">
      <ul class="nav nav-tabs" id="reportTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-raw" data-bs-toggle="tab" data-bs-target="#tabRawPane" type="button" role="tab">åŸå§‹è³‡æ–™</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-pivot" data-bs-toggle="tab" data-bs-target="#tabPivotPane" type="button" role="tab">æ¨ç´åˆ†æ</button>
        </li>
      </ul>

      <div class="tab-content mt-3">
        <!-- åŸå§‹è³‡æ–™åˆ†é  -->
        <div class="tab-pane fade show active" id="tabRawPane" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle text-center mb-0" id="resultTable">
              <thead class="table-light" id="tableHead"></thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- æ¨ç´åˆ†æåˆ†é  -->
        <div class="tab-pane fade" id="tabPivotPane" role="tabpanel">
          <div id="pivotContainer" style="height:70vh; overflow:auto;">
            <div class="text-secondary text-center mt-5">å°šæœªè¼‰å…¥è³‡æ–™</div>
          </div>
        </div>
      </div>
    </div>
</div>
@* F3 å…±ç”¨è¾­å…¸ Modal *@
@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", Model.FieldDictList, ViewData)
<script src="~/js/fieldDictModal.js"></script>

<!-- âœ… jQuery æœ¬é«” -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- âœ… jQuery UIï¼ˆpivot éœ€è¦ sortable / draggableï¼‰-->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<!-- âœ… å…¶ä»–å¥—ä»¶ -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.min.css" rel="stylesheet"/>
<script>
(function () {
  // --- å¾Œç«¯å‚³ä¾†çš„å ±è¡¨è¨­å®š ---
  const cfg = @Html.Raw(json);
  cfg.ParamDefs = cfg.ParamDefs || [];

  // --- ä¾› renderTable ä½¿ç”¨çš„è¾­å…¸æ¬„ä½ï¼ˆåªå« Visible=1ï¼Œå·²æ’åºï¼‰ ---
  window._tableFields = @Html.Raw(Json.Serialize(ViewData["Fields"] ?? new object()));

  // ====== é€šç”¨å·¥å…· ======
  function pad2(n){ return String(n).padStart(2,'0'); }
  function todayOffset(expr){
    if (!expr || !/^today([+-]\d+d)?$/i.test(expr)) return '';
    const m = expr.match(/^today([+-]\d+)?d?$/i);
    const d = new Date();
    if (m && m[1]) d.setDate(d.getDate() + parseInt(m[1],10));
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  async function loadLookup(key, el){
    try{
      const res = await fetch(`/api/Report/lookup/${key}`);
      if (!res.ok) throw 0;
      const data = await res.json(); // [{value,text}]
      data.forEach(o=>{
        const opt = document.createElement('option');
        opt.value = o.value ?? '';
        opt.textContent = o.text ?? '';
        el.appendChild(opt);
      });
    }catch{
      // ä¿åº•è‡³å°‘æœ‰ä¸€å€‹ "(ä¸é™)"
      if (!el.querySelector('option')) {
        const opt = document.createElement('option');
        opt.value = ''; opt.textContent = '(ä¸é™)';
        el.appendChild(opt);
      }
    }
  }

  // ====== åˆå§‹åŒ–æ¢ä»¶ï¼ˆè¼‰å…¥ä¸‹æ‹‰ + å¥—é è¨­å€¼ï¼‰ ======
  async function initParams(){
    const jobs = [];
    (cfg.ParamDefs || []).forEach(def=>{
      const el = document.getElementById(def.Name);
      if (!el) return;
      const key = el.dataset.lookup;  // æœ‰ data-lookup æ‰æ‰“ API
      if (key) jobs.push(loadLookup(key, el));
    });
    await Promise.all(jobs);

    // é è¨­å€¼ï¼ˆæ—¥æœŸæ”¯æ´ today / today-120d ...ï¼‰
    (cfg.ParamDefs || []).forEach(def=>{
      const el = document.getElementById(def.Name);
      if (!el) return;
      const defVal = el.dataset.default || def.DefaultValue || "";
      if (def.Ui === 1 /* Date */ && typeof defVal === 'string' && defVal.startsWith('today')) {
        el.value = todayOffset(defVal);
      } else {
        el.value = defVal;
      }
    });
  }

  // ====== å‘¼å« SP ======
  async function doSearch() {
    const payload = { spName: cfg.SpName, params: {} };

    (cfg.ParamDefs || []).forEach(def => {
      const el = document.getElementById(def.Name);
      let v = el ? (el.value ?? "") : "";
      if (def.Name === "UseId" && !v) v = "A001";
      payload.params[def.Name] = v;
    });

    const btn = document.getElementById('btnSearch');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> æŸ¥è©¢ä¸­...';

    // âœ… æ”¹é€™è£¡
    const resultTabs = document.getElementById('resultTabs');
    if (resultTabs) resultTabs.style.display = 'none';

    try {
      const res = await fetch('/api/Report/exec', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(await res.text());

      const data = await res.json();

      if (!data.Rows || !Array.isArray(data.Rows) || data.Rows.length === 0) {
        Swal.fire({
          icon: 'info',
          title: 'æŸ¥ç„¡è³‡æ–™',
          text: 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚',
          confirmButtonText: 'ç¢ºå®š'
        });
        return;
      }

      window.renderTable?.(data.Columns, data.Rows);
    } catch (err) {
      console.error('æŸ¥è©¢ç™¼ç”ŸéŒ¯èª¤:', err);
      Swal.fire({
        icon: 'error',
        title: 'æŸ¥è©¢å¤±æ•—',
        text: err.message || 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚',
        confirmButtonText: 'ç¢ºå®š'
      });
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }

  // ====== ç¹ªè¡¨ ======
window.renderTable = function(apiColumns, rows) {
  const thead = document.getElementById('tableHead');
  const tbody = document.getElementById('tableBody');

  const dictFields = (window._tableFields || [])
    .filter(f => f.Visible)
    .sort((a,b) => (a.SerialNum ?? 0) - (b.SerialNum ?? 0));

  // å¾Œç«¯æ¬„ä½ï¼ˆå¿½ç•¥å¤§å°å¯«ï¼‰ï¼›è‹¥æ²’çµ¦ Columnsï¼Œå°±ç”¨ç¬¬ä¸€åˆ— rows çš„ keys
  let apiColsLower = [];
  if (Array.isArray(apiColumns) && apiColumns.length) {
    apiColsLower = apiColumns.map(c => String(c).toLowerCase());
  } else if (Array.isArray(rows) && rows.length) {
    apiColsLower = Object.keys(rows[0]).map(k => k.toLowerCase());
  }

  // ç”¨å¿½ç•¥å¤§å°å¯«æ–¹å¼é…å°è¾­å…¸æ¬„ä½
  let cols = dictFields.filter(f => apiColsLower.includes(String(f.FieldName).toLowerCase()));

  // è‹¥é…ä¸åˆ°å°± fallbackï¼šæŠŠç¬¬ä¸€åˆ—çš„æ‰€æœ‰ key å…¨éƒ¨é¡¯ç¤º
  if (!cols.length && Array.isArray(rows) && rows.length) {
    const keys = Object.keys(rows[0]);
    cols = keys.map(k => ({ FieldName: k, DisplayLabel: k, FormatStr: "" }));
  }

  // è¡¨é ­
  thead.innerHTML = `<tr>${
    cols.map(c => `<th>${(c.DisplayLabel || c.FieldName)}</th>`).join('')
  }</tr>`;

  // æ ¼å¼åŒ–
  function fmt(v, format) {
    if (v == null || format === "") return v ?? "";
    if (/^(yyyy\/MM\/dd|yyyy-MM-dd)$/.test(format)) {
      const d = (typeof v === 'string') ? new Date(v) : v;
      if (isNaN(d)) return v ?? "";
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      return format.includes('/') ? `${y}/${m}/${dd}` : `${y}-${m}-${dd}`;
    }
    if (typeof v === 'number' && /^#,#*0(\.[0#]+)?$/.test((format||'').replace(/ /g,''))) {
      const m = format.match(/\.(0+|#+)?$/);
      const max = m?.[0]?.length ? m[0].length-1 : 0;
      return v.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: Math.max(0,max) });
    }
    return v;
  }

  // è¡¨èº«
  tbody.innerHTML = (rows || []).map(r => `<tr>${
    cols.map(c => {
      const raw = r[c.FieldName];
      const text = fmt(raw, c.FormatStr || "");
      return `<td>${text ?? ''}</td>`;
    }).join('')
  }</tr>`).join('');

  // âœ… æ”¹é€™è£¡ï¼Œä¸è¦å†ç”¨ resultArea
  const resultTabs = document.getElementById('resultTabs');
  if (resultTabs) resultTabs.style.display = '';
};

   // ====== F3 è¾­å…¸ï¼ˆæ¬„ä½å¯è¦–/ä¸­æ–‡/é †åºï¼‰ ======
  // æä¾›çµ¦ fieldDictModal.js ç”¨
  window._dictTableName = cfg.DictTableName || (cfg.TableName || "");
  console.log('dict name =', window._dictTableName); // debug
  function openFieldDict() {
    const el = document.getElementById("fieldDictModal");
    if (!el) return;

    // å…ˆè¼‰å…¥ modal å…§å®¹ï¼ˆä½ çš„ fieldDictModal.js æœƒå®šç¾©é€™å€‹ï¼‰
    if (typeof window.initFieldDictModal === "function") {
      // å¸¶ modalIdï¼Œé¿å…æŠ“éŒ¯ tbody
      window.initFieldDictModal(window._dictTableName, "fieldDictModal");
    } else if (typeof window.loadFieldDict === "function") {
      window.loadFieldDict(window._dictTableName);
    }

    // é¡¯ç¤º Bootstrap Modal
    const modal = new bootstrap.Modal(el);
    modal.show();
  }

  // F3 ç†±éµï¼ˆé¿å…åœ¨æ–‡å­—è¼¸å…¥ä¸­èª¤è§¸ï¼‰
  document.addEventListener("keydown", (e) => {
    const tag = (e.target.tagName || "").toLowerCase();
    const inText = tag === "input" || tag === "textarea" || e.target.isContentEditable;
    if (e.key === "F3" && !inText) {
      e.preventDefault();
      openFieldDict();
    }
  });

  // å„²å­˜æˆåŠŸå¾Œï¼Œè®“å ±è¡¨ç«‹åˆ»å¥—ç”¨æœ€æ–°ä¸­æ–‡/å¯è¦–/é †åº
  window.addEventListener("field-dict-saved", () => location.reload());


  // ç¶äº‹ä»¶
  document.addEventListener('DOMContentLoaded', () => {
    initParams();
    document.getElementById('btnSearch')?.addEventListener('click', e=>{
      e.preventDefault();
      doSearch();
    });
  });

  const resultTabs = document.getElementById('resultTabs');
  const pivotContainer = document.getElementById('pivotContainer');

  // ====== æ¨™æº– renderTable ======
  const origRender = window.renderTable;
  window.renderTable = function(cols, rows) {
    origRender?.(cols, rows);

    if (rows && rows.length > 0) {
      if (resultTabs) resultTabs.style.display = '';
      pivotContainer.innerHTML = '<div class="text-secondary text-center mt-5">è¼‰å…¥ä¸­...</div>';
      window._lastReportData = { cols, rows };  // âœ… æš«å­˜çµ¦æ¨ç´åˆ†æä½¿ç”¨
    } else {
      if (resultTabs) resultTabs.style.display = 'none';
      Swal.fire({ icon: 'info', title: 'æŸ¥ç„¡è³‡æ–™', text: 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚' });
    }
  };

  // ====== é»æ“Šã€Œæ¨ç´åˆ†æã€åˆ†é æ™‚è¼‰å…¥ PivotTable ======
  document.getElementById('tab-pivot')?.addEventListener('shown.bs.tab', () => {
    const data = window._lastReportData?.rows;
    if (!data || !data.length) {
      pivotContainer.innerHTML = '<div class="text-secondary text-center mt-5">å°šæœªè¼‰å…¥è³‡æ–™</div>';
      return;
    }

    pivotContainer.innerHTML = '';

    try {
      // âœ… å–å‡ºè¾­å…¸æ¬„ä½ï¼ˆåƒ…é¡¯ç¤ºå¯è¦–æ¬„ä½ï¼‰
      const dictFields = (window._tableFields || [])
        .filter(f => f.Visible)
        .sort((a,b) => (a.SerialNum ?? 0) - (b.SerialNum ?? 0));

      // âœ… å»ºç«‹ä¸­è‹±æ–‡å°ç…§ map
      const nameMap = {};
      dictFields.forEach(f => {
        const en = f.FieldName?.trim();
        const zh = f.DisplayLabel?.trim() || en;
        nameMap[en] = zh;
      });

      // âœ… è½‰æ›è³‡æ–™ï¼šæŠŠæ¯åˆ—çš„ key å¾è‹±æ–‡æ›æˆä¸­æ–‡
      const localizedData = data.map(row => {
        const newRow = {};
        Object.keys(row).forEach(k => {
          if (nameMap[k]) newRow[nameMap[k]] = row[k];
        });
        return newRow;
      });

      // âœ… å–å¾—æ¬„ä½æ¸…å–®
      const visibleCols = dictFields.map(f => f.DisplayLabel?.trim() || f.FieldName);

      // âœ… è¼‰å…¥ pivotUIï¼ˆæ”¹ç”¨ä¸­æ–‡æ¬„ä½åï¼‰
      $("#pivotContainer").pivotUI(localizedData, {
        rows: [visibleCols[0] || ""],
        cols: [visibleCols[1] || ""],
        rendererName: "Table"
      });

    } catch (err) {
      console.error(err);
      pivotContainer.innerHTML = `<div class="alert alert-danger">è¼‰å…¥æ¨ç´åˆ†æç™¼ç”ŸéŒ¯èª¤ï¼š${err.message}</div>`;
    }
  });

})();

</script>
