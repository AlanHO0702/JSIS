@using System.Text.Json
@{
    // PageModel ç«¯å…ˆæŠŠ ViewData["ReportConfig"], ["Fields"], ["FieldDictList"] éƒ½æº–å‚™å¥½äº†
    var cfg = (ReportConfig)ViewData["ReportConfig"];
    var json = JsonSerializer.Serialize(cfg, new JsonSerializerOptions { PropertyNamingPolicy = null });
        // ğŸ”§ æŠŠè¾­å…¸è¡¨åä¹Ÿä¸Ÿçµ¦ partial
    ViewData["DictTableName"] = cfg.DictTableName ?? "";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<style>
  #resultTable th, #resultTable td {
    writing-mode: horizontal-tb !important;
    text-orientation: mixed !important;
    transform: none !important;
    white-space: nowrap;
    vertical-align: middle;
  }
  #resultTable thead th {
    background: #f5f8ff;
    font-weight: 700;
    letter-spacing: 1px;
  }
  /* æ”¶åˆç®­é ­ï¼šå±•é–‹æ™‚æœä¸‹ã€æ”¶åˆæ™‚æ—‹è½‰ */
  #btnToggleQuery.collapsed .chev { transform: rotate(-90deg); }
</style>

<div class="container my-4">
  <h3 class="text-primary fw-bold mb-3">@cfg.Title</h3>

  <!-- æŸ¥è©¢æ¢ä»¶ï¼ˆå¯æ”¶åˆï¼‰ -->
  <div class="card shadow-sm mb-4" id="queryPanel">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="fw-bold">æŸ¥è©¢æ¢ä»¶</div>

      <!-- æ”¶åˆæŒ‰éˆ• -->
      <button id="btnToggleQuery"
              class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-1"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#queryCollapse"
              aria-expanded="true"
              aria-controls="queryCollapse">
        <span class="chev" style="display:inline-block; transition: transform .2s ease;">â–¾</span>
        <span class="lbl">æ”¶åˆ</span>
      </button>
    </div>

    <div id="queryCollapse" class="collapse show">
      <div class="card-body">
        <div class="row g-3 align-items-end" id="paramRows">
          @foreach (var def in cfg.ParamDefs)
          {
            <div class="col-md-3">
              <label class="form-label">@def.Label</label>

              @if (def.Ui == ParamUiType.Date)
              {
                <input type="date" class="form-control"
                      id="@def.Name" name="@def.Name"
                      value="" data-default="@def.DefaultValue" />
              }
              else if (def.Ui == ParamUiType.Select)
              {
                var lookupAttr = string.IsNullOrWhiteSpace(def.LookupKey)
                    ? ""
                    : $"data-lookup=\"{def.LookupKey}\"";

                <select class="form-select"
                        id="@def.Name" name="@def.Name"
                        @Html.Raw(lookupAttr)
                        data-default="@def.DefaultValue">
                  <option value=""></option>
                  @if (def.Options != null)
                  {
                    foreach (var (value, text) in def.Options)
                    {
                      <option value="@value">@text</option>
                    }
                  }
                </select>
              }
              else if (def.Ui == ParamUiType.Number)
              {
                <input type="number" class="form-control"
                      id="@def.Name" name="@def.Name"
                      value="" data-default="@def.DefaultValue" />
              }
              else
              {
                <input type="text" class="form-control"
                      id="@def.Name" name="@def.Name"
                      value="" data-default="@def.DefaultValue" />
              }
            </div>
          }

          <div class="col-12 text-end d-flex justify-content-end gap-2">
            <button id="btnPrintReport" class="btn btn-success px-4">åˆ—å°å ±è¡¨</button>
            <button id="btnSearch" class="btn btn-primary px-4">æŸ¥è©¢</button>
          </div>
        </div>
      </div>
    </div>
  </div>


    <!-- âœ… çµæœå€å¡Šï¼šæ–°å¢åˆ†é  -->
    <div id="resultTabs" class="card shadow-sm p-3" style="display:none;">
      <ul class="nav nav-tabs" id="reportTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-raw" data-bs-toggle="tab" data-bs-target="#tabRawPane" type="button" role="tab">åŸå§‹è³‡æ–™</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-pivot" data-bs-toggle="tab" data-bs-target="#tabPivotPane" type="button" role="tab">æ¨ç´åˆ†æ</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-chart" data-bs-toggle="tab" data-bs-target="#tabChartPane" type="button" role="tab">
            åœ–è¡¨åˆ†æ
          </button>
        </li>
      </ul>

      <div class="tab-content mt-3">
        <!-- åŸå§‹è³‡æ–™åˆ†é  -->
        <div class="tab-pane fade show active" id="tabRawPane" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle text-center mb-0" id="resultTable">
              <thead class="table-light" id="tableHead"></thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- æ¨ç´åˆ†æåˆ†é  -->
        <div class="tab-pane fade" id="tabPivotPane" role="tabpanel">
          <div id="pivotContainer" style="height:70vh; overflow:auto;">
            <div class="text-secondary text-center mt-5">å°šæœªè¼‰å…¥è³‡æ–™</div>
          </div>
        </div>

        <!-- ğŸ“Š åœ–è¡¨åˆ†æåˆ†é  -->
        <div class="tab-pane fade" id="tabChartPane" role="tabpanel">
          <div class="mt-3">
            <div class="d-flex align-items-center gap-3 mb-3">
              <label class="form-label mb-0">åœ–è¡¨é¡å‹ï¼š</label>
              <select id="chartType" class="form-select" style="width:180px;">
                <option value="bar">é•·æ¢åœ–</option>
                <option value="line">æŠ˜ç·šåœ–</option>
                <option value="pie">åœ“é¤…åœ–</option>
              </select>
              <button id="btnDrawChart" class="btn btn-success">é‡æ–°ç”¢ç”Ÿåœ–è¡¨</button>
            </div>
            <div id="chartContainer">
              <canvas id="pivotChart" style="width:100%; height:70vh;"></canvas>
            </div>
          </div>
        </div>

      </div>
    </div>
</div>
@* F3 å…±ç”¨è¾­å…¸ Modal *@
@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", Model.FieldDictList, ViewData)
<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>

<!-- âœ… jQuery æœ¬é«” -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- âœ… jQuery UIï¼ˆpivot éœ€è¦ sortable / draggableï¼‰-->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<!-- âœ… å…¶ä»–å¥—ä»¶ -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
(function () {
  // --- å¾Œç«¯å‚³ä¾†çš„å ±è¡¨è¨­å®š ---
  const cfg = @Html.Raw(json);

  // === æŸ¥è©¢æ¢ä»¶æ”¶åˆç‹€æ…‹ï¼šä¾å ±è¡¨åç¨±æˆ– DictTableName è¨˜æ†¶ ===
  const QUERY_KEY = `report:queryCollapsed:${(cfg.DictTableName || cfg.Title || 'default')}`;

  function applyQueryCollapseRemember() {
    const btn = document.getElementById('btnToggleQuery');
    const pane = document.getElementById('queryCollapse');
    if (!btn || !pane) return;

    // è®€å–è¨˜æ†¶ï¼ˆ'1' = æ”¶åˆ, '0'/null = å±•é–‹ï¼‰
    const collapsed = localStorage.getItem(QUERY_KEY) === '1';

    // ç›´æ¥ä¿®æ”¹ class ä»¥ç¬¦åˆè¨˜æ†¶ç‹€æ…‹
    if (collapsed) {
      pane.classList.remove('show');
      btn.classList.add('collapsed');
      btn.setAttribute('aria-expanded', 'false');
      btn.querySelector('.lbl').textContent = 'å±•é–‹';
    } else {
      pane.classList.add('show');
      btn.classList.remove('collapsed');
      btn.setAttribute('aria-expanded', 'true');
      btn.querySelector('.lbl').textContent = 'æ”¶åˆ';
    }

    // ç¶å®šäº‹ä»¶ï¼šæ¯æ¬¡åˆ‡æ›æ™‚æ›´æ–°è¨˜æ†¶
    pane.addEventListener('shown.bs.collapse', () => {
      btn.classList.remove('collapsed');
      btn.setAttribute('aria-expanded', 'true');
      btn.querySelector('.lbl').textContent = 'æ”¶åˆ';
      localStorage.setItem(QUERY_KEY, '0');
    });
    pane.addEventListener('hidden.bs.collapse', () => {
      btn.classList.add('collapsed');
      btn.setAttribute('aria-expanded', 'false');
      btn.querySelector('.lbl').textContent = 'å±•é–‹';
      localStorage.setItem(QUERY_KEY, '1');
    });
  }

  // åœ¨ DOMContentLoaded æ™‚å¥—ç”¨
  document.addEventListener('DOMContentLoaded', () => {
    applyQueryCollapseRemember();
  });

  // âš™ï¸ ç¢ºä¿ ParamDefs ä¸€å®šæ˜¯é™£åˆ—ï¼Œä¸æœƒæ˜¯ç‰©ä»¶ {0:{},1:{}}
  cfg.ParamDefs = Array.isArray(cfg.ParamDefs)
    ? cfg.ParamDefs
    : Object.values(cfg.ParamDefs || []);

  // --- ä¾› renderTable ä½¿ç”¨çš„è¾­å…¸æ¬„ä½ï¼ˆåªå« Visible=1ï¼Œå·²æ’åºï¼‰ ---
  window._tableFields = @Html.Raw(Json.Serialize(ViewData["Fields"] ?? new object()));

  // ====== é€šç”¨å·¥å…· ======
  function pad2(n){ return String(n).padStart(2,'0'); }
  function todayOffset(expr){
    if (!expr || !/^today([+-]\d+d)?$/i.test(expr)) return '';
    const m = expr.match(/^today([+-]\d+)?d?$/i);
    const d = new Date();
    if (m && m[1]) d.setDate(d.getDate() + parseInt(m[1],10));
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  async function loadLookup(key, el){
    try{
      const res = await fetch(`/api/Report/lookup/${key}`);
      if (!res.ok) throw 0;
      const data = await res.json(); // [{value,text}]
      data.forEach(o=>{
        const opt = document.createElement('option');
        opt.value = String(o.value ?? '').trim();   // â¬… è½‰å­—ä¸² + å»ç©ºç™½
        opt.textContent = o.text ?? '';
        el.appendChild(opt);
      });
    }catch{
      if (!el.querySelector('option')) {
        const opt = document.createElement('option');
        opt.value = ''; opt.textContent = '(ä¸é™)';
        el.appendChild(opt);
      }
    }
  }

  // ====== åˆå§‹åŒ–æ¢ä»¶ï¼ˆè¼‰å…¥ä¸‹æ‹‰ + å¥—é è¨­å€¼ï¼‰ ======
  async function initParams() {
    cfg.ParamDefs = Array.isArray(cfg.ParamDefs) ? cfg.ParamDefs : Object.values(cfg.ParamDefs || {});
    for (const def of cfg.ParamDefs) {
      const el = document.getElementById(def.Name);
      if (!el) continue;

      const key = el.dataset.lookup;
      // â¬‡ é è¨­å€¼ä¸€å¾‹è½‰å­—ä¸²ä¸¦å»ç©ºç™½
      const defValRaw = el.dataset.default || def.DefaultValue || "";
      const defVal = String(defValRaw).trim();

      if (key) await loadLookup(key, el);

      if (def.Ui === 1 && typeof defVal === "string" && defVal.startsWith("today")) {
        el.value = todayOffset(defVal);
      } else {
        el.value = defVal;
        // è‹¥ä»æ²’é¸åˆ°ï¼ˆä¾‹å¦‚å¾Œç«¯çœŸçš„æœ‰å¤šé¤˜ç©ºç™½ï¼‰ï¼Œå†åšä¸€æ¬¡æ¯”å°ä¿®æ­£
        if (!el.value && el.options?.length > 0) {
          for (const opt of el.options) {
            if (String(opt.value).trim() === defVal) { el.value = opt.value; break; }
          }
        }
        if (!el.value && el.options?.length > 0) el.selectedIndex = 0; // æœ€å¾Œä¿åº•
      }
    }
  }



  // ====== å‘¼å« SP ======
  function collectParams() {
    const p = {};
    (cfg.ParamDefs || []).forEach(def => {
      const el = document.getElementById(def.Name);
      let v = el ? (el.value ?? "") : "";
      if (def.Name === "UseId" && !v) v = "A001";
      p[def.Name] = v;
    });
    return p;
  }

  async function doSearch() {
    const payload = { spName: cfg.SpName, params: collectParams() };

    const btn = document.getElementById('btnSearch');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> æŸ¥è©¢ä¸­...';

    // âœ… æ”¹é€™è£¡
    const resultTabs = document.getElementById('resultTabs');
    if (resultTabs) resultTabs.style.display = 'none';

    try {
      const res = await fetch('/api/Report/exec', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(await res.text());

      const data = await res.json();

      if (!data.Rows || !Array.isArray(data.Rows) || data.Rows.length === 0) {
        Swal.fire({
          icon: 'info',
          title: 'æŸ¥ç„¡è³‡æ–™',
          text: 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚',
          confirmButtonText: 'ç¢ºå®š'
        });
        return;
      }

      window.renderTable?.(data.Columns, data.Rows);
    } catch (err) {
      console.error('æŸ¥è©¢ç™¼ç”ŸéŒ¯èª¤:', err);
      Swal.fire({
        icon: 'error',
        title: 'æŸ¥è©¢å¤±æ•—',
        text: err.message || 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚',
        confirmButtonText: 'ç¢ºå®š'
      });
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }

  // ====== ç¹ªè¡¨ ======
  // ====== åˆ—å°å ±è¡¨ ======
  async function printReport() {
    const payload = {
      spName: cfg.SpName,
      reportName: cfg.ReportName || cfg.DictTableName || cfg.SpName || cfg.Title || "report",
      params: collectParams()
    };

    const btn = document.getElementById('btnPrintReport');
    const originalText = btn?.innerHTML;
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> åˆ—å°ä¸­...';
    }

    try {
      const res = await fetch('/api/report/generate-url', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(await res.text());

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
      setTimeout(() => URL.revokeObjectURL(url), 60_000);
    } catch (err) {
      Swal.fire({ icon: 'error', title: 'åˆ—å°å¤±æ•—', text: err.message || 'è«‹ç¨å¾Œå†è©¦' });
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
  }

window.renderTable = function(apiColumns, rows) {
  const thead = document.getElementById('tableHead');
  const tbody = document.getElementById('tableBody');

  const dictFields = (window._tableFields || [])
    .filter(f => f.Visible)
    .sort((a,b) => (a.SerialNum ?? 0) - (b.SerialNum ?? 0));

  // å¾Œç«¯æ¬„ä½ï¼ˆå¿½ç•¥å¤§å°å¯«ï¼‰ï¼›è‹¥æ²’çµ¦ Columnsï¼Œå°±ç”¨ç¬¬ä¸€åˆ— rows çš„ keys
  let apiColsLower = [];
  if (Array.isArray(apiColumns) && apiColumns.length) {
    apiColsLower = apiColumns.map(c => String(c).toLowerCase());
  } else if (Array.isArray(rows) && rows.length) {
    apiColsLower = Object.keys(rows[0]).map(k => k.toLowerCase());
  }

  // ç”¨å¿½ç•¥å¤§å°å¯«æ–¹å¼é…å°è¾­å…¸æ¬„ä½
  let cols = dictFields.filter(f => apiColsLower.includes(String(f.FieldName).toLowerCase()));

  // è‹¥é…ä¸åˆ°å°± fallbackï¼šæŠŠç¬¬ä¸€åˆ—çš„æ‰€æœ‰ key å…¨éƒ¨é¡¯ç¤º
  if (!cols.length && Array.isArray(rows) && rows.length) {
    const keys = Object.keys(rows[0]);
    cols = keys.map(k => ({ FieldName: k, DisplayLabel: k, FormatStr: "" }));
  }

  // è¡¨é ­
  thead.innerHTML = `<tr>${
    cols.map(c => `<th>${(c.DisplayLabel || c.FieldName)}</th>`).join('')
  }</tr>`;

  // æ ¼å¼åŒ–
  function fmt(v, format) {
    if (v == null || format === "") return v ?? "";
    if (/^(yyyy\/MM\/dd|yyyy-MM-dd)$/.test(format)) {
      const d = (typeof v === 'string') ? new Date(v) : v;
      if (isNaN(d)) return v ?? "";
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      return format.includes('/') ? `${y}/${m}/${dd}` : `${y}-${m}-${dd}`;
    }
    if (typeof v === 'number' && /^#,#*0(\.[0#]+)?$/.test((format||'').replace(/ /g,''))) {
      const m = format.match(/\.(0+|#+)?$/);
      const max = m?.[0]?.length ? m[0].length-1 : 0;
      return v.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: Math.max(0,max) });
    }
    return v;
  }

  // è¡¨èº«
  tbody.innerHTML = (rows || []).map(r => `<tr>${
    cols.map(c => {
      const raw = r[c.FieldName];
      const text = fmt(raw, c.FormatStr || "");
      return `<td>${text ?? ''}</td>`;
    }).join('')
  }</tr>`).join('');

  // âœ… æ”¹é€™è£¡ï¼Œä¸è¦å†ç”¨ resultArea
  const resultTabs = document.getElementById('resultTabs');
  if (resultTabs) resultTabs.style.display = '';
};

   // ====== F3 è¾­å…¸ï¼ˆæ¬„ä½å¯è¦–/ä¸­æ–‡/é †åºï¼‰ ======
  // æä¾›çµ¦ fieldDictModal.js ç”¨
  window._dictTableName = cfg.DictTableName || (cfg.TableName || "");
  console.log('dict name =', window._dictTableName); // debug
  function openFieldDict() {
    const el = document.getElementById("fieldDictModal");
    if (!el) return;

    // å…ˆè¼‰å…¥ modal å…§å®¹ï¼ˆä½ çš„ fieldDictModal.js æœƒå®šç¾©é€™å€‹ï¼‰
    if (typeof window.initFieldDictModal === "function") {
      // å¸¶ modalIdï¼Œé¿å…æŠ“éŒ¯ tbody
      window.initFieldDictModal(window._dictTableName, "fieldDictModal");
    } else if (typeof window.loadFieldDict === "function") {
      window.loadFieldDict(window._dictTableName);
    }

    // é¡¯ç¤º Bootstrap Modal
    const modal = new bootstrap.Modal(el);
    modal.show();
  }

  // F3 ç†±éµï¼ˆé¿å…åœ¨æ–‡å­—è¼¸å…¥ä¸­èª¤è§¸ï¼‰
  document.addEventListener("keydown", (e) => {
    const tag = (e.target.tagName || "").toLowerCase();
    const inText = tag === "input" || tag === "textarea" || e.target.isContentEditable;
    if (e.key === "F3" && !inText) {
      e.preventDefault();
      openFieldDict();
    }
  });

  // å„²å­˜æˆåŠŸå¾Œï¼Œè®“å ±è¡¨ç«‹åˆ»å¥—ç”¨æœ€æ–°ä¸­æ–‡/å¯è¦–/é †åº
  window.addEventListener("field-dict-saved", () => location.reload());


  // ç¶äº‹ä»¶
  document.addEventListener('DOMContentLoaded', () => {
    initParams();
    document.getElementById('btnSearch')?.addEventListener('click', e=>{
      e.preventDefault();
      doSearch();
    });
    document.getElementById('btnPrintReport')?.addEventListener('click', e=>{
      e.preventDefault();
      printReport();
    });
  });

  const resultTabs = document.getElementById('resultTabs');
  const pivotContainer = document.getElementById('pivotContainer');

  // ====== æ¨™æº– renderTable ======
  const origRender = window.renderTable;
  window.renderTable = function(cols, rows) {
    origRender?.(cols, rows);

    if (rows && rows.length > 0) {
      if (resultTabs) resultTabs.style.display = '';
      pivotContainer.innerHTML = '<div class="text-secondary text-center mt-5">è¼‰å…¥ä¸­...</div>';
      window._lastReportData = { cols, rows };  // âœ… æš«å­˜çµ¦æ¨ç´åˆ†æä½¿ç”¨
    } else {
      if (resultTabs) resultTabs.style.display = 'none';
      Swal.fire({ icon: 'info', title: 'æŸ¥ç„¡è³‡æ–™', text: 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚' });
    }
  };

  // ====== é»æ“Šã€Œæ¨ç´åˆ†æã€åˆ†é æ™‚è¼‰å…¥ PivotTable ======
  document.getElementById('tab-pivot')?.addEventListener('shown.bs.tab', () => {
    const data = window._lastReportData?.rows;
    if (!data || !data.length) {
      pivotContainer.innerHTML = '<div class="text-secondary text-center mt-5">å°šæœªè¼‰å…¥è³‡æ–™</div>';
      return;
    }

    // åªå»ºç«‹ä¸€æ¬¡é è¨­åˆ‡æ›å™¨
    if (!document.getElementById('pivotPresets')) {
      const bar = document.createElement('div');
      bar.className = 'd-flex gap-2 align-items-center mb-2';
      bar.innerHTML = `
        <label class="form-label mb-0">é è¨­ï¼š</label>
        <select id="pivotPresets" class="form-select" style="width:240px;"></select>
        <button id="pivotSavePreset" class="btn btn-outline-secondary">å„²å­˜ç›®å‰é…ç½®</button>
      `;
      pivotContainer.before(bar);
    }

    buildPivotUI();     // â† ç”¨æ–°å‡½æ•¸ç”¢ç”Ÿ pivotUIï¼ˆè¦‹ä¸‹ï¼‰

    pivotContainer.innerHTML = '';

    try {
      // âœ… å–å‡ºè¾­å…¸æ¬„ä½ï¼ˆåƒ…é¡¯ç¤ºå¯è¦–æ¬„ä½ï¼‰
      const dictFields = (window._tableFields || [])
        .filter(f => f.Visible)
        .sort((a,b) => (a.SerialNum ?? 0) - (b.SerialNum ?? 0));

      // âœ… å»ºç«‹ä¸­è‹±æ–‡å°ç…§ map
      const nameMap = {};
      dictFields.forEach(f => {
        const en = f.FieldName?.trim();
        const zh = f.DisplayLabel?.trim() || en;
        nameMap[en] = zh;
      });

      // âœ… è½‰æ›è³‡æ–™ï¼šæŠŠæ¯åˆ—çš„ key å¾è‹±æ–‡æ›æˆä¸­æ–‡
      const localizedData = data.map(row => {
        const newRow = {};
        Object.keys(row).forEach(k => {
          if (nameMap[k]) newRow[nameMap[k]] = row[k];
        });
        return newRow;
      });

      // âœ… å–å¾—æ¬„ä½æ¸…å–®
      const visibleCols = dictFields.map(f => f.DisplayLabel?.trim() || f.FieldName);

      // âœ… è¼‰å…¥ pivotUIï¼ˆæ”¹ç”¨ä¸­æ–‡æ¬„ä½åï¼‰
      $("#pivotContainer").pivotUI(localizedData, {
        rows: [visibleCols[0] || ""],
        cols: [visibleCols[1] || ""],
        rendererName: "Table"
      });

    } catch (err) {
      console.error(err);
      pivotContainer.innerHTML = `<div class="alert alert-danger">è¼‰å…¥æ¨ç´åˆ†æç™¼ç”ŸéŒ¯èª¤ï¼š${err.message}</div>`;
    }
  });

   // ===== ğŸ“Š åœ–è¡¨åˆ†é  =====
    let chartInstance = null;

    document.getElementById('tab-chart')?.addEventListener('shown.bs.tab', () => {
      refreshChartFromPivot();
    });

    // âœ… è‡ªå‹•å¾ PivotTable è®€å–ç›®å‰é¡¯ç¤ºçš„è³‡æ–™ç”¢ç”Ÿåœ–è¡¨ï¼ˆå«æ™ºèƒ½ç¸®æ”¾ï¼‰
    function refreshChartFromPivot() {
      const pivotTable = document.querySelector('#pivotContainer .pvtTable');
      const ctx = document.getElementById('pivotChart');
      const chartType = document.getElementById('chartType').value || 'bar';
      const chartContainer = document.getElementById('chartContainer');

      if (!pivotTable) {
        ctx.replaceWith(ctx.cloneNode(true)); // æ¸…ç©º
        Swal.fire({ icon: 'info', title: 'è«‹å…ˆå»ºç«‹æ¨ç´åˆ†æè¡¨æ ¼' });
        return;
      }

      // å–å‡ºè³‡æ–™ï¼ˆæ¬„ä½åç¨±èˆ‡åˆ—è³‡æ–™ï¼‰
      const headers = [...pivotTable.querySelectorAll('thead tr:last-child th')]
        .map(th => th.textContent.trim())
        .filter(t => t !== 'Totals');
      const rows = [...pivotTable.querySelectorAll('tbody tr')];

      const labels = [];
      const values = [];

      rows.forEach(tr => {
        const cells = tr.querySelectorAll('th,td');
        if (cells.length < 2) return;
        const label = cells[0].textContent.trim();
        const valCell = cells[cells.length - 1].textContent.trim().replace(/,/g, '');
        const val = parseFloat(valCell) || 0;
        if (label && !isNaN(val)) {
          labels.push(label);
          values.push(val);
        }
      });

      if (labels.length === 0) {
        ctx.replaceWith(ctx.cloneNode(true));
        Swal.fire({ icon: 'info', title: 'ç„¡æ³•å¾æ¨ç´åˆ†æä¸­æ“·å–æœ‰æ•ˆè³‡æ–™' });
        return;
      }

      // âœ… æ™ºèƒ½é«˜åº¦èª¿æ•´ï¼ˆæœ€å° 300ï¼Œæœ€å¤§ 600ï¼‰
      const dynamicHeight = Math.min(800, Math.max(400, labels.length * 25));
      chartContainer.style.height = dynamicHeight + 'px';
      chartContainer.style.overflowY = labels.length > 20 ? 'auto' : 'visible';

      // æ¸…é™¤èˆŠåœ–
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: chartType,
        data: {
          labels,
          datasets: [{
            label: headers[0] || 'æ•¸å€¼',
            data: values,
            backgroundColor: 'rgba(54,162,235,0.6)',
            borderColor: 'rgba(54,162,235,1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // âœ… é—œé–‰å›ºå®šæ¯”ä¾‹ï¼Œå…è¨±é«˜åº¦è‡ªå‹•æ’é–‹
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: headers[0] || 'æ¨ç´åˆ†æåœ–è¡¨' }
          },
          scales: {
            x: { title: { display: true, text: headers[0] || 'åˆ†é¡' } },
            y: { title: { display: true, text: 'æ•¸å€¼' } }
          }
        }
      });
    }

    // âœ… æ‰‹å‹•é‡æ–°ç”¢ç”Ÿåœ–è¡¨
    document.getElementById('btnDrawChart')?.addEventListener('click', () => {
      refreshChartFromPivot();
    });


    // === å®šç¾©å¯åˆ‡æ›çš„é è¨­ï¼ˆä¾ä½ çš„ä¸­æ–‡æ¬„ä½åå¡«ï¼‰===
  const PIVOT_PRESETS = {
    'å®¢æˆ¶ Ã— å®¢æˆ¶ç°¡ç¨±ï¼ˆç­†æ•¸ï¼‰': {
      rows: ['å®¢æˆ¶ä»£ç¢¼'],
      cols: ['å®¢æˆ¶ç°¡ç¨±'],
      aggregatorName: 'Count',
      rendererName: 'Table'
    },
    'äº¤æœŸ(æœˆ) Ã— å®¢æˆ¶ï¼ˆåŠ ç¸½æ•¸é‡ï¼‰': {
      rows: ['äº¤æœŸ(æœˆ)'],         // ä½ è‹¥æ²’æœ‰é€™æ¬„ï¼Œå¯åœ¨ localizedData äº‹å…ˆæ´¾ç”Ÿä¸€æ¬„
      cols: ['å®¢æˆ¶ç°¡ç¨±'],
      aggregatorName: 'Sum',
      vals: ['æ•¸é‡'],
      rendererName: 'Heatmap'     // ä¹Ÿå¯ç”¨ Table Heatmap
    },
    'å“å Ã— å®¢æˆ¶ï¼ˆåŠ ç¸½é‡‘é¡ï¼‰': {
      rows: ['å“å(å®¢æˆ¶æ–™è™Ÿ)'],
      cols: ['å®¢æˆ¶ç°¡ç¨±'],
      aggregatorName: 'Sum',
      vals: ['é‡‘é¡'],              // ä½ çš„æ¬„ä½åè‡ªè¡Œå°æ‡‰
      rendererName: 'Table'
    }
  };

  // ä¾å ±è¡¨ï¼ˆæˆ– DictTableNameï¼‰åš localStorage Key
  function pivotStorageKey() {
    const name = window._dictTableName || 'default-report';
    return `pivotCfg:${name}`;
  }

  // ç”¢ç”Ÿ/é‡å»º pivotUIï¼Œæ”¯æ´å¥—ç”¨é è¨­æˆ–é‚„åŸä½¿ç”¨è€…ä¸Šæ¬¡è¨­å®š
  function buildPivotUI(presetKey) {
    const raw = window._lastReportData?.rows || [];
    const dictFields = (window._tableFields || []).filter(f => f.Visible)
                                                  .sort((a,b) => (a.SerialNum ?? 0) - (b.SerialNum ?? 0));
    const nameMap = {};
    dictFields.forEach(f => {
      const en = f.FieldName?.trim();
      const zh = f.DisplayLabel?.trim() || en;
      nameMap[en] = zh;
    });

    // å°‡è³‡æ–™è‹±æ–‡éµæ›ä¸­æ–‡éµï¼ˆç¶­æŒä½ åŸæœ¬çš„ä½œæ³•ï¼‰
    const localizedData = raw.map(row => {
      const o = {};
      Object.keys(row).forEach(k => { if (nameMap[k]) o[nameMap[k]] = row[k]; });
      return o;
    });

    // å…ˆæ¸…ç©ºå®¹å™¨
    const container = document.getElementById('pivotContainer');
    container.innerHTML = '';

    // æº–å‚™ optionsï¼šå…ˆçœ‹æ˜¯å¦æœ‰ä¸Šæ¬¡ä½¿ç”¨è€…é…ç½®ï¼ˆlocalStorageï¼‰ï¼Œå¦å‰‡å¥— presetï¼Œæœ€å¾Œæ‰é€€å›é è¨­ rows/cols
    let opts = { rendererName: 'Table' };
    const saved = localStorage.getItem(pivotStorageKey());
    if (saved && !presetKey) {
      // é‚„åŸä½¿ç”¨è€…ä¸Šæ¬¡é…ç½®
      try { opts = JSON.parse(saved); } catch {}
    } else if (presetKey && PIVOT_PRESETS[presetKey]) {
      opts = { ...PIVOT_PRESETS[presetKey] };
    } else {
      // ä½ åŸæœ¬çš„åˆå§‹å€¼
      const visibleCols = dictFields.map(f => f.DisplayLabel?.trim() || f.FieldName);
      opts.rows = [visibleCols[0] || ""];
      opts.cols = [visibleCols[1] || ""];
      opts.rendererName = 'Table';
    }

    // å»ºç«‹ pivotUI
    $("#pivotContainer").pivotUI(localizedData, opts, true);

    // ç›£è½ onRefreshï¼šæ¯æ¬¡ä½¿ç”¨è€…æ”¹å‹•å°±å­˜èµ·ä¾†
    const $pvt = $("#pivotContainer");
    const onRefresh = $pvt.data("pivotUIOptions")?.onRefresh;
    // æ›¿æ› onRefresh ä»¥å­˜å„²ï¼ˆä¿ç•™èˆŠçš„è¡Œç‚ºï¼‰
    const saveOnRefresh = function(cfg) {
      // cfg æœƒå¸¶å¾ˆå¤šå‡½å¼/DOMï¼Œç•™ä¹¾æ·¨çš„å°±å¥½
      const safe = (({ rows, cols, vals, aggregatorName, rendererName, sorters, derivedAttributes, inclusions, exclusions, unusedAttrsVertical }) =>
        ({ rows, cols, vals, aggregatorName, rendererName, sorters, derivedAttributes, inclusions, exclusions, unusedAttrsVertical }))(cfg);
      localStorage.setItem(pivotStorageKey(), JSON.stringify(safe));
      if (typeof onRefresh === 'function') onRefresh(cfg);
    };
    // å¯«å› options
    const options = $pvt.data("pivotUIOptions");
    options.onRefresh = saveOnRefresh;
    $pvt.data("pivotUIOptions", options);

    // å»ºç«‹/æ›´æ–°ã€Œé è¨­é¸å–®ã€å…§å®¹èˆ‡äº‹ä»¶
    const sel = document.getElementById('pivotPresets');
    if (sel && sel.options.length === 0) {
      Object.keys(PIVOT_PRESETS).forEach(name => sel.add(new Option(name, name)));
      sel.addEventListener('change', () => buildPivotUI(sel.value));
      document.getElementById('pivotSavePreset')?.addEventListener('click', () => {
        const cfg = $("#pivotContainer").data("pivotUIOptions");
        const safe = (({ rows, cols, vals, aggregatorName, rendererName, sorters, derivedAttributes, inclusions, exclusions, unusedAttrsVertical }) =>
          ({ rows, cols, vals, aggregatorName, rendererName, sorters, derivedAttributes, inclusions, exclusions, unusedAttrsVertical }))(cfg);
        localStorage.setItem(pivotStorageKey(), JSON.stringify(safe));
        Swal.fire({ icon:'success', title:'å·²å„²å­˜ç›®å‰é…ç½®' });
      });
    }

    // è‹¥æ˜¯å¸¶å…¥ presetï¼Œå°±æŠŠä¸‹æ‹‰é¸å–®ä¹Ÿé¸åˆ°é‚£å€‹
    if (sel && presetKey) sel.value = presetKey;
  }


})();

</script>
