@model dynamic
@using System.Linq

@{
    // 預期由頁面 model 提供：List<ItemCustButtonRow>
    var buttons = (IEnumerable<dynamic>)(Model?.CustomButtons ?? Enumerable.Empty<dynamic>());
}

@foreach (var b in buttons)
{
    var caption = (b?.Caption ?? b?.CustCaption ?? b?.ButtonName ?? "").ToString();
    if (string.IsNullOrWhiteSpace(caption)) { continue; }

    var hint = (b?.Hint ?? b?.CustHint ?? "").ToString();
    var btnName = (b?.ButtonName ?? "").ToString();

    var designType = (b?.DesignType ?? "").ToString();
    var searchTemplate = (b?.SearchTemplate ?? "").ToString();
    var spName = (b?.SpName ?? "").ToString();
    var execSpName = (b?.ExecSpName ?? "").ToString();
    var multiSelectDd = (b?.MultiSelectDD ?? "").ToString();
    var replaceExists = (b?.ReplaceExists ?? "").ToString();
    var dialogCaption = (b?.DialogCaption ?? "").ToString();
    var allowSelCount = (b?.AllowSelCount ?? "").ToString();

    <button type="button"
            class="fab"
            title="@hint"
            data-custom-btn="1"
            data-button-name="@btnName"
            data-design-type="@designType"
            data-search-template="@searchTemplate"
            data-sp-name="@spName"
            data-exec-sp-name="@execSpName"
            data-multi-select-dd="@multiSelectDd"
            data-replace-exists="@replaceExists"
            data-dialog-caption="@dialogCaption"
            data-allow-sel-count="@allowSelCount">
        @caption
    </button>
}

<div class="modal fade" id="paperSearchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl paper-search-dialog">
    <div class="modal-content paper-search-modal">
      <div class="modal-header">
        <h5 class="modal-title">查詢並挑選</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form class="mb-3 paper-search-form"></form>
        <div class="row paper-search-picker">
          <div class="col-5 paper-search-col">
            <div class="paper-search-title">可選擇的項目</div>
            <div class="paper-search-scroll">
      <table class="table table-sm table-striped mb-0 paper-search-available">
                <thead><tr></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="col-2 paper-search-transfer">
            <button class="btn btn-outline-primary ps-right" type="button" aria-label="右移">
              <span class="material-symbols-outlined" aria-hidden="true">keyboard_arrow_right</span>
            </button>
            <button class="btn btn-outline-primary ps-right-all" type="button" aria-label="全部右移">
              <span class="material-symbols-outlined" aria-hidden="true">keyboard_double_arrow_right</span>
            </button>
            <button class="btn btn-outline-secondary ps-left" type="button" aria-label="左移">
              <span class="material-symbols-outlined" aria-hidden="true">keyboard_arrow_left</span>
            </button>
            <button class="btn btn-outline-secondary ps-left-all" type="button" aria-label="全部左移">
              <span class="material-symbols-outlined" aria-hidden="true">keyboard_double_arrow_left</span>
            </button>
          </div>
          <div class="col-5 paper-search-col">
            <div class="paper-search-title">已選入的項目</div>
            <div class="paper-search-scroll">
              <table class="table table-sm table-striped mb-0 paper-search-selected">
                <thead><tr></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="form-check ps-replace">
          <input id="paperSearchReplace" class="form-check-input" type="checkbox">
          <label class="form-check-label" for="paperSearchReplace">取代已存在</label>
        </div>
        <button class="btn btn-success ps-confirm">確定</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="condRunSpModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog cond-runsp-dialog">
    <div class="modal-content cond-runsp-modal">
      <div class="modal-header">
        <h5 class="modal-title">輸入條件</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form class="cond-runsp-form"></form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success crs-confirm">確定</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<style>
  #paperSearchModal .paper-search-dialog { --bs-modal-width: 92vw; --bs-modal-margin: 11vh; }
  #paperSearchModal .paper-search-modal { height: calc(82vh); display: flex; flex-direction: column; }
  #paperSearchModal .modal-body { flex: 1 1 auto; display: flex; flex-direction: column; min-height: 0; overflow: hidden; padding: 16px; }
  #paperSearchModal .modal-footer { position: sticky; bottom: 0; background: #fff; z-index: 3; }
  #paperSearchModal .modal-footer { display: flex; align-items: center; gap: 12px; }
  #paperSearchModal .modal-footer .ps-replace { margin-left: auto; margin-right: auto; }
  #paperSearchModal .paper-search-picker { flex: 1 1 auto; min-height: 0; display: flex; gap: 4px; margin-left: 0; margin-right: 0; }
  #paperSearchModal .paper-search-picker > div { padding-left: 0; padding-right: 0; }
  #paperSearchModal .paper-search-col { display: flex; flex-direction: column; min-width: 0; }
  #paperSearchModal .paper-search-title {
    font-weight: 600;
    color: #475569;
    font-size: 13px;
  }
  #paperSearchModal .paper-search-col:first-child { flex: 0 0 58%; }
  #paperSearchModal .paper-search-col:last-child { flex: 1 1 0; }
  #paperSearchModal .paper-search-scroll { flex: 1 1 0; min-height: 0; overflow: auto; border: 1px solid #e5e7eb; border-radius: 8px; }
  #paperSearchModal .paper-search-transfer { flex: 0 0 56px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: .6rem; }
  #paperSearchModal .paper-search-transfer .btn {
    width: 28px;
    height: 28px;
    padding: 0;
    border: 1px solid currentColor;
    border-radius: 6px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  #paperSearchModal .paper-search-transfer .btn:hover {
    border-color: currentColor;
    box-shadow: none;
  }
  #paperSearchModal .paper-search-transfer .material-symbols-outlined {
    font-size: 28px;
    line-height: 1;
  }
  #paperSearchModal thead th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; }
  #paperSearchModal table { border-collapse: collapse; }
  #paperSearchModal th, #paperSearchModal td { border: 1px solid #dee2e6; vertical-align: middle; }
  #paperSearchModal .paper-search-scroll th,
  #paperSearchModal .paper-search-scroll td {
    white-space: nowrap;
  }
  #paperSearchModal .paper-search-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
    position: relative;
    padding-right: 120px;
  }
  #paperSearchModal .paper-search-form .ps-grid {
    display: grid;
    grid-template-columns: repeat(4, 300px);
    grid-auto-rows: minmax(0, auto);
    gap: 8px 16px;
    justify-content: start;
    align-items: start;
  }
  #paperSearchModal .paper-search-form .ps-field {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 0;
  }
  #paperSearchModal .paper-search-form .ps-label {
    white-space: nowrap;
    margin: 0;
    flex: 0 0 100px;
    text-align: right;
    font-size: var(--field-label-size);
  }
  #paperSearchModal .paper-search-form .ps-control {
    flex: 0 0 200px;
    min-width: 0;
    font-size: var(--field-value-size);
  }
  #paperSearchModal .paper-search-scroll table,
  #paperSearchModal .paper-search-scroll th,
  #paperSearchModal .paper-search-scroll td {
    font-size: var(--field-value-size);
  }
  #paperSearchModal .paper-search-scroll tbody tr { cursor: pointer; }
  #paperSearchModal .paper-search-scroll tbody tr.ps-row-selected,
  #paperSearchModal .paper-search-scroll tbody tr.ps-row-selected > td {
    background: #dbeafe !important;
  }
  #paperSearchModal .paper-search-scroll tbody tr.ps-row-selected {
    --bs-table-bg-type: #dbeafe;
    --bs-table-accent-bg: #dbeafe;
  }
  #paperSearchModal .paper-search-form .ps-actions {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    position: absolute;
    top: 0;
    right: 0;
    margin: 0;
  }
  #paperSearchModal .paper-search-form .ps-tab-content {
    margin-top: 6px;
  }
  #paperSearchModal .ps-fetch.is-loading { pointer-events: none; opacity: .8; }
  #paperSearchModal .ps-fetch .spin { display: inline-block; margin-right: 6px; animation: ps-spin 0.8s linear infinite; }
  #paperSearchModal .modal-header { cursor: move; user-select: none; }
  #paperSearchModal .modal-header :is(button, input, select, textarea, a) { cursor: default; }
  @@keyframes ps-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  @@media (max-width: 991.98px){
    #paperSearchModal .paper-search-dialog { --bs-modal-width: 100vw; --bs-modal-margin: 0; }
    #paperSearchModal .paper-search-modal { border-radius: 0; }
  }

  #condRunSpModal .cond-runsp-dialog { --bs-modal-width: 520px; }
  #condRunSpModal .cond-runsp-modal { display: flex; flex-direction: column; }
  #condRunSpModal .modal-body { padding: 16px 18px; }
  #condRunSpModal .cond-runsp-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  #condRunSpModal .crs-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px 12px;
  }
  #condRunSpModal .crs-field {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #condRunSpModal .crs-label {
    white-space: nowrap;
    margin: 0;
    flex: 0 0 90px;
    text-align: right;
    font-size: var(--field-label-size);
  }
  #condRunSpModal .crs-control {
    flex: 1 1 auto;
    min-width: 0;
    font-size: var(--field-value-size);
  }
</style>

<script>
(() => {
  const resolveCustomHandler = (btnName) => {
    const map = window.ActionRailCustomHandlers || {};
    const itemId = window._singleItemId || window._itemId || "";
    if (map[itemId] && typeof map[itemId][btnName] === "function") return map[itemId][btnName];
    if (typeof map[btnName] === "function") return map[btnName];
    return null;
  };

  const readPaperNum = () => {
    const v = (window._paperNum || "").toString().trim();
    if (v) return v;
    if (typeof window.getPaperNum === "function") {
      try { return (window.getPaperNum() || "").toString().trim(); } catch { /* ignore */ }
    }
    return "";
  };

  const withJwtHeaders = (init = {}) => {
    const jwt = localStorage.getItem("jwtId");
    const headers = Object.assign({}, init.headers || {});
    if (jwt) headers["X-JWTID"] = jwt;
    return { ...init, headers };
  };

  const hasDateOnlyMask = (mask) => {
    const m = (mask || "").toString().toLowerCase();
    if (!m) return false;
    const isDate = m.includes("yyyy") && m.includes("mm") && m.includes("dd");
    const hasTime = m.includes("hh") || m.includes("ss") || m.includes("tt");
    return isDate && !hasTime;
  };

  const parseDateValue = (value) => {
    if (!value) return null;
    if (value instanceof Date && !isNaN(value)) return value;
    const s = String(value).trim();
    if (!s) return null;
    if (/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s.slice(0, 10));
    if (/^\d{4}[/.]\d{1,2}[/.]\d{1,2}$/.test(s)) {
      const [y, m, d] = s.split(/[/.]/).map(Number);
      return new Date(y, (m || 1) - 1, d || 1);
    }
    if (/^\d{8}$/.test(s)) {
      const y = Number(s.slice(0, 4));
      const m = Number(s.slice(4, 6));
      const d = Number(s.slice(6, 8));
      return new Date(y, (m || 1) - 1, d || 1);
    }
    const dt = new Date(s);
    return isNaN(dt) ? null : dt;
  };

  const formatDateByMask = (value, mask) => {
    const dt = parseDateValue(value);
    if (!dt) return value;
    const sep = (mask || "").includes("/") ? "/" : ((mask || "").includes(".") ? "." : "-");
    const y = dt.getFullYear();
    const m = String(dt.getMonth() + 1).padStart(2, "0");
    const d = String(dt.getDate()).padStart(2, "0");
    return `${y}${sep}${m}${sep}${d}`;
  };

  const applyEditMask = (value, editMask) => {
    if (hasDateOnlyMask(editMask)) return formatDateByMask(value, editMask);
    return value;
  };

  const paperSearch = (() => {
    const modalEl = document.getElementById("paperSearchModal");
    if (modalEl && modalEl.parentElement !== document.body) {
      document.body.appendChild(modalEl);
    }
    const formEl = modalEl?.querySelector(".paper-search-form");
    const availTable = modalEl?.querySelector(".paper-search-available");
    const selTable = modalEl?.querySelector(".paper-search-selected");
    const btnRight = modalEl?.querySelector(".ps-right");
    const btnLeft = modalEl?.querySelector(".ps-left");
    const btnRightAll = modalEl?.querySelector(".ps-right-all");
    const btnLeftAll = modalEl?.querySelector(".ps-left-all");
    const btnConfirm = modalEl?.querySelector(".ps-confirm");
    const ckReplace = modalEl?.querySelector("#paperSearchReplace");
    const titleEl = modalEl?.querySelector(".modal-title");
    const dialogEl = modalEl?.querySelector(".modal-dialog");
    const headerEl = modalEl?.querySelector(".modal-header");

    const state = {
      itemId: "",
      buttonName: "",
      paperNum: "",
      allowSelCount: 0,
      replaceExists: 0,
      dict: [],
      searchParams: [],
      insertKeys: [],
      inputs: {},
      available: [],
      selected: [],
      editableFields: new Set(),
      selectedAvailIdx: new Set(),
      selectedSelIdx: new Set()
    };

    const enableDrag = () => {
      if (!modalEl || !dialogEl || !headerEl) return;
      let dragging = false;
      let startX = 0, startY = 0, startLeft = 0, startTop = 0;

      const resetDialogStyle = () => {
        dialogEl.style.position = '';
        dialogEl.style.left = '';
        dialogEl.style.top = '';
        dialogEl.style.margin = '';
        dialogEl.style.transform = '';
      };

      const begin = (ev) => {
        const isMouse = ev.pointerType === 'mouse' || ev.pointerType === undefined;
        if (isMouse && ev.button !== 0) return;
        if (ev.target?.closest('button, input, select, textarea, a')) return;

        const rect = dialogEl.getBoundingClientRect();
        dialogEl.style.position = 'fixed';
        dialogEl.style.margin = '0';
        dialogEl.style.left = `${rect.left}px`;
        dialogEl.style.top = `${rect.top}px`;
        dialogEl.style.transform = 'none';

        startX = ev.clientX;
        startY = ev.clientY;
        startLeft = rect.left;
        startTop = rect.top;
        dragging = true;

        if (headerEl.setPointerCapture && ev.pointerId !== undefined) {
          headerEl.setPointerCapture(ev.pointerId);
        }
        ev.preventDefault();
      };

      const move = (ev) => {
        if (!dragging) return;
        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;

        const w = dialogEl.offsetWidth || dialogEl.getBoundingClientRect().width;
        const h = dialogEl.offsetHeight || dialogEl.getBoundingClientRect().height;

        let left = startLeft + dx;
        let top = startTop + dy;

        const keepVisibleX = 120;
        const keepVisibleY = 80;
        const minLeft = -(w - keepVisibleX);
        const maxLeft = window.innerWidth - keepVisibleX;
        const minTop = -(h - keepVisibleY);
        const maxTop = window.innerHeight - keepVisibleY;

        left = Math.min(Math.max(minLeft, left), maxLeft);
        top = Math.min(Math.max(minTop, top), maxTop);

        dialogEl.style.left = `${left}px`;
        dialogEl.style.top = `${top}px`;
      };

      const end = () => { dragging = false; };

      headerEl.addEventListener('pointerdown', begin);
      headerEl.addEventListener('pointermove', move);
      headerEl.addEventListener('pointerup', end);
      headerEl.addEventListener('pointercancel', end);

      modalEl.addEventListener('hidden.bs.modal', resetDialogStyle);
      modalEl.addEventListener('show.bs.modal', resetDialogStyle);
    };

    enableDrag();

    const toNumber = (v, fallback = 0) => {
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : fallback;
    };

    const normalizeKey = (name) => (name || "").replace(/^@@+/, "").toLowerCase();

    const getRowValue = (row, field) => {
      if (!row) return "";
      const key = normalizeKey(field);
      const hit = Object.keys(row).find(k => k.toLowerCase() === key);
      if (!hit) return "";
      const val = row[hit];
      return val == null ? "" : val;
    };

    const clearTable = (table) => {
      const head = table?.querySelector("thead tr");
      const body = table?.querySelector("tbody");
      if (head) head.innerHTML = '';
      if (body) body.innerHTML = "";
    };

    const buildHeads = () => {
      const headHtml = (state.dict || []).map(c => {
        const w = Math.max(40, Number(c.DisplaySize ?? 120));
        return `<th data-field="${c.FieldName}" style="min-width:${w}px;width:${w}px;">${c.DisplayLabel ?? ""}</th>`;
      }).join("");
      availTable?.querySelector("thead tr")?.insertAdjacentHTML("beforeend", headHtml);
      selTable?.querySelector("thead tr")?.insertAdjacentHTML("beforeend", headHtml);
    };

    const fmtCell = (val, col) => {
      if (val == null) return "";
      if ((col.DataType || "").toString().toLowerCase().includes("date")) {
        const d = new Date(val);
        if (!Number.isNaN(d.getTime())) return d.toISOString().slice(0, 10);
      }
      if ((col.DataType || "").toString().toLowerCase().includes("number")) {
        const n = Number(String(val).replace(/,/g, ""));
        if (!Number.isNaN(n)) return n.toLocaleString();
      }
      return String(val);
    };

    const renderRows = () => {
      const cols = state.dict || [];
      const availBody = availTable?.querySelector("tbody");
      const selBody = selTable?.querySelector("tbody");
      if (!availBody || !selBody) return;

      const availHtml = state.available.map(r => {
        const isSelected = state.selectedAvailIdx.has(r.idx);
        const tds = cols.map(c => {
          const v = getRowValue(r.data, c.FieldName);
          const cls = (c.DataType || "").toString().toLowerCase().includes("number") ? "text-end" : "";
          return `<td class="${cls}">${fmtCell(v, c)}</td>`;
        }).join("");
        const selClass = isSelected ? " ps-row-selected" : "";
        return `<tr data-idx="${r.idx}" class="${selClass}">${tds}</tr>`;
      }).join("");

      const selHtml = state.selected.map(r => {
        const isSelected = state.selectedSelIdx.has(r.idx);
        const tds = cols.map(c => {
          const v = getRowValue(r.data, c.FieldName);
          const cls = (c.DataType || "").toString().toLowerCase().includes("number") ? "text-end" : "";
          return `<td class="${cls}">${fmtCell(v, c)}</td>`;
        }).join("");
        const selClass = isSelected ? " ps-row-selected" : "";
        return `<tr data-idx="${r.idx}" class="${selClass}">${tds}</tr>`;
      }).join("");

      availBody.innerHTML = availHtml;
      selBody.innerHTML = selHtml;
    };

    const moveRight = () => {
      if (!availTable) return;
      const picked = Array.from(state.selectedAvailIdx);
      if (!picked.length) return;
      if (state.allowSelCount > 0 && (state.selected.length + picked.length) > state.allowSelCount) {
        alert(`最多只能選 ${state.allowSelCount} 筆`);
        return;
      }
      picked.forEach(idx => {
        const row = state.available.find(x => x.idx === idx);
        if (!row) return;
        state.selected.push(row);
        state.available = state.available.filter(x => x.idx !== idx);
      });
      state.selectedAvailIdx.clear();
      renderRows();
    };

    const moveLeft = () => {
      if (!selTable) return;
      const picked = Array.from(state.selectedSelIdx);
      if (!picked.length) return;
      picked.forEach(idx => {
        const row = state.selected.find(x => x.idx === idx);
        if (!row) return;
        state.available.push(row);
        state.selected = state.selected.filter(x => x.idx !== idx);
      });
      state.selectedSelIdx.clear();
      renderRows();
    };

    const moveAllRight = () => {
      if (state.allowSelCount > 0 && (state.selected.length + state.available.length) > state.allowSelCount) {
        alert(`最多只能選 ${state.allowSelCount} 筆`);
        return;
      }
      if (!state.available.length) return;
      state.selected = state.selected.concat(state.available);
      state.available = [];
      state.selectedAvailIdx.clear();
      renderRows();
    };

    const moveAllLeft = () => {
      if (!state.selected.length) return;
      state.available = state.available.concat(state.selected);
      state.selected = [];
      state.selectedSelIdx.clear();
      renderRows();
    };

    const collectInputs = () => {
      const values = {};
      (state.searchParams || []).forEach(p => {
        const name = normalizeKey(p.ParamName || p.paramName);
        if (!name) return;
        const input = formEl?.querySelector(`[data-param="${name}"]`);
        if (input) {
          values[name] = input.value ?? "";
          return;
        }
        const tableKind = p.TableKind ?? p.tableKind;
        const paramValue = p.ParamValue ?? p.paramValue;
        const fromKind = paramValue ? getDefaultFromTableKind(tableKind, paramValue) : "";
        const defVal = fromKind || (p.DefaultValue ?? p.defaultValue ?? p.ParamValue ?? p.paramValue);
        values[name] = defVal == null ? "" : defVal;
      });
      if (values.useid != null && String(values.useid).trim() === "") {
        values.useid = window.DEFAULT_USEID || window._useId || "A001";
      }
      state.inputs = values;
      return values;
    };

    const readSelectedRows = () => {
      const rows = state.selected.map(r => ({ ...r.data }));
      if (!selTable) return rows;
      selTable.querySelectorAll("tbody tr").forEach((tr, idx) => {
        const row = rows[idx] || {};
        tr.querySelectorAll("input[data-field]").forEach(inp => {
          const field = inp.getAttribute("data-field");
          if (!field) return;
          row[field] = inp.value;
        });
        rows[idx] = row;
      });
      return rows;
    };

    const loadDict = async (table) => {
      if (!table) throw new Error("MultiSelectDD is required");
      const url = `/api/TableFieldLayout/DictFields?table=${encodeURIComponent(table)}&lang=TW`;
      const res = await fetch(url, withJwtHeaders());
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error("DictFields payload is not array");
      state.dict = data.filter(x => (x.Visible ?? x.visible) === 1 || (x.Visible ?? x.visible) === true).map(c => ({
        FieldName: c.FieldName ?? c.fieldName,
        DisplayLabel: c.DisplayLabel ?? c.displayLabel,
        DisplaySize: c.DisplaySize ?? c.displaySize,
        DataType: c.DataType ?? c.dataType
      }));
      return state.dict;
    };

    const loadParamOptions = async (itemId, buttonName, paramName, superValue) => {
      const extra = superValue ? `&superValue=${encodeURIComponent(superValue)}` : "";
      const url = `/api/PaperSearch/ParamOptionsV2?itemId=${encodeURIComponent(itemId)}&buttonName=${encodeURIComponent(buttonName)}&paramName=${encodeURIComponent(paramName)}${extra}`;
      const res = await fetch(url, withJwtHeaders());
      if (!res.ok) throw new Error(await res.text());
      return await res.json();
    };

    const getHeaderFieldValue = (name) => {
      const key = (name || "").toString().trim();
      if (!key) return "";
      const form = document.getElementById("orderHeaderForm");
      const el = form?.querySelector(`[name="${CSS.escape(key)}"]`);
      if (!el) return "";
      if (el instanceof HTMLSelectElement) {
        return (el.value || "").toString().trim();
      }
      if (el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement) {
        return (el.value || "").toString().trim();
      }
      return "";
    };

    const isMaster1 = (v) => (v || "").toString().trim().toLowerCase() === "master1";

    const getRowFieldValue = (row, field) => {
      if (!row || !field) return "";
      const key = String(field).toLowerCase();
      const hit = Object.keys(row).find(k => String(k).toLowerCase() === key);
      const val = hit ? row[hit] : "";
      return val == null ? "" : String(val).trim();
    };

    const getDetailRowByIndex = (index) => {
      const tabs = window._multiTabTabs || window._debugTabsData || [];
      const tab = tabs[index];
      const tabId = tab?.Id || tab?.id;
      if (!tabId) return null;
      const selected = window._multiTabSelectedRows?.[tabId];
      if (selected) return selected;
      return null;
    };

    const getSubDetailRowByIndex = (index) => {
      return window._paper3lSubDetailSelectedRows?.[String(index + 1)] || null;
    };

    const getDefaultFromTableKind = (tableKind, fieldName) => {
      const kind = (tableKind || "").toString().trim().toLowerCase();
      if (!kind || !fieldName) return "";
      if (kind === "master1") return getHeaderFieldValue(fieldName);
      const m = kind.match(/^(detail|subdetail)(\d+)$/);
      if (!m) return "";
      const idx = Math.max(0, parseInt(m[2], 10) - 1);
      if (m[1] === "detail") {
        return getRowFieldValue(getDetailRowByIndex(idx), fieldName);
      }
      return getRowFieldValue(getSubDetailRowByIndex(idx), fieldName);
    };

    const buildForm = async (itemId, buttonName) => {
      if (!formEl) return;
      formEl.innerHTML = "";
      const visibleParams = (state.searchParams || []).filter(p => {
        return Number(p.iVisible ?? p.IVisible ?? 0) === 1;
      });
      const pageSize = 12;
      const pages = [];
      for (let i = 0; i < visibleParams.length; i += pageSize) {
        pages.push(visibleParams.slice(i, i + pageSize));
      }

      let grids = [];
      if (pages.length > 1) {
        const nav = document.createElement("ul");
        nav.className = "nav nav-tabs ps-tabs";
        nav.setAttribute("role", "tablist");

        const tabContent = document.createElement("div");
        tabContent.className = "tab-content ps-tab-content";

        pages.forEach((group, idx) => {
          const tabId = `ps-tab-${idx + 1}`;
          const btn = document.createElement("button");
          btn.className = `nav-link${idx === 0 ? " active" : ""}`;
          btn.type = "button";
          btn.setAttribute("role", "tab");
          btn.setAttribute("data-bs-toggle", "tab");
          btn.setAttribute("data-bs-target", `#${tabId}`);
          btn.setAttribute("aria-controls", tabId);
          btn.setAttribute("aria-selected", idx === 0 ? "true" : "false");
          btn.textContent = idx === 0 ? "查詢條件" : `查詢條件${idx + 1}`;
          const li = document.createElement("li");
          li.className = "nav-item";
          li.setAttribute("role", "presentation");
          li.appendChild(btn);
          nav.appendChild(li);

          const pane = document.createElement("div");
          pane.className = `tab-pane fade${idx === 0 ? " show active" : ""}`;
          pane.id = tabId;
          pane.setAttribute("role", "tabpanel");

          const grid = document.createElement("div");
          grid.className = "ps-grid";
          pane.appendChild(grid);
          tabContent.appendChild(pane);
          grids.push({ grid, group });
        });

        formEl.appendChild(nav);
        formEl.appendChild(tabContent);
      } else {
        const grid = document.createElement("div");
        grid.className = "ps-grid";
        formEl.appendChild(grid);
        grids.push({ grid, group: visibleParams });
      }

      for (const { grid, group } of grids) {
        for (const p of group) {
        const name = normalizeKey(p.ParamName || p.paramName);
        if (!name) continue;

        const wrap = document.createElement("div");
        wrap.className = "ps-field";
        const label = document.createElement("label");
        label.className = "form-label ps-label";
        label.textContent = p.DisplayName || p.displayName || name;
        wrap.appendChild(label);

        const controlType = Number(p.ControlType ?? p.controlType ?? 0);
        const tableKind = p.TableKind ?? p.tableKind;
        const paramValue = p.ParamValue ?? p.paramValue;
        let headerDefault = "";
        if (paramValue) {
          headerDefault = getDefaultFromTableKind(tableKind, paramValue);
        }
        if (controlType === 1) {
          const select = document.createElement("select");
          select.className = "form-select form-select-sm ps-control";
          select.setAttribute("data-param", name);
          const emptyOpt = document.createElement("option");
          emptyOpt.value = "";
          emptyOpt.textContent = "";
          select.appendChild(emptyOpt);
          wrap.appendChild(select);
          try {
            const superKey = normalizeKey(p.SuperId || p.superId);
            const superInput = superKey ? formEl?.querySelector(`[data-param="${superKey}"]`) : null;
            const superValue = superInput ? (superInput.value ?? "") : "";
            const options = await loadParamOptions(itemId, buttonName, p.ParamName || p.paramName, superValue);
            if (Array.isArray(options)) {
              options.forEach(opt => {
                const o = document.createElement("option");
                const val = opt.value ?? opt.Value ?? "";
                const text = opt.text ?? opt.Text ?? "";
                o.value = val;
                o.textContent = text ? `${val} ${text}`.trim() : val;
                if (text && text !== val) o.title = text;
                select.appendChild(o);
              });
            }
          } catch (err) {
            console.warn("load options failed", err);
          }
          const defVal = headerDefault || (p.DefaultValue ?? p.defaultValue);
          if (defVal != null && defVal !== "") {
            select.value = applyEditMask(defVal, p.EditMask ?? p.editMask);
          }
          select.addEventListener("keydown", (ev) => {
            if (ev.key === "Delete" || ev.key === "Backspace") {
              select.value = "";
            }
          });
        } else {
          const input = document.createElement("input");
          input.className = "form-control form-control-sm ps-control";
          input.type = "text";
          input.setAttribute("data-param", name);
          const defVal = headerDefault || (p.DefaultValue ?? p.defaultValue);
          if (defVal != null && defVal !== "") {
            input.value = applyEditMask(defVal, p.EditMask ?? p.editMask);
          }
          const readOnly = Number(p.iReadOnly ?? p.IReadOnly ?? 0) === 1;
          if (readOnly) input.readOnly = true;
          wrap.appendChild(input);
        }

        grid.appendChild(wrap);
        }
      }

      const fetchWrap = document.createElement("div");
      fetchWrap.className = "ps-actions";
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn btn-primary ps-fetch";
      btn.textContent = "資料重取";
      fetchWrap.appendChild(btn);
      formEl.appendChild(fetchWrap);
    };

    const setFetchLoading = (loading) => {
      const btn = formEl?.querySelector(".ps-fetch");
      if (!btn) return;
      if (loading) {
        btn.classList.add("is-loading");
        btn.setAttribute("aria-busy", "true");
        btn.innerHTML = '<span class="spin">↻</span>查詢中...';
      } else {
        btn.classList.remove("is-loading");
        btn.removeAttribute("aria-busy");
        btn.textContent = "資料重取";
      }
    };

    const fetchSearch = async () => {
      setFetchLoading(true);
      const payload = {
        itemId: state.itemId,
        buttonName: state.buttonName,
        paperNum: state.paperNum,
        params: collectInputs()
      };
      try {
        const res = await fetch("/api/PaperSearch/Search", withJwtHeaders({
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }));
        const raw = await res.text();
        let data; try { data = JSON.parse(raw); } catch { data = { ok: false, error: raw }; }
        if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
        state.available = (data.data || []).map((r, i) => ({ idx: i, data: r }));
        state.selected = [];
        renderRows();
      } finally {
        setFetchLoading(false);
      }
    };

    const confirmInsert = async () => {
      collectInputs();
      const rows = readSelectedRows();
      if (!rows.length) {
        alert("尚未選擇任何項目");
        return;
      }
      const payload = {
        itemId: state.itemId,
        buttonName: state.buttonName,
        paperNum: state.paperNum,
        replace: !!ckReplace?.checked,
        inputs: state.inputs,
        rows
      };
      const res = await fetch("/api/PaperSearch/Confirm", withJwtHeaders({
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }));
      const raw = await res.text();
      let data; try { data = JSON.parse(raw); } catch { data = { ok: false, error: raw }; }
      if (!res.ok || !data.ok) {
        alert(`匯入失敗: ${data.error || `HTTP ${res.status}`}`);
        return;
      }
      alert(`匯入完成（${data.rows || 0} 筆）`);
      location.reload();
    };

    const open = async (ctx, meta) => {
      if (!modalEl) return;
      state.itemId = ctx.itemId || "";
      state.buttonName = ctx.buttonName || "";
      state.paperNum = ctx.paperNum || "";
      state.allowSelCount = toNumber(meta.allowSelCount, 0);
      state.replaceExists = toNumber(meta.replaceExists, 0);
      state.editableFields = new Set();

      const configUrl = `/api/PaperSearch/Config?itemId=${encodeURIComponent(state.itemId)}&buttonName=${encodeURIComponent(state.buttonName)}`;
      const res = await fetch(configUrl, withJwtHeaders());
      if (!res.ok) {
        alert(await res.text());
        return;
      }
      const cfg = await res.json();
      state.searchParams = cfg.searchParams || cfg.SearchParams || [];
      state.insertKeys = cfg.insertKeys || cfg.InsertKeys || [];

      state.editableFields = new Set(
        (state.insertKeys || [])
          .filter(k => Number(k.PositionType ?? k.positionType) === 0)
          .map(k => normalizeKey(k.KeyFieldName || k.keyFieldName))
          .filter(k => k)
      );

      const caption = meta.dialogCaption || cfg.dialogCaption || cfg.DialogCaption || ctx.caption || "查詢並挑選";
      if (titleEl) titleEl.textContent = caption;
      if (ckReplace) ckReplace.checked = false;
      if (state.replaceExists) ckReplace?.closest(".ps-replace")?.classList.remove("d-none");
      else ckReplace?.closest(".ps-replace")?.classList.add("d-none");

      clearTable(availTable);
      clearTable(selTable);
      await loadDict(meta.multiSelectDd || cfg.multiSelectDd || cfg.MultiSelectDd || "");
      buildHeads();
      await buildForm(state.itemId, state.buttonName);
      state.available = [];
      state.selected = [];
      state.selectedAvailIdx.clear();
      state.selectedSelIdx.clear();
      renderRows();

      if (window.bootstrap) {
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      }
    };

    const toggleRowSelection = (tr, set) => {
      const idx = Number(tr.dataset.idx);
      if (!Number.isFinite(idx)) return;
      if (set.has(idx)) set.delete(idx);
      else set.add(idx);
      tr.classList.toggle("ps-row-selected");
    };

    availTable?.addEventListener("click", (ev) => {
      if (ev.target?.closest("input, select, textarea, button, a")) return;
      const tr = ev.target?.closest("tbody tr");
      if (!tr) return;
      toggleRowSelection(tr, state.selectedAvailIdx);
    });

    selTable?.addEventListener("click", (ev) => {
      if (ev.target?.closest("input, select, textarea, button, a")) return;
      const tr = ev.target?.closest("tbody tr");
      if (!tr) return;
      toggleRowSelection(tr, state.selectedSelIdx);
    });

    btnRight?.addEventListener("click", moveRight);
    btnLeft?.addEventListener("click", moveLeft);
    btnRightAll?.addEventListener("click", moveAllRight);
    btnLeftAll?.addEventListener("click", moveAllLeft);
    btnConfirm?.addEventListener("click", (e) => { e.preventDefault(); confirmInsert(); });
    modalEl?.addEventListener("click", (ev) => {
      const btn = ev.target.closest(".ps-fetch");
      if (!btn) return;
      ev.preventDefault();
      fetchSearch().catch(err => alert(`查詢失敗: ${err?.message || err}`));
    });

    return { open };
  })();

  const condRunSp = (() => {
    const modalEl = document.getElementById("condRunSpModal");
    if (modalEl && modalEl.parentElement !== document.body) {
      document.body.appendChild(modalEl);
    }
    const formEl = modalEl?.querySelector(".cond-runsp-form");
    const btnConfirm = modalEl?.querySelector(".crs-confirm");
    const titleEl = modalEl?.querySelector(".modal-title");

    const state = {
      itemId: "",
      buttonName: "",
      paperNum: "",
      searchParams: [],
      inputs: {}
    };

    const normalizeKey = (name) => (name || "").replace(/^@@+/, "").toLowerCase();

    const loadParamOptions = async (itemId, buttonName, paramName, superValue) => {
      const extra = superValue ? `&superValue=${encodeURIComponent(superValue)}` : "";
      const url = `/api/PaperSearch/ParamOptions?itemId=${encodeURIComponent(itemId)}&buttonName=${encodeURIComponent(buttonName)}&paramName=${encodeURIComponent(paramName)}${extra}`;
      const res = await fetch(url, withJwtHeaders());
      if (!res.ok) throw new Error(await res.text());
      return await res.json();
    };

    const getHeaderFieldValue = (name) => {
      const key = (name || "").toString().trim();
      if (!key) return "";
      const form = document.getElementById("orderHeaderForm");
      const el = form?.querySelector(`[name="${CSS.escape(key)}"]`);
      if (!el) return "";
      if (el instanceof HTMLSelectElement) {
        return (el.value || "").toString().trim();
      }
      if (el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement) {
        return (el.value || "").toString().trim();
      }
      return "";
    };

    const getRowFieldValue = (row, field) => {
      if (!row || !field) return "";
      const key = String(field).toLowerCase();
      const hit = Object.keys(row).find(k => String(k).toLowerCase() === key);
      const val = hit ? row[hit] : "";
      return val == null ? "" : String(val).trim();
    };

    const getDetailRowByIndex = (index) => {
      const tabs = window._multiTabTabs || window._debugTabsData || [];
      const tab = tabs[index];
      const tabId = tab?.Id || tab?.id;
      if (!tabId) return null;
      const selected = window._multiTabSelectedRows?.[tabId];
      if (selected) return selected;
      return null;
    };

    const getSubDetailRowByIndex = (index) => {
      return window._paper3lSubDetailSelectedRows?.[String(index + 1)] || null;
    };

    const getDefaultFromTableKind = (tableKind, fieldName) => {
      const kind = (tableKind || "").toString().trim().toLowerCase();
      if (!kind || !fieldName) return "";
      if (kind === "master1") return getHeaderFieldValue(fieldName);
      const m = kind.match(/^(detail|subdetail)(\d+)$/);
      if (!m) return "";
      const idx = Math.max(0, parseInt(m[2], 10) - 1);
      if (m[1] === "detail") {
        return getRowFieldValue(getDetailRowByIndex(idx), fieldName);
      }
      return getRowFieldValue(getSubDetailRowByIndex(idx), fieldName);
    };

    const buildForm = async (itemId, buttonName) => {
      if (!formEl) return;
      formEl.innerHTML = "";
      const visibleParams = (state.searchParams || []).filter(p => {
        return Number(p.iVisible ?? p.IVisible ?? 0) === 1;
      });

      if (!visibleParams.length) {
        formEl.innerHTML = '<div class="text-muted small">（沒有可輸入的條件）</div>';
        return;
      }

      const grid = document.createElement("div");
      grid.className = "crs-grid";
      formEl.appendChild(grid);

      for (const p of visibleParams) {
        const name = normalizeKey(p.ParamName || p.paramName);
        if (!name) continue;

        const wrap = document.createElement("div");
        wrap.className = "crs-field";
        const label = document.createElement("label");
        label.className = "form-label crs-label";
        label.textContent = p.DisplayName || p.displayName || name;
        wrap.appendChild(label);

        const controlType = Number(p.ControlType ?? p.controlType ?? 0);
        const tableKind = p.TableKind ?? p.tableKind;
        const paramValue = p.ParamValue ?? p.paramValue;
        let headerDefault = "";
        if (paramValue) {
          headerDefault = getDefaultFromTableKind(tableKind, paramValue);
        }

        if (controlType === 1) {
          const select = document.createElement("select");
          select.className = "form-select form-select-sm crs-control";
          select.setAttribute("data-param", name);
          const emptyOpt = document.createElement("option");
          emptyOpt.value = "";
          emptyOpt.textContent = "";
          select.appendChild(emptyOpt);
          wrap.appendChild(select);
          try {
            const superKey = normalizeKey(p.SuperId || p.superId);
            const superInput = superKey ? formEl?.querySelector(`[data-param="${superKey}"]`) : null;
            const superValue = superInput ? (superInput.value ?? "") : "";
            const options = await loadParamOptions(itemId, buttonName, p.ParamName || p.paramName, superValue);
            if (Array.isArray(options)) {
              options.forEach(opt => {
                const o = document.createElement("option");
                const val = opt.value ?? opt.Value ?? "";
                const text = opt.text ?? opt.Text ?? "";
                o.value = val;
                o.textContent = text ? `${val} ${text}`.trim() : val;
                if (text && text !== val) o.title = text;
                select.appendChild(o);
              });
            }
          } catch (err) {
            console.warn("load options failed", err);
          }
          const defVal = headerDefault || (p.DefaultValue ?? p.defaultValue);
          if (defVal != null && defVal !== "") {
            select.value = applyEditMask(defVal, p.EditMask ?? p.editMask);
          }
          select.addEventListener("keydown", (ev) => {
            if (ev.key === "Delete" || ev.key === "Backspace") {
              select.value = "";
            }
          });
          const superKey = normalizeKey(p.SuperId || p.superId);
          if (superKey) {
            const superInput = formEl?.querySelector(`[data-param="${superKey}"]`);
            if (superInput && !select.dataset.superBound) {
              select.dataset.superBound = "1";
              superInput.addEventListener("change", async () => {
                try {
                  const options = await loadParamOptions(itemId, buttonName, p.ParamName || p.paramName, superInput.value ?? "");
                  select.innerHTML = "";
                  const emptyOpt = document.createElement("option");
                  emptyOpt.value = "";
                  emptyOpt.textContent = "";
                  select.appendChild(emptyOpt);
                  if (Array.isArray(options)) {
                    options.forEach(opt => {
                      const o = document.createElement("option");
                      const val = opt.value ?? opt.Value ?? "";
                      const text = opt.text ?? opt.Text ?? "";
                      o.value = val;
                      o.textContent = text ? `${val} ${text}`.trim() : val;
                      if (text && text !== val) o.title = text;
                      select.appendChild(o);
                    });
                  }
                } catch (err) {
                  console.warn("load options failed", err);
                }
              });
            }
          }
        } else {
          const input = document.createElement("input");
          input.className = "form-control form-control-sm crs-control";
          input.type = "text";
          input.setAttribute("data-param", name);
          const defVal = headerDefault || (p.DefaultValue ?? p.defaultValue);
          if (defVal != null && defVal !== "") {
            input.value = applyEditMask(defVal, p.EditMask ?? p.editMask);
          }
          const readOnly = Number(p.iReadOnly ?? p.IReadOnly ?? 0) === 1;
          if (readOnly) input.readOnly = true;
          wrap.appendChild(input);
        }

        grid.appendChild(wrap);
      }
    };

    const collectInputs = () => {
      const values = {};
      (state.searchParams || []).forEach(p => {
        const name = normalizeKey(p.ParamName || p.paramName);
        if (!name) return;
        const input = formEl?.querySelector(`[data-param="${name}"]`);
        if (input) {
          values[name] = input.value ?? "";
          return;
        }
        const tableKind = p.TableKind ?? p.tableKind;
        const paramValue = p.ParamValue ?? p.paramValue;
        const fromKind = paramValue ? getDefaultFromTableKind(tableKind, paramValue) : "";
        const defVal = fromKind || (p.DefaultValue ?? p.defaultValue ?? p.ParamValue ?? p.paramValue);
        values[name] = defVal == null ? "" : defVal;
      });
      if (values.useid != null && String(values.useid).trim() === "") {
        values.useid = window.DEFAULT_USEID || window._useId || "A001";
      }
      state.inputs = values;
      return values;
    };

    const setConfirmLoading = (loading) => {
      if (!btnConfirm) return;
      btnConfirm.disabled = loading;
      btnConfirm.textContent = loading ? "執行中..." : "確定";
    };

    const runSp = async () => {
      setConfirmLoading(true);
      const payload = {
        itemId: state.itemId,
        buttonName: state.buttonName,
        paperNum: state.paperNum,
        params: collectInputs()
      };
      try {
        const res = await fetch("/api/PaperSearch/RunSpExec", withJwtHeaders({
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }));
        const raw = await res.text();
        let data; try { data = JSON.parse(raw); } catch { data = { ok: false, error: raw }; }
        if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
        localStorage.setItem("afterSave", "1");
        location.reload();
      } catch (err) {
        alert(`執行失敗: ${err?.message || err}`);
      } finally {
        setConfirmLoading(false);
      }
    };

    const open = async (ctx, meta) => {
      if (!modalEl) return;
      state.itemId = ctx.itemId || "";
      state.buttonName = ctx.buttonName || "";
      state.paperNum = ctx.paperNum || "";

      const configUrl = `/api/PaperSearch/Config?itemId=${encodeURIComponent(state.itemId)}&buttonName=${encodeURIComponent(state.buttonName)}`;
      const res = await fetch(configUrl, withJwtHeaders());
      if (!res.ok) {
        alert(await res.text());
        return;
      }
      const cfg = await res.json();
      state.searchParams = cfg.searchParams || cfg.SearchParams || [];

      const caption = meta.dialogCaption || cfg.dialogCaption || cfg.DialogCaption || ctx.caption || "輸入條件";
      if (titleEl) titleEl.textContent = caption;

      await buildForm(state.itemId, state.buttonName);
      if (window.bootstrap) {
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      }
    };

    btnConfirm?.addEventListener("click", (e) => { e.preventDefault(); runSp(); });

    return { open };
  })();

  const wireActionRailButtons = () => {
    document.querySelectorAll('.action-rail [data-custom-btn="1"]').forEach(btn => {
      if (btn.dataset.cbBound === "1") return;
      btn.dataset.cbBound = "1";

      btn.addEventListener('click', async (e) => {
        e.preventDefault(); e.stopPropagation();

        const buttonName = btn.getAttribute('data-button-name') || '';
        if (!buttonName) return;

        const handler = resolveCustomHandler(buttonName);
        const designType = parseInt(btn.dataset.designType || "0", 10);
        const searchTemplate = (btn.dataset.searchTemplate || "").toLowerCase();
        const meta = {
          designType,
          searchTemplate,
          spName: btn.dataset.spName || "",
          execSpName: btn.dataset.execSpName || "",
          multiSelectDd: btn.dataset.multiSelectDd || "",
          replaceExists: btn.dataset.replaceExists || "",
          dialogCaption: btn.dataset.dialogCaption || "",
          allowSelCount: btn.dataset.allowSelCount || ""
        };
        const ctx = {
          buttonName,
          itemId: (window._itemId || '@(Model?.ItemId ?? "")').toString(),
          paperNum: readPaperNum(),
          headerTable: (window._headerTableName || '@(Model?.HeaderTableName ?? "")').toString(),
          dictTableName: (window._dictTableName || '').toString(),
          caption: (btn.textContent || '').trim()
        };

        if (handler) {
          try {
            await handler(ctx);
          } catch (err) {
            console.error("action-rail custom button handler error", err);
            alert(`執行失敗: ${err?.message || err}`);
          }
          return;
        }

        if (searchTemplate === "jsdpapersearchdll.dll") {
          if (designType !== 1) {
            alert("此按鈕 SearchTemplate=JSdPaperSearchDLL.dll，但 DesignType 不是 1，請調整按鈕設定。");
            return;
          }
          try {
            await paperSearch.open(ctx, meta);
          } catch (err) {
            console.error("paper search template error", err);
            alert(`執行失敗: ${err?.message || err}`);
          }
          return;
        }

        if (searchTemplate === "jsdcondrunspdll.dll") {
          if (designType !== 1) {
            alert("此按鈕 SearchTemplate=JSdCondRunSpDLL.dll，但 DesignType 不是 1，請調整按鈕設定。");
            return;
          }
          try {
            await condRunSp.open(ctx, meta);
          } catch (err) {
            console.error("cond-run-sp template error", err);
            alert(`執行失敗: ${err?.message || err}`);
          }
          return;
        }

        // 無自訂 handler → 嘗試依 DB 設定呼叫 SP (DesignType=3)
        try {
          const resp = await fetch('/api/StoredProc/execByButton', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              itemId: ctx.itemId,
              buttonName: ctx.buttonName,
              paperNum: ctx.paperNum
            })
          });
          const raw = await resp.text();
          let data; try { data = JSON.parse(raw); } catch { data = { ok: false, error: raw }; }
          if (resp.ok && data.ok) {
            alert('執行完成');
            location.reload();
            return;
          }
          alert(`執行失敗: ${data.error || `HTTP ${resp.status}`}`);
        } catch (err) {
          console.error("action-rail execByButton error", err);
          alert(`執行失敗: ${err?.message || err}`);
        }
      });
    });
  };

  wireActionRailButtons();
})();
</script>
