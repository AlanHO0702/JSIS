@using System.Text.Json
@model WebRazor.Models.MasterMultiDetailConfig

@{
    var domId = Model.DomId;
    var masterTitle = Model.MasterTitle ?? Model.MasterTable;
    var json = JsonSerializer.Serialize(Model, new JsonSerializerOptions { PropertyNamingPolicy = null });
    var layoutMode = Model.Layout;
}

<link rel="stylesheet" href="~/css/masterMultiDetailTemplate.css" />

<div id="@domId" class="mmd-wrapper mmd-layout-@layoutMode.ToString().ToLower() container-fluid px-2 px-md-4">

  <!-- 工具列（與 MasterDetail 一致） -->
  <div class="top-toolbar md-toolbar-new">
    <div class="toolbar-icon-row" role="group" aria-label="row-nav-and-actions">
      <button id="@domId-btnFirst" type="button" class="btn toolbar-btn toolbar-btn-icon" title="第一筆" aria-label="第一筆"><i class="bi bi-chevron-bar-left toolbar-icon"></i></button>
      <button id="@domId-btnPrev" type="button" class="btn toolbar-btn toolbar-btn-icon" title="上一筆" aria-label="上一筆"><i class="bi bi-chevron-left toolbar-icon"></i></button>
      <button id="@domId-btnNext" type="button" class="btn toolbar-btn toolbar-btn-icon" title="下一筆" aria-label="下一筆"><i class="bi bi-chevron-right toolbar-icon"></i></button>
      <button id="@domId-btnLast" type="button" class="btn toolbar-btn toolbar-btn-icon" title="最後一筆" aria-label="最後一筆"><i class="bi bi-chevron-bar-right toolbar-icon"></i></button>
      <button id="@domId-btnAdd" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add" title="新增" aria-label="新增" disabled><span class="toolbar-icon">+</span></button>
      <button id="@domId-btnDelete" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-del" title="刪除" aria-label="刪除" disabled><span class="toolbar-icon">-</span></button>
      <button id="@domId-btnSave" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add toolbar-btn-check" title="儲存" aria-label="儲存" disabled><span class="toolbar-icon">✓</span></button>
      <button id="@domId-btnCancel" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-cancel toolbar-btn-check" title="取消" aria-label="取消" disabled><span class="toolbar-icon">&times;</span></button>
    </div>
    <div class="toolbar-main">
      <div class="d-flex gap-2 flex-wrap align-items-center">
        <div id="@domId-countBox" class="toolbar-count-box mode-view">
          <div id="@domId-modeLabel" class="count-line">瀏覽模式</div>
          <div id="@domId-countLabel" class="count-line">0 / 0</div>
        </div>
        <button id="@domId-btnQuery" type="button" class="btn toolbar-btn">
          <i class="bi bi-search"></i>查詢
        </button>
        <button id="@domId-btnEdit" type="button" class="btn toolbar-btn">
          <i class="bi bi-pencil-square"></i>修改
        </button>
      </div>
    </div>
    <div class="d-flex gap-2 flex-wrap" id="@domId-custom-slot">@Html.Raw(ViewData["CustomButtonsHtml"]?.ToString() ?? "")</div>
  </div>

  @if (layoutMode == WebRazor.Models.LayoutMode.Tabs)
  {
      <!-- ==================== Tabs 佈局（原始預設佈局） ==================== -->
      <!-- Master 區 -->
      <div class="card shadow-sm border-0 rounded-4 mb-1 mmd-master-card" data-area="master">
        <div class="card-header bg-light fw-bold d-flex align-items-center gap-2">
            <span class="area-indicator" id="@domId-masterIndicator"></span>
            <span>@masterTitle</span>
            <span class="ms-auto" id="@domId-count-master"></span>
        </div>
        <div class="card-body p-0">
          <div id="@domId-masterWrapper" class="table-responsive mmd-master-scroll">
            <table id="@domId-masterGrid"
                   class="table table-sm table-hover align-middle mb-0 mmd-master-table"
                   data-dict-table="@Model.MasterDict"
                   tabindex="0">
              <thead class="table-primary sticky-top">
                <tr id="@domId-m-head"></tr>
              </thead>
              <tbody id="@domId-m-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="@domId-tabs">
          @for (int i = 0; i < Model.Details.Count; i++)
          {
              var d = Model.Details[i];
              var active = (i==0 ? "active" : "");
              <li class="nav-item">
                  <button class="nav-link @active"
                          id="@domId-tab-@i"
                          data-bs-toggle="tab"
                          data-bs-target="#@domId-tabpane-@i">
                    <span class="area-indicator detail-indicator" id="@domId-detailIndicator-@i"></span>
                    @d.DetailTitle
                  </button>
              </li>
          }
      </ul>

      <!-- Tab 內容 -->
      <div class="tab-content" id="@domId-tabContent">
          @for (int i = 0; i < Model.Details.Count; i++)
          {
              var d = Model.Details[i];
              var active = (i==0 ? "show active" : "");
              var dId = $"{domId}-detail-{i}";

              <div class="tab-pane fade @active" id="@domId-tabpane-@i">
                  <div class="card shadow-sm border-0 rounded-4 mmd-detail-card mt-0" data-area="detail">
                    <div class="card-body p-0">
                        <div id="@dId-wrapper" class="mmd-detail-scroll">
                            <table id="@dId-grid"
                                   class="table table-sm table-striped align-middle mb-0 mmd-detail-table"
                                   data-dict-table="@d.DetailDict"
                                   tabindex="0">
                                <thead class="table-secondary sticky-top">
                                    <tr id="@dId-head"></tr>
                                </thead>
                                <tbody id="@dId-body">
                                    <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                  </div>
              </div>
          }
      </div>
  }
  else if (layoutMode == WebRazor.Models.LayoutMode.ThreeColumn)
  {
      <!-- ==================== 三欄式佈局（橫向） ==================== -->
      <div class="mmd-three-column-container">
          <!-- 左側面板：Master + Detail[0] -->
          <div class="mmd-panel mmd-panel-left" data-min-width="200">
              <!-- Master 區域 -->
              <div class="mmd-section mmd-section-master" data-min-height="150">
                  <div class="mmd-section-header">
                      <div class="d-flex align-items-center gap-2">
                          <span class="area-indicator" id="@domId-masterIndicator"></span>
                          <span>@masterTitle</span>
                      </div>
                      <span id="@domId-count-master"></span>
                  </div>
                  <div class="mmd-section-body" id="@domId-masterWrapper">
                      <table id="@domId-masterGrid"
                             class="mmd-grid mmd-master-table"
                             data-dict-table="@Model.MasterDict"
                             tabindex="0">
                          <thead><tr id="@domId-m-head"></tr></thead>
                          <tbody id="@domId-m-body"></tbody>
                      </table>
                  </div>
              </div>

              <!-- 水平分隔器 -->
              <div class="mmd-splitter mmd-splitter-h" data-target="master"></div>

              @if (Model.Details.Count > 0)
              {
                  var d0 = Model.Details[0];
                  var d0Id = $"{domId}-detail-0";
                  <!-- Detail[0] 區域 -->
                  <div class="mmd-section mmd-section-detail0" data-min-height="100">
                      <div class="mmd-section-header">
                          <div class="d-flex align-items-center gap-2">
                              <span class="area-indicator detail-indicator" id="@domId-detailIndicator-0"></span>
                              <span>@d0.DetailTitle</span>
                          </div>
                          <span id="@domId-count-detail-0"></span>
                      </div>
                      <div class="mmd-section-body" id="@d0Id-wrapper">
                          <table id="@d0Id-grid"
                                 class="mmd-grid mmd-detail-table"
                                 data-dict-table="@d0.DetailDict"
                                 tabindex="0">
                              <thead><tr id="@d0Id-head"></tr></thead>
                              <tbody id="@d0Id-body">
                                  <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              }
          </div>

          <!-- 垂直分隔器 -->
          <div class="mmd-splitter mmd-splitter-v"></div>

          @if (Model.Details.Count > 1)
          {
              var d1 = Model.Details[1];
              var d1Id = $"{domId}-detail-1";
              <!-- 中間面板：Detail[1] -->
              <div class="mmd-panel mmd-panel-mid" data-min-width="200">
                  <div class="mmd-section">
                      <div class="mmd-section-header">
                          <div class="d-flex align-items-center gap-2">
                              <span class="area-indicator detail-indicator" id="@domId-detailIndicator-1"></span>
                              <span>@d1.DetailTitle</span>
                          </div>
                          <span id="@domId-count-detail-1"></span>
                      </div>
                      <div class="mmd-section-body" id="@d1Id-wrapper">
                          <table id="@d1Id-grid"
                                 class="mmd-grid mmd-detail-table"
                                 data-dict-table="@d1.DetailDict"
                                 tabindex="0">
                              <thead><tr id="@d1Id-head"></tr></thead>
                              <tbody id="@d1Id-body">
                                  <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>

              <!-- 垂直分隔器 -->
              <div class="mmd-splitter mmd-splitter-v"></div>
          }

          @if (Model.Details.Count > 2)
          {
              var d2 = Model.Details[2];
              var d2Id = $"{domId}-detail-2";
              <!-- 右側面板：Detail[2] -->
              <div class="mmd-panel mmd-panel-right" data-min-width="200">
                  <div class="mmd-section">
                      <div class="mmd-section-header">
                          <div class="d-flex align-items-center gap-2">
                              <span class="area-indicator detail-indicator" id="@domId-detailIndicator-2"></span>
                              <span>@d2.DetailTitle</span>
                          </div>
                          <span id="@domId-count-detail-2"></span>
                      </div>
                      <div class="mmd-section-body" id="@d2Id-wrapper">
                          <table id="@d2Id-grid"
                                 class="mmd-grid mmd-detail-table"
                                 data-dict-table="@d2.DetailDict"
                                 tabindex="0">
                              <thead><tr id="@d2Id-head"></tr></thead>
                              <tbody id="@d2Id-body">
                                  <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          }
      </div>
  }
  else if (layoutMode == WebRazor.Models.LayoutMode.VerticalStack)
  {
      <!-- ==================== 垂直堆疊佈局 ==================== -->
      <div class="mmd-vertical-stack-container">
          <!-- Master 區域 -->
          <div class="mmd-panel mmd-panel-stack-master" data-min-height="120">
              <div class="mmd-section-header">
                  <div class="d-flex align-items-center gap-2">
                      <span class="area-indicator" id="@domId-masterIndicator"></span>
                      <span>@masterTitle</span>
                  </div>
                  <span id="@domId-count-master"></span>
              </div>
              <div class="mmd-section-body" id="@domId-masterWrapper">
                  <table id="@domId-masterGrid"
                         class="mmd-grid mmd-master-table"
                         data-dict-table="@Model.MasterDict"
                         tabindex="0">
                      <thead><tr id="@domId-m-head"></tr></thead>
                      <tbody id="@domId-m-body"></tbody>
                  </table>
              </div>
          </div>

          <!-- 水平分隔器 -->
          <div class="mmd-splitter mmd-splitter-h" data-target="stack-master"></div>

          @if (Model.Details.Count > 0)
          {
              var d0 = Model.Details[0];
              var d0Id = $"{domId}-detail-0";
              <!-- Detail 區域 -->
              <div class="mmd-panel mmd-panel-stack-detail" data-min-height="150">
                  <div class="mmd-section-header">
                      <div class="d-flex align-items-center gap-2">
                          <span class="area-indicator detail-indicator" id="@domId-detailIndicator-0"></span>
                          <span>@d0.DetailTitle</span>
                      </div>
                      <span id="@domId-count-detail-0"></span>
                  </div>
                  <div class="mmd-section-body" id="@d0Id-wrapper">
                      <table id="@d0Id-grid"
                             class="mmd-grid mmd-detail-table"
                             data-dict-table="@d0.DetailDict"
                             tabindex="0">
                          <thead><tr id="@d0Id-head"></tr></thead>
                          <tbody id="@d0Id-body">
                              <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                          </tbody>
                      </table>
                  </div>
              </div>

              <!-- 水平分隔器 -->
              <div class="mmd-splitter mmd-splitter-h" data-target="stack-detail"></div>
          }

          @if (Model.Details.Count > 1)
          {
              var d1 = Model.Details[1];
              var d1Id = $"{domId}-detail-1";
              <!-- SubDetail 區域 -->
              <div class="mmd-panel mmd-panel-stack-subdetail" data-min-height="100">
                  <div class="mmd-section-header">
                      <div class="d-flex align-items-center gap-2">
                          <span class="area-indicator detail-indicator" id="@domId-detailIndicator-1"></span>
                          <span>@d1.DetailTitle</span>
                      </div>
                      <span id="@domId-count-detail-1"></span>
                  </div>
                  <div class="mmd-section-body" id="@d1Id-wrapper">
                      <table id="@d1Id-grid"
                             class="mmd-grid mmd-detail-table"
                             data-dict-table="@d1.DetailDict"
                             tabindex="0">
                          <thead><tr id="@d1Id-head"></tr></thead>
                          <tbody id="@d1Id-body">
                              <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                          </tbody>
                      </table>
                  </div>
              </div>

              <!-- 水平分隔器（底部拖曳器） -->
              <div class="mmd-splitter mmd-splitter-h" data-target="stack-subdetail"></div>
          }

          <!-- 底部填充區域 -->
          <div class="mmd-panel-filler"></div>
      </div>
  }
  else if (layoutMode == WebRazor.Models.LayoutMode.BalanceSheet)
  {
      <!-- ==================== 資產負債表佈局（三層級聯動：Master → Detail → SubDetail） ==================== -->
      <!--
          資料流結構：
          1. Master (頂部) → Detail[0] (左側區域)
          2. Detail[0] (左側) → Detail[1]... (右側所有頁籤)

          類似垂直堆疊的三層級聯動，但使用橫向分割的視覺佈局
       -->
      <div class="mmd-balancesheet-container">
          <!-- 頂部區域：Master + 工具列 -->
          <div class="mmd-panel mmd-panel-top-selector" style="height: @(Model.MasterHeight)px;" data-min-height="80">
              <div class="d-flex h-100">
                  <!-- 左側：Master Grid (75% 寬度，3:1 比例) -->
                  <div class="mmd-top-selector-grid" style="flex: 3; min-width: 0;">
                      <div class="mmd-section-header">
                          <div class="d-flex align-items-center gap-2">
                              <span class="area-indicator" id="@domId-masterIndicator"></span>
                              <span>@masterTitle</span>
                          </div>
                          <span id="@domId-count-master"></span>
                      </div>
                      <div class="mmd-section-body" id="@domId-masterWrapper">
                          <table id="@domId-masterGrid"
                                 class="mmd-grid mmd-master-table"
                                 data-dict-table="@Model.MasterDict"
                                 tabindex="0">
                              <thead><tr id="@domId-m-head"></tr></thead>
                              <tbody id="@domId-m-body"></tbody>
                          </table>
                      </div>
                  </div>

                  <!-- 右側：工具列（可選，25% 寬度，3:1 比例） -->
                  @if (Model.EnableTopToolbar)
                  {
                      <div class="mmd-top-toolbar border-start" style="flex: 1; min-width: 0;">
                          <div class="mmd-section-header">
                              <span>項目新增</span>
                          </div>
                          <div class="mmd-section-body p-3">
                              <div class="row g-2">
                                  <div class="col-auto">
                                      <label class="form-label mb-1">編碼</label>
                                      <input type="text" id="@domId-newItemCode" class="form-control form-control-sm" style="width: 80px;" />
                                  </div>
                                  <div class="col">
                                      <label class="form-label mb-1">項目名稱</label>
                                      <input type="text" id="@domId-newItemName" class="form-control form-control-sm" />
                                  </div>
                                  <div class="col-auto d-flex align-items-end">
                                      <button type="button" id="@domId-btnAddItem" class="btn btn-primary btn-sm">加入</button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  }
              </div>
          </div>

          <!-- 水平分隔器 -->
          <div class="mmd-splitter mmd-splitter-h" data-target="top-selector"></div>

          <!-- 主要區域：Detail[0] + Detail[1]... -->
          <div class="mmd-panel mmd-panel-main-area d-flex" style="flex: 1; overflow: hidden;">
              @if (Model.Details.Count > 0)
              {
                  var d0 = Model.Details[0];
                  var d0Id = $"{domId}-detail-0";
                  <!-- 左側：Detail[0] Grid -->
                  <div class="mmd-panel mmd-panel-master" style="width: 300px;" data-min-width="200">
                      <div class="mmd-section-header">
                          <div class="d-flex align-items-center gap-2">
                              <span class="area-indicator detail-indicator" id="@domId-detailIndicator-0"></span>
                              <span>@d0.DetailTitle</span>
                          </div>
                          <span id="@domId-count-detail-0"></span>
                      </div>
                      <div class="mmd-section-body" id="@d0Id-wrapper">
                          <table id="@d0Id-grid"
                                 class="mmd-grid mmd-detail-table"
                                 data-dict-table="@d0.DetailDict"
                                 tabindex="0">
                              <thead><tr id="@d0Id-head"></tr></thead>
                              <tbody id="@d0Id-body">
                                  <tr><td class="text-center text-muted p-3">請點選上方一筆分組資料</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>

                  <!-- 垂直分隔器 -->
                  <div class="mmd-splitter mmd-splitter-v" data-target="master"></div>
              }

              @if (Model.Details.Count > 1)
              {
                  <!-- 右側：Detail[1]... Tabs -->
                  <div class="mmd-panel mmd-panel-detail flex-fill">
                      <!-- 頁籤導航 -->
                      <ul class="nav nav-tabs mmd-detail-tabs" id="@domId-detail-tabs">
                          @for (int i = 1; i < Model.Details.Count; i++)
                          {
                              var d = Model.Details[i];
                              var dId = $"{domId}-detail-{i}";
                              var active = (i == 1 ? "active" : "");
                              <li class="nav-item">
                                  <button class="nav-link @active"
                                          id="@domId-detail-tab-@i"
                                          data-bs-toggle="tab"
                                          data-bs-target="#@domId-detail-tabpane-@i"
                                          type="button">
                                      @d.DetailTitle
                                      <span id="@domId-count-detail-@i" class="ms-2"></span>
                                  </button>
                              </li>
                          }
                      </ul>

                      <!-- 頁籤內容 -->
                      <div class="tab-content mmd-detail-tab-content" id="@domId-detail-tabContent">
                          @for (int i = 1; i < Model.Details.Count; i++)
                          {
                              var d = Model.Details[i];
                              var dId = $"{domId}-detail-{i}";
                              var active = (i == 1 ? "show active" : "");

                              <div class="tab-pane fade @active" id="@domId-detail-tabpane-@i">
                                  <div class="mmd-section-body mmd-tabpane-body" id="@dId-wrapper">
                                      <table id="@dId-grid"
                                             class="mmd-grid mmd-detail-table"
                                             data-dict-table="@d.DetailDict"
                                             tabindex="0">
                                          <thead><tr id="@dId-head"></tr></thead>
                                          <tbody id="@dId-body">
                                              <tr><td class="text-center text-muted p-3">請點選左方一筆資料</td></tr>
                                          </tbody>
                                      </table>
                                  </div>
                              </div>
                          }
                      </div>
                  </div>
              }
          </div>
      </div>
  }

</div>

<!-- Query Modal -->
<div class="modal fade" id="@domId-queryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-search me-2"></i>查詢條件</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="@domId-queryForm" class="row g-3"></form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="@domId-btnClearQuery">清除</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="@domId-btnQuerySubmit">確定</button>
      </div>
    </div>
  </div>
</div>

<script>
window._mmdConfigs = window._mmdConfigs || {};
window._mmdConfigs["@domId"] = @Html.Raw(json);
</script>

<script src="/js/editableGrid.js"></script>
<script src="/js/masterMultiDetailTemplate.js"></script>
<script src="~/js/gridToolbarTemplate.js"></script>
