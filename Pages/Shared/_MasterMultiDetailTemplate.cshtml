@using System.Text.Json
@model WebRazor.Models.MasterMultiDetailConfig

@{
    var domId = Model.DomId;
    var masterTitle = Model.MasterTitle ?? Model.MasterTable;
    var json = JsonSerializer.Serialize(Model, new JsonSerializerOptions { PropertyNamingPolicy = null });
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>

<div id="@domId" class="mmd-wrapper container-fluid px-2 px-md-4">

  <!-- 功能列 -->
  <div class="d-flex align-items-center justify-content-between my-3">
      <div class="btn-toolbar gap-2">
        <button id="@domId-btnEdit" class="btn btn-warning shadow-sm px-4">修改</button>
        <button id="@domId-btnSave" class="btn btn-success shadow-sm px-4 d-none">儲存</button>
      </div>
  </div>

  <!-- Master 區 -->
  <div class="card shadow-sm border-0 rounded-4 mb-2 mmd-master-card">
    <div class="card-header bg-light fw-bold">@masterTitle</div>
    <div class="card-body p-0">
      <div id="@domId-masterWrapper" class="table-responsive mmd-master-scroll">
        <table id="@domId-masterGrid"
               class="table table-sm table-hover align-middle mb-0 mmd-master-table"
               data-dict-table="@Model.MasterDict"
               tabindex="0">
          <thead class="table-primary sticky-top">
            <tr id="@domId-m-head"></tr>
          </thead>
          <tbody id="@domId-m-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="@domId-tabs">
      @for (int i = 0; i < Model.Details.Count; i++)
      {
          var d = Model.Details[i];
          var active = (i==0 ? "active" : "");
          <li class="nav-item">
              <button class="nav-link @active"
                      id="@domId-tab-@i"
                      data-bs-toggle="tab"
                      data-bs-target="#@domId-tabpane-@i">
                @d.DetailTitle
              </button>
          </li>
      }
  </ul>

  <!-- Tab 內容 -->
  <div class="tab-content" id="@domId-tabContent">
      @for (int i = 0; i < Model.Details.Count; i++)
      {
          var d = Model.Details[i];
          var active = (i==0 ? "show active" : "");
          var dId = $"{domId}-detail-{i}";

          <div class="tab-pane fade @active" id="@domId-tabpane-@i">
              <div class="card shadow-sm border-0 rounded-4 mmd-detail-card mt-2">
                <div class="card-header bg-light fw-bold">@d.DetailTitle</div>
                <div class="card-body p-0">
                    <div id="@dId-wrapper" class="mmd-detail-scroll">
                        <table id="@dId-grid"
                               class="table table-sm table-striped align-middle mb-0 mmd-detail-table"
                               data-dict-table="@d.DetailDict"
                               tabindex="0">
                            <thead class="table-secondary sticky-top">
                                <tr id="@dId-head"></tr>
                            </thead>
                            <tbody id="@dId-body">
                                <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
              </div>
          </div>
      }
  </div>
</div>

<script>
window._mmdConfigs = window._mmdConfigs || {};
window._mmdConfigs["@domId"] = @Html.Raw(json);
</script>

<script src="/js/editableGrid.js"></script>
<script src="/js/masterMultiDetailTemplate.js"></script>

<style>
/* ========================================================= */
/* 1. 基礎表格樣式 (ERP 風格)                                */
/* ========================================================= */
.mmd-wrapper table {
    table-layout: fixed;
}

.mmd-wrapper table th,
.mmd-wrapper table td {
    padding: 3px 4px !important;
    font-size: 13px !important;
    border-right: 1px solid #e0e0e0 !important;
    border-bottom: 1px solid #e0e0e0 !important;
}

.mmd-wrapper table th {
    background: #f5f7fa !important;
    font-weight: bold;
    border-left: 1px solid #e0e0e0 !important;
}

.mmd-wrapper table td:first-child {
    border-left: 1px solid #e0e0e0 !important;
}

/* ========================================================= */
/* 2. 儲存格顯示與編輯                                       */
/* ========================================================= */
.cell-view {
    display: block;
    width: 100%;
    padding: 3px 4px !important;
    font-size: 13px !important;
    background: transparent !important;
    border: none !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.cell-edit {
    width: 100%;
    height: 28px !important;
    padding: 2px 4px !important;
    font-size: 13px !important;
    border-radius: 3px !important;
    box-sizing: border-box;
}

.mmd-editing .mmd-readonly-cell { background: #eeeeee !important; }
.mmd-editing .mmd-readonly-cell .cell-edit { background: #eeeeee !important; cursor: not-allowed; }
.mmd-editing .mmd-readonly-cell .cell-view { background: #eeeeee !important; color: #555 !important; }

.nav-tabs .nav-link { font-size: 13px !important; padding: 6px 12px !important; color: #495057; }
.nav-tabs .nav-link.active { font-weight: bold; color: #000; }

/* ========================================================= */
/* 3. 版面佈局 (修正：解決頁籤堆疊造成的空白)                  */
/* ========================================================= */

/* 最外層 */
#@domId, .mmd-wrapper {
    display: block !important;
    height: auto !important;
    min-height: 0 !important;
    overflow: visible !important;
    padding-bottom: 50px; 
}

/* Master 卡片：下方留白推開 Tabs */
.mmd-master-card {
    margin-bottom: 20px !important;
    flex: none !important;
}

/* Master 表格捲軸 */
.mmd-master-scroll {
    max-height: 300px; 
    overflow-y: auto;
    border-bottom: 1px solid #dee2e6;
}

/* Tabs 容器 */
#@domId-tabs {
    display: flex !important;
    flex-wrap: wrap !important;
    margin-bottom: 0 !important;
    border-bottom: 1px solid #dee2e6;
}

/* Tab 內容容器 & 卡片本體 */
#@domId-tabContent, 
#@domId-tabContent .card-body {
    height: auto !important;
    flex: none !important;
    display: block !important;
}

/* ⭐⭐⭐ 關鍵修正：這裡不能強制 display: block，否則隱藏的頁籤會佔位 ⭐⭐⭐ */
#@domId-tabContent .tab-pane {
    height: auto !important;
    flex: none !important;
    /* 移除了 display: block !important; 讓 Bootstrap 控制顯示/隱藏 */
}

/* 明細卡片：去除頂部邊框與間距，與 Tabs 接合 */
.mmd-detail-card {
    margin-top: 0 !important; 
    border-top-left-radius: 0 !important;
    border-top-right-radius: 0 !important;
    border-top: none !important; 
    flex: none !important;
}

/* 明細表格捲軸 */
.mmd-detail-scroll {
    max-height: 500px;
    overflow-y: auto !important;
    overflow-x: hidden;
    min-height: 50px;
}

/* ========================================================= */
/* 4. 選中行的樣式 (Master 和 Detail 共用)                    */
/* ========================================================= */
.mmd-master-table tbody tr.selected,
.mmd-detail-table tbody tr.selected {
    background-color: #d1ecf1 !important;
    font-weight: 500;
}

.mmd-master-table tbody tr.selected td,
.mmd-detail-table tbody tr.selected td {
    background-color: #d1ecf1 !important;
    border-color: #bee5eb !important;
}
</style>

