@using System.Text.Json
@model WebRazor.Models.MasterMultiDetailConfig

@{
    var domId = Model.DomId;
    var masterTitle = Model.MasterTitle ?? Model.MasterTable;
    var json = JsonSerializer.Serialize(Model, new JsonSerializerOptions { PropertyNamingPolicy = null });
    var layoutMode = Model.Layout;
}

<link rel="stylesheet" href="~/css/grid-toolbar.css" />

<div id="@domId" class="mmd-wrapper mmd-layout-@layoutMode.ToString().ToLower() container-fluid px-2 px-md-4">

  <!-- 功能列 -->
  <div class="d-flex align-items-center justify-content-between my-3">
      <partial name="~/Pages/Shared/_GridToolbar.cshtml" model='@(new PcbErpApi.Models.GridToolbarConfig { Prefix = domId + "-", ShowCancel = true })' />
  </div>

  @if (layoutMode == WebRazor.Models.LayoutMode.Tabs)
  {
      <!-- ==================== Tabs 佈局（原始預設佈局） ==================== -->
      <!-- Master 區 -->
      <div class="card shadow-sm border-0 rounded-4 mb-2 mmd-master-card">
        <div class="card-header bg-light fw-bold">@masterTitle</div>
        <div class="card-body p-0">
          <div id="@domId-masterWrapper" class="table-responsive mmd-master-scroll">
            <table id="@domId-masterGrid"
                   class="table table-sm table-hover align-middle mb-0 mmd-master-table"
                   data-dict-table="@Model.MasterDict"
                   tabindex="0">
              <thead class="table-primary sticky-top">
                <tr id="@domId-m-head"></tr>
              </thead>
              <tbody id="@domId-m-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="@domId-tabs">
          @for (int i = 0; i < Model.Details.Count; i++)
          {
              var d = Model.Details[i];
              var active = (i==0 ? "active" : "");
              <li class="nav-item">
                  <button class="nav-link @active"
                          id="@domId-tab-@i"
                          data-bs-toggle="tab"
                          data-bs-target="#@domId-tabpane-@i">
                    @d.DetailTitle
                  </button>
              </li>
          }
      </ul>

      <!-- Tab 內容 -->
      <div class="tab-content" id="@domId-tabContent">
          @for (int i = 0; i < Model.Details.Count; i++)
          {
              var d = Model.Details[i];
              var active = (i==0 ? "show active" : "");
              var dId = $"{domId}-detail-{i}";

              <div class="tab-pane fade @active" id="@domId-tabpane-@i">
                  <div class="card shadow-sm border-0 rounded-4 mmd-detail-card mt-2">
                    <div class="card-header bg-light fw-bold">@d.DetailTitle</div>
                    <div class="card-body p-0">
                        <div id="@dId-wrapper" class="mmd-detail-scroll">
                            <table id="@dId-grid"
                                   class="table table-sm table-striped align-middle mb-0 mmd-detail-table"
                                   data-dict-table="@d.DetailDict"
                                   tabindex="0">
                                <thead class="table-secondary sticky-top">
                                    <tr id="@dId-head"></tr>
                                </thead>
                                <tbody id="@dId-body">
                                    <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                  </div>
              </div>
          }
      </div>
  }
  else if (layoutMode == WebRazor.Models.LayoutMode.ThreeColumn)
  {
      <!-- ==================== 三欄式佈局（橫向） ==================== -->
      <div class="mmd-three-column-container">
          <!-- 左側面板：Master + Detail[0] -->
          <div class="mmd-panel mmd-panel-left">
              <!-- Master 區域 -->
              <div class="mmd-section mmd-section-master">
                  <div class="mmd-section-header">
                      <span>@masterTitle</span>
                      <span id="@domId-count-master">0 / 0</span>
                  </div>
                  <div class="mmd-section-body" id="@domId-masterWrapper">
                      <table id="@domId-masterGrid"
                             class="mmd-grid mmd-master-table"
                             data-dict-table="@Model.MasterDict"
                             tabindex="0">
                          <thead><tr id="@domId-m-head"></tr></thead>
                          <tbody id="@domId-m-body"></tbody>
                      </table>
                  </div>
              </div>

              <!-- 水平分隔器 -->
              <div class="mmd-splitter mmd-splitter-h" data-target="master"></div>

              @if (Model.Details.Count > 0)
              {
                  var d0 = Model.Details[0];
                  var d0Id = $"{domId}-detail-0";
                  <!-- Detail[0] 區域 -->
                  <div class="mmd-section mmd-section-detail0">
                      <div class="mmd-section-header">
                          <span>@d0.DetailTitle</span>
                          <span id="@domId-count-detail-0">0 / 0</span>
                      </div>
                      <div class="mmd-section-body" id="@d0Id-wrapper">
                          <table id="@d0Id-grid"
                                 class="mmd-grid mmd-detail-table"
                                 data-dict-table="@d0.DetailDict"
                                 tabindex="0">
                              <thead><tr id="@d0Id-head"></tr></thead>
                              <tbody id="@d0Id-body">
                                  <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              }
          </div>

          <!-- 垂直分隔器 -->
          <div class="mmd-splitter mmd-splitter-v"></div>

          @if (Model.Details.Count > 1)
          {
              var d1 = Model.Details[1];
              var d1Id = $"{domId}-detail-1";
              <!-- 中間面板：Detail[1] -->
              <div class="mmd-panel mmd-panel-mid">
                  <div class="mmd-section">
                      <div class="mmd-section-header">
                          <span>@d1.DetailTitle</span>
                          <span id="@domId-count-detail-1">0 / 0</span>
                      </div>
                      <div class="mmd-section-body" id="@d1Id-wrapper">
                          <table id="@d1Id-grid"
                                 class="mmd-grid mmd-detail-table"
                                 data-dict-table="@d1.DetailDict"
                                 tabindex="0">
                              <thead><tr id="@d1Id-head"></tr></thead>
                              <tbody id="@d1Id-body">
                                  <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>

              <!-- 垂直分隔器 -->
              <div class="mmd-splitter mmd-splitter-v"></div>
          }

          @if (Model.Details.Count > 2)
          {
              var d2 = Model.Details[2];
              var d2Id = $"{domId}-detail-2";
              <!-- 右側面板：Detail[2] -->
              <div class="mmd-panel mmd-panel-right">
                  <div class="mmd-section">
                      <div class="mmd-section-header">
                          <span>@d2.DetailTitle</span>
                          <span id="@domId-count-detail-2">0 / 0</span>
                      </div>
                      <div class="mmd-section-body" id="@d2Id-wrapper">
                          <table id="@d2Id-grid"
                                 class="mmd-grid mmd-detail-table"
                                 data-dict-table="@d2.DetailDict"
                                 tabindex="0">
                              <thead><tr id="@d2Id-head"></tr></thead>
                              <tbody id="@d2Id-body">
                                  <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          }
      </div>
  }
  else if (layoutMode == WebRazor.Models.LayoutMode.VerticalStack)
  {
      <!-- ==================== 垂直堆疊佈局 ==================== -->
      <div class="mmd-vertical-stack-container">
          <!-- Master 區域 -->
          <div class="mmd-panel mmd-panel-stack-master">
              <div class="mmd-section-header">
                  <span>@masterTitle</span>
                  <span id="@domId-count-master">0 / 0</span>
              </div>
              <div class="mmd-section-body" id="@domId-masterWrapper">
                  <table id="@domId-masterGrid"
                         class="mmd-grid mmd-master-table"
                         data-dict-table="@Model.MasterDict"
                         tabindex="0">
                      <thead><tr id="@domId-m-head"></tr></thead>
                      <tbody id="@domId-m-body"></tbody>
                  </table>
              </div>
          </div>

          <!-- 水平分隔器 -->
          <div class="mmd-splitter mmd-splitter-h" data-target="stack-master"></div>

          @if (Model.Details.Count > 0)
          {
              var d0 = Model.Details[0];
              var d0Id = $"{domId}-detail-0";
              <!-- Detail[0] 區域 -->
              <div class="mmd-panel mmd-panel-stack-detail">
                  <div class="mmd-section-header">
                      <span>@d0.DetailTitle</span>
                      <span id="@domId-count-detail-0">0 / 0</span>
                  </div>
                  <div class="mmd-section-body" id="@d0Id-wrapper">
                      <table id="@d0Id-grid"
                             class="mmd-grid mmd-detail-table"
                             data-dict-table="@d0.DetailDict"
                             tabindex="0">
                          <thead><tr id="@d0Id-head"></tr></thead>
                          <tbody id="@d0Id-body">
                              <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                          </tbody>
                      </table>
                  </div>
              </div>

              <!-- 水平分隔器 -->
              <div class="mmd-splitter mmd-splitter-h" data-target="stack-detail"></div>
          }

          @if (Model.Details.Count > 1)
          {
              var d1 = Model.Details[1];
              var d1Id = $"{domId}-detail-1";
              <!-- Detail[1] 區域 -->
              <div class="mmd-panel mmd-panel-stack-subdetail">
                  <div class="mmd-section-header">
                      <span>@d1.DetailTitle</span>
                      <span id="@domId-count-detail-1">0 / 0</span>
                  </div>
                  <div class="mmd-section-body" id="@d1Id-wrapper">
                      <table id="@d1Id-grid"
                             class="mmd-grid mmd-detail-table"
                             data-dict-table="@d1.DetailDict"
                             tabindex="0">
                          <thead><tr id="@d1Id-head"></tr></thead>
                          <tbody id="@d1Id-body">
                              <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                          </tbody>
                      </table>
                  </div>
              </div>

              <!-- 水平分隔器（底部拖曳器） -->
              <div class="mmd-splitter mmd-splitter-h" data-target="stack-subdetail"></div>
          }

          <!-- 底部填充區域 -->
          <div class="mmd-panel-filler"></div>
      </div>
  }

</div>

<script>
window._mmdConfigs = window._mmdConfigs || {};
window._mmdConfigs["@domId"] = @Html.Raw(json);
</script>

<script src="/js/editableGrid.js"></script>
<script src="/js/masterMultiDetailTemplate.js"></script>
<script src="~/js/gridToolbarTemplate.js"></script>

<style>
/* ========================================================= */
/* 1. 基礎表格樣式 (ERP 風格) - 所有佈局共用                   */
/* ========================================================= */
.mmd-wrapper table {
    table-layout: fixed;
}

.mmd-wrapper table th,
.mmd-wrapper table td {
    padding: 3px 4px !important;
    font-size: 13px !important;
    border-right: 1px solid #e0e0e0 !important;
    border-bottom: 1px solid #e0e0e0 !important;
}

.mmd-wrapper table th {
    background: #f5f7fa !important;
    font-weight: bold;
    border-left: 1px solid #e0e0e0 !important;
}

.mmd-wrapper table td:first-child {
    border-left: 1px solid #e0e0e0 !important;
}

/* ========================================================= */
/* 2. 儲存格顯示與編輯 - 所有佈局共用                          */
/* ========================================================= */
.cell-view {
    display: block;
    width: 100%;
    padding: 3px 4px !important;
    font-size: 13px !important;
    background: transparent !important;
    border: none !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.cell-edit {
    width: 100%;
    height: 28px !important;
    padding: 2px 4px !important;
    font-size: 13px !important;
    border-radius: 3px !important;
    box-sizing: border-box;
}

.mmd-editing .mmd-readonly-cell { background: #eeeeee !important; }
.mmd-editing .mmd-readonly-cell .cell-edit { background: #eeeeee !important; cursor: not-allowed; }
.mmd-editing .mmd-readonly-cell .cell-view { background: #eeeeee !important; color: #555 !important; }

.nav-tabs .nav-link { font-size: 13px !important; padding: 6px 12px !important; color: #495057; }
.nav-tabs .nav-link.active { font-weight: bold; color: #000; }

/* ========================================================= */
/* 3. Tabs 佈局樣式（預設佈局）                               */
/* ========================================================= */
.mmd-layout-tabs {
    display: block !important;
    height: auto !important;
    min-height: 0 !important;
    overflow: visible !important;
    padding-bottom: 50px;
}

.mmd-layout-tabs .mmd-master-card {
    margin-bottom: 20px !important;
    flex: none !important;
}

.mmd-layout-tabs .mmd-master-scroll {
    max-height: 300px;
    overflow-y: auto;
    border-bottom: 1px solid #dee2e6;
}

.mmd-layout-tabs #@domId-tabs {
    display: flex !important;
    flex-wrap: wrap !important;
    margin-bottom: 0 !important;
    border-bottom: 1px solid #dee2e6;
}

.mmd-layout-tabs #@domId-tabContent,
.mmd-layout-tabs #@domId-tabContent .card-body {
    height: auto !important;
    flex: none !important;
    display: block !important;
}

.mmd-layout-tabs #@domId-tabContent .tab-pane {
    height: auto !important;
    flex: none !important;
}

.mmd-layout-tabs .mmd-detail-card {
    margin-top: 0 !important;
    border-top-left-radius: 0 !important;
    border-top-right-radius: 0 !important;
    border-top: none !important;
    flex: none !important;
}

.mmd-layout-tabs .mmd-detail-scroll {
    max-height: 500px;
    overflow-y: auto !important;
    overflow-x: auto;
    min-height: 50px;
}

/* 讓欄位很多時可水平卷軸瀏覽 */
.mmd-detail-table,
.mmd-master-table {
    width: max-content;
    min-width: 100%;
}

/* ========================================================= */
/* 4. 三欄式佈局樣式                                          */
/* ========================================================= */
.mmd-layout-threecolumn {
    min-height: 100vh;
    height: 100vh;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    padding: 0.5rem 0;
}

.mmd-layout-threecolumn > .d-flex {
    flex-shrink: 0;
}

.mmd-three-column-container {
    display: flex;
    flex-direction: row;
    flex: 1;
    min-height: 0;
    gap: 0;
    border: 1px solid #ccc;
    background: #f5f5f5;
    overflow: hidden;
}

.mmd-three-column-container .mmd-panel {
    display: flex;
    flex-direction: column;
    background: #fff;
    overflow: hidden;
}

.mmd-three-column-container .mmd-panel-left {
    width: 280px;
    min-width: 200px;
    flex-shrink: 0;
}

.mmd-three-column-container .mmd-panel-mid {
    width: 400px;
    min-width: 300px;
    flex-shrink: 0;
}

.mmd-three-column-container .mmd-panel-right {
    flex: 1;
    min-width: 280px;
}

.mmd-three-column-container .mmd-section {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%;
}

.mmd-three-column-container .mmd-section-master {
    height: 250px;
    min-height: 150px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
}

.mmd-three-column-container .mmd-section-detail0 {
    flex: 1;
    min-height: 100px;
    display: flex;
    flex-direction: column;
}

/* ========================================================= */
/* 5. 垂直堆疊佈局樣式                                        */
/* ========================================================= */
.mmd-layout-verticalstack {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: auto;
    box-sizing: border-box;
    padding: 0.5rem 0;
}

.mmd-layout-verticalstack > .d-flex {
    flex-shrink: 0;
}

.mmd-vertical-stack-container {
    display: flex;
    flex-direction: column;
    min-height: calc(100vh - 5rem);
    overflow: visible;
    border: 1px solid #ccc;
    background: #f5f5f5;
}

.mmd-vertical-stack-container .mmd-panel {
    display: flex;
    flex-direction: column;
    background: #fff;
    overflow: hidden;
}

.mmd-vertical-stack-container .mmd-panel-stack-master {
    height: 120px;
    min-height: 80px;
    flex-shrink: 0;
}

.mmd-vertical-stack-container .mmd-panel-stack-detail {
    height: 150px;
    min-height: 100px;
    flex-shrink: 0;
}

.mmd-vertical-stack-container .mmd-panel-stack-subdetail {
    flex: 1;
    min-height: 100px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.mmd-vertical-stack-container .mmd-panel-filler {
    flex: 0;
    min-height: 0;
    background: #f5f5f5;
}

/* ========================================================= */
/* 6. 共用區段樣式                                            */
/* ========================================================= */
.mmd-section-header {
    background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
    border-bottom: 1px solid #ccc;
    padding: 4px 8px;
    font-weight: bold;
    font-size: 13px;
    color: #333;
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.mmd-section-body {
    flex: 1;
    overflow: auto;
    background: #fff;
}

/* ========================================================= */
/* 7. 分隔器樣式                                              */
/* ========================================================= */
.mmd-splitter-v {
    width: 5px;
    background: #d0d0d0;
    cursor: col-resize;
    flex-shrink: 0;
}

.mmd-splitter-v:hover {
    background: #4a90e2;
}

.mmd-splitter-h {
    height: 5px;
    background: #d0d0d0;
    cursor: row-resize;
    flex-shrink: 0;
}

.mmd-splitter-h:hover {
    background: #4a90e2;
}

/* ========================================================= */
/* 8. 表格樣式（三欄式和垂直堆疊專用）                         */
/* ========================================================= */
.mmd-grid {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    font-size: 13px;
}

.mmd-grid thead {
    position: sticky;
    top: 0;
    z-index: 10;
}

.mmd-grid th {
    background: linear-gradient(to bottom, #f8f8f8, #e8e8e8) !important;
    border: 1px solid #ccc !important;
    padding: 4px 6px !important;
    font-weight: bold;
    text-align: left;
    white-space: nowrap;
}

.mmd-grid td {
    border: 1px solid #e0e0e0 !important;
    padding: 3px 6px !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.mmd-grid tbody tr {
    background: #fff;
}

.mmd-grid tbody tr:nth-child(even) {
    background: #f9f9f9;
}

.mmd-grid tbody tr:hover {
    background: #e8f4fd !important;
    cursor: pointer;
}

/* Master 表格特殊樣式（不壓縮欄位）*/
.mmd-layout-threecolumn .mmd-master-table {
    table-layout: auto;
    width: max-content;
    min-width: 100%;
}

.mmd-layout-verticalstack .mmd-master-table {
    table-layout: auto !important;
}

.mmd-layout-verticalstack .mmd-detail-table {
    table-layout: auto !important;
}

/* ========================================================= */
/* 9. 選中行的樣式 (Master 和 Detail 共用)                    */
/* ========================================================= */
.mmd-master-table tbody tr.selected,
.mmd-detail-table tbody tr.selected,
.mmd-grid tbody tr.selected {
    background-color: #d1ecf1 !important;
    font-weight: 500;
}

.mmd-master-table tbody tr.selected td,
.mmd-detail-table tbody tr.selected td,
.mmd-grid tbody tr.selected td {
    background-color: #d1ecf1 !important;
    border-color: #bee5eb !important;
}

.mmd-grid tbody tr.selected,
.mmd-grid tbody tr.selected:nth-child(even) {
    background: #cce5ff !important;
    font-weight: bold;
}

.mmd-grid tbody tr.selected td,
.mmd-grid tbody tr.selected:nth-child(even) td {
    background: #cce5ff !important;
}
</style>

<script>
// ========================================================
// 初始化：根據佈局模式執行不同的初始化邏輯
// ========================================================
document.addEventListener('DOMContentLoaded', function() {
    const domId = '@domId';
    const layoutMode = '@layoutMode';
    const root = document.getElementById(domId);

    if (!root) {
        console.error('找不到根容器:', domId);
        return;
    }

    if (layoutMode === 'ThreeColumn' || layoutMode === 'VerticalStack') {
        // 三欄式和垂直堆疊佈局需要初始化計數和分隔器
        setTimeout(() => {
            initGridCounts(domId);
            // 記錄垂直堆疊佈局中摘要對應科目的初始高度
            if (layoutMode === 'VerticalStack') {
                const subdetailPanel = root.querySelector('.mmd-panel-stack-subdetail');
                if (subdetailPanel) {
                    const initialHeight = subdetailPanel.offsetHeight;
                    subdetailPanel.setAttribute('data-initial-height', initialHeight);
                }
            }
            bindSplitters();
        }, 300);
    }
});

// ========================================================
// 初始化表格計數
// ========================================================
function initGridCounts(domId) {
    const tables = document.querySelectorAll(`#${domId} .mmd-grid`);
    tables.forEach(table => {
        const wrapper = table.closest('[id$="-wrapper"]') || table.closest('.mmd-section-body');
        if (!wrapper) return;

        const wrapperId = wrapper.id.replace('-wrapper', '').replace(`${domId}-`, '');
        let countId = '';

        if (wrapperId === 'masterWrapper' || wrapperId === domId + '-masterWrapper') {
            countId = `${domId}-count-master`;
        } else if (wrapperId.startsWith('detail-')) {
            const detailIndex = wrapperId.replace('detail-', '');
            countId = `${domId}-count-detail-${detailIndex}`;
        }

        if (countId) {
            updateGridCount(table, countId);

            // 監聽表格變化
            const tbody = table.querySelector('tbody');
            if (tbody) {
                const observer = new MutationObserver(() => {
                    updateGridCount(table, countId);
                });
                observer.observe(tbody, {
                    childList: true,
                    subtree: true
                });
            }
        }
    });
}

// ========================================================
// 更新表格計數
// ========================================================
function updateGridCount(table, countId) {
    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    const rows = tbody.querySelectorAll('tr');
    let count = 0;
    let selectedIndex = 0;

    rows.forEach((row, index) => {
        // 排除提示訊息行
        if (!row.textContent.includes('請點選') && !row.textContent.includes('載入中')) {
            count++;
            if (row.classList.contains('selected')) {
                selectedIndex = count;
            }
        }
    });

    const countElem = document.getElementById(countId);
    if (countElem) {
        countElem.textContent = `${selectedIndex > 0 ? selectedIndex : count} / ${count}`;
    }
}

// ========================================================
// 綁定分隔器拖曳
// ========================================================
function bindSplitters() {
    const splitters = document.querySelectorAll('.mmd-splitter-v, .mmd-splitter-h');
    splitters.forEach(splitter => {
        splitter.addEventListener('mousedown', function(e) {
            e.preventDefault();
            const isVertical = splitter.classList.contains('mmd-splitter-v');
            const startPos = isVertical ? e.clientX : e.clientY;
            const prevPanel = splitter.previousElementSibling;
            const nextPanel = splitter.nextElementSibling;
            const startSize = isVertical ? prevPanel.offsetWidth : prevPanel.offsetHeight;
            const startNextSize = nextPanel ? (isVertical ? nextPanel.offsetWidth : nextPanel.offsetHeight) : 0;

            // 檢查是否為最後一個水平分隔器（垂直堆疊佈局的底部拖曳器）
            const isLastHSplitter = !isVertical &&
                                    prevPanel &&
                                    prevPanel.classList.contains('mmd-panel-stack-subdetail');

            // 讀取最後一個分隔器的初始高度（從 data 屬性），作為最小高度限制
            const initialHeight = isLastHSplitter && prevPanel.hasAttribute('data-initial-height')
                                    ? parseInt(prevPanel.getAttribute('data-initial-height'))
                                    : 0;

            if (isLastHSplitter) {
                prevPanel.style.flex = 'none';
                prevPanel.style.height = startSize + 'px';
                if (nextPanel) {
                    nextPanel.style.flex = '1';
                }
            }

            function onMouseMove(e) {
                const delta = (isVertical ? e.clientX : e.clientY) - startPos;
                const newSize = startSize + delta;
                const newNextSize = startNextSize - delta;

                // 對於最後一個水平分隔器，不能縮小到低於初始高度
                // 其他分隔器限制最小高度為 100px
                const minHeight = isLastHSplitter ? initialHeight : 100;

                if (newSize >= minHeight) {
                    if (isVertical) {
                        prevPanel.style.width = newSize + 'px';
                        if (nextPanel && !isLastHSplitter && newNextSize > 100) {
                            nextPanel.style.width = newNextSize + 'px';
                        }
                    } else {
                        prevPanel.style.height = newSize + 'px';
                        // 最後一個水平分隔器允許無限增長，不限制 nextPanel 大小
                        if (!isLastHSplitter && nextPanel && newNextSize > 100) {
                            nextPanel.style.height = newNextSize + 'px';
                        }
                        // 對於最後一個分隔器，讓 filler 自動調整（可以為 0）
                        if (isLastHSplitter && nextPanel) {
                            nextPanel.style.minHeight = '0';
                        }
                    }
                }
            }

            function onMouseUp() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    });
}

// ========================================================
// 監聽選中行變化，更新計數顯示
// ========================================================
document.addEventListener('click', function(e) {
    const tr = e.target.closest('tr');
    if (tr && tr.parentElement.tagName === 'TBODY') {
        const table = tr.closest('table');
        if (table && table.classList.contains('mmd-grid')) {
            const wrapper = table.closest('[id$="-wrapper"]') || table.closest('.mmd-section-body');
            if (!wrapper) return;

            const domId = table.id.split('-')[0];
            const wrapperId = wrapper.id.replace('-wrapper', '').replace(`${domId}-`, '');
            let countId = '';

            if (wrapperId === 'masterWrapper' || wrapperId === domId + '-masterWrapper') {
                countId = `${domId}-count-master`;
            } else if (wrapperId.startsWith('detail-')) {
                const detailIndex = wrapperId.replace('detail-', '');
                countId = `${domId}-count-detail-${detailIndex}`;
            }

            if (countId) {
                setTimeout(() => updateGridCount(table, countId), 100);
            }
        }
    }
});
</script>