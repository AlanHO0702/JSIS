@using System.Text.Json
@model WebRazor.Models.MasterMultiDetailConfig

@{
    var domId = Model.DomId;
    var masterTitle = Model.MasterTitle ?? Model.MasterTable;
    var json = JsonSerializer.Serialize(Model, new JsonSerializerOptions { PropertyNamingPolicy = null });
    var layoutMode = Model.Layout;
}

<link rel="stylesheet" href="~/css/grid-toolbar.css" />
<link rel="stylesheet" href="~/css/masterMultiDetailTemplate.css" />

<div id="@domId" class="mmd-wrapper mmd-layout-@layoutMode.ToString().ToLower() container-fluid px-2 px-md-4">

  <!-- 功能列 -->
  <div class="d-flex align-items-center justify-content-between my-3">
      <partial name="~/Pages/Shared/_GridToolbar.cshtml" model='@(new PcbErpApi.Models.GridToolbarConfig { Prefix = domId + "-", ShowCancel = true })' />
  </div>

  @if (layoutMode == WebRazor.Models.LayoutMode.Tabs)
  {
      <!-- ==================== Tabs 佈局（原始預設佈局） ==================== -->
      <!-- Master 區 -->
      <div class="card shadow-sm border-0 rounded-4 mb-2 mmd-master-card">
        <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
            <span>@masterTitle</span>
            <span id="@domId-count-master"></span>
        </div>
        <div class="card-body p-0">
          <div id="@domId-masterWrapper" class="table-responsive mmd-master-scroll">
            <table id="@domId-masterGrid"
                   class="table table-sm table-hover align-middle mb-0 mmd-master-table"
                   data-dict-table="@Model.MasterDict"
                   tabindex="0">
              <thead class="table-primary sticky-top">
                <tr id="@domId-m-head"></tr>
              </thead>
              <tbody id="@domId-m-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="@domId-tabs">
          @for (int i = 0; i < Model.Details.Count; i++)
          {
              var d = Model.Details[i];
              var active = (i==0 ? "active" : "");
              <li class="nav-item">
                  <button class="nav-link @active"
                          id="@domId-tab-@i"
                          data-bs-toggle="tab"
                          data-bs-target="#@domId-tabpane-@i">
                    @d.DetailTitle
                  </button>
              </li>
          }
      </ul>

      <!-- Tab 內容 -->
      <div class="tab-content" id="@domId-tabContent">
          @for (int i = 0; i < Model.Details.Count; i++)
          {
              var d = Model.Details[i];
              var active = (i==0 ? "show active" : "");
              var dId = $"{domId}-detail-{i}";

              <div class="tab-pane fade @active" id="@domId-tabpane-@i">
                  <div class="card shadow-sm border-0 rounded-4 mmd-detail-card mt-2">
                    <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
                        <span>@d.DetailTitle</span>
                        <span id="@domId-count-detail-@i"></span>
                    </div>
                    <div class="card-body p-0">
                        <div id="@dId-wrapper" class="mmd-detail-scroll">
                            <table id="@dId-grid"
                                   class="table table-sm table-striped align-middle mb-0 mmd-detail-table"
                                   data-dict-table="@d.DetailDict"
                                   tabindex="0">
                                <thead class="table-secondary sticky-top">
                                    <tr id="@dId-head"></tr>
                                </thead>
                                <tbody id="@dId-body">
                                    <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                  </div>
              </div>
          }
      </div>
  }
  else if (layoutMode == WebRazor.Models.LayoutMode.ThreeColumn)
  {
      <!-- ==================== 三欄式佈局（橫向） ==================== -->
      <div class="mmd-three-column-container">
          <!-- 左側面板：Master + Detail[0] -->
          <div class="mmd-panel mmd-panel-left" data-min-width="200">
              <!-- Master 區域 -->
              <div class="mmd-section mmd-section-master" data-min-height="150">
                  <div class="mmd-section-header">
                      <span>@masterTitle</span>
                      <span id="@domId-count-master"></span>
                  </div>
                  <div class="mmd-section-body" id="@domId-masterWrapper">
                      <table id="@domId-masterGrid"
                             class="mmd-grid mmd-master-table"
                             data-dict-table="@Model.MasterDict"
                             tabindex="0">
                          <thead><tr id="@domId-m-head"></tr></thead>
                          <tbody id="@domId-m-body"></tbody>
                      </table>
                  </div>
              </div>

              <!-- 水平分隔器 -->
              <div class="mmd-splitter mmd-splitter-h" data-target="master"></div>

              @if (Model.Details.Count > 0)
              {
                  var d0 = Model.Details[0];
                  var d0Id = $"{domId}-detail-0";
                  <!-- Detail[0] 區域 -->
                  <div class="mmd-section mmd-section-detail0" data-min-height="100">
                      <div class="mmd-section-header">
                          <span>@d0.DetailTitle</span>
                          <span id="@domId-count-detail-0"></span>
                      </div>
                      <div class="mmd-section-body" id="@d0Id-wrapper">
                          <table id="@d0Id-grid"
                                 class="mmd-grid mmd-detail-table"
                                 data-dict-table="@d0.DetailDict"
                                 tabindex="0">
                              <thead><tr id="@d0Id-head"></tr></thead>
                              <tbody id="@d0Id-body">
                                  <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              }
          </div>

          <!-- 垂直分隔器 -->
          <div class="mmd-splitter mmd-splitter-v"></div>

          @if (Model.Details.Count > 1)
          {
              var d1 = Model.Details[1];
              var d1Id = $"{domId}-detail-1";
              <!-- 中間面板：Detail[1] -->
              <div class="mmd-panel mmd-panel-mid" data-min-width="200">
                  <div class="mmd-section">
                      <div class="mmd-section-header">
                          <span>@d1.DetailTitle</span>
                          <span id="@domId-count-detail-1"></span>
                      </div>
                      <div class="mmd-section-body" id="@d1Id-wrapper">
                          <table id="@d1Id-grid"
                                 class="mmd-grid mmd-detail-table"
                                 data-dict-table="@d1.DetailDict"
                                 tabindex="0">
                              <thead><tr id="@d1Id-head"></tr></thead>
                              <tbody id="@d1Id-body">
                                  <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>

              <!-- 垂直分隔器 -->
              <div class="mmd-splitter mmd-splitter-v"></div>
          }

          @if (Model.Details.Count > 2)
          {
              var d2 = Model.Details[2];
              var d2Id = $"{domId}-detail-2";
              <!-- 右側面板：Detail[2] -->
              <div class="mmd-panel mmd-panel-right" data-min-width="200">
                  <div class="mmd-section">
                      <div class="mmd-section-header">
                          <span>@d2.DetailTitle</span>
                          <span id="@domId-count-detail-2"></span>
                      </div>
                      <div class="mmd-section-body" id="@d2Id-wrapper">
                          <table id="@d2Id-grid"
                                 class="mmd-grid mmd-detail-table"
                                 data-dict-table="@d2.DetailDict"
                                 tabindex="0">
                              <thead><tr id="@d2Id-head"></tr></thead>
                              <tbody id="@d2Id-body">
                                  <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          }
      </div>
  }
  else if (layoutMode == WebRazor.Models.LayoutMode.VerticalStack)
  {
      <!-- ==================== 垂直堆疊佈局 ==================== -->
      <div class="mmd-vertical-stack-container">
          <!-- Master 區域 -->
          <div class="mmd-panel mmd-panel-stack-master" data-min-height="120">
              <div class="mmd-section-header">
                  <span>@masterTitle</span>
                  <span id="@domId-count-master"></span>
              </div>
              <div class="mmd-section-body" id="@domId-masterWrapper">
                  <table id="@domId-masterGrid"
                         class="mmd-grid mmd-master-table"
                         data-dict-table="@Model.MasterDict"
                         tabindex="0">
                      <thead><tr id="@domId-m-head"></tr></thead>
                      <tbody id="@domId-m-body"></tbody>
                  </table>
              </div>
          </div>

          <!-- 水平分隔器 -->
          <div class="mmd-splitter mmd-splitter-h" data-target="stack-master"></div>

          @if (Model.Details.Count > 0)
          {
              var d0 = Model.Details[0];
              var d0Id = $"{domId}-detail-0";
              <!-- Detail 區域 -->
              <div class="mmd-panel mmd-panel-stack-detail" data-min-height="150">
                  <div class="mmd-section-header">
                      <span>@d0.DetailTitle</span>
                      <span id="@domId-count-detail-0"></span>
                  </div>
                  <div class="mmd-section-body" id="@d0Id-wrapper">
                      <table id="@d0Id-grid"
                             class="mmd-grid mmd-detail-table"
                             data-dict-table="@d0.DetailDict"
                             tabindex="0">
                          <thead><tr id="@d0Id-head"></tr></thead>
                          <tbody id="@d0Id-body">
                              <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                          </tbody>
                      </table>
                  </div>
              </div>

              <!-- 水平分隔器 -->
              <div class="mmd-splitter mmd-splitter-h" data-target="stack-detail"></div>
          }

          @if (Model.Details.Count > 1)
          {
              var d1 = Model.Details[1];
              var d1Id = $"{domId}-detail-1";
              <!-- SubDetail 區域 -->
              <div class="mmd-panel mmd-panel-stack-subdetail" data-min-height="100">
                  <div class="mmd-section-header">
                      <span>@d1.DetailTitle</span>
                      <span id="@domId-count-detail-1"></span>
                  </div>
                  <div class="mmd-section-body" id="@d1Id-wrapper">
                      <table id="@d1Id-grid"
                             class="mmd-grid mmd-detail-table"
                             data-dict-table="@d1.DetailDict"
                             tabindex="0">
                          <thead><tr id="@d1Id-head"></tr></thead>
                          <tbody id="@d1Id-body">
                              <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
                          </tbody>
                      </table>
                  </div>
              </div>

              <!-- 水平分隔器（底部拖曳器） -->
              <div class="mmd-splitter mmd-splitter-h" data-target="stack-subdetail"></div>
          }

          <!-- 底部填充區域 -->
          <div class="mmd-panel-filler"></div>
      </div>
  }
  else if (layoutMode == WebRazor.Models.LayoutMode.BalanceSheet)
  {
      <!-- ==================== 資產負債表佈局（四層結構） ==================== -->
      <div class="mmd-balancesheet-container">
          <!-- 頂部區域：分組選擇器 + 工具列 -->
          <div class="mmd-panel mmd-panel-top-selector" style="height: @(Model.TopSelectorHeight)px;" data-min-height="80">
              <div class="d-flex h-100">
                  <!-- 左側：分組選擇器 Grid (75% 寬度，3:1 比例) -->
                  <div class="mmd-top-selector-grid" style="flex: 3; min-width: 0;">
                      <div class="mmd-section-header">
                          <span>@(Model.TopSelectorTitle ?? Model.TopSelectorTable)</span>
                          <span id="@domId-count-topselector"></span>
                      </div>
                      <div class="mmd-section-body" id="@domId-topSelectorWrapper">
                          <table id="@domId-topSelectorGrid"
                                 class="mmd-grid mmd-topselector-table"
                                 data-dict-table="@Model.TopSelectorDict"
                                 tabindex="0">
                              <thead><tr id="@domId-ts-head"></tr></thead>
                              <tbody id="@domId-ts-body"></tbody>
                          </table>
                      </div>
                  </div>

                  <!-- 右側：工具列（可選，25% 寬度，3:1 比例） -->
                  @if (Model.EnableTopToolbar)
                  {
                      <div class="mmd-top-toolbar border-start" style="flex: 1; min-width: 0;">
                          <div class="mmd-section-header">
                              <span>項目新增</span>
                          </div>
                          <div class="mmd-section-body p-3">
                              <div class="row g-2">
                                  <div class="col-auto">
                                      <label class="form-label mb-1">編碼</label>
                                      <input type="text" id="@domId-newItemCode" class="form-control form-control-sm" style="width: 80px;" />
                                  </div>
                                  <div class="col">
                                      <label class="form-label mb-1">項目名稱</label>
                                      <input type="text" id="@domId-newItemName" class="form-control form-control-sm" />
                                  </div>
                                  <div class="col-auto d-flex align-items-end">
                                      <button type="button" id="@domId-btnAddItem" class="btn btn-primary btn-sm">加入</button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  }
              </div>
          </div>

          <!-- 水平分隔器 -->
          <div class="mmd-splitter mmd-splitter-h" data-target="top-selector"></div>

          <!-- 主要區域：Master + Detail -->
          <div class="mmd-panel mmd-panel-main-area d-flex" style="flex: 1; overflow: hidden;">
              <!-- 左側：Master Grid -->
              <div class="mmd-panel mmd-panel-master" style="width: 300px;" data-min-width="200">
                  <div class="mmd-section-header">
                      <span>@masterTitle</span>
                      <span id="@domId-count-master"></span>
                  </div>
                  <div class="mmd-section-body" id="@domId-masterWrapper">
                      <table id="@domId-masterGrid"
                             class="mmd-grid mmd-master-table"
                             data-dict-table="@Model.MasterDict"
                             tabindex="0">
                          <thead><tr id="@domId-m-head"></tr></thead>
                          <tbody id="@domId-m-body">
                              <tr><td class="text-center text-muted p-3">請點選上方一筆分組資料</td></tr>
                          </tbody>
                      </table>
                  </div>
              </div>

              <!-- 垂直分隔器 -->
              <div class="mmd-splitter mmd-splitter-v" data-target="master"></div>

              <!-- 右側：Detail Tabs -->
              <div class="mmd-panel mmd-panel-detail flex-fill">
                  @if (Model.Details.Count > 0)
                  {
                      <!-- 頁籤導航 -->
                      <ul class="nav nav-tabs mmd-detail-tabs" id="@domId-detail-tabs">
                          @for (int i = 0; i < Model.Details.Count; i++)
                          {
                              var d = Model.Details[i];
                              var active = (i == 0 ? "active" : "");
                              <li class="nav-item">
                                  <button class="nav-link @active"
                                          id="@domId-detail-tab-@i"
                                          data-bs-toggle="tab"
                                          data-bs-target="#@domId-detail-tabpane-@i"
                                          type="button">
                                      @d.DetailTitle
                                      <span id="@domId-count-detail-@i" class="ms-2"></span>
                                  </button>
                              </li>
                          }
                      </ul>

                      <!-- 頁籤內容 -->
                      <div class="tab-content mmd-detail-tab-content" id="@domId-detail-tabContent">
                          @for (int i = 0; i < Model.Details.Count; i++)
                          {
                              var d = Model.Details[i];
                              var dId = $"{domId}-detail-{i}";
                              var active = (i == 0 ? "show active" : "");

                              <div class="tab-pane fade @active" id="@domId-detail-tabpane-@i">
                                  <div class="mmd-section-body mmd-tabpane-body" id="@dId-wrapper">
                                      <table id="@dId-grid"
                                             class="mmd-grid mmd-detail-table"
                                             data-dict-table="@d.DetailDict"
                                             tabindex="0">
                                          <thead><tr id="@dId-head"></tr></thead>
                                          <tbody id="@dId-body">
                                              <tr><td class="text-center text-muted p-3">請點選左方一筆資料</td></tr>
                                          </tbody>
                                      </table>
                                  </div>
                              </div>
                          }
                      </div>
                  }
              </div>
          </div>
      </div>
  }

</div>

<script>
window._mmdConfigs = window._mmdConfigs || {};
window._mmdConfigs["@domId"] = @Html.Raw(json);
</script>

<script src="/js/editableGrid.js"></script>
<script src="/js/masterMultiDetailTemplate.js"></script>
<script src="~/js/gridToolbarTemplate.js"></script>
<script src="~/js/masterMultiDetailTemplateUI.js"></script>
