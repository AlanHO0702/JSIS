@using System.Reflection
@model dynamic
@{
    var tableName  = (string)(Model.TableName ?? "");
    var items      = (IEnumerable<object>)(Model.Items ?? new List<object>());
    var fields     = (IEnumerable<dynamic>)(Model.TableFields ?? new List<object>());
    int totalCount = (int)(Model.TotalCount ?? 0);
    int pageNumber = (int)(Model.PageNumber ?? 1);
    int pageSize   = (int)(Model.PageSize   ?? 50);
    var totalPages = Math.Ceiling(totalCount / (double)Math.Max(1, pageSize));
    var hasData    = items.Any();
}

<div class="card shadow-sm border-0">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="text-muted small">
        共 <strong>@totalCount</strong> 筆，每頁 <strong>@pageSize</strong>，目前第 <strong>@pageNumber</strong> / <strong>@(totalPages == 0 ? 1 : totalPages)</strong> 頁
      </div>
    </div>

    @if (!hasData)
    {
      <div class="alert alert-warning mb-0">找不到任何資料。</div>
    }
    else
    {
      <div class="table-responsive" style="max-height:65vh; overflow-y:auto;">
        <table class="table table-bordered table-hover table-sm align-middle">
          <thead class="table-light sticky-top">
            <tr>
              @foreach (var f in fields)
              {
                  <th class="text-nowrap">@((string)f.DisplayLabel)</th>
              }
            </tr>
          </thead>
          <tbody>
            @foreach (var item in items)
            {
              <tr>
                @foreach (var f in fields)
                {
                    // 取得欄位名稱（保險轉字串）
                    string? fieldName = null;
                    try { fieldName = Convert.ToString(f.FieldName) ?? ""; } catch {}

                    // 反射找屬性（忽略大小寫）
                    PropertyInfo? prop = null;
                    if (!string.IsNullOrWhiteSpace(fieldName))
                    {
                        prop = item.GetType().GetProperty(
                            fieldName!,
                            BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase
                        );
                    }

                    var value = prop?.GetValue(item);
                    string displayValue =
                        value switch
                        {
                            DateTime dt  => dt.ToString("yyyy/MM/dd HH:mm"),
                            decimal dec  => dec.ToString("#,##0.##"),
                            double d     => d.ToString("#,##0.##"),
                            float  fl    => fl.ToString("#,##0.##"),
                            IFormattable fmt => fmt.ToString(null, System.Globalization.CultureInfo.InvariantCulture),
                            _ => value?.ToString() ?? ""
                        };

                    <td class="text-nowrap">@displayValue</td>
                }
              </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-end mt-2">
        <nav aria-label="Page navigation">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item @(pageNumber <= 1 ? "disabled" : "")">
              <a class="page-link" href="?page=@(pageNumber - 1)">«</a>
            </li>
            <li class="page-item active"><span class="page-link">@pageNumber</span></li>
            <li class="page-item @(pageNumber >= totalPages ? "disabled" : "")">
              <a class="page-link" href="?page=@(pageNumber + 1)">»</a>
            </li>
          </ul>
        </nav>
      </div>
    }
  </div>
</div>

<style>
  table.table th, table.table td { vertical-align: middle !important; border: 1px solid #dee2e6 !important; padding: .4rem .6rem !important; }
  thead.table-light th { background:#f8f9fa!important; font-weight:600; border-bottom:2px solid #dee2e6!important; }
  .table-hover tbody tr:hover { background:#f1f5ff!important; }
  .card { border-radius:.75rem; }
</style>

<script>
  // 讓這頁也可 F3 叫出辭典設定（且儲存後重整）
  (function () {
    window._dictTableName = "@tableName" || "CurdBu";

    document.addEventListener('keydown', function (e) {
      if (e.key === 'F3') {
        e.preventDefault();
        if (window.showDictModal) {
          showDictModal('dictModal', window._dictTableName);
        } else {
          console.warn('找不到 showDictModal，請確認 fieldDictModal.js 已載入');
        }
      }
    });

    // 儲存成功事件（請確保 fieldDictModal.js 會 dispatch 這個事件）
    window.addEventListener('dict:saved', function () {
      location.reload(); // 直接重整，避免你遇到「改了沒更新」
    });
  })();
</script>
