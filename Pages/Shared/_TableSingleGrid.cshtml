@using System.Reflection
@using Microsoft.AspNetCore.Html
@model dynamic

@{
    var tableName     = (string)(Model.TableName ?? "");
    var items         = (IEnumerable<object>)(Model.Items ?? new List<object>());
    var fields        = (IEnumerable<dynamic>)(Model.TableFields ?? new List<object>());
    var customButtons = ViewData["CustomButtons"] as HtmlString;
    var hasData       = items.Any();
    var keyFieldsFromViewData = (IEnumerable<string>)(ViewData["KeyFields"] as IEnumerable<string> ?? Array.Empty<string>());
}

@functions{
    private static string Fmt(object? v) => v switch
    {
        DateTime dt  => dt.ToString("yyyy/MM/dd HH:mm"),
        decimal dec  => dec.ToString("#,##0.##"),
        double d     => d.ToString("#,##0.##"),
        float f      => f.ToString("#,##0.##"),
        IFormattable fm => fm.ToString(null, System.Globalization.CultureInfo.InvariantCulture),
        _ => v?.ToString() ?? ""
    };

    // 將 DisplaySize（字數概念）換成像素欄寬
    private static int ToColWidthPx(dynamic f, int pxPerChar = 10)
    {
        try
        {
            var raw = f?.DisplaySize;
            if (raw == null) return 0;

            if (raw is int i && i > 0) return i * pxPerChar;

            int n;
            var s = raw.ToString();
            if (int.TryParse(s, out n) && n > 0) return n * pxPerChar;

            return 0;
        }
        catch { return 0; }
    }
}

<div class="table-wrapper my-4 px-4">
  <div class="card shadow-sm border-0 rounded-4">
    <div class="card-body">

      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div class="d-flex gap-2">
          <button id="btnEditToggle" type="button" class="btn btn-warning btn-sm fw-bold">
            <i class="bi bi-pencil-square me-1"></i> 修改
          </button>
          <button id="btnSaveTable" type="button" class="btn btn-success btn-sm fw-bold d-none">
            <i class="bi bi-save me-1"></i> 儲存
          </button>
        </div>

        @if (customButtons != null && !string.IsNullOrWhiteSpace(customButtons.ToString()))
        {
          <div class="d-flex justify-content-end gap-2">
            @customButtons
          </div>
        }
      </div>

      <div class="table-fix-wrapper">
        <table class="table table-bordered table-hover table-sm align-middle mb-0 " id="mainGrid" >
          <colgroup>
            @foreach (var f in fields)
            {
              var w = ToColWidthPx(f, 10);
              if (w > 0)
              { <col style="width:@($"{w}px");min-width:@($"{w}px");max-width:@($"{w}px")" /> }
              else
              { <col /> }
            }
          </colgroup>

          <thead class="table-light sticky-top">
            <tr>
              @foreach (var f in fields)
              {
                <th class="text-nowrap">@((string)f.DisplayLabel)</th>
              }
            </tr>
          </thead>

          <tbody>
            @if (!hasData)
            {
              <tr><td colspan="@fields.Count()" class="text-center text-muted py-3">（無資料）</td></tr>
            }
            else
            {
              @foreach (var item in items)
              {
                <tr>
                  @foreach (var f in fields)
                  {
                      string? name = Convert.ToString(f.FieldName);
                      PropertyInfo? prop = string.IsNullOrWhiteSpace(name) ? null :
                      item.GetType().GetProperty(name!, BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase);
                      var value = prop?.GetValue(item);

                     bool isReadOnly = f.ReadOnly != null && (int)f.ReadOnly != 0;


                      // 這裡不用強迫把 SystemId/ParamId 設唯讀，給使用者自行編輯與否由辭典控制
                      <td class="text-nowrap" data-field="@name">
                        <span class="cell-view">@Fmt(value)</span>
                        <input class="form-control form-control-sm cell-edit d-none @(isReadOnly ? "readonly-cell" : "")"
                               name="@name"
                               value="@Fmt(value)"
                               data-readonly="@(isReadOnly ? "1" : "0")"
                               @(isReadOnly ? "readonly" : "") />
                      </td>
                  }
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<style>
.table-fix-wrapper{max-height:70vh;overflow:auto;background:#fff;border:1px solid #dee2e6;border-radius:.5rem;white-space:nowrap}
table.table{table-layout:fixed!important;border-collapse:separate!important;border-spacing:0;font-size:.9rem;width:100%}
table th,table td{vertical-align:middle!important;border:1px solid #dee2e6!important;padding:.4rem .6rem!important;white-space:nowrap}
.table-hover tbody tr:hover{background:#f1f5ff!important}
.cell-view,.cell-edit{display:inline-block;width:100%;font-size:.9rem;line-height:1.4;box-sizing:border-box;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding:.4rem .6rem!important;vertical-align:middle}
.cell-edit.form-control{height:calc(1.6em + .5rem + 2px)!important;padding:.4rem .6rem!important;font-size:.9rem!important;line-height:1.4!important;border-radius:0!important;box-sizing:border-box!important}
.edit-mode .cell-edit:not(.readonly-cell){border:1px solid #ccc!important;background:#fff!important}
.readonly-cell{background:#f3f3f3!important;color:#555!important;border:1px solid #ddd!important;cursor:not-allowed!important;pointer-events:none!important;user-select:none!important}
.table-fix-wrapper::-webkit-scrollbar{height:10px;width:10px}
.table-fix-wrapper::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:6px}
.table-fix-wrapper::-webkit-scrollbar-thumb:hover{background:#9ca3af}
/* 滑過 */
#mainGrid tbody tr:hover {
    background-color: #f9f2d7 !important;
    cursor: pointer;
}

/* 點擊後選取 */
#mainGrid tbody tr.selected-row {
    background-color: #fff3cd !important;
    transition: background-color .15s;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const editBtn = document.getElementById("btnEditToggle");
  const saveBtn = document.getElementById("btnSaveTable");
  const wrapper = document.querySelector(".table-wrapper");
  const table   = document.getElementById("mainGrid");
  let isEdit = false;

  // ===== 取得本頁的鍵欄位（支援 window.KEY_FIELDS / ViewData["KeyFields"] / 預設） =====
  const KEY_FIELDS = (() => {
    if (Array.isArray(window.KEY_FIELDS) && window.KEY_FIELDS.length)
      return window.KEY_FIELDS.map(s => String(s).toLowerCase());

    // Razor 轉入的 ViewData["KeyFields"]
    const fromView = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(keyFieldsFromViewData));
    if (Array.isArray(fromView) && fromView.length)
      return fromView.map(s => String(s).toLowerCase());

    // 預設（共用樣板常見鍵）
    return ["buid","itemid","id","papernum","systemcode"];
  })();

  // ===== 修改/保留切換 =====
  editBtn.addEventListener("click", () => {
    isEdit = !isEdit;
    editBtn.innerHTML = isEdit
      ? '<i class="bi bi-eye me-1"></i> 保留'
      : '<i class="bi bi-pencil-square me-1"></i> 修改';

    wrapper.classList.toggle("edit-mode", isEdit);
    saveBtn.classList.toggle("d-none", !isEdit);

    if (isEdit) {
      table.querySelectorAll(".cell-edit").forEach(inp => {
        inp.defaultValue = inp.value;
      });
    }

    table.querySelectorAll("tbody tr").forEach(tr => {
      tr.querySelectorAll("td").forEach(td => {
        const span = td.querySelector(".cell-view");
        const inp  = td.querySelector(".cell-edit");
        if (!span || !inp) return;

        if (isEdit) {
          span.classList.add("d-none");
          inp.classList.remove("d-none");
          if (inp.dataset.readonly === "1") {
            inp.classList.add("readonly-cell");
            inp.setAttribute("readonly", "readonly");
            inp.setAttribute("tabindex", "-1");
          } else {
            inp.classList.remove("readonly-cell");
            inp.removeAttribute("readonly");
            inp.removeAttribute("tabindex");
          }
        } else {
          span.textContent = inp.value;
          span.classList.remove("d-none");
          inp.classList.add("d-none");
        }
      });
    });
  });

  // ===== 儲存 =====
  saveBtn.addEventListener("click", async () => {
    const changes = collectChanges();
    if (changes.length === 0) { /* ... */ return; }

    const resp = await fetch('/api/CommonTable/SaveTableChanges', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        TableName: "@tableName",
        Data: changes
      })
    });

    if (resp.ok) {
      Swal.fire({ icon: 'success', title: '儲存完成', timer: 1000, showConfirmButton: false });

      // 依複合鍵更新畫面該列
      changes.forEach(change => {
        const targetRow = findRowByKeys(change);
        if (!targetRow) return;

        for (const [field, newVal] of Object.entries(change)) {
          // 不處理鍵欄位的畫面刷新？→ 鍵欄位也一併刷新（避免視覺不一致）
          const cell = targetRow.querySelector(`td[data-field="${field}"]`);
          if (!cell) continue;
          const inp  = cell.querySelector(".cell-edit");
          const span = cell.querySelector(".cell-view");
          if (inp)  inp.defaultValue = newVal;
          if (span) span.textContent  = newVal;
        }
      });
    } else {
      Swal.fire({ icon: 'error', title: '儲存失敗', text: await resp.text() });
    }
  });

  // ===== 依複合鍵找列 =====
  function findRowByKeys(change) {
    const rows = Array.from(table.querySelectorAll("tbody tr"));
    return rows.find(tr => {
      return KEY_FIELDS.every(k => {
        const inp = Array.from(tr.querySelectorAll('.cell-edit')).find(i => i.name.toLowerCase() === k);
        if (!inp) return false;
        const changeVal = change[k];
        // 從 change 取值（可能來自 new 或 old），若沒有就用現值
        if (changeVal == null) return false;
        return String(inp.value) === String(changeVal) || String(inp.defaultValue) === String(changeVal);
      });
    });
  }

  // ===== 收集變更（複合鍵一定帶上） =====
  function collectChanges() {
    const list = [];
    document.querySelectorAll("#mainGrid tbody tr").forEach(tr => {
      let hasDiff = false;

      // 先偵測有沒有變更
      tr.querySelectorAll(".cell-edit").forEach(inp => {
        const oldVal = inp.defaultValue ?? "";
        const newVal = inp.value ?? "";
        if (inp.dataset.readonly === "1") return;
        if (newVal !== oldVal) hasDiff = true;
      });

      if (!hasDiff) return; // 沒有變更就不送

      // 有變更 → 整列打包（確保包含鍵欄位）
      const rowAll = {};
      tr.querySelectorAll(".cell-edit").forEach(inp => {
        const name = inp.name;
        if (!name) return;
        // 送目前值；空字串照樣送，後端會依型別轉 DBNull 或字串
        rowAll[name] = inp.value ?? "";
      });
      list.push(rowAll);
    });
    return list;
  }

  table.addEventListener("click", (ev) => {
    const tr = ev.target.closest("tbody tr");
    if (!tr) return;
    table.querySelectorAll("tbody tr").forEach(r => r.classList.remove("selected-row"));
    tr.classList.add("selected-row");
    window.SELECTED_ROW = tr;
  });


});
</script>
