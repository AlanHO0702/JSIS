@using System.Reflection
@using Microsoft.AspNetCore.Html
@model dynamic
@{
    var tableName  = (string)(Model.TableName ?? "");
    var items      = (IEnumerable<object>)(Model.Items ?? new List<object>());
    var fields     = (IEnumerable<dynamic>)(Model.TableFields ?? new List<object>());
    int totalCount = (int)(Model.TotalCount ?? 0);
    int pageNumber = (int)(Model.PageNumber ?? 1);
    int pageSize   = (int)(Model.PageSize   ?? 50);
    var totalPages = Math.Ceiling(totalCount / (double)Math.Max(1, pageSize));
    var hasData    = items.Any();

    // ğŸ”¸ å¾é é¢å‚³å…¥çš„è‡ªè¨‚æŒ‰éˆ•å€
    var customButtons = ViewData["CustomButtons"] as HtmlString;
}

<div class="card shadow-sm border-0">
  <div class="card-body">

    <!-- ğŸ”¸ è³‡æ–™ç­†æ•¸èˆ‡åˆ†é è³‡è¨Š -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="text-muted small">
        å…± <strong>@totalCount</strong> ç­†ï¼Œæ¯é  <strong>@pageSize</strong>ï¼Œ
        ç›®å‰ç¬¬ <strong>@pageNumber</strong> / <strong>@(totalPages == 0 ? 1 : totalPages)</strong> é 
      </div>
    </div>

    <!-- ğŸ”¸ è¡¨æ ¼ -->
    @if (!hasData)
    {
      <div class="alert alert-warning mb-0">æ‰¾ä¸åˆ°ä»»ä½•è³‡æ–™ã€‚</div>
    }
    else
    {
      <div class="table-responsive" style="max-height:65vh; overflow-y:auto;">
        <table class="table table-bordered table-hover table-sm align-middle">
          <thead class="table-light sticky-top">
            <tr>
              @foreach (var f in fields)
              {
                  <th class="text-nowrap">@((string)f.DisplayLabel)</th>
              }
            </tr>
          </thead>
          <tbody>
            @foreach (var item in items)
            {
              <tr>
                @foreach (var f in fields)
                {
                    // å–å¾—æ¬„ä½åç¨±
                    string? fieldName = null;
                    try { fieldName = Convert.ToString(f.FieldName) ?? ""; } catch {}

                    // åå°„æ‰¾å±¬æ€§ï¼ˆå¿½ç•¥å¤§å°å¯«ï¼‰
                    PropertyInfo? prop = null;
                    if (!string.IsNullOrWhiteSpace(fieldName))
                    {
                        prop = item.GetType().GetProperty(
                            fieldName!,
                            BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase
                        );
                    }

                    var value = prop?.GetValue(item);
                    string displayValue =
                        value switch
                        {
                            DateTime dt  => dt.ToString("yyyy/MM/dd HH:mm"),
                            decimal dec  => dec.ToString("#,##0.##"),
                            double d     => d.ToString("#,##0.##"),
                            float  fl    => fl.ToString("#,##0.##"),
                            IFormattable fmt => fmt.ToString(null, System.Globalization.CultureInfo.InvariantCulture),
                            _ => value?.ToString() ?? ""
                        };

                    <td class="text-nowrap">@displayValue</td>
                }
              </tr>
            }
          </tbody>
        </table>
      </div>
              <!-- ğŸ”¸ æŒ‰éˆ•å€å¡Šï¼ˆå…±ç”¨æ¨£æ¿é ç•™ä½ç½®ï¼‰ -->
    <div class="d-flex justify-content-end gap-2 mb-3">
      @if (customButtons != null)
      {
          @customButtons
      }
      else
      {
          <!-- é è¨­ç•™ç©ºä½†ä½”ä½ -->
          <button type="button" class="btn btn-outline-secondary btn-sm" disabled style="width:100px; opacity:0.3;">
            ï¼ˆæŒ‰éˆ•å€ï¼‰
          </button>
      }
    </div>
      <!-- ğŸ”¸ åˆ†é å€ -->
      <div class="d-flex justify-content-end mt-2">
        <nav aria-label="Page navigation">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item @(pageNumber <= 1 ? "disabled" : "")">
              <a class="page-link" href="?page=@(pageNumber - 1)">Â«</a>
            </li>
            <li class="page-item active"><span class="page-link">@pageNumber</span></li>
            <li class="page-item @(pageNumber >= totalPages ? "disabled" : "")">
              <a class="page-link" href="?page=@(pageNumber + 1)">Â»</a>
            </li>
          </ul>
        </nav>
      </div>
    }

  </div>
</div>

<style>
  table.table th, table.table td {
    vertical-align: middle !important;
    border: 1px solid #dee2e6 !important;
    padding: .4rem .6rem !important;
  }
  thead.table-light th {
    background:#f8f9fa!important;
    font-weight:600;
    border-bottom:2px solid #dee2e6!important;
  }
  .table-hover tbody tr:hover { background:#f1f5ff!important; }
  .card { border-radius:.75rem; }
</style>

<script>
  // ğŸ”¸ æ”¯æ´ F3 é–‹å•Ÿæ¬„ä½è¾­å…¸è¨­å®š
  (function () {
    window._dictTableName = "@tableName" || "CurdBu";

    document.addEventListener('keydown', function (e) {
      if (e.key === 'F3') {
        e.preventDefault();
        if (window.showDictModal) {
          showDictModal('dictModal', window._dictTableName);
        } else {
          console.warn('æ‰¾ä¸åˆ° showDictModalï¼Œè«‹ç¢ºèª fieldDictModal.js å·²è¼‰å…¥');
        }
      }
    });

    // ğŸ”¸ å„²å­˜å¾Œè‡ªå‹•é‡æ•´
    window.addEventListener('dict:saved', function () {
      location.reload();
    });
  })();
</script>
