@using System.Reflection
@using Microsoft.AspNetCore.Html
@using System.Text.Json
@using System.Linq
@using System.Collections
@using System.Collections.Generic
@using PcbErpApi.Helpers
@model dynamic

@{
    var tableName     = (string)(Model.TableName ?? "");
    var items         = (IEnumerable<object>)(Model.Items ?? new List<object>());
    var fields        = (IEnumerable<dynamic>)(Model.TableFields ?? new List<object>());
    var customButtons = ViewData["CustomButtons"] as HtmlString;
    var customButtonMeta = ViewData["CustomButtonMeta"] as IEnumerable<dynamic>;
    var hasServerButtons = customButtons != null && !string.IsNullOrWhiteSpace(customButtons.ToString());
    var hasCustomMeta = customButtonMeta != null && customButtonMeta.Cast<object>().Any();
    var autoBuildCustomButtons = !hasServerButtons && hasCustomMeta;
    var hasData       = items.Any();
    var keyFieldsFromViewData = (IEnumerable<string>)(ViewData["KeyFields"] as IEnumerable<string> ?? Array.Empty<string>());
    var dictFields    = (IEnumerable<dynamic>)(ViewData["FieldDictList"] as IEnumerable<dynamic> ?? fields);
    var dictTableName = (string?)(ViewData["DictTableName"] as string) ?? tableName;
    var enableRowDelete = (ViewData["EnableRowDelete"] as bool?)
        ?? (string.Equals(ViewData["EnableRowDelete"]?.ToString(), "true", StringComparison.OrdinalIgnoreCase)
            || string.Equals(ViewData["EnableRowDelete"]?.ToString(), "1", StringComparison.OrdinalIgnoreCase));
    var ocxLookupsRaw = ViewData["OCXLookups"] as IEnumerable<dynamic>;
    var ocxLookupPayload = ocxLookupsRaw?.ToDictionary(
        k => ((string)k.FieldName).ToLowerInvariant(),
        v => (object)new { keySelf = v.KeySelfName as string ?? "", keyField = v.KeyFieldName as string ?? "", map = v.LookupValues }
    ) ?? new Dictionary<string, object>();

    int pageNumber = 1;
    int pageSize = 0;
    int totalCount = 0;
    try { pageNumber = (int)(Model.PageNumber ?? 1); } catch { }
    try { pageSize = (int)(Model.PageSize ?? 0); } catch { }
    try { totalCount = (int)(Model.TotalCount ?? 0); } catch { }
    if (pageSize <= 0) pageSize = Math.Max(1, items.Count());
    if (totalCount <= 0) totalCount = items.Count();
    var totalPages = Math.Max(1, (int)Math.Ceiling(totalCount / (double)pageSize));
}

@functions{
    private static string Fmt(object? v) => v switch
    {
        DateTime dt  => dt.ToString("yyyy/MM/dd HH:mm"),
        decimal dec  => dec.ToString("#,##0.##"),
        double d     => d.ToString("#,##0.##"),
        float f      => f.ToString("#,##0.##"),
        IFormattable fm => fm.ToString(null, System.Globalization.CultureInfo.InvariantCulture),
        _ => v?.ToString() ?? ""
    };

    // 將 DisplaySize（字數概念）換成像素欄寬
    private static int ToColWidthPx(dynamic f, int pxPerChar = 10)
    {
        try
        {
            var raw = f?.DisplaySize;
            if (raw == null) return 0;

            if (raw is int i && i > 0) return i * pxPerChar;

            int n;
            var s = raw.ToString();
            if (int.TryParse(s, out n) && n > 0) return n * pxPerChar;

            return 0;
        }
        catch { return 0; }
    }

    // �s�� dictionary/dynamic object �W�٬�����
    private static object? GetValue(object item, string? name)
    {
        if (item == null || string.IsNullOrWhiteSpace(name)) return null;

        if (item is IDictionary dict)
        {
            foreach (var k in dict.Keys)
            {
                if (k is string ks && string.Equals(ks, name, StringComparison.OrdinalIgnoreCase))
                    return dict[k];
            }
        }

        var prop = item.GetType().GetProperty(name!, BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase);
        return prop?.GetValue(item);
    }

    private static bool ToBool(object? raw, bool defaultValue)
    {
        if (raw == null) return defaultValue;

        return raw switch
        {
            bool b => b,
            byte b => b != 0,
            sbyte b => b != 0,
            short n => n != 0,
            ushort n => n != 0,
            int n => n != 0,
            uint n => n != 0,
            long n => n != 0,
            ulong n => n != 0,
            decimal n => n != 0m,
            double n => Math.Abs(n) > double.Epsilon,
            float n => Math.Abs(n) > float.Epsilon,
            _ => ParseBool(raw.ToString(), defaultValue)
        };

        static bool ParseBool(string? text, bool fallback)
        {
            var s = text?.Trim();
            if (string.IsNullOrWhiteSpace(s)) return fallback;

            if (bool.TryParse(s, out var b)) return b;
            if (int.TryParse(s, out var n)) return n != 0;
            if (string.Equals(s, "Y", StringComparison.OrdinalIgnoreCase)) return true;
            if (string.Equals(s, "N", StringComparison.OrdinalIgnoreCase)) return false;

            return fallback;
        }
    }

    private static string GetFieldProp(object? field, string propName)
    {
        if (field == null || string.IsNullOrWhiteSpace(propName)) return "";
        if (field is IDictionary dict)
        {
            foreach (var k in dict.Keys)
            {
                if (k is string ks && string.Equals(ks, propName, StringComparison.OrdinalIgnoreCase))
                {
                    var v = dict[k];
                    return v?.ToString() ?? "";
                }
            }
        }

        var prop = field.GetType().GetProperty(propName, BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase);
        return prop?.GetValue(field)?.ToString() ?? "";
    }

    private static string FormatCell(object? value, object field)
    {
        var dataType = GetFieldProp(field, "DataType");
        var formatStr = GetFieldProp(field, "FormatStr");
        return FormatHelper.FormatValue(value, dataType, formatStr);
    }

    private static bool IsNumberDataType(object field)
    {
        var dt = GetFieldProp(field, "DataType").Trim().ToLowerInvariant();
        if (string.IsNullOrWhiteSpace(dt)) return false;
        return dt == "number"
            || dt.StartsWith("decimal") || dt.StartsWith("numeric")
            || dt.StartsWith("money") || dt.StartsWith("smallmoney")
            || dt.StartsWith("float") || dt.StartsWith("real")
            || dt.StartsWith("int") || dt.StartsWith("smallint")
            || dt.StartsWith("tinyint") || dt.StartsWith("bigint");
    }
}

<style>
  .sortable-header .header-label {
    user-select: none;
  }
  .sortable-header:hover .header-label {
    background: rgba(0, 0, 0, 0.05);
    padding: 2px 4px;
    border-radius: 3px;
  }
  .sort-icon {
    display: inline-block;
    margin-left: 4px;
    color: #0d6efd;
    font-size: 0.75em;
  }
  .col-resizer {
    cursor: col-resize;
  }
</style>

<div class="table-wrapper my-4 px-4">
  <div class="card shadow-sm border-0 rounded-4">
    <div class="card-body">

      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div class="d-flex gap-2">
          <button id="btnEditToggle" type="button" class="btn btn-warning btn-sm fw-bold">
            <i class="bi bi-pencil-square me-1"></i> 修改
          </button>
          <button id="btnSaveTable" type="button" class="btn btn-success btn-sm fw-bold d-none">
            <i class="bi bi-save me-1"></i> 儲存
          </button>
          @if (enableRowDelete)
          {
            <button id="btnDeleteRow" type="button" class="btn btn-danger btn-sm fw-bold">
              <i class="bi bi-trash me-1"></i> &#21034;&#38500;
            </button>
          }
          <button id="btnOpenQuery" type="button" class="btn btn-outline-primary btn-sm fw-bold">
            <i class="bi bi-search me-1"></i> 查詢
          </button>
        </div>

        <div class="d-flex justify-content-end gap-2" id="customButtonBar" data-auto-build="@(autoBuildCustomButtons ? "1" : "0")">
          @if (hasServerButtons)
          {
              @customButtons
          }
          else if (hasCustomMeta)
          {
              foreach (var b in customButtonMeta)
              {
                  var btnName = (GetValue(b, "ButtonName") ?? GetValue(b, "buttonName") ?? "").ToString();
                  if (string.IsNullOrWhiteSpace(btnName)) continue;
                  var caption = (GetValue(b, "CustCaption") ?? GetValue(b, "custCaption") ?? btnName).ToString();
                  var hint = (GetValue(b, "CustHint") ?? GetValue(b, "custHint") ?? "").ToString();
                  var itemId = (GetValue(b, "ItemId") ?? GetValue(b, "itemId") ?? "").ToString();
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm"
                          data-custom-btn="1"
                          data-button-name="@btnName"
                          data-item-id="@itemId"
                          title="@hint">
                    @caption
                  </button>
              }
          }
        </div>
      </div>

      <div class="table-fix-wrapper" data-dict-table="@dictTableName" style="max-height:70vh;overflow:auto;background:#fff;border:1px solid #dee2e6;border-radius:.5rem;white-space:nowrap">
        <table class="table table-bordered table-hover table-sm align-middle mb-0" id="mainGrid" data-dict-table="@dictTableName" style="table-layout:fixed;width:100%">
          <colgroup>
            @foreach (var f in fields)
            {
              var w = ToColWidthPx(f, 10);
              var isHidden = !ToBool(f.Visible, defaultValue: true);
              var hiddenStyle = isHidden ? "display:none;" : "";
              if (w > 0)
              { <col data-field="@f.FieldName" style="@hiddenStyle width:@($"{w}px");min-width:@($"{w}px");max-width:@($"{w}px")" /> }
              else
              { <col data-field="@f.FieldName" style="@hiddenStyle" /> }
            }
          </colgroup>

          <thead class="table-light sticky-top">
            <tr>
              @foreach (var f in fields)
              {
                var isHidden = !ToBool(f.Visible, defaultValue: true);
                var hiddenStyle = isHidden ? "display:none;" : "";
                var currentSortBy = ViewData["SortBy"] as string;
                var currentSortDir = ViewData["SortDir"] as string;
                var isSorted = string.Equals(currentSortBy, f.FieldName, StringComparison.OrdinalIgnoreCase);
                var sortIcon = isSorted ? (currentSortDir == "desc" ? "▼" : "▲") : "";

                <th class="text-nowrap sortable-header" data-field="@f.FieldName" style="cursor:pointer;@hiddenStyle">
                  <span class="header-label">@((string)f.DisplayLabel) <span class="sort-icon">@sortIcon</span></span>
                  <span class="col-resizer" data-field="@f.FieldName"></span>
                </th>
              }
            </tr>
          </thead>

          <tbody>
            @if (!hasData)
            {
              <tr><td colspan="@fields.Count()" class="text-center text-muted py-3">（無資料）</td></tr>
            }
            else
            {
              @foreach (var item in items)
              {
                <tr>
                  @foreach (var f in fields)
                  {
                      var dictField = dictFields.FirstOrDefault(df =>
                          string.Equals(Convert.ToString(df.FieldName), Convert.ToString(f.FieldName), StringComparison.OrdinalIgnoreCase));
                      string? name = Convert.ToString(f.FieldName);
                      var value = GetValue(item, name);
                      var rawVal = value?.ToString() ?? "";
                      var displayValue = FormatCell(value, dictField ?? f);
                      var lookupKey = rawVal;
                      var keyFieldVal = "";
                      var keySelfVal = "";

                      bool isReadOnly = ToBool(f.ReadOnly, defaultValue: false);
                      bool isHidden = !ToBool(f.Visible, defaultValue: true);
                      var hiddenStyle = isHidden ? "display:none;" : "";

                      // 依 OCX 設定帶出 key 欄位，讓 lookup 有依據
                      if (!string.IsNullOrWhiteSpace(name) && ocxLookupsRaw is not null)
                      {
                          var lk = ocxLookupsRaw.FirstOrDefault(x =>
                              string.Equals((string?)x.FieldName, name, StringComparison.OrdinalIgnoreCase));
                          var keyFieldName = lk?.KeyFieldName as string;
                          var keySelfName = lk?.KeySelfName as string;

                          if (!string.IsNullOrWhiteSpace(keyFieldName))
                          {
                              var keyVal = GetValue(item, keyFieldName);
                              keyFieldVal = keyVal?.ToString() ?? "";
                          }
                          if (!string.IsNullOrWhiteSpace(keySelfName))
                          {
                              var keyVal = GetValue(item, keySelfName);
                              keySelfVal = keyVal?.ToString() ?? "";
                          }

                          if (string.IsNullOrWhiteSpace(lookupKey))
                              lookupKey = !string.IsNullOrWhiteSpace(keyFieldVal) ? keyFieldVal : keySelfVal;
                      }

                      var cellClass = IsNumberDataType(dictField ?? f) ? "cell-number" : "cell-text";
                      <td class="text-nowrap @cellClass" data-field="@name" style="@hiddenStyle">
                        <span class="cell-view" data-raw="@rawVal" data-lookupkey="@lookupKey">@displayValue</span>
                        <input class="form-control form-control-sm cell-edit d-none @(isReadOnly ? "readonly-cell" : "")"
                               name="@name"
                               value="@rawVal"
                               data-raw="@rawVal"
                               data-lookupkey="@lookupKey"
                               data-readonly="@(isReadOnly ? "1" : "0")"
                               @(isReadOnly ? "readonly" : "") />
                      </td>
                  }
                </tr>
              }
            }
          </tbody>
        </table>
      </div>

      @if (totalPages > 1)
      {
        <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="pagerFirst" @(pageNumber <= 1 ? "disabled" : "")>|&laquo;</button>
            <button class="btn btn-outline-secondary btn-sm" id="pagerPrev" @(pageNumber <= 1 ? "disabled" : "")>&laquo;</button>
            <span>Page: <strong id="pagerCurrent">@pageNumber</strong> / <span id="pagerTotal">@totalPages</span></span>
            <button class="btn btn-outline-secondary btn-sm" id="pagerNext" @(pageNumber >= totalPages ? "disabled" : "")>&raquo;</button>
            <button class="btn btn-outline-secondary btn-sm" id="pagerLast" @(pageNumber >= totalPages ? "disabled" : "")>&raquo;|</button>
          </div>
          <div class="d-flex align-items-center gap-2">
            <label class="mb-0 text-muted">Go to:</label>
            <input id="pagerGoInput" type="number" min="1" max="@totalPages" class="form-control form-control-sm" style="width:80px" value="@pageNumber" />
            <button class="btn btn-outline-primary btn-sm" id="pagerGoBtn">Go</button>
          </div>
          <div class="d-flex align-items-center gap-2">
            <label class="mb-0 text-muted">Page size:</label>
            <select id="pagerPageSize" class="form-select form-select-sm" style="width:auto">
              @{
                  var sizes = new[] { 20, 50, 100, 200, 500 };
                  foreach (var s in sizes)
                  {
                      <option value="@s" selected="@(s == pageSize ? "selected" : null)">@s</option>
                  }
              }
            </select>
            <span class="text-muted">Total: @totalCount</span>
          </div>
        </div>
      }
    </div>
  </div>
</div>

<!-- Query Modal -->
<div class="modal fade" id="singleGridQueryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-search me-2"></i>查詢條件</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="singleGridQueryForm" class="row g-3"></form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="btnClearQuery">清除</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="btnQuerySubmit">確定</button>
      </div>
    </div>
  </div>
</div>

<style>
 .table-fix-wrapper{max-height:70vh;overflow:auto;background:#fff;border:1px solid #dee2e6;border-radius:.5rem;white-space:nowrap}
 table.table{table-layout:fixed!important;border-collapse:separate!important;border-spacing:0;font-size:.85rem;width:100%}
 table th,table td{vertical-align:middle!important;border:1px solid #dee2e6!important;padding:0 2px!important;white-space:nowrap}
 .table-hover tbody tr:hover{background:#f1f5ff!important}
.cell-view,.cell-edit{display:inline-block;width:100%;font-size:.85rem;line-height:1.35;box-sizing:border-box;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding:0 2px!important;vertical-align:middle}
.cell-edit.form-control{height:calc(1.45em + .45rem + 2px)!important;padding:0 2px!important;font-size:.85rem!important;line-height:1.35!important;border-radius:0!important;box-sizing:border-box!important}
.edit-mode .cell-edit:not(.readonly-cell){border:1px solid #ccc!important;background:#fff!important}
.readonly-cell{background:#f3f3f3!important;color:#555!important;border:1px solid #ddd!important;cursor:not-allowed!important;pointer-events:none!important;user-select:none!important}
.table-fix-wrapper::-webkit-scrollbar{height:10px;width:10px}
.table-fix-wrapper::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:6px}
.table-fix-wrapper::-webkit-scrollbar-thumb:hover{background:#9ca3af}
#mainGrid tbody tr:hover {background-color: #f9f2d7 !important; cursor: pointer;}
#mainGrid tbody tr.selected-row {background-color: #fff3cd !important; transition: background-color .15s;}
table th{position:relative;}
.col-resizer{position:absolute;top:0;right:-3px;width:6px;cursor:col-resize;user-select:none;height:100%;}
#singleGridQueryModal .modal-dialog{max-width:900px;}
#singleGridQueryModal .modal-content{max-height:90vh;}
#singleGridQueryModal .modal-body{max-height:70vh; overflow-y:auto; padding-bottom:1rem;}
#singleGridQueryModal .form-label{font-size:.9rem;}
#singleGridQueryModal .form-control{font-size:.9rem;}
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="~/js/gridToolbarTemplate.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const editBtn = document.getElementById("btnEditToggle");
  const saveBtn = document.getElementById("btnSaveTable");
  const delBtn  = document.getElementById("btnDeleteRow");
  const wrapper = document.querySelector(".table-wrapper");
  const table   = document.getElementById("mainGrid");
  const ocxLookupMaps = @Html.Raw(JsonSerializer.Serialize(ocxLookupPayload));
  const customButtonsMeta = @Html.Raw(JsonSerializer.Serialize(customButtonMeta ?? new List<object>()));
  const fieldFormatMap = @Html.Raw(JsonSerializer.Serialize(
    dictFields.Select(f => new {
      FieldName = f.FieldName,
      DataType = f.DataType,
      FormatStr = f.FormatStr
    })
  ));
  const customButtonBar = document.getElementById("customButtonBar");
  let lookupMaps = ocxLookupMaps || {};
  let isEdit = false;

  // 取得鍵欄位（支援 window.KEY_FIELDS / ViewData["KeyFields"] / 預設）
  const KEY_FIELDS = (() => {
    if (Array.isArray(window.KEY_FIELDS) && window.KEY_FIELDS.length)
      return window.KEY_FIELDS.map(s => String(s).toLowerCase());

    const fromView = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(keyFieldsFromViewData));
    if (Array.isArray(fromView) && fromView.length)
      return fromView.map(s => String(s).toLowerCase());

    return ["buid","itemid","id","papernum","systemcode"];
  })();

  const findButtonMeta = (btnName) => {
    if (!btnName || !Array.isArray(customButtonsMeta)) return null;
    const target = btnName.toLowerCase();
    return customButtonsMeta.find(b => ((b.buttonName || b.ButtonName || "")?.toLowerCase() === target)) || null;
  };

  const readRowData = (tr) => {
    const obj = {};
    if (!tr) return obj;
    tr.querySelectorAll("td[data-field]").forEach(td => {
      const field = td.dataset.field || "";
      if (!field) return;
      const inp = td.querySelector(".cell-edit");
      const span = td.querySelector(".cell-view");
      obj[field] = inp?.value ?? span?.textContent ?? "";
    });
    return obj;
  };

  const resolveCustomHandler = (btnName) => {
    if (!btnName) return null;
    const map = window.SingleGridCustomHandlers || {};
    const itemId = window._singleItemId || "";
    if (map[itemId] && typeof map[itemId][btnName] === "function") return map[itemId][btnName];
    if (typeof map[btnName] === "function") return map[btnName];
    return null;
  };

  const buildCustomButtonsFromMeta = () => {
    if (!customButtonBar || customButtonBar.childElementCount > 0) return;
    const autoBuild = customButtonBar.dataset.autoBuild === "1";
    if (!autoBuild || !Array.isArray(customButtonsMeta) || customButtonsMeta.length === 0) return;
    customButtonsMeta.forEach(b => {
      if (b.bVisible === 0 || b.bVisible === "0") return;
      const btnName = b.buttonName || b.ButtonName || "";
      if (!btnName) return;
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn btn-outline-secondary btn-sm";
      btn.dataset.customBtn = "1";
      btn.dataset.buttonName = btnName;
      btn.dataset.itemId = b.itemId || b.ItemId || "";
      const caption = (b.custCaption || b.CustCaption || btnName || "").toString();
      const hint = (b.custHint || b.CustHint || "").toString();
      btn.textContent = caption;
      if (hint) btn.title = hint;
      customButtonBar.appendChild(btn);
    });
  };

  const wireCustomButtons = () => {
    if (!customButtonBar) return;
    customButtonBar.querySelectorAll("[data-custom-btn]").forEach(btn => {
      if (btn.dataset.cbBound === "1") return;
      btn.dataset.cbBound = "1";
      btn.addEventListener("click", () => {
        const name = btn.dataset.buttonName || btn.dataset.customBtn || "";
        if (!name) return;
        const handler = resolveCustomHandler(name);
        const meta = findButtonMeta(name);
        const ctx = {
          buttonName: name,
          itemId: window._singleItemId || "",
          tableName: window._singleRealTable || window._dictTableName || table?.dataset?.dictTable || "",
          meta,
          selectedRow: readRowData(window.SELECTED_ROW)
        };
        if (!handler) {
          alert(`尚未實作: ${name}`);
          return;
        }
        try {
          handler(ctx);
        } catch (err) {
          console.error("custom button handler error", err);
          alert(`執行失敗: ${err?.message || err}`);
        }
      });
    });
  };

    const formatByDict = (fieldName, rawVal) => {
    if (rawVal == null) return "";
    const meta = fieldFormatMap?.find?.(x => (x.FieldName || "").toLowerCase() === (fieldName || "").toLowerCase());
    const fmt = (meta?.FormatStr || "").toString();
    if (!fmt) return String(rawVal);
    const fmtLower = fmt.toLowerCase();
    const dt = (meta?.DataType || "").toString().toLowerCase();
    const isDate = dt.includes("date") || fmtLower.includes("y");
    const isNumber = dt.includes("decimal") || dt.includes("numeric") || dt.includes("money")
      || dt.includes("float") || dt.includes("real") || dt.includes("int") || dt.includes("number");
    if (isNumber) {
      const rawText = String(rawVal);
      const normalized = rawText.replace(/,/g, "");
      if (/^-?\d+(\.\d+)?$/.test(normalized)) {
        if (normalized.includes(".")) {
          const trimmed = normalized.replace(/0+$/, "").replace(/\.$/, "");
          return trimmed;
        }
        return normalized;
      }
      return rawText;
    }
    if (!isDate) return String(rawVal);

    const hasTime = fmtLower.includes("hh") || fmtLower.includes("nn") || fmtLower.includes("ss");
    const rawText = String(rawVal);
    const normalized = rawText.replace("上午", "AM").replace("下午", "PM");
    const date = new Date(normalized);
    if (isNaN(date)) {
      if (!hasTime) {
        const m = rawText.match(/(\d{4})[/-](\d{1,2})[/-](\d{1,2})/);
        if (m) {
          const y = m[1];
          const mm = String(m[2]).padStart(2, '0');
          const dd = String(m[3]).padStart(2, '0');
          return `${y}/${mm}/${dd}`;
        }
      }
      return rawText;
    }
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    if (!hasTime) return `${y}/${m}/${d}`;
    const hh = String(date.getHours()).padStart(2, '0');
    const mm = String(date.getMinutes()).padStart(2, '0');
    const ss = String(date.getSeconds()).padStart(2, '0');
    return `${y}/${m}/${d} ${hh}:${mm}:${ss}`;
  };

  const lookupDisplay = (fieldName, rawVal, fallback, lookupKey) => {
    const key = String(lookupKey ?? rawVal ?? "");
    const map = lookupMaps[fieldName?.toLowerCase?.()]?.map;
    if (!fieldName || key === "" || !map) return formatByDict(fieldName, rawVal) || fallback || "";
    if (Object.prototype.hasOwnProperty.call(map, key)) {
      return map[key] ?? fallback ?? key;
    }
    return formatByDict(fieldName, rawVal) || fallback || "";
  };

  const applyLookupToTable = () => {
    table.querySelectorAll("tbody tr").forEach(tr => {
      tr.querySelectorAll("td").forEach(td => {
        const field = td.dataset.field || "";
        const span = td.querySelector(".cell-view");
        const inp  = td.querySelector(".cell-edit");
        if (!span || !inp) return;
        const rawVal = inp.dataset.raw ?? inp.value;
        const lkVal  = inp.dataset.lookupkey ?? rawVal;
        span.textContent = lookupDisplay(field, rawVal, span.textContent, lkVal);
      });
    });
  };

  // 修改/檢視切換
  editBtn.addEventListener("click", () => {
    isEdit = !isEdit;
    editBtn.innerHTML = isEdit
      ? '<i class="bi bi-eye me-1"></i> 檢視'
      : '<i class="bi bi-pencil-square me-1"></i> 修改';

    wrapper.classList.toggle("edit-mode", isEdit);
    saveBtn.classList.toggle("d-none", !isEdit);

    if (isEdit) {
      table.querySelectorAll(".cell-edit").forEach(inp => {
        inp.defaultValue = inp.value;
      });
    }

    table.querySelectorAll("tbody tr").forEach(tr => {
      tr.querySelectorAll("td").forEach(td => {
        const span = td.querySelector(".cell-view");
        const inp  = td.querySelector(".cell-edit");
        if (!span || !inp) return;

        if (isEdit) {
          span.classList.add("d-none");
          inp.classList.remove("d-none");
          if (inp.dataset.readonly === "1") {
            inp.classList.add("readonly-cell");
            inp.setAttribute("readonly", "readonly");
            inp.setAttribute("tabindex", "-1");
          } else {
            inp.classList.remove("readonly-cell");
            inp.removeAttribute("readonly");
            inp.removeAttribute("tabindex");
          }
        } else {
          inp.dataset.raw = inp.value;
          span.textContent = lookupDisplay(td.dataset.field, inp.value, span.textContent, inp.dataset.lookupkey);
          span.classList.remove("d-none");
          inp.classList.add("d-none");
        }
      });
    });
  });

  // 儲存
  saveBtn.addEventListener("click", async () => {
    const changes = collectChanges();
    if (changes.length === 0) { return; }

    const resp = await fetch('/api/CommonTable/SaveTableChanges', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        TableName: "@tableName",
        KeyFields: KEY_FIELDS,  // ★ 明確告知後端主鍵欄位
        Data: changes
      })
    });

    if (resp.ok) {
      Swal.fire({ icon: 'success', title: '儲存成功', timer: 1000, showConfirmButton: false });

      changes.forEach(change => {
        const targetRow = findRowByKeys(change);
        if (!targetRow) return;

        for (const [field, newVal] of Object.entries(change)) {
          const cell = targetRow.querySelector(`td[data-field="${field}"]`);
          if (!cell) continue;
          const inp  = cell.querySelector(".cell-edit");
          const span = cell.querySelector(".cell-view");
          if (inp)  inp.defaultValue = newVal;
          if (span) span.textContent  = lookupDisplay(field, newVal, span.textContent, inp?.dataset.lookupkey ?? newVal);
        }
      });
    } else {
      Swal.fire({ icon: 'error', title: '儲存失敗', text: await resp.text() });
    }
  });

  // 依複合鍵找列
  async function deleteSelectedRow() {
    const tr = window.SELECTED_ROW;
    if (!tr) {
      Swal.fire({ icon: 'warning', title: '\u8acb\u5148\u9078\u53d6\u4e00\u7b46\u8cc7\u6599' });
      return;
    }

    const keyValues = {};
    KEY_FIELDS.forEach(k => {
      const inp = Array.from(tr.querySelectorAll('.cell-edit')).find(i => (i.name || '').toLowerCase() === k);
      if (!inp) return;
      keyValues[inp.name] = inp.defaultValue ?? inp.value ?? "";
    });

    const missingKeys = KEY_FIELDS.filter(k => !Object.keys(keyValues).some(n => n.toLowerCase() === k));
    if (missingKeys.length) {
      Swal.fire({
        icon: 'error',
        title: '\u522a\u9664\u5931\u6557',
        text: `\u7f3a\u5c11\u4e3b\u9375/\u7d22\u5f15\u6b04\u4f4d: ${missingKeys.join(', ')}`
      });
      return;
    }

    const ok = await Swal.fire({
      icon: 'warning',
      title: '\u78ba\u5b9a\u8981\u522a\u9664\u9019\u4e00\u7b46\u55ce\uff1f',
      showCancelButton: true,
      confirmButtonText: '\u522a\u9664',
      cancelButtonText: '\u53d6\u6d88',
      confirmButtonColor: '#dc3545'
    });
    if (!ok.isConfirmed) return;

    const resp = await fetch('/api/CommonTable/SaveTableChanges', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        TableName: "@tableName",
        KeyFields: KEY_FIELDS,
        Data: [{ __delete: true, ...keyValues }]
      })
    });

    if (!resp.ok) {
      Swal.fire({ icon: 'error', title: '\u522a\u9664\u5931\u6557', text: await resp.text() });
      return;
    }

    let affected = null;
    try {
      const json = await resp.json();
      affected = json?.results?.[0]?.affected ?? null;
    } catch { }

    tr.remove();
    window.SELECTED_ROW = null;

    if (typeof affected === 'number' && affected > 1) {
      Swal.fire({
        icon: 'warning',
        title: '\u522a\u9664\u5b8c\u6210',
        text: `\u6ce8\u610f\uff1a\u5f71\u97ff\u884c\u6578 = ${affected}\uff0c\u5efa\u8b70\u91cd\u65b0\u67e5\u8a62\u78ba\u8a8d`
      });
    } else {
      Swal.fire({ icon: 'success', title: '\u522a\u9664\u5b8c\u6210', timer: 900, showConfirmButton: false });
    }
  }

  if (delBtn) {
    if (window.createGridController) {
      window.createGridController({ name: 'singleGridDelete', btnDelete: delBtn, onDelete: deleteSelectedRow });
    } else {
      delBtn.addEventListener('click', deleteSelectedRow);
    }
  }

  function findRowByKeys(change) {
    const rows = Array.from(table.querySelectorAll("tbody tr"));
    return rows.find(tr => {
      return KEY_FIELDS.every(k => {
        const inp = Array.from(tr.querySelectorAll('.cell-edit')).find(i => i.name.toLowerCase() === k);
        if (!inp) return false;
        const changeVal = change[k];
        if (changeVal == null) return false;
        return String(inp.value) === String(changeVal) || String(inp.defaultValue) === String(changeVal);
      });
    });
  }

  // 收集變更（只傳送鍵欄位 + 真正有變更的欄位）
  function collectChanges() {
    const list = [];
    document.querySelectorAll("#mainGrid tbody tr").forEach(tr => {
      const changed = {};
      const keys = {};
      let hasDiff = false;

      tr.querySelectorAll(".cell-edit").forEach(inp => {
        const name = inp.name;
        if (!name) return;

        const oldVal = inp.defaultValue ?? "";
        const newVal = inp.value ?? "";
        const isReadonly = inp.dataset.readonly === "1";
        const isKey = KEY_FIELDS.includes(name.toLowerCase());

        // 鍵欄位一定要帶
        if (isKey) {
          keys[name] = newVal;
          return;
        }

        // 唯讀欄位跳過
        if (isReadonly) return;

        // 只收集有變更的欄位
        if (newVal !== oldVal) {
          hasDiff = true;
          changed[name] = newVal;
        }
      });

      if (!hasDiff) return;

      // 合併鍵欄位 + 變更欄位
      list.push({ ...keys, ...changed });
    });
    return list;
  }

  table.addEventListener("click", (ev) => {
    const tr = ev.target.closest("tbody tr");
    if (!tr) return;
    table.querySelectorAll("tbody tr").forEach(r => r.classList.remove("selected-row", "table-active"));
    tr.classList.add("selected-row", "table-active");
    window.SELECTED_ROW = tr;
  });

  applyLookupToTable();
  buildCustomButtonsFromMeta();
  wireCustomButtons();

  // 共用狀態變數
  let isSorting = false; // 防止重複請求（排序、分頁共用）
  let currentSortBy = '@(ViewData["SortBy"] as string ?? "")';
  let currentSortDir = '@(ViewData["SortDir"] as string ?? "")';

  // 分頁控制
  const pagerPrev = document.getElementById("pagerPrev");
  const pagerNext = document.getElementById("pagerNext");
  const pagerLast = document.getElementById("pagerLast");
  const pagerFirst = document.getElementById("pagerFirst");
  const pagerPageSize = document.getElementById("pagerPageSize");
  const pagerCurrentEl = document.getElementById("pagerCurrent");
  const pagerTotalEl = document.getElementById("pagerTotal");
  let currentPage = parseInt(pagerCurrentEl?.textContent || "1", 10);
  let totalPages = parseInt(pagerTotalEl?.textContent || "1", 10);
  let pageSize = @pageSize;
  const pagerGoInput = document.getElementById("pagerGoInput");
  const pagerGoBtn = document.getElementById("pagerGoBtn");
  const btnOpenQuery = document.getElementById("btnOpenQuery");
  const queryModalEl = document.getElementById("singleGridQueryModal");
  const queryForm = document.getElementById("singleGridQueryForm");
  const btnQuerySubmit = document.getElementById("btnQuerySubmit");
  const fallbackQueryFields = @Html.Raw(JsonSerializer.Serialize(
    fields.Select(f => new {
      ColumnName = f.FieldName,
      ColumnCaption = f.DisplayLabel,
      DataType = f.DataType,
      DefaultEqual = "like"
    })
  ));

  // 更新分頁資訊
  function updatePager(newPage, newPageSize, newTotalCount) {
    currentPage = newPage;
    pageSize = newPageSize;
    totalPages = Math.max(1, Math.ceil(newTotalCount / newPageSize));

    // 更新 DOM
    if (pagerCurrentEl) pagerCurrentEl.textContent = currentPage;
    if (pagerTotalEl) pagerTotalEl.textContent = totalPages;
    if (pagerGoInput) {
      pagerGoInput.value = currentPage;
      pagerGoInput.max = totalPages;
    }

    // 更新按鈕狀態
    if (pagerFirst) pagerFirst.disabled = currentPage <= 1;
    if (pagerPrev) pagerPrev.disabled = currentPage <= 1;
    if (pagerNext) pagerNext.disabled = currentPage >= totalPages;
    if (pagerLast) pagerLast.disabled = currentPage >= totalPages;
  }

  async function goPage(p) {
    console.log('[goPage] Called with p =', p, 'currentPage =', currentPage, 'totalPages =', totalPages);

    if (!Number.isFinite(p) || p < 1) {
      console.log('[goPage] Invalid page number, returning');
      return;
    }

    if (isSorting) {
      console.log('[goPage] Already sorting, returning');
      return;
    }

    isSorting = true;
    showLoading();
    console.log('[goPage] Starting page change to', p);

    try {
      const newPageSize = pagerPageSize ? parseInt(pagerPageSize.value) : pageSize;

      // 呼叫 AJAX API
      const urlObj = new URL(window.location.href);
      urlObj.searchParams.set("handler", "Data");
      urlObj.searchParams.set("pageIndex", String(p));
      urlObj.searchParams.set("pageSize", String(newPageSize));
      if (currentSortBy) urlObj.searchParams.set("sortBy", currentSortBy);
      else urlObj.searchParams.delete("sortBy");
      if (currentSortDir) urlObj.searchParams.set("sortDir", currentSortDir);
      else urlObj.searchParams.delete("sortDir");
      const url = urlObj.toString();

      console.log('[goPage] Fetching URL:', url);
      const response = await fetch(url);

      if (!response.ok) {
        throw new Error('HTTP error! status: ' + response.status);
      }

      const data = await response.json();
      console.log('[goPage] Response data:', data);

      if (!data.success) {
        throw new Error(data.error || 'Unknown error');
      }

      // 更新表格
      const fields = @Html.Raw(JsonSerializer.Serialize(Model.TableFields));
      updateTableBody(data.items, fields);
      applyLookupToTable(); // 套用 lookup 顯示
      console.log('[goPage] Table updated with', data.items.length, 'items');

      // 更新分頁資訊
      updatePager(data.pageNumber, newPageSize, data.totalCount);
      console.log('[goPage] Pager updated: page', data.pageNumber, 'of', totalPages);

    } catch (err) {
      console.error('[goPage] Page change failed:', err);
      alert('換頁失敗：' + err.message);
    } finally {
      hideLoading();
      isSorting = false;
      console.log('[goPage] Finished');
    }
  }

  pagerFirst?.addEventListener("click", (e) => {
    console.log('[pagerFirst] Clicked');
    e.preventDefault();
    goPage(1);
  });
  pagerPrev?.addEventListener("click", (e) => {
    console.log('[pagerPrev] Clicked, disabled =', e.currentTarget.disabled, 'currentPage =', currentPage);
    e.preventDefault();
    if (!e.currentTarget.disabled) goPage(currentPage - 1);
  });
  pagerNext?.addEventListener("click", (e) => {
    console.log('[pagerNext] Clicked, disabled =', e.currentTarget.disabled, 'currentPage =', currentPage);
    e.preventDefault();
    if (!e.currentTarget.disabled) goPage(currentPage + 1);
  });
  pagerLast?.addEventListener("click", (e) => {
    console.log('[pagerLast] Clicked, disabled =', e.currentTarget.disabled, 'totalPages =', totalPages);
    e.preventDefault();
    if (!e.currentTarget.disabled) goPage(totalPages);
  });
  pagerPageSize?.addEventListener("change", () => {
    console.log('[pagerPageSize] Changed');
    goPage(1);
  });
  pagerGoBtn?.addEventListener("click", () => {
    const v = parseInt(pagerGoInput?.value || "1", 10);
    console.log('[pagerGoBtn] Clicked, value =', v);
    if (Number.isFinite(v)) goPage(Math.min(Math.max(1, v), totalPages));
  });
  pagerGoInput?.addEventListener("keyup", (e) => {
    if (e.key === "Enter") pagerGoBtn?.click();
  });

  // 查詢 modal
  let queryFieldsLoaded = false;
  async function loadQueryFields() {
    if (queryFieldsLoaded) return;
    const itemId = window._singleItemId || "";
    const table = window._singleRealTable || tableName;
    if (!itemId || !table) return;
    try {
      const res = await fetch(`/api/DictSetupApi/QueryFields?itemId=${encodeURIComponent(itemId)}&table=${encodeURIComponent(table)}&lang=TW`);
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      const list = Array.isArray(data) && data.length ? data : (fallbackQueryFields || []);
      buildQueryForm(list);
      queryFieldsLoaded = true;
    } catch (err) {
      console.warn("load query fields failed", err);
      if (fallbackQueryFields && fallbackQueryFields.length) {
        buildQueryForm(fallbackQueryFields);
        queryFieldsLoaded = true;
      }
    }
  }

  function buildQueryForm(fields) {
    if (!queryForm) return;
    queryForm.innerHTML = "";

    // 直接渲染所有查詢欄位
    fields.forEach(f => {
      const colName = f.columnName || f.ColumnName || "";
      if (!colName) return;
      const caption = f.columnCaption || f.ColumnCaption || colName;
      const defVal = f.defaultValue || f.DefaultValue || "";
      const defEq = (f.defaultEqual || f.DefaultEqual || "").toString().toLowerCase();
      const dtRaw = f.dataType ?? f.DataType;
      const dt = Number(dtRaw);

      const wrap = document.createElement("div");
      wrap.className = "col-md-4 col-sm-6";
      const label = document.createElement("label");
      label.className = "form-label text-muted";
      label.textContent = caption;
      const input = document.createElement("input");
      input.className = "form-control form-control-sm";
      input.name = colName;
      if (dt === 1) input.type = "date";
      else if (dt === 2) input.type = "number";
      else input.type = "text";
      if (defVal) input.value = defVal;
      if (defEq === "like") input.placeholder = "模糊查詢";

      wrap.appendChild(label);
      wrap.appendChild(input);
      queryForm.appendChild(wrap);
    });
  }

  btnOpenQuery?.addEventListener("click", async () => {
    await loadQueryFields();
    if (queryModalEl && window.bootstrap) {
      const modal = bootstrap.Modal.getOrCreateInstance(queryModalEl);
      modal.show();
    }
  });

  // 清除查詢條件
  const btnClearQuery = document.getElementById("btnClearQuery");
  btnClearQuery?.addEventListener("click", () => {
    if (queryForm) {
      Array.from(queryForm.elements).forEach(el => {
        if (el.tagName === "INPUT") el.value = "";
      });
    }
  });

  const submitQueryForm = () => {
    if (!queryForm) return;
    const url = new URL(window.location.href);
    // 保留 pageSize，其餘重新以 pageIndex=1
    url.searchParams.delete("pageIndex");
    url.searchParams.set("pageIndex", "1");
    // 移除排序參數（排序已改用 AJAX，不需要在網址中）
    url.searchParams.delete("sortBy");
    url.searchParams.delete("sortDir");

    // 收集查詢欄位
    Array.from(queryForm.elements).forEach(el => {
      if (!el.name) return;
      const val = el.value?.toString() ?? "";
      if (val) url.searchParams.set(el.name, val);
      else url.searchParams.delete(el.name);
    });

    window.location.href = url.toString();
  };

  btnQuerySubmit?.addEventListener("click", () => submitQueryForm());
  queryForm?.addEventListener("submit", (e) => {
    e.preventDefault();
    submitQueryForm();
  });

  // 欄寬拖拉
  const colGroupCols = Array.from(table.querySelectorAll("colgroup col"));
  const ths = Array.from(table.querySelectorAll("thead th"));
  const dictName = window._dictTableName || table.dataset.dictTable || dictTableName || table.dataset.table || table.dataset.dict || "";
  const tableName = dictName;
  const colMap = {};
  colGroupCols.forEach(col => {
    const field = col.getAttribute("data-field");
    if (field) colMap[field.toLowerCase()] = col;
  });

  let dragState = null;
  ths.forEach(th => {
    const field = th.getAttribute("data-field");
    const resizer = th.querySelector(".col-resizer");
    if (!field || !resizer) return;
    resizer.addEventListener("mousedown", (e) => {
      e.preventDefault();
      const col = colMap[field.toLowerCase()];
      const startX = e.clientX;
      const startWidth = (col?.getBoundingClientRect().width) || th.getBoundingClientRect().width;
      dragState = { field, startX, startWidth };
      document.body.style.cursor = "col-resize";
    });
  });

  document.addEventListener("mousemove", (e) => {
    if (!dragState) return;
    const delta = e.clientX - dragState.startX;
    const newW = Math.max(40, dragState.startWidth + delta);
    const col = colMap[dragState.field.toLowerCase()];
    if (col) {
      col.style.width = `${newW}px`;
      col.style.minWidth = `${newW}px`;
      col.style.maxWidth = `${newW}px`;
    }
    // apply to header cell for visual feedback
    const th = ths.find(t => (t.getAttribute("data-field") || "").toLowerCase() === dragState.field.toLowerCase());
    if (th) th.style.width = `${newW}px`;
  });

  document.addEventListener("mouseup", async () => {
    if (!dragState) return;
    const col = colMap[dragState.field.toLowerCase()];
    const th = ths.find(t => (t.getAttribute("data-field") || "").toLowerCase() === dragState.field.toLowerCase());
    const width = col?.getBoundingClientRect().width || th?.getBoundingClientRect().width || dragState.startWidth;
    dragState = null;
    document.body.style.cursor = "";
    if (!tableName) return;
    try {
      await fetch("/api/DictSetupApi/FieldWidth/Save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          tableName: tableName,
          fieldName: th?.getAttribute("data-field") || "",
          widthPx: Math.round(width)
        })
      });
    } catch (err) {
      console.warn("save width failed", err);
    }
  });

  // ===== AJAX 排序功能 =====
  const headers = document.querySelectorAll(".sortable-header .header-label");
  const sortTableBody = document.querySelector("#mainGrid tbody");
  const tableWrapper = document.querySelector(".table-fix-wrapper");

  // Loading overlay
  const loadingOverlay = document.createElement('div');
  loadingOverlay.className = 'table-loading-overlay';
  loadingOverlay.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
  loadingOverlay.style.cssText = 'position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,0.8);z-index:1000;';
  tableWrapper?.appendChild(loadingOverlay);

  // 顯示 Loading
  function showLoading() {
    if (loadingOverlay) loadingOverlay.style.display = 'flex';
  }

  // 隱藏 Loading
  function hideLoading() {
    if (loadingOverlay) loadingOverlay.style.display = 'none';
  }

  // 更新排序圖示
  function updateSortIcons(fieldName, sortDir) {
    document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = '');
    const th = document.querySelector(`.sortable-header[data-field="${fieldName}"]`);
    if (th) {
      const icon = th.querySelector('.sort-icon');
      if (icon) icon.textContent = sortDir === 'desc' ? '▼' : '▲';
    }
  }

  // 更新表格內容
  function updateTableBody(items, fields) {
    const tbody = sortTableBody || document.querySelector("#mainGrid tbody");
    if (!tbody) return;

    if (!items || items.length === 0) {
      tbody.innerHTML = '<tr><td colspan="' + fields.length + '" class="text-center text-muted py-3">（無資料）</td></tr>';
      return;
    }

    const ocxLookupPayload = @Html.Raw(JsonSerializer.Serialize(ocxLookupPayload));

    tbody.innerHTML = items.map(item => {
      return '<tr>' + fields.map(f => {
        const fieldName = f.FieldName;
        const rawVal = item[fieldName] ?? item[fieldName?.toLowerCase()] ?? '';
        const isHidden = f.Visible == 0;
        const hiddenStyle = isHidden ? 'display:none;' : '';
        const isReadOnly = f.ReadOnly != null && f.ReadOnly != 0;
        const dt = (f.DataType || '').toString().toLowerCase();
        const isNumber = dt.includes('number') || dt.startsWith('decimal') || dt.startsWith('numeric')
          || dt.startsWith('money') || dt.startsWith('smallmoney') || dt.startsWith('float') || dt.startsWith('real')
          || dt.startsWith('int') || dt.startsWith('smallint') || dt.startsWith('tinyint') || dt.startsWith('bigint');
        const cellClass = isNumber ? 'cell-number' : 'cell-text';

        // 計算 lookupKey（與初始渲染邏輯一致）
        let lookupKey = rawVal;
        const ocxLookup = ocxLookupPayload[fieldName?.toLowerCase()];
        if (ocxLookup) {
          const keyFieldName = ocxLookup.keyField;
          const keySelfName = ocxLookup.keySelf;

          let keyFieldVal = '';
          let keySelfVal = '';

          if (keyFieldName) {
            const kfVal = item[keyFieldName] ?? item[keyFieldName?.toLowerCase()];
            keyFieldVal = (kfVal !== null && kfVal !== undefined) ? String(kfVal) : '';
          }
          if (keySelfName) {
            const ksVal = item[keySelfName] ?? item[keySelfName?.toLowerCase()];
            keySelfVal = (ksVal !== null && ksVal !== undefined) ? String(ksVal) : '';
          }

          // 優先使用 keyFieldVal，其次 keySelfVal，最後才用 rawVal
          // 這樣可以確保 lookup 欄位（如 StatusName）能用對應的 key 欄位（如 Status）的值
          if (keyFieldVal !== '') {
            lookupKey = keyFieldVal;
          } else if (keySelfVal !== '') {
            lookupKey = keySelfVal;
          } else if (lookupKey === '' && rawVal !== null && rawVal !== undefined) {
            lookupKey = String(rawVal);
          }
        }

        // 簡單格式化
        let displayVal = rawVal;
        const dateFormatMode = window._singleGridDateFormat || '';
        const formatDateValue = (val, dateOnly) => {
          const date = new Date(val);
          if (isNaN(date)) {
            if (dateOnly) {
              const m = String(val).match(/(\d{4})[/-](\d{1,2})[/-](\d{1,2})/);
              if (m) {
                const y = m[1];
                const mm = String(m[2]).padStart(2, '0');
                const dd = String(m[3]).padStart(2, '0');
                return `${y}/${mm}/${dd}`;
              }
            }
            return String(val);
          }
          const y = date.getFullYear();
          const m = String(date.getMonth() + 1).padStart(2, '0');
          const d = String(date.getDate()).padStart(2, '0');
          if (dateOnly || dateFormatMode === 'date') return `${y}/${m}/${d}`;
          const hh = String(date.getHours()).padStart(2, '0');
          const mm = String(date.getMinutes()).padStart(2, '0');
          const ss = String(date.getSeconds()).padStart(2, '0');
          return `${y}/${m}/${d} ${hh}:${mm}:${ss}`;
        };

        if (rawVal instanceof Date || (typeof rawVal === 'string' && rawVal.match(/^\d{4}-\d{2}-\d{2}/))) {
          const fmtMeta = fieldFormatMap?.find?.(x => (x.FieldName || "").toLowerCase() === (fieldName || "").toLowerCase());
          const fmt = (fmtMeta?.FormatStr || "").toString();
          const fmtLower = fmt.toLowerCase();
          const hasTime = fmtLower.includes("hh") || fmtLower.includes("nn") || fmtLower.includes("ss");
          if (fmt) displayVal = formatDateValue(rawVal, !hasTime);
          else if (dateFormatMode) displayVal = formatDateValue(rawVal, true);
          else {
            const date = new Date(rawVal);
            if (!isNaN(date)) {
              displayVal = date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
            }
          }
        } else if (typeof rawVal === 'number') {
          displayVal = rawVal.toLocaleString('zh-TW');
        }

        // 安全處理值，避免 0 被視為 falsy
        const safeRawVal = (rawVal !== null && rawVal !== undefined) ? String(rawVal) : '';
        const safeLookupKey = (lookupKey !== null && lookupKey !== undefined) ? String(lookupKey) : '';
        const safeDisplayVal = (displayVal !== null && displayVal !== undefined) ? String(displayVal) : '';

        // 產生與初始渲染一致的結構，包含 data-field, cell-view, cell-edit
        return '<td class="text-nowrap ' + cellClass + '" data-field="' + fieldName + '" style="' + hiddenStyle + '">' +
          '<span class="cell-view" data-raw="' + safeRawVal + '" data-lookupkey="' + safeLookupKey + '">' + safeDisplayVal + '</span>' +
          '<input class="form-control form-control-sm cell-edit d-none ' + (isReadOnly ? 'readonly-cell' : '') + '" ' +
          'name="' + fieldName + '" ' +
          'value="' + safeRawVal + '" ' +
          'data-raw="' + safeRawVal + '" ' +
          'data-lookupkey="' + safeLookupKey + '" ' +
          'data-readonly="' + (isReadOnly ? '1' : '0') + '" ' +
          (isReadOnly ? 'readonly' : '') + ' />' +
          '</td>';
      }).join('') + '</tr>';
    }).join('');
  }

  // AJAX 排序處理
  async function handleSort(fieldName) {
    if (isSorting) return;
    isSorting = true;
    showLoading();

    try {
      // 處理 Lookup 欄位：先計算實際要排序的欄位名稱
      let actualFieldName = fieldName;
      if (fieldName.endsWith('Name')) {
        const baseFieldName = fieldName.substring(0, fieldName.length - 4);
        // 檢查這個基礎欄位是否存在
        const fields = @Html.Raw(JsonSerializer.Serialize(Model.TableFields));
        const baseField = fields.find(f => f.FieldName === baseFieldName);
        if (baseField) {
          actualFieldName = baseFieldName;
        }
      }

      // 決定新的排序方向（使用實際欄位名稱比較）
      let newSortDir = 'asc';
      if (currentSortBy === actualFieldName) {
        newSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
      }

      // 呼叫 AJAX API
      const urlObj = new URL(window.location.href);
      urlObj.searchParams.set("handler", "Data");
      urlObj.searchParams.set("sortBy", actualFieldName);
      urlObj.searchParams.set("sortDir", newSortDir);
      urlObj.searchParams.set("pageIndex", "1");
      const url = urlObj.toString();
      const response = await fetch(url);

      if (!response.ok) {
        throw new Error('HTTP error! status: ' + response.status);
      }

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'Unknown error');
      }

      // 更新表格
      const fields = @Html.Raw(JsonSerializer.Serialize(Model.TableFields));
      updateTableBody(data.items, fields);
      applyLookupToTable(); // 套用 lookup 顯示

      // 更新排序狀態（使用實際傳送的欄位名稱）
      currentSortBy = actualFieldName;
      currentSortDir = newSortDir;
      updateSortIcons(fieldName, newSortDir);

    } catch (err) {
      console.error('Sort failed:', err);
      alert('排序失敗：' + err.message);
    } finally {
      hideLoading();
      isSorting = false;
    }
  }

  // 綁定點擊事件
  headers.forEach(headerLabel => {
    headerLabel.addEventListener("click", (e) => {
      e.stopPropagation(); // 防止觸發 col-resizer
      const th = headerLabel.closest("th");
      const fieldName = th?.getAttribute("data-field");
      if (fieldName) handleSort(fieldName);
    });
  });
});
</script>
