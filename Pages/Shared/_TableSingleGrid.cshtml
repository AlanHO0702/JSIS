@using System.Reflection
@using Microsoft.AspNetCore.Html
@using System.Text.Json
@using System.Linq
@using System.Collections
@using System.Collections.Generic
@using PcbErpApi.Helpers
@model dynamic

@{
    var tableName     = (string)(Model.TableName ?? "");
    var items         = (IEnumerable<object>)(Model.Items ?? new List<object>());
    var fields        = (IEnumerable<dynamic>)(Model.TableFields ?? new List<object>());
    var customButtons = ViewData["CustomButtons"] as HtmlString;
    var customButtonMeta = ViewData["CustomButtonMeta"] as IEnumerable<dynamic>;
    var hasServerButtons = customButtons != null && !string.IsNullOrWhiteSpace(customButtons.ToString());
    var hasCustomMeta = customButtonMeta != null && customButtonMeta.Cast<object>().Any();
    var autoBuildCustomButtons = !hasServerButtons && hasCustomMeta;
    var hasData       = items.Any();
    var hideToolbar = (ViewData["HideSingleGridToolbar"] as bool?)
        ?? string.Equals(ViewData["HideSingleGridToolbar"]?.ToString(), "true", StringComparison.OrdinalIgnoreCase);
    var keyFieldsFromViewData = (IEnumerable<string>)(ViewData["KeyFields"] as IEnumerable<string> ?? Array.Empty<string>());
    var dictFields    = (IEnumerable<dynamic>)(ViewData["FieldDictList"] as IEnumerable<dynamic> ?? fields);
    var dictTableName = (string?)(ViewData["DictTableName"] as string) ?? tableName;
    var enableRowDelete = (ViewData["EnableRowDelete"] as bool?)
        ?? (string.Equals(ViewData["EnableRowDelete"]?.ToString(), "true", StringComparison.OrdinalIgnoreCase)
            || string.Equals(ViewData["EnableRowDelete"]?.ToString(), "1", StringComparison.OrdinalIgnoreCase));
    var ocxLookupsRaw = ViewData["OCXLookups"] as IEnumerable<dynamic>;
    var ocxLookupPayload = ocxLookupsRaw?.ToDictionary(
        k => ((string)k.FieldName).ToLowerInvariant(),
        v => (object)new { keySelf = v.KeySelfName as string ?? "", keyField = v.KeyFieldName as string ?? "", map = v.LookupValues }
    ) ?? new Dictionary<string, object>();
    var toolbarButtonVisibility = ViewData["ToolbarButtonVisibility"] as Dictionary<string, bool>
        ?? new Dictionary<string, bool>(StringComparer.OrdinalIgnoreCase);
    bool IsToolbarVisible(string name) => !toolbarButtonVisibility.TryGetValue(name, out var visible) || visible;
    var showBtnInq = IsToolbarVisible("btnInq");
    var showBtnToExcel = IsToolbarVisible("btnToExcel");
    var showBtnUpdate = IsToolbarVisible("btnUpdate");
    var hidePager = (ViewData["HideSingleGridPager"] as bool?)
        ?? string.Equals(ViewData["HideSingleGridPager"]?.ToString(), "true", StringComparison.OrdinalIgnoreCase);

    // OpenNoRecord 模式：開啟時不自動載入資料
    var openNoRecord = ViewData["OpenNoRecord"] as bool? ?? false;
    var hasQueryParams = ViewData["HasQueryParams"] as bool? ?? false;
    var emptyMessage = (openNoRecord && !hasQueryParams) ? "（請先使用查詢功能）" : "（無資料）";

    int pageNumber = 1;
    int pageSize = 0;
    int totalCount = 0;
    try { pageNumber = (int)(Model.PageNumber ?? 1); } catch { }
    try { pageSize = (int)(Model.PageSize ?? 0); } catch { }
    try { totalCount = (int)(Model.TotalCount ?? 0); } catch { }
    if (pageSize <= 0) pageSize = Math.Max(1, items.Count());
    if (totalCount <= 0) totalCount = items.Count();
    var totalPages = Math.Max(1, (int)Math.Ceiling(totalCount / (double)pageSize));

    var isViewOnly = (ViewData["IsViewOnly"] as bool?) ?? false;
}

@functions{
    private static string Fmt(object? v) => v switch
    {
        DateTime dt  => dt.ToString("yyyy/MM/dd HH:mm"),
        decimal dec  => dec.ToString("#,##0.##"),
        double d     => d.ToString("#,##0.##"),
        float f      => f.ToString("#,##0.##"),
        IFormattable fm => fm.ToString(null, System.Globalization.CultureInfo.InvariantCulture),
        _ => v?.ToString() ?? ""
    };

    // 將 DisplaySize（字數概念）換成像素欄寬
    private static int ToColWidthPx(dynamic f, int pxPerChar = 10)
    {
        try
        {
            var raw = f?.DisplaySize;
            if (raw == null) return 0;

            if (raw is int i && i > 0) return i * pxPerChar;

            int n;
            var s = raw.ToString();
            if (int.TryParse(s, out n) && n > 0) return n * pxPerChar;

            return 0;
        }
        catch { return 0; }
    }

    // �s�� dictionary/dynamic object �W�٬�����
    private static object? GetValue(object item, string? name)
    {
        if (item == null || string.IsNullOrWhiteSpace(name)) return null;

        if (item is IDictionary dict)
        {
            foreach (var k in dict.Keys)
            {
                if (k is string ks && string.Equals(ks, name, StringComparison.OrdinalIgnoreCase))
                    return dict[k];
            }
        }

        var prop = item.GetType().GetProperty(name!, BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase);
        return prop?.GetValue(item);
    }

    private static bool ToBool(object? raw, bool defaultValue)
    {
        if (raw == null) return defaultValue;

        return raw switch
        {
            bool b => b,
            byte b => b != 0,
            sbyte b => b != 0,
            short n => n != 0,
            ushort n => n != 0,
            int n => n != 0,
            uint n => n != 0,
            long n => n != 0,
            ulong n => n != 0,
            decimal n => n != 0m,
            double n => Math.Abs(n) > double.Epsilon,
            float n => Math.Abs(n) > float.Epsilon,
            _ => ParseBool(raw.ToString(), defaultValue)
        };

        static bool ParseBool(string? text, bool fallback)
        {
            var s = text?.Trim();
            if (string.IsNullOrWhiteSpace(s)) return fallback;

            if (bool.TryParse(s, out var b)) return b;
            if (int.TryParse(s, out var n)) return n != 0;
            if (string.Equals(s, "Y", StringComparison.OrdinalIgnoreCase)) return true;
            if (string.Equals(s, "N", StringComparison.OrdinalIgnoreCase)) return false;

            return fallback;
        }
    }

    private static string GetFieldProp(object? field, string propName)
    {
        if (field == null || string.IsNullOrWhiteSpace(propName)) return "";
        if (field is IDictionary dict)
        {
            foreach (var k in dict.Keys)
            {
                if (k is string ks && string.Equals(ks, propName, StringComparison.OrdinalIgnoreCase))
                {
                    var v = dict[k];
                    return v?.ToString() ?? "";
                }
            }
        }

        var prop = field.GetType().GetProperty(propName, BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase);
        return prop?.GetValue(field)?.ToString() ?? "";
    }

    private static string FormatCell(object? value, object field)
    {
        var dataType = GetFieldProp(field, "DataType");
        var formatStr = GetFieldProp(field, "FormatStr");
        if (string.IsNullOrWhiteSpace(formatStr) && TryGetDecimalScale(dataType, out _) && TryToDecimal(value, out var dec))
        {
            return dec.ToString("###,###,##0.########", System.Globalization.CultureInfo.CurrentCulture);
        }

        var formatted = FormatHelper.FormatValue(value, dataType, formatStr);
        if (IsNumberDataType(field) || IsDecimalString(formatted))
            return TrimZeroDecimal(formatted);
        return formatted;
    }

    private static bool IsNumberDataType(object field)
    {
        var dt = GetFieldProp(field, "DataType").Trim().ToLowerInvariant();
        if (string.IsNullOrWhiteSpace(dt)) return false;
        return dt == "number"
            || dt.StartsWith("decimal") || dt.StartsWith("numeric")
            || dt.StartsWith("money") || dt.StartsWith("smallmoney")
            || dt.StartsWith("float") || dt.StartsWith("real")
            || dt.StartsWith("int") || dt.StartsWith("smallint")
            || dt.StartsWith("tinyint") || dt.StartsWith("bigint");
    }

    private static bool TryGetDecimalScale(string? dataType, out int scale)
    {
        scale = 0;
        if (string.IsNullOrWhiteSpace(dataType)) return false;
        var s = dataType.Trim().ToLowerInvariant();
        if (!(s.StartsWith("decimal") || s.StartsWith("numeric"))) return false;
        var l = s.IndexOf('(');
        var r = s.IndexOf(')');
        if (l < 0 || r <= l) return true;
        var inner = s.Substring(l + 1, r - l - 1);
        var parts = inner.Split(',');
        if (parts.Length == 2 && int.TryParse(parts[1].Trim(), out var parsed))
        {
            scale = Math.Max(0, parsed);
        }
        return true;
    }

    private static bool TryToDecimal(object? value, out decimal dec)
    {
        dec = 0m;
        if (value == null) return false;
        if (value is System.Text.Json.JsonElement je)
        {
            if (je.ValueKind == System.Text.Json.JsonValueKind.Number && je.TryGetDecimal(out var d))
            {
                dec = d;
                return true;
            }
            if (je.ValueKind == System.Text.Json.JsonValueKind.String)
                value = je.GetString();
        }
        if (value is decimal d0)
        {
            dec = d0;
            return true;
        }
        if (value is IConvertible)
        {
            try
            {
                dec = Convert.ToDecimal(value, System.Globalization.CultureInfo.CurrentCulture);
                return true;
            }
            catch { }
        }
        if (value is string s)
        {
            return decimal.TryParse(s, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.CurrentCulture, out dec)
                || decimal.TryParse(s, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out dec);
        }
        return false;
    }

    private static string TrimZeroDecimal(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return text;
        var sep = System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator;
        var idx = text.IndexOf(sep, StringComparison.Ordinal);
        if (idx < 0) return text;
        var end = text.Length - 1;
        while (end > idx && text[end] == '0') end--;
        if (end == idx) return text.Substring(0, idx);
        return text.Substring(0, end + 1);
    }

    private static bool IsDecimalString(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return false;
        var sep = System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator;
        var s = text.Trim();
        if (s.StartsWith("+", StringComparison.Ordinal) || s.StartsWith("-", StringComparison.Ordinal))
            s = s.Substring(1);
        var idx = s.IndexOf(sep, StringComparison.Ordinal);
        if (idx <= 0 || idx >= s.Length - 1) return false;
        var left = s.Substring(0, idx);
        var right = s.Substring(idx + 1);
        if (left.Length == 0 || right.Length == 0) return false;
        foreach (var c in left)
        {
            if (!char.IsDigit(c)) return false;
        }
        foreach (var c in right)
        {
            if (!char.IsDigit(c)) return false;
        }
        return true;
    }
}

<style>
  .sortable-header .header-label {
    user-select: none;
  }
  .sortable-header:hover {
    background: #e8f4fd !important;
    cursor: pointer;
  }
  .sort-icon {
    display: inline-block;
    margin-left: 4px;
    color: #0d6efd;
    font-size: 0.75em;
  }
  .col-resizer {
    cursor: col-resize;
  }

  /* 資料數量顯示框 */
  .toolbar-count-box {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    height: 31px;
    min-width: 74px;
    padding: 2px 8px;
    border-radius: 6px;
    font-weight: 700;
    line-height: 1.05;
    color: #fff;
    background: #1e4db7;
    user-select: none;
    font-size: 14px;
  }
  .toolbar-count-box.mode-edit,
  .toolbar-count-box.mode-view {
    background: #1e4db7;
  }
  .count-line {
    text-align: center;
  }
</style>

<div class="table-wrapper">
  <div class="card shadow-sm border-0">
    <div class="card-body">

        @if (!hideToolbar)
        {
        <div class="top-toolbar singlegrid-toolbar">
          <div class="toolbar-icon-row" role="group" aria-label="row-nav-and-actions">
            <button id="sgFirst" type="button" class="btn toolbar-btn toolbar-btn-icon" title="第一筆" aria-label="第一筆"><i class="bi bi-chevron-bar-left toolbar-icon"></i></button>
            <button id="sgPrev" type="button" class="btn toolbar-btn toolbar-btn-icon" title="上一筆" aria-label="上一筆"><i class="bi bi-chevron-left toolbar-icon"></i></button>
            <button id="sgNext" type="button" class="btn toolbar-btn toolbar-btn-icon" title="下一筆" aria-label="下一筆"><i class="bi bi-chevron-right toolbar-icon"></i></button>
            <button id="sgLast" type="button" class="btn toolbar-btn toolbar-btn-icon" title="最後一筆" aria-label="最後一筆"><i class="bi bi-chevron-bar-right toolbar-icon"></i></button>
            <button id="sgAdd" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add" title="新增" aria-label="新增" disabled><span class="toolbar-icon">+</span></button>
            <button id="sgDelete" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-del" title="刪除" aria-label="刪除" disabled @(enableRowDelete ? "" : "data-lock='1'")><span class="toolbar-icon">-</span></button>
            <button id="sgSave" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add toolbar-btn-check" title="儲存" aria-label="儲存" disabled><span class="toolbar-icon">✓</span></button>
            <button id="sgCancel" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-cancel toolbar-btn-check" title="取消" aria-label="取消" disabled><span class="toolbar-icon">&times;</span></button>
          </div>
          <div class="toolbar-main">
            <div class="d-flex gap-2 flex-wrap align-items-center">
              <div id="singleGridCountBox" class="toolbar-count-box mode-view">
                <div id="singleGridMode" class="count-line">瀏覽模式</div>
                <div id="singleGridCount" class="count-line">0 / 0</div>
              </div>
            <button id="btnOpenQuery" type="button" class="btn toolbar-btn @(showBtnInq ? "" : "d-none")" data-toolbar-btn="btnInq">
              <i class="bi bi-search"></i>查詢
            </button>
            <button id="btnExportExcel" type="button" class="btn toolbar-btn @(showBtnToExcel ? "" : "d-none")" data-toolbar-btn="btnToExcel">
              <i class="bi bi-file-earmark-excel"></i>Excel
            </button>
            <button id="btnEditToggle" type="button" class="btn toolbar-btn @(showBtnUpdate ? "" : "d-none")" data-toolbar-btn="btnUpdate">
              <i class="bi bi-pencil-square"></i>修改
            </button>
            </div>
          </div>
          <div class="d-flex justify-content-end gap-2"></div>
        </div>
        }
        @if (enableRowDelete)
        {
          <button id="btnDeleteRow" type="button" class="btn d-none">
            &#21034;&#38500;
          </button>
        }

      <div class="table-fix-wrapper" data-dict-table="@dictTableName">
        <table class="table table-bordered table-hover table-sm align-middle mb-0" id="mainGrid" data-dict-table="@dictTableName" style="table-layout:fixed;width:100%">
          <colgroup>
            @foreach (var f in fields)
            {
              var w = ToColWidthPx(f, 10);
              var isHidden = !ToBool(f.Visible, defaultValue: true);
              var hiddenStyle = isHidden ? "display:none;" : "";
              if (w > 0)
              { <col data-field="@f.FieldName" style="@hiddenStyle width:@($"{w}px");min-width:@($"{w}px");max-width:@($"{w}px")" /> }
              else
              { <col data-field="@f.FieldName" style="@hiddenStyle" /> }
            }
          </colgroup>

          <thead class="table-light sticky-top">
            <tr>
              @foreach (var f in fields)
              {
                var isHidden = !ToBool(f.Visible, defaultValue: true);
                var hiddenStyle = isHidden ? "display:none;" : "";
                var currentSortBy = ViewData["SortBy"] as string;
                var currentSortDir = ViewData["SortDir"] as string;
                var isSorted = string.Equals(currentSortBy, f.FieldName, StringComparison.OrdinalIgnoreCase);
                var sortIcon = isSorted ? (currentSortDir == "desc" ? "▼" : "▲") : "";

                <th class="text-nowrap sortable-header" data-field="@f.FieldName" style="cursor:pointer;@hiddenStyle">
                  <span class="header-label">@((string)f.DisplayLabel) <span class="sort-icon">@sortIcon</span></span>
                  <span class="col-resizer" data-field="@f.FieldName"></span>
                </th>
              }
            </tr>
          </thead>

          <tbody>
            @if (!hasData)
            {
              <tr><td colspan="@fields.Count()" class="text-center text-muted py-3">@emptyMessage</td></tr>
            }
            else
            {
              @foreach (var item in items)
              {
                <tr>
                  @foreach (var f in fields)
                  {
                      var dictField = dictFields.FirstOrDefault(df =>
                          string.Equals(Convert.ToString(df.FieldName), Convert.ToString(f.FieldName), StringComparison.OrdinalIgnoreCase));
                      string? name = Convert.ToString(f.FieldName);
                      var value = GetValue(item, name);
                      var rawVal = value?.ToString() ?? "";
                      var displayValue = FormatCell(value, dictField ?? f);
                      var lookupKey = rawVal;
                      var keyFieldVal = "";
                      var keySelfVal = "";

                      bool isReadOnly = ToBool(f.ReadOnly, defaultValue: false);
                      bool isHidden = !ToBool(f.Visible, defaultValue: true);
                      var hiddenStyle = isHidden ? "display:none;" : "";

                      // 依 OCX 設定帶出 key 欄位，讓 lookup 有依據
                      if (!string.IsNullOrWhiteSpace(name) && ocxLookupsRaw is not null)
                      {
                          var lk = ocxLookupsRaw.FirstOrDefault(x =>
                              string.Equals((string?)x.FieldName, name, StringComparison.OrdinalIgnoreCase));
                          var keyFieldName = lk?.KeyFieldName as string;
                          var keySelfName = lk?.KeySelfName as string;

                          if (!string.IsNullOrWhiteSpace(keyFieldName))
                          {
                              var keyVal = GetValue(item, keyFieldName);
                              keyFieldVal = keyVal?.ToString() ?? "";
                          }
                          if (!string.IsNullOrWhiteSpace(keySelfName))
                          {
                              var keyVal = GetValue(item, keySelfName);
                              keySelfVal = keyVal?.ToString() ?? "";
                          }

                          if (string.IsNullOrWhiteSpace(lookupKey))
                              lookupKey = !string.IsNullOrWhiteSpace(keyFieldVal) ? keyFieldVal : keySelfVal;
                      }

                      var cellClass = IsNumberDataType(dictField ?? f) ? "cell-number" : "cell-text";
                      <td class="text-nowrap @cellClass @(isReadOnly ? "readonly-td" : "")" data-field="@name" style="@hiddenStyle">
                        <span class="cell-view @(isReadOnly ? "readonly-cell" : "")" data-raw="@rawVal" data-lookupkey="@lookupKey">@displayValue</span>
                        <input class="form-control form-control-sm cell-edit d-none @(isReadOnly ? "readonly-cell" : "")"
                               name="@name"
                               value="@rawVal"
                               data-raw="@rawVal"
                               data-lookupkey="@lookupKey"
                               data-readonly="@(isReadOnly ? "1" : "0")"
                               @(isReadOnly ? "readonly" : "") />
                      </td>
                  }
                </tr>
              }
            }
          </tbody>
        </table>
      </div>

      <div id="customButtonBarBottom" class="d-flex gap-2 flex-wrap my-2" data-auto-build="@(autoBuildCustomButtons ? "1" : "0")">
        @if (hasServerButtons)
        {
            @customButtons
        }
      </div>

      @if (!hidePager && totalPages > 1)
      {
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="pagerFirst" @(pageNumber <= 1 ? "disabled" : "")>|&laquo;</button>
            <button class="btn btn-outline-secondary btn-sm" id="pagerPrev" @(pageNumber <= 1 ? "disabled" : "")>&laquo;</button>
            <span>Page: <strong id="pagerCurrent">@pageNumber</strong> / <span id="pagerTotal">@totalPages</span></span>
            <button class="btn btn-outline-secondary btn-sm" id="pagerNext" @(pageNumber >= totalPages ? "disabled" : "")>&raquo;</button>
            <button class="btn btn-outline-secondary btn-sm" id="pagerLast" @(pageNumber >= totalPages ? "disabled" : "")>&raquo;|</button>
          </div>
          <div class="d-flex align-items-center gap-2">
            <label class="mb-0 text-muted">Go to:</label>
            <input id="pagerGoInput" type="number" min="1" max="@totalPages" class="form-control form-control-sm" style="width:80px" value="@pageNumber" />
            <button class="btn btn-outline-primary btn-sm" id="pagerGoBtn">Go</button>
          </div>
          <div class="d-flex align-items-center gap-2">
            <label class="mb-0 text-muted">Page size:</label>
            <select id="pagerPageSize" class="form-select form-select-sm" style="width:auto">
              @{
                  var sizes = new[] { 20, 50, 100, 200, 500 };
                  foreach (var s in sizes)
                  {
                      <option value="@s" selected="@(s == pageSize ? "selected" : null)">@s</option>
                  }
              }
            </select>
            <span class="text-muted">Total: @totalCount</span>
          </div>
        </div>
      }
    </div>
  </div>
</div>

<!-- Query Modal -->
<div class="modal fade" id="singleGridQueryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    @await Html.PartialAsync("~/Pages/Shared/_QueryPanelPartial.cshtml", (object)(Model.QueryFields ?? new List<object>()))
  </div>
</div>

<!-- CondRunSp Modal -->
<div class="modal fade" id="condRunSpModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog cond-runsp-dialog">
    <div class="modal-content cond-runsp-modal">
      <div class="modal-header">
        <h5 class="modal-title">輸入條件</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form class="cond-runsp-form"></form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success crs-confirm">確定</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<style>
 .table-fix-wrapper{flex:1;overflow:auto;background:#fff;border:1px solid #dee2e6;border-radius:.5rem;white-space:nowrap;min-height:0}
 .table-wrapper{height:calc(100vh - var(--app-toolbar-height, 56px));display:flex;flex-direction:column}
 .table-wrapper>.card{flex:1;display:flex;flex-direction:column;min-height:0}
 .table-wrapper>.card>.card-body{flex:1;display:flex;flex-direction:column;min-height:0;padding-top:12px;padding-bottom:8px}
 table.table{table-layout:fixed!important;border-collapse:collapse!important;font-size:.85rem;width:100%}
 table th,table td{vertical-align:middle!important;border:1px solid #dee2e6!important;padding:0!important;white-space:nowrap}
 table th{padding:2px 6px!important}
 .table-hover tbody tr:hover{background:#f1f5ff!important}
.cell-view,.cell-edit{display:block;width:100%;height:20px!important;min-height:20px!important;max-height:20px!important;font-size:.85rem;line-height:16px!important;box-sizing:border-box;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding:2px 6px!important}
.cell-view{text-align:inherit;border:none!important;background:transparent!important}
.cell-edit.form-control{height:20px!important;min-height:20px!important;max-height:20px!important;padding:2px 6px!important;font-size:inherit!important;line-height:16px!important;text-align:inherit!important;border:none!important;border-radius:0!important;box-sizing:border-box!important;background:transparent!important;vertical-align:middle!important;margin:0!important}
.cell-number{text-align:right}
.cell-text{text-align:left}
table.table tbody td{background:#f3f3f3!important}
.edit-mode table.table tbody td{background:#fff!important}
.edit-mode table.table tbody td.readonly-td{background:#f3f3f3!important}
.readonly-cell{color:#555!important;border:none!important;cursor:not-allowed!important;pointer-events:none!important;user-select:none!important}
.table-fix-wrapper::-webkit-scrollbar{height:10px;width:10px}
  .table-fix-wrapper::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:6px}
  .table-fix-wrapper::-webkit-scrollbar-thumb:hover{background:#9ca3af}
  #mainGrid tbody tr:hover {background-color: #e8f4ff !important; cursor: pointer;}
  #mainGrid tbody tr.selected-row {background-color: #d1e7ff !important; transition: background-color .15s;}
  #mainGrid tbody tr.selected-row td {background-color: #d1e7ff !important; border-color: transparent !important;}
  table th{position:relative;}
  .col-resizer{position:absolute;top:0;right:-3px;width:6px;cursor:col-resize;user-select:none;height:100%;}
  .top-toolbar{display:flex;align-items:center;gap:6px;flex-wrap:wrap;width:100%;margin-bottom:14px;border-radius:10px;background:#f6f7f9;border:1px solid #d8dee8;padding:6px 8px;box-shadow:0 1px 2px rgba(20,40,80,0.06)}
  .singlegrid-toolbar{--top-toolbar-icon-font-size: 20px;}
  .top-toolbar .toolbar-icon-row{display:flex;gap:4px;align-items:center}
  .top-toolbar .toolbar-main{display:flex;align-items:center;gap:6px;flex-wrap:nowrap;flex:1 1 0;min-width:0}
  .toolbar-btn{display:flex;align-items:center;gap:4px;background:#fff;color:#2a4a7a;border:1px solid #b9c7de;border-radius:11px;font-size:var(--top-toolbar-font-size);font-weight:500;padding:5px 10px;box-shadow:none;transition:background .18s, transform .11s, border-color .18s, color .18s;cursor:pointer}
  .toolbar-btn:hover,.toolbar-btn:focus{background:#eef3fb;border-color:#9fb2d2;transform:translateY(-1px) scale(1.02)}
  .toolbar-btn.primary{background:#2564b3;border-color:#2564b3;color:#fff;box-shadow:0 2px 8px rgba(37,100,179,0.25)}
  .toolbar-btn.primary:hover,.toolbar-btn.primary:focus{background:#215aa2;border-color:#215aa2;color:#fff}
  .toolbar-btn i{font-size:1.08em}
  .top-toolbar .toolbar-btn{font-size:var(--top-toolbar-font-size);height:var(--top-toolbar-btn-height);min-height:var(--top-toolbar-btn-height);padding:0 6px;line-height:1}
  .top-toolbar .toolbar-btn-icon{display:inline-flex;align-items:center;justify-content:center;height:var(--top-toolbar-btn-height);min-height:var(--top-toolbar-btn-height);padding:0;width:30px;border-radius:8px;font-size:var(--top-toolbar-icon-font-size);line-height:1;background:#fff;border:1px solid #b9c7de;color:#2a4a7a;box-shadow:none}
  .top-toolbar .toolbar-icon{display:inline-block;font-size:var(--top-toolbar-icon-font-size);line-height:1}
  .top-toolbar .toolbar-btn-icon i{font-size:var(--top-toolbar-icon-font-size);line-height:1}
  .top-toolbar .toolbar-btn:disabled{background:#f1f3f7 !important;border-color:#c5ccd8 !important;color:#9aa7bb !important;cursor:not-allowed;box-shadow:none;opacity:0.8}
  .top-toolbar .toolbar-btn-icon.toolbar-btn-add:not(:disabled){background:#f7fcf9;border-color:#7ccfa1;color:#1f7a45}
  .top-toolbar .toolbar-btn-icon.toolbar-btn-del:not(:disabled),
  .top-toolbar .toolbar-btn-icon.toolbar-btn-cancel:not(:disabled){background:#fff4f4;border-color:#e08a8a;color:#b33939}
  .top-toolbar .toolbar-btn-check,.top-toolbar .toolbar-btn-cancel{font-size:18px}
  .toolbar-count-box{display:inline-flex;flex-direction:column;justify-content:center;align-items:center;height:var(--top-toolbar-btn-height, 36px);min-width:74px;padding:2px 8px;border-radius:6px;font-weight:700;line-height:1.05;color:#fff;user-select:none}
  .toolbar-count-box .count-line{font-size:0.75rem}
  .toolbar-count-box.mode-view{background:#1e4db7}
  .toolbar-count-box.mode-edit{background:#f00000}
  .singlegrid-custom-btn{
    position:relative;
    padding:6px 10px;
    font-size:.92rem;
    letter-spacing:0;
    white-space:normal;
    word-break:break-word;
    background:#f8f9fb;
    color:#1f5fbf;
    font-weight:600;
    border-radius:10px;
    cursor:pointer;
    box-shadow:0 2px 8px rgba(20,40,80,.12);
    border:1px solid #cfd7e6;
  }
  .singlegrid-custom-btn:hover,
  .singlegrid-custom-btn:focus{
    background:#e9f1ff;
    border-color:#9fbaf0;
  }
  #singleGridQueryModal .modal-dialog{max-width:900px;width:90vw;}
  #singleGridQueryModal .modal-content{max-height:90vh;}
  #singleGridQueryModal .modal-body{max-height:70vh; overflow-y:auto; padding-bottom:1rem; display:flex; justify-content:center;}
  #singleGridQueryModal .query-field-grid{width:100%; max-width:720px; margin:0 auto;}
#singleGridQueryModal .form-label{font-size:.9rem;}
#singleGridQueryModal .form-control{font-size:.9rem;}
#singleGridQueryModal .query-footer { display: flex; align-items: center; justify-content: space-between; }
#singleGridQueryModal .query-footer-left { display: flex; gap: 6px; }
#singleGridQueryModal .query-footer-right { display: flex; gap: 8px; }
  #condRunSpModal .cond-runsp-dialog { --bs-modal-width: 520px; }
  #condRunSpModal .cond-runsp-modal { display: flex; flex-direction: column; }
  #condRunSpModal .modal-body { padding: 16px 18px; }
  #condRunSpModal .cond-runsp-form { display: flex; flex-direction: column; gap: 10px; }
  #condRunSpModal .crs-grid { display: grid; grid-template-columns: 1fr; gap: 10px 12px; }
  #condRunSpModal .crs-field { display: flex; align-items: center; gap: 8px; }
  #condRunSpModal .crs-label { white-space: nowrap; margin: 0; flex: 0 0 90px; text-align: right; font-size: var(--field-label-size); }
  #condRunSpModal .crs-control { flex: 1 1 auto; min-width: 0; font-size: var(--field-value-size); }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="~/js/gridToolbarTemplate.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const editBtn = document.getElementById("btnEditToggle");
    const saveBtn = document.getElementById("btnSaveTable");
    const delBtn  = document.getElementById("btnDeleteRow");
    const exportBtn = document.getElementById("btnExportExcel");
    const sgFirst = document.getElementById("sgFirst");
    const sgPrev = document.getElementById("sgPrev");
    const sgNext = document.getElementById("sgNext");
    const sgLast = document.getElementById("sgLast");
    const sgAdd = document.getElementById("sgAdd");
    const sgDelete = document.getElementById("sgDelete");
    const sgSave = document.getElementById("sgSave");
    const sgCancel = document.getElementById("sgCancel");
    const wrapper = document.querySelector(".table-wrapper");
    const modeEl = document.getElementById("singleGridMode");
    const countEl = document.getElementById("singleGridCount");
    const countBox = document.getElementById("singleGridCountBox");
  const table   = document.getElementById("mainGrid");
  const ocxLookupMaps = @Html.Raw(JsonSerializer.Serialize(ocxLookupPayload));
  const customButtonsMeta = @Html.Raw(JsonSerializer.Serialize(customButtonMeta ?? new List<object>()));
  const fieldFormatMap = @Html.Raw(JsonSerializer.Serialize(
    dictFields.Select(f => new {
      FieldName = f.FieldName,
      DataType = f.DataType,
      FormatStr = f.FormatStr
    })
  ));
    const customButtonBar = null;
    const customButtonBarBottom = document.getElementById("customButtonBarBottom");
    const dictTableName = "@dictTableName";
    let lookupMaps = ocxLookupMaps || {};
    let isEdit = false;
    let totalCountAll = @totalCount;
    let currentPage = @pageNumber;
    let pageSize = @pageSize;
    let totalPages = @totalPages;
    const openNoRecordInit = @(openNoRecord ? "true" : "false");
    const hasQueryParamsInit = @(hasQueryParams ? "true" : "false");
    let pendingSelect = "";
    let isDirty = false;

    const setModePanel = (editing) => {
      if (!modeEl) return;
      modeEl.textContent = editing ? "編輯模式" : "瀏覽模式";
      if (countBox) {
        countBox.classList.toggle("mode-edit", editing);
        countBox.classList.toggle("mode-view", !editing);
      }
      if (sgAdd) sgAdd.disabled = !editing;
      if (sgSave) sgSave.disabled = !editing || !isDirty;
      if (sgCancel) sgCancel.disabled = !editing || !isDirty;
      if (sgDelete) {
        const locked = sgDelete.dataset.lock === "1";
        sgDelete.disabled = !editing || locked;
      }
      if (sgFirst) sgFirst.disabled = false;
      if (sgPrev) sgPrev.disabled = false;
      if (sgNext) sgNext.disabled = false;
      if (sgLast) sgLast.disabled = false;
    };

    const updateCountPanel = (rowIdx) => {
      if (!countEl) return;
      const current = rowIdx > 0 ? rowIdx : 0;
      countEl.textContent = `${current} / ${totalCountAll || 0}`;
    };

    const setDirty = (dirty) => {
      isDirty = !!dirty;
      if (!isEdit) return;
      if (sgSave) sgSave.disabled = !isDirty;
      if (sgCancel) sgCancel.disabled = !isDirty;
    };

    const selectRow = (tr) => {
      if (!tr) return;
      table.querySelectorAll("tbody tr").forEach(r => r.classList.remove("selected-row", "table-active"));
      tr.classList.add("selected-row", "table-active");
      window.SELECTED_ROW = tr;
      try { tr.scrollIntoView({ block: "center", behavior: "auto" }); } catch { }
      updateCountPanel(getSelectedRowIndex());
    };

  // 取得鍵欄位（支援 window.KEY_FIELDS / ViewData["KeyFields"] / 預設）
    const KEY_FIELDS = (() => {
    if (Array.isArray(window.KEY_FIELDS) && window.KEY_FIELDS.length)
      return window.KEY_FIELDS.map(s => String(s).toLowerCase());

    const fromView = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(keyFieldsFromViewData));
    if (Array.isArray(fromView) && fromView.length)
      return fromView.map(s => String(s).toLowerCase());

    return ["buid","itemid","id","papernum","systemcode"];
    })();

    const getSelectedRowIndex = () => {
      if (!window.SELECTED_ROW) return 0;
      const rows = Array.from(table.querySelectorAll("tbody tr"));
      const localIdx = rows.indexOf(window.SELECTED_ROW);
      if (localIdx < 0) return 0;
      return (currentPage - 1) * pageSize + localIdx + 1;
    };

  const findButtonMeta = (btnName) => {
    if (!btnName || !Array.isArray(customButtonsMeta)) return null;
    const target = btnName.toLowerCase();
    return customButtonsMeta.find(b => ((b.buttonName || b.ButtonName || "")?.toLowerCase() === target)) || null;
  };

  const readRowData = (tr) => {
    const obj = {};
    if (!tr) return obj;
    tr.querySelectorAll("td[data-field]").forEach(td => {
      const field = td.dataset.field || "";
      if (!field) return;
      const inp = td.querySelector(".cell-edit");
      const span = td.querySelector(".cell-view");
      obj[field] = inp?.value ?? span?.textContent ?? "";
    });
    return obj;
  };

    const resolveCustomHandler = (btnName) => {
      if (!btnName) return null;
      const map = window.SingleGridCustomHandlers || {};
      const itemId = window._singleItemId || "";
      if (map[itemId] && typeof map[itemId][btnName] === "function") return map[itemId][btnName];
      if (typeof map[btnName] === "function") return map[btnName];
      return null;
    };

  const pickFieldCI = (row, names) => {
    if (!row) return "";
    const keys = Object.keys(row);
    for (const name of names) {
      const hit = keys.find(k => k.toLowerCase() === name.toLowerCase());
      if (hit) return row[hit];
    }
    return "";
  };

    const withJwtHeaders = (init = {}) => {
      const jwt = localStorage.getItem("jwtId");
      const headers = Object.assign({}, init.headers || {});
      if (jwt) headers["X-JWTID"] = jwt;
      return { ...init, headers };
    };

    const hasDateOnlyMask = (mask) => {
      const m = (mask || "").toString().toLowerCase();
      if (!m) return false;
      const isDate = m.includes("yyyy") && m.includes("mm") && m.includes("dd");
      const hasTime = m.includes("hh") || m.includes("ss") || m.includes("tt");
      return isDate && !hasTime;
    };

    const parseDateValue = (value) => {
      if (!value) return null;
      if (value instanceof Date && !isNaN(value)) return value;
      const s = String(value).trim();
      if (!s) return null;
      if (/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s.slice(0, 10));
      if (/^\d{4}[/.]\d{1,2}[/.]\d{1,2}$/.test(s)) {
        const [y, m, d] = s.split(/[/.]/).map(Number);
        return new Date(y, (m || 1) - 1, d || 1);
      }
      if (/^\d{8}$/.test(s)) {
        const y = Number(s.slice(0, 4));
        const m = Number(s.slice(4, 6));
        const d = Number(s.slice(6, 8));
        return new Date(y, (m || 1) - 1, d || 1);
      }
      const dt = new Date(s);
      return isNaN(dt) ? null : dt;
    };

    const formatDateByMask = (value, mask) => {
      const dt = parseDateValue(value);
      if (!dt) return value;
      const sep = (mask || "").includes("/") ? "/" : ((mask || "").includes(".") ? "." : "-");
      const y = dt.getFullYear();
      const m = String(dt.getMonth() + 1).padStart(2, "0");
      const d = String(dt.getDate()).padStart(2, "0");
      return `${y}${sep}${m}${sep}${d}`;
    };

    const applyEditMask = (value, editMask) => {
      if (hasDateOnlyMask(editMask)) return formatDateByMask(value, editMask);
      return value;
    };

    const condRunSp = (() => {
      const modalEl = document.getElementById("condRunSpModal");
      if (modalEl && modalEl.parentElement !== document.body) {
        document.body.appendChild(modalEl);
      }
      const formEl = modalEl?.querySelector(".cond-runsp-form");
      const btnConfirm = modalEl?.querySelector(".crs-confirm");
      const titleEl = modalEl?.querySelector(".modal-title");

      const state = {
        itemId: "",
        buttonName: "",
        paperNum: "",
        searchParams: [],
        inputs: {},
        selectedRow: {}
      };

      const normalizeKey = (name) => (name || "").replace(/^@@+/, "").toLowerCase();

      const loadParamOptions = async (itemId, buttonName, paramName, superValue) => {
        const extra = superValue ? `&superValue=${encodeURIComponent(superValue)}` : "";
        const url = `/api/PaperSearch/ParamOptionsV2?itemId=${encodeURIComponent(itemId)}&buttonName=${encodeURIComponent(buttonName)}&paramName=${encodeURIComponent(paramName)}${extra}`;
        const res = await fetch(url, withJwtHeaders());
        if (!res.ok) throw new Error(await res.text());
        return await res.json();
      };

      const getRowFieldValue = (row, field) => {
        if (!row || !field) return "";
        const key = String(field).toLowerCase();
        const hit = Object.keys(row).find(k => String(k).toLowerCase() === key);
        const val = hit ? row[hit] : "";
        return val == null ? "" : String(val).trim();
      };

      const getDefaultFromTableKind = (_tableKind, fieldName) => {
        if (!fieldName) return "";
        return getRowFieldValue(state.selectedRow, fieldName);
      };

      const getSuperValueCrs = (p) => {
        const rawSuperId = (p.SuperId || p.superId || "").toString().trim().replace(/^@@+/, "");
        const superKey = normalizeKey(rawSuperId);
        if (!superKey) return "";
        const superInput = formEl?.querySelector(`[data-param="${superKey}"]`);
        if (superInput && (superInput.value ?? "") !== "") return superInput.value ?? "";

        const rowVal = rawSuperId ? getRowFieldValue(state.selectedRow, rawSuperId) : "";
        if (rowVal) return rowVal;

        const superParam = (state.searchParams || []).find(sp => normalizeKey(sp.ParamName || sp.paramName) === superKey);
        if (!superParam) return "";
        const pv = superParam.ParamValue ?? superParam.paramValue;
        const fromKind = pv ? getDefaultFromTableKind(superParam.TableKind ?? superParam.tableKind, pv) : "";
        return fromKind || (superParam.DefaultValue ?? superParam.defaultValue ?? "");
      };

      const buildForm = async (itemId, buttonName) => {
        if (!formEl) return;
        formEl.innerHTML = "";
        const visibleParams = (state.searchParams || []).filter(p => Number(p.iVisible ?? p.IVisible ?? 0) === 1);
        if (!visibleParams.length) {
          formEl.innerHTML = '<div class="text-muted small">（沒有可輸入的條件）</div>';
          return;
        }

        const grid = document.createElement("div");
        grid.className = "crs-grid";
        formEl.appendChild(grid);

        for (const p of visibleParams) {
          const name = normalizeKey(p.ParamName || p.paramName);
          if (!name) continue;

          const wrap = document.createElement("div");
          wrap.className = "crs-field";
          const label = document.createElement("label");
          label.className = "form-label crs-label";
          label.textContent = p.DisplayName || p.displayName || name;
          wrap.appendChild(label);

          const controlType = Number(p.ControlType ?? p.controlType ?? 0);
          const tableKind = p.TableKind ?? p.tableKind;
          const paramValue = p.ParamValue ?? p.paramValue;
          const rowDefault = paramValue ? getDefaultFromTableKind(tableKind, paramValue) : "";

          if (controlType === 1) {
            const select = document.createElement("select");
            select.className = "form-select form-select-sm crs-control";
            select.setAttribute("data-param", name);
            const emptyOpt = document.createElement("option");
            emptyOpt.value = "";
            emptyOpt.textContent = "";
            select.appendChild(emptyOpt);
            wrap.appendChild(select);
            try {
              const superValue = getSuperValueCrs(p);
              const options = await loadParamOptions(itemId, buttonName, p.ParamName || p.paramName, superValue);
              if (Array.isArray(options)) {
                options.forEach(opt => {
                  const o = document.createElement("option");
                  const val = opt.value ?? opt.Value ?? "";
                  const text = opt.text ?? opt.Text ?? "";
                  o.value = val;
                  o.textContent = text ? `${val} ${text}`.trim() : val;
                  if (text && text !== val) o.title = text;
                  select.appendChild(o);
                });
              }
            } catch (err) {
              console.warn("load options failed", err);
            }
            const defVal = rowDefault || (p.DefaultValue ?? p.defaultValue);
            if (defVal != null && defVal !== "") {
              select.value = applyEditMask(defVal, p.EditMask ?? p.editMask);
              if (!select.value) {
                const o = document.createElement("option");
                o.value = defVal;
                o.textContent = defVal;
                select.appendChild(o);
                select.value = defVal;
              }
            }
            select.addEventListener("keydown", (ev) => {
              if (ev.key === "Delete" || ev.key === "Backspace") {
                select.value = "";
              }
            });
            const superKey = normalizeKey(p.SuperId || p.superId);
            if (superKey) {
              const superInput = formEl?.querySelector(`[data-param="${superKey}"]`);
              if (superInput && !select.dataset.superBound) {
                select.dataset.superBound = "1";
                superInput.addEventListener("change", async () => {
                  try {
                    const options = await loadParamOptions(itemId, buttonName, p.ParamName || p.paramName, superInput.value ?? "");
                    select.innerHTML = "";
                    const emptyOpt = document.createElement("option");
                    emptyOpt.value = "";
                    emptyOpt.textContent = "";
                    select.appendChild(emptyOpt);
                    if (Array.isArray(options)) {
                      options.forEach(opt => {
                        const o = document.createElement("option");
                        const val = opt.value ?? opt.Value ?? "";
                        const text = opt.text ?? opt.Text ?? "";
                        o.value = val;
                        o.textContent = text ? `${val} ${text}`.trim() : val;
                        if (text && text !== val) o.title = text;
                        select.appendChild(o);
                      });
                    }
                  } catch (err) {
                    console.warn("load options failed", err);
                  }
                });
              }
            }
          } else {
            const input = document.createElement("input");
            input.className = "form-control form-control-sm crs-control";
            input.type = "text";
            input.setAttribute("data-param", name);
            const defVal = rowDefault || (p.DefaultValue ?? p.defaultValue);
            if (defVal != null && defVal !== "") {
              input.value = applyEditMask(defVal, p.EditMask ?? p.editMask);
            }
            const readOnly = Number(p.iReadOnly ?? p.IReadOnly ?? 0) === 1;
            if (readOnly) input.readOnly = true;
            wrap.appendChild(input);
          }

          grid.appendChild(wrap);
        }
      };

      const collectInputs = () => {
        const values = {};
        (state.searchParams || []).forEach(p => {
          const name = normalizeKey(p.ParamName || p.paramName);
          if (!name) return;
          const input = formEl?.querySelector(`[data-param="${name}"]`);
          if (input) {
            values[name] = input.value ?? "";
            return;
          }
          const paramValue = p.ParamValue ?? p.paramValue;
          const fromRow = paramValue ? getRowFieldValue(state.selectedRow, paramValue) : "";
          const defVal = fromRow || (p.DefaultValue ?? p.defaultValue ?? p.ParamValue ?? p.paramValue);
          values[name] = defVal == null ? "" : defVal;
        });
        if (values.useid != null && String(values.useid).trim() === "") {
          values.useid = window.DEFAULT_USEID || window._useId || "A001";
        }
        state.inputs = values;
        return values;
      };

      const setConfirmLoading = (loading) => {
        if (!btnConfirm) return;
        btnConfirm.disabled = loading;
        btnConfirm.textContent = loading ? "執行中..." : "確定";
      };

      const runSp = async () => {
        setConfirmLoading(true);
        const payload = {
          itemId: state.itemId,
          buttonName: state.buttonName,
          paperNum: state.paperNum,
          params: collectInputs()
        };
        try {
          const res = await fetch("/api/PaperSearch/RunSpExec", withJwtHeaders({
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          }));
          const raw = await res.text();
          let data; try { data = JSON.parse(raw); } catch { data = { ok: false, error: raw }; }
          if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
          if (typeof goPage === "function") {
            goPage(currentPage);
          } else {
            location.reload();
          }
        } catch (err) {
          Swal.fire({ icon: "error", title: `執行失敗: ${err?.message || err}` });
        } finally {
          setConfirmLoading(false);
        }
      };

      const open = async (ctx, meta) => {
        if (!modalEl) return;
        state.itemId = ctx.itemId || "";
        state.buttonName = ctx.buttonName || "";
        state.paperNum = ctx.paperNum || "";
        state.selectedRow = ctx.selectedRow || {};

        const configUrl = `/api/PaperSearch/Config?itemId=${encodeURIComponent(state.itemId)}&buttonName=${encodeURIComponent(state.buttonName)}`;
        const res = await fetch(configUrl, withJwtHeaders());
        if (!res.ok) {
          Swal.fire({ icon: "error", title: await res.text() });
          return;
        }
        const cfg = await res.json();
        state.searchParams = cfg.searchParams || cfg.SearchParams || [];

        const caption = meta?.dialogCaption || cfg.dialogCaption || cfg.DialogCaption || ctx.caption || "輸入條件";
        if (titleEl) titleEl.textContent = caption;

        await buildForm(state.itemId, state.buttonName);
        if (window.bootstrap) {
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        }
      };

      btnConfirm?.addEventListener("click", (e) => { e.preventDefault(); runSp(); });

      return { open };
    })();

    const runCustomButton = async (meta, ctx) => {
      const btnName = ctx?.buttonName || "";
      const row = ctx?.selectedRow || {};
      if (!btnName) return;

      const needInEdit = (meta?.bNeedInEdit ?? meta?.BNeedInEdit ?? meta?.bNeedInEdit) || 0;
      if (String(needInEdit) === "1" && !isEdit) {
        Swal.fire({ icon: 'warning', title: '必須在「編輯中」才可使用此功能' });
        return;
      }

      const designType = meta?.DesignType ?? meta?.designType ?? 0;
      const searchTemplate = (meta?.SearchTemplate || meta?.searchTemplate || "").toString().toLowerCase();
      if (designType === 1 && searchTemplate === "jsdcondrunspdll.dll") {
        const paperNum = pickFieldCI(row, ["PaperNum", "PaperNUM", "PaperNo", "PaperNO"]);
        await condRunSp.open({ ...ctx, paperNum }, meta);
        return;
      }
      if (designType === 1 && searchTemplate) {
        Swal.fire({ icon: 'info', title: '此按鈕需使用模板功能', text: '請先在單據頁面使用此功能。' });
        return;
      }

      if (designType !== 3) {
        Swal.fire({ icon: 'info', title: '此按鈕尚未支援', text: `DesignType=${designType}` });
        return;
      }

      const paperNum = pickFieldCI(row, ["PaperNum", "PaperNUM", "PaperNo", "PaperNO"]);
      const payloadBase = {
        itemId: ctx.itemId || "",
        buttonName: btnName,
        paperNum: paperNum || "",
        tableName: ctx.tableName || "",
        paperMode: isEdit ? "UPDATE" : "BROWSE",
        userId: window._userId || localStorage.getItem('erpLoginUserId') || 'admin',
        useId: window._useId || 'A001',
        globalId: window._globalId || "",
        opKind: paperNum ? 1 : 0
      };

      const invoke = async (acceptConfirm) => {
        const resp = await fetch('/api/CustomButtonExec/Run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...payloadBase, acceptConfirm })
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || data.ok === false) {
          const msg = data.error || data.message || '執行失敗';
          Swal.fire({ icon: 'error', title: msg });
          return;
        }
        if (data.needConfirm) {
          const result = await Swal.fire({
            icon: 'question',
            title: data.message || '確認要執行？',
            showCancelButton: true,
            confirmButtonText: '確定',
            cancelButtonText: '取消'
          });
          if (result.isConfirmed) {
            await invoke(true);
          }
          return;
        }
        if (data.message) {
          Swal.fire({ icon: 'info', title: data.message });
        } else {
          Swal.fire({ icon: 'success', title: '已完成', timer: 900, showConfirmButton: false });
        }
        if (typeof goPage === "function") {
          goPage(currentPage);
        } else {
          location.reload();
        }
      };

      await invoke(false);
    };

    const buildCustomButtonsFromMeta = () => {
      const bars = [customButtonBar, customButtonBarBottom].filter(Boolean);
      if (bars.length === 0) return;
      const autoBuild = bars.some(b => b.dataset.autoBuild === "1");
      if (!autoBuild || !Array.isArray(customButtonsMeta) || customButtonsMeta.length === 0) return;

      bars.forEach(bar => {
        if (!bar || bar.childElementCount > 0) return;
        customButtonsMeta.forEach(b => {
          if (b.bVisible === 0 || b.bVisible === "0") return;
          const btnName = b.buttonName || b.ButtonName || "";
          if (!btnName) return;
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn btn-sm singlegrid-custom-btn";
          btn.dataset.customBtn = "1";
          btn.dataset.buttonName = btnName;
          btn.dataset.itemId = b.itemId || b.ItemId || "";
          const caption = (b.custCaption || b.CustCaption || btnName || "").toString();
          const hint = (b.custHint || b.CustHint || "").toString();
          btn.textContent = caption;
          if (hint) btn.title = hint;
          bar.appendChild(btn);
        });
      });
    };

    const wireCustomButtons = () => {
      const bars = [customButtonBar, customButtonBarBottom].filter(Boolean);
      if (bars.length === 0) return;
      bars.forEach(bar => bar.querySelectorAll("[data-custom-btn]").forEach(btn => {
        if (btn.dataset.cbBound === "1") return;
        btn.dataset.cbBound = "1";
        btn.addEventListener("click", () => {
          const name = btn.dataset.buttonName || btn.dataset.customBtn || "";
          if (!name) return;
          const handler = resolveCustomHandler(name);
          const meta = findButtonMeta(name);
          const ctx = {
            buttonName: name,
            itemId: window._singleItemId || "",
            tableName: window._singleRealTable || window._dictTableName || table?.dataset?.dictTable || "",
            meta,
            selectedRow: readRowData(window.SELECTED_ROW)
          };
          if (handler) {
            try {
              handler(ctx);
            } catch (err) {
              console.error("custom button handler error", err);
              alert(`執行失敗: ${err?.message || err}`);
            }
            return;
          }
          runCustomButton(meta, ctx);
        });
      }));
    };

    const formatByDict = (fieldName, rawVal) => {
    if (rawVal == null) return "";
    const meta = fieldFormatMap?.find?.(x => (x.FieldName || "").toLowerCase() === (fieldName || "").toLowerCase());
    const fmt = (meta?.FormatStr || "").toString();
    if (!fmt) return String(rawVal);
    const fmtLower = fmt.toLowerCase();
    const dt = (meta?.DataType || "").toString().toLowerCase();
    const isDate = dt.includes("date") || fmtLower.includes("y");
    const isNumber = dt.includes("decimal") || dt.includes("numeric") || dt.includes("money")
      || dt.includes("float") || dt.includes("real") || dt.includes("int") || dt.includes("number");
    if (isNumber) {
      const rawText = String(rawVal);
      const normalized = rawText.replace(/,/g, "");
      if (/^-?\d+(\.\d+)?$/.test(normalized)) {
        if (normalized.includes(".")) {
          const trimmed = normalized.replace(/0+$/, "").replace(/\.$/, "");
          return trimmed;
        }
        return normalized;
      }
      return rawText;
    }
    if (!isDate) return String(rawVal);

    const hasTime = fmtLower.includes("hh") || fmtLower.includes("nn") || fmtLower.includes("ss");
    const rawText = String(rawVal);
    const normalized = rawText.replace("上午", "AM").replace("下午", "PM");
    const date = new Date(normalized);
    if (isNaN(date)) {
      if (!hasTime) {
        const m = rawText.match(/(\d{4})[/-](\d{1,2})[/-](\d{1,2})/);
        if (m) {
          const y = m[1];
          const mm = String(m[2]).padStart(2, '0');
          const dd = String(m[3]).padStart(2, '0');
          return `${y}/${mm}/${dd}`;
        }
      }
      return rawText;
    }
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    if (!hasTime) return `${y}/${m}/${d}`;
    const hh = String(date.getHours()).padStart(2, '0');
    const mm = String(date.getMinutes()).padStart(2, '0');
    const ss = String(date.getSeconds()).padStart(2, '0');
    return `${y}/${m}/${d} ${hh}:${mm}:${ss}`;
  };

  const lookupDisplay = (fieldName, rawVal, fallback, lookupKey) => {
    const key = String(lookupKey ?? rawVal ?? "");
    const map = lookupMaps[fieldName?.toLowerCase?.()]?.map;
    if (!fieldName || key === "" || !map) return formatByDict(fieldName, rawVal) || fallback || "";
    if (Object.prototype.hasOwnProperty.call(map, key)) {
      return map[key] ?? fallback ?? key;
    }
    return formatByDict(fieldName, rawVal) || fallback || "";
  };

  const applyLookupToTable = () => {
    table.querySelectorAll("tbody tr").forEach(tr => {
      tr.querySelectorAll("td").forEach(td => {
        const field = td.dataset.field || "";
        const span = td.querySelector(".cell-view");
        const inp  = td.querySelector(".cell-edit");
        if (!span || !inp) return;
        const rawVal = inp.dataset.raw ?? inp.value;
        const lkVal  = inp.dataset.lookupkey ?? rawVal;
        span.textContent = lookupDisplay(field, rawVal, span.textContent, lkVal);
      });
    });
  };

  // 修改/檢視切換
    editBtn.addEventListener("click", () => {
      isEdit = !isEdit;
      editBtn.innerHTML = isEdit
        ? '<i class="bi bi-eye me-1"></i> 瀏覽'
        : '<i class="bi bi-pencil-square me-1"></i> 修改';

      wrapper.classList.toggle("edit-mode", isEdit);
      if (saveBtn) saveBtn.classList.toggle("d-none", !isEdit);
      setModePanel(isEdit);
      if (!isEdit) setDirty(false);

      if (isEdit) {
        table.querySelectorAll(".cell-edit").forEach(inp => {
          inp.defaultValue = inp.value;
        });
        setDirty(false);
      }

    table.querySelectorAll("tbody tr").forEach(tr => {
      tr.querySelectorAll("td").forEach(td => {
        const span = td.querySelector(".cell-view");
        const inp  = td.querySelector(".cell-edit");
        if (!span || !inp) return;

        if (isEdit) {
          if (inp.dataset.readonly === "1") {
            // readonly 欄位：維持顯示 span（lookup 值），隱藏 input
            span.classList.remove("d-none");
            inp.classList.add("d-none");
            inp.classList.add("readonly-cell");
            inp.setAttribute("readonly", "readonly");
            inp.setAttribute("tabindex", "-1");
          } else {
            // 可編輯欄位：顯示 input，隱藏 span
            span.classList.add("d-none");
            inp.classList.remove("d-none");
            inp.classList.remove("readonly-cell");
            inp.removeAttribute("readonly");
            inp.removeAttribute("tabindex");
          }
        } else {
          inp.dataset.raw = inp.value;
          span.textContent = lookupDisplay(td.dataset.field, inp.value, span.textContent, inp.dataset.lookupkey);
          span.classList.remove("d-none");
          inp.classList.add("d-none");
        }
      });
    });

    table.addEventListener("input", (e) => {
      if (!isEdit) return;
      const inp = e.target;
      if (!(inp instanceof HTMLInputElement)) return;
      if (!inp.classList.contains("cell-edit")) return;
      if (inp.dataset.readonly === "1") return;
      setDirty(true);
    });
  });

  // 儲存
    const saveTableChanges = async () => {
      const changes = collectChanges();
      if (changes.length === 0) { return; }

    const resp = await fetch('/api/CommonTable/SaveTableChanges', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        TableName: "@tableName",
        KeyFields: KEY_FIELDS,  // ★ 明確告知後端主鍵欄位
        Data: changes
      })
    });

      if (resp.ok) {
      Swal.fire({ icon: 'success', title: '儲存成功', timer: 1000, showConfirmButton: false });

      changes.forEach(change => {
        const targetRow = findRowByKeys(change);
        if (!targetRow) return;

        for (const [field, newVal] of Object.entries(change)) {
          const cell = targetRow.querySelector(`td[data-field="${field}"]`);
          if (!cell) continue;
          const inp  = cell.querySelector(".cell-edit");
          const span = cell.querySelector(".cell-view");
          if (inp)  inp.defaultValue = newVal;
          if (span) span.textContent  = lookupDisplay(field, newVal, span.textContent, inp?.dataset.lookupkey ?? newVal);
        }
      });
      setDirty(false);
      } else {
        Swal.fire({ icon: 'error', title: '儲存失敗', text: await resp.text() });
      }
    };
    if (saveBtn) {
      saveBtn.addEventListener("click", saveTableChanges);
    }

  // 依複合鍵找列
  async function deleteSelectedRow() {
    if (delBtn && delBtn.disabled) return; // 防止 disabled 按鈕被點擊
    const tr = window.SELECTED_ROW;
    if (!tr) {
      Swal.fire({ icon: 'warning', title: '\u8acb\u5148\u9078\u53d6\u4e00\u7b46\u8cc7\u6599' });
      return;
    }

    const keyValues = {};
    KEY_FIELDS.forEach(k => {
      const inp = Array.from(tr.querySelectorAll('.cell-edit')).find(i => (i.name || '').toLowerCase() === k);
      if (!inp) return;
      keyValues[inp.name] = inp.defaultValue ?? inp.value ?? "";
    });

    const missingKeys = KEY_FIELDS.filter(k => !Object.keys(keyValues).some(n => n.toLowerCase() === k));
    if (missingKeys.length) {
      Swal.fire({
        icon: 'error',
        title: '\u522a\u9664\u5931\u6557',
        text: `\u7f3a\u5c11\u4e3b\u9375/\u7d22\u5f15\u6b04\u4f4d: ${missingKeys.join(', ')}`
      });
      return;
    }

    const ok = await Swal.fire({
      icon: 'warning',
      title: '\u78ba\u5b9a\u8981\u522a\u9664\u9019\u4e00\u7b46\u55ce\uff1f',
      showCancelButton: true,
      confirmButtonText: '\u522a\u9664',
      cancelButtonText: '\u53d6\u6d88',
      confirmButtonColor: '#dc3545'
    });
    if (!ok.isConfirmed) return;

    const resp = await fetch('/api/CommonTable/SaveTableChanges', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        TableName: "@tableName",
        KeyFields: KEY_FIELDS,
        Data: [{ __delete: true, ...keyValues }]
      })
    });

    if (!resp.ok) {
      Swal.fire({ icon: 'error', title: '\u522a\u9664\u5931\u6557', text: await resp.text() });
      return;
    }

    let affected = null;
    try {
      const json = await resp.json();
      affected = json?.results?.[0]?.affected ?? null;
    } catch { }

      tr.remove();
      window.SELECTED_ROW = null;
      if (totalCountAll > 0) totalCountAll -= 1;
      updateCountPanel(0);

    if (typeof affected === 'number' && affected > 1) {
      Swal.fire({
        icon: 'warning',
        title: '\u522a\u9664\u5b8c\u6210',
        text: `\u6ce8\u610f\uff1a\u5f71\u97ff\u884c\u6578 = ${affected}\uff0c\u5efa\u8b70\u91cd\u65b0\u67e5\u8a62\u78ba\u8a8d`
      });
    } else {
      Swal.fire({ icon: 'success', title: '\u522a\u9664\u5b8c\u6210', timer: 900, showConfirmButton: false });
    }
  }

  if (delBtn) {
    if (window.createGridController) {
      window.createGridController({ name: 'singleGridDelete', btnDelete: delBtn, onDelete: deleteSelectedRow });
    } else {
      delBtn.addEventListener('click', deleteSelectedRow);
    }
  }

  function selectRowByIndex(idx) {
    const rows = Array.from(table.querySelectorAll("tbody tr"));
    if (rows.length === 0) return;
    const target = rows[Math.max(0, Math.min(rows.length - 1, idx))];
    if (target) selectRow(target);
  }

  function selectRelativeRow(delta) {
    const rows = Array.from(table.querySelectorAll("tbody tr"));
    if (rows.length === 0) return;
    const currentIdx = window.SELECTED_ROW ? rows.indexOf(window.SELECTED_ROW) : -1;
    const nextIdx = currentIdx + delta;
    if (nextIdx < 0) {
      if (currentPage > 1 && typeof goPage === "function") {
        pendingSelect = "last";
        goPage(currentPage - 1);
      } else {
        selectRow(rows[0]);
      }
      return;
    }
    if (nextIdx >= rows.length) {
      if (currentPage < totalPages && typeof goPage === "function") {
        pendingSelect = "first";
        goPage(currentPage + 1);
      } else {
        selectRow(rows[rows.length - 1]);
      }
      return;
    }
    selectRow(rows[nextIdx]);
  }

  function jumpFirst() {
    const rows = Array.from(table.querySelectorAll("tbody tr"));
    if (rows.length === 0) return;
    if (currentPage > 1 && typeof goPage === "function") {
      pendingSelect = "first";
      goPage(1);
      return;
    }
    selectRow(rows[0]);
  }

  function jumpLast() {
    const rows = Array.from(table.querySelectorAll("tbody tr"));
    if (rows.length === 0) return;
    if (currentPage < totalPages && typeof goPage === "function") {
      pendingSelect = "last";
      goPage(totalPages);
      return;
    }
    selectRow(rows[rows.length - 1]);
  }

  sgFirst?.addEventListener("click", jumpFirst);
  sgPrev?.addEventListener("click", () => selectRelativeRow(-1));
  sgNext?.addEventListener("click", () => selectRelativeRow(1));
  sgLast?.addEventListener("click", jumpLast);
  sgAdd?.addEventListener("click", addRow);
  sgDelete?.addEventListener("click", deleteSelectedRow);
  sgSave?.addEventListener("click", saveTableChanges);
  sgCancel?.addEventListener("click", cancelEdit);

  function findRowByKeys(change) {
    const rows = Array.from(table.querySelectorAll("tbody tr"));
    return rows.find(tr => {
      return KEY_FIELDS.every(k => {
        const inp = Array.from(tr.querySelectorAll('.cell-edit')).find(i => i.name.toLowerCase() === k);
        if (!inp) return false;
        const changeVal = change[k];
        if (changeVal == null) return false;
        return String(inp.value) === String(changeVal) || String(inp.defaultValue) === String(changeVal);
      });
    });
  }

  // 收集變更（只傳送鍵欄位 + 真正有變更的欄位）
  function collectChanges() {
    const list = [];
    document.querySelectorAll("#mainGrid tbody tr").forEach(tr => {
      const changed = {};
      const keys = {};
      let hasDiff = false;

      tr.querySelectorAll(".cell-edit").forEach(inp => {
        const name = inp.name;
        if (!name) return;

        const oldVal = inp.defaultValue ?? "";
        const newVal = inp.value ?? "";
        const isReadonly = inp.dataset.readonly === "1";
        const isKey = KEY_FIELDS.includes(name.toLowerCase());

        // 鍵欄位一定要帶
        if (isKey) {
          keys[name] = newVal;
          return;
        }

        // 唯讀欄位跳過
        if (isReadonly) return;

        // 只收集有變更的欄位
        if (newVal !== oldVal) {
          hasDiff = true;
          changed[name] = newVal;
        }
      });

      if (!hasDiff) return;

      // 合併鍵欄位 + 變更欄位
      list.push({ ...keys, ...changed });
    });
    return list;
  }

    table.addEventListener("click", (ev) => {
      const tr = ev.target.closest("tbody tr");
      if (!tr) return;
      selectRow(tr);
    });

    applyLookupToTable();
    setModePanel(isEdit);
    updateCountPanel(getSelectedRowIndex());
    buildCustomButtonsFromMeta();
    wireCustomButtons();

  // 共用狀態變數
  let isSorting = false; // 防止重複請求（排序、分頁共用）
  let currentSortBy = '@(ViewData["SortBy"] as string ?? "")';
  let currentSortDir = '@(ViewData["SortDir"] as string ?? "")';

  // 分頁控制
    const pagerPrev = document.getElementById("pagerPrev");
    const pagerNext = document.getElementById("pagerNext");
    const pagerLast = document.getElementById("pagerLast");
    const pagerFirst = document.getElementById("pagerFirst");
    const pagerPageSize = document.getElementById("pagerPageSize");
    const pagerCurrentEl = document.getElementById("pagerCurrent");
    const pagerTotalEl = document.getElementById("pagerTotal");
    currentPage = parseInt(pagerCurrentEl?.textContent || String(currentPage), 10);
    totalPages = parseInt(pagerTotalEl?.textContent || String(totalPages), 10);
  const pagerGoInput = document.getElementById("pagerGoInput");
  const pagerGoBtn = document.getElementById("pagerGoBtn");
  const btnOpenQuery = document.getElementById("btnOpenQuery");
  const queryModalEl = document.getElementById("singleGridQueryModal");
  const queryForm = document.getElementById("singleGridQueryForm");
  const btnQuerySubmit = document.getElementById("btnQuerySubmit");
  const fallbackQueryFields = @Html.Raw(JsonSerializer.Serialize(
    fields.Select(f => new {
      ColumnName = f.FieldName,
      ColumnCaption = f.DisplayLabel,
      DataType = f.DataType,
      DefaultEqual = "like"
    })
  ));

  // 更新分頁資訊
    function updatePager(newPage, newPageSize, newTotalCount) {
      currentPage = newPage;
      pageSize = newPageSize;
      totalPages = Math.max(1, Math.ceil(newTotalCount / newPageSize));
      totalCountAll = newTotalCount;

      // 更新 DOM
      if (pagerCurrentEl) pagerCurrentEl.textContent = currentPage;
      if (pagerTotalEl) pagerTotalEl.textContent = totalPages;
      if (pagerGoInput) {
        pagerGoInput.value = currentPage;
        pagerGoInput.max = totalPages;
      }

      // 更新按鈕狀態
      if (pagerFirst) pagerFirst.disabled = currentPage <= 1;
      if (pagerPrev) pagerPrev.disabled = currentPage <= 1;
      if (pagerNext) pagerNext.disabled = currentPage >= totalPages;
      if (pagerLast) pagerLast.disabled = currentPage >= totalPages;
      updateCountPanel(getSelectedRowIndex());
    }

  async function goPage(p) {

    if (!Number.isFinite(p) || p < 1) {
      return;
    }

    if (isSorting) {
      return;
    }

    isSorting = true;
    showLoading();

    try {
      const newPageSize = pagerPageSize ? parseInt(pagerPageSize.value) : pageSize;

      // 呼叫 AJAX API
      const urlObj = new URL(window.location.href);
      urlObj.searchParams.set("handler", "Data");
      urlObj.searchParams.set("pageIndex", String(p));
      urlObj.searchParams.set("pageSize", String(newPageSize));
      if (currentSortBy) urlObj.searchParams.set("sortBy", currentSortBy);
      else urlObj.searchParams.delete("sortBy");
      if (currentSortDir) urlObj.searchParams.set("sortDir", currentSortDir);
      else urlObj.searchParams.delete("sortDir");
      const url = urlObj.toString();

      const response = await fetch(url);

      if (!response.ok) {
        throw new Error('HTTP error! status: ' + response.status);
      }

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'Unknown error');
      }

      // 更新表格
      const fields = @Html.Raw(JsonSerializer.Serialize(Model.TableFields));
      const emptyMessage = getEmptyMessage(!!data.openNoRecord, !!data.hasQueryParams);
      updateTableBody(data.items, fields, emptyMessage);
      applyLookupToTable(); // 套用 lookup 顯示

      // 更新分頁資訊
      updatePager(data.pageNumber, newPageSize, data.totalCount);

    } catch (err) {
      console.error('[goPage] Page change failed:', err);
      alert('換頁失敗：' + err.message);
    } finally {
      hideLoading();
      isSorting = false;
    
    }
  }

  pagerFirst?.addEventListener("click", (e) => {
 
    e.preventDefault();
    goPage(1);
  });
  pagerPrev?.addEventListener("click", (e) => {
    e.preventDefault();
    if (!e.currentTarget.disabled) goPage(currentPage - 1);
  });
  pagerNext?.addEventListener("click", (e) => {
    e.preventDefault();
    if (!e.currentTarget.disabled) goPage(currentPage + 1);
  });
  pagerLast?.addEventListener("click", (e) => {
    e.preventDefault();
    if (!e.currentTarget.disabled) goPage(totalPages);
  });
  pagerPageSize?.addEventListener("change", () => {
    goPage(1);
  });
  pagerGoBtn?.addEventListener("click", () => {
    const v = parseInt(pagerGoInput?.value || "1", 10);
    if (Number.isFinite(v)) goPage(Math.min(Math.max(1, v), totalPages));
  });
  pagerGoInput?.addEventListener("keyup", (e) => {
    if (e.key === "Enter") pagerGoBtn?.click();
  });

  // 查詢 modal
  let queryFieldsLoaded = false;
  let inqMustLoaded = false;
  let inqMustList = [];
  async function loadQueryFields() {
    if (queryFieldsLoaded) return;
    const itemId = window._singleItemId || "";
    const table = window._singleRealTable || tableName;
    if (!itemId || !table) return;
    try {
      const res = await fetch(`/api/DictSetupApi/QueryFields?itemId=${encodeURIComponent(itemId)}&table=${encodeURIComponent(table)}&lang=TW`);
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      const list = Array.isArray(data) && data.length ? data : (fallbackQueryFields || []);
      buildQueryForm(list);
      queryFieldsLoaded = true;
    } catch (err) {
      console.warn("load query fields failed", err);
      if (fallbackQueryFields && fallbackQueryFields.length) {
        buildQueryForm(fallbackQueryFields);
        queryFieldsLoaded = true;
      }
    }
  }

  function buildEmptyRow(fields) {
    const tr = document.createElement("tr");
    tr.dataset.newRow = "1";
    fields.forEach(f => {
      const fieldName = f.FieldName;
      const isHidden = f.Visible == 0;
      const hiddenStyle = isHidden ? "display:none;" : "";
      const dt = (f.DataType || "").toString().toLowerCase();
      const isNumber = dt.includes('number') || dt.startsWith('decimal') || dt.startsWith('numeric')
        || dt.startsWith('money') || dt.startsWith('smallmoney') || dt.startsWith('float') || dt.startsWith('real')
        || dt.startsWith('int') || dt.startsWith('smallint') || dt.startsWith('tinyint') || dt.startsWith('bigint');
      const cellClass = isNumber ? 'cell-number' : 'cell-text';
      const isReadOnly = f.ReadOnly != null && f.ReadOnly != 0;

      const td = document.createElement("td");
      td.className = `text-nowrap ${cellClass}`;
      td.dataset.field = fieldName;
      td.setAttribute("style", hiddenStyle);

      const span = document.createElement("span");
      span.className = "cell-view d-none";
      span.dataset.raw = "";
      span.dataset.lookupkey = "";
      span.textContent = "";

      const inp = document.createElement("input");
      inp.className = `form-control form-control-sm cell-edit ${isReadOnly ? "readonly-cell" : ""}`;
      inp.name = fieldName;
      inp.value = "";
      inp.dataset.raw = "";
      inp.dataset.lookupkey = "";
      inp.dataset.readonly = isReadOnly ? "1" : "0";
      if (isReadOnly) inp.readOnly = true;

      td.appendChild(span);
      td.appendChild(inp);
      tr.appendChild(td);
    });
    return tr;
  }

  function addRow() {
    if (!isEdit) editBtn.click();
    const tbody = table.querySelector("tbody");
    if (!tbody) return;
    const fields = @Html.Raw(JsonSerializer.Serialize(Model.TableFields));
    if (tbody.children.length === 1) {
      const only = tbody.children[0];
      if (only.querySelector("td[colspan]")) tbody.innerHTML = "";
    }
      const tr = buildEmptyRow(fields);
      tbody.insertBefore(tr, tbody.firstChild);
      selectRow(tr);
      tr.scrollIntoView({ block: "center" });
      setDirty(true);
    }

  function cancelEdit() {
    if (!isEdit) return;
    table.querySelectorAll("tbody tr").forEach(tr => {
      if (tr.dataset.newRow === "1") {
        tr.remove();
        return;
      }
      tr.querySelectorAll(".cell-edit").forEach(inp => {
        const val = inp.defaultValue ?? "";
        inp.value = val;
        inp.dataset.raw = val;
        const span = inp.closest("td")?.querySelector(".cell-view");
        if (span) span.textContent = val;
      });
    });
    applyLookupToTable();
    isEdit = false;
      editBtn.innerHTML = '<i class="bi bi-pencil-square me-1"></i> 修改';
      wrapper.classList.remove("edit-mode");
      if (saveBtn) saveBtn.classList.add("d-none");
      setModePanel(false);
      setDirty(false);
    }

  async function loadInqMust() {
    if (inqMustLoaded) return;
    const table = window._singleRealTable || table?.dataset?.dictTable || window._dictTableName || "";
    if (!table) return;
    try {
      const res = await fetch(`/api/DictSetupApi/InqMust?paperId=${encodeURIComponent(table)}`);
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      inqMustList = Array.isArray(data) ? data : [];
      inqMustLoaded = true;
    } catch (err) {
      console.warn("load inq must failed", err);
    }
  }

  function buildQueryForm(fields) {
    if (!queryForm) return;
    queryForm.innerHTML = "";

    // 直接渲染所有查詢欄位
    fields.forEach(f => {
      const colName = f.columnName || f.ColumnName || "";
      if (!colName) return;
      const caption = f.columnCaption || f.ColumnCaption || colName;
      const defVal = f.defaultValue || f.DefaultValue || "";
      const defEq = (f.defaultEqual || f.DefaultEqual || "").toString().toLowerCase();
      const dtRaw = f.dataType ?? f.DataType;
      const dt = Number(dtRaw);

      const wrap = document.createElement("div");
      wrap.className = "col-md-4 col-sm-6";
      const label = document.createElement("label");
      label.className = "form-label text-muted";
      label.textContent = caption;
      const input = document.createElement("input");
      input.className = "form-control form-control-sm";
      input.name = colName;
      if (dt === 1) input.type = "date";
      else if (dt === 2) input.type = "number";
      else input.type = "text";
      if (defVal) input.value = defVal;
      if (defEq === "like") input.placeholder = "模糊查詢";

      wrap.appendChild(label);
      wrap.appendChild(input);
      queryForm.appendChild(wrap);
    });
  }

  btnOpenQuery?.addEventListener("click", async () => {
    await loadQueryFields();
    if (queryModalEl && window.bootstrap) {
      const modal = bootstrap.Modal.getOrCreateInstance(queryModalEl);
      modal.show();
    }
  });

  // 清除查詢條件
  const btnClearQuery = document.getElementById("btnClearQuery");
  btnClearQuery?.addEventListener("click", () => {
    if (queryForm) {
      Array.from(queryForm.elements).forEach(el => {
        if (el.tagName === "INPUT") el.value = "";
      });
    }
  });

  const submitQueryForm = async () => {
    if (!queryForm) return;
    await loadInqMust();

    if (inqMustList.length > 0) {
      for (const rule of inqMustList) {
        const field = (rule.fieldMust || rule.FieldMust || "").toString();
        if (!field) continue;
        const input = queryForm.querySelector(`[name="${CSS.escape(field)}"]`);
        const value = input?.value?.toString().trim() ?? "";
        if (!value) {
          const msg = (rule.showError || rule.ShowError || "").toString();
          Swal.fire({ icon: 'error', title: msg || '請輸入必要查詢條件' });
          return;
        }
      }
    }
    const url = new URL(window.location.href);
    // 保留 pageSize，其餘重新以 pageIndex=1
    url.searchParams.delete("pageIndex");
    url.searchParams.set("pageIndex", "1");
    // 移除排序參數（排序已改用 AJAX，不需要在網址中）
    url.searchParams.delete("sortBy");
    url.searchParams.delete("sortDir");

    // 收集查詢欄位
    Array.from(queryForm.elements).forEach(el => {
      if (!el.name) return;
      const val = el.value?.toString() ?? "";
      if (val) url.searchParams.set(el.name, val);
      else url.searchParams.delete(el.name);
    });

    window.location.href = url.toString();
  };

  btnQuerySubmit?.addEventListener("click", () => submitQueryForm());
  queryForm?.addEventListener("submit", (e) => {
    e.preventDefault();
    submitQueryForm();
  });

  exportBtn?.addEventListener("click", () => {
    const url = new URL(window.location.href);
    url.searchParams.set("handler", "Export");
    window.location.href = url.toString();
  });


  // 欄寬拖拉
  const colGroupCols = Array.from(table.querySelectorAll("colgroup col"));
  const ths = Array.from(table.querySelectorAll("thead th"));
  const dictName = window._dictTableName || table.dataset.dictTable || dictTableName || table.dataset.table || table.dataset.dict || "";
  const tableName = dictName;
  const colMap = {};
  colGroupCols.forEach(col => {
    const field = col.getAttribute("data-field");
    if (field) colMap[field.toLowerCase()] = col;
  });

  let dragState = null;
  ths.forEach(th => {
    const field = th.getAttribute("data-field");
    const resizer = th.querySelector(".col-resizer");
    if (!field || !resizer) return;
    resizer.addEventListener("mousedown", (e) => {
      e.preventDefault();
      const col = colMap[field.toLowerCase()];
      const startX = e.clientX;
      const startWidth = (col?.getBoundingClientRect().width) || th.getBoundingClientRect().width;
      dragState = { field, startX, startWidth };
      document.body.style.cursor = "col-resize";
    });
  });

  document.addEventListener("mousemove", (e) => {
    if (!dragState) return;
    const delta = e.clientX - dragState.startX;
    const newW = Math.max(40, dragState.startWidth + delta);
    const col = colMap[dragState.field.toLowerCase()];
    if (col) {
      col.style.width = `${newW}px`;
      col.style.minWidth = `${newW}px`;
      col.style.maxWidth = `${newW}px`;
    }
    // apply to header cell for visual feedback
    const th = ths.find(t => (t.getAttribute("data-field") || "").toLowerCase() === dragState.field.toLowerCase());
    if (th) th.style.width = `${newW}px`;
  });

  document.addEventListener("mouseup", async () => {
    if (!dragState) return;
    const col = colMap[dragState.field.toLowerCase()];
    const th = ths.find(t => (t.getAttribute("data-field") || "").toLowerCase() === dragState.field.toLowerCase());
    const width = col?.getBoundingClientRect().width || th?.getBoundingClientRect().width || dragState.startWidth;
    dragState = null;
    document.body.style.cursor = "";
    if (!tableName) return;
    try {
      await fetch("/api/DictSetupApi/FieldWidth/Save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          tableName: tableName,
          fieldName: th?.getAttribute("data-field") || "",
          widthPx: Math.round(width)
        })
      });
    } catch (err) {
      console.warn("save width failed", err);
    }
  });

  // ===== AJAX 排序功能 =====
  const headers = document.querySelectorAll(".sortable-header .header-label");
  const sortTableBody = document.querySelector("#mainGrid tbody");
  const tableWrapper = document.querySelector(".table-fix-wrapper");

  // Loading overlay
  const loadingOverlay = document.createElement('div');
  loadingOverlay.className = 'table-loading-overlay';
  loadingOverlay.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
  loadingOverlay.style.cssText = 'position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,0.8);z-index:1000;';
  tableWrapper?.appendChild(loadingOverlay);

  // 顯示 Loading
  function showLoading() {
    if (loadingOverlay) loadingOverlay.style.display = 'flex';
  }

  // 隱藏 Loading
  function hideLoading() {
    if (loadingOverlay) loadingOverlay.style.display = 'none';
  }

  // 更新排序圖示
  function updateSortIcons(fieldName, sortDir) {
    document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = '');
    const th = document.querySelector(`.sortable-header[data-field="${fieldName}"]`);
    if (th) {
      const icon = th.querySelector('.sort-icon');
      if (icon) icon.textContent = sortDir === 'desc' ? '▼' : '▲';
    }
  }

  // 更新表格內容
  const getEmptyMessage = (openNoRecordFlag, hasQueryFlag) => {
    return (openNoRecordFlag && !hasQueryFlag) ? "（請先使用查詢功能）" : "（無資料）";
  };

  const trimZeroDecimal = (value) => {
    if (value === null || value === undefined) return "";
    const text = String(value);
    const idx = text.indexOf(".");
    if (idx < 0) return text;
    const head = text.slice(0, idx + 1);
    let tail = text.slice(idx + 1);
    tail = tail.replace(/0+$/, "");
    if (!tail) return head.slice(0, -1);
    return head + tail;
  };

  const getDecimalScale = (dataType) => {
    if (!dataType) return null;
    const s = String(dataType).trim().toLowerCase();
    if (!s.startsWith("decimal") && !s.startsWith("numeric")) return null;
    const l = s.indexOf("(");
    const r = s.indexOf(")");
    if (l < 0 || r <= l) return 0;
    const inner = s.slice(l + 1, r);
    const parts = inner.split(",");
    if (parts.length === 2) {
      const n = parseInt(parts[1].trim(), 10);
      return Number.isFinite(n) ? Math.max(0, n) : 0;
    }
    return 0;
  };

  const isDecimalString = (value) => {
    if (value === null || value === undefined) return false;
    const text = String(value).trim();
    if (!text) return false;
    return /^[+-]?\d+\.\d+$/.test(text);
  };

  function updateTableBody(items, fields, emptyMessage) {
    const tbody = sortTableBody || document.querySelector("#mainGrid tbody");
    if (!tbody) return;

    if (!items || items.length === 0) {
      const msg = emptyMessage || getEmptyMessage(openNoRecordInit, hasQueryParamsInit);
      tbody.innerHTML = '<tr><td colspan="' + fields.length + '" class="text-center text-muted py-3">' + msg + '</td></tr>';
      return;
    }

    const ocxLookupPayload = @Html.Raw(JsonSerializer.Serialize(ocxLookupPayload));

    tbody.innerHTML = items.map(item => {
      return '<tr>' + fields.map(f => {
        const fieldName = f.FieldName;
        const rawVal = item[fieldName] ?? item[fieldName?.toLowerCase()] ?? '';
        const isHidden = f.Visible == 0;
        const hiddenStyle = isHidden ? 'display:none;' : '';
        const isReadOnly = f.ReadOnly != null && f.ReadOnly != 0;
        const dt = (f.DataType || '').toString().toLowerCase();
        const isNumber = dt.includes('number') || dt.startsWith('decimal') || dt.startsWith('numeric')
          || dt.startsWith('money') || dt.startsWith('smallmoney') || dt.startsWith('float') || dt.startsWith('real')
          || dt.startsWith('int') || dt.startsWith('smallint') || dt.startsWith('tinyint') || dt.startsWith('bigint');
        const cellClass = isNumber ? 'cell-number' : 'cell-text';

        // 計算 lookupKey（與初始渲染邏輯一致）
        let lookupKey = rawVal;
        const ocxLookup = ocxLookupPayload[fieldName?.toLowerCase()];
        if (ocxLookup) {
          const keyFieldName = ocxLookup.keyField;
          const keySelfName = ocxLookup.keySelf;

          let keyFieldVal = '';
          let keySelfVal = '';

          if (keyFieldName) {
            const kfVal = item[keyFieldName] ?? item[keyFieldName?.toLowerCase()];
            keyFieldVal = (kfVal !== null && kfVal !== undefined) ? String(kfVal) : '';
          }
          if (keySelfName) {
            const ksVal = item[keySelfName] ?? item[keySelfName?.toLowerCase()];
            keySelfVal = (ksVal !== null && ksVal !== undefined) ? String(ksVal) : '';
          }

          // 優先使用 keyFieldVal，其次 keySelfVal，最後才用 rawVal
          // 這樣可以確保 lookup 欄位（如 StatusName）能用對應的 key 欄位（如 Status）的值
          if (keyFieldVal !== '') {
            lookupKey = keyFieldVal;
          } else if (keySelfVal !== '') {
            lookupKey = keySelfVal;
          } else if (lookupKey === '' && rawVal !== null && rawVal !== undefined) {
            lookupKey = String(rawVal);
          }
        }

        // 簡單格式化
        let displayVal = rawVal;
        const dateFormatMode = window._singleGridDateFormat || '';
        const formatDateValue = (val, dateOnly) => {
          const date = new Date(val);
          if (isNaN(date)) {
            if (dateOnly) {
              const m = String(val).match(/(\d{4})[/-](\d{1,2})[/-](\d{1,2})/);
              if (m) {
                const y = m[1];
                const mm = String(m[2]).padStart(2, '0');
                const dd = String(m[3]).padStart(2, '0');
                return `${y}/${mm}/${dd}`;
              }
            }
            return String(val);
          }
          const y = date.getFullYear();
          const m = String(date.getMonth() + 1).padStart(2, '0');
          const d = String(date.getDate()).padStart(2, '0');
          if (dateOnly || dateFormatMode === 'date') return `${y}/${m}/${d}`;
          const hh = String(date.getHours()).padStart(2, '0');
          const mm = String(date.getMinutes()).padStart(2, '0');
          const ss = String(date.getSeconds()).padStart(2, '0');
          return `${y}/${m}/${d} ${hh}:${mm}:${ss}`;
        };

        if (rawVal instanceof Date || (typeof rawVal === 'string' && rawVal.match(/^\d{4}-\d{2}-\d{2}/))) {
          const fmtMeta = fieldFormatMap?.find?.(x => (x.FieldName || "").toLowerCase() === (fieldName || "").toLowerCase());
          const fmt = (fmtMeta?.FormatStr || "").toString();
          const fmtLower = fmt.toLowerCase();
          const hasTime = fmtLower.includes("hh") || fmtLower.includes("nn") || fmtLower.includes("ss");
          if (fmt) displayVal = formatDateValue(rawVal, !hasTime);
          else if (dateFormatMode) displayVal = formatDateValue(rawVal, true);
          else {
            const date = new Date(rawVal);
            if (!isNaN(date)) {
              displayVal = date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
            }
          }
        } else if (typeof rawVal === 'number') {
          const scale = getDecimalScale(dt);
          displayVal = scale !== null ? trimZeroDecimal(rawVal.toLocaleString('zh-TW', { maximumFractionDigits: 8 })) : trimZeroDecimal(rawVal.toLocaleString('zh-TW'));
        } else if (typeof rawVal === 'string' && (isNumber || isDecimalString(rawVal) || getDecimalScale(dt) !== null)) {
          displayVal = trimZeroDecimal(rawVal);
        }

        // 安全處理值，避免 0 被視為 falsy
        const safeRawVal = (rawVal !== null && rawVal !== undefined) ? String(rawVal) : '';
        const safeLookupKey = (lookupKey !== null && lookupKey !== undefined) ? String(lookupKey) : '';
        const safeDisplayVal = (displayVal !== null && displayVal !== undefined) ? String(displayVal) : '';

        // 產生與初始渲染一致的結構，包含 data-field, cell-view, cell-edit
        const tdClass = 'text-nowrap ' + cellClass + (isReadOnly ? ' readonly-td' : '');
        return '<td class="' + tdClass + '" data-field="' + fieldName + '" style="' + hiddenStyle + '">' +
          '<span class="cell-view' + (isReadOnly ? ' readonly-cell' : '') + '" data-raw="' + safeRawVal + '" data-lookupkey="' + safeLookupKey + '">' + safeDisplayVal + '</span>' +
          '<input class="form-control form-control-sm cell-edit d-none ' + (isReadOnly ? 'readonly-cell' : '') + '" ' +
          'name="' + fieldName + '" ' +
          'value="' + safeRawVal + '" ' +
          'data-raw="' + safeRawVal + '" ' +
          'data-lookupkey="' + safeLookupKey + '" ' +
          'data-readonly="' + (isReadOnly ? '1' : '0') + '" ' +
          (isReadOnly ? 'readonly' : '') + ' />' +
          '</td>';
      }).join('') + '</tr>';
    }).join('');

    window.SELECTED_ROW = null;
    updateCountPanel(0);
    if (pendingSelect) {
      const rows = Array.from(tbody.querySelectorAll("tr"));
      if (rows.length > 0) {
        const idx = pendingSelect === "last" ? rows.length - 1 : 0;
        selectRow(rows[idx]);
      }
      pendingSelect = "";
    }
  }

  // AJAX 排序處理
  async function handleSort(fieldName) {
    if (isSorting) return;

    const fields = @Html.Raw(JsonSerializer.Serialize(Model.TableFields));
    const ocxLookupPayload = @Html.Raw(JsonSerializer.Serialize(ocxLookupPayload));

    // 計算實際要排序的欄位名稱
    let actualFieldName = fieldName;
    const fieldDef = fields.find(f => f.FieldName === fieldName);

    // 判斷是否為非實體欄位：DataType 為空或 null 表示非實體欄位
    const isVirtualField = fieldDef && (!fieldDef.DataType || fieldDef.DataType === '');

    // 檢查是否為非實體欄位
    if (isVirtualField) {
      // 嘗試從 OCXLookup 找到對應的 KeyField
      const lookupInfo = ocxLookupPayload[fieldName.toLowerCase()];
      if (lookupInfo && lookupInfo.keyField) {
        // 使用 lookup 的 keyField 作為實際排序欄位
        actualFieldName = lookupInfo.keyField;
      } else if (fieldName.endsWith('Name')) {
        // 嘗試去掉 Name 後綴找到對應的實體欄位
        const baseFieldName = fieldName.substring(0, fieldName.length - 4);
        const baseField = fields.find(f => f.FieldName === baseFieldName && f.DataType);
        if (baseField) {
          actualFieldName = baseFieldName;
        }
      }

      // 如果還是找不到對應的實體欄位，則無法排序
      if (actualFieldName === fieldName) {
        Swal.fire({ icon: 'info', title: '此欄位不支援排序', text: '找不到對應的實體欄位', timer: 2000, showConfirmButton: false });
        return;
      }
    }

    isSorting = true;
    showLoading();

    try {

      // 決定新的排序方向（使用實際欄位名稱比較）
      let newSortDir = 'asc';
      if (currentSortBy === actualFieldName) {
        newSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
      }

      // 呼叫 AJAX API
      const urlObj = new URL(window.location.href);
      urlObj.searchParams.set("handler", "Data");
      urlObj.searchParams.set("sortBy", actualFieldName);
      urlObj.searchParams.set("sortDir", newSortDir);
      urlObj.searchParams.set("pageIndex", "1");
      const url = urlObj.toString();
      const response = await fetch(url);

      if (!response.ok) {
        throw new Error('HTTP error! status: ' + response.status);
      }

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'Unknown error');
      }

      // 更新表格
      const emptyMessage = getEmptyMessage(!!data.openNoRecord, !!data.hasQueryParams);
      updateTableBody(data.items, fields, emptyMessage);
      applyLookupToTable(); // 套用 lookup 顯示

      // 更新排序狀態（使用實際傳送的欄位名稱）
      currentSortBy = actualFieldName;
      currentSortDir = newSortDir;
      updateSortIcons(fieldName, newSortDir);

    } catch (err) {
      console.error('Sort failed:', err);
      Swal.fire({ icon: 'error', title: '排序失敗', text: err.message });
    } finally {
      hideLoading();
      isSorting = false;
    }
  }

  // 綁定點擊事件
  headers.forEach(headerLabel => {
    headerLabel.addEventListener("click", (e) => {
      e.stopPropagation(); // 防止觸發 col-resizer
      const th = headerLabel.closest("th");
      const fieldName = th?.getAttribute("data-field");
      if (fieldName) handleSort(fieldName);
    });
  });

});
</script>

@if (ViewData["QueryFieldModalsRendered"] == null)
{
    @await Html.PartialAsync("~/Pages/Shared/_QueryFieldModals.cshtml")
}
