@model dynamic
@using System.Text.Json
@{
    var fieldsJson = JsonSerializer.Serialize(Model ?? new List<object>());
}

<form id="searchForm" method="post" class="modal-content query-modal-content">
    <div class="modal-header">
        <h5 class="modal-title">查詢條件</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
        <div class="container-fluid">
            <div class="row g-1 query-field-grid"></div>
        </div>
    </div>
    <div class="modal-footer query-footer">
        <div class="query-footer-left">
            <button id="btnQueryFieldSelect" class="btn btn-outline-secondary btn-sm" type="button">進階</button>
            <button id="btnQueryDefault" class="btn btn-outline-secondary btn-sm" type="button">預設</button>
        </div>
        <div class="query-footer-right">
            <button type="submit" class="btn btn-primary">查詢</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        </div>
    </div>
</form>

<style>
    .query-modal-content .modal-header { cursor: move; user-select: none; padding: 6px 12px; }
    .query-modal-content .modal-header :is(button, input, select, textarea, a) { cursor: default; }
    .query-modal-content .query-op { flex: 0 0 76px; min-width: 76px; max-width: 76px; }
    .query-modal-content .query-input { flex: 0 0 140px; min-width: 140px; max-width: 140px; }
    .query-modal-content .modal-body { padding: 10px 12px; max-height: 50vh; overflow-y: auto; }
    .query-modal-content .modal-header { display: flex; align-items: center; gap: 10px; }
    .query-modal-content .modal-title { margin: 0; }
    .query-modal-content .query-footer { display: flex; align-items: center; justify-content: space-between; }
    .query-modal-content .query-footer-left { display: flex; gap: 6px; }
    .query-modal-content .query-footer-right { display: flex; gap: 8px; }
    .query-field-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); column-gap: 16px; }
    .query-field-grid > .query-item { box-sizing: border-box; }
    .query-field-grid .query-item { display: flex; }
    .query-field-grid .query-row { display: flex; align-items: center; gap: 8px; }
    .query-field-grid .col-md-6:nth-child(2n) .query-row { justify-content: flex-end; }
    .query-field-grid .col-md-6:nth-child(2n+1) .query-row { justify-content: flex-start; }
    .query-field-grid .query-label {
        flex: 0 0 110px;
        text-align: right;
        font-size: var(--field-label-size);
        line-height: 1.2;
        margin: 0;
        white-space: nowrap;
    }
    @@media (max-width: 991.98px) {
        .query-field-grid { grid-template-columns: 1fr; }
    }
    .query-field-grid .query-input,
    .query-field-grid .query-op {
        height: 24px;
        padding-top: 2px;
        padding-bottom: 2px;
        font-size: var(--field-value-size);
    }
</style>

<script>
(() => {
    const formEl = document.getElementById("searchForm");
    const gridEl = formEl?.querySelector(".query-field-grid");
    if (!formEl || !gridEl) return;
    const busyFetch = (input, init, msg) => {
        if (typeof window.busyFetch === "function") return window.busyFetch(input, init, msg);
        return fetch(input, init);
    };
    const modalEl = formEl.closest(".modal");
    if (modalEl && modalEl.parentElement !== document.body) {
        document.body.appendChild(modalEl);
    }

    const fallbackFields = @Html.Raw(fieldsJson);
    let cachedFields = null;
    let cachedEquals = null;
    let building = false;

    const normalizeKey = (v) => (v || "").toString().trim().replace(/^@@+/, "").toLowerCase();

    const getItemId = () => (window._itemId || window._singleItemId || "").toString().trim();
    const getTable = () => (window._dictTableName || window._tableName || "").toString().trim();

    const getUserId = () => (localStorage.getItem("erpLoginUserId") || window._userId || "").toString().trim();
    const getUseId = () => (localStorage.getItem("erpLoginBUId") || window.DEFAULT_USEID || window._useId || "A001").toString().trim();

    const applyDefaultByType = (field) => {
        const defType = Number(field.defaultType ?? field.DefaultType ?? 0);
        if (defType === 2) return getUserId();
        if (defType === 3) return getUseId();
        const raw = field.defaultValue ?? field.DefaultValue;
        return raw ?? "";
    };

    const looksLikeSqlDefault = (val) => {
        if (typeof val !== "string") return false;
        return /\bselect\b/i.test(val);
    };

    const isDatePlaceholder = (val) => {
        if (val == null) return false;
        const s = String(val).trim();
        const lower = s.toLowerCase();
        // 瑼Ｘ撣貉????雿泵?澆?嚗??思葉????
        return lower === "yyyy/mm/dd" ||
               lower === "yyyy-mm-dd" ||
               lower === "yyyy/月/dd" ||
               /^yyyy[\/-]mm[\/-]dd$/i.test(s) ||
               /^yyyy[\/-]月[\/-]dd$/i.test(s);
    };

    const applyEditMask = (value, field) => {
        if (typeof window.normalizeForDateInput === "function") {
            const fake = { type: "date", dataset: { field: field.columnName || field.ColumnName || "" } };
            return window.normalizeForDateInput(fake, value);
        }
        return value;
    };

    const normalizeDateValue = (val) => {
        if (val == null) return "";
        const s = String(val).trim();
        if (!s) return "";
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(s)) {
            const [y, m, d] = s.split("/");
            return `${y}-${m.padStart(2, "0")}-${d.padStart(2, "0")}`;
        }
        const m = s.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})(?:\s+(上午|下午))?(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
        if (m) {
            const y = m[1];
            const mo = m[2].padStart(2, "0");
            const d = m[3].padStart(2, "0");
            let hour = m[5] ? Number(m[5]) : 0;
            const ap = m[4];
            if (ap === "下午" && hour < 12) hour += 12;
            if (ap === "上午" && hour === 12) hour = 0;
            return `${y}-${mo}-${d}`;
        }
        const parsed = new Date(s);
        if (!Number.isNaN(parsed.getTime())) {
            const y = String(parsed.getFullYear());
            const mo = String(parsed.getMonth() + 1).padStart(2, "0");
            const d = String(parsed.getDate()).padStart(2, "0");
            return `${y}-${mo}-${d}`;
        }
        return "";
    };

    const fetchEquals = async () => {
        if (cachedEquals) return cachedEquals;
        try {
            const res = await busyFetch("/api/DictSetupApi/QueryEquals", null, "載入查詢條件…");
            if (!res.ok) throw new Error(await res.text());
            const list = await res.json();
            cachedEquals = Array.isArray(list) ? list : [];
        } catch {
            cachedEquals = [
                { value: "=", text: "=" },
                { value: ">=", text: ">=" },
                { value: "<=", text: "<=" },
                { value: "like", text: "like" }
            ];
        }
        return cachedEquals;
    };

    const mergeResolvedDefaults = (selected, resolved) => {
        if (!Array.isArray(selected) || !Array.isArray(resolved)) return selected;
        const map = new Map();
        resolved.forEach(r => {
            const key = normalizeKey(r?.columnName ?? r?.ColumnName ?? "");
            if (key) map.set(key, r);
        });

        // 瑼Ｘ?芯?甈??閬銵?SQL 雿???瑁?蝯?銝?
        const sqlFields = selected.filter(item => {
            const defType = Number(item.defaultType ?? item.DefaultType ?? 0);
            const defVal = item?.defaultValue ?? item?.DefaultValue ?? "";
            return defType === 1 && looksLikeSqlDefault(defVal);
        });

        const missingFields = sqlFields.filter(item => {
            const key = normalizeKey(item?.columnName ?? item?.ColumnName ?? "");
            return key && !map.has(key);
        });
        if (missingFields.length > 0) {
            console.warn(`[QueryPanel] 隞乩? ${missingFields.length} ??雿?閬銵?SQL 雿?瑁?蝯?銝剜銝:`, missingFields.map(f => f.columnName || f.ColumnName));
        }

        selected.forEach(item => {
            const key = normalizeKey(item?.columnName ?? item?.ColumnName ?? "");
            if (!key || !map.has(key)) return;
            const hit = map.get(key);
            const defType = Number(item.defaultType ?? item.DefaultType ?? hit?.defaultType ?? hit?.DefaultType ?? 0);
            const resolvedVal = hit?.defaultValue ?? hit?.DefaultValue ?? "";
            const currentVal = item?.defaultValue ?? item?.DefaultValue ?? "";

            if (defType === 1 && resolvedVal !== "" && looksLikeSqlDefault(currentVal)) {
                item.defaultValue = resolvedVal;
                item.DefaultValue = resolvedVal;
            } else if (!currentVal && resolvedVal) {
                item.defaultValue = resolvedVal;
                item.DefaultValue = resolvedVal;
            }
        });
        return selected;
    };

    const loadQueryFields = async () => {
        if (cachedFields) {
            return cachedFields;
        }
        const itemId = getItemId();
        const table = getTable();
        if (!itemId || !table) {
            console.warn('[QueryPanel] 蝻箏? itemId ??table嚗蝙??fallback 甈?');
            cachedFields = Array.isArray(fallbackFields) ? fallbackFields : [];
            return cachedFields;
        }
        try {
            const url = `/api/DictSetupApi/PaperSelectedList?itemId=${encodeURIComponent(itemId)}&table=${encodeURIComponent(table)}&resolveDefault=1`;
            const res = await busyFetch(url, null, "載入查詢條件…");
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            let selected = Array.isArray(data?.selected) ? data.selected : (Array.isArray(fallbackFields) ? fallbackFields : []);
            // 憿舐內??3 ??雿? defaultType
            selected.slice(0, 3).forEach(item => {
            });
            const needResolve = selected.some(f => {
                const defType = Number(f?.defaultType ?? f?.DefaultType ?? 0);
                const defVal = f?.defaultValue ?? f?.DefaultValue ?? "";
                return defType === 1 && looksLikeSqlDefault(defVal);
            });
            if (needResolve) {
                try {
                    const res2 = await busyFetch(`/api/DictSetupApi/QueryFields?itemId=${encodeURIComponent(itemId)}&table=${encodeURIComponent(table)}&lang=TW`, null, "載入查詢預設值…");
                    if (res2.ok) {
                        const resolved = await res2.json();
                        selected = mergeResolvedDefaults(selected, resolved);
                    } else {
                        console.error('[QueryPanel] QueryFields API ???航炊:', res2.status);
                    }
                } catch (err) {
                    console.error('[QueryPanel] QueryFields API ?澆憭望?:', err);
                }
            }
            cachedFields = selected;
        } catch (err) {
            console.error('[QueryPanel] 頛查詢甈?憭望?:', err);
            cachedFields = Array.isArray(fallbackFields) ? fallbackFields : [];
        }
        return cachedFields;
    };

    const loadOptions = async (columnName, superValue) => {
        const itemId = getItemId();
        const table = getTable();
        if (!itemId || !table) return [];
        const extra = superValue ? `&superValue=${encodeURIComponent(superValue)}` : "";
        const url = `/api/DictSetupApi/QueryFieldOptions?itemId=${encodeURIComponent(itemId)}&table=${encodeURIComponent(table)}&column=${encodeURIComponent(columnName)}${extra}`;
        const res = await busyFetch(url, null, "載入選項…");
        if (!res.ok) return [];
        const data = await res.json();
        return Array.isArray(data) ? data : [];
    };

    const buildOptionList = (selectEl, options, defaultValue) => {
        selectEl.innerHTML = "";
        const emptyOpt = document.createElement("option");
        emptyOpt.value = "";
        emptyOpt.textContent = "";
        selectEl.appendChild(emptyOpt);

        if (Array.isArray(options)) {
            options.forEach(opt => {
                const o = document.createElement("option");
                const val = opt.value ?? opt.Value ?? "";
                const text = opt.text ?? opt.Text ?? "";
                o.value = val;
                o.textContent = text ? `${val} ${text}`.trim() : val;
                if (text && text !== val) o.title = text;
                selectEl.appendChild(o);
            });
        }

        if (defaultValue && !Array.from(selectEl.options).some(o => o.value === defaultValue)) {
            const o = document.createElement("option");
            o.value = defaultValue;
            o.textContent = defaultValue;
            selectEl.appendChild(o);
        }
        if (defaultValue != null) selectEl.value = defaultValue;
    };

    const buildField = async (field, equals, index) => {
        const colName = field.columnName || field.ColumnName || "";
        if (!colName) return;

        const sortOrder = field.sortOrder ?? field.SortOrder ?? index + 1;
        const key = `${colName}${sortOrder}`;
        const caption = field.columnCaption || field.ColumnCaption || colName;

        const wrap = document.createElement("div");
        wrap.className = "query-item";

        const row = document.createElement("div");
        row.className = "query-row";

        const label = document.createElement("label");
        label.className = "query-label text-muted";
        label.textContent = caption;

        const opSelect = document.createElement("select");
        opSelect.name = `Cond_${key}`;
        opSelect.className = "form-select query-op";
        opSelect.style.fontWeight = "bold";
        equals.forEach(eq => {
            const opt = document.createElement("option");
            opt.value = eq.value ?? eq.Value ?? eq;
            opt.textContent = eq.text ?? eq.Text ?? eq;
            opSelect.appendChild(opt);
        });

        const defEqRaw = (field.defaultEqual || field.DefaultEqual || "").toString();
        const defEq = defEqRaw.toLowerCase();
        if (defEq && !Array.from(opSelect.options).some(o => o.value.toLowerCase() === defEq)) {
            const opt = document.createElement("option");
            opt.value = defEqRaw;
            opt.textContent = defEqRaw;
            opSelect.appendChild(opt);
        }
        if (defEq) {
            const hit = Array.from(opSelect.options).find(o => o.value.toLowerCase() === defEq);
            if (hit) opSelect.value = hit.value;
        }

        const controlType = Number(field.controlType ?? field.ControlType ?? 0);
        const dataType = Number(field.dataType ?? field.DataType ?? 0);
        const commandText = (field.commandText || field.CommandText || "").toString();
        const superId = (field.superId || field.SuperId || "").toString();
        const readOnly = Number(field.iReadOnly ?? field.IReadOnly ?? field.readOnly ?? 0) === 1;

        let input;
        if (controlType === 1 || controlType === 2 || commandText) {
            const select = document.createElement("select");
            select.className = "form-select query-input";
            select.dataset.param = normalizeKey(colName);
            select.dataset.column = colName;
            if (superId) select.dataset.super = normalizeKey(superId);
            input = select;
        } else {
            const inp = document.createElement("input");
            inp.className = "form-control query-input";
            inp.type = dataType === 1 ? "date" : "text";
            input = inp;
        }

        input.name = key;
        input.dataset.field = colName;
        input.dataset.key = key;
        input.dataset.column = colName;
        if (field.tableName || field.TableName) input.dataset.tableName = field.tableName || field.TableName;
        if (field.aliasName || field.AliasName) input.dataset.aliasName = field.aliasName || field.AliasName;
        if (readOnly) input.readOnly = true;

        row.appendChild(label);
        row.appendChild(opSelect);
        row.appendChild(input);
        wrap.appendChild(row);
        gridEl.appendChild(wrap);

        const rawDefaultVal = applyDefaultByType(field);
        let defaultVal = applyEditMask(rawDefaultVal, field);
        if (input.type === "date") {
            defaultVal = normalizeDateValue(defaultVal);
        }

        

        // 憒? defaultType=1嚗QL?誘嚗?預設?潮???SQL 摮葡嚗”蝷?SQL 瘝??瑁?嚗?閬‵??
        const defType = Number(field.defaultType ?? field.DefaultType ?? 0);
        if (defType === 1 && looksLikeSqlDefault(defaultVal)) {
            defaultVal = "";
        }

        // 憒??舀??雿泵嚗?蝛?
        if (input.type === "date" && isDatePlaceholder(defaultVal)) {
            defaultVal = "";
        }
        if (input.tagName === "SELECT") {
            const superValue = superId ? readSuperValue(superId) : "";
            const opts = await loadOptions(colName, superValue);
            buildOptionList(input, opts, defaultVal);
        } else if (defaultVal) {
            input.value = defaultVal;
        } else if (input.type === "date") {
            // 蝣箔??交?甈?皜征雿?蝚?
            input.value = "";
        }

        if (input.tagName === "SELECT") {
            input.addEventListener("focus", async () => {
                const superValue = superId ? readSuperValue(superId) : "";
                const opts = await loadOptions(colName, superValue);
                buildOptionList(input, opts, input.value || defaultVal);
            });
        }
    };

    const readSuperValue = (superId) => {
        const key = normalizeKey(superId);
        if (!key) return "";
        const el = formEl.querySelector(`[data-param="${key}"]`);
        if (el && (el.value ?? "") !== "") return el.value ?? "";
        const byName = formEl.querySelector(`[name="${CSS.escape(key)}"]`);
        if (byName && (byName.value ?? "") !== "") return byName.value ?? "";
        return "";
    };

    const wireSuperChange = () => {
        const selects = Array.from(formEl.querySelectorAll("select[data-super]"));
        const bySuper = new Map();
        selects.forEach(sel => {
            const key = sel.dataset.super || "";
            if (!key) return;
            if (!bySuper.has(key)) bySuper.set(key, []);
            bySuper.get(key).push(sel);
        });

        bySuper.forEach((children, superKey) => {
            const superEl = formEl.querySelector(`[data-param="${superKey}"]`) || formEl.querySelector(`[name="${CSS.escape(superKey)}"]`);
            if (!superEl) return;
            superEl.addEventListener("change", async () => {
                for (const child of children) {
                    const col = child.dataset.column || "";
                    const opts = await loadOptions(col, superEl.value || "");
                    buildOptionList(child, opts, "");
                }
            });
        });
    };

    let buildPromise = null;

    const buildForm = async () => {
        if (building) {
            if (buildPromise) {
                await buildPromise;
            }
            return;
        }
        building = true;

        buildPromise = (async () => {
            gridEl.innerHTML = "";
            try {
                const [fields, equals] = await Promise.all([loadQueryFields(), fetchEquals()]);
                if (!Array.isArray(fields) || fields.length === 0) {
                    console.warn('[QueryPanel] 沒有查詢欄位，無法建立表單');
                    return;
                }
                for (let i = 0; i < fields.length; i++) {
                    await buildField(fields[i], equals, i);
                }
                wireSuperChange();
            } catch (err) {
                console.error('[QueryPanel] 建立查詢表單發生錯誤', err);
            }
        })();

        await buildPromise;
        building = false;
        buildPromise = null;
    };

    window.QueryFieldsManager = {
        refresh: async () => {
            cachedFields = null;
            await buildForm();
        },
        load: buildForm
    };

    if (modalEl) {
        modalEl.addEventListener("shown.bs.modal", () => {
            // 皜敹怠?嚗Ⅱ靽??啗??亥??蒂?瑁? SQL
            cachedFields = null;
            buildForm().catch(() => {});
        });
    }

    (function enableQueryModalDrag() {
        const content = document.querySelector('.query-modal-content');
        if (!content) return;

        const dialog = content.closest('.modal-dialog');
        const modal = content.closest('.modal');
        const header = content.querySelector('.modal-header');
        if (!dialog || !header) return;

        let dragging = false;
        let startX = 0, startY = 0, startLeft = 0, startTop = 0;

        const resetDialogStyle = () => {
            dialog.style.position = '';
            dialog.style.left = '';
            dialog.style.top = '';
            dialog.style.margin = '';
            dialog.style.transform = '';
        };

        const begin = (ev) => {
            const isMouse = ev.pointerType === 'mouse' || ev.pointerType === undefined;
            if (isMouse && ev.button !== 0) return;
            if (ev.target?.closest('button, input, select, textarea, a')) return;

            const rect = dialog.getBoundingClientRect();
            dialog.style.position = 'fixed';
            dialog.style.margin = '0';
            dialog.style.left = `${rect.left}px`;
            dialog.style.top = `${rect.top}px`;
            dialog.style.transform = 'none';

            startX = ev.clientX;
            startY = ev.clientY;
            startLeft = rect.left;
            startTop = rect.top;
            dragging = true;

            if (header.setPointerCapture && ev.pointerId !== undefined) {
                header.setPointerCapture(ev.pointerId);
            }
            ev.preventDefault();
        };

        const move = (ev) => {
            if (!dragging) return;
            const dx = ev.clientX - startX;
            const dy = ev.clientY - startY;

            const w = dialog.offsetWidth || dialog.getBoundingClientRect().width;
            const h = dialog.offsetHeight || dialog.getBoundingClientRect().height;

            let left = startLeft + dx;
            let top = startTop + dy;

            const keepVisibleX = 120;
            const keepVisibleY = 80;
            const minLeft = -(w - keepVisibleX);
            const maxLeft = window.innerWidth - keepVisibleX;
            const minTop = -(h - keepVisibleY);
            const maxTop = window.innerHeight - keepVisibleY;

            left = Math.min(Math.max(minLeft, left), maxLeft);
            top = Math.min(Math.max(minTop, top), maxTop);

            dialog.style.left = `${left}px`;
            dialog.style.top = `${top}px`;
        };

        const end = () => { dragging = false; };

        header.addEventListener('pointerdown', begin);
        header.addEventListener('pointermove', move);
        header.addEventListener('pointerup', end);
        header.addEventListener('pointercancel', end);

        if (modal) {
            modal.addEventListener('hidden.bs.modal', resetDialogStyle);
            modal.addEventListener('show.bs.modal', resetDialogStyle);
        }
    })();
})();
</script>


