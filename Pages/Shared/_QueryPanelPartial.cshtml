@model List<QueryFieldViewModel>
@{
    var condOps = new List<SelectListItem> {
        new("=", "="), new(">=", ">="), new("<=", "<="), new("like", "like")
    };
    int colCount = 3;
}

<form id="searchForm" method="post" class="modal-content query-modal-content">
    <div class="modal-header">
        <h5 class="modal-title">查詢條件</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
        <div class="container-fluid">
            @for (int i = 0; i < Model.Count; i += colCount)
            {
                <div class="row">
                    @for (int j = 0; j < colCount && i + j < Model.Count; j++)
                    {
                        var field = Model[i + j];
                        // 1. 這裡直接產生唯一 key
                        var inputName = field.ColumnName + field.SortOrder;
                        var condName = "Cond_" + field.ColumnName + field.SortOrder;
                        <div class="col-12 col-sm-6 col-md-4 mb-3">
                            <label>@field.ColumnCaption</label>
                            <div class="d-flex align-items-center gap-2">
                                <!-- 條件符號下拉 -->
                                <select name="@condName" class="form-select query-op" style="font-weight:bold">
                                    @foreach(var op in condOps)
                                    {
                                        if (field.DefaultEqual == op.Value)
                                        {
                                            <option value="@op.Value" selected>@op.Text</option>
                                        }  
                                        else
                                        {
                                            <option value="@op.Value">@op.Text</option>
                                        }
                                    }
                                </select>
                                @if (field.ControlType == 2)
                                {
                                    var options = ViewData[$"Option_{field.ColumnName}"] as List<SelectListItem> ?? new();
                                    <select name="@inputName" class="form-select query-input">
                                        <option value="">--請選擇--</option>
                                        @foreach(var opt in options)
                                        if (field.DefaultValue == opt.Value)
                                            {
                                                <option value="@opt.Value" selected>@opt.Text</option>
                                            }
                                            else
                                            {
                                                <option value="@opt.Value">@opt.Text</option>
                                            }
                                        }
                                    </select>
                                }
                                else if (field.DataType == 1)
                                {
                                    <input type="date" name="@inputName" class="form-control query-input" value="@field.DefaultValue" />
                                }
                                //else if (field.DataType == 2)
                                //{
                                    //<input type="number" name="@inputName" class="form-control" value="@field.DefaultValue" />
                                //}
                                else
                                {
                                    <input type="text" name="@inputName" class="form-control query-input" value="@field.DefaultValue" />
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary">查詢</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
    </div>
</form>

<style>
    .query-modal-content .modal-header { cursor: move; user-select: none; }
    .query-modal-content .modal-header :is(button, input, select, textarea, a) { cursor: default; }
    .query-modal-content .query-op { flex: 0 0 72px; min-width: 72px; max-width: 72px; }
    .query-modal-content .query-input { flex: 1 1 0; min-width: 0; }
    .query-modal-content .modal-body .d-flex { flex-wrap: nowrap; }
</style>

<script>
    // 讓查詢視窗可拖曳（拖曳區：modal-header）
    (function enableQueryModalDrag() {
        const content = document.querySelector('.query-modal-content');
        if (!content) return;

        const dialog = content.closest('.modal-dialog');
        const modal = content.closest('.modal');
        const header = content.querySelector('.modal-header');
        if (!dialog || !header) return;

        let dragging = false;
        let startX = 0, startY = 0, startLeft = 0, startTop = 0;

        const resetDialogStyle = () => {
            dialog.style.position = '';
            dialog.style.left = '';
            dialog.style.top = '';
            dialog.style.margin = '';
            dialog.style.transform = '';
        };

        const begin = (ev) => {
            const isMouse = ev.pointerType === 'mouse' || ev.pointerType === undefined;
            if (isMouse && ev.button !== 0) return;
            if (ev.target?.closest('button, input, select, textarea, a')) return;

            const rect = dialog.getBoundingClientRect();
            dialog.style.position = 'fixed';
            dialog.style.margin = '0';
            dialog.style.left = `${rect.left}px`;
            dialog.style.top = `${rect.top}px`;
            dialog.style.transform = 'none';

            startX = ev.clientX;
            startY = ev.clientY;
            startLeft = rect.left;
            startTop = rect.top;
            dragging = true;

            if (header.setPointerCapture && ev.pointerId !== undefined) {
                header.setPointerCapture(ev.pointerId);
            }
            ev.preventDefault();
        };

        const move = (ev) => {
            if (!dragging) return;
            const dx = ev.clientX - startX;
            const dy = ev.clientY - startY;

            const w = dialog.offsetWidth || dialog.getBoundingClientRect().width;
            const h = dialog.offsetHeight || dialog.getBoundingClientRect().height;

            let left = startLeft + dx;
            let top = startTop + dy;

            // 允許拖到畫面外，但保留一點點可抓回來
            const keepVisibleX = 120;
            const keepVisibleY = 80;
            const minLeft = -(w - keepVisibleX);
            const maxLeft = window.innerWidth - keepVisibleX;
            const minTop = -(h - keepVisibleY);
            const maxTop = window.innerHeight - keepVisibleY;

            left = Math.min(Math.max(minLeft, left), maxLeft);
            top = Math.min(Math.max(minTop, top), maxTop);

            dialog.style.left = `${left}px`;
            dialog.style.top = `${top}px`;
        };

        const end = () => { dragging = false; };

        header.addEventListener('pointerdown', begin);
        header.addEventListener('pointermove', move);
        header.addEventListener('pointerup', end);
        header.addEventListener('pointercancel', end);

        // 關掉 modal 時恢復 bootstrap 原本的定位（避免下次開啟偏移）
        if (modal) {
            modal.addEventListener('hidden.bs.modal', resetDialogStyle);
            modal.addEventListener('show.bs.modal', resetDialogStyle);
        }
    })();
</script>
