<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>@ViewData["Title"] - JSIS</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400&display=swap">

  @RenderSection("Styles", required: false)
  <style>
    html, body { height: 100%; }
    :root {
      --app-toolbar-height: 56px;
      --field-label-size: 14px;
      --field-value-size: 13px;
      --detail-max-width: 1400px;
      --detail-left-pad: 0px;
      --tab-pad-y: 2px;
      --tab-pad-x: 8px;
      --top-toolbar-font-size: 15px;
      --top-toolbar-icon-size: 20px;
      --top-toolbar-btn-height: 36px;
      --top-toolbar-icon-font-size: 26px;
      --page-bg: #f4f6fb;
      --section-bg-toolbar: #f6f7f9;
      --section-bg-rail: #eef2f9;
      --section-bg-header: #f3f6fb;
      --section-bg-detail: #f7f9fd;
    }
    html {
      background: var(--page-bg);
    }
    body {
      background: var(--page-bg);
      font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    }
    body.with-toolbar {
      padding-top: var(--app-toolbar-height);
    }

    .app-toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--app-toolbar-height);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      z-index: 2000;
    }
    .app-toolbar .toolbar-left,
    .app-toolbar .toolbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .app-toolbar .toolbar-center {
      flex: 1 1 auto;
      text-align: center;
      font-weight: 700;
      color: #1f3a8a;
      letter-spacing: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 0 12px;
    }
    .toolbar-home-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border: 1px solid #cbd5f5;
      border-radius: 8px;
      background: #f8fafc;
      color: #1f3a8a;
      font-weight: 600;
      cursor: pointer;
    }
    .toolbar-home-btn:hover {
      background: #eef2ff;
    }
    .toolbar-home-btn.icon-only {
      padding: 6px 8px;
      gap: 0;
    }
    .toolbar-help-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      border: 1px solid #cbd5f5;
      border-radius: 8px;
      background: #f8fafc;
      color: #1f3a8a;
      font-weight: 600;
      cursor: pointer;
    }
    .toolbar-help-btn:hover {
      background: #eef2ff;
    }
    .toolbar-help-btn.icon-only {
      padding: 6px 8px;
      gap: 0;
    }
    .toolbar-help-btn .bi {
      font-size: 18px;
      line-height: 1;
      display: block;
    }

    #itemNotesModal .modal-dialog {
      max-width: 820px;
      width: 820px;
    }
    #itemNotesUserModal .modal-dialog {
      max-width: 820px;
      width: 820px;
    }
    .toolbar-user {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #334155;
      font-weight: 600;
    }
    .toolbar-user .value-box {
      padding: 2px 8px;
      border: 1px solid #cbd5f5;
      border-radius: 6px;
      background: #f8fafc;
      color: #1f2937;
      font-weight: 600;
    }
    .toolbar-user .label {
      font-weight: 500;
      color: #64748b;
    }
    .toolbar-palette {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-right: 8px;
    }
    .toolbar-palette .palette-picker-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid #cbd5f5;
      background: #f8fafc;
      color: #1f3a8a;
      cursor: pointer;
      font-size: 18px;
    }
    .toolbar-palette .palette-picker-btn:hover {
      background: #eef2ff;
    }
    .palette-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 6px;
      background: #fff;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      padding: 12px;
      min-width: 200px;
      z-index: 3000;
    }
    .palette-dropdown.show {
      display: block;
    }
    .palette-dropdown-title {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 10px;
    }
    .palette-presets {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    .palette-preset {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      border: 2px solid #d1d5db;
      cursor: pointer;
      transition: transform 0.1s, border-color 0.1s;
    }
    .palette-preset:hover {
      transform: scale(1.1);
      border-color: #6366f1;
    }
    .palette-preset.active {
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
    }
    .palette-custom {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-top: 10px;
      border-top: 1px solid #e5e7eb;
      margin-bottom: 10px;
    }
    .palette-custom-label {
      font-size: 12px;
      color: #6b7280;
      white-space: nowrap;
    }
    .palette-color-input-visible {
      width: 100%;
      height: 32px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      cursor: pointer;
      padding: 2px;
    }
    .palette-reset-btn {
      width: 100%;
      padding: 6px 12px;
      font-size: 12px;
      color: #6b7280;
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      cursor: pointer;
    }
    .palette-reset-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }
    .toolbar-brand {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #1f3a8a;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .toolbar-brand img {
      height: 35px;
      width: auto;
      display: block;
      margin-bottom: 5px;
    }
    .toolbar-brand .label {
      padding: 2px 8px;
      border: 1px solid #cbd5f5;
      border-radius: 6px;
      background: #f8fafc;
      color: #1f3a8a;
      font-weight: 700;
    }
    .toolbar-title-left {
      font-weight: 700;
      color: #1f3a8a;
      letter-spacing: 1px;
      white-space: nowrap;
      font-size: 18px;
    }

    /* 麵包屑導航樣式 */
    .toolbar-breadcrumb {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 15px;
      white-space: nowrap;
    }
    .toolbar-breadcrumb .breadcrumb-link {
      color: #64748b;
      text-decoration: none;
      transition: color 0.15s;
    }
    .toolbar-breadcrumb .breadcrumb-link:hover {
      color: #1f3a8a;
      text-decoration: underline;
    }
    .toolbar-breadcrumb .breadcrumb-text {
      color: #64748b;
    }
    .toolbar-breadcrumb .breadcrumb-sep {
      color: #94a3b8;
      font-size: 12px;
    }
    .toolbar-breadcrumb .breadcrumb-current {
      color: #1f3a8a;
      font-weight: 700;
    }

    /* Center all bootstrap modals on screen */
    .modal.show {
      display: flex !important;
      align-items: center;
      justify-content: center;
    }
    .modal .modal-dialog {
      margin: 0;
    }
    .modal .modal-dialog.modal-dialog-scrollable {
      max-height: 90vh;
    }

    /* SweetAlert2: avoid active/focus glow on buttons */
    .swal2-styled:focus,
    .swal2-styled:focus-visible,
    .swal2-styled:active,
    .swal2-styled:active:focus,
    .swal2-popup button:focus,
    .swal2-popup button:active {
      outline: none !important;
      box-shadow: none !important;
      filter: none !important;
    }
    .swal2-actions .swal2-styled:not([disabled]):active {
      box-shadow: none !important;
      filter: none !important;
      transform: none !important;
    }
    .swal2-popup .swal2-confirm:active,
    .swal2-popup .swal2-cancel:active {
      background-image: none !important;
      filter: none !important;
      box-shadow: none !important;
      transform: none !important;
    }

    /* ✅ 全站共用 Loading Overlay */
    .app-loading-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(1px);
      z-index: 11000;
      transition: opacity 0.2s ease-in-out;
    }
    .app-loading-overlay.show {
      display: flex;
      opacity: 1;
    }

    /* ✅ 防止灰畫面殘影 */
    #loadingOverlay:not(.show) {
      display: none !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    .app-loading-overlay .box {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: #fff;
      padding: 14px 18px;
      border-radius: 12px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.12);
      color: #0d6efd;
      font-weight: 600;
    }

    /* 確保 Modal 遮罩可以覆蓋工具列 */
    .modal-backdrop {
      z-index: 2001 !important;
    }
    .modal {
      z-index: 2002 !important;
    }
    /* SweetAlert2 遮罩覆蓋工具列 */
    .swal2-container {
      z-index: 2003 !important;
    }
  </style>
</head>

@{
  var homeUrl = (ViewData["MainMenuUrl"]?.ToString()) ?? Url.Page("/FontIndex") ?? "/FontIndex";
  var path = (Context.Request.Path.Value ?? "").ToLowerInvariant();
  var showToolbar = path != "/login";
  var isHome = path == "/" || path == "/fontindex";
  var homeLabel = (path == "/" || path == "/index") ? "後台設定" : "主選單";
  var rawTitle = (ViewData["Title"]?.ToString()) ?? "";
  var toolbarTitle = System.Text.RegularExpressions.Regex.Replace(rawTitle, "([A-Za-z0-9])([\\u4e00-\\u9fff])", "$1 $2");
  toolbarTitle = System.Text.RegularExpressions.Regex.Replace(toolbarTitle, "([\\u4e00-\\u9fff])([A-Za-z0-9])", "$1 $2");
}

<body class="@(showToolbar ? "with-toolbar" : "")">
  @if (showToolbar)
  {
    <div class="app-toolbar" role="navigation" aria-label="全站工具列">
      <div class="toolbar-left">
        @if (!isHome)
        {
          var breadcrumbs = ViewData["Breadcrumbs"] as System.Collections.IList;
          if (breadcrumbs != null && breadcrumbs.Count > 0)
          {
            <nav class="toolbar-breadcrumb" aria-label="麵包屑導航">
              @foreach (dynamic crumb in breadcrumbs)
              {
                if (!string.IsNullOrEmpty((string)crumb.Url))
                {
                  <a href="@crumb.Url" class="breadcrumb-link">@crumb.Name</a>
                }
                else
                {
                  <span class="breadcrumb-text">@crumb.Name</span>
                }
                <span class="breadcrumb-sep">&gt;</span>
              }
              <span class="breadcrumb-current">@toolbarTitle</span>
            </nav>
          }
          else
          {
            <div class="toolbar-title-left" id="toolbarTitle">@toolbarTitle</div>
          }
        }
        else
        {
          <div class="toolbar-brand" aria-label="@homeLabel">
            <img src="/images/LOGO.jpg" alt="JSIS" />
            <span class="label">@homeLabel</span>
          </div>
        }
      </div>
      <div class="toolbar-right">
        @if (!isHome)
        {
          <button type="button" id="__btnBackToMenu" class="toolbar-home-btn icon-only" title="返回主畫面" aria-label="返回主畫面">
            <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false" width="18" height="18" fill="currentColor">
              <path d="M8 .5 1 6v9a1 1 0 0 0 1 1h4.5v-5h3v5H14a1 1 0 0 0 1-1V6L8 .5Z"/>
              <path d="M13 2.5v2.708l2 1.6V2.5a1 1 0 0 0-1.555-.832L9.5 4.15 10.5 5l2.5-2.5Z"/>
            </svg>
          </button>
        }
        @if (!isHome)
        {
          <button type="button" id="__btnItemNotes" class="toolbar-home-btn toolbar-help-btn icon-only" title="作業說明" aria-label="作業說明">
            <i class="bi bi-info-circle"></i>
          </button>
          <button type="button" id="__btnItemNotesUser" class="toolbar-home-btn toolbar-help-btn icon-only" title="個人作業說明" aria-label="個人作業說明">
            <i class="bi bi-person-lines-fill"></i>
          </button>
        }
        <div class="toolbar-palette" role="group" aria-label="背景配色">
          <button type="button" class="palette-picker-btn" id="palettePickerBtn" title="選擇背景顏色" aria-label="選擇背景顏色">
            <i class="bi bi-palette"></i>
          </button>
          <div class="palette-dropdown" id="paletteDropdown">
            <div class="palette-dropdown-title">背景配色</div>
            <div class="palette-presets">
              <button type="button" class="palette-preset" data-color="#f4f6fb" title="預設（冷灰）" style="background:#f4f6fb;"></button>
              <button type="button" class="palette-preset" data-color="#f6f1e9" title="砂岩" style="background:#f6f1e9;"></button>
              <button type="button" class="palette-preset" data-color="#eef6f4" title="薄荷" style="background:#eef6f4;"></button>
              <button type="button" class="palette-preset" data-color="#eef2f7" title="墨藍" style="background:#eef2f7;"></button>
              <button type="button" class="palette-preset" data-color="#f5f0f5" title="淡紫" style="background:#f5f0f5;"></button>
              <button type="button" class="palette-preset" data-color="#faf5f0" title="暖橙" style="background:#faf5f0;"></button>
              <button type="button" class="palette-preset" data-color="#f0f5f0" title="淺綠" style="background:#f0f5f0;"></button>
              <button type="button" class="palette-preset" data-color="#ffffff" title="純白" style="background:#ffffff;"></button>
            </div>
            <div class="palette-custom">
              <label class="palette-custom-label">自訂顏色</label>
              <input type="color" id="paletteColorInput" class="palette-color-input-visible" value="#f4f6fb" />
            </div>
            <button type="button" class="palette-reset-btn" id="paletteResetBtn">恢復預設</button>
          </div>
        </div>
        <div class="toolbar-user">
          <span class="label">公司別</span>
          <span id="toolbarBuName" class="value-box">未指定</span>
          <span class="label">登入者</span>
          <span id="toolbarUserName" class="value-box">未登入</span>
        </div>
      </div>
    </div>
  }

  @RenderBody()

  <!-- ✅ 全站共用 Loading Overlay -->
  <div id="loadingOverlay" class="app-loading-overlay" aria-live="polite" aria-busy="true">
    <div class="box">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <div class="msg" id="loadingMsg">處理中…</div>
    </div>
  </div>

  <div class="modal fade" id="itemNotesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="itemNotesTitle">作業說明</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <textarea id="itemNotesText" class="form-control" rows="12"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" id="itemNotesSave" class="btn btn-primary">儲存</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="itemNotesUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="itemNotesUserTitle">個人作業說明</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <textarea id="itemNotesUserText" class="form-control" rows="12"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" id="itemNotesUserSave" class="btn btn-primary">儲存</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
        </div>
      </div>
    </div>
  </div>

  <!-- === Bootstrap & SweetAlert === -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // ===============================
    // ? 全站工具列：主畫面按鈕 + 登入者
    // ===============================
    (() => {
      const btn = document.getElementById('__btnBackToMenu');
      if (btn) {
        btn.addEventListener('click', function (e) {
          e.preventDefault();
          e.stopPropagation();
          const url = '@homeUrl';
          const dirty = !!window.__unsavedChanges;
          if (!dirty) { location.href = url; return; }

          if (window.Swal) {
            Swal.fire({
              icon: 'question',
              title: '確定返回主畫面？',
              text: '可能有尚未儲存的變更。',
              showCancelButton: true,
              confirmButtonText: '確認返回',
              cancelButtonText: '取消'
            }).then(r => { if (r.isConfirmed) location.href = url; });
          } else {
            if (confirm('可能有尚未儲存的變更，確定要返回主畫面？')) location.href = url;
          }
        });
      }

      const userNameEl = document.getElementById('toolbarUserName');
      if (userNameEl) {
        const localUser = localStorage.getItem('erpLoginUserId');
        const userId = localUser || window._userId;
        if (!window._userId && localUser) window._userId = localUser;
        if (window.__isAdmin == null) window.__isAdmin = false;
        if (userId) {
          userNameEl.textContent = userId;
          const cacheKey = `erpIsAdmin:${userId.toString().trim().toLowerCase()}`;
          const cached = localStorage.getItem(cacheKey);
          if (cached === '1') {
            window.__isAdmin = true;
            document.body.dataset.isAdmin = '1';
          }
          fetch(`/api/Login/UserInfo?userId=${encodeURIComponent(userId)}`)
            .then(r => r.ok ? r.json() : null)
            .then(data => {
              if (!data || !data.userName) return;
              userNameEl.textContent = `${userId} ${data.userName}`;
            })
            .catch(() => { /* ignore */ });
          fetch(`/api/Login/UserAdmin?userId=${encodeURIComponent(userId)}`)
            .then(r => r.ok ? r.json() : null)
            .then(data => {
              const isAdmin = data && data.isAdmin === true;
              window.__isAdmin = isAdmin;
              document.body.dataset.isAdmin = isAdmin ? '1' : '0';
              localStorage.setItem(cacheKey, isAdmin ? '1' : '0');
              window.dispatchEvent(new CustomEvent('adminStateReady', { detail: { isAdmin } }));
            })
            .catch(() => {
              window.__isAdmin = false;
              document.body.dataset.isAdmin = '0';
              window.dispatchEvent(new CustomEvent('adminStateReady', { detail: { isAdmin: false } }));
            });
        } else {
          userNameEl.textContent = '未登入';
        }
      }

      const buNameEl = document.getElementById('toolbarBuName');
      if (buNameEl) {
        const buName = localStorage.getItem('erpLoginBUName');
        buNameEl.textContent = buName || '未指定';
      }

      const getItemIdFromUrl = () => {
        const path = (location.pathname || '').toString();
        const m1 = path.match(/\/DynamicTemplate\/Paper3L\/([^\/]+)/i);
        if (m1 && m1[1]) return decodeURIComponent(m1[1]);
        const m2 = path.match(/\/DynamicTemplate\/Paper\/([^\/]+)/i);
        if (m2 && m2[1]) return decodeURIComponent(m2[1]);
        const m3 = path.match(/\/CUR\/[^\/]+\/([^\/]+)/i);
        if (m3 && m3[1]) return decodeURIComponent(m3[1]);
        const last = path.split('/').filter(Boolean).pop() || '';
        if (/^[A-Za-z]{2,}\d{3,}$/i.test(last)) return decodeURIComponent(last);
        return '';
      };

      const btnNotes = document.getElementById('__btnItemNotes');
      const btnSave = document.getElementById('itemNotesSave');
      const btnNotesUser = document.getElementById('__btnItemNotesUser');
      const btnSaveUser = document.getElementById('itemNotesUserSave');
      if (btnNotes) {
        btnNotes.addEventListener('click', async () => {
          const itemId = (window._itemId || getItemIdFromUrl() || '').toString().trim();
          if (!itemId) {
            const titleEl = document.getElementById('itemNotesTitle');
            const textEl = document.getElementById('itemNotesText');
            if (titleEl) titleEl.textContent = '功能說明';
            if (textEl) textEl.value = '';
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('itemNotesModal'));
            modal.show();
            return;
          }

          const fetcher = window.busyFetch || fetch.bind(window);
          const resp = await fetcher(`/api/ItemNotes?itemId=${encodeURIComponent(itemId)}`);
          if (!resp.ok) {
            if (window.Swal) Swal.fire({ icon: 'error', title: '載入失敗' });
            return;
          }
          const data = await resp.json().catch(() => ({}));
          const notes = (data?.notes ?? '').toString();

          const titleEl = document.getElementById('itemNotesTitle');
          const textEl = document.getElementById('itemNotesText');
          if (titleEl) titleEl.textContent = `${itemId} 功能說明`;
          if (textEl) textEl.value = notes || '（無說明）';

          const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('itemNotesModal'));
          modal.show();
        });
      }

      if (btnSave) {
        btnSave.addEventListener('click', async () => {
          const itemId = (window._itemId || getItemIdFromUrl() || '').toString().trim();
          if (!itemId) {
            if (window.Swal) Swal.fire({ icon: 'info', title: '找不到作業代號' });
            return;
          }
          const textEl = document.getElementById('itemNotesText');
          const notes = (textEl?.value ?? '').toString();
          const fetcher = window.busyFetch || fetch.bind(window);
          const resp = await fetcher('/api/ItemNotes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ itemId, notes })
          }, '儲存中…');
          if (!resp.ok) {
            if (window.Swal) Swal.fire({ icon: 'error', title: '儲存失敗' });
            return;
          }
          if (window.Swal) Swal.fire({ icon: 'success', title: '儲存完成', timer: 1000, showConfirmButton: false });
        });
      }

      if (btnNotesUser) {
        btnNotesUser.addEventListener('click', async () => {
          const itemId = (window._itemId || getItemIdFromUrl() || '').toString().trim();
          const userId = (localStorage.getItem('erpLoginUserId') || window._userId || '').toString().trim();
          if (!userId) {
            if (window.Swal) Swal.fire({ icon: 'info', title: '找不到使用者' });
            return;
          }
          if (!itemId) {
            const titleEl = document.getElementById('itemNotesUserTitle');
            const textEl = document.getElementById('itemNotesUserText');
            if (titleEl) titleEl.textContent = '個人作業說明';
            if (textEl) textEl.value = '';
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('itemNotesUserModal'));
            modal.show();
            return;
          }

          const fetcher = window.busyFetch || fetch.bind(window);
          const resp = await fetcher(`/api/ItemNotesUser?itemId=${encodeURIComponent(itemId)}&userId=${encodeURIComponent(userId)}`);
          if (!resp.ok) {
            if (window.Swal) Swal.fire({ icon: 'error', title: '載入失敗' });
            return;
          }
          const data = await resp.json().catch(() => ({}));
          const notes = (data?.notes ?? '').toString();

          const titleEl = document.getElementById('itemNotesUserTitle');
          const textEl = document.getElementById('itemNotesUserText');
          if (titleEl) titleEl.textContent = `${itemId} 個人作業說明`;
          if (textEl) textEl.value = notes || '（無說明）';

          const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('itemNotesUserModal'));
          modal.show();
        });
      }

      if (btnSaveUser) {
        btnSaveUser.addEventListener('click', async () => {
          const itemId = (window._itemId || getItemIdFromUrl() || '').toString().trim();
          const userId = (localStorage.getItem('erpLoginUserId') || window._userId || '').toString().trim();
          if (!userId) {
            if (window.Swal) Swal.fire({ icon: 'info', title: '找不到使用者' });
            return;
          }
          if (!itemId) {
            if (window.Swal) Swal.fire({ icon: 'info', title: '找不到作業代號' });
            return;
          }
          const textEl = document.getElementById('itemNotesUserText');
          const notes = (textEl?.value ?? '').toString();
          const fetcher = window.busyFetch || fetch.bind(window);
          const resp = await fetcher('/api/ItemNotesUser', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ itemId, userId, notes })
          }, '儲存中…');
          if (!resp.ok) {
            if (window.Swal) Swal.fire({ icon: 'error', title: '儲存失敗' });
            return;
          }
          if (window.Swal) Swal.fire({ icon: 'success', title: '儲存完成', timer: 1000, showConfirmButton: false });
        });
      }
    })();
  </script>

  <script>
    // Global draggable Bootstrap modals (drag by header).
    (() => {
      function initDraggable(modalEl) {
        if (!modalEl || modalEl.dataset.dragInit === "1") return;
        const dialog = modalEl.querySelector(".modal-dialog");
        const header = modalEl.querySelector(".modal-header");
        if (!dialog || !header) return;
        modalEl.dataset.dragInit = "1";
        header.style.cursor = "move";

        let dragging = false;
        let startX = 0, startY = 0, startLeft = 0, startTop = 0;

        const resetDialog = () => {
          dialog.style.position = "";
          dialog.style.left = "";
          dialog.style.top = "";
          dialog.style.margin = "";
          dialog.style.transform = "";
        };

        const begin = (ev) => {
          const isMouse = ev.pointerType === "mouse" || ev.pointerType === undefined;
          if (isMouse && ev.button !== 0) return;
          if (ev.target?.closest("button, input, select, textarea, a")) return;
          if (ev.target?.closest(".no-modal-drag")) return;
          const rect = dialog.getBoundingClientRect();
          dialog.style.position = "fixed";
          dialog.style.margin = "0";
          dialog.style.left = `${rect.left}px`;
          dialog.style.top = `${rect.top}px`;
          dialog.style.transform = "none";
          startX = ev.clientX;
          startY = ev.clientY;
          startLeft = rect.left;
          startTop = rect.top;
          dragging = true;
          if (header.setPointerCapture && ev.pointerId !== undefined) {
            header.setPointerCapture(ev.pointerId);
          }
          document.body.classList.add("modal-dragging");
          ev.preventDefault();
        };

        const move = (ev) => {
          if (!dragging) return;
          const dx = ev.clientX - startX;
          const dy = ev.clientY - startY;
          dialog.style.left = `${startLeft + dx}px`;
          dialog.style.top = `${startTop + dy}px`;
        };

        const end = () => {
          if (!dragging) return;
          dragging = false;
          document.body.classList.remove("modal-dragging");
        };

        header.addEventListener("pointerdown", begin);
        header.addEventListener("pointermove", move);
        header.addEventListener("pointerup", end);
        header.addEventListener("pointercancel", end);

        modalEl.addEventListener("hidden.bs.modal", resetDialog);
        modalEl.addEventListener("show.bs.modal", resetDialog);
      }

      document.addEventListener("shown.bs.modal", (e) => {
        const modalEl = e.target;
        if (modalEl && modalEl.classList?.contains("modal")) initDraggable(modalEl);
      });
    })();
  </script>

  <script>
    // ===============================
    // ✅ 全站 Loading Overlay 控制邏輯
    // ===============================
    (() => {
      const overlay = document.getElementById('loadingOverlay');
      const msgEl = document.getElementById('loadingMsg');
      let counter = 0;
      let lastShowAt = 0;
      const MIN_SHOW = 150;

      function openOverlay(msg) {
        if (msgEl) msgEl.textContent = msg || '處理中…';
        overlay.classList.add('show');
        overlay.style.display = 'flex';
        lastShowAt = Date.now();
      }

      function closeOverlay() {
        const elapsed = Date.now() - lastShowAt;
        const wait = Math.max(0, MIN_SHOW - elapsed);
        setTimeout(() => {
          overlay.classList.remove('show');
          overlay.style.display = 'none';
        }, wait);
      }

      window.showBusy = (msg) => {
        if (++counter === 1) openOverlay(msg);
      };
      window.hideBusy = () => {
        if (counter > 0 && --counter === 0) closeOverlay();
      };

      window.busyFetch = async (input, init, msg = '處理中…') => {
        showBusy(msg);
        try {
          return await fetch(input, init);
        } finally {
          hideBusy();
        }
      };

      // jQuery 兼容
      if (window.jQuery) {
        $(document).ajaxStart(() => showBusy('處理中…'));
        $(document).ajaxStop(() => hideBusy());
      }
    })();

    // ===============================
    // ✅ Modal 關閉時自動清理 (防止灰畫面)
    // ===============================
    (() => {
      if (window.__dictModalHandlerBound) return;
      window.__dictModalHandlerBound = true;

      document.addEventListener('hidden.bs.modal', (e) => {
        const id = e.target.id;
        const shouldForceClean = id && id.toLowerCase().includes('dictmodal');
        if (shouldForceClean) {
          // 清除 Bootstrap backdrop
          document.querySelectorAll('.modal-backdrop').forEach((b) => b.remove());
          // 清除 body 狀態
          document.body.classList.remove('modal-open');
          document.body.style.overflow = '';
          document.body.style.paddingRight = '';
          // 強制關閉 overlay
          const overlay = document.getElementById('loadingOverlay');
          if (overlay) {
            overlay.classList.remove('show');
            overlay.style.display = 'none';
          }
        }
        // 對所有 modal 做一次保險清理
        setTimeout(() => {
          if (document.querySelector('.modal.show')) return;
          document.querySelectorAll('.modal-backdrop').forEach((b) => b.remove());
          document.body.classList.remove('modal-open');
          document.body.style.overflow = '';
          document.body.style.paddingRight = '';
          const overlay = document.getElementById('loadingOverlay');
          if (overlay) {
            overlay.classList.remove('show');
            overlay.style.display = 'none';
          }
        }, 0);
      });
    })();

    setInterval(() => {
        const jwt = localStorage.getItem("jwtId");
        if (!jwt) return;

        fetch("/api/Login/Ping", {
            method: "POST",
            headers: {
                "X-JWTID": jwt
            }
        });
    }, 10000); // 每10秒更新一次

    // 全域 fetch 包裝器
    const oldFetch = window.fetch;

    (async function () {
        // 攔截 fetch，發現 401 就回登入頁
        const origFetch = window.fetch;
        window.fetch = async (...args) => {
            const resp = await origFetch(...args);

            if (resp.status === 401) {
              localStorage.removeItem("jwtId");
              localStorage.removeItem("erpLoginBUId");
              localStorage.removeItem("erpLoginBUName");
                alert("您的登入已過期或被管理者剔除，請重新登入！");
                window.location.href = "/Login";
            }

            return resp;
        };
    })();

    (function initPalette() {
        const DEFAULT_COLOR = '#f4f6fb';

        // 根據基色生成相關色調
        const generatePaletteFromColor = (baseColor) => {
            const hex = baseColor.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);

            const lighten = (val, amount) => Math.min(255, Math.round(val + (255 - val) * amount));
            const darken = (val, amount) => Math.round(val * (1 - amount));
            const toHex = (r, g, b) => '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');

            return {
                page: baseColor,
                toolbar: toHex(lighten(r, 0.02), lighten(g, 0.02), lighten(b, 0.02)),
                rail: toHex(darken(r, 0.02), darken(g, 0.02), darken(b, 0.02)),
                header: toHex(lighten(r, 0.01), lighten(g, 0.01), lighten(b, 0.01)),
                detail: toHex(lighten(r, 0.04), lighten(g, 0.04), lighten(b, 0.04))
            };
        };

        const applyColor = (color, save = true) => {
            const p = generatePaletteFromColor(color);
            const root = document.documentElement;
            root.style.setProperty("--page-bg", p.page);
            root.style.setProperty("--section-bg-toolbar", p.toolbar);
            root.style.setProperty("--section-bg-rail", p.rail);
            root.style.setProperty("--section-bg-header", p.header);
            root.style.setProperty("--section-bg-detail", p.detail);
            if (save) localStorage.setItem("erpPaletteColor", color);
            updateActivePreset(color);
        };

        const updateActivePreset = (color) => {
            document.querySelectorAll('.palette-preset').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.color.toLowerCase() === color.toLowerCase());
            });
            const input = document.getElementById('paletteColorInput');
            if (input) input.value = color;
        };

        // 載入已儲存的顏色
        const saved = localStorage.getItem("erpPaletteColor");
        if (saved) {
            applyColor(saved, false);
        }

        const btn = document.getElementById('palettePickerBtn');
        const dropdown = document.getElementById('paletteDropdown');
        const input = document.getElementById('paletteColorInput');
        const resetBtn = document.getElementById('paletteResetBtn');

        if (btn && dropdown) {
            // 切換下拉選單
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('show');
            });

            // 點擊外部關閉
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target) && e.target !== btn) {
                    dropdown.classList.remove('show');
                }
            });

            // 預設色塊點擊
            dropdown.querySelectorAll('.palette-preset').forEach(preset => {
                preset.addEventListener('click', () => {
                    applyColor(preset.dataset.color);
                });
            });

            // 自訂顏色
            if (input) {
                input.addEventListener('input', (e) => applyColor(e.target.value));
                input.addEventListener('change', (e) => applyColor(e.target.value));
            }

            // 恢復預設
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    applyColor(DEFAULT_COLOR);
                });
            }
        }
    })();
  </script>

  @RenderSection("Scripts", required: false)
</body>
</html>
