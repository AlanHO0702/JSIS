<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>@ViewData["Title"] - JSIS</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    .app-loading-overlay{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      background:rgba(255,255,255,.65);
      backdrop-filter: blur(1px);
      z-index:11000;
    }
    .app-loading-overlay.show{ display:flex; }
    .app-loading-overlay .box{
      display:flex; align-items:center; gap:.75rem;
      background:#fff; padding:14px 18px; border-radius:12px;
      box-shadow:0 6px 24px rgba(0,0,0,.12);
      color:#0d6efd; font-weight:600;
    }
  </style>
</head>
<body>
@await Html.PartialAsync("~/Pages/Shared/_GlobalBackToMenu.cshtml")

  @RenderBody()

  <!-- 全站共用 Loading Overlay -->
  <div id="loadingOverlay" class="app-loading-overlay" aria-live="polite" aria-busy="true" style="display:none">
    <div class="box">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <div class="msg" id="loadingMsg">處理中…</div>
    </div>
  </div>

  <!-- 先載入 Bootstrap，再放 busy helpers，最後才是各頁的 Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (() => {
      const overlay = document.getElementById('loadingOverlay');
      const msgEl   = document.getElementById('loadingMsg');

      let counter = 0;
      let lastShowAt = 0;
      const MIN_SHOW = 150;

      function openOverlay(msg){
        if (msgEl) msgEl.textContent = msg || '處理中…';
        overlay.classList.add('show'); overlay.style.display = 'flex';
        lastShowAt = Date.now();
      }
      function closeOverlay(){
        const elapsed = Date.now() - lastShowAt;
        const wait = Math.max(0, MIN_SHOW - elapsed);
        setTimeout(() => {
          overlay.classList.remove('show');
          overlay.style.display = 'none';
        }, wait);
      }

      window.showBusy = (msg) => { if (++counter === 1) openOverlay(msg); };
      window.hideBusy = ()     => { if (counter > 0 && --counter === 0) closeOverlay(); };
      window.busyFetch = async (input, init, msg = '處理中…') => {
        showBusy(msg);
        try { return await fetch(input, init); }
        finally { hideBusy(); }
      };

      if (window.jQuery) {
        $(document).ajaxStart(() => showBusy('處理中…'));
        $(document).ajaxStop(()  => hideBusy());
      }
    })();
    
  </script>

  @RenderSection("Scripts", required: false)
</body>
</html>
