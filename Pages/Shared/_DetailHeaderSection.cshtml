@model dynamic
@using PcbErpApi.Helpers
@using System.Text.Json
@{
    // å–®é ­æ¬„ä½
    var headerFields = Model.HeaderTableFields; // å¯è¦–æ¬„ä½
    var headerData = Model.HeaderData; // å–®é ­è³‡æ–™ (Dictionary<string, object> æˆ–ä½ çš„å–®é ­Model)
    var headerFieldsList = ((IEnumerable<TableFieldViewModel>)Model.HeaderTableFields).ToList();
    var addApiUrl = ViewData["AddApiUrl"]?.ToString() ?? "";
    var detailRouteTemplate = ViewData["SubRouteTemplate"]?.ToString() ?? "";
    var tableName = ViewData["DictTableName"]?.ToString() ?? "";
    var keyFieldName = ViewData["KeyFieldName"]?.ToString() ?? "PaperNum";
    var queryRedirectUrl = ViewData["QueryRedirectUrl"]?.ToString() ?? "";
    var DeleteApiUrl = ViewData["DeleteApiUrl"]?.ToString() ?? "";
    static int NormalizeShowWhere(int? v)
    {
        // æœ‰äº›å–®æ“šå­—å…¸çš„ iShowWhere æœƒæ˜¯ 0ï¼ˆä»£è¡¨ç¬¬ä¸€é ï¼‰ï¼Œè‹¥éæ¿¾æœƒå°è‡´å–®é ­æ•´æ®µæ¶ˆå¤±
        return (v.HasValue && v.Value > 0) ? v.Value : 1;
    }

    var groupedTabs = headerFieldsList
        .GroupBy(f => NormalizeShowWhere(f.iShowWhere))
        .OrderBy(g => g.Key)
        .ToDictionary(g => g.Key, g => g.ToList());

    var firstTabKey = groupedTabs.Keys.FirstOrDefault();
    if (firstTabKey <= 0) firstTabKey = 1;
    var lookupMap = ViewData["LookupDisplayMap"] as Dictionary<string, Dictionary<string, string>>;

    var PaperNum = headerData.ContainsKey("PaperNum") ? headerData["PaperNum"]?.ToString() ?? "" : "";

    var headerLookupMap = ViewData["HeaderLookupMap"] as Dictionary<string, string>;

    string actionPartial = (ViewData["ActionRailPartial"] as string)
                           ?? "~/Pages/Shared/_ActionRail.Empty.cshtml";

    string? actionLogicPartial = (ViewData["ActionRailLogicPartial"] as string);

    // âœ… å–å¾—å–®é ­è¡¨åç¨±å’Œ Finished ç‹€æ…‹ï¼ˆé‡å° FmedIssueMainï¼‰
    string headerTableName = Model.HeaderTableName ?? "";
    int? finishedValue = null;
    if (headerTableName == "FMEdIssueMain" && headerData != null && headerData.ContainsKey("Finished"))
    {
        var finishedObj = headerData["Finished"];
        if (finishedObj != null)
        {
            int finishedTemp;
            if (int.TryParse(finishedObj.ToString(), out finishedTemp))
            {
                finishedValue = finishedTemp;
            }
        }
    }
}

<script>
    // âœ… å°‡ Finished ç‹€æ…‹æš´éœ²çµ¦å‰ç«¯ JavaScript
    window._headerTableName = '@headerTableName';
    window._finishedStatus = @(finishedValue?.ToString() ?? "null");
    window._paperNum = '@PaperNum';
</script>

<div id="topToolbar" class="d-flex align-items-center mb-4" style="gap:12px;" data-dict-table="@headerTableName">
    <div class="btn-group" role="group" aria-label="row-nav" style="gap:6px;">
        <button type="button" class="btn btn-outline-primary" id="btnPrev">ä¸Šä¸€ç­†</button>
        <button type="button" class="btn btn-outline-primary" id="btnNext">ä¸‹ä¸€ç­†</button>
    </div>
    <div class="btn-group" role="group" aria-label="sub-detail">
        <button type="button" class="btn btn-outline-success btn-sm" id="btnSubDetailAdd" title="æ–°å¢ç¬¬äºŒ/ç¬¬ä¸‰éšé …æ¬¡">+</button>
        <button type="button" class="btn btn-outline-danger btn-sm" id="btnSubDetailDelete" title="åˆªæ¸›ç¬¬äºŒ/ç¬¬ä¸‰éšé …æ¬¡">-</button>
    </div>
    <button type="submit" class="btn toolbar-btn" form="orderHeaderForm">
        å„²å­˜
    </button>
    <div class="ms-2">
        @await Html.PartialAsync("_TableToolbar", new TableToolbarModel {
            SearchBtnId = "btnSubSearch",
            AddBtnId = "btnSubAddNew",
            DeleteBtnId = "btnSubBatchDelete",
            QueryFields = ViewData["QueryFields"] as List<QueryFieldViewModel>,
            ModalId = "searchModal",
            ReportSpName = ViewData["ReportSpName"]?.ToString() ?? ""   // ğŸ‘ˆ å¾å¤–å±¤å†å‚³é€²ä¾†
        })
    </div>
</div>

<div class="action-rail">
    @await Html.PartialAsync(actionPartial, (object)Model)
</div>

@if (!string.IsNullOrWhiteSpace(actionLogicPartial))
{
    @await Html.PartialAsync(actionLogicPartial, (object)Model)
}

<!-- å–®é ­å¯ç·¨è¼¯è¡¨å–® -->
<form id="orderHeaderForm" class="erp-header-form" data-dict-table="@headerTableName">
    <div class="row">
        <!-- âœ… Tabs åˆ‡æ›åˆ— -->
        <ul class="nav nav-tabs" id="headerTabs" role="tablist">
            @foreach (var tab in groupedTabs.Keys)
            {
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(tab == firstTabKey ? "active" : "")"
                            id="tab-@tab-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#tab-@tab"
                            type="button" role="tab">
                        åˆ†é  @tab
                    </button>
                </li>
            }
        </ul>

        <!-- âœ… Tabs å°æ‡‰å…§å®¹ -->
        <div class="tab-content" id="headerTabContent">
            @foreach (var tab in groupedTabs)
            {
                <div class="tab-pane fade @(tab.Key == firstTabKey ? "show active" : "")"
                    id="tab-@tab.Key" role="tabpanel">
                    <ul class="list-unstyled header-fields-tab"
                        data-tab-index="@tab.Key"
                        style="position: relative">
                        @foreach (var field in tab.Value)
                        {
                            object rawValue = null;
                            headerData?.TryGetValue(field.FieldName, out rawValue);
                            string displayText = "";

                            // 1. lookup å„ªå…ˆé¡¯ç¤º
                            if (headerLookupMap != null && headerLookupMap.TryGetValue(field.FieldName, out var lookupVal))
                            {
                                displayText = lookupVal;
                            }
                            else if (rawValue != null)
                            {
                                //è¼¸å‡ºæ ¼å¼ç”¨Helperè½‰å‹
                                displayText = FormatHelper.FormatValue(rawValue, field.DataType, field.FormatStr);

                                // âœ… é€™è£¡è£œï¼šæ•¸å€¼å‹è‹¥ç‚ºç©ºï¼Œé¡¯ç¤º 0
                                if (string.IsNullOrWhiteSpace(displayText) && field.DataType?.ToLower() == "number")
                                {
                                    displayText = "0";
                                }
                            }

                            var top = field.iFieldTop ?? 0;
                            var left = field.iFieldLeft ?? 0;
                            var width = field.iFieldWidth ?? 160;
                            var height = field.iFieldHeight ?? 44;

                            var liClass = "draggable-field inline"; // æ°¸é æ©«æ’


                            var isCheckbox = (field.ComboStyle ?? 0) == 1;
                            var isReadOnly = (field.ReadOnly ?? 0) == 1;

                            // 1) å‹¾é¸æ¡†
                            if (isCheckbox)
                            {
                                var s = rawValue?.ToString()?.Trim() ?? "";
                                var isChecked = s == "1"
                                                || s.Equals("true", StringComparison.OrdinalIgnoreCase)
                                                || s.Equals("y", StringComparison.OrdinalIgnoreCase)
                                                || s.Equals("yes", StringComparison.OrdinalIgnoreCase);

                                <li class="@liClass"
                                    data-field="@field.FieldName"
                                    data-tab="@tab.Key"
                                    style="top:@(top)px; left:@(left)px; width:@(width)px; height:@(height)px;">
                                    <label>@field.DisplayLabel</label>
                                    <div class="form-check d-flex align-items-center" style="height:100%; margin:0; padding-left: 1.5rem;">
                                        <input type="hidden" name="@field.FieldName" value="0" />
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="@field.FieldName"
                                               value="1"
                                               @(isChecked ? "checked" : "")
                                               @(isReadOnly ? "disabled" : "") />
                                    </div>
                                </li>
                            }
                            // 2) åˆ¤æ–·æœ‰ lookup table è¨­å®š
                            else if (!string.IsNullOrWhiteSpace(field.LookupTable) &&
                                !string.IsNullOrWhiteSpace(field.LookupKeyField) &&
                                !string.IsNullOrWhiteSpace(field.LookupResultField))
                            {
                                // ä¸‹æ‹‰é¸å–®å…ƒä»¶ï¼ˆç”¨ selectï¼‰
                                <li class="@liClass"
                                    data-field="@field.FieldName"
                                    data-tab="@tab.Key"
                                    style="top:@(field.iFieldTop ?? 0)px; left:@(field.iFieldLeft ?? 0)px; width:@(field.iFieldWidth ?? 160)px; height:@(field.iFieldHeight ?? 44)px;">
                                    <label>@field.DisplayLabel</label>
                                    <select class="form-select lookup-dropdown"
                                            name="@field.FieldName"
                                            data-table="@field.LookupTable"
                                            data-key="@field.LookupKeyField"
                                            data-result="@field.LookupResultField.Replace(" ", "")"
                                            data-selected="@rawValue">
                                        <option value="">--è«‹é¸æ“‡--</option>
                                    </select>
                                </li>
                            }
                            else
                            {
                                <li class="@liClass"
                                    data-field="@field.FieldName"
                                    data-tab="@tab.Key"
                                    style="top:@(top)px; left:@(left)px; width:@(width)px; height:@(height)px;">
                                    <label>@field.DisplayLabel</label>
                                    <textarea class="form-control resizable-input"
                                            name="@field.FieldName">@displayText</textarea>
                                </li>
                            }
                        }
                    </ul>
                </div>
            }
        </div>
    </div>
</form>

<script>window._dictTableName = "@(ViewData["DictTableName"] ?? Model.TableName)";</script>

<!-- SweetAlert2 foræç¤º -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="~/js/toolbarHandler.js?v=@DateTime.Now.Ticks"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />

<script>
// ============================
// 0) é é¢å¸¸æ•¸ï¼Razor æ³¨å…¥
// ============================
const PAGE = {
  paperNum: "@PaperNum",
  keyField: ("@(keyFieldName ?? "PaperNum")" || "PaperNum").trim(),
  headerTable: ("@(Model.HeaderTableName ?? "")".trim() || "").toLowerCase(),
  detailTable: "@(tableName ?? "")".trim(),
  queryRedirectUrl: "@(ViewData["QueryRedirectUrl"])",
  addApiUrl: "@addApiUrl",
  deleteApiUrl: "@DeleteApiUrl",
  detailRouteTemplate: "@detailRouteTemplate",
  headerFields: @Html.Raw(JsonSerializer.Serialize(headerFieldsList)),
};

// æ”¾åœ¨æœ€å‰é¢ï¼ˆè¾­å…¸é–‹é—œï¼‰
window.__DICT_OPEN__ = false;

// è®“å…¶å®ƒå·¥å…·å¯ä»¥å–åˆ°ç›®å‰å–®è™Ÿ
window.selectedPaperNum = '@(Model.HeaderData["PaperNum"] ?? "")';

const PAGE_PAPER_NUM = ("@PaperNum" || "").trim();
const KEY_FIELD = ("@(keyFieldName ?? "PaperNum")" || "PaperNum").trim();

const backToMainTpl = (PAGE.queryRedirectUrl || '').trim()
  ? PAGE.queryRedirectUrl.replace(/\/$/, '') + '/{0}'
  : '';
const subTpl = (PAGE.detailRouteTemplate || '').replace(/\{PaperNum\}/gi, '{0}');
const finalSwitchTpl = backToMainTpl || subTpl;

console.debug('[Switch template]', finalSwitchTpl);
console.debug('[Sub template for new]', subTpl);

new ToolbarHandler({
  searchBtnId: "btnSubSearch",
  addBtnId: "btnSubAddNew",
  deleteBtnId: "btnSubBatchDelete",
  getSelectedId: () => (PAGE.paperNum || window.selectedPaperNum || ''),
  modalId: "searchModal",
  formId: "searchForm",
  addApiUrl: PAGE.addApiUrl,
  deleteApiUrlFn: id => `/api/${PAGE.deleteApiUrl}/${id || PAGE.paperNum}`,
  // å‹•æ…‹å–®æ“šçš„ä½œå»¢ï¼šèµ° PaperActionï¼ˆé¿å…æ‰¾ä¸åˆ° /api/{Table}/{PaperNum} controller è€Œ 404ï¼‰
  paperAction: { url: '/api/PaperAction/DoAction', paperId: "@Model.HeaderTableName", eoc: 0, aftFinished: 2 },
  detailRouteTemplate: subTpl,  // ä½¿ç”¨å–®èº«é è·¯å¾‘ï¼Œæ–°å¢å¾Œè·³è½‰åˆ°å–®èº«é 
  tableName: "@tableName",
  renderTable: null,
  renderPagination: null,
  renderOrderCount: null,
  restoreSearchForm: null,
  queryRedirectUrl: PAGE.queryRedirectUrl
});

// å–®èº«é  â†’ ä¸»é  åˆ‡æ›
(function hookToggleBackToMain() {
  const rawBtn = document.getElementById('btnToggle') ||
    Array.from(document.querySelectorAll('button, a'))
      .find(el => (el.textContent || '').trim() === 'åˆ‡æ›');
  if (!rawBtn) return;
  const btn = rawBtn.cloneNode(true);
  rawBtn.replaceWith(btn);
  btn.addEventListener('click', (e) => {
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    const base = ("@queryRedirectUrl" || '').trim().replace(/\/$/, '');
    if (!base) { Swal.fire({ icon: 'error', title: 'æœªæä¾›è¿”å›ä¸»é è·¯å¾‘' }); return; }
    const id = (PAGE_PAPER_NUM || window.selectedPaperNum || '').trim();
    const sep = base.includes('?') ? '&' : '?';
    const url = id ? `${base}${sep}${encodeURIComponent(KEY_FIELD)}=${encodeURIComponent(id)}` : base;
    location.href = url;
  }, { capture: true });
})();

// ============================
// å…±ç”¨å°å·¥å…·ï¼ˆæ•¸å€¼è™•ç†ã€å­—ä¸²åŒ–ï¼‰
// ============================
function normalizeNumberFields(obj, fieldDefs) {
  (fieldDefs || []).forEach(f => {
    if ((f.DataType || '').toLowerCase() === 'number') {
      const k = f.FieldName;
      if (obj[k] != null) obj[k] = obj[k].toString().replace(/,/g, '');
    }
  });
}

function withTemporarilyEnabled(formEl, callback) {
  const disabledEls = Array.from(formEl.querySelectorAll('input:disabled, select:disabled, textarea:disabled'));
  disabledEls.forEach(el => el.disabled = false);
  try { return callback(); } finally { disabledEls.forEach(el => el.disabled = true); }
}

function collectHeaderFormData() {
  const form = document.getElementById('orderHeaderForm');
  return withTemporarilyEnabled(form, () => Object.fromEntries(new FormData(form)));
}

function getPaperNum() {
  const p1 = (PAGE.paperNum || window.selectedPaperNum || '').trim();
  if (p1) return p1;
  const header = collectHeaderFormData();
  return (header.PaperNum || header.papernum || '').toString().trim();
}

// ============================
// å„²å­˜å–®èº«ï¼ˆMultiTabDetailï¼‰
// ============================
async function saveMultiTabChanges(options) {
  const opts = Object.assign({ silentSuccess: false }, options || {});
  const headerTableName = window._headerTableName;

  // ? é‡å° FMEdIssueMainï¼Œåœ¨å„²å­˜å‰é‡æ–°æª¢æŸ¥è³‡æ–™åº«çš„å¯¦éš›ç‹€æ…‹
  if (headerTableName === 'FMEdIssueMain') {
    try {
      const paperNum = window._paperNum || PAGE.paperNum;
      const resp = await fetch(`/api/FMEdIssueMain/${encodeURIComponent(paperNum)}`);
      if (resp.ok) {
        const mainData = await resp.json();
        const currentFinished = mainData.Finished;

        // å…è¨±å„²å­˜çš„ç‹€æ…‹ï¼šä½œæ¥­ä¸­(0) å’Œ å¯©æ ¸ä¸­(3)
        const allowedStatuses = [0, 3];
        if (currentFinished !== null && !allowedStatuses.includes(currentFinished)) {
          const statusMap = {0:'ä½œæ¥­ä¸­', 1:'å·²ç¢ºèª', 2:'ä½œå»¢ä¸­', 3:'å¯©æ ¸ä¸­', 4:'å·²çµæ¡ˆ'};
          const statusName = statusMap[currentFinished] || `ä»£ç¢¼:${currentFinished}`;

          console.log('?? [å„²å­˜] è³‡æ–™åº«ç‹€æ…‹å·²è®Šæ›´ï¼Œç„¡æ³•å„²å­˜');
          await Swal.fire({
            icon: 'warning',
            title: 'å–®æ“šç‹€æ…‹å·²è®Šæ›´',
            html: `æ­¤å–®æ“šç‹€æ…‹å·²è®Šæ›´ç‚ºã€Œ<b>${statusName}</b>ã€ï¼Œç„¡æ³•å„²å­˜ä¿®æ”¹ã€‚<br>è«‹é‡æ–°æ•´ç†é é¢ä»¥å–å¾—æœ€æ–°ç‹€æ…‹ã€‚`,
            confirmButtonText: 'é‡æ–°æ•´ç†é é¢',
            showCancelButton: true,
            cancelButtonText: 'å–æ¶ˆ'
          }).then((result) => {
            if (result.isConfirmed) {
              location.reload();
            }
          });
          return { ok: false, hasChanges: false };
        }
      }
    } catch (err) {
      console.error('? [å„²å­˜] æª¢æŸ¥ç‹€æ…‹å¤±æ•—:', err);
      // ç¹¼çºŒåŸ·è¡Œå„²å­˜ï¼ˆè®“è§¸ç™¼å™¨æ±ºå®šæ˜¯å¦å…è¨±ï¼‰
    }
  }

  // æ”¶é›†æ‰€æœ‰å·²ä¿®æ”¹çš„åˆ—è³‡æ–™ï¼ˆåƒ…é™ç•¶å‰å–®è™Ÿï¼‰
  const currentPaperNum = window._paperNum || PAGE.paperNum;
  console.log('?? [å„²å­˜] ç•¶å‰å–®è™Ÿ:', currentPaperNum);

  const allChanges = [];
  const tables = document.querySelectorAll('.multi-tab-detail .table-container');

  for (const container of tables) {
    const tableName = container.dataset.dictTable;
    if (!tableName) continue;

    const tbody = container.querySelector('tbody');
    if (!tbody) continue;

    const rows = tbody.querySelectorAll('tr[data-state="modified"], tr[data-state="added"]');
    const changes = [];

    for (const row of rows) {
      // ? é—œéµä¿®æ­£ï¼šåªè™•ç†ç•¶å‰å–®è™Ÿçš„è³‡æ–™
      const rowPaperNum = row.dataset.paperNum;
      console.log(`?? [å„²å­˜] æª¢æŸ¥åˆ—: rowPaperNum="${rowPaperNum}", currentPaperNum="${currentPaperNum}", state="${row.dataset.state}"`);

      if (rowPaperNum && rowPaperNum !== currentPaperNum) {
        console.log(`?? [å„²å­˜] è·³éä¸åŒå–®è™Ÿçš„åˆ—: ${rowPaperNum} (ç•¶å‰: ${currentPaperNum})`);
        continue;
      }

      const rowData = {};
      const inputs = row.querySelectorAll('.cell-edit');

      for (const inp of inputs) {
        const fieldName = inp.dataset.field || inp.name;
        if (fieldName) {
          // ? æ™ºèƒ½å‹åˆ¥è½‰æ›ï¼šæ•¸å­—æ¬„ä½è½‰æˆæ•¸å­—ï¼Œç©ºå€¼è½‰æˆ null
          let value = inp.value?.trim();

          // ç©ºå€¼çµ±ä¸€è½‰æˆ nullï¼Œè®“å¾Œç«¯è™•ç†æˆ DBNull.Value
          if (value === '' || value === undefined || value === null) {
            value = null;
          } else {
            // å¦‚æœæ¬„ä½åç¨±åŒ…å«å¸¸è¦‹çš„æ•¸å­—æ¬„ä½é—œéµå­—ï¼Œå˜—è©¦è½‰æˆæ•¸å­—
            const numberFieldPatterns = /Qnty|Item|Serial|Amount|Price|Qty|Num|Count|Weight|Rate|Pop|Pcs$/i;

            if (numberFieldPatterns.test(fieldName)) {
              // ç§»é™¤åƒåˆ†ä½é€—è™Ÿ
              const cleanValue = value.replace(/,/g, '');
              const numValue = Number(cleanValue);

              // åªæœ‰åœ¨æ˜¯æœ‰æ•ˆæ•¸å­—æ™‚æ‰è½‰æ›ï¼Œå¦å‰‡ä¿æŒåŸå€¼ï¼ˆè®“å¾Œç«¯å ±éŒ¯ï¼‰
              if (!isNaN(numValue)) {
                value = numValue;
              }
            }
          }

          rowData[fieldName] = value;
        }
      }

      // ? ç¢ºä¿ PaperNum å’Œ Item ä¸€å®šå­˜åœ¨ï¼ˆå¾ dataset å–å¾—ä¸»éµå€¼ï¼‰
      if (!rowData.PaperNum && rowPaperNum) {
        rowData.PaperNum = rowPaperNum;
        console.log(`?? [å„²å­˜] æ˜ç¢ºåŠ å…¥ PaperNum: ${rowPaperNum}`);
      }

      const rowItem = row.dataset.item;
      if (!rowData.Item && rowItem) {
        // Item éœ€è¦è½‰æˆæ•¸å­—
        const itemNum = Number(rowItem);
        if (!isNaN(itemNum)) {
          rowData.Item = itemNum;
          console.log(`?? [å„²å­˜] æ˜ç¢ºåŠ å…¥ Item: ${itemNum}`);
        }
      }

      // ç¢ºä¿æœ‰è³‡æ–™å†åŠ å…¥ï¼Œä¸¦ä¸”é¡¯ç¤ºå®Œæ•´çš„ rowData å…§å®¹
      if (Object.keys(rowData).length > 0) {
        console.log(`?? [å„²å­˜] æ”¶é›†çš„å®Œæ•´åˆ—è³‡æ–™:`, JSON.stringify(rowData, null, 2));
        changes.push(rowData);
      }
    }

    if (changes.length > 0) {
      console.log(`?? [å„²å­˜] ${tableName} æ”¶é›†åˆ° ${changes.length} ç­†è®Šæ›´`);
      allChanges.push({ tableName, changes });
    }
  }

  if (allChanges.length === 0) {
    console.log('?? [å„²å­˜] æ²’æœ‰è®Šæ›´éœ€è¦å„²å­˜');
    return { ok: true, hasChanges: false };
  }

  try {
    let saveSuccess = true;
    let saveErrors = [];

    const formatSaveError = (raw, tableName) => {
      const text = (raw || '').toString();
      const key = (tableName || '').toString().replace(/^dbo\./i, '').trim().toLowerCase();
      const dict = window._detailFieldDicts?.[key] || {};
      const colMatch = text.match(/è³‡æ–™è¡Œ\s+'([^']+)'/i) || text.match(/column\s+'([^']+)'/i);
      const col = colMatch ? colMatch[1] : '';
      if (!col) return text;
      const label = dict[col] || dict[col.toLowerCase?.()] || col;
      return `${label}(${col})ä¸èƒ½ç‚ºç©º`;
    };

    for (const { tableName, changes } of allChanges) {
      console.log(`?? [å„²å­˜] å„²å­˜ ${tableName}:`, changes);

      // å–å¾—ä¸»éµæ¬„ä½ï¼ˆå¾ç¬¬ä¸€ç­†è³‡æ–™æ¨æ–·ï¼‰
      const firstRow = changes[0];
      const keyFields = [];
      if (firstRow.PaperNum !== undefined) keyFields.push('PaperNum');
      if (firstRow.Item !== undefined) keyFields.push('Item');

      const payload = {
        TableName: tableName,
        Data: changes,
        KeyFields: keyFields
      };

      const resp = await fetch('/api/CommonTable/SaveTableChanges', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        saveSuccess = false;
        const errorText = await resp.text();
        const friendly = formatSaveError(errorText, tableName);
        saveErrors.push(`${tableName}: ${friendly}`);
        console.error(`? [å„²å­˜] ${tableName} å„²å­˜å¤±æ•—:`, errorText);
      } else {
        const result = await resp.json();
        console.log(`? [å„²å­˜] ${tableName} å„²å­˜æˆåŠŸ:`, result);

        // å„²å­˜æˆåŠŸå¾Œï¼Œå°‡æ‰€æœ‰å·²ä¿®æ”¹åˆ—çš„ç‹€æ…‹æ”¹ç‚º unchangedï¼Œä¸¦åŒæ­¥æ›´æ–° view é¡¯ç¤ºå€¼
        const container = document.querySelector(`.table-container[data-dict-table="${tableName}"]`);
        if (container) {
          container.querySelectorAll('tr[data-state="modified"], tr[data-state="added"]').forEach(tr => {
            tr.dataset.state = 'unchanged';

            // ? åŒæ­¥æ›´æ–° view é¡¯ç¤ºå€¼ï¼šå°‡ input çš„å€¼è¤‡è£½åˆ°å°æ‡‰çš„ cell-view
            tr.querySelectorAll('.cell-edit').forEach(input => {
              const fieldName = input.dataset.field || input.name;
              if (!fieldName) return;

              // æ‰¾åˆ°åŒä¸€å€‹ td å…§çš„ cell-view
              const td = input.closest('td');
              if (td) {
                const viewSpan = td.querySelector('.cell-view');
                if (viewSpan) {
                  // æ›´æ–°é¡¯ç¤ºå€¼ï¼ˆä¿ç•™åƒåˆ†ä½æ ¼å¼åŒ–ï¼Œå¦‚æœæœ‰çš„è©±ï¼‰
                  let displayValue = input.value?.trim() || '';

                  // å¦‚æœæ˜¯æ•¸å­—æ¬„ä½ï¼Œå¯ä»¥é¸æ“‡æ€§åŠ ä¸Šåƒåˆ†ä½
                  const numberFieldPatterns = /Qnty|Amount|Price|Qty|Count|Weight$/i;
                  if (numberFieldPatterns.test(fieldName) && displayValue) {
                    const num = parseFloat(displayValue.replace(/,/g, ''));
                    if (!isNaN(num)) {
                      displayValue = num.toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 4
                      });
                    }
                  }

                  viewSpan.textContent = displayValue;
                  console.log(`?? [å„²å­˜] åŒæ­¥æ›´æ–° ${fieldName}: "${displayValue}"`);
                }
              }
            });
          });
        }
      }
    }

    if (saveSuccess) {
      if (!opts.silentSuccess) {
        await Swal.fire({
          icon: 'success',
          title: 'å„²å­˜æˆåŠŸ',
          text: 'å–®èº«è³‡æ–™å·²æˆåŠŸå„²å­˜',
          timer: 1500,
          showConfirmButton: false
        });
      }
      return { ok: true, hasChanges: true };
    }

    await Swal.fire({
      icon: 'error',
      title: 'å„²å­˜å¤±æ•—',
      html: saveErrors.join('<br>')
    });
    return { ok: false, hasChanges: true };
  } catch (err) {
    console.error('? [å„²å­˜] å„²å­˜éŒ¯èª¤:', err);
    await Swal.fire({
      icon: 'error',
      title: 'å„²å­˜éŒ¯èª¤',
      text: String(err)
    });
    return { ok: false, hasChanges: true };
  }
}

// ============================
// å„²å­˜å–®é ­
// ============================
document.getElementById('orderHeaderForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const header = collectHeaderFormData();
  normalizeNumberFields(header, PAGE.headerFields);

  const payload = { ...header, __headerTable: PAGE.headerTable };

  try {
    const detailSave = await saveMultiTabChanges({ silentSuccess: true });
    if (!detailSave.ok) return;

    const resp = await fetch('/api/OrderHeaderApi/SaveOrderHeader', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
    });
    if (resp.ok) {
      const result = await resp.json();
      if (result.updated) {
        await Swal.fire({ icon: 'success', title: 'å„²å­˜æˆåŠŸï¼', timer: 1000, showConfirmButton: false });
        localStorage.setItem("afterSave", "1"); location.reload();
      } else {
        Swal.fire({ icon: 'info', title: 'æ²’æœ‰è³‡æ–™ç•°å‹•' });
      }
    } else {
      let msg = 'å„²å­˜å¤±æ•—'; try { const txt = await resp.text(); msg = txt || msg; } catch {}
      Swal.fire({ icon: 'error', title: msg });
    }
  } catch (err) { Swal.fire({ icon: 'error', title: 'ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤' }); }
});

// ============================
// æª¢è¦–/ç·¨è¼¯æ¨¡å¼åˆ‡æ›
// ============================
const editBtn = document.getElementById('btnViewEditToggle');
if (editBtn) {
  let isEdit = false;

  function setLookupReadOnly(selectEl, readOnly) {
    if (!selectEl) return;
    if (readOnly) {
      selectEl.disabled = false; // å¿…é ˆå¯é»ï¼Œæ‰èƒ½å±•é–‹é¸é …
      selectEl.dataset.lockedValue = selectEl.value ?? '';
      selectEl.classList.add('lookup-readonly');
      selectEl.setAttribute('aria-readonly', 'true');
      selectEl.title = 'ç€è¦½æ¨¡å¼ï¼šå¯æŸ¥çœ‹ä¸‹æ‹‰å…§å®¹ï¼Œä¸èƒ½ä¿®æ”¹';
    } else {
      selectEl.classList.remove('lookup-readonly');
      selectEl.removeAttribute('aria-readonly');
      selectEl.title = '';
      selectEl.dataset.lockedValue = selectEl.value ?? '';
      selectEl.disabled = false;
    }
  }

  function applyHeaderEditState(editing) {
    document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
      .forEach(el => {
        if (el.closest('.modal')) return;
        if (el.matches('select.lookup-dropdown')) {
          setLookupReadOnly(el, !editing);
        } else {
          el.disabled = !editing;
        }
      });
  }

  document.addEventListener('change', (e) => {
    const sel = e.target;
    if (!(sel instanceof HTMLSelectElement)) return;
    if (!sel.matches('.erp-header-form select.lookup-dropdown')) return;
    if (sel.closest('.modal')) return;
    if (isEdit) return;

    const locked = sel.dataset.lockedValue ?? '';
    if ((sel.value ?? '') !== locked) {
      sel.value = locked;
    }
    e.stopPropagation();
  }, true);
  document.addEventListener('keydown', (e) => {
    const sel = e.target;
    if (!(sel instanceof HTMLSelectElement)) return;
    if (!sel.matches('.erp-header-form select.lookup-dropdown')) return;
    if (sel.closest('.modal')) return;
    if (isEdit) return;

    const blockKeys = ['ArrowUp', 'ArrowDown', 'Home', 'End', 'PageUp', 'PageDown', ' ', 'Enter'];
    if (blockKeys.includes(e.key)) {
      e.preventDefault();
      e.stopPropagation();
    }
  }, true);
  const getHeaderValueByLabel = (labelText) => {
    const $li = $('.draggable-field').filter(function () {
      return $(this).children('label').first().text().trim() === labelText;
    }).first();
    if (!$li.length) return null;
    const $ctrl = $li.find('select, input, textarea').first();
    if (!$ctrl.length) return null;
    if ($ctrl.is('select')) return $ctrl.find('option:selected').text().trim();
    return ($ctrl.val() || '').toString().trim();
  };

  editBtn.addEventListener('click', async function () {
    // âœ… é‡å° FMEdIssueMain ä½¿ç”¨ Finished æ¬„ä½æª¢æŸ¥ï¼ˆæ•¸å­—ï¼‰
    const headerTableName = window._headerTableName;
    console.log('ğŸ” [ä¿®æ”¹æŒ‰éˆ•] headerTableName:', headerTableName);
    console.log('ğŸ” [ä¿®æ”¹æŒ‰éˆ•] finishedStatus:', window._finishedStatus);

    // ? å¦‚æœæ˜¯å¾ã€Œç·¨è¼¯æ¨¡å¼ã€åˆ‡å›ã€Œæª¢è¦–æ¨¡å¼ã€ï¼ˆä¿ç•™ï¼‰ï¼Œå‰‡å„²å­˜å–®èº«è³‡æ–™
    if (isEdit) {
      console.log('?? [ä¿ç•™æŒ‰éˆ•] é–‹å§‹å„²å­˜å–®èº«è³‡æ–™...');
      const detailSave = await saveMultiTabChanges();
      if (!detailSave.ok) return;
    }

    // â­ å¦‚æœæ˜¯å¾ã€Œæª¢è¦–æ¨¡å¼ã€åˆ‡åˆ°ã€Œç·¨è¼¯æ¨¡å¼ã€ï¼ˆä¿®æ”¹ï¼‰ï¼Œå…ˆæª¢æŸ¥ç‹€æ…‹
    if (!isEdit) {
      if (headerTableName === 'FMEdIssueMain') {
        // ä½¿ç”¨å¾Œç«¯å‚³éçš„ Finished ç‹€æ…‹
        const finished = window._finishedStatus;

        // ç‹€æ…‹å°ç…§è¡¨
        const statusMap = {0:'ä½œæ¥­ä¸­', 1:'å·²ç¢ºèª', 2:'ä½œå»¢ä¸­', 3:'å¯©æ ¸ä¸­', 4:'å·²çµæ¡ˆ'};
        const statusName = statusMap[finished] || `ä»£ç¢¼:${finished}`;

        // å…è¨±ä¿®æ”¹çš„ç‹€æ…‹ï¼šä½œæ¥­ä¸­(0) å’Œ å¯©æ ¸ä¸­(3)
        const allowedStatuses = [0, 3];
        if (finished !== null && !allowedStatuses.includes(finished)) {
          console.log('ğŸš« [ä¿®æ”¹æŒ‰éˆ•] ç‹€æ…‹ä¸å…è¨±ä¿®æ”¹ï¼Œé˜»æ­¢ä¿®æ”¹');
          Swal.fire({
            icon: 'warning',
            title: 'ç„¡æ³•ä¿®æ”¹',
            html: `å–®æ“šç‹€æ…‹ï¼š<b>${statusName}</b><br>åªæœ‰ã€Œä½œæ¥­ä¸­ã€æˆ–ã€Œå¯©æ ¸ä¸­ã€çš„å–®æ“šæ‰èƒ½é€²è¡Œä¿®æ”¹ã€‚`
          });
          return;
        }
        console.log('âœ… [ä¿®æ”¹æŒ‰éˆ•] ç‹€æ…‹å…è¨±ä¿®æ”¹');
      } else {
        // ä¸€èˆ¬å–®æ“šä½¿ç”¨åŸæœ¬çš„ã€Œå–®æ“šç‹€æ…‹ã€æ–‡å­—æª¢æŸ¥
        const status = getHeaderValueByLabel('å–®æ“šç‹€æ…‹') || '';
        if (window.BLOCK_STATUSES && window.BLOCK_STATUSES.includes(status)) {
          Swal.fire({ icon: 'warning', title: 'ç„¡æ³•ä¿®æ”¹', text: `æ­¤å–®æ“šç‹€æ…‹ç‚ºã€Œ${status}ã€ï¼Œä¸å¯é€²è¡Œä¿®æ”¹ã€‚`});
          return;
        }
      }
    }

    isEdit = !isEdit; editBtn.textContent = isEdit ? 'ä¿ç•™' : 'ä¿®æ”¹';
    applyHeaderEditState(isEdit);

    // åˆ‡æ›å–®é ­æ¬„ä½çš„ disabled ç‹€æ…‹
    document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
      .forEach(el => { if (!el.closest('.modal')) el.disabled = !isEdit; });

    // âœ… åˆ‡æ›å–®èº«è¡¨æ ¼çš„é¡¯ç¤º/ç·¨è¼¯æ¨¡å¼ï¼ˆé‡å° _MultiTabDetail.cshtmlï¼‰
    document.querySelectorAll('.multi-tab-detail .erp-table .cell-view')
      .forEach(el => el.classList.toggle('d-none', isEdit));
    document.querySelectorAll('.multi-tab-detail .erp-table .cell-edit')
      .forEach(el => el.classList.toggle('d-none', !isEdit));

    // ç¶å®š input äº‹ä»¶ï¼Œæ¨™è¨˜åˆ—ç‚ºå·²ä¿®æ”¹
    if (isEdit) {
      document.querySelectorAll('.multi-tab-detail .erp-table .cell-edit').forEach(inp => {
        inp.addEventListener('input', () => {
          const tr = inp.closest('tr');
          if (tr && tr.dataset.state !== 'added') {
            tr.dataset.state = 'modified';
          }
        });
      });
    }
  });

  window.addEventListener('load', () => {
    applyHeaderEditState(false);
    if (localStorage.getItem("afterSave") === "1") {
      localStorage.removeItem("afterSave");
      document.getElementById("btnViewEditToggle")?.click();
    }
  });
}

// ============================
// Header ç‰ˆé¢æ‹–æ‹‰å„²å­˜ / Lookup ä¸‹æ‹‰åˆå§‹åŒ–ï¼ˆjQueryï¼‰
// ============================
$(function () {
  let debounceTimer;
  const debounceSave = () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(saveLayoutChanges, 400); };

  function saveLayoutChanges() {
    const layout = [];
    const hiddenTabs = $(".tab-pane").not(".show");
    hiddenTabs.addClass("temporary-show").addClass("show").css("display", "block");
    $(".draggable-field").each(function () {
      const $li = $(this);
      layout.push({
        fieldName: $li.data("field"),
        top: Math.round($li.position().top),
        left: Math.round($li.position().left),
        width: Math.round($li.outerWidth()),
        height: Math.round($li.outerHeight()),
        ishowWhere: parseInt($li.attr("data-tab")) || 1
      });
    });
    hiddenTabs.removeClass("show").removeClass("temporary-show").css("display", "");
    if (!layout.length) return;

    fetch("/api/TableFieldLayout/SaveHeaderLayout", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tableName: "@Model.HeaderTableName", layoutUpdates: layout })
    }).catch(()=>{});
  }

  $(".draggable-field").each(function () {
    const $li = $(this);
    $li.draggable({
      handle: "label",
      helper: function () {
        return $("<div>").text($(this).find("label").text()).css({
          width: "80px", height: $li.outerHeight() + "px",
          background: "#eef", border: "1px dashed #999", padding: "4px", "font-size": "0.9em"
        });
      },
      appendTo: "body", zIndex: 10000,
      start: function () { $(this).hide(); },
      stop: function (event, ui) {
        const $item = $(this);
        $item.show();

        const $parent = $item.parent();
        const parentOff = $parent.offset();
        if (parentOff) {
          $item.css({
            position: "absolute",
            top: Math.round(ui.offset.top - parentOff.top),
            left: Math.round(ui.offset.left - parentOff.left)
          });
        }

        debounceSave();
      }
    });
    $li.resizable({ handles: "e, se", minWidth: 50, minHeight: 30, stop: debounceSave });
  });

  // ============================
  // å¤šé¸/ç¾¤çµ„æ‹–æ›³/å°é½Šï¼ˆå¿«æ·éµï¼‰
  //  - Ctrl/Meta+é»æ“Šï¼šåˆ‡æ›é¸å–
  //  - é»æ“Šç©ºç™½ï¼šæ¸…é™¤é¸å–
  //  - æ‹–æ›³ä»»ä¸€è¢«é¸å–çš„ labelï¼šæ•´çµ„ä¸€èµ·ç§»å‹•
  //  - L/R/T/Bï¼šå·¦/å³/ä¸Š/ä¸‹å°é½Š
  //  - H/Vï¼šæ°´å¹³/å‚ç›´å¹³å‡åˆ†ä½ˆ
  //  - æ–¹å‘éµï¼šå¾®èª¿ï¼ˆShift=10pxï¼‰
  // ============================
  const $doc = $(document);
  const SELECTED_CLASS = "md-selected";
  let dragGroupSnapshot = null;

  function $allFields() { return $(".draggable-field"); }
  function $selected() { return $allFields().filter("." + SELECTED_CLASS); }
  function isTypingTarget(e) {
    const t = e?.target;
    if (!t) return false;
    const tag = (t.tagName || "").toLowerCase();
    return tag === "input" || tag === "textarea" || tag === "select" || t.isContentEditable;
  }
  function clearSelection() { $selected().removeClass(SELECTED_CLASS); }
  function toggleSelection($el) { $el.toggleClass(SELECTED_CLASS); }
  function selectOnly($el) { clearSelection(); $el.addClass(SELECTED_CLASS); }

  $doc.on("mousedown", ".draggable-field label", function (e) {
    if (window.__DICT_OPEN__) return;
    const $field = $(this).closest(".draggable-field");
    if (!$field.length) return;

    if (e.ctrlKey || e.metaKey) {
      toggleSelection($field);
    } else if (!$field.hasClass(SELECTED_CLASS)) {
      selectOnly($field);
    }
  });
  $doc.on("mousedown", function (e) {
    if (window.__DICT_OPEN__) return;
    if ($(e.target).closest(".draggable-field, .ui-resizable-handle, .modal").length) return;
    clearSelection();
  });

  function ensureDragGroupSnapshot($base) {
    const $sel = $selected();
    const $group = ($sel.length ? $sel : $base);
    if (!$base.hasClass(SELECTED_CLASS) && $sel.length) selectOnly($base);
    dragGroupSnapshot = {
      baseEl: $base.get(0),
      baseTop: Math.round($base.position().top),
      baseLeft: Math.round($base.position().left),
      items: $group.toArray().map(el => {
        const $el = $(el);
        return { el, top: Math.round($el.position().top), left: Math.round($el.position().left) };
      })
    };
  }

  $allFields().each(function () {
    const $li = $(this);
    $li.draggable("option", "start", function () {
      if (window.__DICT_OPEN__) return;
      ensureDragGroupSnapshot($(this));
      $(this).hide();
    });
    $li.draggable("option", "stop", function (event, ui) {
      const $item = $(this);
      $item.show();

      const $parent = $item.parent();
      const parentOff = $parent.offset();
      if (!parentOff) return;

      const newTop = Math.round(ui.offset.top - parentOff.top);
      const newLeft = Math.round(ui.offset.left - parentOff.left);

      if (dragGroupSnapshot && dragGroupSnapshot.baseEl === $item.get(0)) {
        const dy = newTop - dragGroupSnapshot.baseTop;
        const dx = newLeft - dragGroupSnapshot.baseLeft;
        dragGroupSnapshot.items.forEach(it => {
          const $el = $(it.el);
          $el.css({
            position: "absolute",
            top: Math.max(0, it.top + dy),
            left: Math.max(0, it.left + dx)
          });
        });
        dragGroupSnapshot = null;
        debounceSave();
        return;
      }

      $item.css({ position: "absolute", top: newTop, left: newLeft });
      dragGroupSnapshot = null;
      debounceSave();
    });
  });

  function applyToSelected(mutator) {
    const $sel = $selected();
    if (!$sel.length) return false;
    $sel.each(function () { mutator($(this)); });
    debounceSave();
    return true;
  }
  function alignSelected(mode) {
    const $sel = $selected();
    if ($sel.length < 2) return false;
    const boxes = $sel.toArray().map(el => {
      const $el = $(el);
      const p = $el.position();
      const w = $el.outerWidth();
      const h = $el.outerHeight();
      const $ctrl = $el.find('select, input, textarea').first();
      const ctrlOff = $ctrl.length ? $ctrl.offset() : null;
      const elOff = $el.offset();
      const ctrlLeftAbs = ctrlOff?.left ?? elOff.left;
      const ctrlTopAbs = ctrlOff?.top ?? elOff.top;
      const ctrlW = $ctrl.length ? $ctrl.outerWidth() : w;
      const ctrlH = $ctrl.length ? $ctrl.outerHeight() : h;
      return {
        $el,
        top: Math.round(p.top),
        left: Math.round(p.left),
        right: Math.round(p.left + w),
        bottom: Math.round(p.top + h),
        w,
        h,
        ctrlLeftAbs,
        ctrlRightAbs: ctrlLeftAbs + ctrlW,
        ctrlTopAbs,
        ctrlBottomAbs: ctrlTopAbs + ctrlH,
        ctrlW,
        ctrlH
      };
    });
    const minCtrlLeftAbs = Math.min(...boxes.map(b => b.ctrlLeftAbs));
    const maxCtrlRightAbs = Math.max(...boxes.map(b => b.ctrlRightAbs));

    const minLeft = Math.min(...boxes.map(b => b.left));
    const maxRight = Math.max(...boxes.map(b => b.right));
    const minTop = Math.min(...boxes.map(b => b.top));
    const maxBottom = Math.max(...boxes.map(b => b.bottom));

    boxes.forEach(b => {
      if (mode === "L") {
        const delta = minCtrlLeftAbs - b.ctrlLeftAbs;
        b.$el.css("left", Math.max(0, Math.round(b.left + delta)));
      }
      if (mode === "R") {
        const targetCtrlLeftAbs = maxCtrlRightAbs - b.ctrlW;
        const delta = targetCtrlLeftAbs - b.ctrlLeftAbs;
        b.$el.css("left", Math.max(0, Math.round(b.left + delta)));
      }
      if (mode === "T") b.$el.css("top", minTop);
      if (mode === "B") b.$el.css("top", Math.max(0, maxBottom - b.h));
    });
    debounceSave();
    return true;
  }
  function distributeSelected(axis) {
    const $sel = $selected();
    if ($sel.length < 3) return false;
    const boxes = $sel.toArray().map(el => {
      const $el = $(el);
      const p = $el.position();
      const w = $el.outerWidth();
      const h = $el.outerHeight();
      return { $el, top: Math.round(p.top), left: Math.round(p.left), w, h };
    });
    if (axis === "H") {
      boxes.sort((a, b) => a.left - b.left);
      const first = boxes[0], last = boxes[boxes.length - 1];
      const span = (last.left - first.left);
      const gaps = boxes.length - 1;
      const step = gaps ? Math.round(span / gaps) : 0;
      boxes.forEach((b, i) => b.$el.css("left", Math.max(0, first.left + step * i)));
    } else {
      boxes.sort((a, b) => a.top - b.top);
      const first = boxes[0], last = boxes[boxes.length - 1];
      const span = (last.top - first.top);
      const gaps = boxes.length - 1;
      const step = gaps ? Math.round(span / gaps) : 0;
      boxes.forEach((b, i) => b.$el.css("top", Math.max(0, first.top + step * i)));
    }
    debounceSave();
    return true;
  }

  $doc.on("keydown", function (e) {
    if (window.__DICT_OPEN__) return;
    if (isTypingTarget(e)) return;
    const key = (e.key || "").toUpperCase();

    if (key === "L" || key === "R" || key === "T" || key === "B") {
      if (alignSelected(key)) { e.preventDefault(); return; }
    }
    if (key === "H" || key === "V") {
      if (distributeSelected(key)) { e.preventDefault(); return; }
    }

    const step = e.shiftKey ? 10 : 1;
    if (e.key === "ArrowLeft")  { if (applyToSelected($el => $el.css("left", Math.max(0, Math.round($el.position().left) - step)))) { e.preventDefault(); } return; }
    if (e.key === "ArrowRight") { if (applyToSelected($el => $el.css("left", Math.max(0, Math.round($el.position().left) + step)))) { e.preventDefault(); } return; }
    if (e.key === "ArrowUp")    { if (applyToSelected($el => $el.css("top",  Math.max(0, Math.round($el.position().top) - step)))) { e.preventDefault(); } return; }
    if (e.key === "ArrowDown")  { if (applyToSelected($el => $el.css("top",  Math.max(0, Math.round($el.position().top) + step)))) { e.preventDefault(); } return; }
  });

  $(".header-fields-tab").droppable({
    accept: ".draggable-field", tolerance: "pointer",
    over: function () { $(this).addClass("drop-hover"); },
    out:  function () { $(this).removeClass("drop-hover"); },
    drop: function (event, ui) {
      $(this).removeClass("drop-hover");
      const $zone = $(this), $item = $(ui.draggable);
      const newTabIndex = parseInt($zone.data("tab-index")) || 1;
      $item.appendTo($zone).attr("data-tab", newTabIndex).css({
        top: ui.offset.top - $zone.offset().top,
        left: ui.offset.left - $zone.offset().left,
        position: "absolute"
      });
      debounceSave();
    }
  });

  let dragTabSwitchTimer = null;
  $("#headerTabs button").droppable({
    accept: ".draggable-field",
    over: function () { const $tabBtn = $(this); dragTabSwitchTimer = setTimeout(() => { $tabBtn.trigger("click"); }, 600); },
    out:  function () { clearTimeout(dragTabSwitchTimer); }
  });

  $('.lookup-dropdown').each(function() {
    const $select = $(this);
    const table = $select.data('table'), key = $select.data('key'),
          result = $select.data('result'), selected = $select.data('selected');
    $.getJSON(`/api/TableFieldLayout/LookupData?table=${table}&key=${key}&result=${result}`, function(data) {
      $select.empty().append('<option value="">--è«‹é¸æ“‡--</option>');
      (data || []).forEach(row => {
        const val = row.key;
        const label = Object.keys(row).filter(p => p.startsWith('result')).map(p => row[p]).join(' - ');
        const $opt = $('<option>').val(val).text(label);
        if (val == selected) $opt.attr('selected', true);
        $select.append($opt);
      });
      $select.next('.lookup-label').text($select.find('option:selected').text());
      // è‹¥æ˜¯ç€è¦½æ¨¡å¼ï¼ˆreadonlyï¼‰ï¼Œåœ¨ä¸‹æ‹‰è³‡æ–™è¼‰å…¥å¾ŒåŒæ­¥ lockedValueï¼Œé¿å…è®Šæ›´æ™‚å›å¾©æˆç©ºå€¼
      if ($select.hasClass('lookup-readonly') && $select[0]) {
        $select[0].dataset.lockedValue = $select.val() ?? '';
      }
    });
    $select.on('change', function() {
      $(this).next('.lookup-label').text($(this).find('option:selected').text());
    });
  });

  function setInitialTabHeights(offsetPx = 4) {
    const hiddenTabs = $(".tab-pane").not(".show");
    hiddenTabs.addClass("tmp-show").addClass("show").css("display", "block");
    $(".header-fields-tab").each(function () {
      let maxBottom = 0;
      $(this).children(".draggable-field").each(function () {
        const $el = $(this);
        maxBottom = Math.max(maxBottom, $el.position().top + $el.outerHeight());
      });
      $(this).height(Math.max(0, Math.ceil(maxBottom + offsetPx)));
    });
    hiddenTabs.removeClass("show tmp-show").css("display", "");
  }
  requestAnimationFrame(() => setInitialTabHeights(4));
});

// ============================
// ä¸Šä¸€ç­† / ä¸‹ä¸€ç­†
// ============================
const NAV_BTN_PREV = document.getElementById('btnPrev');
const NAV_BTN_NEXT = document.getElementById('btnNext');
let navIds = [], navIndex = -1;

function loadLastFilters() {
  try {
    const tn = (PAGE.headerTable || '').toString().trim().toLowerCase();
    const fk = tn ? `orderListQueryFilters:${tn}` : "orderListQueryFilters";
    const s1 = localStorage.getItem(fk);
    if (s1) return JSON.parse(s1);

    // legacy: only accept global filters if they were saved for the same table
    const legacyTable = (localStorage.getItem("orderListQueryTable") || '').toLowerCase();
    const s2 = legacyTable === tn ? localStorage.getItem("orderListQueryFilters") : null;
    return s2 ? JSON.parse(s2) : [];
  }
  catch { return []; }
}
function getDetailBasePath() { return location.pathname.replace(/\/[^\/]+$/, "/"); }
function gotoPaper(pn) { if (!pn) return; localStorage.setItem("lastViewedPaperNum", pn); location.href = getDetailBasePath() + pn; }
function updateNavButtons() {
  const hasPrev = navIndex > 0;
  const hasNext = navIndex >= 0 && navIndex < navIds.length - 1;
  if (NAV_BTN_PREV) {
    NAV_BTN_PREV.disabled = !hasPrev;
    NAV_BTN_PREV.onclick = () => hasPrev && gotoPaper(navIds[navIndex - 1]);
  }
  if (NAV_BTN_NEXT) {
    NAV_BTN_NEXT.disabled = !hasNext;
    NAV_BTN_NEXT.onclick = () => hasNext && gotoPaper(navIds[navIndex + 1]);
  }
}
async function fetchIdListByApi(filters) {
  const res = await fetch('/api/PagedQuery/IdList', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ table: PAGE.headerTable, keyField: PAGE.keyField, filters: filters || [] })
  });
  const json = await res.json();
  return Array.isArray(json.ids) ? json.ids : [];
}
async function fetchIdListByPagedQuery(filters) {
  const fs = [...(filters || []), {Field:"page",Op:"",Value:"1"}, {Field:"pageSize",Op:"",Value:"999999"}];
  const res = await fetch('/api/PagedQuery/PagedQuery', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ table: PAGE.headerTable, filters: fs })
  });
  const json = await res.json();
  const rows = Array.isArray(json.data) ? json.data : [];
  return rows.map(r => r[PAGE.keyField]).filter(Boolean);
}
async function fetchIdListByDynamicTable(filters) {
  const fs = [...(filters || []), { Field: "page", Op: "", Value: "1" }, { Field: "pageSize", Op: "", Value: "999999" }];
  const res = await fetch('/api/DynamicTable/PagedQuery', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ table: PAGE.headerTable, filters: fs })
  });
  if (!res.ok) throw new Error('DynamicTable/PagedQuery failed');
  const json = await res.json();
  const rows = Array.isArray(json.data) ? json.data : [];
  return rows.map(r => (r?.[PAGE.keyField] ?? r?.[PAGE.keyField?.toLowerCase?.()]))
    .filter(Boolean)
    .map(x => x.toString());
}
async function initRowNavigation() {
  try {
    const filters = loadLastFilters();
    // ä¾åºå˜—è©¦ï¼šIdListï¼ˆè‹¥æœ‰ï¼‰â†’ PagedQueryï¼ˆEF DbSetï¼‰â†’ DynamicTableï¼ˆSQL å‹•æ…‹æŸ¥è©¢ï¼Œæœ€é€šç”¨ï¼‰
    try { navIds = await fetchIdListByApi(filters); }
    catch {
      try { navIds = await fetchIdListByPagedQuery(filters); }
      catch { navIds = await fetchIdListByDynamicTable(filters); }
    }
    const cur = (PAGE.paperNum || '').toString().trim().toLowerCase();
    navIndex = navIds.findIndex(x => (x || '').toString().trim().toLowerCase() === cur);
    updateNavButtons();
  } catch {
    if (NAV_BTN_PREV) NAV_BTN_PREV.disabled = true;
    if (NAV_BTN_NEXT) NAV_BTN_NEXT.disabled = true;
  }
}
initRowNavigation();

// ============================
// å›ºå®šå·¥å…·åˆ—ï¼šç¬¬äºŒ/ç¬¬ä¸‰éšæ–°å¢åˆªæ¸›
// ============================
(function wireSubDetailToolbar() {
  const btnAdd = document.getElementById('btnSubDetailAdd');
  const btnDel = document.getElementById('btnSubDetailDelete');
  if (!btnAdd && !btnDel) return;
  btnAdd?.classList.remove('d-none');
  btnDel?.classList.remove('d-none');
  const root = document.querySelector('.mmd-wrapper');

  const pickApi = () => {
    const domId = root?.id;
    if (domId && window._mmdApi?.[domId]) return window._mmdApi[domId];
    const keys = Object.keys(window._mmdApi || {});
    return keys.length ? window._mmdApi[keys[0]] : null;
  };

  const warn = (msg) => {
    if (window.Swal?.fire) Swal.fire({ icon: 'info', title: msg });
    else alert(msg);
  };

  const clickMultiTabAction = (kind) => {
    const selector = kind === 'add' ? '.btn-add-row' : '.btn-delete-row';
    const activePane = document.querySelector('.multi-tab-detail .tab-pane.active');
    const scope = activePane || document.querySelector('.multi-tab-detail');
    if (!scope) return { ok: false, reason: 'no-multitab' };
    const btn = scope.querySelector(selector) || document.querySelector(`.multi-tab-detail ${selector}`);
    if (!btn) return { ok: false, reason: 'no-button' };
    btn.click();
    return { ok: true };
  };

  const getActiveMultiTabCtx = () => {
    const activePane = document.querySelector('.multi-tab-detail .tab-pane.active');
    if (!activePane) return null;
    const navBtn = document.querySelector('.multi-tab-detail .nav-link.active[data-api-url]');
    const apiUrl = navBtn?.dataset?.apiUrl || '';
    const tbody = activePane.querySelector('tbody');
    let selectedRow = tbody?.querySelector('tr.row-selected') || null;
    if (!selectedRow) {
      const focusTr = document.activeElement?.closest?.('.multi-tab-detail tbody tr');
      if (focusTr && tbody?.contains(focusTr)) selectedRow = focusTr;
    }
    return { activePane, apiUrl, tbody, selectedRow };
  };

  const detailDefaultsCache = {};

  const escAttr = (v) => String(v ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');

  const getDetailDefaults = async (table) => {
    const key = (table || '').toString().toLowerCase();
    if (!key) return {};
    if (detailDefaultsCache[key]) return detailDefaultsCache[key];
    const url = `/api/OrderHeaderApi/DetailDefaults?table=${encodeURIComponent(table)}`;
    const res = await fetch(url);
    if (!res.ok) return {};
    const data = await res.json();
    const defs = data?.defaults || {};
    detailDefaultsCache[key] = defs;
    return defs;
  };

  const addMultiTabBlankRow = async () => {
    const ctx = getActiveMultiTabCtx();
    if (!ctx || !ctx.tbody) return { ok: false, reason: 'no-multitab' };
    const { activePane, tbody } = ctx;
    const table = activePane.querySelector('table.erp-table');
    const fields = Array.from(table?.querySelectorAll('thead th') || [])
      .map(th => (th.dataset.field || '').toString())
      .filter(Boolean);
    if (!fields.length) return { ok: false, reason: 'no-fields' };

    const dictTable = activePane?.querySelector?.('.table-container')?.dataset?.dictTable || '';
    const safeTable = (dictTable || '').toString().replace(/^dbo\./i, '').trim();
    const defaults = safeTable ? await getDetailDefaults(safeTable) : {};

    let maxItem = 0;
    tbody.querySelectorAll('tr').forEach(tr => {
      const n = parseInt(tr.dataset.item || '', 10);
      if (!isNaN(n) && n > maxItem) maxItem = n;
    });
    const newItem = maxItem + 1;
    const pn = (getPaperNum() || '').trim();

    const isEditing = !!document.querySelector('.multi-tab-detail .cell-edit:not(.d-none)');
    const viewClass = isEditing ? 'cell-view d-none' : 'cell-view';
    const editClass = isEditing ? 'cell-edit' : 'cell-edit d-none';
    let html = `<tr data-paper-num="${pn}" data-item="${newItem}" data-state="added" class="row-selected">`;
    fields.forEach(field => {
      const defVal = (defaults && Object.prototype.hasOwnProperty.call(defaults, field)) ? defaults[field] : '';
      const value = defVal == null ? '' : String(defVal);
      const safeValue = escAttr(value);
      html += `<td>
        <span class="${viewClass}">${safeValue}</span>
        <input type="text" class="${editClass}" data-field="${field}" value="${safeValue}">
      </td>`;
    });
    html += '</tr>';

    tbody.querySelectorAll('tr.row-selected').forEach(r => r.classList.remove('row-selected'));
    tbody.insertAdjacentHTML('beforeend', html);
    const newRow = tbody.querySelector('tr:last-child');
    if (newRow) {
      const firstInput = newRow.querySelector('input.cell-edit');
      if (firstInput) {
        try { firstInput.focus(); } catch {}
      }
    }
    return { ok: true };
  };

  const deleteMultiTabSelectedRow = async () => {
    const ctx = getActiveMultiTabCtx();
    if (!ctx || !ctx.tbody) return { ok: false, reason: 'no-multitab' };
    const { apiUrl, selectedRow, tbody, activePane } = ctx;
    if (!selectedRow) return { ok: false, reason: 'no-row' };

    const paperNum = selectedRow.dataset.paperNum || '';
    const item = selectedRow.dataset.item || '';
    const state = selectedRow.dataset.state || '';

    const { isConfirmed } = await Swal.fire({
      icon: 'question',
      title: 'ç¢ºå®šè¦åˆªé™¤é€™ä¸€ç­†æ˜ç´°ï¼Ÿ',
      text: `é …æ¬¡ï¼š${item}`,
      showCancelButton: true,
      confirmButtonText: 'åˆªé™¤',
      cancelButtonText: 'å–æ¶ˆ',
      confirmButtonColor: '#dc3545'
    });
    if (!isConfirmed) return { ok: true, canceled: true };

    if (state === 'added') {
      const next = selectedRow.nextElementSibling || selectedRow.previousElementSibling;
      selectedRow.remove();
      if (next) next.classList.add('row-selected');
      return { ok: true };
    }

    const dictTable = activePane?.querySelector?.('.table-container')?.dataset?.dictTable || '';
    const safeTable = (dictTable || '').toString().replace(/^dbo\./i, '').trim();
    if (!safeTable) return { ok: false, reason: 'no-table' };

    const deleteUrl = `/api/OrderHeaderApi/DeleteRow?table=${encodeURIComponent(safeTable)}&paperNum=${encodeURIComponent(paperNum)}&item=${encodeURIComponent(item)}`;
    const response = await fetch(deleteUrl, { method: 'DELETE' });
    if (!response.ok) {
      let errorMessage = `HTTP ${response.status}`;
      try {
        const errorData = await response.json();
        if (errorData && errorData.error) errorMessage = errorData.error;
      } catch {
        try {
          const errorText = await response.text();
          if (errorText) errorMessage = errorText;
        } catch {}
      }
      return { ok: false, reason: 'delete-failed', error: errorMessage };
    }

    const next = selectedRow.nextElementSibling || selectedRow.previousElementSibling;
    selectedRow.remove();
    if (next) next.classList.add('row-selected');
    return { ok: true };
  };

  btnAdd?.addEventListener('click', async () => {
    const api = pickApi();
    if (api?.addSubDetailRow) {
      api.addSubDetailRow();
      return;
    }
    const r = await addMultiTabBlankRow();
    if (!r.ok) {
      warn(r.reason === 'no-fields' ? 'æ‰¾ä¸åˆ°æ˜ç´°æ¬„ä½' : 'è«‹å…ˆåˆ‡åˆ°æ˜ç´°åˆ†é å†æ–°å¢');
    }
  });

  btnDel?.addEventListener('click', () => {
    const api = pickApi();
    if (api?.deleteSubDetailRow) {
      api.deleteSubDetailRow();
      return;
    }
    deleteMultiTabSelectedRow().then((r) => {
      if (r?.ok) return;
      if (r?.reason === 'no-row') return warn('è«‹å…ˆé¸å–åˆ—å†åˆªé™¤');
      if (r?.reason === 'no-table') return warn('æ‰¾ä¸åˆ°æ˜ç´°è¡¨è¨­å®š');
      if (r?.reason === 'delete-failed') return warn(`åˆªé™¤å¤±æ•—ï¼š${r.error || ''}`.trim());
      const k = clickMultiTabAction('delete');
      if (!k.ok) warn(k.reason === 'no-button' ? 'è«‹å…ˆåˆ‡åˆ°æ˜ç´°åˆ†é ä¸¦é¸å–åˆ—å†åˆªé™¤' : 'æ‰¾ä¸åˆ°æ˜ç´°æŒ‰éˆ•æ§åˆ¶å™¨');
    });
  });
})();

// ============================
// å…¶ä»–ï¼šæŠŠæœ€å¾Œæª¢è¦–çš„å–®è™Ÿå­˜åœ¨ localStorage
// ============================
localStorage.setItem("lastViewedPaperNum", window.selectedPaperNum);
function getHeaderValueByLabel(labelText) {
  const li = Array.from(document.querySelectorAll('.draggable-field'))
    .find(el => (el.querySelector('label')?.textContent || '').trim() === labelText);
  if (!li) return '';
  const ctrl = li.querySelector('select, input, textarea');
  if (!ctrl) return '';
  if (ctrl.tagName.toLowerCase() === 'select') {
    const opt = ctrl.options[ctrl.selectedIndex];
    return (opt?.text || opt?.value || '').trim();
  }
  return (ctrl.value || '').trim();
}

// æœªå„²å­˜æ——æ¨™
window.__unsavedChanges = false;
document.addEventListener('input', (e) => {
  if (e.target.closest('.erp-header-form')) window.__unsavedChanges = true;
});
window.addEventListener('pageshow', () => { window.__unsavedChanges = false; });
</script>

<style>
/* =========================================
   A) å…¨å±€/ç‰ˆé¢
   ========================================= */
body { background: #f7f9fb !important; }
.erp-detail-container { min-height: 100vh; padding: 32px 0; margin-left: 3vw; margin-right: 3vw; }

/* =========================================
   B) Header è¡¨å–® & Tabs
   ========================================= */
.erp-header-form,
.erp-header-form select,
.erp-header-form textarea,
.erp-header-form input { font-size: 0.95em; }

/* å–®é ­/å–®èº«å‘å³å¾®èª¿ï¼ˆå°é½Šç´…ç·šï¼‰ */
.erp-header-form,
.multi-tab-detail {
  padding-left: 24px;
}

/* å–®é ­/å–®èº«é–“è·ï¼šç¸®å°è¡¨å–®åº•éƒ¨ç•™ç™½ */
.erp-header-form { margin-bottom: .15rem; }

.erp-header-form select.form-select{
  font-size: 1em !important; height: 32px !important; min-height: 32px !important; line-height: 1.15 !important;
  padding: 2px 30px 2px 6px !important; appearance: none; -webkit-appearance: none; -moz-appearance: none;
  background-image: url('data:image/svg+xml;utf8,<svg width="11" height="11" fill="gray" xmlns="http://www.w3.org/2000/svg"><path d="M2 4.5l3.5 3.5L9 4.5" stroke="gray" stroke-width="2" fill="none" stroke-linecap="round"/></svg>');
  background-repeat: no-repeat; background-position: right 10px center; background-size: 14px 14px; box-shadow: none !important; border-radius: 5px !important;
}
.header-fields-tab{
  position: relative;
  min-height: 72px;
  padding-bottom: 2px;
  margin-bottom: .25rem !important;
  background: #eef2f9 !important; box-shadow: 0 2px 6px rgba(0,0,0,0.04);
}
.drop-hover{ background-color:#cce5ff !important; border-radius:4px; }

.erp-header-form .nav-tabs .nav-link{ border-radius:8px 8px 0 0 !important; padding:7px 18px; font-size:1.05em; font-weight:500; color:#235eb8; }
.erp-header-form .nav-tabs .nav-link.active{
  background:#fff; color:#124d8b; border-color:#bdd2f7 #bdd2f7 #fff #bdd2f7 !important; box-shadow:0 2px 6px 0 #e4ecf7; font-weight:bold;
}

/* draggable æ¬„ä½ï¼ˆæ©«æ’ label + æ§ä»¶ï¼‰ */
.draggable-field{ position:absolute; display:flex; flex-direction:column; box-sizing:border-box; overflow:hidden; background:transparent; border:1px dashed transparent; }
.draggable-field:hover{ border-color:#c7d3e1; }
.draggable-field.inline{ display:flex; flex-direction:row; align-items: center; gap:4px; flex:0 0 auto; min-width:100px; max-width:100%; }
.draggable-field label{ cursor:move; font-size:0.85em; margin:0 6px 0 0; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
.draggable-field.inline .field-control{ flex:1 1 auto; height:100%; display:flex; }
.draggable-field.inline textarea,
.draggable-field.inline input,
.draggable-field.inline .form-select{
  flex:1 1 auto; width:100%; height:100%; min-height:32px; line-height:1.2; resize:none; padding:4px 6px; font-size:0.95em;
}
.draggable-field.inline label{
  white-space: nowrap !important;
  overflow: visible !important;
  text-overflow: clip !important;
  max-width: none !important;
}
.draggable-field.md-selected{
  border-radius: 8px;
  border-color:#5b8def;
  background:rgba(91,141,239,0.08);
}
.erp-header-form select.lookup-dropdown.lookup-readonly{
  /* ç€è¦½æ¨¡å¼å…è¨±å±•é–‹ä¸‹æ‹‰ï¼Œä½†ä¸å…è¨±ä¿®æ”¹ï¼šå¤–è§€æ¯”ç…§ disabled çš„ç°åº• */
  background-color: var(--bs-secondary-bg, #e9ecef) !important;
  color: var(--bs-secondary-color, #6c757d) !important;
  opacity: 1; /* é¿å…åƒ disabled ä¸€æ¨£æ•´é«”è®Šæ·¡ */
  cursor: default;
}
.erp-header-form select.lookup-dropdown.lookup-readonly:focus{
  border-color: #ced4da;
  box-shadow: none !important;
}
/* jQuery UI resizableï¼šè®“å³å´æ‹‰å¯¬æŠŠæ‰‹æ›´å¥½æŠ“ */
.draggable-field.ui-resizable .ui-resizable-e{
  position: absolute;
  top: 0; right: 0; width: 10px; height: 100%;
  cursor: ew-resize; background: transparent;
  z-index: 5;
}
.draggable-field.ui-resizable:hover .ui-resizable-e{
  background: rgba(32,86,172,0.10);
}
.draggable-field.ui-resizable .ui-resizable-se{
  position: absolute;
  right: 0; bottom: 0; width: 14px; height: 14px;
  cursor: se-resize; background: transparent;
  z-index: 5;
}

/* =========================================
   D) å…¶å®ƒ
   ========================================= */
.highlight-red { color:#e53b2d; font-weight:700; }
.highlight-blue{ color:#2564b3; font-weight:700; }

/* --- Action Rail åŸºç¤ç‰ˆä½ & å…§å®¹å³ç§»ï¼ˆå›ºå®šåœ¨æ¨£æ¿ï¼‰--- */
/* æ›´æ–°æ™‚é–“: 2025-03-20 13:45 */
:root{
  --fab-left: 20px;
  --fab-width: 120px;
  --fab-gap: 14px;
  --rail-reserve: 146px;
}

.action-rail{
  position: fixed;
  left: var(--fab-left);
  top: 80px;
  max-height: calc(100vh - 100px); /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé¿å…è¶…å‡ºè¦–çª— */
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 900;
  overflow-y: scroll; /* æ°¸é é¡¯ç¤ºæ²è»¸ï¼Œé¿å…å¯¬åº¦è®ŠåŒ– */
  overflow-x: visible; /* å…è¨±æŒ‰éˆ•è¶…å‡ºå®¹å™¨ï¼Œé¿å…è¢«æ²è»¸é®ä½ */
}

/* action-rail çš„æ²è»¸æ¨£å¼ - ä½¿ç”¨ overlay æ¨¡å¼ä¸ä½”ç©ºé–“ */
.action-rail::-webkit-scrollbar {
  width: 8px;
}

.action-rail::-webkit-scrollbar-track {
  background: transparent;
}

.action-rail::-webkit-scrollbar-thumb {
  background: rgba(0, 0, 0, 0.25);
  border-radius: 4px;
  border: 2px solid transparent;
  background-clip: padding-box;
}

.action-rail::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 0, 0, 0.4);
  background-clip: padding-box;
}

/* æŒ‰éˆ•çš„å…±åŒå¤–è§€ï¼ˆä¿æŒåœ¨æ¨£æ¿ï¼Œè®“æ‰€æœ‰é é¢ä¸€è‡´ï¼‰ */
.fab{
  position: relative;
  width: var(--fab-width);
  min-width: 0;
  padding: 6px 8px;
  font-size: .92rem;
  letter-spacing: 0;
  white-space: normal;
  word-break: break-word;
  background:#ffc107;
  color:#090101;
  font-weight:700;
  border-radius:10px;
  cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.2);
  border:0;
}
.fab:hover{ filter:brightness(0.95); }
.fab-red{ background:#dc3545; color:#fff; }
.fab-blue{ background:#3583dc; color:#fff; }
</style>
