@model dynamic
@using PcbErpApi.Helpers
@using System.Text.Json
@using System.Globalization
@{
    // å–®é ­æ¬„ä½
    var headerFields = Model.HeaderTableFields; // å¯è¦–æ¬„ä½
    var headerData = Model.HeaderData; // å–®é ­è³‡æ–™ (Dictionary<string, object> æˆ–ä½ çš„å–®é ­Model)
    var headerFieldsList = ((IEnumerable<TableFieldViewModel>)Model.HeaderTableFields).ToList();
    var addApiUrl = ViewData["AddApiUrl"]?.ToString() ?? "";
    var detailRouteTemplate = ViewData["SubRouteTemplate"]?.ToString() ?? "";
    var tableName = ViewData["DictTableName"]?.ToString() ?? "";
    var keyFieldName = ViewData["KeyFieldName"]?.ToString() ?? "PaperNum";
    var queryRedirectUrl = ViewData["QueryRedirectUrl"]?.ToString() ?? "";
    var DeleteApiUrl = ViewData["DeleteApiUrl"]?.ToString() ?? "";
    static int NormalizeShowWhere(int? v)
    {
        // æœ‰äº›å–®æ“šå­—å…¸çš„ iShowWhere æœƒæ˜¯ 0ï¼ˆä»£è¡¨ç¬¬ä¸€é ï¼‰ï¼Œè‹¥éæ¿¾æœƒå°è‡´å–®é ­æ•´æ®µæ¶ˆå¤±
        return (v.HasValue && v.Value > 0) ? v.Value : 1;
    }
    static bool IsNumberType(string? dt)
    {
        var t = (dt ?? "").Trim().ToLowerInvariant();
        if (string.IsNullOrEmpty(t)) return false;
        return t == "number"
            || t == "int" || t == "smallint" || t == "tinyint" || t == "bigint"
            || t.StartsWith("decimal") || t.StartsWith("numeric")
            || t.StartsWith("money") || t.StartsWith("smallmoney")
            || t.StartsWith("float") || t.StartsWith("real");
    }
    static bool IsNumberValue(object? raw)
    {
        if (raw == null) return false;
        if (raw is sbyte or byte or short or ushort or int or uint or long or ulong
            or float or double or decimal) return true;
        var s = raw.ToString();
        if (string.IsNullOrWhiteSpace(s)) return false;
        s = s.Replace(",", "");
        return decimal.TryParse(s, NumberStyles.Any, CultureInfo.InvariantCulture, out _)
            || decimal.TryParse(s, NumberStyles.Any, CultureInfo.CurrentCulture, out _);
    }
    static string NormalizeEditColor(string? raw)
    {
        if (string.IsNullOrWhiteSpace(raw)) return "";
        var s = raw.Trim();
        if (s.StartsWith("cl", StringComparison.OrdinalIgnoreCase))
            s = s.Substring(2);
        return s;
    }

    var groupedTabs = headerFieldsList
        .GroupBy(f => NormalizeShowWhere(f.iShowWhere))
        .OrderBy(g => g.Key)
        .ToDictionary(g => g.Key, g => g.ToList());

    var firstTabKey = groupedTabs.Keys.FirstOrDefault();
    if (firstTabKey <= 0) firstTabKey = 1;
    var lookupMap = ViewData["LookupDisplayMap"] as Dictionary<string, Dictionary<string, string>>;

    var PaperNum = headerData.ContainsKey("PaperNum") ? headerData["PaperNum"]?.ToString() ?? "" : "";

    var headerLookupMap = ViewData["HeaderLookupMap"] as Dictionary<string, string>;
    var headerLookupTypeMap = ViewData["HeaderLookupResultTypes"] as Dictionary<string, string>;
    var headerTabBaseLabel = ViewData["HeaderTableDisplayLabel"]?.ToString() ?? "åˆ†é ";

    string actionPartial = (ViewData["ActionRailPartial"] as string)
                           ?? "~/Pages/Shared/_ActionRail.Empty.cshtml";

    string? actionLogicPartial = (ViewData["ActionRailLogicPartial"] as string);

    // âœ… å–å¾—å–®é ­è¡¨åç¨±å’Œ Finished ç‹€æ…‹ï¼ˆé‡å° FmedIssueMainï¼‰
    string headerTableName = Model.HeaderTableName ?? "";
    int? finishedValue = null;
    if (headerTableName == "FMEdIssueMain" && headerData != null && headerData.ContainsKey("Finished"))
    {
        var finishedObj = headerData["Finished"];
        if (finishedObj != null)
        {
            int finishedTemp;
            if (int.TryParse(finishedObj.ToString(), out finishedTemp))
            {
                finishedValue = finishedTemp;
            }
        }
    }
}

<script>
    // âœ… å°‡ Finished ç‹€æ…‹æš´éœ²çµ¦å‰ç«¯ JavaScript
    window._headerTableName = '@headerTableName';
    window._finishedStatus = @(finishedValue?.ToString() ?? "null");
    window._paperNum = '@PaperNum';
</script>

<div id="topToolbar" class="top-toolbar" data-dict-table="@headerTableName">
    <div class="toolbar-icon-row" role="group" aria-label="row-nav-and-sub-detail">
        <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btnPrev" title="ä¸Šä¸€ç­†" aria-label="ä¸Šä¸€ç­†"><span class="toolbar-icon">&laquo;</span></button>
        <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btnNext" title="ä¸‹ä¸€ç­†" aria-label="ä¸‹ä¸€ç­†"><span class="toolbar-icon">&raquo;</span></button>
        <button type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add" id="btnSubDetailAdd" title="æ–°å¢ç¬¬äºŒ/ç¬¬ä¸‰éšé …æ¬¡" aria-label="æ–°å¢ç¬¬äºŒæˆ–ç¬¬ä¸‰éšé …æ¬¡"><span class="toolbar-icon">+</span></button>
        <button type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-del" id="btnSubDetailDelete" title="åˆªæ¸›ç¬¬äºŒ/ç¬¬ä¸‰éšé …æ¬¡" aria-label="åˆªæ¸›ç¬¬äºŒæˆ–ç¬¬ä¸‰éšé …æ¬¡"><span class="toolbar-icon">-</span></button>
        <button type="submit" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add toolbar-btn-check" id="btnSaveHeader" form="orderHeaderForm" title="å„²å­˜" aria-label="å„²å­˜"><span class="toolbar-icon">âœ“</span></button>
        <button type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-cancel toolbar-btn-check" id="btnCancelChanges" title="å–æ¶ˆè®Šæ›´" aria-label="å–æ¶ˆè®Šæ›´"><span class="toolbar-icon">&times;</span></button>
    </div>
    <div class="toolbar-main">
    <div>
        @await Html.PartialAsync("_TableToolbar", new TableToolbarModel {
            SearchBtnId = "btnSubSearch",
            AddBtnId = "btnSubAddNew",
            DeleteBtnId = "btnSubBatchDelete",
            QueryFields = ViewData["QueryFields"] as List<QueryFieldViewModel>,
            ModalId = "searchModal",
            ReportSpName = ViewData["ReportSpName"]?.ToString() ?? ""   // ğŸ‘ˆ å¾å¤–å±¤å†å‚³é€²ä¾†
        })
    </div>
    </div>
</div>

<div class="action-rail">
    @await Html.PartialAsync(actionPartial, (object)Model)
</div>

@if (!string.IsNullOrWhiteSpace(actionLogicPartial))
{
    @await Html.PartialAsync(actionLogicPartial, (object)Model)
}

@{
    string? inheritedActionPartial = (ViewData["InheritedActionPartial"] as string);
}
@if (!string.IsNullOrWhiteSpace(inheritedActionPartial))
{
    @await Html.PartialAsync(inheritedActionPartial, (object)Model)
}

<!-- å–®é ­å¯ç·¨è¼¯è¡¨å–® -->
<form id="orderHeaderForm" class="erp-header-form" data-dict-table="@headerTableName">
    <div class="row">
        <!-- âœ… Tabs åˆ‡æ›åˆ— -->
        <ul class="nav nav-tabs" id="headerTabs" role="tablist">
            @foreach (var tab in groupedTabs.Keys)
            {
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(tab == firstTabKey ? "active" : "")"
                            id="tab-@tab-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#tab-@tab"
                            type="button" role="tab">
                        @(tab <= 1 ? headerTabBaseLabel : $"{headerTabBaseLabel}{tab}")
                    </button>
                </li>
            }
        </ul>

        <!-- âœ… Tabs å°æ‡‰å…§å®¹ -->
        <div class="tab-content" id="headerTabContent">
            @foreach (var tab in groupedTabs)
            {
                <div class="tab-pane fade @(tab.Key == firstTabKey ? "show active" : "")"
                    id="tab-@tab.Key" role="tabpanel">
                    <ul class="list-unstyled header-fields-tab"
                        data-tab-index="@tab.Key"
                        style="position: relative">
                        @foreach (var field in tab.Value)
                        {
                            object rawValue = null;
                            headerData?.TryGetValue(field.FieldName, out rawValue);
                            string displayText = "";

                            // 1. lookup å„ªå…ˆé¡¯ç¤º
                            if (headerLookupMap != null && headerLookupMap.TryGetValue(field.FieldName, out var lookupVal))
                            {
                                displayText = FormatHelper.FormatValue(lookupVal, field.DataType, field.FormatStr);
                            }
                            else if (rawValue != null)
                            {
                                //è¼¸å‡ºæ ¼å¼ç”¨Helperè½‰å‹
                                displayText = FormatHelper.FormatValue(rawValue, field.DataType, field.FormatStr);

                                // âœ… é€™è£¡è£œï¼šæ•¸å€¼å‹è‹¥ç‚ºç©ºï¼Œé¡¯ç¤º 0
                                if (string.IsNullOrWhiteSpace(displayText) && field.DataType?.ToLower() == "number")
                                {
                                    displayText = "0";
                                }
                            }

                            const int headerTopPad = 6;
                            var top = (field.iFieldTop ?? 0) + headerTopPad;
                            var left = field.iFieldLeft ?? 0;
                            var width = field.iFieldWidth ?? 160;
                            var height = field.iFieldHeight ?? 44;

                            var labTop = (field.iLabTop ?? 0) + headerTopPad;
                            var labLeft = field.iLabLeft ?? 0;
                            var labWidth = field.iLabWidth;
                            var labHeight = field.iLabHeight;
                            var labStyle = $"top:{labTop}px; left:{labLeft}px;";
                            if (labWidth.HasValue) { labStyle += $" width:{labWidth.Value}px;"; }
                            if (labHeight.HasValue) { labStyle += $" height:{labHeight.Value}px;"; }

                            var liClass = "draggable-field inline"; // æ°¸é æ©«æ’


                            var isCheckbox = (field.ComboStyle ?? 0) == 1;
                            var isNumber = IsNumberType(field.DataType) || IsNumberValue(rawValue);
                            var hasLookupSetting = !string.IsNullOrWhiteSpace(field.LookupTable)
                                && !string.IsNullOrWhiteSpace(field.LookupKeyField)
                                && !string.IsNullOrWhiteSpace(field.LookupResultField);
                            var hasLookupDisplay = headerLookupMap != null && headerLookupMap.ContainsKey(field.FieldName);
                            var lookupResultType = "";
                            if (headerLookupTypeMap != null && headerLookupTypeMap.TryGetValue(field.FieldName, out var rt))
                            {
                                lookupResultType = rt ?? "";
                            }
                            var lookupIsNumber = IsNumberType(lookupResultType) || (hasLookupDisplay && headerLookupMap != null && IsNumberValue(headerLookupMap[field.FieldName]));
                            var alignRight = lookupIsNumber || (isNumber && !hasLookupSetting && !hasLookupDisplay);
                            var alignCenter = hasLookupSetting;
                            var editColor = NormalizeEditColor(field.EditColor);
                            var editStyle = !string.IsNullOrWhiteSpace(editColor) ? $"background-color:{editColor} !important;" : "";
                            var editStyleForSelect = editStyle;
                            var isReadOnly = (field.ReadOnly ?? 0) == 1;
                            var readOnlyClass = isReadOnly ? "dict-readonly" : "";
                            var readOnlyAttr = isReadOnly ? " data-readonly=\"1\"" : " data-readonly=\"0\"";

                            <li class="header-label-item"
                                data-field="@field.FieldName"
                                data-tab="@tab.Key"
                                title="@field.FieldName"
                                style="@labStyle">
                                @field.DisplayLabel
                            </li>

                            // 1) å‹¾é¸æ¡†
                            if (isCheckbox)
                            {
                                var s = rawValue?.ToString()?.Trim() ?? "";
                                var isChecked = s == "1"
                                                || s.Equals("true", StringComparison.OrdinalIgnoreCase)
                                                || s.Equals("y", StringComparison.OrdinalIgnoreCase)
                                                || s.Equals("yes", StringComparison.OrdinalIgnoreCase);

                                <li class="@liClass @(alignRight ? "field-number" : "field-text")"
                                    data-field="@field.FieldName"
                                    data-tab="@tab.Key"
                                    title="@field.FieldName"
                                    style="top:@(top)px; left:@(left)px; width:@(width)px; height:@(height)px;">
                                    <span class="field-drag-handle" aria-hidden="true"></span>
                                    <div class="form-check d-flex align-items-center" style="height:100%; margin:0; padding-left: 0; @editStyle">
                                        <input type="hidden" name="@field.FieldName" value="0" />
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="@field.FieldName"
                                               value="1"
                                               @(isChecked ? "checked" : "")
                                               @(isReadOnly ? "disabled" : "")
                                               @Html.Raw(readOnlyAttr) />
                                    </div>
                                </li>
                            }
                            // 2) åˆ¤æ–·æœ‰ lookup table è¨­å®š
                            else if (!string.IsNullOrWhiteSpace(field.LookupTable) &&
                                !string.IsNullOrWhiteSpace(field.LookupKeyField) &&
                                !string.IsNullOrWhiteSpace(field.LookupResultField))
                            {
                                // ä¸‹æ‹‰é¸å–®å…ƒä»¶ï¼ˆåŸæœ¬ selectï¼‰
                                <li class="@liClass @(alignRight ? "field-number" : "field-text")"
                                    data-field="@field.FieldName"
                                    data-tab="@tab.Key"
                                    title="@field.FieldName"
                                    style="top:@(top)px; left:@(left)px; width:@(width)px; height:@(height)px;">
                                    <span class="field-drag-handle" aria-hidden="true"></span>
                                    <select class="form-select lookup-dropdown @(readOnlyClass)"
                                            name="@field.FieldName"
                                            data-table="@field.LookupTable"
                                            data-key="@field.LookupKeyField"
                                            data-result="@field.LookupResultField.Replace(" ", "")"
                                            data-selected="@rawValue"
                                            style="@editStyleForSelect"
                                            @Html.Raw(readOnlyAttr)>
                                        <option value="">--è«‹é¸æ“‡--</option>
                                    </select>
                                </li>
                            }
                            else
                            {
                                <li class="@liClass"
                                    data-field="@field.FieldName"
                                    data-tab="@tab.Key"
                                    title="@field.FieldName"
                                    style="top:@(top)px; left:@(left)px; width:@(width)px; height:@(height)px;">
                                    <span class="field-drag-handle" aria-hidden="true"></span>
                                    <textarea class="form-control resizable-input @(readOnlyClass)"
                                            name="@field.FieldName"
                                            @(isReadOnly ? "readonly" : "")
                                            data-align="@(alignRight ? "right" : (alignCenter ? "center" : null))"
                                            style="@editStyle"
                                            @Html.Raw(readOnlyAttr)>@displayText</textarea>
                                </li>
                            }
                        }
                    </ul>
                </div>
            }
        </div>
    </div>
</form>

<script>window._dictTableName = "@(ViewData["DictTableName"] ?? Model.TableName)";</script>

<!-- SweetAlert2 foræç¤º -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="~/js/toolbarHandler.js?v=@DateTime.Now.Ticks"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />

<script>
// ============================
// 0) é é¢å¸¸æ•¸ï¼Razor æ³¨å…¥
// ============================
const PAGE = {
  paperNum: "@PaperNum",
  keyField: ("@(keyFieldName ?? "PaperNum")" || "PaperNum").trim(),
  headerTable: ("@(Model.HeaderTableName ?? "")".trim() || "").toLowerCase(),
  detailTable: "@(tableName ?? "")".trim(),
  queryRedirectUrl: "@(ViewData["QueryRedirectUrl"])",
  addApiUrl: "@addApiUrl",
  deleteApiUrl: "@DeleteApiUrl",
  detailRouteTemplate: "@detailRouteTemplate",
  headerFields: @Html.Raw(JsonSerializer.Serialize(headerFieldsList)),
};

// æ”¾åœ¨æœ€å‰é¢ï¼ˆè¾­å…¸é–‹é—œï¼‰
window.__DICT_OPEN__ = false;

// è®“å…¶å®ƒå·¥å…·å¯ä»¥å–åˆ°ç›®å‰å–®è™Ÿ
window.selectedPaperNum = '@(Model.HeaderData["PaperNum"] ?? "")';

const PAGE_PAPER_NUM = ("@PaperNum" || "").trim();
const KEY_FIELD = ("@(keyFieldName ?? "PaperNum")" || "PaperNum").trim();

const backToMainTpl = (PAGE.queryRedirectUrl || '').trim()
  ? PAGE.queryRedirectUrl.replace(/\/$/, '') + '/{0}'
  : '';
const subTpl = (PAGE.detailRouteTemplate || '').replace(/\{PaperNum\}/gi, '{0}');
const finalSwitchTpl = backToMainTpl || subTpl;

console.debug('[Switch template]', finalSwitchTpl);
console.debug('[Sub template for new]', subTpl);

new ToolbarHandler({
  searchBtnId: "btnSubSearch",
  addBtnId: "btnSubAddNew",
  deleteBtnId: "btnSubBatchDelete",
  getSelectedId: () => (PAGE.paperNum || window.selectedPaperNum || ''),
  modalId: "searchModal",
  formId: "searchForm",
  addApiUrl: PAGE.addApiUrl,
  deleteApiUrlFn: id => `/api/${PAGE.deleteApiUrl}/${id || PAGE.paperNum}`,
  // å‹•æ…‹å–®æ“šçš„ä½œå»¢ï¼šèµ° PaperActionï¼ˆé¿å…æ‰¾ä¸åˆ° /api/{Table}/{PaperNum} controller è€Œ 404ï¼‰
  paperAction: { url: '/api/PaperAction/DoAction', paperId: "@Model.HeaderTableName", eoc: 0, aftFinished: 2 },
  detailRouteTemplate: subTpl,  // ä½¿ç”¨å–®èº«é è·¯å¾‘ï¼Œæ–°å¢å¾Œè·³è½‰åˆ°å–®èº«é 
  tableName: "@tableName",
  renderTable: null,
  renderPagination: null,
  renderOrderCount: null,
  restoreSearchForm: null,
  queryRedirectUrl: PAGE.queryRedirectUrl
});

// å–®èº«é  â†’ ä¸»é  åˆ‡æ›
(function hookToggleBackToMain() {
  const rawBtn = document.getElementById('btnToggle') ||
    Array.from(document.querySelectorAll('button, a'))
      .find(el => (el.textContent || '').trim() === 'åˆ‡æ›');
  if (!rawBtn) return;
  const btn = rawBtn.cloneNode(true);
  rawBtn.replaceWith(btn);
  btn.addEventListener('click', (e) => {
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    const base = ("@queryRedirectUrl" || '').trim().replace(/\/$/, '');
    if (!base) { Swal.fire({ icon: 'error', title: 'æœªæä¾›è¿”å›ä¸»é è·¯å¾‘' }); return; }
      const id = (PAGE_PAPER_NUM || window.selectedPaperNum || '').trim();
      if (id) {
        localStorage.setItem("lastViewedPaperNum", id);
      }
      location.href = base;
  }, { capture: true });
})();

// ============================
// å…±ç”¨å°å·¥å…·ï¼ˆæ•¸å€¼è™•ç†ã€å­—ä¸²åŒ–ï¼‰
// ============================
function normalizeNumberFields(obj, fieldDefs) {
  (fieldDefs || []).forEach(f => {
    if ((f.DataType || '').toLowerCase() === 'number') {
      const k = f.FieldName;
      if (obj[k] != null) obj[k] = obj[k].toString().replace(/,/g, '');
    }
  });
}

function normalizeBool(val) {
  const s = (val ?? '').toString().trim().toLowerCase();
  return s === '1' || s === 'true' || s === 'y' || s === 'yes';
}

function withTemporarilyEnabled(formEl, callback) {
  const disabledEls = Array.from(formEl.querySelectorAll('input:disabled, select:disabled, textarea:disabled'));
  disabledEls.forEach(el => el.disabled = false);
  try { return callback(); } finally { disabledEls.forEach(el => el.disabled = true); }
}

function collectHeaderFormData() {
  const form = document.getElementById('orderHeaderForm');
  return withTemporarilyEnabled(form, () => Object.fromEntries(new FormData(form)));
}

function getPaperNum() {
  const p1 = (PAGE.paperNum || window.selectedPaperNum || '').trim();
  if (p1) return p1;
  const header = collectHeaderFormData();
  return (header.PaperNum || header.papernum || '').toString().trim();
}

// ============================
// å„²å­˜å–®èº«ï¼ˆMultiTabDetailï¼‰
// ============================
async function saveMultiTabChanges(options) {
  const opts = Object.assign({ silentSuccess: false }, options || {});
  const headerTableName = window._headerTableName;

  // ? é‡å° FMEdIssueMainï¼Œåœ¨å„²å­˜å‰é‡æ–°æª¢æŸ¥è³‡æ–™åº«çš„å¯¦éš›ç‹€æ…‹
  if (headerTableName === 'FMEdIssueMain') {
    try {
      const paperNum = window._paperNum || PAGE.paperNum;
      const resp = await fetch(`/api/FMEdIssueMain/${encodeURIComponent(paperNum)}`);
      if (resp.ok) {
        const mainData = await resp.json();
        const currentFinished = mainData.Finished;

        // å…è¨±å„²å­˜çš„ç‹€æ…‹ï¼šä½œæ¥­ä¸­(0) å’Œ å¯©æ ¸ä¸­(3)
        const allowedStatuses = [0, 3];
        if (currentFinished !== null && !allowedStatuses.includes(currentFinished)) {
          const statusMap = {0:'ä½œæ¥­ä¸­', 1:'å·²ç¢ºèª', 2:'ä½œå»¢ä¸­', 3:'å¯©æ ¸ä¸­', 4:'å·²çµæ¡ˆ'};
          const statusName = statusMap[currentFinished] || `ä»£ç¢¼:${currentFinished}`;

          console.log('?? [å„²å­˜] è³‡æ–™åº«ç‹€æ…‹å·²è®Šæ›´ï¼Œç„¡æ³•å„²å­˜');
          await Swal.fire({
            icon: 'warning',
            title: 'å–®æ“šç‹€æ…‹å·²è®Šæ›´',
            html: `æ­¤å–®æ“šç‹€æ…‹å·²è®Šæ›´ç‚ºã€Œ<b>${statusName}</b>ã€ï¼Œç„¡æ³•å„²å­˜ä¿®æ”¹ã€‚<br>è«‹é‡æ–°æ•´ç†é é¢ä»¥å–å¾—æœ€æ–°ç‹€æ…‹ã€‚`,
            confirmButtonText: 'é‡æ–°æ•´ç†é é¢',
            showCancelButton: true,
            cancelButtonText: 'å–æ¶ˆ'
          }).then((result) => {
            if (result.isConfirmed) {
              location.reload();
            }
          });
          return { ok: false, hasChanges: false };
        }
      }
    } catch (err) {
      console.error('? [å„²å­˜] æª¢æŸ¥ç‹€æ…‹å¤±æ•—:', err);
      // ç¹¼çºŒåŸ·è¡Œå„²å­˜ï¼ˆè®“è§¸ç™¼å™¨æ±ºå®šæ˜¯å¦å…è¨±ï¼‰
    }
  }

  // æ”¶é›†æ‰€æœ‰å·²ä¿®æ”¹çš„åˆ—è³‡æ–™ï¼ˆåƒ…é™ç•¶å‰å–®è™Ÿï¼‰
  const currentPaperNum = window._paperNum || PAGE.paperNum;
  console.log('?? [å„²å­˜] ç•¶å‰å–®è™Ÿ:', currentPaperNum);

  const allChanges = [];
  const tables = document.querySelectorAll('.multi-tab-detail .table-container');

  for (const container of tables) {
    const tableName = container.dataset.dictTable;
    if (!tableName) continue;

    const tbody = container.querySelector('tbody');
    if (!tbody) continue;

    const rows = tbody.querySelectorAll('tr[data-state="modified"], tr[data-state="added"]');
    const changes = [];

    for (const row of rows) {
      const isAdded = (row.dataset.state || '').toString().toLowerCase() === 'added';
      // ? é—œéµä¿®æ­£ï¼šåªè™•ç†ç•¶å‰å–®è™Ÿçš„è³‡æ–™
      const rowPaperNum = row.dataset.paperNum;
      console.log(`?? [å„²å­˜] æª¢æŸ¥åˆ—: rowPaperNum="${rowPaperNum}", currentPaperNum="${currentPaperNum}", state="${row.dataset.state}"`);

      if (rowPaperNum && rowPaperNum !== currentPaperNum) {
        console.log(`?? [å„²å­˜] è·³éä¸åŒå–®è™Ÿçš„åˆ—: ${rowPaperNum} (ç•¶å‰: ${currentPaperNum})`);
        continue;
      }

      const rowData = {};
      let hasChangedField = false;
      const inputs = row.querySelectorAll('.cell-edit');

      for (const inp of inputs) {
        const fieldName = inp.dataset.field || inp.name;
        if (fieldName) {
          let currentValue = '';
          let initValue = inp.dataset.init ?? '';
          if (inp.type === 'checkbox') {
            currentValue = inp.checked ? '1' : '0';
            initValue = normalizeBool(initValue) ? '1' : '0';
          } else {
            currentValue = (inp.value ?? '').trim();
            initValue = (initValue ?? '').toString().trim();
          }
          if (!isAdded && currentValue === initValue) continue;

          // ? æ™ºèƒ½å‹åˆ¥è½‰æ›ï¼šæ•¸å­—æ¬„ä½è½‰æˆæ•¸å­—ï¼Œç©ºå€¼è½‰æˆ null
          let value = currentValue;

          // ç©ºå€¼çµ±ä¸€è½‰æˆ nullï¼Œè®“å¾Œç«¯è™•ç†æˆ DBNull.Value
          if (value === '' || value === undefined || value === null) {
            value = null;
          } else {
            // å¦‚æœæ¬„ä½åç¨±åŒ…å«å¸¸è¦‹çš„æ•¸å­—æ¬„ä½é—œéµå­—ï¼Œå˜—è©¦è½‰æˆæ•¸å­—
            const numberFieldPatterns = /Qnty|Item|Serial|Amount|Price|Qty|Num|Count|Weight|Rate|Pop|Pcs$/i;

            if (numberFieldPatterns.test(fieldName)) {
              // ç§»é™¤åƒåˆ†ä½é€—è™Ÿ
              const cleanValue = value.replace(/,/g, '');
              const numValue = Number(cleanValue);

              // åªæœ‰åœ¨æ˜¯æœ‰æ•ˆæ•¸å­—æ™‚æ‰è½‰æ›ï¼Œå¦å‰‡ä¿æŒåŸå€¼ï¼ˆè®“å¾Œç«¯å ±éŒ¯ï¼‰
              if (!isNaN(numValue)) {
                value = numValue;
              }
            }
          }

          rowData[fieldName] = value;
          hasChangedField = true;
        }
      }

      if (!isAdded && !hasChangedField) continue;

      // ? ç¢ºä¿ PaperNum å’Œ Item ä¸€å®šå­˜åœ¨ï¼ˆå¾ dataset å–å¾—ä¸»éµå€¼ï¼‰
      if (!rowData.PaperNum && rowPaperNum) {
        rowData.PaperNum = rowPaperNum;
        console.log(`?? [å„²å­˜] æ˜ç¢ºåŠ å…¥ PaperNum: ${rowPaperNum}`);
      }

      const rowItem = row.dataset.item;
      if (!rowData.Item && rowItem) {
        // Item éœ€è¦è½‰æˆæ•¸å­—
        const itemNum = Number(rowItem);
        if (!isNaN(itemNum)) {
          rowData.Item = itemNum;
          console.log(`?? [å„²å­˜] æ˜ç¢ºåŠ å…¥ Item: ${itemNum}`);
        }
      }

      // ç¢ºä¿æœ‰è³‡æ–™å†åŠ å…¥ï¼Œä¸¦ä¸”é¡¯ç¤ºå®Œæ•´çš„ rowData å…§å®¹
      if (Object.keys(rowData).length > 0) {
        console.log(`?? [å„²å­˜] æ”¶é›†çš„å®Œæ•´åˆ—è³‡æ–™:`, JSON.stringify(rowData, null, 2));
        changes.push(rowData);
      }
    }

    if (changes.length > 0) {
      console.log(`?? [å„²å­˜] ${tableName} æ”¶é›†åˆ° ${changes.length} ç­†è®Šæ›´`);
      allChanges.push({ tableName, changes });
    }
  }

  const subDetailPayload = (typeof window.__paper3lSubDetailCollectChanges === 'function')
    ? window.__paper3lSubDetailCollectChanges()
    : null;
  if (subDetailPayload?.changes?.length) {
    allChanges.push(subDetailPayload);
  }

  if (allChanges.length === 0) {
    console.log('?? [å„²å­˜] æ²’æœ‰è®Šæ›´éœ€è¦å„²å­˜');
    return { ok: true, hasChanges: false };
  }

  try {
    let saveSuccess = true;
    let saveErrors = [];

    const formatSaveError = (raw, tableName) => {
      const text = (raw || '').toString();
      const key = (tableName || '').toString().replace(/^dbo\./i, '').trim().toLowerCase();
      const dict = window._detailFieldDicts?.[key] || {};
      const colMatch = text.match(/è³‡æ–™è¡Œ\s+'([^']+)'/i) || text.match(/column\s+'([^']+)'/i);
      const col = colMatch ? colMatch[1] : '';
      if (!col) return text;
      const label = dict[col] || dict[col.toLowerCase?.()] || col;
      return `${label}(${col})ä¸èƒ½ç‚ºç©º`;
    };

    for (const { tableName, changes, keyFields: keyFieldsOverride } of allChanges) {
      console.log(`?? [å„²å­˜] å„²å­˜ ${tableName}:`, changes);

      // å–å¾—ä¸»éµæ¬„ä½ï¼ˆå¾ç¬¬ä¸€ç­†è³‡æ–™æ¨æ–·ï¼‰
      const firstRow = changes[0];
      const keyFields = Array.isArray(keyFieldsOverride) ? keyFieldsOverride.slice(0) : [];
      if (keyFields.length === 0) {
        if (firstRow.PaperNum !== undefined) keyFields.push('PaperNum');
        if (firstRow.Item !== undefined) keyFields.push('Item');
      }

      const payload = {
        TableName: tableName,
        Data: changes,
        KeyFields: keyFields
      };

      const resp = await fetch('/api/CommonTable/SaveTableChanges', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        saveSuccess = false;
        const errorText = await resp.text();
        const friendly = formatSaveError(errorText, tableName);
        saveErrors.push(`${tableName}: ${friendly}`);
        console.error(`? [å„²å­˜] ${tableName} å„²å­˜å¤±æ•—:`, errorText);
      } else {
        const result = await resp.json();
        console.log(`? [å„²å­˜] ${tableName} å„²å­˜æˆåŠŸ:`, result);

        // å„²å­˜æˆåŠŸå¾Œï¼Œå°‡æ‰€æœ‰å·²ä¿®æ”¹åˆ—çš„ç‹€æ…‹æ”¹ç‚º unchangedï¼Œä¸¦åŒæ­¥æ›´æ–° view é¡¯ç¤ºå€¼
        const container = document.querySelector(`.table-container[data-dict-table="${tableName}"]`);
        if (container) {
          container.querySelectorAll('tr[data-state="modified"], tr[data-state="added"]').forEach(tr => {
            tr.dataset.state = 'unchanged';

            // ? åŒæ­¥æ›´æ–° view é¡¯ç¤ºå€¼ï¼šå°‡ input çš„å€¼è¤‡è£½åˆ°å°æ‡‰çš„ cell-view
            tr.querySelectorAll('.cell-edit').forEach(input => {
              const fieldName = input.dataset.field || input.name;
              if (!fieldName) return;

              // æ‰¾åˆ°åŒä¸€å€‹ td å…§çš„ cell-view
              const td = input.closest('td');
              if (td) {
                const viewSpan = td.querySelector('.cell-view');
                if (viewSpan) {
                  // æ›´æ–°é¡¯ç¤ºå€¼ï¼ˆä¿ç•™åƒåˆ†ä½æ ¼å¼åŒ–ï¼Œå¦‚æœæœ‰çš„è©±ï¼‰
                  let displayValue = input.value?.trim() || '';

                  // å¦‚æœæ˜¯æ•¸å­—æ¬„ä½ï¼Œå¯ä»¥é¸æ“‡æ€§åŠ ä¸Šåƒåˆ†ä½
                  const numberFieldPatterns = /Qnty|Amount|Price|Qty|Count|Weight$/i;
                  if (numberFieldPatterns.test(fieldName) && displayValue) {
                    const num = parseFloat(displayValue.replace(/,/g, ''));
                    if (!isNaN(num)) {
                      displayValue = num.toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 4
                      });
                    }
                  }

                  viewSpan.textContent = displayValue;
                  console.log(`?? [å„²å­˜] åŒæ­¥æ›´æ–° ${fieldName}: "${displayValue}"`);
                }
              }
            });
          });
        }
      }
    }

    if (saveSuccess) {
      if (!opts.silentSuccess) {
        await Swal.fire({
          icon: 'success',
          title: 'å„²å­˜æˆåŠŸ',
          text: 'å–®èº«è³‡æ–™å·²æˆåŠŸå„²å­˜',
          timer: 1500,
          showConfirmButton: false
        });
      }
      return { ok: true, hasChanges: true };
    }

    await Swal.fire({
      icon: 'error',
      title: 'å„²å­˜å¤±æ•—',
      html: saveErrors.join('<br>')
    });
    return { ok: false, hasChanges: true };
  } catch (err) {
    console.error('? [å„²å­˜] å„²å­˜éŒ¯èª¤:', err);
    await Swal.fire({
      icon: 'error',
      title: 'å„²å­˜éŒ¯èª¤',
      text: String(err)
    });
    return { ok: false, hasChanges: true };
  }
}

// ============================
// å„²å­˜å–®é ­
// ============================
document.getElementById('orderHeaderForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const header = collectHeaderFormData();
  normalizeNumberFields(header, PAGE.headerFields);

  const payload = { ...header, __headerTable: PAGE.headerTable };

  try {
    const detailSave = await saveMultiTabChanges({ silentSuccess: true });
    if (!detailSave.ok) return;

    const resp = await fetch('/api/OrderHeaderApi/SaveOrderHeader', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
    });
    if (resp.ok) {
      const result = await resp.json();
      if (result.updated) {
        await Swal.fire({ icon: 'success', title: 'å„²å­˜æˆåŠŸï¼', timer: 1000, showConfirmButton: false });
        localStorage.setItem("afterSave", "1"); location.reload();
      } else {
        Swal.fire({ icon: 'info', title: 'æ²’æœ‰è³‡æ–™ç•°å‹•' });
      }
    } else {
      let msg = 'å„²å­˜å¤±æ•—'; try { const txt = await resp.text(); msg = txt || msg; } catch {}
      Swal.fire({ icon: 'error', title: msg });
    }
  } catch (err) { Swal.fire({ icon: 'error', title: 'ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤' }); }
});

// ============================
// æª¢è¦–/ç·¨è¼¯æ¨¡å¼åˆ‡æ›
// ============================
const editBtn = document.getElementById('btnViewEditToggle');
if (editBtn) {
  let isEdit = false;
  if (localStorage.getItem("afterSave") === "1" && typeof window.__headerIsEdit !== 'boolean') {
    window.__headerIsEdit = true;
  }

  function setLookupReadOnly(el, readOnly) {
    if (!el) return;
    const isSelect = el.tagName && el.tagName.toLowerCase() === 'select';
    if (readOnly) {
      el.dataset.lockedValue = el.value ?? '';
      el.classList.add('lookup-readonly');
      el.setAttribute('aria-readonly', 'true');
      el.title = 'ç€è¦½æ¨¡å¼ï¼šå¯æŸ¥çœ‹ä¸‹æ‹‰å…§å®¹ï¼Œä¸èƒ½ä¿®æ”¹';
      if (isSelect) {
        el.disabled = false;
      } else {
        el.readOnly = true;
        el.disabled = false;
      }
    } else {
      el.classList.remove('lookup-readonly');
      el.removeAttribute('aria-readonly');
      el.title = '';
      el.dataset.lockedValue = el.value ?? '';
      if (isSelect) {
        el.disabled = false;
      } else {
        el.readOnly = false;
        el.disabled = false;
      }
    }
  }

  function applyHeaderEditState(editing) {
    document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
      .forEach(el => {
        if (el.closest('.modal')) return;
        const isDictReadOnly = el.dataset.readonly === '1';
        if (el.matches('.lookup-dropdown')) {
          setLookupReadOnly(el, isDictReadOnly || !editing);
        } else {
          if (isDictReadOnly) {
            if (el.type === 'checkbox') {
              el.disabled = true;
            } else {
              el.readOnly = true;
            }
            el.classList.add('dict-readonly');
            el.disabled = false;
          } else {
            el.disabled = !editing;
          }
        }
      });
  }

  function applyToolbarEditState(editing) {
    const editOnlyIds = ['btnSubDetailAdd', 'btnSubDetailDelete', 'btnSaveHeader', 'btnCancelChanges'];
    editOnlyIds.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.disabled = !editing;
      el.classList.toggle('disabled', !editing);
    });

    const viewOnlyIds = ['btnSubSearch', 'btnSwitch', 'btnSubAddNew', 'btnPrint', 'btnCancel', 'btnPrev', 'btnNext'];
    viewOnlyIds.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      if (editing) {
        el.dataset.prevDisabled = el.disabled ? '1' : '0';
        el.disabled = true;
        el.classList.add('disabled');
      } else {
        const wasDisabled = el.dataset.prevDisabled === '1';
        el.disabled = wasDisabled;
        if (!wasDisabled) el.classList.remove('disabled');
        delete el.dataset.prevDisabled;
      }
    });
  }

  document.addEventListener('change', (e) => {
    const sel = e.target;
    if (!(sel instanceof HTMLSelectElement || sel instanceof HTMLInputElement)) return;
    if (!sel.matches('.erp-header-form .lookup-dropdown')) return;
    if (sel.closest('.modal')) return;
    if (isEdit && sel.dataset.readonly !== '1') return;

    const locked = sel.dataset.lockedValue ?? '';
    if ((sel.value ?? '') !== locked) {
      sel.value = locked;
    }
    e.stopPropagation();
  }, true);
  document.addEventListener('input', (e) => {
    const sel = e.target;
    if (!(sel instanceof HTMLInputElement)) return;
    if (!sel.matches('.erp-header-form .lookup-dropdown')) return;
    if (sel.closest('.modal')) return;
    if (isEdit && sel.dataset.readonly !== '1') return;

    const locked = sel.dataset.lockedValue ?? '';
    if ((sel.value ?? '') !== locked) {
      sel.value = locked;
    }
    e.stopPropagation();
  }, true);
  document.addEventListener('keydown', (e) => {
    const sel = e.target;
    if (!(sel instanceof HTMLSelectElement)) return;
    if (!sel.matches('.erp-header-form .lookup-dropdown')) return;
    if (sel.closest('.modal')) return;
    if (isEdit && sel.dataset.readonly !== '1') return;

    const blockKeys = ['ArrowUp', 'ArrowDown', 'Home', 'End', 'PageUp', 'PageDown', ' ', 'Enter'];
    if (blockKeys.includes(e.key)) {
      e.preventDefault();
      e.stopPropagation();
    }
  }, true);
  const getHeaderValueByLabel = (labelText) => {
    const $label = $('.header-label-item').filter(function () {
      return $(this).text().trim() === labelText;
    }).first();
    if (!$label.length) return null;
    const fieldName = $label.data('field');
    if (!fieldName) return null;
    const $li = $(`.draggable-field[data-field="${fieldName}"]`).first();
    if (!$li.length) return null;
    const $ctrl = $li.find('select, input, textarea').first();
    if (!$ctrl.length) return null;
    if ($ctrl.is('select')) return $ctrl.find('option:selected').text().trim();
    return ($ctrl.val() || '').toString().trim();
  };

  function setHeaderEditMode(editing) {
    isEdit = !!editing;
    window.__headerIsEdit = isEdit;
    try {
      window.dispatchEvent(new CustomEvent('headerEditModeChanged', { detail: { isEdit } }));
    } catch {}
    const topToolbar = document.getElementById('topToolbar');
    if (topToolbar) {
      topToolbar.classList.toggle('mode-edit', isEdit);
      topToolbar.classList.toggle('mode-view', !isEdit);
    }
    const countBox = document.getElementById('toolbarCountBox');
    if (countBox) {
      countBox.classList.toggle('mode-edit', isEdit);
      countBox.classList.toggle('mode-view', !isEdit);
    }
    editBtn.textContent = isEdit ? 'ä¿ç•™' : 'ä¿®æ”¹';
    applyHeaderEditState(isEdit);
    applyToolbarEditState(isEdit);

    // åˆ‡æ›å–®é ­æ¬„ä½çš„ disabled ç‹€æ…‹
    document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
      .forEach(el => {
        if (el.closest('.modal')) return;
        const isDictReadOnly = el.dataset.readonly === '1';
        if (el.matches('.lookup-dropdown')) {
          setLookupReadOnly(el, isDictReadOnly || !isEdit);
          if (isDictReadOnly) el.classList.add('dict-readonly');
          return;
        }
        if (isDictReadOnly) {
          if (el.type === 'checkbox') {
            el.disabled = true;
          } else {
            el.readOnly = true;
            el.disabled = false;
          }
          el.classList.add('dict-readonly');
        } else {
          el.disabled = !isEdit;
        }
      });

    // ? åˆ‡æ›å–®èº«è¡¨æ ¼çš„é¡¯ç¤º/ç·¨è¼¯æ¨¡å¼ï¼ˆé‡å° _MultiTabDetail.cshtmlï¼‰
    document.querySelectorAll('.multi-tab-detail .erp-table .cell-view')
      .forEach(el => el.classList.toggle('d-none', isEdit));
    document.querySelectorAll('.multi-tab-detail .erp-table .cell-edit')
      .forEach(el => el.classList.toggle('d-none', !isEdit));

    // ç¶å®š input äº‹ä»¶ï¼Œæ¨™è¨˜åˆ—ç‚ºå·²ä¿®æ”¹
    if (isEdit) {
      document.querySelectorAll('.multi-tab-detail .erp-table .cell-edit').forEach(inp => {
        inp.addEventListener('input', () => {
          const tr = inp.closest('tr');
          if (tr && tr.dataset.state !== 'added') {
            tr.dataset.state = 'modified';
          }
          window.__unsavedChanges = true;
        });
      });
    }
  }

  window.__setHeaderEditMode = setHeaderEditMode;

  editBtn.addEventListener('click', async function () {
    // âœ… é‡å° FMEdIssueMain ä½¿ç”¨ Finished æ¬„ä½æª¢æŸ¥ï¼ˆæ•¸å­—ï¼‰
    const headerTableName = window._headerTableName;
    console.log('ğŸ” [ä¿®æ”¹æŒ‰éˆ•] headerTableName:', headerTableName);
    console.log('ğŸ” [ä¿®æ”¹æŒ‰éˆ•] finishedStatus:', window._finishedStatus);

    // ? å¦‚æœæ˜¯å¾ã€Œç·¨è¼¯æ¨¡å¼ã€åˆ‡å›ã€Œæª¢è¦–æ¨¡å¼ã€ï¼ˆä¿ç•™ï¼‰ï¼Œå‰‡å„²å­˜å–®èº«è³‡æ–™
    if (isEdit) {
      console.log('?? [ä¿ç•™æŒ‰éˆ•] é–‹å§‹å„²å­˜å–®èº«è³‡æ–™...');
      const detailSave = await saveMultiTabChanges();
      if (!detailSave.ok) return;
    }

    // â­ å¦‚æœæ˜¯å¾ã€Œæª¢è¦–æ¨¡å¼ã€åˆ‡åˆ°ã€Œç·¨è¼¯æ¨¡å¼ã€ï¼ˆä¿®æ”¹ï¼‰ï¼Œå…ˆæª¢æŸ¥ç‹€æ…‹
    if (!isEdit) {
      if (headerTableName === 'FMEdIssueMain') {
        // ä½¿ç”¨å¾Œç«¯å‚³éçš„ Finished ç‹€æ…‹
        const finished = window._finishedStatus;

        // ç‹€æ…‹å°ç…§è¡¨
        const statusMap = {0:'ä½œæ¥­ä¸­', 1:'å·²ç¢ºèª', 2:'ä½œå»¢ä¸­', 3:'å¯©æ ¸ä¸­', 4:'å·²çµæ¡ˆ'};
        const statusName = statusMap[finished] || `ä»£ç¢¼:${finished}`;

        // å…è¨±ä¿®æ”¹çš„ç‹€æ…‹ï¼šä½œæ¥­ä¸­(0) å’Œ å¯©æ ¸ä¸­(3)
        const allowedStatuses = [0, 3];
        if (finished !== null && !allowedStatuses.includes(finished)) {
          console.log('ğŸš« [ä¿®æ”¹æŒ‰éˆ•] ç‹€æ…‹ä¸å…è¨±ä¿®æ”¹ï¼Œé˜»æ­¢ä¿®æ”¹');
          Swal.fire({
            icon: 'warning',
            title: 'ç„¡æ³•ä¿®æ”¹',
            html: `å–®æ“šç‹€æ…‹ï¼š<b>${statusName}</b><br>åªæœ‰ã€Œä½œæ¥­ä¸­ã€æˆ–ã€Œå¯©æ ¸ä¸­ã€çš„å–®æ“šæ‰èƒ½é€²è¡Œä¿®æ”¹ã€‚`
          });
          return;
        }
        console.log('âœ… [ä¿®æ”¹æŒ‰éˆ•] ç‹€æ…‹å…è¨±ä¿®æ”¹');
      } else {
        // ä¸€èˆ¬å–®æ“šä½¿ç”¨åŸæœ¬çš„ã€Œå–®æ“šç‹€æ…‹ã€æ–‡å­—æª¢æŸ¥
        const status = getHeaderValueByLabel('å–®æ“šç‹€æ…‹') || '';
        if (window.BLOCK_STATUSES && window.BLOCK_STATUSES.includes(status)) {
          Swal.fire({ icon: 'warning', title: 'ç„¡æ³•ä¿®æ”¹', text: `æ­¤å–®æ“šç‹€æ…‹ç‚ºã€Œ${status}ã€ï¼Œä¸å¯é€²è¡Œä¿®æ”¹ã€‚`});
          return;
        }
      }
    }

    setHeaderEditMode(!isEdit);
  });

  window.addEventListener('load', () => {
    captureHeaderInitValues();
    setHeaderEditMode(false);
    if (localStorage.getItem("afterSave") === "1") {
      localStorage.removeItem("afterSave");
      document.getElementById("btnViewEditToggle")?.click();
    }
  });
}

// ============================
// Header ç‰ˆé¢æ‹–æ‹‰å„²å­˜ / Lookup ä¸‹æ‹‰åˆå§‹åŒ–ï¼ˆjQueryï¼‰
// ============================
$(function () {
  let debounceTimer;
  const debounceSave = () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(saveLayoutChanges, 400); };

  function saveLayoutChanges() {
    const layout = [];
    const headerTopPad = 6;
    const hiddenTabs = $(".tab-pane").not(".show");
    hiddenTabs.addClass("temporary-show").addClass("show").css("display", "block");
    $(".draggable-field").each(function () {
      const $li = $(this);
      const $label = $(`.header-label-item[data-field="${$li.data("field")}"]`).first();
      const labelPos = $label.length ? $label.position() : null;
      const fieldTop = Math.max(0, Math.round($li.position().top) - headerTopPad);
      const fieldLeft = Math.round($li.position().left);
      const labTop = labelPos ? Math.max(0, Math.round(labelPos.top) - headerTopPad) : null;
      const labLeft = labelPos ? Math.round(labelPos.left) : null;
      layout.push({
        fieldName: $li.data("field"),
        top: fieldTop,
        left: fieldLeft,
        width: Math.round($li.outerWidth()),
        height: Math.round($li.outerHeight()),
        labTop: labTop,
        labLeft: labLeft,
        ishowWhere: parseInt($li.attr("data-tab")) || 1
      });
    });
    hiddenTabs.removeClass("show").removeClass("temporary-show").css("display", "");
    if (!layout.length) return;

    fetch("/api/TableFieldLayout/SaveHeaderLayout", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tableName: "@Model.HeaderTableName", layoutUpdates: layout })
    }).catch(()=>{});
  }

  $(".draggable-field").each(function () {
    const $li = $(this);
    $li.draggable({
      handle: ".field-drag-handle",
      helper: function () {
        const labelText = $('.header-label-item[data-field="' + $li.data('field') + '"]').text().trim();
        return $("<div>").text(labelText).css({
          width: "80px", height: $li.outerHeight() + "px",
          background: "#eef", border: "1px dashed #999", padding: "4px", "font-size": "0.9em"
        });
      },
      appendTo: "body", zIndex: 10000,
      start: function () { $(this).hide(); },
      stop: function (event, ui) {
        const $item = $(this);
        $item.show();

        const $parent = $item.parent();
        const parentOff = $parent.offset();
        if (parentOff) {
          $item.css({
            position: "absolute",
            top: Math.round(ui.offset.top - parentOff.top),
            left: Math.round(ui.offset.left - parentOff.left)
          });
        }

        debounceSave();
      }
    });
    $li.resizable({ handles: "e, se", minWidth: 50, minHeight: 22, stop: debounceSave });
  });

  function setLayoutEditEnabled(enabled) {
    const $body = $(document.body);
    const uid = (localStorage.getItem('erpLoginUserId') || window._userId || '').toString().trim().toLowerCase();
    const cachedAdmin = uid ? localStorage.getItem(`erpIsAdmin:${uid}`) === '1' : false;
    const bodyAdmin = document.body?.dataset?.isAdmin === '1';
    const canEnable = !!enabled && (window.__isAdmin === true || cachedAdmin || bodyAdmin);
    $body.toggleClass("layout-edit-enabled", canEnable);
    $(".draggable-field").each(function () {
      try { $(this).draggable(canEnable ? "enable" : "disable"); } catch {}
      try { $(this).resizable(canEnable ? "enable" : "disable"); } catch {}
    });
  }

  setLayoutEditEnabled(false);
  $(document).on("keydown", function (e) {
    if (e.key === "Shift" || e.shiftKey) {
      window.__layoutShiftDown = true;
      setLayoutEditEnabled(true);
    }
  });
  $(document).on("keyup", function (e) {
    if (e.key === "Shift" || !e.shiftKey) {
      window.__layoutShiftDown = false;
      setLayoutEditEnabled(false);
    }
  });
  window.addEventListener('adminStateReady', () => {
    if (window.__layoutShiftDown) setLayoutEditEnabled(true);
  });

  // ============================
  // å¤šé¸/ç¾¤çµ„æ‹–æ›³/å°é½Šï¼ˆå¿«æ·éµï¼‰
  //  - Ctrl/Meta+é»æ“Šï¼šåˆ‡æ›é¸å–
  //  - é»æ“Šç©ºç™½ï¼šæ¸…é™¤é¸å–
  //  - æ‹–æ›³ä»»ä¸€è¢«é¸å–çš„ labelï¼šæ•´çµ„ä¸€èµ·ç§»å‹•
  //  - L/R/T/Bï¼šå·¦/å³/ä¸Š/ä¸‹å°é½Š
  //  - H/Vï¼šæ°´å¹³/å‚ç›´å¹³å‡åˆ†ä½ˆ
  //  - æ–¹å‘éµï¼šå¾®èª¿ï¼ˆShift=10pxï¼‰
  // ============================
  const $doc = $(document);
  const SELECTED_CLASS = "md-selected";
  let dragGroupSnapshot = null;

    function $allFields() { return $(".draggable-field"); }
    function getLabelForField($field) {
      const fieldName = $field?.data("field");
      if (!fieldName) return $();
      return $(`.header-label-item[data-field="${fieldName}"]`).first();
    }
    function moveLabel($label, top, left) {
      if (!$label || !$label.length) return;
      $label.css({ position: "absolute", top: Math.max(0, top), left: Math.max(0, left) });
    }
  function $selected() { return $allFields().filter("." + SELECTED_CLASS); }
  function isTypingTarget(e) {
    const t = e?.target;
    if (!t) return false;
    const tag = (t.tagName || "").toLowerCase();
    return tag === "input" || tag === "textarea" || tag === "select" || t.isContentEditable;
  }
  function clearSelection() { $selected().removeClass(SELECTED_CLASS); }
  function toggleSelection($el) { $el.toggleClass(SELECTED_CLASS); }
  function selectOnly($el) { clearSelection(); $el.addClass(SELECTED_CLASS); }

  $doc.on("mousedown", ".field-drag-handle", function (e) {
    if (window.__DICT_OPEN__) return;
    const $field = $(this).closest(".draggable-field");
    if (!$field.length) return;

    if (e.ctrlKey || e.metaKey) {
      toggleSelection($field);
    } else if (!$field.hasClass(SELECTED_CLASS)) {
      selectOnly($field);
    }
  });
  $doc.on("mousedown", ".header-label-item", function (e) {
    if (window.__DICT_OPEN__) return;
    const fieldName = $(this).data("field");
    if (!fieldName) return;
    const $field = $(`.draggable-field[data-field="${fieldName}"]`).first();
    if (!$field.length) return;

    if (e.ctrlKey || e.metaKey) {
      toggleSelection($field);
    } else if (!$field.hasClass(SELECTED_CLASS)) {
      selectOnly($field);
    }
  });
  $doc.on("mousedown", function (e) {
    if (window.__DICT_OPEN__) return;
    if ($(e.target).closest(".draggable-field, .header-label-item, .ui-resizable-handle, .modal").length) return;
    clearSelection();
  });

  function ensureDragGroupSnapshot($base) {
    const $sel = $selected();
    const $group = ($sel.length ? $sel : $base);
    if (!$base.hasClass(SELECTED_CLASS) && $sel.length) selectOnly($base);
    dragGroupSnapshot = {
      baseEl: $base.get(0),
      baseTop: Math.round($base.position().top),
      baseLeft: Math.round($base.position().left),
      items: $group.toArray().map(el => {
        const $el = $(el);
        const $label = getLabelForField($el);
        const labelPos = $label.length ? $label.position() : null;
        return {
          el,
          top: Math.round($el.position().top),
          left: Math.round($el.position().left),
          labelEl: $label.get(0) || null,
          labelTop: labelPos ? Math.round(labelPos.top) : null,
          labelLeft: labelPos ? Math.round(labelPos.left) : null
        };
      })
    };
  }

    $allFields().each(function () {
      const $li = $(this);
      $li.draggable("option", "start", function () {
        if (window.__DICT_OPEN__) return;
        ensureDragGroupSnapshot($(this));
        $(this).hide();
      });
      $li.draggable("option", "drag", function (event, ui) {
        const $item = $(this);
        if (!dragGroupSnapshot || dragGroupSnapshot.baseEl !== $item.get(0)) return;
        const $parent = $item.parent();
        const parentOff = $parent.offset();
        if (!parentOff) return;
        const newTop = Math.round(ui.offset.top - parentOff.top);
        const newLeft = Math.round(ui.offset.left - parentOff.left);
        const dy = newTop - dragGroupSnapshot.baseTop;
        const dx = newLeft - dragGroupSnapshot.baseLeft;
        dragGroupSnapshot.items.forEach(it => {
          if (it.labelEl && it.labelTop != null && it.labelLeft != null) {
            moveLabel($(it.labelEl), it.labelTop + dy, it.labelLeft + dx);
          }
        });
      });
      $li.draggable("option", "stop", function (event, ui) {
        const $item = $(this);
        $item.show();

      const $parent = $item.parent();
      const parentOff = $parent.offset();
      if (!parentOff) return;

      const newTop = Math.round(ui.offset.top - parentOff.top);
      const newLeft = Math.round(ui.offset.left - parentOff.left);

        if (dragGroupSnapshot && dragGroupSnapshot.baseEl === $item.get(0)) {
          const dy = newTop - dragGroupSnapshot.baseTop;
          const dx = newLeft - dragGroupSnapshot.baseLeft;
          dragGroupSnapshot.items.forEach(it => {
            const $el = $(it.el);
            $el.css({
              position: "absolute",
              top: Math.max(0, it.top + dy),
              left: Math.max(0, it.left + dx)
            });
            if (it.labelEl && it.labelTop != null && it.labelLeft != null) {
              moveLabel($(it.labelEl), it.labelTop + dy, it.labelLeft + dx);
            }
          });
          dragGroupSnapshot = null;
          debounceSave();
          return;
        }

        const oldPos = $item.position();
        const dy = newTop - Math.round(oldPos.top);
        const dx = newLeft - Math.round(oldPos.left);
        $item.css({ position: "absolute", top: newTop, left: newLeft });
        const $label = getLabelForField($item);
        if ($label.length) {
          const labelPos = $label.position();
          moveLabel($label, Math.round(labelPos.top) + dy, Math.round(labelPos.left) + dx);
        }
        dragGroupSnapshot = null;
        debounceSave();
      });
    });

  function applyToSelected(mutator) {
    const $sel = $selected();
    if (!$sel.length) return false;
    $sel.each(function () { mutator($(this)); });
    debounceSave();
    return true;
  }
  function alignSelected(mode) {
    const $sel = $selected();
    if ($sel.length < 2) return false;
    const boxes = $sel.toArray().map(el => {
      const $el = $(el);
      const p = $el.position();
      const w = $el.outerWidth();
      const h = $el.outerHeight();
      const $ctrl = $el.find('select, input, textarea').first();
      const ctrlOff = $ctrl.length ? $ctrl.offset() : null;
      const elOff = $el.offset();
      const ctrlLeftAbs = ctrlOff?.left ?? elOff.left;
      const ctrlTopAbs = ctrlOff?.top ?? elOff.top;
      const ctrlW = $ctrl.length ? $ctrl.outerWidth() : w;
      const ctrlH = $ctrl.length ? $ctrl.outerHeight() : h;
      return {
        $el,
        top: Math.round(p.top),
        left: Math.round(p.left),
        right: Math.round(p.left + w),
        bottom: Math.round(p.top + h),
        w,
        h,
        ctrlLeftAbs,
        ctrlRightAbs: ctrlLeftAbs + ctrlW,
        ctrlTopAbs,
        ctrlBottomAbs: ctrlTopAbs + ctrlH,
        ctrlW,
        ctrlH
      };
    });
    const minCtrlLeftAbs = Math.min(...boxes.map(b => b.ctrlLeftAbs));
    const maxCtrlRightAbs = Math.max(...boxes.map(b => b.ctrlRightAbs));

    const minLeft = Math.min(...boxes.map(b => b.left));
    const maxRight = Math.max(...boxes.map(b => b.right));
    const minTop = Math.min(...boxes.map(b => b.top));
    const maxBottom = Math.max(...boxes.map(b => b.bottom));

    boxes.forEach(b => {
      if (mode === "L") {
        const delta = minCtrlLeftAbs - b.ctrlLeftAbs;
        b.$el.css("left", Math.max(0, Math.round(b.left + delta)));
      }
      if (mode === "R") {
        const targetCtrlLeftAbs = maxCtrlRightAbs - b.ctrlW;
        const delta = targetCtrlLeftAbs - b.ctrlLeftAbs;
        b.$el.css("left", Math.max(0, Math.round(b.left + delta)));
      }
      if (mode === "T") b.$el.css("top", minTop);
      if (mode === "B") b.$el.css("top", Math.max(0, maxBottom - b.h));
    });
    debounceSave();
    return true;
  }
  function distributeSelected(axis) {
    const $sel = $selected();
    if ($sel.length < 3) return false;
    const boxes = $sel.toArray().map(el => {
      const $el = $(el);
      const p = $el.position();
      const w = $el.outerWidth();
      const h = $el.outerHeight();
      return { $el, top: Math.round(p.top), left: Math.round(p.left), w, h };
    });
    if (axis === "H") {
      boxes.sort((a, b) => a.left - b.left);
      const first = boxes[0], last = boxes[boxes.length - 1];
      const span = (last.left - first.left);
      const gaps = boxes.length - 1;
      const step = gaps ? Math.round(span / gaps) : 0;
      boxes.forEach((b, i) => b.$el.css("left", Math.max(0, first.left + step * i)));
    } else {
      boxes.sort((a, b) => a.top - b.top);
      const first = boxes[0], last = boxes[boxes.length - 1];
      const span = (last.top - first.top);
      const gaps = boxes.length - 1;
      const step = gaps ? Math.round(span / gaps) : 0;
      boxes.forEach((b, i) => b.$el.css("top", Math.max(0, first.top + step * i)));
    }
    debounceSave();
    return true;
  }

  $doc.on("keydown", function (e) {
    if (window.__DICT_OPEN__) return;
    if (isTypingTarget(e)) return;
    const key = (e.key || "").toUpperCase();

    if (key === "L" || key === "R" || key === "T" || key === "B") {
      if (alignSelected(key)) { e.preventDefault(); return; }
    }
    if (key === "H" || key === "V") {
      if (distributeSelected(key)) { e.preventDefault(); return; }
    }

    const step = e.shiftKey ? 10 : 1;
    if (e.key === "ArrowLeft")  { if (applyToSelected($el => $el.css("left", Math.max(0, Math.round($el.position().left) - step)))) { e.preventDefault(); } return; }
    if (e.key === "ArrowRight") { if (applyToSelected($el => $el.css("left", Math.max(0, Math.round($el.position().left) + step)))) { e.preventDefault(); } return; }
    if (e.key === "ArrowUp")    { if (applyToSelected($el => $el.css("top",  Math.max(0, Math.round($el.position().top) - step)))) { e.preventDefault(); } return; }
    if (e.key === "ArrowDown")  { if (applyToSelected($el => $el.css("top",  Math.max(0, Math.round($el.position().top) + step)))) { e.preventDefault(); } return; }
  });

  $(".header-fields-tab").droppable({
    accept: ".draggable-field", tolerance: "pointer",
    over: function () { $(this).addClass("drop-hover"); },
    out:  function () { $(this).removeClass("drop-hover"); },
    drop: function (event, ui) {
      $(this).removeClass("drop-hover");
      const $zone = $(this), $item = $(ui.draggable);
      const newTabIndex = parseInt($zone.data("tab-index")) || 1;
      $item.appendTo($zone).attr("data-tab", newTabIndex).css({
        top: ui.offset.top - $zone.offset().top,
        left: ui.offset.left - $zone.offset().left,
        position: "absolute"
      });
      debounceSave();
    }
  });

  let dragTabSwitchTimer = null;
  $("#headerTabs button").droppable({
    accept: ".draggable-field",
    over: function () { const $tabBtn = $(this); dragTabSwitchTimer = setTimeout(() => { $tabBtn.trigger("click"); }, 600); },
    out:  function () { clearTimeout(dragTabSwitchTimer); }
  });

  function applyLookupData(el, data, selected) {
    const $el = $(el);
    $el.empty().append('<option value="">--è«‹é¸æ“‡--</option>');
    (data || []).forEach(row => {
      const val = row.key;
      const label = Object.keys(row).filter(p => p.startsWith('result')).map(p => row[p]).join(' - ');
      const $opt = $('<option>').val(val).text(label);
      if (val == selected) $opt.attr('selected', true);
      $el.append($opt);
    });
    $el.next('.lookup-label').text($el.find('option:selected').text());
    if (el.classList.contains('lookup-readonly')) {
      el.dataset.lockedValue = el.value ?? '';
    }
  }

  function loadLookupOptions(el) {
    if (!el || el.dataset.lookupLoading === '1' || el.dataset.lookupLoaded === '1') return;
    const table = el.dataset.table || '';
    const key = el.dataset.key || '';
    const result = el.dataset.result || '';
    if (!table || !key || !result) return;
    el.dataset.lookupLoading = '1';
    const url = `/api/TableFieldLayout/LookupData?table=${encodeURIComponent(table)}&key=${encodeURIComponent(key)}&result=${encodeURIComponent(result)}`;
    fetch(url)
      .then(r => r.ok ? r.json() : [])
      .then(data => {
        applyLookupData(el, data, el.dataset.selected);
        el.dataset.lookupLoaded = '1';
      })
      .catch(() => {})
      .finally(() => { delete el.dataset.lookupLoading; });
  }

  $('.lookup-dropdown').each(function() {
    const el = this;
    loadLookupOptions(el);
    $(el).on('change', function() {
      $(this).next('.lookup-label').text($(this).find('option:selected').text());
    });
  });

  function setInitialTabHeights(offsetPx = 4) {
    const hiddenTabs = $(".tab-pane").not(".show");
    hiddenTabs.addClass("tmp-show").addClass("show").css("display", "block");
    $(".header-fields-tab").each(function () {
      let maxBottom = 0;
      $(this).children(".draggable-field").each(function () {
        const $el = $(this);
        maxBottom = Math.max(maxBottom, $el.position().top + $el.outerHeight());
      });
      $(this).height(Math.max(0, Math.ceil(maxBottom + offsetPx)));
    });
    hiddenTabs.removeClass("show tmp-show").css("display", "");
  }
  requestAnimationFrame(() => setInitialTabHeights(4));
});

// ============================
// ä¸Šä¸€ç­† / ä¸‹ä¸€ç­†
// ============================
const NAV_BTN_PREV = document.getElementById('btnPrev');
const NAV_BTN_NEXT = document.getElementById('btnNext');
let navIds = [], navIndex = -1;
const headerCountEl = document.getElementById('toolbarHeaderCount');
const detailCountEl = document.getElementById('toolbarDetailCount');

function loadLastFilters() {
  try {
    const tn = (PAGE.headerTable || '').toString().trim().toLowerCase();
    const fk = tn ? `orderListQueryFilters:${tn}` : "orderListQueryFilters";
    const s1 = localStorage.getItem(fk);
    if (s1) return JSON.parse(s1);

    // legacy: only accept global filters if they were saved for the same table
    const legacyTable = (localStorage.getItem("orderListQueryTable") || '').toLowerCase();
    const s2 = legacyTable === tn ? localStorage.getItem("orderListQueryFilters") : null;
    return s2 ? JSON.parse(s2) : [];
  }
  catch { return []; }
}
function getDetailBasePath() { return location.pathname.replace(/\/[^\/]+$/, "/"); }
function gotoPaper(pn) { if (!pn) return; localStorage.setItem("lastViewedPaperNum", pn); location.href = getDetailBasePath() + pn; }
function updateNavButtons() {
  const hasPrev = navIndex > 0;
  const hasNext = navIndex >= 0 && navIndex < navIds.length - 1;
  if (NAV_BTN_PREV) {
    NAV_BTN_PREV.disabled = !hasPrev;
    NAV_BTN_PREV.onclick = () => hasPrev && gotoPaper(navIds[navIndex - 1]);
  }
  if (NAV_BTN_NEXT) {
    NAV_BTN_NEXT.disabled = !hasNext;
    NAV_BTN_NEXT.onclick = () => hasNext && gotoPaper(navIds[navIndex + 1]);
  }
  updateToolbarCounts();
}
async function fetchIdListByPagedQuery(filters) {
  const fs = [...(filters || []), {Field:"page",Op:"",Value:"1"}, {Field:"pageSize",Op:"",Value:"999999"}];
  const res = await fetch('/api/PagedQuery/PagedQuery', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ table: PAGE.headerTable, filters: fs })
  });
  const json = await res.json();
  const rows = Array.isArray(json.data) ? json.data : [];
  return rows.map(r => r[PAGE.keyField]).filter(Boolean);
}
async function fetchIdListByDynamicTable(filters) {
  const fs = [...(filters || []), { Field: "page", Op: "", Value: "1" }, { Field: "pageSize", Op: "", Value: "999999" }];
  const res = await fetch('/api/DynamicTable/PagedQuery', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ table: PAGE.headerTable, filters: fs })
  });
  if (!res.ok) throw new Error('DynamicTable/PagedQuery failed');
  const json = await res.json();
  const rows = Array.isArray(json.data) ? json.data : [];
  return rows.map(r => (r?.[PAGE.keyField] ?? r?.[PAGE.keyField?.toLowerCase?.()]))
    .filter(Boolean)
    .map(x => x.toString());
}
async function initRowNavigation() {
  try {
    const filters = loadLastFilters();
    // ä¾åºå˜—è©¦ï¼šIdListï¼ˆè‹¥æœ‰ï¼‰â†’ PagedQueryï¼ˆEF DbSetï¼‰â†’ DynamicTableï¼ˆSQL å‹•æ…‹æŸ¥è©¢ï¼Œæœ€é€šç”¨ï¼‰
    try { navIds = await fetchIdListByApi(filters); }
    catch {
      try { navIds = await fetchIdListByPagedQuery(filters); }
      catch { navIds = await fetchIdListByDynamicTable(filters); }
    }
    const cur = (PAGE.paperNum || '').toString().trim().toLowerCase();
    navIndex = navIds.findIndex(x => (x || '').toString().trim().toLowerCase() === cur);
    updateNavButtons();
  } catch {
    if (NAV_BTN_PREV) NAV_BTN_PREV.disabled = true;
    if (NAV_BTN_NEXT) NAV_BTN_NEXT.disabled = true;
  }
}
initRowNavigation();

function getActiveDetailRowStats() {
  const activePane = document.querySelector('.multi-tab-detail .tab-pane.show.active');
  if (!activePane) return { index: 0, total: 0 };
  const tbody = activePane.querySelector('tbody');
  if (!tbody) return { index: 0, total: 0 };
  const rows = Array.from(tbody.querySelectorAll('tr'))
    .filter(tr => (tr.dataset.state || '').toString().toLowerCase() !== 'empty');
  const total = rows.length;
  if (!total) return { index: 0, total: 0 };
  const selected = tbody.querySelector('tr.row-selected');
  const idx = selected ? rows.indexOf(selected) + 1 : 1;
  return { index: idx, total };
}

function updateToolbarCounts() {
  if (headerCountEl) {
    const total = navIds.length;
    if (total > 0 && navIndex >= 0) {
      headerCountEl.textContent = `${navIndex + 1}/${total}`;
    } else {
      headerCountEl.textContent = '--/--';
    }
  }
  if (detailCountEl) {
    const stats = getActiveDetailRowStats();
    detailCountEl.textContent = stats.total > 0 ? `${stats.index}/${stats.total}` : '--/--';
  }
}

window.__updateToolbarCounts = updateToolbarCounts;

// ============================
// å›ºå®šå·¥å…·åˆ—ï¼šç¬¬äºŒ/ç¬¬ä¸‰éšæ–°å¢åˆªæ¸›
// ============================
(function wireSubDetailToolbar() {
  const btnAdd = document.getElementById('btnSubDetailAdd');
  const btnDel = document.getElementById('btnSubDetailDelete');
  if (!btnAdd && !btnDel) return;
  btnAdd?.classList.remove('d-none');
  btnDel?.classList.remove('d-none');
  const root = document.querySelector('.mmd-wrapper');

  const pickApi = () => {
    const domId = root?.id;
    if (domId && window._mmdApi?.[domId]) return window._mmdApi[domId];
    const keys = Object.keys(window._mmdApi || {});
    return keys.length ? window._mmdApi[keys[0]] : null;
  };

  const warn = (msg) => {
    if (window.Swal?.fire) Swal.fire({ icon: 'info', title: msg });
    else alert(msg);
  };

  const clickMultiTabAction = (kind) => {
    const selector = kind === 'add' ? '.btn-add-row' : '.btn-delete-row';
    const activePane = document.querySelector('.multi-tab-detail .tab-pane.active');
    const scope = activePane || document.querySelector('.multi-tab-detail');
    if (!scope) return { ok: false, reason: 'no-multitab' };
    const btn = scope.querySelector(selector) || document.querySelector(`.multi-tab-detail ${selector}`);
    if (!btn) return { ok: false, reason: 'no-button' };
    btn.click();
    return { ok: true };
  };

  const getActiveMultiTabCtx = () => {
    const activePane = document.querySelector('.multi-tab-detail .tab-pane.active');
    if (!activePane) return null;
    const navBtn = document.querySelector('.multi-tab-detail .nav-link.active[data-api-url]');
    const apiUrl = navBtn?.dataset?.apiUrl || '';
    const tbody = activePane.querySelector('tbody');
    let selectedRow = tbody?.querySelector('tr.row-selected') || null;
    if (!selectedRow) {
      const focusTr = document.activeElement?.closest?.('.multi-tab-detail tbody tr');
      if (focusTr && tbody?.contains(focusTr)) selectedRow = focusTr;
    }
    return { activePane, apiUrl, tbody, selectedRow };
  };

  const detailDefaultsCache = {};

  const escAttr = (v) => String(v ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');

  const getDetailDefaults = async (table) => {
    const key = (table || '').toString().toLowerCase();
    if (!key) return {};
    if (detailDefaultsCache[key]) return detailDefaultsCache[key];
    const url = `/api/OrderHeaderApi/DetailDefaults?table=${encodeURIComponent(table)}`;
    const res = await fetch(url);
    if (!res.ok) return {};
    const data = await res.json();
    const defs = data?.defaults || {};
    detailDefaultsCache[key] = defs;
    return defs;
  };

  function isMultiTabBlankRow(tr, fields) {
    if (!tr) return false;
    const inputs = Array.from(tr.querySelectorAll('.cell-edit[data-field]'));
    if (!inputs.length) return false;
    let hasValue = false;
    inputs.forEach(inp => {
      const f = (inp.dataset.field || '').toString().toLowerCase();
      if (f === 'papernum' || f === 'item') return;
      const val = (inp.value ?? '').toString().trim();
      if (val === '') return;
      if (/^[-â€“â€”]+$/.test(val)) return;
      const num = Number(val);
      if (Number.isFinite(num) && num === 0) return;
      hasValue = true;
    });
    return !hasValue;
  }

  const addMultiTabBlankRow = async () => {
    const ctx = getActiveMultiTabCtx();
    if (!ctx || !ctx.tbody) return { ok: false, reason: 'no-multitab' };
    const { activePane, tbody } = ctx;
    const table = activePane.querySelector('table.erp-table');
    const fields = Array.from(table?.querySelectorAll('thead th') || [])
      .map(th => (th.dataset.field || '').toString())
      .filter(Boolean);
    if (!fields.length) return { ok: false, reason: 'no-fields' };

    const dictTable = activePane?.querySelector?.('.table-container')?.dataset?.dictTable || '';
    const safeTable = (dictTable || '').toString().replace(/^dbo\./i, '').trim();
    const defaults = safeTable ? await getDetailDefaults(safeTable) : {};
    const readOnlyMap = safeTable && window._detailFieldReadOnlyMap
      ? (window._detailFieldReadOnlyMap[safeTable.toLowerCase()] || {})
      : {};

    let maxItem = 0;
    tbody.querySelectorAll('tr').forEach(tr => {
      const n = parseInt(tr.dataset.item || '', 10);
      if (!isNaN(n) && n > maxItem) maxItem = n;
    });
    const newItem = maxItem + 1;
    const pn = (getPaperNum() || '').trim();

    const isEditing = !!document.querySelector('.multi-tab-detail .cell-edit:not(.d-none)');
    const viewClass = isEditing ? 'cell-view d-none' : 'cell-view';
    const editClass = isEditing ? 'cell-edit' : 'cell-edit d-none';

    const pendingRow = tbody.querySelector('tr[data-state="added"]');
    const blankRow = pendingRow || Array.from(tbody.querySelectorAll('tr')).find(tr => isMultiTabBlankRow(tr, fields));
    if (blankRow) {
      tbody.querySelectorAll('tr.row-selected').forEach(r => r.classList.remove('row-selected'));
      blankRow.classList.add('row-selected');
      blankRow.dataset.state = 'added';
      if (!blankRow.dataset.paperNum) blankRow.dataset.paperNum = pn;
      if (!blankRow.dataset.item) blankRow.dataset.item = String(newItem);
      blankRow.querySelectorAll('.cell-view').forEach(el => el.classList.add('d-none'));
      blankRow.querySelectorAll('.cell-edit').forEach(el => el.classList.remove('d-none'));
      const first = blankRow.querySelector('.cell-edit');
      first?.focus();
      if (typeof window.__updateToolbarCounts === 'function') window.__updateToolbarCounts();
      return { ok: true, reused: true };
    }
    let html = `<tr data-paper-num="${pn}" data-item="${newItem}" data-state="added" class="row-selected">`;
      fields.forEach(field => {
        const isReadOnly = !!readOnlyMap[(field || '').toString().toLowerCase()];
        const roClass = isReadOnly ? ' readonly-cell' : '';
        const roAttr = isReadOnly ? ' data-readonly="1" readonly' : ' data-readonly="0"';
        const defVal = (defaults && Object.prototype.hasOwnProperty.call(defaults, field)) ? defaults[field] : '';
        const value = defVal == null ? '' : String(defVal);
        const safeValue = escAttr(value);
        html += `<td data-readonly="${isReadOnly ? '1' : '0'}">
          <span class="${viewClass}${roClass}" data-init-view="${safeValue}" data-readonly="${isReadOnly ? '1' : '0'}">${safeValue}</span>
          <input type="text" class="${editClass}${roClass}" data-field="${field}" data-init="${safeValue}" value="${safeValue}"${roAttr}>
        </td>`;
      });
    html += '</tr>';

    tbody.querySelectorAll('tr.row-selected').forEach(r => r.classList.remove('row-selected'));
    tbody.insertAdjacentHTML('beforeend', html);
    const newRow = tbody.querySelector('tr:last-child');
    if (newRow) {
      const firstInput = newRow.querySelector('input.cell-edit');
      if (firstInput) {
        try { firstInput.focus(); } catch {}
      }
    }
    if (typeof window.__updateToolbarCounts === 'function') window.__updateToolbarCounts();
    return { ok: true };
  };

  const deleteMultiTabSelectedRow = async () => {
    const ctx = getActiveMultiTabCtx();
    if (!ctx || !ctx.tbody) return { ok: false, reason: 'no-multitab' };
    const { apiUrl, selectedRow, tbody, activePane } = ctx;
    if (!selectedRow) return { ok: false, reason: 'no-row' };

    const paperNum = selectedRow.dataset.paperNum || '';
    const item = selectedRow.dataset.item || '';
    const state = selectedRow.dataset.state || '';

    const { isConfirmed } = await Swal.fire({
      icon: 'question',
      title: 'ç¢ºå®šè¦åˆªé™¤é€™ä¸€ç­†æ˜ç´°ï¼Ÿ',
      text: `é …æ¬¡ï¼š${item}`,
      showCancelButton: true,
      confirmButtonText: 'åˆªé™¤',
      cancelButtonText: 'å–æ¶ˆ',
      confirmButtonColor: '#dc3545'
    });
    if (!isConfirmed) return { ok: true, canceled: true };

    if (state === 'added') {
      const next = selectedRow.nextElementSibling || selectedRow.previousElementSibling;
      selectedRow.remove();
      if (next) next.classList.add('row-selected');
      if (typeof window.__updateToolbarCounts === 'function') window.__updateToolbarCounts();
      return { ok: true };
    }

    const dictTable = activePane?.querySelector?.('.table-container')?.dataset?.dictTable || '';
    const safeTable = (dictTable || '').toString().replace(/^dbo\./i, '').trim();
    if (!safeTable) return { ok: false, reason: 'no-table' };

    const deleteUrl = `/api/OrderHeaderApi/DeleteRow?table=${encodeURIComponent(safeTable)}&paperNum=${encodeURIComponent(paperNum)}&item=${encodeURIComponent(item)}`;
    const response = await fetch(deleteUrl, { method: 'DELETE' });
    if (!response.ok) {
      let errorMessage = `HTTP ${response.status}`;
      try {
        const errorData = await response.json();
        if (errorData && errorData.error) errorMessage = errorData.error;
      } catch {
        try {
          const errorText = await response.text();
          if (errorText) errorMessage = errorText;
        } catch {}
      }
      return { ok: false, reason: 'delete-failed', error: errorMessage };
    }

    const next = selectedRow.nextElementSibling || selectedRow.previousElementSibling;
    selectedRow.remove();
    if (next) next.classList.add('row-selected');
    if (typeof window.__updateToolbarCounts === 'function') window.__updateToolbarCounts();
    return { ok: true };
  };

  const tryAddPaper3L = () => {
    if (typeof window.__paper3lSubDetailAddRow !== 'function') return { handled: false };
    if (window.__activeDetailGrid !== 'paper3l') return { handled: false };
    try {
      const res = window.__paper3lSubDetailAddRow();
      return res && typeof res === 'object' ? res : { handled: false };
    } catch (err) {
      return { handled: true, ok: false, reason: 'add-failed', error: err?.message || String(err) };
    }
  };

  btnAdd?.addEventListener('click', async () => {
    const api = pickApi();
    if (api?.addSubDetailRow) {
      api.addSubDetailRow();
      return;
    }
    const r3 = tryAddPaper3L();
    if (r3?.handled) {
      if (r3?.ok) return;
      if (r3?.reason === 'add-failed') return warn(`æ–°å¢å¤±æ•—ï¼š${r3.error || ''}`.trim());
      return;
    }
    const r = await addMultiTabBlankRow();
    if (!r.ok) {
      warn(r.reason === 'no-fields' ? 'æ‰¾ä¸åˆ°æ˜ç´°æ¬„ä½' : 'è«‹å…ˆåˆ‡åˆ°æ˜ç´°åˆ†é å†æ–°å¢');
    }
  });

  const tryDeletePaper3L = async () => {
    if (typeof window.__paper3lSubDetailDeleteRow !== 'function') return { handled: false };
    if (window.__activeDetailGrid !== 'paper3l') return { handled: false };
    try {
      const res = await window.__paper3lSubDetailDeleteRow();
      return res && typeof res === 'object' ? res : { handled: false };
    } catch (err) {
      return { handled: true, ok: false, reason: 'delete-failed', error: err?.message || String(err) };
    }
  };

  btnDel?.addEventListener('click', async () => {
    const api = pickApi();
    if (api?.deleteSubDetailRow) {
      api.deleteSubDetailRow();
      return;
    }
    const r3 = await tryDeletePaper3L();
    if (r3?.handled) {
      if (r3?.ok || r3?.canceled) return;
      if (r3?.reason === 'no-row') return warn('è«‹å…ˆé¸å–åˆ—å†åˆªé™¤');
      if (r3?.reason === 'no-keys') return warn('æ‰¾ä¸åˆ°ç¬¬ä¸‰éšéµæ¬„ä½');
      if (r3?.reason === 'delete-failed') return warn(`åˆªé™¤å¤±æ•—ï¼š${r3.error || ''}`.trim());
      return;
    }
    const r = await deleteMultiTabSelectedRow();
    if (r?.ok) return;
    if (r?.reason === 'no-row') return warn('è«‹å…ˆé¸å–åˆ—å†åˆªé™¤');
    if (r?.reason === 'no-table') return warn('æ‰¾ä¸åˆ°æ˜ç´°è¡¨è¨­å®š');
    if (r?.reason === 'delete-failed') return warn(`åˆªé™¤å¤±æ•—ï¼š${r.error || ''}`.trim());
    const k = clickMultiTabAction('delete');
    if (!k.ok) warn(k.reason === 'no-button' ? 'è«‹å…ˆåˆ‡åˆ°æ˜ç´°åˆ†é ä¸¦é¸å–åˆ—å†åˆªé™¤' : 'æ‰¾ä¸åˆ°æ˜ç´°æŒ‰éˆ•æ§åˆ¶å™¨');
  });
})();

// ============================
// å…¶ä»–ï¼šæŠŠæœ€å¾Œæª¢è¦–çš„å–®è™Ÿå­˜åœ¨ localStorage
// ============================
localStorage.setItem("lastViewedPaperNum", window.selectedPaperNum);
function getHeaderValueByLabel(labelText) {
  const labelEl = Array.from(document.querySelectorAll('.header-label-item'))
    .find(el => (el.textContent || '').trim() === labelText);
  if (!labelEl) return '';
  const fieldName = labelEl.getAttribute('data-field') || '';
  if (!fieldName) return '';
  const li = document.querySelector(`.draggable-field[data-field="${CSS.escape(fieldName)}"]`);
  if (!li) return '';
  const ctrl = li.querySelector('select, input, textarea');
  if (!ctrl) return '';
  if (ctrl.tagName.toLowerCase() === 'select') {
    const opt = ctrl.options[ctrl.selectedIndex];
    return (opt?.text || opt?.value || '').trim();
  }
  return (ctrl.value || '').trim();
}

// æœªå„²å­˜æ——æ¨™
  function syncLookupLabel(selectEl) {
    const label = selectEl?.nextElementSibling;
    if (label && label.classList.contains('lookup-label')) {
      const text = selectEl.options[selectEl.selectedIndex]?.text ?? '';
      label.textContent = text;
    }
  }

  function captureHeaderInitValues() {
    document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
      .forEach(el => {
        if (el.closest('.modal')) return;
        if (el.dataset.init != null) return;
        if (el.type === 'checkbox') {
          el.dataset.init = el.checked ? '1' : '0';
        } else {
          el.dataset.init = el.value ?? '';
        }
      });
  }

  function resetHeaderForm() {
    document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
      .forEach(el => {
        if (el.closest('.modal')) return;
        const init = el.dataset.init ?? '';
        if (el.type === 'checkbox') {
          el.checked = init === '1' || init.toLowerCase?.() === 'true';
        } else {
          el.value = init;
        }
        if (el.matches('select.lookup-dropdown')) syncLookupLabel(el);
      });
  }

  window.__unsavedChanges = false;
document.addEventListener('input', (e) => {
  if (e.target.closest('.erp-header-form')) window.__unsavedChanges = true;
});
window.addEventListener('pageshow', () => { window.__unsavedChanges = false; });

  const cancelChangesBtn = document.getElementById('btnCancelChanges');
  if (cancelChangesBtn) {
    cancelChangesBtn.addEventListener('click', async () => {
      const wasEdit = !!window.__headerIsEdit;
      if (window.__unsavedChanges) {
        if (!confirm('å–æ¶ˆæœªå„²å­˜çš„è®Šæ›´ä¸¦é‚„åŸè³‡æ–™ï¼Ÿ')) return;
      }

      resetHeaderForm();
      if (typeof window.resetMultiTabEdits === 'function') {
        window.resetMultiTabEdits();
      }
      if (typeof window.__paper3lSubDetailReset === 'function') {
        try { await window.__paper3lSubDetailReset(wasEdit); } catch {}
      }
      if (typeof window.__setHeaderEditMode === 'function') {
        window.__setHeaderEditMode(false);
        if (wasEdit) window.__setHeaderEditMode(true);
      }
      window.__unsavedChanges = false;
    });
  }
</script>

<style>
/* =========================================
   A) å…¨å±€/ç‰ˆé¢
   ========================================= */
body { background: #f7f9fb !important; }
.erp-detail-container { min-height: 100vh; padding: 12px 0; margin-left: 3vw; margin-right: 3vw; }

/* =========================================
   B) Header è¡¨å–® & Tabs
   ========================================= */
.erp-header-form,
.erp-header-form select,
.erp-header-form textarea,
.erp-header-form input { font-size: var(--field-value-size); }

/* å–®é ­/å–®èº«å¯¬åº¦èˆ‡å·¦å´é–“è·ä¸€è‡´ */
.erp-header-form,
.multi-tab-detail {
  padding-left: var(--detail-left-pad);
  max-width: var(--detail-max-width);
  width: 100%;
  box-sizing: border-box;
}
.erp-header-form .row{
  margin-left: 0;
  margin-right: 0;
  --bs-gutter-x: 0;
}

/* å–®é ­/å–®èº«é–“è·ï¼šç¸®å°è¡¨å–®åº•éƒ¨ç•™ç™½ */
.erp-header-form { margin-bottom: 0; }

.erp-header-form select.form-select{
  font-size: 1em !important; height: 100% !important; min-height: 22px !important; line-height: 1.2 !important;
  padding: 2px 30px 2px 6px !important; appearance: none; -webkit-appearance: none; -moz-appearance: none;
  background-image: url('data:image/svg+xml;utf8,<svg width="11" height="11" fill="gray" xmlns="http://www.w3.org/2000/svg"><path d="M2 4.5l3.5 3.5L9 4.5" stroke="gray" stroke-width="2" fill="none" stroke-linecap="round"/></svg>');
  background-repeat: no-repeat; background-position: right 10px center; background-size: 14px 14px; box-shadow: none !important; border-radius: 0 !important;
  margin: 0 !important;
}
.erp-header-form .form-check{
  padding-left: 0 !important;
  min-height: 0 !important;
}
.erp-header-form input[type="checkbox"],
.erp-header-form .form-check-input{
  width: 18px !important;
  height: 18px !important;
  min-width: 18px !important;
  min-height: 18px !important;
  max-width: 18px !important;
  max-height: 18px !important;
  line-height: 18px !important;
  display: inline-block !important;
  vertical-align: middle !important;
  box-sizing: border-box !important;
  margin: 0 !important;
  padding: 0 !important;
  border: 1px solid #6c7a90 !important;
  border-radius: 2px !important;
  background-color: #fff !important;
  appearance: none !important;
  -webkit-appearance: none !important;
  -moz-appearance: none !important;
}
.erp-header-form input[type="checkbox"]:checked,
.erp-header-form .form-check-input:checked{
  background-color: #2c3e50 !important;
  border-color: #2c3e50 !important;
  background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'><path d='M2.2 6.3l2.2 2.2 5.4-5.4' stroke='white' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg>") !important;
  background-repeat: no-repeat !important;
  background-position: center !important;
  background-size: 10px 10px !important;
}
.header-fields-tab{
  position: relative;
  min-height: 72px;
  width: 100%;
  box-sizing: border-box;
  padding-top: 6px;
  padding-bottom: 2px;
  margin-bottom: .25rem !important;
  background: #eef2f9 !important; box-shadow: 0 2px 6px rgba(0,0,0,0.04);
}
.drop-hover{ background-color:#cce5ff !important; border-radius:4px; }

.erp-header-form .nav-tabs .nav-link{ border-radius:8px 8px 0 0 !important; padding:var(--tab-pad-y) var(--tab-pad-x); font-size:var(--field-label-size); font-weight:500; color:#235eb8; }
.erp-header-form .nav-tabs .nav-link.active{
  background:#fff; color:#124d8b; border-color:#bdd2f7 #bdd2f7 #fff #bdd2f7 !important; box-shadow:0 2px 6px 0 #e4ecf7; font-weight:bold;
}

.top-toolbar{
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  width: 100%;
  padding-left: var(--detail-left-pad);
  margin-bottom: 14px;
  border-radius: 10px;
  transition: background-color 0.2s ease;
}
.top-toolbar .toolbar-icon-row{
  display: flex;
  gap: 4px;
  align-items: center;
}
.top-toolbar .toolbar-icon-row #btnPrev{
  margin-left: 16px;
}
.top-toolbar .toolbar-main{
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: nowrap;
  flex: 1 1 0;
  min-width: 0;
}
.top-toolbar .toolbar-main > div{
  flex: 1 1 auto;
  min-width: 0;
}
.top-toolbar .toolbar-btn{
  font-size: var(--top-toolbar-font-size);
  height: var(--top-toolbar-btn-height);
  min-height: var(--top-toolbar-btn-height);
  padding: 0 12px;
  line-height: 1;
}
.top-toolbar .toolbar-btn-icon{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: var(--top-toolbar-btn-height);
  min-height: var(--top-toolbar-btn-height);
  padding: 0;
  width: 30px;
  border-radius: 8px;
  font-size: var(--top-toolbar-icon-font-size);
  line-height: 1;
}
.top-toolbar .toolbar-btn-icon .toolbar-icon{
  display: inline-block;
}
.top-toolbar #btnPrev .toolbar-icon,
.top-toolbar #btnNext .toolbar-icon,
.top-toolbar #btnSubDetailDelete .toolbar-icon{
  transform: translateY(-3px);
}
.top-toolbar .toolbar-btn:disabled{
  background: #9aa7bb;
  cursor: not-allowed;
  box-shadow: none;
  opacity: 0.7;
}
.top-toolbar .toolbar-btn-add{
  background: #0e9f4b;
}
.top-toolbar .toolbar-btn-del{
  background: #e04848;
}
.top-toolbar .toolbar-btn-cancel{
  background: #e04848;
}
.top-toolbar .toolbar-btn-check,
.top-toolbar .toolbar-btn-cancel{
  font-size: 18px;
}
.top-toolbar.mode-view,
.top-toolbar.mode-edit{
  background: transparent;
}

.toolbar-count-box{
  display: inline-flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: var(--top-toolbar-btn-height, 36px);
  min-width: 74px;
  padding: 2px 8px;
  border-radius: 6px;
  font-weight: 700;
  line-height: 1.05;
  color: #fff;
  user-select: none;
}
.toolbar-count-box .count-line{
  font-size: 0.75rem;
}
.toolbar-count-box.mode-view{
  background: #1e4db7;
}
.toolbar-count-box.mode-edit{
  background: #f00000;
}

/* draggable æ¬„ä½ï¼ˆæ©«æ’ label + æ§ä»¶ï¼‰ */
.draggable-field{ position:absolute; display:flex; flex-direction:column; box-sizing:border-box; overflow:hidden; background:transparent; border:1px dashed transparent; }
.draggable-field:hover{ border-color:#c7d3e1; }
.draggable-field.inline{ display:flex; flex-direction:row; align-items: center; gap:4px; flex:0 0 auto; min-width:0; max-width:100%; box-sizing:border-box; }
.header-label-item{ position:absolute; display:flex; align-items:center; justify-content:flex-end; text-align:right; font-size:var(--field-label-size); line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding:0 4px 0 2px; z-index:2; }
.field-drag-handle{ position:absolute; left:0; top:0; width:10px; height:100%; cursor:default; background:transparent; z-index:3; }
.draggable-field.inline .field-control{ flex:1 1 auto; height:100%; display:flex; }
.draggable-field.inline textarea,
.draggable-field.inline input,
.draggable-field.inline .form-select{
  flex:1 1 auto; width:100%; height:100%; min-height:22px; min-width:0; max-width:100%; line-height:1.2; resize:none; padding:4px 6px; font-size:var(--field-value-size); border-radius:0 !important; box-sizing:border-box;
  text-align: left;
}
.draggable-field.inline.field-number textarea,
.draggable-field.inline.field-number input,
.draggable-field.inline.field-number .form-select{
  text-align: right !important;
}
.erp-header-form textarea[data-align="right"],
.erp-header-form input[data-align="right"],
.erp-header-form select[data-align="right"]{
  text-align: right !important;
}
.erp-header-form textarea[data-align="center"],
.erp-header-form input[data-align="center"],
.erp-header-form select[data-align="center"]{
  text-align: center !important;
}
.erp-header-form .resizable-input{
  padding: 2px 4px !important;
  resize: none !important;
  overflow: hidden;
  white-space: nowrap;
}
/* æ˜ç´°è¡¨é ­/æ¬„ä½å­—é«”å¤§å°ä¸€è‡´ */
.erp-table th{ font-size: var(--field-label-size); }
.erp-table td{ font-size: var(--field-value-size); }
.draggable-field.inline label{
  white-space: nowrap !important;
  overflow: visible !important;
  text-overflow: clip !important;
  max-width: none !important;
}
.draggable-field.md-selected{
  border-radius: 8px;
  border-color:#5b8def;
  background:rgba(91,141,239,0.08);
}
.erp-header-form .lookup-dropdown.lookup-readonly{
  /* ç€è¦½æ¨¡å¼å…è¨±å±•é–‹ä¸‹æ‹‰ï¼Œä½†ä¸å…è¨±ä¿®æ”¹ï¼šå¤–è§€æ¯”ç…§ disabled çš„ç°åº• */
  background-color: var(--bs-secondary-bg, #e9ecef) !important;
  color: var(--bs-secondary-color, #6c757d) !important;
  opacity: 1; /* é¿å…åƒ disabled ä¸€æ¨£æ•´é«”è®Šæ·¡ */
  cursor: default;
}
.erp-header-form .lookup-dropdown.lookup-readonly:focus{
  border-color: #ced4da;
  box-shadow: none !important;
}
.erp-header-form .lookup-dropdown option,
.erp-header-form .lookup-dropdown optgroup{
  background-color: var(--bs-body-bg, #fff) !important;
  color: var(--bs-body-color, #212529) !important;
}
.erp-header-form .dict-readonly,
.erp-header-form .dict-readonly:focus{
  background-color: var(--bs-secondary-bg, #e9ecef) !important;
  color: var(--bs-secondary-color, #6c757d) !important;
  border-color: #ced4da !important;
  box-shadow: none !important;
  cursor: not-allowed;
}
/* jQuery UI resizableï¼šè®“å³å´æ‹‰å¯¬æŠŠæ‰‹æ›´å¥½æŠ“ */
.draggable-field.ui-resizable .ui-resizable-e{
  position: absolute;
  top: 0; right: 0; width: 10px; height: 100%;
  cursor: ew-resize; background: transparent;
  z-index: 5;
}
.draggable-field.ui-resizable:hover .ui-resizable-e{
  background: rgba(32,86,172,0.10);
}
.draggable-field.ui-resizable .ui-resizable-se{
  position: absolute;
  right: 0; bottom: 0; width: 14px; height: 14px;
  cursor: se-resize; background: transparent;
  z-index: 5;
}
.field-drag-handle,
.draggable-field.ui-resizable .ui-resizable-e,
.draggable-field.ui-resizable .ui-resizable-se{
  display: none;
}
.layout-edit-enabled .field-drag-handle,
.layout-edit-enabled .draggable-field.ui-resizable .ui-resizable-e,
.layout-edit-enabled .draggable-field.ui-resizable .ui-resizable-se{
  display: block;
}
.layout-edit-enabled .field-drag-handle{
  cursor: move;
}

/* =========================================
   D) å…¶å®ƒ
   ========================================= */
.highlight-red { color:#e53b2d; font-weight:700; }
.highlight-blue{ color:#2564b3; font-weight:700; }

/* --- Action Rail åŸºç¤ç‰ˆä½ & å…§å®¹å³ç§»ï¼ˆå›ºå®šåœ¨æ¨£æ¿ï¼‰--- */
/* æ›´æ–°æ™‚é–“: 2025-03-20 13:45 */
:root{
  --fab-left: 20px;
  --fab-width: 120px;
  --fab-gap: 14px;
  --rail-reserve: 146px;
  --action-rail-top: 64px;
}

.action-rail{
  position: fixed;
  left: var(--fab-left);
  top: var(--action-rail-top);
  box-sizing: border-box;
  max-height: calc(100vh - (var(--action-rail-top) + 20px)); /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé¿å…è¶…å‡ºè¦–çª— */
  display: flex;
  flex-direction: column;
  gap: 2px;
  z-index: 900;
  overflow-y: auto;
  overflow-x: visible;
}

body.with-toolbar .action-rail{
  top: calc(var(--action-rail-top) + var(--app-toolbar-height, 0px));
  max-height: calc(100vh - (var(--action-rail-top) + 20px + var(--app-toolbar-height, 0px)));
}

/* action-rail çš„æ²è»¸æ¨£å¼ - ä½¿ç”¨ overlay æ¨¡å¼ä¸ä½”ç©ºé–“ */
.action-rail::-webkit-scrollbar {
  width: 8px;
}

.action-rail::-webkit-scrollbar-track {
  background: transparent;
}

.action-rail::-webkit-scrollbar-thumb {
  background: rgba(0, 0, 0, 0.25);
  border-radius: 4px;
  border: 2px solid transparent;
  background-clip: padding-box;
}

.action-rail::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 0, 0, 0.4);
  background-clip: padding-box;
}

/* æŒ‰éˆ•çš„å…±åŒå¤–è§€ï¼ˆä¿æŒåœ¨æ¨£æ¿ï¼Œè®“æ‰€æœ‰é é¢ä¸€è‡´ï¼‰ */
.fab{
  position: relative;
  width: var(--fab-width);
  min-width: 0;
  padding: 6px 8px;
  font-size: .92rem;
  letter-spacing: 0;
  white-space: normal;
  word-break: break-word;
  background:#f8f9fb;
  color:#1f5fbf;
  font-weight:600;
  border-radius:10px;
  cursor:pointer;
  box-shadow:0 2px 8px rgba(20,40,80,.12);
  border:1px solid #cfd7e6;
}
.fab:hover{
  background:#e9f1ff;
  border-color:#9fbaf0;
}
.fab:focus-visible{
  outline:2px solid #9fbaf0;
  outline-offset:2px;
}
.fab-red{ background:#dc3545; color:#fff; }
.fab-blue{ background:#3583dc; color:#fff; }
</style>
