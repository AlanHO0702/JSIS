@model dynamic
@using PcbErpApi.Helpers
@using System.Text.Json
@{
    // å–®é ­æ¬„ä½
    var headerFields = Model.HeaderTableFields; // å¯è¦–æ¬„ä½
    var headerData = Model.HeaderData; // å–®é ­è³‡æ–™ (Dictionary<string, object> æˆ–ä½ çš„å–®é ­Model)
    var headerFieldsList = ((IEnumerable<TableFieldViewModel>)Model.HeaderTableFields).ToList();
    var addApiUrl = ViewData["AddApiUrl"]?.ToString() ?? "";
    var detailRouteTemplate = ViewData["SubRouteTemplate"]?.ToString() ?? "";
    var tableName = ViewData["DictTableName"]?.ToString() ?? "";
    var keyFieldName = ViewData["KeyFieldName"]?.ToString() ?? "PaperNum";
    var queryRedirectUrl = ViewData["QueryRedirectUrl"]?.ToString() ?? "";
    var DeleteApiUrl = ViewData["DeleteApiUrl"]?.ToString() ?? "";

    var groupedTabs = headerFieldsList
        .Where(f => (f.iShowWhere ?? 1) > 0) // âœ éæ¿¾æ‰ iShowWhere ç‚º 0 çš„æ¬„ä½
        .GroupBy(f => f.iShowWhere ?? 1)
        .OrderBy(g => g.Key)
        .ToDictionary(g => g.Key, g => g.ToList());

    var lookupMap = ViewData["LookupDisplayMap"] as Dictionary<string, Dictionary<string, string>>;

    var PaperNum = headerData.ContainsKey("PaperNum") ? headerData["PaperNum"]?.ToString() ?? "" : "";

    var headerLookupMap = ViewData["HeaderLookupMap"] as Dictionary<string, string>;

    string actionPartial = (ViewData["ActionRailPartial"] as string)
                           ?? "~/Pages/Shared/_ActionRail.Empty.cshtml";

    // âœ… å–å¾—å–®é ­è¡¨åç¨±å’Œ Finished ç‹€æ…‹ï¼ˆé‡å° FmedIssueMainï¼‰
    string headerTableName = Model.HeaderTableName ?? "";
    int? finishedValue = null;
    if (headerTableName == "FMEdIssueMain" && headerData != null && headerData.ContainsKey("Finished"))
    {
        var finishedObj = headerData["Finished"];
        if (finishedObj != null)
        {
            int finishedTemp;
            if (int.TryParse(finishedObj.ToString(), out finishedTemp))
            {
                finishedValue = finishedTemp;
            }
        }
    }
}

<script>
    // âœ… å°‡ Finished ç‹€æ…‹æš´éœ²çµ¦å‰ç«¯ JavaScript
    window._headerTableName = '@headerTableName';
    window._finishedStatus = @(finishedValue?.ToString() ?? "null");
    window._paperNum = '@PaperNum';
</script>

<div id="topToolbar" class="d-flex align-items-center mb-4" style="gap:12px;">
    <div class="btn-group" role="group" aria-label="row-nav" style="gap:6px;">
        <button type="button" class="btn btn-outline-primary" id="btnPrev">ä¸Šä¸€ç­†</button>
        <button type="button" class="btn btn-outline-primary" id="btnNext">ä¸‹ä¸€ç­†</button>
    </div>
    <button type="submit" class="btn toolbar-btn" form="orderHeaderForm">
        å„²å­˜
    </button>
    <div class="ms-2">
        @await Html.PartialAsync("_TableToolbar", new TableToolbarModel {
            SearchBtnId = "btnSubSearch",
            AddBtnId = "btnSubAddNew",
            DeleteBtnId = "btnSubBatchDelete",
            QueryFields = ViewData["QueryFields"] as List<QueryFieldViewModel>,
            ModalId = "searchModal",
            ReportSpName = ViewData["ReportSpName"]?.ToString() ?? ""   // ğŸ‘ˆ å¾å¤–å±¤å†å‚³é€²ä¾†
        })
    </div>
</div>

<div class="action-rail">
    @await Html.PartialAsync(actionPartial, (object)Model)
</div>

<!-- å–®é ­å¯ç·¨è¼¯è¡¨å–® -->
<form id="orderHeaderForm" class="erp-header-form">
    <div class="row">
        <!-- âœ… Tabs åˆ‡æ›åˆ— -->
        <ul class="nav nav-tabs" id="headerTabs" role="tablist">
            @foreach (var tab in groupedTabs.Keys)
            {
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(tab == 1 ? "active" : "")"
                            id="tab-@tab-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#tab-@tab"
                            type="button" role="tab">
                        åˆ†é  @tab
                    </button>
                </li>
            }
        </ul>

        <!-- âœ… Tabs å°æ‡‰å…§å®¹ -->
        <div class="tab-content" id="headerTabContent">
            @foreach (var tab in groupedTabs)
            {
                <div class="tab-pane fade @(tab.Key == 1 ? "show active" : "")"
                    id="tab-@tab.Key" role="tabpanel">
                    <ul class="list-unstyled header-fields-tab"
                        data-tab-index="@tab.Key"
                        style="position: relative">
                        @foreach (var field in tab.Value)
                        {
                            object rawValue = null;
                            headerData?.TryGetValue(field.FieldName, out rawValue);
                            string displayText = "";

                            // 1. lookup å„ªå…ˆé¡¯ç¤º
                            if (headerLookupMap != null && headerLookupMap.TryGetValue(field.FieldName, out var lookupVal))
                            {
                                displayText = lookupVal;
                            }
                            else if (rawValue != null)
                            {
                                //è¼¸å‡ºæ ¼å¼ç”¨Helperè½‰å‹
                                displayText = FormatHelper.FormatValue(rawValue, field.DataType, field.FormatStr);

                                // âœ… é€™è£¡è£œï¼šæ•¸å€¼å‹è‹¥ç‚ºç©ºï¼Œé¡¯ç¤º 0
                                if (string.IsNullOrWhiteSpace(displayText) && field.DataType?.ToLower() == "number")
                                {
                                    displayText = "0";
                                }
                            }

                            var top = field.iFieldTop ?? 0;
                            var left = field.iFieldLeft ?? 0;
                            var width = field.iFieldWidth ?? 160;
                            var height = field.iFieldHeight ?? 44;

                            var liClass = "draggable-field inline"; // æ°¸é æ©«æ’


                            // åˆ¤æ–·æœ‰ lookup table è¨­å®š
                            if (!string.IsNullOrWhiteSpace(field.LookupTable) &&
                                !string.IsNullOrWhiteSpace(field.LookupKeyField) &&
                                !string.IsNullOrWhiteSpace(field.LookupResultField))
                            {
                                // ä¸‹æ‹‰é¸å–®å…ƒä»¶ï¼ˆç”¨ selectï¼‰
                                <li class="@liClass"
                                    data-field="@field.FieldName"
                                    data-tab="@tab.Key"
                                    style="top:@(field.iFieldTop ?? 0)px; left:@(field.iFieldLeft ?? 0)px; width:@(field.iFieldWidth ?? 160)px; height:@(field.iFieldHeight ?? 44)px;">
                                    <label>@field.DisplayLabel</label>
                                    <select class="form-select lookup-dropdown"
                                            name="@field.FieldName"
                                            data-table="@field.LookupTable"
                                            data-key="@field.LookupKeyField"
                                            data-result="@field.LookupResultField.Replace(" ", "")"
                                            data-selected="@rawValue">
                                        <option value="">--è«‹é¸æ“‡--</option>
                                    </select>
                                </li>
                            }
                            else
                            {
                                <li class="@liClass"
                                    data-field="@field.FieldName"
                                    data-tab="@tab.Key"
                                    style="top:@(top)px; left:@(left)px; width:@(width)px; height:@(height)px;">
                                    <label>@field.DisplayLabel</label>
                                    <textarea class="form-control resizable-input"
                                            name="@field.FieldName">@displayText</textarea>
                                </li>
                            }
                        }
                    </ul>
                </div>
            }
        </div>
    </div>
</form>

<script>window._dictTableName = "@(ViewData["DictTableName"] ?? Model.TableName)";</script>

<!-- SweetAlert2 foræç¤º -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="~/js/toolbarHandler.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />

<script>
// ============================
// 0) é é¢å¸¸æ•¸ï¼Razor æ³¨å…¥
// ============================
const PAGE = {
  paperNum: "@PaperNum",
  keyField: "PaperNum",
  headerTable: ("@(Model.HeaderTableName ?? "")".trim() || "").toLowerCase(),
  detailTable: "@(tableName ?? "")".trim(),
  queryRedirectUrl: "@(ViewData["QueryRedirectUrl"])",
  addApiUrl: "@addApiUrl",
  deleteApiUrl: "@DeleteApiUrl",
  detailRouteTemplate: "@detailRouteTemplate",
  headerFields: @Html.Raw(JsonSerializer.Serialize(headerFieldsList)),
};

// æ”¾åœ¨æœ€å‰é¢ï¼ˆè¾­å…¸é–‹é—œï¼‰
window.__DICT_OPEN__ = false;

// è®“å…¶å®ƒå·¥å…·å¯ä»¥å–åˆ°ç›®å‰å–®è™Ÿ
window.selectedPaperNum = '@(Model.HeaderData["PaperNum"] ?? "")';

const PAGE_PAPER_NUM = ("@PaperNum" || "").trim();
const KEY_FIELD = ("@(keyFieldName ?? "PaperNum")" || "PaperNum").trim();

const backToMainTpl = (PAGE.queryRedirectUrl || '').trim()
  ? PAGE.queryRedirectUrl.replace(/\/$/, '') + '/{0}'
  : '';
const subTpl = (PAGE.detailRouteTemplate || '').replace(/\{PaperNum\}/gi, '{0}');
const finalSwitchTpl = backToMainTpl || subTpl;

console.debug('[Switch template]', finalSwitchTpl);
console.debug('[Sub template for new]', subTpl);

new ToolbarHandler({
  searchBtnId: "btnSubSearch",
  addBtnId: "btnSubAddNew",
  deleteBtnId: "btnSubBatchDelete",
  getSelectedId: () => (PAGE.paperNum || window.selectedPaperNum || ''),
  modalId: "searchModal",
  formId: "searchForm",
  addApiUrl: PAGE.addApiUrl,
  deleteApiUrlFn: id => `/api/${PAGE.deleteApiUrl}/${id || PAGE.paperNum}`,
  detailRouteTemplate: subTpl,  // ä½¿ç”¨å–®èº«é è·¯å¾‘ï¼Œæ–°å¢å¾Œè·³è½‰åˆ°å–®èº«é 
  tableName: "@tableName",
  renderTable: null,
  renderPagination: null,
  renderOrderCount: null,
  restoreSearchForm: null,
  queryRedirectUrl: PAGE.queryRedirectUrl
});

// å–®èº«é  â†’ ä¸»é  åˆ‡æ›
(function hookToggleBackToMain() {
  const rawBtn = document.getElementById('btnToggle') ||
    Array.from(document.querySelectorAll('button, a'))
      .find(el => (el.textContent || '').trim() === 'åˆ‡æ›');
  if (!rawBtn) return;
  const btn = rawBtn.cloneNode(true);
  rawBtn.replaceWith(btn);
  btn.addEventListener('click', (e) => {
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    const base = ("@queryRedirectUrl" || '').trim().replace(/\/$/, '');
    if (!base) { Swal.fire({ icon: 'error', title: 'æœªæä¾›è¿”å›ä¸»é è·¯å¾‘' }); return; }
    const id = (PAGE_PAPER_NUM || window.selectedPaperNum || '').trim();
    const sep = base.includes('?') ? '&' : '?';
    const url = id ? `${base}${sep}${encodeURIComponent(KEY_FIELD)}=${encodeURIComponent(id)}` : base;
    location.href = url;
  }, { capture: true });
})();

// ============================
// å…±ç”¨å°å·¥å…·ï¼ˆæ•¸å€¼è™•ç†ã€å­—ä¸²åŒ–ï¼‰
// ============================
function normalizeNumberFields(obj, fieldDefs) {
  (fieldDefs || []).forEach(f => {
    if ((f.DataType || '').toLowerCase() === 'number') {
      const k = f.FieldName;
      if (obj[k] != null) obj[k] = obj[k].toString().replace(/,/g, '');
    }
  });
}

function withTemporarilyEnabled(formEl, callback) {
  const disabledEls = Array.from(formEl.querySelectorAll('input:disabled, select:disabled, textarea:disabled'));
  disabledEls.forEach(el => el.disabled = false);
  try { return callback(); } finally { disabledEls.forEach(el => el.disabled = true); }
}

function collectHeaderFormData() {
  const form = document.getElementById('orderHeaderForm');
  return withTemporarilyEnabled(form, () => Object.fromEntries(new FormData(form)));
}

function getPaperNum() {
  const p1 = (PAGE.paperNum || window.selectedPaperNum || '').trim();
  if (p1) return p1;
  const header = collectHeaderFormData();
  return (header.PaperNum || header.papernum || '').toString().trim();
}

// ============================
// å„²å­˜å–®é ­
// ============================
document.getElementById('orderHeaderForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const header = collectHeaderFormData();
  normalizeNumberFields(header, PAGE.headerFields);

  const payload = { ...header, __headerTable: PAGE.headerTable };

  try {
    const resp = await fetch('/api/OrderHeaderApi/SaveOrderHeader', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
    });
    if (resp.ok) {
      const result = await resp.json();
      if (result.updated) {
        await Swal.fire({ icon: 'success', title: 'å„²å­˜æˆåŠŸï¼', timer: 1000, showConfirmButton: false });
        localStorage.setItem("afterSave", "1"); location.reload();
      } else {
        Swal.fire({ icon: 'info', title: 'æ²’æœ‰è³‡æ–™ç•°å‹•' });
      }
    } else {
      let msg = 'å„²å­˜å¤±æ•—'; try { const txt = await resp.text(); msg = txt || msg; } catch {}
      Swal.fire({ icon: 'error', title: msg });
    }
  } catch (err) { Swal.fire({ icon: 'error', title: 'ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤' }); }
});

// ============================
// æª¢è¦–/ç·¨è¼¯æ¨¡å¼åˆ‡æ›
// ============================
const editBtn = document.getElementById('btnViewEditToggle');
if (editBtn) {
  let isEdit = false;
  const getHeaderValueByLabel = (labelText) => {
    const $li = $('.draggable-field').filter(function () {
      return $(this).children('label').first().text().trim() === labelText;
    }).first();
    if (!$li.length) return null;
    const $ctrl = $li.find('select, input, textarea').first();
    if (!$ctrl.length) return null;
    if ($ctrl.is('select')) return $ctrl.find('option:selected').text().trim();
    return ($ctrl.val() || '').toString().trim();
  };

  editBtn.addEventListener('click', async function () {
    // âœ… é‡å° FMEdIssueMain ä½¿ç”¨ Finished æ¬„ä½æª¢æŸ¥ï¼ˆæ•¸å­—ï¼‰
    const headerTableName = window._headerTableName;
    console.log('ğŸ” [ä¿®æ”¹æŒ‰éˆ•] headerTableName:', headerTableName);
    console.log('ğŸ” [ä¿®æ”¹æŒ‰éˆ•] finishedStatus:', window._finishedStatus);

    // â­ å¦‚æœæ˜¯å¾ã€Œç·¨è¼¯æ¨¡å¼ã€åˆ‡å›ã€Œæª¢è¦–æ¨¡å¼ã€ï¼ˆä¿ç•™ï¼‰ï¼Œå‰‡å„²å­˜å–®èº«è³‡æ–™
    if (isEdit) {
      console.log('ğŸ’¾ [ä¿ç•™æŒ‰éˆ•] é–‹å§‹å„²å­˜å–®èº«è³‡æ–™...');

      // â­ é‡å° FMEdIssueMainï¼Œåœ¨å„²å­˜å‰é‡æ–°æª¢æŸ¥è³‡æ–™åº«çš„å¯¦éš›ç‹€æ…‹
      if (headerTableName === 'FMEdIssueMain') {
        try {
          const paperNum = window._paperNum || PAGE.paperNum;
          const resp = await fetch(`/api/FMEdIssueMain/${encodeURIComponent(paperNum)}`);
          if (resp.ok) {
            const mainData = await resp.json();
            const currentFinished = mainData.Finished;

            if (currentFinished !== 0 && currentFinished !== null) {
              const statusMap = {0:'ä½œæ¥­ä¸­', 1:'å·²ç¢ºèª', 2:'ä½œå»¢ä¸­', 4:'å·²çµæ¡ˆ'};
              const statusName = statusMap[currentFinished] || `ä»£ç¢¼:${currentFinished}`;

              console.log('ğŸš« [ä¿ç•™] è³‡æ–™åº«ç‹€æ…‹å·²è®Šæ›´ï¼Œç„¡æ³•å„²å­˜');
              await Swal.fire({
                icon: 'warning',
                title: 'å–®æ“šç‹€æ…‹å·²è®Šæ›´',
                html: `æ­¤å–®æ“šç‹€æ…‹å·²è®Šæ›´ç‚ºã€Œ<b>${statusName}</b>ã€ï¼Œç„¡æ³•å„²å­˜ä¿®æ”¹ã€‚<br>è«‹é‡æ–°æ•´ç†é é¢ä»¥å–å¾—æœ€æ–°ç‹€æ…‹ã€‚`,
                confirmButtonText: 'é‡æ–°æ•´ç†é é¢',
                showCancelButton: true,
                cancelButtonText: 'å–æ¶ˆ'
              }).then((result) => {
                if (result.isConfirmed) {
                  location.reload();
                }
              });
              return;
            }
          }
        } catch (err) {
          console.error('âŒ [ä¿ç•™] æª¢æŸ¥ç‹€æ…‹å¤±æ•—:', err);
          // ç¹¼çºŒåŸ·è¡Œå„²å­˜ï¼ˆè®“è§¸ç™¼å™¨æ±ºå®šæ˜¯å¦å…è¨±ï¼‰
        }
      }

      // æ”¶é›†æ‰€æœ‰å·²ä¿®æ”¹çš„åˆ—è³‡æ–™ï¼ˆåƒ…é™ç•¶å‰å–®è™Ÿï¼‰
      const currentPaperNum = window._paperNum || PAGE.paperNum;
      console.log('ğŸ” [ä¿ç•™] ç•¶å‰å–®è™Ÿ:', currentPaperNum);

      const allChanges = [];
      const tables = document.querySelectorAll('.multi-tab-detail .table-container');

      for (const container of tables) {
        const tableName = container.dataset.dictTable;
        if (!tableName) continue;

        const tbody = container.querySelector('tbody');
        if (!tbody) continue;

        const rows = tbody.querySelectorAll('tr[data-state="modified"], tr[data-state="added"]');
        const changes = [];

        for (const row of rows) {
          // â­ é—œéµä¿®æ­£ï¼šåªè™•ç†ç•¶å‰å–®è™Ÿçš„è³‡æ–™
          const rowPaperNum = row.dataset.paperNum;
          console.log(`ğŸ” [ä¿ç•™] æª¢æŸ¥åˆ—: rowPaperNum="${rowPaperNum}", currentPaperNum="${currentPaperNum}", state="${row.dataset.state}"`);

          if (rowPaperNum && rowPaperNum !== currentPaperNum) {
            console.log(`âš ï¸ [ä¿ç•™] è·³éä¸åŒå–®è™Ÿçš„åˆ—: ${rowPaperNum} (ç•¶å‰: ${currentPaperNum})`);
            continue;
          }

          const rowData = {};
          const inputs = row.querySelectorAll('.cell-edit');

          for (const inp of inputs) {
            const fieldName = inp.dataset.field || inp.name;
            if (fieldName) {
              // â­ æ™ºèƒ½å‹åˆ¥è½‰æ›ï¼šæ•¸å­—æ¬„ä½è½‰æˆæ•¸å­—ï¼Œç©ºå€¼è½‰æˆ null
              let value = inp.value?.trim();

              // ç©ºå€¼çµ±ä¸€è½‰æˆ nullï¼Œè®“å¾Œç«¯è™•ç†æˆ DBNull.Value
              if (value === '' || value === undefined || value === null) {
                value = null;
              } else {
                // å¦‚æœæ¬„ä½åç¨±åŒ…å«å¸¸è¦‹çš„æ•¸å­—æ¬„ä½é—œéµå­—ï¼Œå˜—è©¦è½‰æˆæ•¸å­—
                const numberFieldPatterns = /Qnty|Item|Serial|Amount|Price|Qty|Num|Count|Weight|Rate|Pop|Pcs$/i;

                if (numberFieldPatterns.test(fieldName)) {
                  // ç§»é™¤åƒåˆ†ä½é€—è™Ÿ
                  const cleanValue = value.replace(/,/g, '');
                  const numValue = Number(cleanValue);

                  // åªæœ‰åœ¨æ˜¯æœ‰æ•ˆæ•¸å­—æ™‚æ‰è½‰æ›ï¼Œå¦å‰‡ä¿æŒåŸå€¼ï¼ˆè®“å¾Œç«¯å ±éŒ¯ï¼‰
                  if (!isNaN(numValue)) {
                    value = numValue;
                  }
                }
              }

              rowData[fieldName] = value;
            }
          }

          // â­ ç¢ºä¿ PaperNum å’Œ Item ä¸€å®šå­˜åœ¨ï¼ˆå¾ dataset å–å¾—ä¸»éµå€¼ï¼‰
          if (!rowData.PaperNum && rowPaperNum) {
            rowData.PaperNum = rowPaperNum;
            console.log(`ğŸ”‘ [ä¿ç•™] æ˜ç¢ºåŠ å…¥ PaperNum: ${rowPaperNum}`);
          }

          const rowItem = row.dataset.item;
          if (!rowData.Item && rowItem) {
            // Item éœ€è¦è½‰æˆæ•¸å­—
            const itemNum = Number(rowItem);
            if (!isNaN(itemNum)) {
              rowData.Item = itemNum;
              console.log(`ğŸ”‘ [ä¿ç•™] æ˜ç¢ºåŠ å…¥ Item: ${itemNum}`);
            }
          }

          // ç¢ºä¿æœ‰è³‡æ–™å†åŠ å…¥ï¼Œä¸¦ä¸”é¡¯ç¤ºå®Œæ•´çš„ rowData å…§å®¹
          if (Object.keys(rowData).length > 0) {
            console.log(`ğŸ“¦ [ä¿ç•™] æ”¶é›†çš„å®Œæ•´åˆ—è³‡æ–™:`, JSON.stringify(rowData, null, 2));
            changes.push(rowData);
          }
        }

        if (changes.length > 0) {
          console.log(`ğŸ“ [ä¿ç•™] ${tableName} æ”¶é›†åˆ° ${changes.length} ç­†è®Šæ›´`);
          allChanges.push({ tableName, changes });
        }
      }

      // å¦‚æœæœ‰è®Šæ›´ï¼Œå‘¼å«å„²å­˜ API
      if (allChanges.length > 0) {
        try {
          let saveSuccess = true;
          let saveErrors = [];

          for (const { tableName, changes } of allChanges) {
            console.log(`ğŸ’¾ [ä¿ç•™] å„²å­˜ ${tableName}:`, changes);

            // å–å¾—ä¸»éµæ¬„ä½ï¼ˆå¾ç¬¬ä¸€ç­†è³‡æ–™æ¨æ–·ï¼‰
            const firstRow = changes[0];
            const keyFields = [];
            if (firstRow.PaperNum !== undefined) keyFields.push('PaperNum');
            if (firstRow.Item !== undefined) keyFields.push('Item');

            const payload = {
              TableName: tableName,
              Data: changes,
              KeyFields: keyFields
            };

            const resp = await fetch('/api/CommonTable/SaveTableChanges', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!resp.ok) {
              saveSuccess = false;
              const errorText = await resp.text();
              saveErrors.push(`${tableName}: ${errorText}`);
              console.error(`âŒ [ä¿ç•™] ${tableName} å„²å­˜å¤±æ•—:`, errorText);
            } else {
              const result = await resp.json();
              console.log(`âœ… [ä¿ç•™] ${tableName} å„²å­˜æˆåŠŸ:`, result);

              // å„²å­˜æˆåŠŸå¾Œï¼Œå°‡æ‰€æœ‰å·²ä¿®æ”¹åˆ—çš„ç‹€æ…‹æ”¹ç‚º unchangedï¼Œä¸¦åŒæ­¥æ›´æ–° view é¡¯ç¤ºå€¼
              const container = document.querySelector(`.table-container[data-dict-table="${tableName}"]`);
              if (container) {
                container.querySelectorAll('tr[data-state="modified"], tr[data-state="added"]').forEach(tr => {
                  tr.dataset.state = 'unchanged';

                  // â­ åŒæ­¥æ›´æ–° view é¡¯ç¤ºå€¼ï¼šå°‡ input çš„å€¼è¤‡è£½åˆ°å°æ‡‰çš„ cell-view
                  tr.querySelectorAll('.cell-edit').forEach(input => {
                    const fieldName = input.dataset.field || input.name;
                    if (!fieldName) return;

                    // æ‰¾åˆ°åŒä¸€å€‹ td å…§çš„ cell-view
                    const td = input.closest('td');
                    if (td) {
                      const viewSpan = td.querySelector('.cell-view');
                      if (viewSpan) {
                        // æ›´æ–°é¡¯ç¤ºå€¼ï¼ˆä¿ç•™åƒåˆ†ä½æ ¼å¼åŒ–ï¼Œå¦‚æœæœ‰çš„è©±ï¼‰
                        let displayValue = input.value?.trim() || '';

                        // å¦‚æœæ˜¯æ•¸å­—æ¬„ä½ï¼Œå¯ä»¥é¸æ“‡æ€§åŠ ä¸Šåƒåˆ†ä½
                        const numberFieldPatterns = /Qnty|Amount|Price|Qty|Count|Weight$/i;
                        if (numberFieldPatterns.test(fieldName) && displayValue) {
                          const num = parseFloat(displayValue.replace(/,/g, ''));
                          if (!isNaN(num)) {
                            displayValue = num.toLocaleString('en-US', {
                              minimumFractionDigits: 0,
                              maximumFractionDigits: 4
                            });
                          }
                        }

                        viewSpan.textContent = displayValue;
                        console.log(`ğŸ”„ [ä¿ç•™] åŒæ­¥æ›´æ–° ${fieldName}: "${displayValue}"`);
                      }
                    }
                  });
                });
              }
            }
          }

          if (saveSuccess) {
            await Swal.fire({
              icon: 'success',
              title: 'å„²å­˜æˆåŠŸ',
              text: 'å–®èº«è³‡æ–™å·²æˆåŠŸå„²å­˜',
              timer: 1500,
              showConfirmButton: false
            });
          } else {
            await Swal.fire({
              icon: 'error',
              title: 'å„²å­˜å¤±æ•—',
              html: saveErrors.join('<br>')
            });
            return; // å„²å­˜å¤±æ•—ï¼Œä¸åˆ‡æ›æ¨¡å¼
          }
        } catch (err) {
          console.error('âŒ [ä¿ç•™] å„²å­˜éŒ¯èª¤:', err);
          await Swal.fire({
            icon: 'error',
            title: 'å„²å­˜éŒ¯èª¤',
            text: String(err)
          });
          return; // ç™¼ç”ŸéŒ¯èª¤ï¼Œä¸åˆ‡æ›æ¨¡å¼
        }
      } else {
        console.log('â„¹ï¸ [ä¿ç•™] æ²’æœ‰è®Šæ›´éœ€è¦å„²å­˜');
      }
    }

    // â­ å¦‚æœæ˜¯å¾ã€Œæª¢è¦–æ¨¡å¼ã€åˆ‡åˆ°ã€Œç·¨è¼¯æ¨¡å¼ã€ï¼ˆä¿®æ”¹ï¼‰ï¼Œå…ˆæª¢æŸ¥ç‹€æ…‹
    if (!isEdit) {
      if (headerTableName === 'FMEdIssueMain') {
        // ä½¿ç”¨å¾Œç«¯å‚³éçš„ Finished ç‹€æ…‹
        const finished = window._finishedStatus;

        // ç‹€æ…‹å°ç…§è¡¨
        const statusMap = {0:'ä½œæ¥­ä¸­', 1:'å·²ç¢ºèª', 2:'ä½œå»¢ä¸­', 4:'å·²çµæ¡ˆ'};
        const statusName = statusMap[finished] || `ä»£ç¢¼:${finished}`;

        // å¦‚æœä¸æ˜¯ä½œæ¥­ä¸­ (Finished != 0)ï¼Œé˜»æ­¢ä¿®æ”¹
        if (finished !== 0 && finished !== null) {
          console.log('ğŸš« [ä¿®æ”¹æŒ‰éˆ•] ç‹€æ…‹ä¸æ˜¯ä½œæ¥­ä¸­ï¼Œé˜»æ­¢ä¿®æ”¹');
          Swal.fire({
            icon: 'warning',
            title: 'ç„¡æ³•ä¿®æ”¹',
            html: `å–®æ“šç‹€æ…‹ï¼š<b>${statusName}</b><br>åªæœ‰ã€Œä½œæ¥­ä¸­ã€çš„å–®æ“šæ‰èƒ½é€²è¡Œä¿®æ”¹ã€‚`
          });
          return;
        }
        console.log('âœ… [ä¿®æ”¹æŒ‰éˆ•] ç‹€æ…‹æ˜¯ä½œæ¥­ä¸­ï¼Œå…è¨±ä¿®æ”¹');
      } else {
        // ä¸€èˆ¬å–®æ“šä½¿ç”¨åŸæœ¬çš„ã€Œå–®æ“šç‹€æ…‹ã€æ–‡å­—æª¢æŸ¥
        const status = getHeaderValueByLabel('å–®æ“šç‹€æ…‹') || '';
        if (window.BLOCK_STATUSES && window.BLOCK_STATUSES.includes(status)) {
          Swal.fire({ icon: 'warning', title: 'ç„¡æ³•ä¿®æ”¹', text: `æ­¤å–®æ“šç‹€æ…‹ç‚ºã€Œ${status}ã€ï¼Œä¸å¯é€²è¡Œä¿®æ”¹ã€‚`});
          return;
        }
      }
    }

    isEdit = !isEdit; editBtn.textContent = isEdit ? 'ä¿ç•™' : 'ä¿®æ”¹';

    // åˆ‡æ›å–®é ­æ¬„ä½çš„ disabled ç‹€æ…‹
    document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
      .forEach(el => { if (!el.closest('.modal')) el.disabled = !isEdit; });

    // âœ… åˆ‡æ›å–®èº«è¡¨æ ¼çš„é¡¯ç¤º/ç·¨è¼¯æ¨¡å¼ï¼ˆé‡å° _MultiTabDetail.cshtmlï¼‰
    document.querySelectorAll('.multi-tab-detail .erp-table .cell-view')
      .forEach(el => el.classList.toggle('d-none', isEdit));
    document.querySelectorAll('.multi-tab-detail .erp-table .cell-edit')
      .forEach(el => el.classList.toggle('d-none', !isEdit));

    // ç¶å®š input äº‹ä»¶ï¼Œæ¨™è¨˜åˆ—ç‚ºå·²ä¿®æ”¹
    if (isEdit) {
      document.querySelectorAll('.multi-tab-detail .erp-table .cell-edit').forEach(inp => {
        inp.addEventListener('input', () => {
          const tr = inp.closest('tr');
          if (tr && tr.dataset.state !== 'added') {
            tr.dataset.state = 'modified';
          }
        });
      });
    }
  });

  window.addEventListener('load', () => {
    document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
      .forEach(el => { if (!el.closest('.modal')) el.disabled = true; });
    if (localStorage.getItem("afterSave") === "1") {
      localStorage.removeItem("afterSave");
      document.getElementById("btnViewEditToggle")?.click();
    }
  });
}

// ============================
// Header ç‰ˆé¢æ‹–æ‹‰å„²å­˜ / Lookup ä¸‹æ‹‰åˆå§‹åŒ–ï¼ˆjQueryï¼‰
// ============================
$(function () {
  let debounceTimer;
  const debounceSave = () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(saveLayoutChanges, 400); };

  function saveLayoutChanges() {
    const layout = [];
    const hiddenTabs = $(".tab-pane").not(".show");
    hiddenTabs.addClass("temporary-show").addClass("show").css("display", "block");
    $(".draggable-field").each(function () {
      const $li = $(this);
      layout.push({
        fieldName: $li.data("field"),
        top: Math.round($li.position().top),
        left: Math.round($li.position().left),
        width: Math.round($li.outerWidth()),
        height: Math.round($li.outerHeight()),
        ishowWhere: parseInt($li.attr("data-tab")) || 1
      });
    });
    hiddenTabs.removeClass("show").removeClass("temporary-show").css("display", "");
    if (!layout.length) return;

    fetch("/api/TableFieldLayout/SaveHeaderLayout", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tableName: "@Model.HeaderTableName".toLowerCase(), layoutUpdates: layout })
    }).catch(()=>{});
  }

  $(".draggable-field").each(function () {
    const $li = $(this);
    $li.draggable({
      handle: "label",
      helper: function () {
        return $("<div>").text($(this).find("label").text()).css({
          width: "80px", height: $li.outerHeight() + "px",
          background: "#eef", border: "1px dashed #999", padding: "4px", "font-size": "0.9em"
        });
      },
      appendTo: "body", zIndex: 10000,
      start: function () { $(this).hide(); },
      stop:  function () { $(this).show(); }
    });
    $li.resizable({ handles: "se", minWidth: 50, minHeight: 30, stop: debounceSave });
  });

  $(".header-fields-tab").droppable({
    accept: ".draggable-field", tolerance: "pointer",
    over: function () { $(this).addClass("drop-hover"); },
    out:  function () { $(this).removeClass("drop-hover"); },
    drop: function (event, ui) {
      $(this).removeClass("drop-hover");
      const $zone = $(this), $item = $(ui.draggable);
      const newTabIndex = parseInt($zone.data("tab-index")) || 1;
      $item.appendTo($zone).attr("data-tab", newTabIndex).css({
        top: ui.offset.top - $zone.offset().top,
        left: ui.offset.left - $zone.offset().left,
        position: "absolute"
      });
      debounceSave();
    }
  });

  let dragTabSwitchTimer = null;
  $("#headerTabs button").droppable({
    accept: ".draggable-field",
    over: function () { const $tabBtn = $(this); dragTabSwitchTimer = setTimeout(() => { $tabBtn.trigger("click"); }, 600); },
    out:  function () { clearTimeout(dragTabSwitchTimer); }
  });

  $('.lookup-dropdown').each(function() {
    const $select = $(this);
    const table = $select.data('table'), key = $select.data('key'),
          result = $select.data('result'), selected = $select.data('selected');
    $.getJSON(`/api/TableFieldLayout/LookupData?table=${table}&key=${key}&result=${result}`, function(data) {
      $select.empty().append('<option value="">--è«‹é¸æ“‡--</option>');
      (data || []).forEach(row => {
        const val = row.key;
        const label = Object.keys(row).filter(p => p.startsWith('result')).map(p => row[p]).join(' - ');
        const $opt = $('<option>').val(val).text(label);
        if (val == selected) $opt.attr('selected', true);
        $select.append($opt);
      });
      $select.next('.lookup-label').text($select.find('option:selected').text());
    });
    $select.on('change', function() {
      $(this).next('.lookup-label').text($(this).find('option:selected').text());
    });
  });

  function setInitialTabHeights(offsetPx = 10) {
    const hiddenTabs = $(".tab-pane").not(".show");
    hiddenTabs.addClass("tmp-show").addClass("show").css("display", "block");
    $(".header-fields-tab").each(function () {
      let maxBottom = 0;
      $(this).children(".draggable-field").each(function () {
        const $el = $(this);
        maxBottom = Math.max(maxBottom, $el.position().top + $el.outerHeight());
      });
      $(this).height(Math.max(0, Math.ceil(maxBottom + offsetPx)));
    });
    hiddenTabs.removeClass("show tmp-show").css("display", "");
  }
  requestAnimationFrame(() => setInitialTabHeights(10));
});

// ============================
// ä¸Šä¸€ç­† / ä¸‹ä¸€ç­†
// ============================
const NAV_BTN_PREV = document.getElementById('btnPrev');
const NAV_BTN_NEXT = document.getElementById('btnNext');
let navIds = [], navIndex = -1;

function loadLastFilters() {
  try { const s = localStorage.getItem("orderListQueryFilters"); return s ? JSON.parse(s) : []; }
  catch { return []; }
}
function getDetailBasePath() { return location.pathname.replace(/\/[^\/]+$/, "/"); }
function gotoPaper(pn) { if (!pn) return; localStorage.setItem("lastViewedPaperNum", pn); location.href = getDetailBasePath() + pn; }
function updateNavButtons() {
  const hasPrev = navIndex > 0;
  const hasNext = navIndex >= 0 && navIndex < navIds.length - 1;
  NAV_BTN_PREV.disabled = !hasPrev;
  NAV_BTN_NEXT.disabled = !hasNext;
  NAV_BTN_PREV.onclick = () => hasPrev && gotoPaper(navIds[navIndex - 1]);
  NAV_BTN_NEXT.onclick = () => hasNext && gotoPaper(navIds[navIndex + 1]);
}
async function fetchIdListByApi(filters) {
  const res = await fetch('/api/PagedQuery/IdList', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ table: PAGE.headerTable, keyField: PAGE.keyField, filters: filters || [] })
  });
  const json = await res.json();
  return Array.isArray(json.ids) ? json.ids : [];
}
async function fetchIdListByPagedQuery(filters) {
  const fs = [...(filters || []), {Field:"page",Op:"",Value:"1"}, {Field:"pageSize",Op:"",Value:"999999"}];
  const res = await fetch('/api/PagedQuery/PagedQuery', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ table: PAGE.headerTable, filters: fs })
  });
  const json = await res.json();
  const rows = Array.isArray(json.data) ? json.data : [];
  return rows.map(r => r[PAGE.keyField]).filter(Boolean);
}
async function initRowNavigation() {
  try {
    const filters = loadLastFilters();
    try { navIds = await fetchIdListByApi(filters); }
    catch { navIds = await fetchIdListByPagedQuery(filters); }
    navIndex = navIds.indexOf(PAGE.paperNum);
    updateNavButtons();
  } catch {
    NAV_BTN_PREV.disabled = true; NAV_BTN_NEXT.disabled = true;
  }
}
initRowNavigation();

// ============================
// å…¶ä»–ï¼šæŠŠæœ€å¾Œæª¢è¦–çš„å–®è™Ÿå­˜åœ¨ localStorage
// ============================
localStorage.setItem("lastViewedPaperNum", window.selectedPaperNum);
function getHeaderValueByLabel(labelText) {
  const li = Array.from(document.querySelectorAll('.draggable-field'))
    .find(el => (el.querySelector('label')?.textContent || '').trim() === labelText);
  if (!li) return '';
  const ctrl = li.querySelector('select, input, textarea');
  if (!ctrl) return '';
  if (ctrl.tagName.toLowerCase() === 'select') {
    const opt = ctrl.options[ctrl.selectedIndex];
    return (opt?.text || opt?.value || '').trim();
  }
  return (ctrl.value || '').trim();
}

// æœªå„²å­˜æ——æ¨™
window.__unsavedChanges = false;
document.addEventListener('input', (e) => {
  if (e.target.closest('.erp-header-form')) window.__unsavedChanges = true;
});
window.addEventListener('pageshow', () => { window.__unsavedChanges = false; });
</script>

<style>
/* =========================================
   A) å…¨å±€/ç‰ˆé¢
   ========================================= */
body { background: #f7f9fb !important; }
.erp-detail-container { min-height: 100vh; padding: 32px 0; margin-left: 3vw; margin-right: 3vw; }

/* =========================================
   B) Header è¡¨å–® & Tabs
   ========================================= */
.erp-header-form,
.erp-header-form select,
.erp-header-form textarea,
.erp-header-form input { font-size: 0.95em; }

.erp-header-form select.form-select{
  font-size: 1em !important; height: 32px !important; min-height: 32px !important; line-height: 1.15 !important;
  padding: 2px 30px 2px 6px !important; appearance: none; -webkit-appearance: none; -moz-appearance: none;
  background-image: url('data:image/svg+xml;utf8,<svg width="11" height="11" fill="gray" xmlns="http://www.w3.org/2000/svg"><path d="M2 4.5l3.5 3.5L9 4.5" stroke="gray" stroke-width="2" fill="none" stroke-linecap="round"/></svg>');
  background-repeat: no-repeat; background-position: right 10px center; background-size: 14px 14px; box-shadow: none !important; border-radius: 5px !important;
}
.header-fields-tab{
  position: relative; min-height: 120px; padding-bottom: 8px;
  background: #eef2f9 !important; box-shadow: 0 2px 6px rgba(0,0,0,0.04);
}
.drop-hover{ background-color:#cce5ff !important; border-radius:4px; }

.erp-header-form .nav-tabs .nav-link{ border-radius:8px 8px 0 0 !important; padding:7px 18px; font-size:1.05em; font-weight:500; color:#235eb8; }
.erp-header-form .nav-tabs .nav-link.active{
  background:#fff; color:#124d8b; border-color:#bdd2f7 #bdd2f7 #fff #bdd2f7 !important; box-shadow:0 2px 6px 0 #e4ecf7; font-weight:bold;
}

/* draggable æ¬„ä½ï¼ˆæ©«æ’ label + æ§ä»¶ï¼‰ */
.draggable-field{ position:absolute; display:flex; flex-direction:column; box-sizing:border-box; overflow:hidden; background:transparent; }
.draggable-field.inline{ display:flex; flex-direction:row; align-items: center; gap:4px; flex:0 0 auto; min-width:100px; max-width:100%; }
.draggable-field label{ cursor:move; font-size:0.85em; margin:0 6px 0 0; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
.draggable-field.inline .field-control{ flex:1 1 auto; height:100%; display:flex; }
.draggable-field.inline textarea,
.draggable-field.inline input,
.draggable-field.inline .form-select{
  flex:1 1 auto; width:100%; height:100%; min-height:32px; line-height:1.2; resize:none; padding:4px 6px; font-size:0.95em;
}
.draggable-field.inline label{
  white-space: nowrap !important;
  overflow: visible !important;
  text-overflow: clip !important;
  max-width: none !important;
}

/* =========================================
   D) å…¶å®ƒ
   ========================================= */
.highlight-red { color:#e53b2d; font-weight:700; }
.highlight-blue{ color:#2564b3; font-weight:700; }

/* --- Action Rail åŸºç¤ç‰ˆä½ & å…§å®¹å³ç§»ï¼ˆå›ºå®šåœ¨æ¨£æ¿ï¼‰--- */
:root{
  --fab-left: 12px;
  --fab-width: 100px;
  --fab-gap: 20px;
  --rail-reserve: calc(var(--fab-left) + var(--fab-width) + var(--fab-gap));
}

.action-rail{
  position: fixed;
  left: var(--fab-left);
  top: 80px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 900;
}

/* æŒ‰éˆ•çš„å…±åŒå¤–è§€ï¼ˆä¿æŒåœ¨æ¨£æ¿ï¼Œè®“æ‰€æœ‰é é¢ä¸€è‡´ï¼‰ */
.fab{
  position: relative;
  min-width: var(--fab-width);
  padding: 8px 12px;
  background:#ffc107;
  color:#090101;
  font-weight:700;
  border-radius:10px;
  cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.2);
  border:0;
}
.fab:hover{ filter:brightness(0.95); }
.fab-red{ background:#dc3545; color:#fff; }
.fab-blue{ background:#3583dc; color:#fff; }
</style>
