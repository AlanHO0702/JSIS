@using System.Text.Json
@model WebRazor.Models.MasterDetailConfig
@{
    var domId = Model.DomId;
    var masterTitle = Model.MasterTitle ?? Model.MasterTable;
    var detailTitle = Model.DetailTitle ?? Model.DetailTable;
    var masterDictName = Model.MasterDict ?? Model.MasterTable;
    var detailDictName = Model.DetailDict ?? Model.DetailTable;
    var json = JsonSerializer.Serialize(Model, new JsonSerializerOptions { PropertyNamingPolicy = null });
}

<div id="@domId" class="md-wrapper md-page container-fluid px-2 px-md-4">

  <!-- 工具列（與 SingleGrid 一致） -->
  <div class="top-toolbar md-toolbar-new">
    <div class="toolbar-icon-row" role="group" aria-label="row-nav-and-actions">
      <button id="@domId-btnFirst" type="button" class="btn toolbar-btn toolbar-btn-icon" title="第一筆" aria-label="第一筆"><i class="bi bi-chevron-bar-left toolbar-icon"></i></button>
      <button id="@domId-btnPrev" type="button" class="btn toolbar-btn toolbar-btn-icon" title="上一筆" aria-label="上一筆"><i class="bi bi-chevron-left toolbar-icon"></i></button>
      <button id="@domId-btnNext" type="button" class="btn toolbar-btn toolbar-btn-icon" title="下一筆" aria-label="下一筆"><i class="bi bi-chevron-right toolbar-icon"></i></button>
      <button id="@domId-btnLast" type="button" class="btn toolbar-btn toolbar-btn-icon" title="最後一筆" aria-label="最後一筆"><i class="bi bi-chevron-bar-right toolbar-icon"></i></button>
      <button id="@domId-btnAdd" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add" title="新增" aria-label="新增" disabled><span class="toolbar-icon">+</span></button>
      <button id="@domId-btnDelete" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-del" title="刪除" aria-label="刪除" disabled><span class="toolbar-icon">-</span></button>
      <button id="@domId-btnSave" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add toolbar-btn-check" title="儲存" aria-label="儲存" disabled><span class="toolbar-icon">✓</span></button>
      <button id="@domId-btnCancel" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-cancel toolbar-btn-check" title="取消" aria-label="取消" disabled><span class="toolbar-icon">&times;</span></button>
    </div>
    <div class="toolbar-main">
      <div class="d-flex gap-2 flex-wrap align-items-center">
        <div id="@domId-countBox" class="toolbar-count-box mode-view">
          <div id="@domId-modeLabel" class="count-line">瀏覽模式</div>
          <div id="@domId-countLabel" class="count-line">0 / 0</div>
        </div>
        <button id="@domId-btnQuery" type="button" class="btn toolbar-btn">
          <i class="bi bi-search"></i>查詢
        </button>
        <button id="@domId-btnEdit" type="button" class="btn toolbar-btn">
          <i class="bi bi-pencil-square"></i>修改
        </button>
      </div>
    </div>
    <div class="d-flex gap-2 flex-wrap" id="@domId-custom-slot"></div>
  </div>

  <!-- 單頭 Master -->
  <div class="card shadow-sm border-0 rounded-4 mb-3 md-master-card" data-area="master">
    <div class="card-header bg-light fw-bold d-flex align-items-center gap-2">
      <span class="area-indicator" id="@domId-masterIndicator"></span>
      @masterTitle
    </div>
    <div class="card-body p-0">
      <div id="@domId-masterWrapper" class="table-fix-wrapper md-master-scroll fab-safe">
        <table id="@domId-masterGrid" class="table table-sm table-hover align-middle mb-0 md-master-table"
               tabindex="0" data-dict-table="@masterDictName">
          <thead class="sticky-top md-head">
            <tr id="@domId-m-head"><th class="text-center" style="width:60px;display:none;">#</th></tr>
          </thead>
          <tbody id="@domId-m-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 單身 Detail -->
  <div class="card shadow-sm border-0 rounded-4 md-detail-card" data-area="detail">
    <div class="card-header bg-light fw-bold d-flex align-items-center gap-2">
      <span class="area-indicator" id="@domId-detailIndicator"></span>
      @detailTitle
    </div>
    <div class="card-body p-0">
      <div id="@domId-detailWrapper" class="table-fix-wrapper md-detail-scroll fab-safe">
        <table id="@domId-detailGrid" class="table table-sm table-hover align-middle mb-0 md-detail-table"
               tabindex="0" data-dict-table="@detailDictName">
          <thead class="sticky-top md-head">
            <tr id="@domId-d-head"><th class="text-center" style="width:60px;display:none;">#</th></tr>
          </thead>
          <tbody id="@domId-d-body">
            <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Query Modal -->
<div class="modal fade" id="@domId-queryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-search me-2"></i>查詢條件</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="@domId-queryForm" class="row g-3"></form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="@domId-btnClearQuery">清除</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="@domId-btnQuerySubmit">確定</button>
      </div>
    </div>
  </div>
</div>

<script>
  window._mdConfigs = window._mdConfigs || {};
  window._mdConfigs["@domId"] = @Html.Raw(json);
</script>

<script src="/js/editableGrid.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/masterDetailTemplate.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const domId = '@domId';
  const cfg = window._mdConfigs[domId] || {};

  // 按鈕元素
  const editBtn = document.getElementById(domId + '-btnEdit');
  const saveBtn = document.getElementById(domId + '-btnSave');
  const cancelBtn = document.getElementById(domId + '-btnCancel');
  const addBtn = document.getElementById(domId + '-btnAdd');
  const deleteBtn = document.getElementById(domId + '-btnDelete');
  const firstBtn = document.getElementById(domId + '-btnFirst');
  const prevBtn = document.getElementById(domId + '-btnPrev');
  const nextBtn = document.getElementById(domId + '-btnNext');
  const lastBtn = document.getElementById(domId + '-btnLast');
  const queryBtn = document.getElementById(domId + '-btnQuery');

  // 查詢相關
  const queryModalEl = document.getElementById(domId + '-queryModal');
  const queryForm = document.getElementById(domId + '-queryForm');
  const btnClearQuery = document.getElementById(domId + '-btnClearQuery');
  const btnQuerySubmit = document.getElementById(domId + '-btnQuerySubmit');

  // 狀態面板
  const modeLabel = document.getElementById(domId + '-modeLabel');
  const countLabel = document.getElementById(domId + '-countLabel');
  const countBox = document.getElementById(domId + '-countBox');
  const masterIndicator = document.getElementById(domId + '-masterIndicator');
  const detailIndicator = document.getElementById(domId + '-detailIndicator');

  // 表格元素
  const mWrapper = document.getElementById(domId + '-masterWrapper');
  const mTable = document.getElementById(domId + '-masterGrid');
  const dWrapper = document.getElementById(domId + '-detailWrapper');
  const dTable = document.getElementById(domId + '-detailGrid');
  const wrapper = document.getElementById(domId);

  let isEdit = false;
  let isDirty = false;
  let currentTarget = 'master'; // 'master' or 'detail'

  // 建立 Master / Detail 兩個 editor
  // KeyMap 是物件陣列 [{Master, Detail}]，需要提取 Master 欄位名稱
  const masterKeyFields = (cfg.KeyMap || []).map(k => k.Master).filter(Boolean);
  const detailKeyFields = cfg.DetailKeyFields || (cfg.KeyMap || []).map(k => k.Detail).filter(Boolean);

  const masterEditor = window.makeEditableGrid({
    wrapper: mWrapper,
    table: mTable,
    tableName: cfg.MasterTable || cfg.Master || '',
    keyFields: masterKeyFields
  });
  window._masterEditor = masterEditor;

  const detailEditor = window.makeEditableGrid({
    wrapper: dWrapper,
    table: dTable,
    tableName: cfg.DetailTable || cfg.Detail || '',
    keyFields: detailKeyFields
  });
  window._detailEditor = detailEditor;

  const getActiveEditor = () => currentTarget === 'master' ? masterEditor : detailEditor;
  const getActiveTable = () => currentTarget === 'master' ? mTable : dTable;

  const setTarget = (target) => {
    currentTarget = target;
    if (masterIndicator) {
      masterIndicator.classList.toggle('active', target === 'master');
    }
    if (detailIndicator) {
      detailIndicator.classList.toggle('active', target === 'detail');
    }
    updateCountPanel();
  };

  const setModePanel = (editing) => {
    if (modeLabel) modeLabel.textContent = editing ? '編輯模式' : '瀏覽模式';
    if (wrapper) wrapper.classList.toggle('edit-mode', editing);
    if (countBox) {
      countBox.classList.toggle('mode-edit', editing);
      countBox.classList.toggle('mode-view', !editing);
    }
    if (editBtn) {
      editBtn.innerHTML = editing
        ? '<i class="bi bi-eye"></i>瀏覽'
        : '<i class="bi bi-pencil-square"></i>修改';
    }
    if (addBtn) addBtn.disabled = !editing;
    if (saveBtn) saveBtn.disabled = !editing || !isDirty;
    if (cancelBtn) cancelBtn.disabled = !editing || !isDirty;
    if (deleteBtn) deleteBtn.disabled = !editing;
  };

  const updateCountPanel = () => {
    if (!countLabel) return;
    const table = getActiveTable();
    const rows = table?.querySelectorAll('tbody tr') || [];
    const total = rows.length;
    const selected = table?.querySelector('tbody tr.selected');
    const idx = selected ? Array.from(rows).indexOf(selected) + 1 : 0;
    countLabel.textContent = `${idx} / ${total}`;
  };

  const setDirty = (dirty) => {
    isDirty = !!dirty;
    if (!isEdit) return;
    if (saveBtn) saveBtn.disabled = !isDirty;
    if (cancelBtn) cancelBtn.disabled = !isDirty;
  };

  // 切換編輯模式
  editBtn?.addEventListener('click', () => {
    isEdit = !isEdit;
    window._mdEditing = isEdit;

    masterEditor.toggleEdit(isEdit);
    detailEditor.toggleEdit(isEdit);

    setModePanel(isEdit);
    setDirty(false);

    const evt = new CustomEvent('md-edit-click', { detail: { domId, isEdit } });
    window.dispatchEvent(evt);
  });

  // 儲存
  saveBtn?.addEventListener('click', async () => {
    const r1 = await masterEditor.saveChanges();
    const r2 = await detailEditor.saveChanges();

    const hasChanges = !(r1.skipped && r2.skipped);
    if (!hasChanges) {
      return;
    }

    if (!r1.ok || !r2.ok) {
      const err = !r1.ok ? r1 : r2;
      Swal.fire({
        icon: 'error',
        title: '儲存失敗',
        text: err.text || '其中一個表格儲存失敗'
      });
      return;
    }

    setDirty(false);
    window.location.reload();
  });

  // 取消
  cancelBtn?.addEventListener('click', () => {
    if (isEdit) {
      isEdit = false;
      window._mdEditing = false;
      masterEditor.toggleEdit(false);
      detailEditor.toggleEdit(false);
      setModePanel(false);
      setDirty(false);
      window.location.reload();
    }
  });

  // 新增
  addBtn?.addEventListener('click', async () => {
    if (!isEdit) return;
    const editor = getActiveEditor();
    try {
      const r = await editor.insertRows();
      if (r && r.ok === false) {
        Swal.fire({ icon: 'error', title: '新增失敗', text: r.text || '無法新增資料' });
      } else {
        setDirty(true);
      }
    } catch (err) {
      console.error(err);
      Swal.fire({ icon: 'error', title: '新增發生錯誤', text: err.message || err });
    }
  });

  // 刪除
  deleteBtn?.addEventListener('click', async () => {
    if (!isEdit) return;
    const editor = getActiveEditor();

    const confirm = await Swal.fire({
      icon: 'warning',
      title: '確認刪除',
      text: '確定要刪除所選資料嗎？',
      showCancelButton: true,
      confirmButtonText: '刪除',
      cancelButtonText: '取消'
    });

    if (!confirm.isConfirmed) return;

    try {
      const r = await editor.deleteRows();
      if (r && r.ok === false) {
        Swal.fire({ icon: 'error', title: '刪除失敗', text: r.text || '刪除失敗' });
      } else {
        setDirty(true);
      }
    } catch (err) {
      console.error(err);
      Swal.fire({ icon: 'error', title: '刪除發生錯誤', text: err.message || err });
    }
  });

  // 導航按鈕
  const navigateRow = (direction) => {
    const table = getActiveTable();
    if (!table) return;
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    if (rows.length === 0) return;
    const current = table.querySelector('tbody tr.selected');
    let idx = current ? rows.indexOf(current) : -1;

    switch (direction) {
      case 'first': idx = 0; break;
      case 'prev': idx = Math.max(0, idx - 1); break;
      case 'next': idx = Math.min(rows.length - 1, idx + 1); break;
      case 'last': idx = rows.length - 1; break;
    }

    rows.forEach(r => r.classList.remove('selected'));
    if (rows[idx]) {
      rows[idx].classList.add('selected');
      rows[idx].click(); // 觸發原本的選取邏輯
      try { rows[idx].scrollIntoView({ block: 'center', behavior: 'auto' }); } catch { }
    }
    updateCountPanel();
  };

  firstBtn?.addEventListener('click', () => navigateRow('first'));
  prevBtn?.addEventListener('click', () => navigateRow('prev'));
  nextBtn?.addEventListener('click', () => navigateRow('next'));
  lastBtn?.addEventListener('click', () => navigateRow('last'));

  // 點擊 Master/Detail 切換目標
  mTable?.addEventListener('click', () => {
    setTarget('master');
  });
  dTable?.addEventListener('click', () => {
    setTarget('detail');
  });

  // 監聽輸入變化
  document.addEventListener('input', (e) => {
    if (e.target.closest('.cell-edit')) {
      setDirty(true);
    }
  });
  document.addEventListener('change', (e) => {
    if (e.target.closest('.cell-edit')) {
      setDirty(true);
    }
  });
  document.addEventListener('click', (e) => {
    if (e.target.matches('.cell-edit[type="checkbox"]')) {
      setDirty(true);
    }
  });

  // 查詢功能
  let queryFieldsLoaded = false;
  const masterTable = cfg.MasterTable || cfg.Master || '';
  const itemId = cfg.ItemId || window._mdItemId || '';

  async function loadQueryFields() {
    if (queryFieldsLoaded) return;
    if (!itemId || !masterTable) return;
    try {
      const res = await fetch(`/api/DictSetupApi/QueryFields?itemId=${encodeURIComponent(itemId)}&table=${encodeURIComponent(masterTable)}&lang=TW`);
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      const list = Array.isArray(data) && data.length ? data : [];
      buildQueryForm(list);
      queryFieldsLoaded = true;
    } catch (err) {
      console.warn("load query fields failed", err);
    }
  }

  function buildQueryForm(fields) {
    if (!queryForm) return;
    queryForm.innerHTML = "";

    fields.forEach(f => {
      const colName = f.columnName || f.ColumnName || "";
      if (!colName) return;
      const caption = f.columnCaption || f.ColumnCaption || colName;
      const defVal = f.defaultValue || f.DefaultValue || "";
      const defEq = (f.defaultEqual || f.DefaultEqual || "").toString().toLowerCase();
      const dtRaw = f.dataType ?? f.DataType;
      const dt = Number(dtRaw);

      const wrap = document.createElement("div");
      wrap.className = "col-md-4 col-sm-6";
      const label = document.createElement("label");
      label.className = "form-label text-muted";
      label.textContent = caption;
      const input = document.createElement("input");
      input.className = "form-control form-control-sm";
      input.name = colName;
      if (dt === 1) input.type = "date";
      else if (dt === 2) input.type = "number";
      else input.type = "text";
      if (defVal) input.value = defVal;
      if (defEq === "like") input.placeholder = "模糊查詢";

      wrap.appendChild(label);
      wrap.appendChild(input);
      queryForm.appendChild(wrap);
    });
  }

  queryBtn?.addEventListener('click', async () => {
    await loadQueryFields();
    if (queryModalEl && window.bootstrap) {
      const modal = bootstrap.Modal.getOrCreateInstance(queryModalEl);
      modal.show();
    }
  });

  btnClearQuery?.addEventListener('click', () => {
    if (queryForm) {
      Array.from(queryForm.elements).forEach(el => {
        if (el.tagName === "INPUT") el.value = "";
      });
    }
  });

  btnQuerySubmit?.addEventListener('click', () => {
    if (!queryForm) return;
    const url = new URL(window.location.href);
    // 收集查詢欄位
    Array.from(queryForm.elements).forEach(el => {
      if (el.tagName === "INPUT" && el.name) {
        const val = el.value?.trim() ?? "";
        if (val) {
          url.searchParams.set(el.name, val);
        } else {
          url.searchParams.delete(el.name);
        }
      }
    });
    // 重設分頁
    url.searchParams.set('pageIndex', '1');
    window.location.href = url.toString();
  });

  // 初始化
  setTarget('master');
  setModePanel(false);
  updateCountPanel();
});
</script>

<style>
:root {
  --fab-space: max(140px, env(safe-area-inset-right));
  --md-master-max: 40vh;
  --md-detail-min: 0;
  --md-head-bg: #f8fafc;
  --md-head-text: #334155;
  --md-border: #dee2e6;
  --top-toolbar-icon-font-size: 20px;
  --top-toolbar-btn-height: 36px;
  --md-cell-height: 20px;
  --md-cell-line: 16px;
  --md-cell-pad-y: 2px;
}

.md-page {
  height: calc(100vh - var(--app-toolbar-height, 56px));
  overflow: hidden;
  display: flex;
  flex-direction: column;
  padding-top: 8px;
}

/* 工具列樣式（與 SingleGrid 一致） */
.top-toolbar {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  width: 100%;
  margin-bottom: 8px;
  border-radius: 10px;
  background: #f6f7f9;
  border: 1px solid #d8dee8;
  padding: 6px 8px;
  box-shadow: 0 1px 2px rgba(20, 40, 80, 0.06);
}
.md-toolbar-new {
  --top-toolbar-icon-font-size: 20px;
}
.top-toolbar .toolbar-icon-row {
  display: flex;
  gap: 4px;
  align-items: center;
}
.top-toolbar .toolbar-main {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: nowrap;
  flex: 1 1 0;
  min-width: 0;
}
.toolbar-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  background: #fff;
  color: #2a4a7a;
  border: 1px solid #b9c7de;
  border-radius: 11px;
  font-size: var(--top-toolbar-font-size);
  font-weight: 500;
  padding: 5px 10px;
  box-shadow: none;
  transition: background .18s, transform .11s, border-color .18s, color .18s;
  cursor: pointer;
}
.toolbar-btn:hover, .toolbar-btn:focus {
  background: #eef3fb;
  border-color: #9fb2d2;
  transform: translateY(-1px) scale(1.02);
}
.toolbar-btn.primary {
  background: #2564b3;
  border-color: #2564b3;
  color: #fff;
  box-shadow: 0 2px 8px rgba(37, 100, 179, 0.25);
}
.toolbar-btn.primary:hover, .toolbar-btn.primary:focus {
  background: #215aa2;
  border-color: #215aa2;
  color: #fff;
}
.toolbar-btn i {
  font-size: 1.08em;
}
.top-toolbar .toolbar-btn {
  font-size: var(--top-toolbar-font-size);
  height: var(--top-toolbar-btn-height);
  min-height: var(--top-toolbar-btn-height);
  padding: 0 6px;
  line-height: 1;
}
.top-toolbar .toolbar-btn-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: var(--top-toolbar-btn-height);
  min-height: var(--top-toolbar-btn-height);
  padding: 0;
  width: 30px;
  border-radius: 8px;
  font-size: var(--top-toolbar-icon-font-size);
  line-height: 1;
  background: #f3f5f8;
  border: 1px solid #c9d2df;
  color: #5a6a82;
  box-shadow: none;
}
.top-toolbar .toolbar-icon {
  display: inline-block;
  font-size: var(--top-toolbar-icon-font-size);
  line-height: 1;
}
.top-toolbar .toolbar-btn-icon i {
  font-size: var(--top-toolbar-icon-font-size);
  line-height: 1;
}
.top-toolbar .toolbar-btn:disabled {
  background: #f1f3f7;
  border-color: #c5ccd8;
  color: #9aa7bb;
  cursor: not-allowed;
  box-shadow: none;
  opacity: 0.8;
}
.top-toolbar .toolbar-btn-icon.toolbar-btn-add {
  background: #f7fcf9;
  border-color: #7ccfa1;
  color: #1f7a45;
}
.top-toolbar .toolbar-btn-icon.toolbar-btn-del,
.top-toolbar .toolbar-btn-icon.toolbar-btn-cancel {
  background: #fff4f4;
  border-color: #e08a8a;
  color: #b33939;
}
.top-toolbar .toolbar-btn-check, .top-toolbar .toolbar-btn-cancel {
  font-size: 18px;
}

/* 狀態面板 */
.toolbar-count-box {
  display: inline-flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: var(--top-toolbar-btn-height, 36px);
  min-width: 74px;
  padding: 2px 8px;
  border-radius: 6px;
  font-weight: 700;
  line-height: 1.05;
  color: #fff;
  user-select: none;
}
.toolbar-count-box .count-line {
  font-size: 0.75rem;
}
.toolbar-count-box.mode-view {
  background: #1e4db7;
}
.toolbar-count-box.mode-edit {
  background: #f00000;
}

/* 區域指示燈 */
.area-indicator {
  display: inline-block;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: #ccc;
  transition: background .2s;
}
.area-indicator.active {
  background: #0d6efd;
  box-shadow: 0 0 6px #0d6efd;
}
.md-detail-card .area-indicator.active {
  background: #198754;
  box-shadow: 0 0 6px #198754;
}

/* 單頭/單身卡片 */
.md-master-card {
  flex: 0 0 auto;
}
.md-master-scroll {
  max-height: var(--md-master-max);
  overflow: auto;
}
.md-detail-card {
  flex: 1 1 0;
  min-height: 0;
  display: flex;
  flex-direction: column;
}
.md-detail-card .card-body {
  flex: 1 1 0;
  min-height: 0;
  display: flex;
  flex-direction: column;
}
.md-detail-scroll {
  flex: 1 1 0;
  min-height: 0;
  overflow: auto;
}

/* 表格容器 */
.table-fix-wrapper {
  flex: 1;
  overflow: auto;
  background: #fff;
  border: 1px solid #dee2e6;
  border-radius: .5rem;
  white-space: nowrap;
  min-height: 0;
}
.table-fix-wrapper::-webkit-scrollbar {
  height: 10px;
  width: 10px;
}
.table-fix-wrapper::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 6px;
}
.table-fix-wrapper::-webkit-scrollbar-thumb:hover {
  background: #9ca3af;
}

/* 表格樣式（與 SingleGrid 一致） */
.md-wrapper table.table {
  table-layout: auto;
  border-collapse: collapse !important;
  font-size: .85rem;
  width: max-content !important;
  min-width: 0;
}
.md-wrapper table th,
.md-wrapper table td {
  vertical-align: middle !important;
  border: 1px solid #dee2e6 !important;
  padding: 0 !important;
  white-space: nowrap;
}
.md-wrapper table th {
  padding: 2px 6px !important;
  background: var(--md-head-bg);
  color: var(--md-head-text);
  position: relative;
}
.md-wrapper .table-hover tbody tr:hover {
  background: #f1f5ff !important;
}

/* 儲存格樣式（與 SingleGrid 一致） */
.md-wrapper .cell-view,
.md-wrapper .cell-edit {
  display: block;
  width: 100%;
  height: var(--md-cell-height) !important;
  min-height: var(--md-cell-height) !important;
  max-height: var(--md-cell-height) !important;
  font-size: .85rem;
  line-height: var(--md-cell-line) !important;
  box-sizing: border-box;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding: var(--md-cell-pad-y) 6px !important;
}
.md-wrapper .cell-view {
  text-align: inherit;
  border: none !important;
  background: transparent !important;
}
.md-wrapper .cell-edit.form-control {
  height: var(--md-cell-height) !important;
  min-height: var(--md-cell-height) !important;
  max-height: var(--md-cell-height) !important;
  padding: var(--md-cell-pad-y) 6px !important;
  font-size: inherit !important;
  line-height: var(--md-cell-line) !important;
  text-align: inherit !important;
  border: none !important;
  border-radius: 0 !important;
  box-sizing: border-box !important;
  background: transparent !important;
  vertical-align: middle !important;
  margin: 0 !important;
}

/* 勾選框大小固定（編輯模式與瀏覽模式一致） */
.md-wrapper .cell-edit.form-check-input {
  width: 16px !important;
  height: 16px !important;
  min-width: 16px !important;
  min-height: 16px !important;
  max-width: 16px !important;
  max-height: 16px !important;
  margin: 0 auto !important;
  padding: 0 !important;
  cursor: pointer;
}
.md-wrapper .cell-view .form-check-input {
  width: 16px !important;
  height: 16px !important;
  min-width: 16px !important;
  min-height: 16px !important;
  max-width: 16px !important;
  max-height: 16px !important;
  margin: 0 !important;
  padding: 0 !important;
}

/* 編輯模式背景 */
.md-wrapper table.table tbody td {
  background: #f3f3f3 !important;
  height: var(--md-cell-height);
}
.md-wrapper.edit-mode table.table tbody td {
  background: #fff !important;
}
.md-wrapper.edit-mode table.table tbody td.readonly-td {
  background: #f3f3f3 !important;
}

.md-wrapper .readonly-cell {
  color: #555 !important;
  border: none !important;
  cursor: not-allowed !important;
  pointer-events: none !important;
  user-select: none !important;
}

/* 選取列高亮 */
.md-wrapper tbody tr.selected td {
  background: #fff3cd !important;
  border-color: #ffc107 !important;
}
.md-wrapper tbody tr.selected {
  background: #fff3cd !important;
  box-shadow: inset 0 0 0 2px #ffc107;
}
.md-wrapper tbody tr:hover td {
  background: #f5f5dc !important;
}
.md-wrapper tbody tr:hover:not(.selected) td {
  background: #f9f2d7 !important;
}
/* 點擊時的過渡效果 */
.md-wrapper tbody tr {
  transition: background 0.15s ease;
}
.md-wrapper tbody tr td {
  transition: background 0.15s ease, border-color 0.15s ease;
}

/* 卡片標題 */
.md-wrapper .card-header {
  font-size: .85rem !important;
  padding: 6px 10px !important;
}

/* Sticky 表頭 */
.md-wrapper thead.sticky-top {
  position: sticky;
  top: 0;
  z-index: 10;
  box-shadow: 0 2px 2px rgba(0, 0, 0, .04);
}

/* 欄寬拖曳把手 */
.md-col-resizer {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  width: 10px;
  cursor: col-resize;
  user-select: none;
  z-index: 2;
}

.checkbox-dark {
  accent-color: #2c3e50;
  border: 1px solid #2c3e50 !important;
}
</style>
