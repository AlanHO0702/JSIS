@using System.Text.Json
@model WebRazor.Models.MasterDetailConfig
@{
    var domId = Model.DomId;
    var masterTitle = Model.MasterTitle ?? Model.MasterTable;
    var detailTitle = Model.DetailTitle ?? Model.DetailTable;
    var masterDictName = Model.MasterDict ?? Model.MasterTable;
    var detailDictName = Model.DetailDict ?? Model.DetailTable;
    var json = JsonSerializer.Serialize(Model, new JsonSerializerOptions { PropertyNamingPolicy = null });
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>

<div id="@domId" class="md-wrapper md-page container-fluid px-2 px-md-4">

  <!-- 功能列（左：修改；右：留白避免壓到主選單浮動鈕） -->
  <div class="d-flex align-items-center gap-3 my-3 flex-wrap">
    <div class="d-flex gap-2 flex-wrap" id="@domId-custom-slot"></div>
    <div class="btn-toolbar gap-2 md-toolbar">
      <button id="@domId-btnEdit" type="button" class="btn btn-warning btn-sm shadow-sm px-3 py-2">編輯</button>
      <button id="@domId-btnSave" type="button" class="btn btn-success btn-sm shadow-sm px-3 py-2 d-none">儲存</button>

      <!-- 新增：新增 / 刪除 按鈕（修改模式才顯示） -->
      <button id="@domId-btnAdd" type="button" class="btn btn-primary shadow-sm px-3 d-none" title="新增">+</button>
      <button id="@domId-btnDelete" type="button" class="btn btn-danger shadow-sm px-3 d-none" title="刪除">-</button>
      <button id="@domId-btnConfirm" type="button" class="btn btn-outline-success btn-sm shadow-sm px-3 py-2 d-none">✓</button>
      <button id="@domId-btnCancel" type="button" class="btn btn-outline-danger btn-sm shadow-sm px-3 py-2 d-none">☓</button>
    </div>
  </div>

  <!-- 單頭 Master -->
  <div class="card shadow-sm border-0 rounded-4 mb-3 md-master-card">
    <div class="card-header bg-light fw-bold">@masterTitle</div>
    <div class="card-body p-0">
      <!-- 卷軸交給這層 -->
      <div id="@domId-masterWrapper" class="table-responsive md-master-scroll fab-safe">
        <table id="@domId-masterGrid" class="table table-sm table-hover align-middle mb-0 md-master-table"
               tabindex="0" data-dict-table="@masterDictName">
          <thead class="sticky-top md-head">
            <tr id="@domId-m-head"><th class="text-center" style="width:60px;display:none;">#</th></tr>
          </thead>
          <tbody id="@domId-m-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 單身 Detail（會吃滿剩餘高度） -->
  <div class="card shadow-sm border-0 rounded-4 md-detail-card">
    <div class="card-header bg-light fw-bold">@detailTitle</div>
    <div class="card-body p-0">
      <!-- 卷軸交給這層 -->
      <div id="@domId-detailWrapper" class="table-responsive md-detail-scroll fab-safe">
        <table  id="@domId-detailGrid" class="table table-sm table-striped align-middle mb-0 md-detail-table"
               tabindex="0" data-dict-table="@detailDictName">
          <thead class="sticky-top md-head">
            <tr id="@domId-d-head"><th class="text-center" style="width:60px;display:none;">#</th></tr>
          </thead>
          <tbody id="@domId-d-body">
            <tr><td class="text-center text-muted p-3">請點選上方一筆資料</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
  // 把設定丟給 masterDetailTemplate.js 用（你原本就有）
  window._mdConfigs = window._mdConfigs || {};
  window._mdConfigs["@domId"] = @Html.Raw(json);
</script>

<script src="/js/editableGrid.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/masterDetailTemplate.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const domId   = '@domId';
  const cfg     = window._mdConfigs[domId] || {};

  const editBtn   = document.getElementById(domId + '-btnEdit');
  const saveBtn   = document.getElementById(domId + '-btnSave');
  const confirmBtn= document.getElementById(domId + '-btnConfirm');
  const cancelBtn = document.getElementById(domId + '-btnCancel');
  const mWrapper  = document.getElementById(domId + '-masterWrapper');
  const mTable    = document.getElementById(domId + '-masterGrid');
  const dWrapper  = document.getElementById(domId + '-detailWrapper');
  const dTable    = document.getElementById(domId + '-detailGrid');
  // 新增、刪除按鈕
  const addBtn    = document.getElementById(domId + '-btnAdd');
  const deleteBtn = document.getElementById(domId + '-btnDelete');


  // 建立 Master / Detail 兩個 editor
  const masterEditor = window.makeEditableGrid({
    wrapper: mWrapper,
    table:   mTable,
    tableName: cfg.MasterTable || cfg.Master || '',
    keyFields: cfg.KeyMap || []
  });
  window._masterEditor = masterEditor;

  const detailEditor = window.makeEditableGrid({
    wrapper:  dWrapper,
    table:    dTable,
    tableName: cfg.DetailTable || cfg.Detail || '',
    keyFields: cfg.DetailKeyFields || [] 
  });

  // ⭐ 正確：宣告後才能存成全域
  window._detailEditor = detailEditor;

  editBtn.addEventListener('click', () => {
    const toEdit = !masterEditor.isEdit();
    window._mdEditing = toEdit;

    masterEditor.toggleEdit(toEdit);
    detailEditor.toggleEdit(toEdit);

    editBtn.textContent = toEdit ? '檢視' : '編輯';
    saveBtn.classList.toggle('d-none', !toEdit);

    // 顯示 / 隱藏 新增、刪除按鈕（只在修改模式顯示）
    addBtn?.classList.toggle('d-none', !toEdit);
    deleteBtn?.classList.toggle('d-none', !toEdit);
    
    // 離開編輯時關閉新增模式
    if (!toEdit) {
      confirmBtn?.classList.add('d-none');
      cancelBtn?.classList.add('d-none');
    }

    const evt = new CustomEvent('md-edit-click', { detail: { domId, isEdit: toEdit } });
    window.dispatchEvent(evt);
  });

  saveBtn.addEventListener('click', async () => {
    const r1 = await masterEditor.saveChanges();
    const r2 = await detailEditor.saveChanges();

    const hasChanges = !(r1.skipped && r2.skipped);
    if (!hasChanges) {
      Swal.fire({ icon: 'info', title: '沒有任何變更', timer: 1000, showConfirmButton: false });
      return;
    }

    if (!r1.ok || !r2.ok) {
      const err = !r1.ok ? r1 : r2;
      Swal.fire({
        icon: 'error',
        title: '儲存失敗',
        text: err.text || '其中一個表格儲存失敗'
      });
      return;
    }

    Swal.fire({ icon: 'success', title: '儲存完成', timer: 1000, showConfirmButton: false });
  });

  // 先判斷是 master 還是 detail
  let target = null;
  // 點擊 table 任一處就更新（可改成更精細的 row click）
  mTable.addEventListener('click', () => { target = masterEditor; });
  dTable.addEventListener('click', () => { target = detailEditor; });
  
  // 新增按鈕
  addBtn.addEventListener('click', async () => {
    if (!window._mdEditing) {
      Swal.fire({ icon: 'info', title: '請先點選修改進入編輯模式', timer: 1000, showConfirmButton: false });
      return;
    }

    if (!target) {
      Swal.fire({ icon: 'info', title: '請先選取要新增的位置', timer: 1000, showConfirmButton: false });
      return;
    }

    try {
      const r = await target.insertRows();
      if (r && r.ok === false) {
        Swal.fire({ icon: 'error', title: '新增失敗', text: r.text || '無法新增資料' });
      }
    } catch (err) {
      console.error(err);
      Swal.fire({ icon: 'error', title: '新增發生錯誤', text: err.message || err });
    }
  });

  // 刪除按鈕
  deleteBtn.addEventListener('click', async () => {
    if (!window._mdEditing) {
      Swal.fire({ icon: 'info', title: '請先點選修改進入編輯模式', timer: 1000, showConfirmButton: false });
      return;
    }

    if (!target) {
      Swal.fire({ icon: 'info', title: '請先選取要刪除的資料', timer: 1000, showConfirmButton: false });
      return;
    }

    const confirm = await Swal.fire({
      icon: 'warning',
      title: '確認刪除',
      text: '確定要刪除所選資料嗎？此動作無法還原。',
      showCancelButton: true,
      confirmButtonText: '刪除',
      cancelButtonText: '取消'
    });

    if (!confirm.isConfirmed) return;

    try {
      const r = await target.deleteRows();
      if (r && r.ok === false) {
        Swal.fire({ icon: 'error', title: '刪除失敗', text: r.text || '刪除失敗' });
      }
    } catch (err) {
      console.error(err);
      Swal.fire({ icon: 'error', title: '刪除發生錯誤', text: err.message || err });
    }
  });
});
</script>

<script src="/js/masterDetailTemplate.js"></script>

<style>
  /* ====== 右上角主選單浮動鈕安全邊界 ====== */
:root {
  --fab-space: max(140px, env(safe-area-inset-right));
  --md-master-max: 40vh;   /* 單頭區塊的最大高度 */
  /* 單身的最小高度交給捲動層，不要卡在 card 上 */
  --md-detail-min: 0;
  --md-head-bg: #f8fafc;
  --md-head-text: #334155;
  --md-border: #e5e7eb;
}

/* ...前面都一樣... */

.md-page{
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* 單頭保留原本設定 */
.md-master-card { flex: 0 0 auto; }
.md-master-scroll{
  max-height: var(--md-master-max);
  overflow: auto;
}

/* ===== 單身卡片改成真正「吃滿剩下高度 + 內部捲動」 ===== */
.md-detail-card{
  flex: 1 1 0;          /* 吃掉剩下的空間 */
  min-height: 0;        /* ★關鍵：允許比內容矮，才有空間給捲軸 */
  display: flex;
  flex-direction: column;
}

/* card-body 也要能被壓縮，讓下一層捲動 */
.md-detail-card .card-body{
  flex: 1 1 0;
  min-height: 0;        /* ★關鍵 */
  display: flex;
  flex-direction: column;
}

/* 真正有捲軸的那一層 */
.md-detail-scroll{
  flex: 1 1 0;
  min-height: 0;
  overflow: auto;       /* 垂直 + 水平捲軸都交給這裡 */
}

/* ===== 表格樣式維持原本 ===== */
.md-wrapper .md-master-table,
.md-wrapper .md-detail-table {
  border-collapse: separate;
  border-spacing: 0;
  width: auto;              /* 欄寬依辭典設定，不撐滿整個 GRID */
  min-width: max-content;   /* 總寬度超過容器時出現水平捲軸 */
  table-layout: fixed;      /* ⭐ 固定欄寬，跟著 th 的 width 走 */

}
  .md-wrapper .md-master-table th,
  .md-wrapper .md-master-table td,
  .md-wrapper .md-detail-table th,
  .md-wrapper .md-detail-table td {
    border-right: 1px solid var(--md-border);
    white-space: nowrap;
    position: relative;
  }
  .md-wrapper .md-master-table thead th:first-child,
  .md-wrapper .md-master-table tbody td:first-child,
  .md-wrapper .md-detail-table thead th:first-child,
  .md-wrapper .md-detail-table tbody td:first-child {
    border-left: 1px solid var(--md-border);
  }
  .md-wrapper .md-master-table thead th,
  .md-wrapper .md-detail-table thead th {
    border-bottom: 1px solid var(--md-border);
  }
  .md-wrapper .md-master-table tbody tr + tr,
  .md-wrapper .md-detail-table tbody tr + tr {
    border-top: 1px solid #f1f3f5;
  }

  /* Sticky 表頭陰影＋避免中文直排 */
  .md-wrapper .md-master-table thead.sticky-top,
  .md-wrapper .md-detail-table thead.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 2px 2px rgba(0,0,0,.04);
  }
  .md-wrapper .md-master-table thead th,
  .md-wrapper .md-detail-table thead th {
    writing-mode: horizontal-tb !important;
    text-orientation: mixed !important;
    white-space: nowrap !important;
    word-break: keep-all !important;
    vertical-align: middle;
    line-height: 1.2;
    min-width: 64px;
    background: var(--md-head-bg);
    color: var(--md-head-text);
  }

  /* 選取列高亮 */
  .md-wrapper .selected { background: #f1f5f9 !important; font-weight: 600; }
  .md-wrapper tbody tr:hover td { background: #f8fafc; }

  /* ====== 高密度模式：字體縮小、padding 縮小 ====== */

  /* 顯示模式 */
  .cell-view,
  .cell-edit {
      display:inline-block;
      width:100%;
      font-size: 14px !important;
      line-height: 1.2 !important;
      box-sizing:border-box;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding: 2px 4px !important;
      vertical-align:middle;
  }

  /* 編輯模式 input */
  .cell-edit.form-control {
      height: 26px !important;
      padding: 2px 4px !important;
      font-size: 14px !important;
      line-height: 1.2 !important;
      border-radius:0!important;
      box-sizing:border-box!important;
  }

  /* 只保留一次 readonly 設定（已合併為密度版） */
  .readonly-cell{
      background:#f3f3f3!important;
      color:#555!important;
      border:1px solid #ddd!important;
      cursor:not-allowed!important;
      font-size: 14px !important;
      padding: 2px 4px !important;
  }

  /* 表頭 */
  .md-wrapper th {
      font-size: 14px !important;
      padding: 6px 8px !important;
      height: 32px !important;
      font-weight: 600;
  }

  /* 表格資料列 */
  .md-wrapper td {
      font-size: 14px !important;
      padding: 6px 8px !important;
      height: 30px !important;
  }

  /* 卡片標題 */
  .md-wrapper .card-header {
      font-size: 14px !important;
      padding: 4px 8px !important;
  }

  /* 工具列按鈕統一樣式（對齊 MultiGrid） */
  .md-toolbar .btn{
      min-height: 32px;
      font-size: 14px;
      border-radius: 8px;
      font-weight: 500;
  }
  .md-toolbar .btn-outline-success { color:#198754 !important; border-color:#198754 !important; box-shadow:none!important; background:#fff!important; }
  .md-toolbar .btn-outline-success:hover,
  .md-toolbar .btn-outline-success:focus { color:#198754 !important; background:#e9f7ef !important; box-shadow:none!important; }

  /* 欄寬拖曳把手 */
  .md-col-resizer{
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 10px;
      cursor: col-resize;
      user-select: none;
      z-index: 2;
  }
  .md-wrapper th.resizing,
  .md-wrapper td.resizing,
  body.resizing { cursor: col-resize !important; }
</style>