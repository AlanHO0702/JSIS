@using PcbErpApi.Models
@model dynamic

@{
    var fields = ViewData["Fields"] as List<TableFieldViewModel>;
    if (fields == null) { <text>æŸ¥ç„¡æ¬„ä½è¨­å®š</text>; return; }
    var items = Model.Items;
    var totalCount = Model.TotalCount;
    var pageNumber = Model.PageNumber;
    var pageSize = Model.PageSize;
    var subRouteTemplate = ViewData["SubRouteTemplate"] as string ?? "";
    var paginationVm = ViewData["PaginationVm"] as PaginationModel;

    // æ–°å¢APIè·¯å¾‘èˆ‡å–®èº«é è·¯å¾‘ï¼Œå¾ ViewData å‚³ï¼ˆé è¨­å€¼ä¹Ÿå¯å¯«æ­»ï¼‰
    var addApiUrl = ViewData["AddApiUrl"] as string ?? "/api/SPOdOrderMain";
    var detailRouteTemplate = ViewData["SubRouteTemplate"] as string ?? "/SpodOrderSubs/{PaperNum}";
    var lookupMapData = ViewData["LookupDisplayMap"] as Dictionary<string, Dictionary<string, string>>;
    var keyFieldName = ViewData["KeyFieldName"]?.ToString() ?? "PaperNum";
    var tableName = ViewData["DictTableName"]?.ToString() ?? "SPOdOrderMain";
}
<script>
    window._tableName = "@tableName";
    window._tableFields = @Html.Raw(Json.Serialize(fields));
    window._lookupMapData = @Html.Raw(Json.Serialize(lookupMapData ?? new Dictionary<string, Dictionary<string, string>>()));
    window._keyFieldName = "@keyFieldName";
</script>

<style>
    body { background: #f7f9fb; }
    .container { max-width: 1100px; }
    .title-row { display: flex; justify-content: space-between; align-items: flex-end; }
    .order-count { font-size: 1rem; color: #666; margin-bottom: 6px; }
    .table { box-shadow: 0 2px 12px 0 #c3d4e6; border-radius: 16px; overflow: hidden; background: #fff; }
    .table th, .table td { vertical-align: middle !important; white-space: nowrap; font-size: 1rem; border: none; }
    .table th {
        background: linear-gradient(90deg, #e8f2fe 0%, #f3f8ff 100%);
        color: #2056ac; letter-spacing: 2px; font-weight: 600;
        border-bottom: 2px solid #bdd2f7; padding: 14px 10px;
    }
    .table tbody tr { transition: background .15s; }
    .table tbody tr:hover { background: #f0f8ff !important; }
    .table td { border-top: 1px solid #f0f3f7 !important; padding: 11px 10px; }
    .status-done { color: #29963b; background: #e5f7e6; border-radius: 8px; padding: 2px 10px; font-weight: bold; letter-spacing: 1px; font-size: 1.05em;}
    .status-pending { color: #c88400; background: #fff9e3; border-radius: 8px; padding: 2px 10px; font-weight: bold; letter-spacing: 1px; font-size: 1.05em;}
    .row-link { cursor: pointer; }
    .pagination-bar { margin: 20px 0 30px 0; }
    .pagination .page-link { color: #3a72d9; border-radius: 6px !important; margin: 0 2px; }
    .pagination .page-item.active .page-link { background: #3a72d9; color: #fff; border: none; }
    .pagination .page-item.disabled .page-link { color: #aaa; pointer-events: none; background: #f1f4f8; }
    .table-wrap {
        max-width: 100%;            /* ä¸æœƒè¶…écontainerå¯¬ */
        overflow-x: auto;           /* è¶…éå¯¬åº¦è‡ªå‹•å‡ºç¾æ©«å‘æ²è»¸ */
        margin: 0 auto;             /* æ°´å¹³ç½®ä¸­ */
        background: #fff;           /* å¯è¦–éœ€æ±‚ */
        border-radius: 16px;
        box-shadow: 0 2px 12px 0 #c3d4e6;
    }
    .table {
        min-width: 1200px;          /* æœ€å°å¯¬ï¼Œæ ¹æ“šæ¬„ä½æ•¸é‡èª¿æ•´ */
        margin-bottom: 0;
    }
    tr.selected td, tr.selected:hover td {
        background-color: #ffe6e6 !important;
    }
    .highlight {
        background-color: #ffd !important;
    }
    .ghost {
        opacity: 0.5;
    }
    #search-panel {
    background: #f8fafb;
    border-radius: 10px;
    padding: 14px 18px;
    margin-top: 12px;
    margin-bottom: 18px;
    box-shadow: 0 2px 6px 0 #e2e8f0;
    }
    #search-panel label {
        margin-bottom: 2px;
        font-size: 0.93em;
        color: #286bb5;
    }

</style>

<div class="container my-5">
    <div class="title-row mb-4 border-bottom pb-2">
        <div style="display:flex;align-items:center;gap:16px;">
            <h2 class="mb-0 text-primary" style="font-weight:700;letter-spacing:3px;">@ViewData["TableTitle"]</h2>
            @await Html.PartialAsync("_TableToolbar", new TableToolbarModel {
                SearchBtnId = "btnSearch",
                AddBtnId = "btnAddNew",
                DeleteBtnId = "btnBatchDelete",
                QueryFields = ViewData["QueryFields"] as List<QueryFieldViewModel>,
                ModalId = "searchModal",
                ReportSpName = ViewData["ReportSpName"]?.ToString() ?? ""   // ğŸ‘ˆ å¾å¤–å±¤å†å‚³é€²ä¾†
            })
        </div>
        <span class="order-count" id="orderCountInfo">
            å…± <span style="font-weight:bold">@Model.TotalCount</span> ç­†ï¼Œ
            é¡¯ç¤ºç¬¬ @(((Model.PageNumber - 1) * Model.PageSize) + 1)
            ~ @(Math.Min(Model.PageNumber * Model.PageSize, Model.TotalCount)) ç­†
        </span>
    </div>


    <div class="table-wrap">
        <table class="table table-hover align-middle text-center">
            <thead>
                <tr id="table-header-row">
                    @foreach (var field in fields)
                    {
                        <th class="sortable" draggable="true" data-field="@field.FieldName" data-serial="@field.SerialNum">
                            @(string.IsNullOrWhiteSpace(field.DisplayLabel) ? field.FieldName : field.DisplayLabel)
                        </th>
                    }
                </tr>
            </thead>
            <tbody id="dataTbody"></tbody>
                <!-- è³‡æ–™ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
            </tbody>
        </table>
    <div class="pagination-bar" id="paginationBar"> 
        <!-- è³‡æ–™ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
        @if (paginationVm != null) { @await Html.PartialAsync("_Pagination", paginationVm) }
    </div>
</div>


<!-- é€™ä¸€è¡Œä¸€å®šè¦åœ¨æ‰€æœ‰ <script> ä¹‹å‰ç¨ç«‹æ”¾ï¼Œä¸è¦åŒ…åœ¨ <script> è£¡ï¼ -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="~/js/toolbarHandler.js"></script>

<script>
    let selectedPaperNum = null;
    const addApiUrl = '@addApiUrl';
    const detailRouteTemplate = '@detailRouteTemplate';

    function saveQueryState(filters, pageNumber) {
        localStorage.setItem("orderListQueryFilters", JSON.stringify(filters));
        localStorage.setItem("orderListPageNumber", String(pageNumber));
    }

    function loadQueryState() {
        const filtersStr = localStorage.getItem("orderListQueryFilters");
        const pageStr = localStorage.getItem("orderListPageNumber");
        return {
            filters: filtersStr ? JSON.parse(filtersStr) : null,
            pageNumber: pageStr ? parseInt(pageStr) : null
        };
    }

    let lastQueryFilters = [];

    document.addEventListener("DOMContentLoaded", function () {

        new ToolbarHandler({
            searchBtnId: "btnSearch",
            addBtnId: "btnAddNew",
            deleteBtnId: "btnBatchDelete",
            getSelectedId: () => {
                const selectedRow = document.querySelector("#dataTbody tr.selected");
                return selectedRow ? selectedRow.getAttribute("data-paper-num") : null;
            },   // â† é€™è£¡åŠ ä¸Šé€—è™Ÿ !!!
            modalId: "searchModal",   // ä¸€å®šè¦åŠ 
            formId: "searchForm",     // ä¸€å®šè¦åŠ 
            addApiUrl: "@addApiUrl",
            deleteApiUrlFn: (id) => `/api/${"@tableName"}/${id}`,
            detailRouteTemplate: "@(detailRouteTemplate)",
            tableName: "@tableName",
            pageSize: 50,
            renderTable: renderTable,
            renderPagination: renderPagination,
            renderOrderCount: renderOrderCount,
            restoreSearchForm: restoreSearchForm,
            queryRedirectUrl: "/@tableName"
        });


         // âœ… æ‹–æ›³è¡¨é ­æ¬„ä½
        const headerRow = document.getElementById("table-header-row");

        if (headerRow) {
           Sortable.create(headerRow, {
                        animation: 150,
                        swap: true,                     // âœ… ä½¿ç”¨ swap æ¨¡å¼
                        swapClass: 'highlight',         // âœ… æ‹–æ›³æ™‚åŠ  highlight æ•ˆæœ
                        ghostClass: 'ghost',            // å¯é¸ï¼šæ‹–æ›³æ™‚åŸä½ç½®æ¨£å¼
                        onEnd: function () {
                            const newOrder = Array.from(headerRow.children).map((th, index) => ({
                                fieldName: th.dataset.field,
                                serialNum: index + 1
                            }));

                            fetch('/api/TableFieldLayout/SaveSerialOrder', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    tableName: window._tableName,
                                    fieldOrders: newOrder
                                })
                            })
                            .then(res => {
                                if (!res.ok) throw new Error("æ›´æ–°å¤±æ•—");
                                return res.json();
                            })
                            .then(() => {
                                location.reload();
                            })
                            .catch(err => {
                                console.error(err);
                                Swal.fire({ icon: 'error', title: 'æ¬„ä½é †åºå„²å­˜å¤±æ•—ï¼' });
                            });
                    }
            });

        }
           // --- ä¸‹é¢æ˜¯æ–°åŠ çš„"é›™æ“Šè¡¨é ­æ¬„ä½æ’åº" ---
            let lastSort = { col: null, asc: true };

            function getCellValue(tr, idx) {
                const cell = tr.children[idx];
                // æ•¸å­—æ¬„ä½è‡ªå‹•å»é™¤é€—è™Ÿ
                let val = cell ? cell.textContent.trim().replace(/,/g, '') : '';
                if (val === '') return 0; // ç©ºå€¼è¦–ç‚º0
                if (!isNaN(val)) return parseFloat(val); // è‹¥ç‚ºæ•¸å­—å°±è½‰ float
                return val;
            }

            document.querySelectorAll("th.sortable").forEach(function (th, idx) {
                th.addEventListener("dblclick", function () {
                    const table = th.closest('table');
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const colIdx = idx;

                    // åˆ‡æ›æ­£åº/ååº
                    let asc = true;
                    if (lastSort.col === colIdx) asc = !lastSort.asc;
                    lastSort = { col: colIdx, asc: asc };

                    rows.sort((a, b) => {
                        let aVal = getCellValue(a, colIdx);
                        let bVal = getCellValue(b, colIdx);

                        // æ•¸å­—/æ—¥æœŸæ’æ•¸å­—ï¼Œå…¶ä»–æ¬„ä½ç”¨å­—ä¸²
                        if (typeof aVal === "number" && typeof bVal === "number") {
                            return asc ? aVal - bVal : bVal - aVal;
                        }
                        // å­—ä¸²æ’åºï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
                        aVal = aVal + '';
                        bVal = bVal + '';
                        return asc ? aVal.localeCompare(bVal, 'zh-Hant') : bVal.localeCompare(aVal, 'zh-Hant');
                    });

                    // é‡æ–°æ’å…¥æ’åºå¾Œçš„ row
                    rows.forEach(tr => tbody.appendChild(tr));
                });
            });

        function renderTable(data) {
            const tbody = document.getElementById('dataTbody');
            tbody.innerHTML = ""; // æ¸…ç©º

            const fields = window._tableFields;
            const lookupMapData = window._lookupMapData;
            const keyFieldName = window._keyFieldName;
            const subRouteTemplate = "@(detailRouteTemplate)";

            data.forEach(item => {
                const keyValue = item[keyFieldName] || "";
                let rowUrl = "";
                if (subRouteTemplate && keyValue)
                    rowUrl = subRouteTemplate.replace("{PaperNum}", keyValue);

                const tr = document.createElement('tr');
                tr.className = "row-link";
                tr.setAttribute('data-url', rowUrl);
                tr.setAttribute('data-paper-num', keyValue);

                fields.forEach(field => {
                    let valStr = "";
                    // lookup
                    let display = "";
                    if (
                        keyValue &&
                        lookupMapData &&
                        lookupMapData[keyValue] &&
                        lookupMapData[keyValue][field.FieldName]
                    ) {
                        display = lookupMapData[keyValue][field.FieldName];
                        valStr = display;
                    } else {
                        // åŸå§‹å€¼
                        let rawValue = item[field.FieldName];
                        if (rawValue != null) {
                            // æ ¼å¼åŒ–
                            if (field.FormatStr) {
                                if (field.DataType && field.DataType.toLowerCase() === "date") {
                                    let dt = new Date(rawValue);
                                    if (!isNaN(dt.getTime())) {
                                        // åªæ”¯æ´ yyyy/MM/dd
                                        valStr = dt.toLocaleDateString("zh-TW"); 
                                    } else {
                                        valStr = rawValue;
                                    }
                                } else if (field.DataType && field.DataType.toLowerCase() === "number") {
                                    valStr = Number(rawValue).toLocaleString();
                                } else {
                                    valStr = rawValue;
                                }
                            } else {
                                valStr = rawValue;
                            }
                        }
                    }
                    const td = document.createElement('td');
                    td.innerHTML = valStr ?? "";
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            highlightLastViewedRow();

            // é»æ“Šè¡Œï¼šé¸å–ï¼Œä¸è·³é 
            document.querySelectorAll(".row-link").forEach(function(row) {
                row.addEventListener("click", function(e) {
                    document.querySelectorAll(".row-link.selected").forEach(r => r.classList.remove("selected"));
                    row.classList.add("selected");
                    window.selectedPaperNum = row.getAttribute("data-paper-num");
                });

            // é›™æ“Šè¡Œï¼šè·³å–®èº«
                row.addEventListener("dblclick", function() {
                    var url = row.getAttribute("data-url");
                    if(url) window.location = url;
                });
            });
        }

        function renderPagination(totalCount, pageSize, pageNumber) {
            const totalPages = Math.ceil(totalCount / pageSize);
            if (totalPages <= 1) {
                document.getElementById("paginationBar").innerHTML = "";
                return;
            }
            let html = '<nav><ul class="pagination justify-content-center">';
            html += `<li class="page-item ${pageNumber === 1 ? "disabled" : ""}">
                <a class="page-link" href="#" data-page="${pageNumber - 1}">ä¸Šä¸€é </a></li>`;

            let start = Math.max(1, pageNumber - 2);
            let end = Math.min(totalPages, pageNumber + 2);

            if (start > 2) {
                html += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
                html += `<li class="page-item"><a class="page-link" href="#" data-page="2">2</a></li>`;
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            } else {
                for (let i = 1; i < start; i++) {
                    html += `<li class="page-item"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
                }
            }

            for (let i = start; i <= end; i++) {
                html += `<li class="page-item ${i === pageNumber ? "active" : ""}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
            }

            if (end < totalPages - 2) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                html += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages - 1}">${totalPages - 1}</a></li>`;
                html += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
            } else {
                for (let i = end + 1; i <= totalPages; i++) {
                    html += `<li class="page-item"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
                }
            }
            html += `<li class="page-item ${pageNumber === totalPages ? "disabled" : ""}">
                <a class="page-link" href="#" data-page="${pageNumber + 1}">ä¸‹ä¸€é </a></li>`;
            html += '</ul></nav>';

            document.getElementById("paginationBar").innerHTML = html;

            // ç¶å®šäº‹ä»¶
            document.querySelectorAll('#paginationBar a[data-page]').forEach(a => {
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    let targetPage = parseInt(this.getAttribute('data-page'));
                    if (!isNaN(targetPage) && targetPage > 0) {
                        doQuery(targetPage); // ç”¨ AJAX æŸ¥æ–°é 
                    }
                });
            });

        }
        // ä½ å¯è¨˜éŒ„ç•¶å‰æŸ¥è©¢æ¢ä»¶ï¼Œä»¥ä¾¿æŸ¥ä¸‹ä¸€é æ™‚é‡ç”¨


        function doQuery(page = 1) {
            // ä»¥ lastQueryFilters ç•¶ä½œæŸ¥è©¢æ¢ä»¶ï¼ˆå¦‚æœæ˜¯æŸ¥è©¢è¡¨å–®é€å‡ºæ™‚ä¹Ÿè¦åŒæ­¥æ›´æ–° lastQueryFiltersï¼‰
            let filters = lastQueryFilters.slice();
            // æ‰¾åˆ°ä¸¦æ›´æ–° page/pageSize
            let foundPage = false, foundPageSize = false;
            filters.forEach(f => {
                if (f.Field === "page") { f.Value = String(page); foundPage = true; }
                if (f.Field === "pageSize") { f.Value = "@Model.PageSize"; foundPageSize = true; }
            });
            if (!foundPage) filters.push({ Field: "page", Op: "", Value: String(page) });
            if (!foundPageSize) filters.push({ Field: "pageSize", Op: "", Value: "@Model.PageSize" });

            saveQueryState(filters, page);

            fetch('/api/PagedQuery/PagedQuery', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    table: window._tableName,    // â† æŒ‡å®šä½ æŸ¥å“ªå€‹è¡¨
                    filters: filters           // â† åŸæœ¬çµ„å¥½çš„æŸ¥è©¢æ¢ä»¶
                })
            }).then(resp => resp.json())
            .then(result => {
                window._lookupMapData = result.lookupMapData;   // <--- å¿…åŠ é€™è¡Œ
                renderTable(result.data);
                renderPagination(result.totalCount, @Model.PageSize, page);
                renderOrderCount(result.totalCount, @Model.PageSize, page);
            });
        }

        function renderOrderCount(totalCount, pageSize, pageNumber) {
            const start = (pageNumber - 1) * pageSize + 1;
            const end = Math.min(pageNumber * pageSize, totalCount);
            document.getElementById('orderCountInfo').innerHTML = `å…± <span style="font-weight:bold">${totalCount}</span> ç­†ï¼Œé¡¯ç¤ºç¬¬ ${start} ~ ${end} ç­†`;
        }

        function restoreSearchForm(filters) {
            if (!filters) return;
            filters.forEach(f => {
                if (f.Field !== "page" && f.Field !== "pageSize") {
                    // åŒæ™‚æ‰¾å¤šçµ„ CustomerId5, CustomerId6 ... input
                    let inputEls = document.querySelectorAll(`#searchForm [name^='${f.Field}']`);
                    inputEls.forEach(el => {
                        // åªå¸¶ç©ºå€¼æ‰å¡«
                        if (!el.value) el.value = f.Value;
                    });
                }
                let condEls = document.querySelectorAll(`#searchForm [name^='Cond_${f.Field}']`);
                condEls.forEach(condEl => {
                    if (condEl && f.Op) condEl.value = f.Op;
                });
            });
        }

        function highlightLastViewedRow() {
            const lastPaperNum = localStorage.getItem("lastViewedPaperNum");
            //console.log('highlight row', lastPaperNum); // â†çœ‹æœ‰æ²’æœ‰æŠ“åˆ°
            if (!lastPaperNum) return;

            const tr = document.querySelector(`tr[data-paper-num="${lastPaperNum}"]`);
            if (tr) {
                tr.classList.add('selected');
                tr.scrollIntoView({ behavior: "smooth", block: "center" });
            }
            // æ¸…æ‰é¿å…ä¸‹æ¬¡åˆ highlight
            localStorage.removeItem("lastViewedPaperNum");
        }


        // æª¢æŸ¥ localStorage æœ‰æŸ¥è©¢æ¢ä»¶å°±è‡ªå‹•æŸ¥è©¢ï¼Œå¦å‰‡é¡¯ç¤ºåˆå§‹
        const { filters, pageNumber } = loadQueryState();
        if (filters && filters.length > 0) {
            lastQueryFilters = filters;
            restoreSearchForm(filters);  // é‚„åŸæŸ¥è©¢è¡¨å–®
            doQuery(pageNumber || 1);
        } else {
            renderTable(@Html.Raw(Json.Serialize(Model.Items)));
        }

    });

    // List é ï¼šé»ä¿®æ”¹ â†’ è·³è½‰å‰æª¢æŸ¥
    btnViewEditToggle.addEventListener("click", () => {
        const id = window.selectedPaperNum;
        if (!id) {
            Swal.fire({ icon: 'warning', title: 'è«‹å…ˆé¸æ“‡ä¸€ç­†å–®æ“š' });
            return;
        }

        const row = document.querySelector(`tr[data-paper-num="${id}"]`);
        const status = row?.querySelector("td:nth-child(6)")?.textContent.trim() || '';

        if (window.BLOCK_STATUSES && window.BLOCK_STATUSES.includes(status)) {
            Swal.fire({
                icon: 'warning',
                title: 'ç„¡æ³•ä¿®æ”¹',
                text: `æ­¤å–®æ“šç‹€æ…‹ç‚ºã€Œ${status}ã€ï¼Œä¸å¯é€²è¡Œä¿®æ”¹ã€‚`
            });
            return; // é˜»æ­¢è·³è½‰
        }

        const url = detailRouteTemplate.replace("{PaperNum}", id);
        window.location.href = url;
    });
    
    
    window.addEventListener('pageshow', function (event) {
        if (event.persisted || (window.performance && window.performance.getEntriesByType("navigation")[0]?.type === "back_forward")) {
            //location.reload();
        }
    });


</script>

