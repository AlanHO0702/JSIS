@using PcbErpApi.Models
@model dynamic

@{
    var fields = ViewData["Fields"] as List<TableFieldViewModel>;
    if (fields == null) { <text>æŸ¥ç„¡æ¬„ä½è¨­å®š</text>; return; }
    var items = Model.Items;
    var totalCount = Model.TotalCount;
    var pageNumber = Model.PageNumber;
    var pageSize = Model.PageSize;
    var subRouteTemplate = ViewData["SubRouteTemplate"] as string ?? "";
    var paginationVm = ViewData["PaginationVm"] as PaginationModel;
    // æ–°å¢APIè·¯å¾‘èˆ‡å–®èº«é è·¯å¾‘
    var addApiUrl = ViewData["AddApiUrl"] as string ?? "/api/SPOdOrderMain";
    var detailRouteTemplate = ViewData["SubRouteTemplate"] as string ?? "/SpodOrderSubs/{PaperNum}";
    var lookupMapData = ViewData["LookupDisplayMap"] as Dictionary<string, Dictionary<string, string>>;
    var keyFieldName = ViewData["KeyFieldName"]?.ToString() ?? "PaperNum";
    var tableName = ViewData["DictTableName"]?.ToString() ?? "SPOdOrderMain";
}
<script>
    window._tableName = "@tableName";
    window._tableFields = @Html.Raw(Json.Serialize(fields));
    window._lookupMapData = @Html.Raw(Json.Serialize(lookupMapData ?? new Dictionary<string, Dictionary<string, string>>()));
    window._keyFieldName = "@keyFieldName";
    window._detailRouteTemplate = "@detailRouteTemplate";
</script>

<style>
    /* åƒ…å½±éŸ¿æ¸…å–®é ï¼Œé¿å…è¦†è“‹è¾­å…¸/å…¶ä»– modal çš„ bootstrap .table æ¨£å¼ */
    .table-list-page { background: #f7f9fb; min-height: 100vh; }
    .table-list-page .container { max-width: 100%; }
    .table-list-page .title-row { display: flex; justify-content: space-between; align-items: flex-end; }
    .table-list-page .order-count { font-size: var(--field-value-size); color: #666; margin-bottom: 6px; }
    .table-list-page .table { box-shadow: 0 2px 12px 0 #c3d4e6; border-radius: 16px; overflow: hidden; background: #fff; }
    .table-list-page .table th, .table-list-page .table td {
        vertical-align: middle !important;
        white-space: nowrap;
        border: none;
        border-right: 1px solid #e3ebf6;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 300px;
    }
    .table-list-page .table th:first-child, .table-list-page .table td:first-child { border-left: 1px solid #e3ebf6; }
    .table-list-page .table th {
        background: linear-gradient(90deg, #e8f2fe 0%, #f3f8ff 100%);
        color: #2056ac; letter-spacing: 2px; font-weight: 600; font-size: var(--field-label-size);
        border-bottom: 2px solid #bdd2f7; padding: 2px 10px;
    }
    .table-list-page .table td { font-size: var(--field-value-size); }
    .table-list-page .table tbody tr { transition: background .15s; }
    .table-list-page .table tbody tr:hover { background: #f0f8ff !important; }
    .table-list-page .table td { border-top: 1px solid #f0f3f7 !important; padding: 2px 10px; }
    .table-list-page .status-done { color: #29963b; background: #e5f7e6; border-radius: 8px; padding: 2px 10px; font-weight: bold; letter-spacing: 1px; font-size: 1.05em;}
    .table-list-page .status-pending { color: #c88400; background: #fff9e3; border-radius: 8px; padding: 2px 10px; font-weight: bold; letter-spacing: 1px; font-size: 1.05em;}
    .table-list-page .row-link { cursor: pointer; }
    .table-list-page .pagination-bar { margin: 20px 0 30px 0; }
    .table-list-page .pagination .page-link { color: #3a72d9; border-radius: 6px !important; margin: 0 2px; }
    .table-list-page .pagination .page-item.active .page-link { background: #3a72d9; color: #fff; border: none; }
    .table-list-page .pagination .page-item.disabled .page-link { color: #aaa; pointer-events: none; background: #f1f4f8; }
    .table-list-page .table-wrap {
        max-width: 100%; /* ä¸æœƒè¶…écontainerå¯¬ */
        overflow-x: auto; /* è¶…éå¯¬åº¦è‡ªå‹•å‡ºç¾æ©«å‘æ²è»¸ */
        margin: 0 auto; /* æ°´å¹³ç½®ä¸­ */
        background: #fff; /* å¯è¦–éœ€æ±‚ */
        border-radius: 16px;
        box-shadow: 0 2px 12px 0 #c3d4e6;
    }
    .table-list-page .table {
        min-width: 1200px; /* æœ€å°å¯¬ï¼Œæ ¹æ“šæ¬„ä½æ•¸é‡èª¿æ•´ */
        margin-bottom: 0;
    }
    .table-list-page tr.selected td, .table-list-page tr.selected:hover td {
        background-color: #ffe6e6 !important;
    }
    .table-list-page .highlight { background-color: #ffd !important; }
    .table-list-page .ghost { opacity: 0.5; }
    .table-list-page #search-panel {
    background: #f8fafb;
    border-radius: 10px;
    padding: 14px 18px;
    margin-top: 12px;
    margin-bottom: 18px;
    box-shadow: 0 2px 6px 0 #e2e8f0;
    }
    .table-list-page #search-panel label {
        margin-bottom: 2px;
        font-size: 0.93em;
        color: #286bb5;
    }
    .table-list-page .table-hscroll-proxy{
    position: sticky; /* é»åœ¨è¦–çª—é ‚ç«¯ */
    top: 0;               /* å¦‚æœä¸Šé¢æœ‰å›ºå®šå·¥å…·åˆ—ï¼Œæ”¹æˆç›¸å°é«˜åº¦ */
    z-index: 100; /* æ¯”è¡¨é ­æ›´é«˜ï¼Œé¿å…è¢«è“‹ä½ */
    background: #fff;     /* çœ‹èµ·ä¾†ä¹¾æ·¨ */
    }

    .table-list-page .hscroll-track{
    height: 14px;
    overflow-x: auto;
    overflow-y: hidden;
    scrollbar-gutter: stable both-edges; /* ç•™å‡ºæ»¾å‹•æ¢ç©ºé–“ï¼Œé¿å…å¿½éš±å¿½ç¾ */
    border-bottom: 1px solid #eaeef4;
    }

    .table-list-page .hscroll-spacer{ height: 1px; }  /* åªè² è²¬æ’å¯¬åº¦ */

    .table-list-page .toolbar-count-box{
        display: inline-flex;
        justify-content: center;
        align-items: center;
        height: var(--top-toolbar-btn-height, 36px);
        min-width: 74px;
        padding: 2px 8px;
        border-radius: 6px;
        font-weight: 700;
        line-height: 1.05;
        color: #fff;
        background: #1e4db7;
        user-select: none;
    }
    .table-list-page .toolbar-count-box.mode-edit,
    .table-list-page .toolbar-count-box.mode-view{
        background: #1e4db7;
    }
    .table-list-page #toolbarDetailCount{
        display: none;
    }
</style>

<div class="table-list-page">
<div class="container my-3">
    <div class="title-row mb-2 border-bottom pb-2">
        <div style="display:flex;align-items:center;gap:16px;">
            <h2 class="mb-0 text-primary" style="font-weight:700;letter-spacing:3px;">@ViewData["TableTitle"]</h2>
            @await Html.PartialAsync("_TableToolbar", new TableToolbarModel {
                SearchBtnId = "btnSearch",
                AddBtnId = "btnAddNew",
                DeleteBtnId = "btnBatchDelete",
                QueryFields = ViewData["QueryFields"] as List<QueryFieldViewModel> ?? new List<QueryFieldViewModel>(),
                ModalId = "searchModal",
                ReportSpName = ViewData["ReportSpName"]?.ToString() ?? "" 
            })
        </div>
        <span class="order-count" id="orderCountInfo">
             å…± <span style="font-weight:bold">@Model.TotalCount</span> ç­†ï¼Œ
            é¡¯ç¤ºç¬¬ @(((Model.PageNumber - 1) * Model.PageSize) + 1)
            ~ @(Math.Min(Model.PageNumber * Model.PageSize, Model.TotalCount)) ç­†
        </span>
    </div>

    <div class="table-hscroll-proxy" id="tableHScrollTop">
    <div class="hscroll-track" id="hscrollTop">
        <div class="hscroll-spacer" id="hscrollSpacer"></div>
    </div>
    </div>

    <div class="table-wrap">
        <table class="table table-hover align-middle text-center">
            <thead>
                <tr id="table-header-row">
                    @foreach (var field in fields)
                    {
                         <th class="sortable" draggable="true" data-field="@field.FieldName" data-serial="@field.SerialNum">
                            @(string.IsNullOrWhiteSpace(field.DisplayLabel) ? field.FieldName : field.DisplayLabel)
                        </th>
                    }
                </tr>
            </thead>
            <tbody id="dataTbody">
                </tbody>
        </table>
    <div class="pagination-bar" id="paginationBar"> 
        @if (paginationVm != null) { @await Html.PartialAsync("_Pagination", paginationVm) }
    </div>
</div>
</div>
</div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
  (function () {
    function pad2(n){ return String(n).padStart(2,'0'); }
    function toYYYYMMDD(input){
      if (!input) return input;

      if (input instanceof Date && !isNaN(input)) {
        return `${input.getFullYear()}-${pad2(input.getMonth()+1)}-${pad2(input.getDate())}`;
      }

      const s = String(input).trim();
      // 2025/10/15 æˆ– 2025.10.15 æˆ– 2025-10-15
      if (/^\d{4}[-/.]\d{1,2}[-/.]\d{1,2}$/.test(s)) {
        const [y, m, d] = s.split(/[-/.]/).map(Number);
        return `${y}-${pad2(m)}-${pad2(d)}`;
      }
      // 20251015
      if (/^\d{8}$/.test(s)) {
        return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
      }
      // å·²æ˜¯ yyyy-mm-dd(æˆ–å¾Œé¢æœ‰æ™‚é–“)
      if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);

      return input;
    }

    if (!window.normalizeForDateInput) {
      window.normalizeForDateInput = function (el, value) {
        const type = (el?.type || '').toLowerCase();
        const hint = (el?.dataset?.type || el?.dataset?.fieldType || el?.dataset?.field || '').toLowerCase();
        if (type === 'date' || hint.includes('date')) {
          return toYYYYMMDD(value);
        }
        if ((type === 'datetime-local' || hint.includes('datetime')) && typeof value === 'string') {
          const m = value.trim().match(/^(\d{4}[-/.]\d{1,2}[-/.]\d{1,2}|\d{8})\s+(\d{1,2}:\d{2})(?::\d{2})?$/);
          if (m) {
            const d = toYYYYMMDD(m[1]);
            const t = m[2].slice(0,5);
            return `${d}T${t}`;
          }
        }
        return value;
      };
    }
  })();
</script>

<script src="~/js/toolbarHandler.js?v=@DateTime.Now.Ticks"></script>

<script>
/* ========= 1) å…¨åŸŸè®Šæ•¸èˆ‡å¸¸ç”¨å‡½å¼ ========= */

let selectedPaperNum = null;
const addApiUrl = '@addApiUrl';
const detailRouteTemplate = '@detailRouteTemplate';
const http = (url, init, msg) =>
  (window.busyFetch ? window.busyFetch(url, init, msg) : fetch(url, init));

function saveQueryState(filters, pageNumber) {
  const tn = String(window._tableName || '').trim().toLowerCase();
  const fk = tn ? `orderListQueryFilters:${tn}` : "orderListQueryFilters";
  const pk = tn ? `orderListPageNumber:${tn}` : "orderListPageNumber";

  localStorage.setItem(fk, JSON.stringify(filters));
  localStorage.setItem(pk, String(pageNumber));
  if (tn) localStorage.setItem(`orderListQueryTable:${tn}`, tn);
  // legacy fallback
  localStorage.setItem("orderListQueryFilters", JSON.stringify(filters));
  localStorage.setItem("orderListPageNumber", String(pageNumber));
  if (tn) localStorage.setItem("orderListQueryTable", tn);
}

function loadQueryState() {
  const tn = String(window._tableName || '').trim().toLowerCase();
  const fk = tn ? `orderListQueryFilters:${tn}` : "orderListQueryFilters";
  const pk = tn ? `orderListPageNumber:${tn}` : "orderListPageNumber";

  let filtersStr = localStorage.getItem(fk);
  let pageStr = localStorage.getItem(pk);
  
  if ((!filtersStr || filtersStr === 'null') && tn) {
    const legacyTable = (localStorage.getItem("orderListQueryTable") || '').toLowerCase();
    const legacy = legacyTable === tn ? localStorage.getItem("orderListQueryFilters") : null;
    if (legacy) {
      filtersStr = legacy;
      try { localStorage.setItem(fk, legacy); } catch {}
      try { localStorage.setItem(`orderListQueryTable:${tn}`, tn); } catch {}
    }
  }
  if ((!pageStr || pageStr === 'null') && tn) {
    const legacyTable = (localStorage.getItem("orderListQueryTable") || '').toLowerCase();
    const legacyP = legacyTable === tn ? localStorage.getItem("orderListPageNumber") : null;
    if (legacyP) {
      pageStr = legacyP;
      try { localStorage.setItem(pk, legacyP); } catch {}
    }
  }
  return {
    filters: filtersStr ? JSON.parse(filtersStr) : null,
    pageNumber: pageStr ? parseInt(pageStr) : null
  };
}

const DATE_RE = /^\d{4}-\d{2}-\d{2}$/;

function looksLikeDateField(el) {
  const t  = (el?.getAttribute('type') || '').toLowerCase();
  const n  = (el?.name || '').toLowerCase();
  const df = (el?.dataset?.field || '').toLowerCase();
  const ph = (el?.placeholder || '').toLowerCase();
  return t === 'date' || n.includes('date') || df.includes('date') || ph.includes('yyyy');
}

function normalizeForInput(el, val) {
  if (val == null) return val;
  let s = String(val).trim();
  if (!looksLikeDateField(el)) return s;
  if (/^\d{4}\/\d{2}\/\d{2}$/.test(s)) return s.replace(/\//g, '-');
  if (/^\d{8}$/.test(s))               return s.slice(0,4)+'-'+s.slice(4,6)+'-'+s.slice(6);
  if (/^\d{4}-\d{2}-\d{2}/.test(s))    return s.slice(0,10);
  return s;
}

const needDrop = v => typeof v === 'string' && /select\s|\bgetdate\b|\bdateadd\b/i.test(v);

let lastQueryFilters = [];
let currentPage = 1;

// ğŸ”¥ [å„ªåŒ–æ ¸å¿ƒ] å…¨åŸŸ Cursor å¿«å– (Greedy Cache)
// æ ¼å¼: { [pageNumber]: { cursorDate, cursorKey, direction } }
// åªè¦æŒ‰éæœå°‹(æ¢ä»¶æ”¹è®Š)å°±æ¸…ç©ºï¼›å¦å‰‡åœ¨æ›é éç¨‹ä¸­æŒçºŒç´¯ç©
let pageCursorCache = {};

if (typeof CSS === 'undefined' || typeof CSS.escape !== 'function') {
  window.CSS = window.CSS || {};
  CSS.escape = s => String(s).replace(/([^\w-])/g, '\\$1');
}

/* ========= 2) é‚„åŸæŸ¥è©¢æ¢ä»¶ ========= */
function restoreSearchFormSafe(formEl, saved) {
  if (!formEl) return;
  try { if (typeof saved === 'string') saved = JSON.parse(saved); } catch { saved = null; }
  if (!Array.isArray(saved) || !saved.length) return;

  const byKey = Object.create(null);
  const byField = Object.create(null);
  saved.forEach(f => {
    if (!f) return;
    if (f.Key) byKey[f.Key] = f;
    const fld = f.Field || '';
    if (!byField[fld]) byField[fld] = [];
    byField[fld].push(f);
  });
  const valueEls = Array.from(
    formEl.querySelectorAll('[name]:not([name^="Cond_"]):not([type="hidden"])')
  );

  const namePos = Object.create(null);
  valueEls.forEach(el => {
    const name = el.name;
    if (!name || name === '__RequestVerificationToken') return;
    const idx = namePos[name] = (namePos[name] ?? 0);
    namePos[name]++;

    let hit = byKey[`${name}#${idx}`] ||
              (byField[name] && byField[name][idx]) ||
              (el.dataset.field && byField[el.dataset.field] && byField[el.dataset.field][idx]) ||
              (byField[name] && byField[name][0]);

    if (!hit) return;

    const v = (typeof window.normalizeForDateInput === 'function')
      ? window.normalizeForDateInput(el, hit.Value) : hit.Value;
    if (el.type === 'date') {
      if (DATE_RE.test(String(v))) el.value = v;
    } else {
      if (v != null) el.value = v;
    }

    const condList = formEl.querySelectorAll(`[name="${CSS.escape('Cond_' + name)}"]`);
    if (condList && condList.length > idx && hit.Op != null) {
      condList[idx].value = hit.Op;
    }
  });
}

/* ========= 3) è¡¨æ ¼ç¹ªè£½/æ›é  ========= */
function pad2(n){ return String(n).padStart(2, '0'); }
function normalizeDateString(input){
  if (input == null) return '';
  let s = String(input).trim();
  if (/^\d{4}\/\d{1,2}\/\d{1,2}/.test(s)) s = s.replace(/\//g, '-');
  if (/^\d{4}-\d{2}-\d{2}\s+\d{1,2}:\d{2}/.test(s)) s = s.replace(' ', 'T');
  return s;
}
function formatDateValue(raw, formatStr){
  if (raw == null) return '';
  const fmt = (formatStr || '').toLowerCase();
  const iso = normalizeDateString(raw);
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return String(raw);

  const yyyy = d.getFullYear();
  const MM = pad2(d.getMonth() + 1);
  const dd = pad2(d.getDate());
  const sep = (formatStr || '').includes('/') ? '/' : '-';
  let out = `${yyyy}${sep}${MM}${sep}${dd}`;
  const wantsTime = (formatStr || '').includes(':') || /(hh|nn|ss)/i.test(formatStr || '');
  if (wantsTime) {
    const HH = pad2(d.getHours());
    const mi = pad2(d.getMinutes());
    const ss = pad2(d.getSeconds());
    if (fmt.includes('ss')) out += ` ${HH}:${mi}:${ss}`;
    else out += ` ${HH}:${mi}`;
  }
  return out;
}
function formatCell(field, raw){
  const dt = (field?.DataType || '').toLowerCase();
  if (raw == null) return '';
  if (dt.includes('date') || dt.includes('time')) {
    return formatDateValue(raw, field?.FormatStr || '');
  }
  if (dt === 'number' && typeof raw === 'number') return raw.toLocaleString();
  return typeof raw === 'string' ? raw : String(raw);
}

function renderTable(data) {
  const tbody = document.getElementById('dataTbody');
  tbody.innerHTML = "";
  const fields = window._tableFields;
  const lookupMapData = window._lookupMapData;
  const keyFieldName = window._keyFieldName;
  const subRouteTemplate = "@(detailRouteTemplate)";
  
  data.forEach(item => {
    const keyValue = item[keyFieldName] || "";
    let rowUrl = "";
    if (subRouteTemplate && keyValue) rowUrl = subRouteTemplate.replace("{PaperNum}", keyValue);

    const tr = document.createElement('tr');
    tr.className = "row-link";
    tr.setAttribute('data-url', rowUrl);
    tr.setAttribute('data-paper-num', keyValue);

    fields.forEach(field => {
      let valStr = "";
      if (keyValue && lookupMapData?.[keyValue]?.[field.FieldName]) {
        valStr = lookupMapData[keyValue][field.FieldName];
      } else {
         let raw = item[field.FieldName];
        valStr = formatCell(field, raw);
      }
      const td = document.createElement('td');
      td.innerHTML = valStr ?? "";

      // æ ¹æ“šè¾­å…¸çš„ FieldLen è¨­å®šæ¬„ä½å¯¬åº¦
      if (field.FieldLen && field.FieldLen > 0) {
        const width = Math.min(field.FieldLen * 10, 300); // æ¯å€‹å­—å…ƒç´„ 10pxï¼Œæœ€å¤§ 300px
        td.style.maxWidth = `${width}px`;
        td.style.minWidth = `${Math.min(width, 60)}px`; // æœ€å°å¯¬åº¦ 60px
      }

      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  
  highlightLastViewedRow();

  document.querySelectorAll(".row-link").forEach(row => {
    row.addEventListener("click", () => {
      document.querySelectorAll(".row-link.selected").forEach(r => r.classList.remove("selected"));
      row.classList.add("selected");
      window.selectedPaperNum = row.getAttribute("data-paper-num");
      updateToolbarHeaderCountForRow(row);
    });
    row.addEventListener("dblclick", () => {
      const url = row.getAttribute("data-url");
      if (url) window.location = url;
    });
  });
  if (window.refreshHScrollWidth) window.refreshHScrollWidth();
}

function renderPagination(totalCount, pageSize, pageNumber) {
  const totalPages = Math.ceil(totalCount / pageSize);
  if (totalPages <= 1) { document.getElementById("paginationBar").innerHTML = ""; return; }

  let html = '<nav><ul class="pagination justify-content-center">';
  // ä¸Šä¸€é æŒ‰éˆ•
  html += `<li class="page-item ${pageNumber === 1 ? "disabled" : ""}">
            <a class="page-link" href="#" data-page="${pageNumber - 1}" data-direction="prev">ä¸Šä¸€é </a></li>`;
            
  let start = Math.max(1, pageNumber - 2);
  let end   = Math.min(totalPages, pageNumber + 2);
  
  if (start > 2) {
    html += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
    html += `<li class="page-item"><a class="page-link" href="#" data-page="2">2</a></li>`;
    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
  } else {
    for (let i = 1; i < start; i++) {
      html += `<li class="page-item"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
    }
  }

  for (let i = start; i <= end; i++) {
    html += `<li class="page-item ${i === pageNumber ? "active" : ""}">
              <a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
  }

  if (end < totalPages - 2) {
    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    html += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages - 1}">${totalPages - 1}</a></li>`;
    html += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
  } else {
    for (let i = end + 1; i <= totalPages; i++) {
      html += `<li class="page-item"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
    }
  }

  // ä¸‹ä¸€é æŒ‰éˆ•
  html += `<li class="page-item ${pageNumber === totalPages ? "disabled" : ""}">
            <a class="page-link" href="#" data-page="${pageNumber + 1}" data-direction="next">ä¸‹ä¸€é </a></li>`;
  html += '</ul></nav>';

  document.getElementById("paginationBar").innerHTML = html;

  document.querySelectorAll('#paginationBar a[data-page]').forEach(a => {
    a.addEventListener('click', e => {
      e.preventDefault();
      const targetPage = parseInt(a.getAttribute('data-page'));
      const direction = a.getAttribute('data-direction'); 
      if (!isNaN(targetPage) && targetPage > 0) {
        doQuery(targetPage, direction);
      }
    });
  });
}

function renderOrderCount(totalCount, pageSize, pageNumber) {
  const start = (pageNumber - 1) * pageSize + 1;
  const end   = Math.min(pageNumber * pageSize, totalCount);
  document.getElementById('orderCountInfo').innerHTML =
    `å…± <span style="font-weight:bold">${totalCount}</span> ç­†ï¼Œé¡¯ç¤ºç¬¬ ${start} ~ ${end} ç­†`;
  const headerCountEl = document.getElementById('toolbarHeaderCount');
  if (headerCountEl) {
    headerCountEl.textContent = totalCount > 0 ? `${start}/${totalCount}` : '--/--';
  }
  try {
    const tn = String(window._tableName || '').trim().toLowerCase();
    if (tn) {
      localStorage.setItem(`orderListQueryTotal:${tn}`, String(totalCount));
      localStorage.setItem(`orderListQueryPageStart:${tn}`, String(start));
    }
  } catch {}
}

function updateToolbarHeaderCountForRow(row) {
  const headerCountEl = document.getElementById('toolbarHeaderCount');
  if (!headerCountEl || !row) return;
  const tn = String(window._tableName || '').trim().toLowerCase();
  const total = parseInt(localStorage.getItem(`orderListQueryTotal:${tn}`) || '0', 10);
  const pageStart = parseInt(localStorage.getItem(`orderListQueryPageStart:${tn}`) || '1', 10);

  const tbody = row.closest('tbody');
  if (!tbody) return;
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const idx = rows.indexOf(row);
  if (idx < 0 || total <= 0) return;

  const currentIndex = pageStart + idx;
  headerCountEl.textContent = `${currentIndex}/${total}`;
  try { if (tn) localStorage.setItem(`orderListQueryIndex:${tn}`, String(currentIndex)); } catch {}
}

// direction: 'next' | 'prev' | null (null = è·³é )
function doQuery(page = 1, direction = null) {
  const t0 = performance.now();
  let filters = lastQueryFilters.map(f => ({ ...f }));
  let hasPage = false, hasSize = false;
  const itemId = (window._itemId || window._singleItemId || '').toString().trim();
  const tableName = (window._tableName || '').toLowerCase();

  filters.forEach(f => {
    const fieldLower = (f.Field || '').toLowerCase();
    if (fieldLower === "page")     { f.Value = String(page); hasPage = true; }
    if (fieldLower === "pagesize") { f.Value = "@Model.PageSize"; hasSize = true; }
  });
  if (!hasPage) filters.push({ Field: "page", Op: "", Value: String(page) });
  if (!hasSize) filters.push({ Field: "pageSize", Op: "", Value: "@Model.PageSize" });
  saveQueryState(filters, page);

  const url = new URL(window.location.href);
  if (page > 1) url.searchParams.set('page', page);
  else url.searchParams.delete('page');
  history.replaceState(null, '', url.toString());

  // æª¢æŸ¥ sessionStorage æ˜¯å¦å·²æœ‰ lookup å¿«å–ï¼ˆé—œé–‰åˆ†é æ‰æœƒæ¶ˆå¤±ï¼‰
  // ä½†å¦‚æœæŸ¥è©¢æ¢ä»¶æ”¹è®Šï¼Œéœ€è¦æ¸…é™¤å¿«å–ä»¥é‡æ–°è¼‰å…¥ lookup è³‡æ–™
  const lookupCacheKey = `lookupCache:${tableName}`;
  const lookupFiltersKey = `lookupFilters:${tableName}`;
  const currentFiltersHash = JSON.stringify(filters.filter(f => f.Field !== 'page' && f.Field !== 'pageSize').sort((a, b) => a.Field.localeCompare(b.Field)));
  const cachedFiltersHash = sessionStorage.getItem(lookupFiltersKey);

  let skipLookup = false;
  if (cachedFiltersHash === currentFiltersHash) {
    // æŸ¥è©¢æ¢ä»¶ç›¸åŒï¼Œå¯ä»¥ä½¿ç”¨å¿«å–
    const cachedLookup = sessionStorage.getItem(lookupCacheKey);
    skipLookup = !!cachedLookup && !!window._lookupMapData;
  } else {
    // æŸ¥è©¢æ¢ä»¶æ”¹è®Šï¼Œæ¸…é™¤èˆŠå¿«å–
    sessionStorage.removeItem(lookupCacheKey);
    sessionStorage.removeItem(lookupFiltersKey);
  }

  http('/api/DynamicTable/PagedQuery', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(requestBody)
  }, 'è®€å–è³‡æ–™ä¸­â€¦')
    .then(r => r.json())
    .then(result => {
      // Lookup Cache è™•ç†
      if (result.lookupMapData && Object.keys(result.lookupMapData).length > 0) {
        window._lookupMapData = result.lookupMapData;
        sessionStorage.setItem(lookupCacheKey, '1');
        sessionStorage.setItem(lookupFiltersKey, currentFiltersHash);
      }
      if (skipLookup && (!window._lookupMapData || Object.keys(window._lookupMapData).length === 0)) {
        sessionStorage.removeItem(lookupCacheKey);
        sessionStorage.removeItem(lookupFiltersKey);
      }

      // ğŸ”¥ [æ ¸å¿ƒé‚è¼¯] è²ªå©ªå„²å­˜ Cursor
      // result.nextCursor æ˜¯ã€Œç¬¬ page é çš„çµå°¾ã€ï¼Œä¹Ÿå°±æ˜¯ã€Œå» page+1 çš„é‘°åŒ™ã€(æ–¹å‘ next)
      if (result.nextCursor && (result.nextCursor.date || result.nextCursor.key)) {
          pageCursorCache[page + 1] = {
              cursorDate: result.nextCursor.date,
              cursorKey: result.nextCursor.key,
              direction: 'next'
          };
      }
      // result.prevCursor æ˜¯ã€Œç¬¬ page é çš„é–‹é ­ã€ï¼Œä¹Ÿå°±æ˜¯ã€Œå» page-1 çš„é‘°åŒ™ã€(æ–¹å‘ prev)
      if (result.prevCursor && (result.prevCursor.date || result.prevCursor.key)) {
          pageCursorCache[page - 1] = {
              cursorDate: result.prevCursor.date,
              cursorKey: result.prevCursor.key,
              direction: 'prev'
          };
      }
      
      currentPage = page;

      const t1 = performance.now();
      renderTable(result.data);
      const renderTime = (performance.now() - t1).toFixed(0);
      renderPagination(result.totalCount, @Model.PageSize, page);
      renderOrderCount(result.totalCount, @Model.PageSize, page);

      const totalTime = (performance.now() - t0).toFixed(0);
      const networkTime = result.serverTiming ? (totalTime - renderTime - result.serverTiming.totalMs) : 0;

      const st = result.serverTiming || {};
      console.log(
        `[åˆ†é æŸ¥è©¢] ${window._tableName} ç¬¬${page}é \n` +
        `  â”œâ”€ å¾Œç«¯ Count:  ${st.countMs ?? '-'}ms\n` +
        `  â”œâ”€ å¾Œç«¯ Data:   ${st.dataMs ?? '-'}ms ${st.useKeyset ? '(Keyset)' : '(OFFSET)'}\n` +
        `  â”œâ”€ å¾Œç«¯ Lookup: ${st.lookupMs ?? '-'}ms ${st.skipLookup ? '(è·³é)' : ''}\n` +
        `  â”œâ”€ å¾Œç«¯ Total:  ${st.totalMs ?? '-'}ms\n` +
        `  â”œâ”€ ç¶²è·¯å‚³è¼¸:    ~${Math.max(0, networkTime).toFixed(0)}ms\n` +
        `  â”œâ”€ å‰ç«¯æ¸²æŸ“:    ${renderTime}ms\n` +
        `  â””â”€ ç¸½è¨ˆ:        ${totalTime}ms`
      );
    })
    .catch(err => {
      Swal.fire({ icon:'error', title:'æŸ¥è©¢å¤±æ•—', text: String(err) });
    });
}

function highlightLastViewedRow() {
  const lastPaperNum = localStorage.getItem("lastViewedPaperNum");
  if (!lastPaperNum) return;
  const tr = document.querySelector(`tr[data-paper-num="${lastPaperNum}"]`);
  if (tr) {
    tr.classList.add('selected');
    window.selectedPaperNum = lastPaperNum;
    tr.scrollIntoView({ behavior: "smooth", block: "center" });
  }
  localStorage.removeItem("lastViewedPaperNum");
}

/* ========= 4) DOMContentLoaded ========= */

document.addEventListener("DOMContentLoaded", function () {
  new ToolbarHandler({
    searchBtnId: "btnSearch",
    addBtnId: "btnAddNew",
    deleteBtnId: "btnBatchDelete",
    getSelectedId: () => {
      const selectedRow = document.querySelector("#dataTbody tr.selected");
      return selectedRow ? selectedRow.getAttribute("data-paper-num") : null;
    },
    modalId: "searchModal",
    formId: "searchForm",
    addApiUrl: "@addApiUrl",
    deleteApiUrlFn: (id) => `/api/${"@tableName"}/${id}`,
    paperAction: { url: '/api/PaperAction/DoAction', paperId: "@tableName", eoc: 0, aftFinished: 2 },
    detailRouteTemplate: "@(detailRouteTemplate)",
    tableName: "@tableName",
    pagedQueryUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewData["PagedQueryUrl"]?.ToString() ?? "/api/PagedQuery/PagedQuery")),
    pageSize: 50,
    renderTable,
    renderPagination,
    renderOrderCount,
    restoreSearchForm: restoreSearchFormSafe,
    queryRedirectUrl: null
  });

  const form = document.getElementById('searchForm');
  form?.addEventListener('submit', () => {
    const formSel = '#searchForm';
    const filters = [];
    const valueEls = Array.from(document.querySelectorAll(`${formSel} [name]:not([name^="Cond_"]):not([type="hidden"])`));
    const namePos = Object.create(null);

    valueEls.forEach(el => {
        const name = el.name;
        if (!name || name === '__RequestVerificationToken') return;
        const idx = namePos[name] = (namePos[name] ?? 0);
        namePos[name]++;

        let val = normalizeForInput(el, el.value);
        if (val == null || val === '') return;

        const condList = document.querySelectorAll(`${formSel} [name="${CSS.escape('Cond_' + name)}"]`);
        const op = (condList && condList.length > idx) ? (condList[idx].value || '') : '';

        filters.push({
          Key: `${name}#${idx}`,
          Field: el.dataset.field || name,
          Op: op,
          Value: val
        });
    });

    // ğŸ”¥ [ç‹€æ…‹é‡ç½®] æŒ‰ä¸‹æœå°‹ä»£è¡¨æ¢ä»¶è®Šæ›´ï¼Œå¿…é ˆæ¸…ç©º Cursor å¿«å–ï¼Œå¦å‰‡æœƒæ‹¿åˆ°èˆŠæ¢ä»¶çš„ Cursor
    pageCursorCache = {};
    console.log('[Search] æ¢ä»¶è®Šæ›´ï¼Œæ¸…é™¤åˆ†é å¿«å–');

    filters.push({ Field: 'page', Op: '', Value: '1' });
    filters.push({ Field: 'pageSize', Op: '', Value: String(@Model.PageSize) });

    lastQueryFilters = filters.slice();
    saveQueryState(lastQueryFilters, 1);
  });

  document.getElementById('searchModal')?.addEventListener('shown.bs.modal', () => {
      const formEl = document.getElementById('searchForm');
      const tn = String(window._tableName || '').trim().toLowerCase();
      const fk = tn ? `orderListQueryFilters:${tn}` : 'orderListQueryFilters';
      const saved = JSON.parse(localStorage.getItem(fk) || localStorage.getItem('orderListQueryFilters') || '[]');
      if (formEl && Array.isArray(saved) && saved.length) restoreSearchFormSafe(formEl, saved);
  });

  const headerRow = document.getElementById("table-header-row");
  if (headerRow && window.Sortable) {
    Sortable.create(headerRow, {
      animation: 150,
      swap: true,
      swapClass: 'highlight',
      ghostClass: 'ghost',
      onEnd: function () {
        const newOrder = Array.from(headerRow.children).map((th, index) => ({
          fieldName: th.dataset.field, serialNum: index + 1
        }));
        http('/api/TableFieldLayout/SaveSerialOrder', {
           method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tableName: window._tableName, fieldOrders: newOrder })
        }, 'å„²å­˜æ¬„ä½é †åºâ€¦')
          .then(res => { if (!res.ok) throw new Error("æ›´æ–°å¤±æ•—"); return res.json(); })
          .then(() => location.reload())
          .catch(() => Swal.fire({ icon: 'error', title: 'æ¬„ä½é †åºå„²å­˜å¤±æ•—ï¼' }));
      }
    });
  }

  const state = loadQueryState();
  const formEl = document.getElementById('searchForm');

  // æª¢æŸ¥ URL æ˜¯å¦æœ‰æŸ¥è©¢åƒæ•¸ï¼ˆå¾å–®èº«é æŸ¥è©¢è·³è½‰éä¾†ï¼‰
  const urlParams = new URLSearchParams(window.location.search);
  const urlPageParam = urlParams.get('page');
  const useStoredQuery = urlParams.get('useStoredQuery') === '1';
  const initialPage = urlPageParam ? parseInt(urlPageParam, 10) : 1;

  // ç²å–æŸ¥è©¢æ¬„ä½é…ç½®ï¼ˆç”¨æ–¼è®€å–é»˜èªæ¯”å°æ¢ä»¶ï¼‰
  const queryFieldsConfig = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewData["QueryFields"] as List<QueryFieldViewModel> ?? new List<QueryFieldViewModel>()));
  const queryFieldsMap = new Map();
  (queryFieldsConfig || []).forEach(f => {
    const colName = (f.columnName || f.ColumnName || '').toLowerCase();
    if (colName) {
      queryFieldsMap.set(colName, {
        defaultEqual: (f.defaultEqual || f.DefaultEqual || 'like').toString(),
        dataType: f.dataType || f.DataType
      });
    }
  });

  // å¾ URL æå–æŸ¥è©¢åƒæ•¸ï¼ˆæ’é™¤ page å’Œ pageSizeï¼‰
  const urlFilters = [];
  for (const [key, value] of urlParams.entries()) {
    if (key !== 'page' && key !== 'pageSize' && key !== 'useStoredQuery' && value) {
      const fieldConfig = queryFieldsMap.get(key.toLowerCase());
      const defaultOp = fieldConfig?.defaultEqual || 'like';
      urlFilters.push({
        Field: key,
        Op: defaultOp,  // ä½¿ç”¨æ¬„ä½é…ç½®ä¸­çš„é»˜èªæ¯”å°æ¢ä»¶
        Value: value,
        Key: `${key}#0`
      });
    }
  }

  // å„ªå…ˆä½¿ç”¨ URL åƒæ•¸ï¼Œå¦‚æœæœ‰çš„è©±
  let finalFilters = [];
  if (!useStoredQuery && urlFilters.length > 0) {
    // URL æœ‰æŸ¥è©¢åƒæ•¸ï¼Œä½¿ç”¨ URL åƒæ•¸ä¸¦ä¿å­˜åˆ° localStorage
    finalFilters = urlFilters;
    const tn = ("@tableName" || '').toString().trim().toLowerCase();
    const filterKey = tn ? `orderListQueryFilters:${tn}` : 'orderListQueryFilters';
    const filtersWithPaging = [
      ...urlFilters,
      { Field: 'page', Op: '', Value: '1' },
      { Field: 'pageSize', Op: '', Value: '50' }
    ];
    try {
      localStorage.setItem(filterKey, JSON.stringify(filtersWithPaging));
      localStorage.setItem('orderListQueryFilters', JSON.stringify(filtersWithPaging));
      // æ¸…é™¤ lookup å¿«å–ï¼Œå› ç‚ºæŸ¥è©¢æ¢ä»¶æ”¹è®Šäº†
      sessionStorage.removeItem(`lookupCache:${tn}`);
      sessionStorage.removeItem(`lookupFilters:${tn}`);
    } catch {}
  } else {
    // æ²’æœ‰ URL åƒæ•¸ï¼Œä½¿ç”¨ localStorage çš„æŸ¥è©¢æ¢ä»¶
    finalFilters = (state.filters || [])
      .filter(f => {
        if (!f) return false;
        const isDate = /date/i.test(String(f.Field || ''));
        return !(isDate && needDrop(f.Value)); // ç§»é™¤çœ‹èµ·ä¾†åƒ SQL çš„æ—¥æœŸå€¼
      })
      .map(f => {
        if (/date/i.test(String(f.Field || ''))) {
          f.Value = normalizeForDateInput({ type: 'date' }, f.Value);
        }
        return f;
      });
  }

  if (finalFilters.length) {
    lastQueryFilters = finalFilters;
    restoreSearchFormSafe(formEl, finalFilters);
    doQuery(initialPage);
  } else {
    if (urlPageParam && initialPage > 1) {
      doQuery(initialPage);
    } else {
      renderTable(@Html.Raw(Json.Serialize(Model.Items)));
      renderOrderCount(@Model.TotalCount, @Model.PageSize, @Model.PageNumber);
    }
  }

  document.getElementById('btnViewEditToggle')?.addEventListener('click', async () => {
    const id = window.selectedPaperNum;
    if (!id) return Swal.fire({ icon: 'warning', title: 'è«‹å…ˆé¸æ“‡ä¸€ç­†å–®æ“š' });
    const tableName = window._tableName || '@tableName';

    try {
      const checkResp = await fetch('/api/PaperAction/CheckCanEdit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          paperId: tableName,
          paperNum: id,
          itemId: window._itemId || '',
          userId: window._userId || localStorage.getItem('erpLoginUserId') || 'admin',
          useId: window._useId || 'A001'
        })
      });

      if (!checkResp.ok) {
        const errData = await checkResp.json().catch(() => ({}));
        return Swal.fire({ icon: 'error', title: 'æª¢æŸ¥å¤±æ•—', text: errData.message || 'ç„¡æ³•é©—è­‰ç·¨è¼¯æ¬Šé™' });
      }

      const result = await checkResp.json();

      const canEdit = result.CanEdit ?? result.canEdit;
      const message = result.Message ?? result.message;
      const requiresRejection = result.RequiresRejection ?? result.requiresRejection;
      const canAutoReject = result.CanAutoReject ?? result.canAutoReject;

      if (!canEdit && !requiresRejection) {
        return Swal.fire({ icon: 'warning', title: 'ç„¡æ³•ä¿®æ”¹', text: message });
      }
      if (!canEdit && requiresRejection && !canAutoReject) {
        return Swal.fire({ icon: 'warning', title: 'ç„¡æ³•ä¿®æ”¹', text: message });
      }
      if (requiresRejection) {
        sessionStorage.setItem('pendingEditCheck', JSON.stringify({
          paperNum: id,
          checkResult: result
        }));
      }

      const url = detailRouteTemplate.replace("{PaperNum}", id);
      window.location.href = url;
    } catch (error) {
      console.error('[åˆ—è¡¨é ä¿®æ”¹æŒ‰éˆ•] æª¢æŸ¥å–®æ“šç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      const url = detailRouteTemplate.replace("{PaperNum}", id);
      window.location.href = url;
    }
  });
});

(function initTopHScroll(){
  const wrap   = document.querySelector('.table-wrap');
  if (!wrap) return;
  const table  = wrap.querySelector('table');
  const topBar = document.getElementById('hscrollTop');
  const spacer = topBar?.querySelector('.hscroll-spacer');
  if (!table || !topBar || !spacer) return;

  function measure(){
    spacer.style.width = table.scrollWidth + 'px';
    topBar.scrollLeft = wrap.scrollLeft;
  }
  let syncing = false;
  topBar.addEventListener('scroll', () => {
    if (syncing) return; syncing = true; wrap.scrollLeft = topBar.scrollLeft; syncing = false;
  });
  wrap.addEventListener('scroll', () => {
    if (syncing) return; syncing = true; topBar.scrollLeft = wrap.scrollLeft; syncing = false;
  });
  window.addEventListener('resize', measure);
  window.refreshHScrollWidth = measure;
  measure();
})();
</script>