@model dynamic
@using PcbErpApi.Helpers
@using System.Text.Json
@using System.Collections.Generic
@using System.Linq
@using System.Globalization
@{
    // ÂñÆÈ†≠Ê¨Ñ‰Ωç
    var headerFields = Model.HeaderTableFields; // ÂèØË¶ñÊ¨Ñ‰Ωç
    var headerData = Model.HeaderData; // ÂñÆÈ†≠Ë≥áÊñô (Dictionary<string, object> Êàñ‰Ω†ÁöÑÂñÆÈ†≠Model)
    // ÂñÆË∫´
    var fields = Model.TableFields;
    var items = Model.Items;
    var tableTitle = ViewData["TableTitle"] as string ?? "";
    var showRowNumber = ViewData["ShowRowNumber"] as bool? ?? true;
    var headerFieldsList = ((IEnumerable<TableFieldViewModel>)Model.HeaderTableFields).ToList();
    var headerTabBaseLabel = ViewData["HeaderTableDisplayLabel"]?.ToString() ?? "ÂàÜÈ†Å";
    var addApiUrl = ViewData["AddApiUrl"]?.ToString() ?? "";
    var detailRouteTemplate = ViewData["SubRouteTemplate"]?.ToString() ?? "";
    var tableName = ViewData["DictTableName"]?.ToString() ?? "";
    var keyFieldName = ViewData["KeyFieldName"]?.ToString() ?? "PaperNum";
    var queryRedirectUrl = ViewData["QueryRedirectUrl"]?.ToString() ?? "";
    var DeleteApiUrl = ViewData["DeleteApiUrl"]?.ToString() ?? "";
    static int NormalizeShowWhere(int? v)
    {
        // Êúâ‰∫õÂñÆÊìöÂ≠óÂÖ∏ÁöÑ iShowWhere ÊúÉÊòØ 0Ôºà‰ª£Ë°®Á¨¨‰∏ÄÈ†ÅÔºâÔºåËã•ÈÅéÊøæÊúÉÂ∞éËá¥ÂñÆÈ†≠Êï¥ÊÆµÊ∂àÂ§±
        return (v.HasValue && v.Value > 0) ? v.Value : 1;
    }
    static bool IsNumberType(string? dt)
    {
        var t = (dt ?? "").Trim().ToLowerInvariant();
        if (string.IsNullOrEmpty(t)) return false;
        return t == "number"
            || t == "int" || t == "smallint" || t == "tinyint" || t == "bigint"
            || t.StartsWith("decimal") || t.StartsWith("numeric")
            || t.StartsWith("money") || t.StartsWith("smallmoney")
            || t.StartsWith("float") || t.StartsWith("real");
    }
    static bool IsNumberValue(object? raw)
    {
        if (raw == null) return false;
        if (raw is sbyte or byte or short or ushort or int or uint or long or ulong
            or float or double or decimal) return true;
        var s = raw.ToString();
        if (string.IsNullOrWhiteSpace(s)) return false;
        s = s.Replace(",", "");
        return decimal.TryParse(s, NumberStyles.Any, CultureInfo.InvariantCulture, out _)
            || decimal.TryParse(s, NumberStyles.Any, CultureInfo.CurrentCulture, out _);
    }
    static string NormalizeNumberByFormat(string? raw, string? formatStr)
    {
        if (string.IsNullOrWhiteSpace(raw) || string.IsNullOrWhiteSpace(formatStr)) return raw ?? "";
        var fmt = formatStr.Trim();
        if (!fmt.Contains("#")) return raw ?? "";
        var t = raw.Replace(",", "").Trim();
        if (!decimal.TryParse(t, NumberStyles.Any, CultureInfo.InvariantCulture, out var n) &&
            !decimal.TryParse(t, NumberStyles.Any, CultureInfo.CurrentCulture, out n))
            return raw ?? "";
        if (fmt.StartsWith(".")) fmt = "0" + fmt;
        return n.ToString(fmt);
    }
    static bool IsZeroNumberString(string? s)
    {
        if (string.IsNullOrWhiteSpace(s)) return false;
        var t = s.Replace(",", "").Trim();
        if (decimal.TryParse(t, NumberStyles.Any, CultureInfo.InvariantCulture, out var n)) return n == 0m;
        return decimal.TryParse(t, NumberStyles.Any, CultureInfo.CurrentCulture, out n) && n == 0m;
    }
    static string NormalizeEditColor(string? raw)
    {
        if (string.IsNullOrWhiteSpace(raw)) return "";
        var s = raw.Trim();
        if (s.StartsWith("cl", StringComparison.OrdinalIgnoreCase))
            s = s.Substring(2);
        return s;
    }
    static bool IsPartNumField(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return false;
        var normalized = name.Replace("_", "").Trim().ToLowerInvariant();
        return normalized.Contains("partnum");
    }

    var groupedTabs = headerFieldsList
        .GroupBy(f => NormalizeShowWhere(f.iShowWhere))
        .OrderBy(g => g.Key)
        .ToDictionary(g => g.Key, g => g.ToList());

    var firstTabKey = groupedTabs.Keys.FirstOrDefault();
    if (firstTabKey <= 0) firstTabKey = 1;
    int GetDetailColWidth(TableFieldViewModel c)
    {
        int? byFieldWidth = (c?.iFieldWidth != null && c.iFieldWidth > 0) ? c.iFieldWidth.Value : null;
        int? byDisplaySize = null;

        if (c?.DisplaySize != null && c.DisplaySize > 0)
        {
            // ‰ª•Â≠óÂÖÉÂØ¨Â∫¶‰º∞ÁÆóÔºàDisplaySize ÈÄöÂ∏∏ÊòØÂ≠óÂÖÉÊï∏Ôºâ
            var w = c.DisplaySize.Value * 14;
            byDisplaySize = Math.Min(520, Math.Max(30, w));
        }

        if (byFieldWidth.HasValue && byDisplaySize.HasValue)
        {
            // Ëã•ÂÖ©ËÄÖÈÉΩÊúâÔºåÊé°Áî®ËºÉÂ∞èËÄÖÔºåËÆì DisplaySize ÂèØ‰ª•ÊääÊ¨Ñ‰ΩçÁ∏ÆÂ∞è
            return Math.Min(Math.Min(520, Math.Max(30, byFieldWidth.Value)), byDisplaySize.Value);
        }

        if (byFieldWidth.HasValue)
            return Math.Min(520, Math.Max(30, byFieldWidth.Value));

        if (byDisplaySize.HasValue)
            return byDisplaySize.Value;

        return 120;
    }

    var detailTotalWidth = (fields as IEnumerable<TableFieldViewModel>)?.Sum(c => GetDetailColWidth(c)) ?? 0;

    var lookupMap = ViewData["LookupDisplayMap"] as Dictionary<string, Dictionary<string, string>>;
    var lookupTypeMap = ViewData["LookupResultTypes"] as Dictionary<string, string>;
    var headerLookupTypeMap = ViewData["HeaderLookupResultTypes"] as Dictionary<string, string>;

    // ÂÆâÂÖ®ÂèñÂñÆÈ†≠Ê¨Ñ‰ΩçÂÄºÔºàÂÆπË®±Â§ßÂ∞èÂØ´‰∏çÂêåÔºâ
    string GetHeaderVal(string key)
    {
        var dict = headerData as IDictionary<string, object> ?? new Dictionary<string, object>(StringComparer.OrdinalIgnoreCase);
        if (dict.TryGetValue(key, out var v) && v != null) return v.ToString();
        var altKey = dict.Keys.FirstOrDefault(k => k.Equals(key, StringComparison.OrdinalIgnoreCase));
        if (!string.IsNullOrEmpty(altKey) && dict.TryGetValue(altKey, out v) && v != null) return v.ToString();
        return "";
    }

    var PaperNum = !string.IsNullOrWhiteSpace(keyFieldName)
        ? GetHeaderVal(keyFieldName)
        : GetHeaderVal("PaperNum");

    var headerLookupMap = ViewData["HeaderLookupMap"] as Dictionary<string, string>;

    string actionPartial = (ViewData["ActionRailPartial"] as string)
                           ?? "~/Pages/Shared/_ActionRail.Empty.cshtml";
        
}

<div class="erp-detail-container">
    <div id="topToolbar" class="top-toolbar mb-2" data-dict-table="@Model.HeaderTableName">
        <div class="toolbar-icon-row" role="group" aria-label="row-nav-and-sub-detail">
            <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btnPrev" title="‰∏ä‰∏ÄÁ≠Ü" aria-label="‰∏ä‰∏ÄÁ≠Ü"><span class="toolbar-icon">&laquo;</span></button>
            <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btnNext" title="‰∏ã‰∏ÄÁ≠Ü" aria-label="‰∏ã‰∏ÄÁ≠Ü"><span class="toolbar-icon">&raquo;</span></button>
            <button type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add" id="btnSubDetailAdd" title="Êñ∞Â¢ûÁ¨¨‰∫å/Á¨¨‰∏âÈöéÈ†ÖÊ¨°" aria-label="Êñ∞Â¢ûÁ¨¨‰∫åÊàñÁ¨¨‰∏âÈöéÈ†ÖÊ¨°"><span class="toolbar-icon">+</span></button>
            <button type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-del" id="btnSubDetailDelete" title="Âà™Ê∏õÁ¨¨‰∫å/Á¨¨‰∏âÈöéÈ†ÖÊ¨°" aria-label="Âà™Ê∏õÁ¨¨‰∫åÊàñÁ¨¨‰∏âÈöéÈ†ÖÊ¨°"><span class="toolbar-icon">-</span></button>
        <button type="submit" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add toolbar-btn-check" id="btnSaveHeader" form="orderHeaderForm" title="ÂÑ≤Â≠ò" aria-label="ÂÑ≤Â≠ò"><span class="toolbar-icon">‚úì</span></button>
            <button type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-cancel toolbar-btn-check" id="btnCancelChanges" title="ÂèñÊ∂àËÆäÊõ¥" aria-label="ÂèñÊ∂àËÆäÊõ¥"><span class="toolbar-icon">&times;</span></button>
        </div>
        <div class="toolbar-main">
        <div>
            @await Html.PartialAsync("_TableToolbar", new TableToolbarModel {
                SearchBtnId = "btnSubSearch",
                AddBtnId = "btnSubAddNew",
                DeleteBtnId = "btnSubBatchDelete",
                QueryFields = ViewData["QueryFields"] as List<QueryFieldViewModel>,
                ModalId = "searchModal",
                ReportSpName = ViewData["ReportSpName"]?.ToString() ?? ""   // üëà ÂæûÂ§ñÂ±§ÂÜçÂÇ≥ÈÄ≤‰æÜ
            })
        </div>
        </div>
    </div>

        <div class="action-rail">
          @await Html.PartialAsync(actionPartial, (object)Model)
        </div>

        <!-- ÂñÆÈ†≠ÂèØÁ∑®ËºØË°®ÂñÆ -->
        <form id="orderHeaderForm" class="erp-header-form" data-dict-table="@Model.HeaderTableName">
        <div class="row">
            <!-- ‚úÖ Tabs ÂàáÊèõÂàó -->
            <ul class="nav nav-tabs" id="headerTabs" role="tablist">
                @foreach (var tab in groupedTabs.Keys)
                {
                    <li class="nav-item" role="presentation">
                        <button class="nav-link @(tab == firstTabKey ? "active" : "")"
                                id="tab-@tab-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#tab-@tab"
                                type="button" role="tab">
                            @(tab <= 1 ? headerTabBaseLabel : $"{headerTabBaseLabel}{tab}")
                        </button>
                    </li>
                }
            </ul>

                <!-- ‚úÖ Tabs Â∞çÊáâÂÖßÂÆπ -->
              <div class="tab-content" id="headerTabContent">
                    @foreach (var tab in groupedTabs)
                    {
                        <div class="tab-pane fade @(tab.Key == firstTabKey ? "show active" : "")"
                            id="tab-@tab.Key" role="tabpanel">
                            <ul class="list-unstyled header-fields-tab"
                                data-tab-index="@tab.Key"
                                style="position: relative">
                               @foreach (var field in tab.Value)
                                {
                                    object rawValue = null;
                                    headerData?.TryGetValue(field.FieldName, out rawValue);
                                    string displayText = "";

                                    // 1. lookup ÂÑ™ÂÖàÈ°ØÁ§∫
                                    if (headerLookupMap != null && headerLookupMap.TryGetValue(field.FieldName, out var lookupVal))
                                    {
                                        displayText = FormatHelper.FormatValue(lookupVal, field.DataType, field.FormatStr);
                                    }
                                    else if (rawValue != null)
                                    {
                                        //Ëº∏Âá∫Ê†ºÂºèÁî®HelperËΩâÂûã
                                        displayText = FormatHelper.FormatValue(rawValue, field.DataType, field.FormatStr);

                                        // ‚úÖ ÈÄôË£°Ë£úÔºöÊï∏ÂÄºÂûãËã•ÁÇ∫Á©∫ÔºåÈ°ØÁ§∫ 0
                                        if (string.IsNullOrWhiteSpace(displayText) && field.DataType?.ToLower() == "number")
                                        {
                                            displayText = "0";
                                        }
                                    }

                                    const int headerTopPad = 6;
                                    var top = (field.iFieldTop ?? 0) + headerTopPad;
                                    var left = field.iFieldLeft ?? 0;
                                    var width = field.iFieldWidth ?? 160;
                                    var height = field.iFieldHeight ?? 44;

                                    var labTop = (field.iLabTop ?? 0) + headerTopPad;
                                    var labLeft = field.iLabLeft ?? 0;
                                    var labWidth = field.iLabWidth;
                                    var labHeight = field.iLabHeight;
                                    var labStyle = $"top:{labTop}px; left:{labLeft}px;";
                                    if (labWidth.HasValue) { labStyle += $" width:{labWidth.Value}px;"; }
                                    if (labHeight.HasValue) { labStyle += $" height:{labHeight.Value}px;"; }

                                    var liClass = "draggable-field inline"; // Ê∞∏ÈÅ†Ê©´Êéí
                                    var isNumber = IsNumberType(field.DataType) || IsNumberValue(rawValue);
                                    var hasLookupSetting = !string.IsNullOrWhiteSpace(field.LookupTable)
                                        && !string.IsNullOrWhiteSpace(field.LookupKeyField)
                                        && !string.IsNullOrWhiteSpace(field.LookupResultField);
                                    var hasLookupDisplay = headerLookupMap != null && headerLookupMap.ContainsKey(field.FieldName);
                                    var lookupResultType = "";
                                    if (headerLookupTypeMap != null && headerLookupTypeMap.TryGetValue(field.FieldName, out var rt))
                                    {
                                        lookupResultType = rt ?? "";
                                    }
                                    var lookupIsNumber = IsNumberType(lookupResultType) || (hasLookupDisplay && headerLookupMap != null && IsNumberValue(headerLookupMap[field.FieldName]));
                                    var alignRight = lookupIsNumber || (isNumber && !hasLookupSetting && !hasLookupDisplay);
                                    var alignCenter = hasLookupSetting;
                                    var editColor = NormalizeEditColor(field.EditColor);
                                    var editStyle = !string.IsNullOrWhiteSpace(editColor) ? $"background-color:{editColor} !important;" : "";
                                    var editStyleForSelect = editStyle;
                                    var isPartNumField = IsPartNumField(field.FieldName);


                                    <li class="header-label-item"
                                        data-field="@field.FieldName"
                                        data-tab="@tab.Key"
                                        title="@field.FieldName"
                                        style="@labStyle">
                                        @field.DisplayLabel
                                    </li>

                                     // Âà§Êñ∑Êúâ lookup table Ë®≠ÂÆö
                                    if (!string.IsNullOrWhiteSpace(field.LookupTable) &&
                                        !string.IsNullOrWhiteSpace(field.LookupKeyField) &&
                                        !string.IsNullOrWhiteSpace(field.LookupResultField))
                                    {
                                        // ‰∏ãÊãâÈÅ∏ÂñÆÂÖÉ‰ª∂ÔºàÂèØËº∏ÂÖ•Ôºâ
                                        var lookupListId = $"lk_{tab.Key}_{field.FieldName}".Replace(" ", "_");
                                        <li class="@liClass @(alignRight ? "field-number" : "field-text") @(isPartNumField ? "partnum-field" : "")"
                                            data-field="@field.FieldName"
                                            data-tab="@tab.Key"
                                            title="@field.FieldName"
                                            style="top:@(top)px; left:@(left)px; width:@(width)px; height:@(height)px;">
                                            <span class="field-drag-handle" aria-hidden="true"></span>
                                            <input type="hidden"
                                                   name="@field.FieldName"
                                                   value="@rawValue"
                                                   class="lookup-key"
                                                   data-field="@field.FieldName" />
                                            <input type="text"
                                                   class="form-control lookup-dropdown"
                                                   value="@rawValue"
                                                   data-field="@field.FieldName"
                                                   data-table="@field.LookupTable"
                                                   data-key="@field.LookupKeyField"
                                                   data-result="@field.LookupResultField.Replace(" ", "")"
                                                   data-cond1-field="@field.LookupCond1Field"
                                                   data-cond1-source="@field.LookupCond1ResultField"
                                                   data-cond2-field="@field.LookupCond2Field"
                                                   data-cond2-source="@field.LookupCond2ResultField"
                                                   data-selected="@rawValue"
                                                   autocomplete="off"
                                                   list="@lookupListId"
                                                   style="@editStyleForSelect" />
                                            <datalist id="@lookupListId"></datalist>
                                            @if (isPartNumField)
                                            {
                                                <button type="button" class="partnum-lookup-btn" data-field="@field.FieldName" title="ÈñãÂïüÂ∫´Â≠ò‰∏ÄË¶Ω" aria-label="ÈñãÂïüÂ∫´Â≠ò‰∏ÄË¶Ω">?</button>
                                            }
                                        </li>
                                    }
                                    else
                                    {
                                        <li class="@liClass @(alignRight ? "field-number" : "field-text") @(isPartNumField ? "partnum-field" : "")"
                                            data-field="@field.FieldName"
                                            data-tab="@tab.Key"
                                            title="@field.FieldName"
                                            style="top:@(top)px; left:@(left)px; width:@(width)px; height:@(height)px;">
                                            <span class="field-drag-handle" aria-hidden="true"></span>
                                        <textarea class="form-control resizable-input"
                                                name="@field.FieldName"
                                                data-align="@(alignRight ? "right" : (alignCenter ? "center" : null))"
                                                style="@editStyle">@displayText</textarea>
                                            @if (isPartNumField)
                                            {
                                                <button type="button" class="partnum-lookup-btn" data-field="@field.FieldName" title="ÈñãÂïüÂ∫´Â≠ò‰∏ÄË¶Ω" aria-label="ÈñãÂïüÂ∫´Â≠ò‰∏ÄË¶Ω">?</button>
                                            }
                                        </li>
                                    }
                                }
                            </ul>
                        </div>
                    }
                </div>
        </div>
    </form>
    <!-- ÂñÆË∫´ÊòéÁ¥∞ table -->
    <div class="erp-table-wrapper" data-dict-table="@tableName">
    <div class="d-flex justify-content-start mb-2">
        <button type="button" id="btnAddDetailRow" class="btn btn-outline-secondary btn-sm">
            Ôºã
        </button>
        <button type="button" class="btn btn-outline-danger btn-sm" id="btnRowDelete" title="Âà™Èô§Áï∂ÂâçÂàó">Ôºç</button>
        <button type="button" class="btn btn-success btn-sm d-none" id="btnDetailConfirm">Á¢∫Ë™ç</button>
        <button type="button" class="btn btn-secondary btn-sm d-none" id="btnDetailCancel">ÂèñÊ∂à</button>
    </div>
        <table class="erp-table" style="width:@(detailTotalWidth)px;">
            <thead>
              <tr>
                @foreach (var col in fields)   // ‚Üê ‰∏çË¶ÅÂØ´ var dynamic
                {
                    var initWidth = GetDetailColWidth(col);

                    <th data-field="@col.FieldName"
                        style="width:@(initWidth)px; position:relative;"> 
                      <span class="th-text">@col.DisplayLabel</span>
                      <span class="col-resizer" draggable="false"></span>
                    </th>
                }
              </tr>
            </thead>
            <tbody>
                    @if (items != null)
                    {
                        var index = 1;
                        string GetValue(object obj, string fieldName)
                        {
                            if (obj == null) return "";
                            if (obj is IDictionary<string, object> dic)
                            {
                                var kv = dic.FirstOrDefault(k => string.Equals(k.Key, fieldName, StringComparison.OrdinalIgnoreCase));
                                return kv.Equals(default(KeyValuePair<string, object>)) ? "" : kv.Value?.ToString() ?? "";
                            }
                            var prop = obj.GetType().GetProperty(fieldName);
                            return prop != null ? prop.GetValue(obj, null)?.ToString() ?? "" : "";
                        }

                        foreach (var item in items)
                        {
                            var paperNum = GetValue(item, "PaperNum");
                            var itemNo   = GetValue(item, "Item");

                            <tr data-paper-num="@paperNum" data-item="@itemNo" data-state="unchanged">
                                @foreach(var col in fields)
                                {
                                    object v = "";
                                    if (item is IDictionary<string, object> dict)
                                        dict.TryGetValue(col.FieldName, out v);
                                    else if (item is System.Dynamic.ExpandoObject exp)
                                    {
                                        var expDict = (IDictionary<string, object>)exp;
                                        expDict.TryGetValue(col.FieldName, out v);
                                    }
                                    else
                                    {
                                        var prop = item.GetType().GetProperty(col.FieldName);
                                        v = prop != null ? prop.GetValue(item, null) : "";
                                    }

                                    var rowKey = $"{paperNum}_{itemNo}";
                                    string display = null;
            
                                    if (lookupMap != null && lookupMap.TryGetValue(rowKey, out var dict2))
                                    {
                                        dict2.TryGetValue(col.FieldName, out display);
                                    }
                                        
                                        // Ë®àÁÆóÈ°ØÁ§∫ÂÄºÔºåÂÖàÁúã lookupÔºåÂÖ∂Ê¨°Ëµ∞Ê†ºÂºèÂåñ
                                        string cellValue;
                                        if (!string.IsNullOrEmpty(display))
                                        {
                                            cellValue = FormatHelper.FormatValue(display, col.DataType, col.FormatStr);
                                        }
                                        else
                                        {
                                            cellValue = FormatHelper.FormatValue(v, col.DataType, col.FormatStr);
                                        }

                                        // È†êÂÖàÁÆóÂ•Ω nameÔºåÈÅøÂÖç Razor Ëß£ÊûêÈåØË™§
                                        var inputName = $"Details[{index}].{col.FieldName}";
                                        var isPartNumCol = IsPartNumField(col.FieldName);

                                        var isNumberCell = IsNumberType(col.DataType);
                                        string lookupCellType = "";
                                        string dt = "";
                                        if (lookupTypeMap != null && lookupTypeMap.TryGetValue(col.FieldName, out dt))
                                        {
                                            lookupCellType = dt ?? "";
                                        }
                                        var lookupCellIsNumber = IsNumberType(lookupCellType) || IsNumberValue(display);
                                        var alignRightCell = lookupCellIsNumber || (isNumberCell && string.IsNullOrEmpty(display));
                                        if ((isNumberCell || lookupCellIsNumber) && !string.IsNullOrWhiteSpace(col.FormatStr))
                                        {
                                            cellValue = NormalizeNumberByFormat(cellValue, col.FormatStr);
                                        }
                                        if ((isNumberCell || lookupCellIsNumber) && IsZeroNumberString(cellValue))
                                        {
                                            cellValue = "0";
                                        }
                                        var cellColor = NormalizeEditColor(col.EditColor);
                                        var cellStyle = !string.IsNullOrWhiteSpace(cellColor) ? $"background-color:{cellColor} !important;" : "";
                                        var rawText = v?.ToString() ?? "";
                                        var isReadOnly = (col.ReadOnly ?? 0) > 0;
                                        if (!isReadOnly && !string.IsNullOrEmpty(display) && string.IsNullOrWhiteSpace(rawText))
                                        {
                                            isReadOnly = true;
                                        }
                                        <td class="detail-cell @(alignRightCell ? "detail-number" : "detail-text") @(isPartNumCol ? "partnum-field" : "")" style="@cellStyle" data-readonly="@(isReadOnly ? "1" : "0")" data-field="@col.FieldName">
                                            <span class="cell-view @(isReadOnly ? "readonly-cell" : "")">@cellValue</span>

                                            <input type="text"
                                                class="form-control form-control-sm cell-edit d-none w-100 @(isReadOnly ? "readonly-cell" : "")"
                                                name="@inputName"
                                                data-field="@col.FieldName"
                                                data-init="@cellValue"
                                                value="@cellValue"
                                                @(isReadOnly ? "readonly data-readonly=\"1\"" : "data-readonly=\"0\"") />
                                            @if (isPartNumCol)
                                            {
                                                <button type="button" class="partnum-lookup-btn" data-field="@col.FieldName" title="ÈñãÂïüÂ∫´Â≠ò‰∏ÄË¶Ω" aria-label="ÈñãÂïüÂ∫´Â≠ò‰∏ÄË¶Ω">?</button>
                                            }
                                                
                                        </td>

                                }
                            </tr>
                            index++;
                        }
                    }
            </tbody>
        </table>
    </div>
</div>



<!-- SweetAlert2 forÊèêÁ§∫ -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="~/js/toolbarHandler.js?v=@DateTime.Now.Ticks"></script>
<script src="~/js/gridToolbarTemplate.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />

<!-- ÂëºÂè´ÂÖÉ‰ª∂ -->
@await Html.PartialAsync("_OrderDetailPicker",
  new DetailPickerConfig{
      ModalId       = "detailPicker",
      PaperNum      = PaperNum,
      FetchApi      = "/api/OrderDetailSearch/fetch",
      InsertApi     = "/api/OrderDetailSearch/insert",
      DictTableName = "SPOdOCXOrderPOChice",   // ‚òÖ ‰Ω†Ë¶ÅÁöÑËæ≠ÂÖ∏Ë°®
      DictUrlBase   = "/DataDict/EditList"     // ‚òÖ ‰Ω†ÂÄëËÉΩÁõ¥Êé• GET ÁöÑËæ≠ÂÖ∏È†ÅÔºàËã•ÊòØ /CURdTableField/EditList Â∞±ÊîπÈÇ£Ê¢ùÔºâ
  })


<script>
//2025.11.10
  window._tableName = "@Model.HeaderTableName";  // ‰æãÂ¶ÇÔºöSPOdMPSOutMainÔºà‰øùÁïôÊ≠£Á¢∫Â§ßÂ∞èÂØ´Ôºâ
</script>


<script>
// ============================
// 0) È†ÅÈù¢Â∏∏Êï∏ÔºèRazor Ê≥®ÂÖ•
// ============================
const PAGE = {
  paperNum: "@PaperNum",
  keyField: "PaperNum",
  headerTable: ("@(Model.HeaderTableName ?? "")".trim() || "").toLowerCase(), // e.g. spodordermain
  headerSaveTable: ("@(ViewData["HeaderRealTableName"] ?? Model.HeaderTableName ?? "")".trim() || "").toLowerCase(),
  detailTable: "@(tableName ?? "")".trim(),                                   // e.g. SpodOrderSub
  queryRedirectUrl: "@(ViewData["QueryRedirectUrl"])",
  addApiUrl: "@addApiUrl",
  deleteApiUrl: "@DeleteApiUrl",
  detailRouteTemplate: "@detailRouteTemplate",
  headerFields: @Html.Raw(JsonSerializer.Serialize(headerFieldsList)),
  detailFields: @Html.Raw(JsonSerializer.Serialize(fields))
};

function getPartNumFromContainer(container) {
  if (!container) return '';
  const keyInput = container.querySelector('input.lookup-key[name]');
  if (keyInput && keyInput.value) return keyInput.value.trim();
  const input = container.querySelector('input.cell-edit, input[type="text"], textarea, select');
  if (input) {
    if (input.tagName && input.tagName.toLowerCase() === 'select') {
      return (input.value || input.options?.[input.selectedIndex]?.value || '').trim();
    }
    return (input.value || '').trim();
  }
  const view = container.querySelector('.cell-view');
  return view ? (view.textContent || '').trim() : '';
}

document.addEventListener('click', (e) => {
  if (e.__partnumHandled) return;
  const btn = e.target.closest('.partnum-lookup-btn');
  if (!btn) return;
  e.__partnumHandled = true;
  e.preventDefault();
  e.stopPropagation();
  const container = btn.closest('td, li');
  const partNum = getPartNumFromContainer(container);
  if (!partNum) return;
  const url = `/MIN/MatDetail?PartNum=${encodeURIComponent(partNum)}`;
  window.open(url, '_blank');
});

// ÊîæÂú®ÊúÄÂâçÈù¢ÔºàËæ≠ÂÖ∏ÈñãÈóúÔºâ
window.__DICT_OPEN__ = false;

// ËÆìÂÖ∂ÂÆÉÂ∑•ÂÖ∑ÂèØ‰ª•ÂèñÂà∞ÁõÆÂâçÂñÆËôü
window.selectedPaperNum = '@(PaperNum)';

// ‚òÖ ÊåáÂÆöËæ≠ÂÖ∏Ë°®
document.addEventListener('DOMContentLoaded', () => {
  window['OrderDetailPicker_detailPicker']?.setDictTableName('SPOdOCXOrderPOChice');
});

// ‚òÖ Á∂ÅÂÆöËæ≠ÂÖ∏ Modal È°ØÁ§∫/ÈóúÈñâÔºåÈéñÁÑ¶Èªû
$('#detailPicker')
  .on('shown.bs.modal', function () {
    window.__DICT_OPEN__ = true;
    $(this).find('input,textarea,select').filter(':visible:enabled').first().trigger('focus');
  })
  .on('hidden.bs.modal', function () {
    window.__DICT_OPEN__ = false;
  });

// ‚òÖ Èò≤Ê≠¢„ÄåÂÑ≤Â≠ò„ÄçÊåâÈàïË¢´Ëá™ÂãïËÅöÁÑ¶
(function guardSaveButtonFocus(){
  const saveBtn = document.querySelector('#topToolbar button[type="submit"]');
  if (!saveBtn) return;
  $('#detailPicker').on('shown.bs.modal', function(){
    saveBtn.setAttribute('data-prev-tabindex', saveBtn.getAttribute('tabindex') ?? '');
    saveBtn.setAttribute('tabindex', '-1');
    saveBtn.blur();
  });
  $('#detailPicker').on('hidden.bs.modal', function(){
    const prev = saveBtn.getAttribute('data-prev-tabindex');
    if (prev === '') saveBtn.removeAttribute('tabindex');
    else saveBtn.setAttribute('tabindex', prev);
    saveBtn.removeAttribute('data-prev-tabindex');
  });
})();

// ============================
// 1) Toolbar Handler ÂïüÂãï
// ============================
// Ëá™ÂãïÊé®Â∞éÊú¨È†ÅÁöÑË∑ØÂæëÊ®£ÊùøÔºö/SpodOrderSub/{0}
const PAPER_NUM = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(PaperNum ?? ""));
const QUERY_REDIRECT_URL = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
  ViewData["QueryRedirectUrl"]?.ToString() ?? ""
));

const PAGE_PAPER_NUM = ("@PaperNum" || "").trim();
const KEY_FIELD = ("@(keyFieldName ?? "PaperNum")" || "PaperNum").trim();

const backToMainTpl = (PAGE.queryRedirectUrl || '').trim()
  ? PAGE.queryRedirectUrl.replace(/\/$/, '') + '/{0}'
  : '';
const subTpl = (PAGE.detailRouteTemplate || '').replace(/\{PaperNum\}/gi, '{0}');
const finalSwitchTpl = backToMainTpl || subTpl;

console.debug('[Switch template]', finalSwitchTpl);
console.debug('[Sub template for new]', subTpl);

new ToolbarHandler({
  searchBtnId: "btnSubSearch",
  addBtnId: "btnSubAddNew",
  deleteBtnId: "btnSubBatchDelete",
  getSelectedId: () => (PAGE.paperNum || window.selectedPaperNum || ''),
  modalId: "searchModal",
  formId: "searchForm",
  addApiUrl: PAGE.addApiUrl,
  deleteApiUrlFn: id => `/api/${PAGE.deleteApiUrl}/${id || PAGE.paperNum}`,
  paperAction: { url: '/api/PaperAction/DoAction', paperId: "@Model.HeaderTableName", eoc: 0, aftFinished: 2 },
  detailRouteTemplate: subTpl,  // ‰ΩøÁî®ÂñÆË∫´È†ÅË∑ØÂæëÔºåÊñ∞Â¢ûÂæåË∑≥ËΩâÂà∞ÂñÆË∫´È†Å
  tableName: "@tableName",
  renderTable: null,
  renderPagination: null,
  renderOrderCount: null,
  restoreSearchForm: null,
  queryRedirectUrl: PAGE.queryRedirectUrl
});

// ÂñÆË∫´È†Å ‚Üí ‰∏ªÈ†Å ÂàáÊèõ
(function hookToggleBackToMain() {
  const rawBtn = document.getElementById('btnToggle') ||
    Array.from(document.querySelectorAll('button, a'))
      .find(el => (el.textContent || '').trim() === 'ÂàáÊèõ');
  if (!rawBtn) return;
  const btn = rawBtn.cloneNode(true);
  rawBtn.replaceWith(btn);
  btn.addEventListener('click', (e) => {
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    const base = (QUERY_REDIRECT_URL || '').trim().replace(/\/$/, '');
    if (!base) { Swal.fire({ icon: 'error', title: 'Êú™Êèê‰æõËøîÂõû‰∏ªÈ†ÅË∑ØÂæë' }); return; }
    const id = (PAGE_PAPER_NUM || window.selectedPaperNum || '').trim();
    const sep = base.includes('?') ? '&' : '?';
    const url = id ? `${base}${sep}${encodeURIComponent(KEY_FIELD)}=${encodeURIComponent(id)}` : base;
    location.href = url;
  }, { capture: true });
})();

// ============================
// 2) ÂÖ±Áî®Â∞èÂ∑•ÂÖ∑ÔºàÊï∏ÂÄºËôïÁêÜ„ÄÅÂ≠ó‰∏≤ÂåñÔºâ
// ============================
function normalizeNumberFields(obj, fieldDefs) {
  (fieldDefs || []).forEach(f => {
    if ((f.DataType || '').toLowerCase() === 'number') {
      const k = f.FieldName;
      if (obj[k] != null) obj[k] = obj[k].toString().replace(/,/g, '');
    }
  });
}
function normalizeDetailsNumbers(detailRows, fieldDefs) {
  const numberFields = (fieldDefs || [])
    .filter(f => (f.DataType || '').toLowerCase() === 'number')
    .map(f => f.FieldName.toLowerCase());
  detailRows.forEach(r => {
    numberFields.forEach(fn => {
      Object.keys(r).forEach(k => {
        if (k.toLowerCase() === fn && r[k] != null) r[k] = r[k].toString().replace(/,/g, '');
      });
    });
  });
}
function toCellString(raw, colMeta) {
  if (raw == null) return '';
  if (typeof raw === 'object') return '';
  let s = String(raw);
  const dt = (colMeta?.DataType || '').toLowerCase();
  if (dt.includes('date')) {
    const d = new Date(s); if (!isNaN(d)) return d.toISOString().slice(0,10);
  }
  if (dt === 'number') return s.replace(/,/g, '');
  return s;
}
function withTemporarilyEnabled(formEl, callback) {
  const disabledEls = Array.from(formEl.querySelectorAll('input:disabled, select:disabled, textarea:disabled'));
  disabledEls.forEach(el => el.disabled = false);
  try { return callback(); } finally { disabledEls.forEach(el => el.disabled = true); }
}
function collectHeaderFormData() {
  const form = document.getElementById('orderHeaderForm');
  return withTemporarilyEnabled(form, () => Object.fromEntries(new FormData(form)));
}
function getPaperNum() {
  const p1 = (PAGE.paperNum || window.selectedPaperNum || '').trim();
  if (p1) return p1;
  const header = collectHeaderFormData();
  return (header.PaperNum || header.papernum || '').toString().trim();
}

// ============================
// 3) ÊòéÁ¥∞Âàó Êî∂ÈõÜ / Êñ∞Â¢û / Âà™Èô§ / Êï¥ÂàóÈÅ∏Âèñ
// ============================
function collectDetails() {
  const rows = document.querySelectorAll('.erp-table tbody tr');
  const details = [];
  rows.forEach(tr => {
    let changed = (tr.dataset.state === 'added' || tr.dataset.state === 'deleted');
    const row = { __state: tr.dataset.state || 'modified', PaperNum: tr.dataset.paperNum || PAGE.paperNum };
    tr.querySelectorAll('.cell-edit').forEach(inp => {
      const field = inp.dataset.field; if (!field) return;
      const val = (inp.value ?? '').toString();
      row[field] = val;
      if (!changed && (val !== (inp.dataset.init ?? ''))) changed = true;
    });
    if (row.Item == null && tr.dataset.item) row.Item = tr.dataset.item;
    if (changed) { if (row.__state === 'unchanged') row.__state = 'modified'; details.push(row); }
  });
  return details;
}

let _pendingNewDetailRow = null;

function computeNextItemNumber() {
  const rows = Array.from(document.querySelectorAll('.erp-table tbody tr'));
  let maxItem = 0;
  rows.forEach(tr => {
    const v = (tr.dataset.item || '').toString().trim();
    const n = parseInt(v, 10);
    if (!isNaN(n) && n > maxItem) maxItem = n;
  });
  return maxItem + 1;
}

function isBlankDetailRow(tr) {
  if (!tr) return false;
  const inputs = Array.from(tr.querySelectorAll('.cell-edit'));
  if (!inputs.length) return false;
  let hasValue = false;
  inputs.forEach(inp => {
    const f = (inp.dataset.field || '').toString().toLowerCase();
    if (f === 'papernum' || f === 'item') return;
    const val = (inp.value ?? '').toString().trim();
    if (val === '') return;
    if (/^[-‚Äì‚Äî]+$/.test(val)) return;
    if (/^[0-9.,]+$/.test(val)) {
      const num = parseFloat(val.replace(/,/g, ''));
      if (Number.isFinite(num) && num === 0) return;
    }
    hasValue = true;
  });
  return !hasValue;
}

function primeBlankRow(tr) {
  if (!tr) return;
  const pn = PAGE.paperNum || getPaperNum();
  const nextItem = computeNextItemNumber();
  if (!tr.dataset.paperNum) tr.dataset.paperNum = pn;
  if (!tr.dataset.item) tr.dataset.item = String(nextItem);
  tr.querySelectorAll('.cell-edit').forEach(inp => {
    const f = (inp.dataset.field || '').toString().toLowerCase();
    if (f === 'papernum' && !inp.value) {
      inp.value = tr.dataset.paperNum || pn;
      inp.dataset.init = inp.value;
      const span = inp.closest('td')?.querySelector('.cell-view');
      if (span) span.textContent = inp.value;
    }
    if (f === 'item' && !inp.value) {
      inp.value = tr.dataset.item || String(nextItem);
      inp.dataset.init = inp.value;
      const span = inp.closest('td')?.querySelector('.cell-view');
      if (span) span.textContent = inp.value;
    }
  });
}

function appendEmptyDetailRow() {
  const tbody = document.querySelector('.erp-table tbody');
  const tr = document.createElement('tr');
  const pn = PAGE.paperNum || getPaperNum();
  const nextItem = computeNextItemNumber();
  tr.dataset.paperNum = pn;
  tr.dataset.item = String(nextItem);
  tr.dataset.state = 'added';

  let tdsHtml = '';
  (PAGE.detailFields || []).forEach((col) => {
    let v = '';
    if ((col.FieldName || '').toLowerCase() === 'papernum') v = pn;
    if ((col.FieldName || '').toLowerCase() === 'item') v = String(nextItem);

    const inputName = `Details[${tbody.rows.length + 1}].${col.FieldName}`;
    const isReadOnly = (col.ReadOnly || 0) > 0;
    const roClass = isReadOnly ? ' readonly-cell' : '';
    const roAttr = isReadOnly ? ' data-readonly="1" readonly' : ' data-readonly="0"';
    const isPartNum = /partnum/i.test((col.FieldName || '').replace(/_/g, ''));
    const partNumBtn = isPartNum ? '<button type="button" class="partnum-lookup-btn" title="ÈñãÂïüÂ∫´Â≠ò‰∏ÄË¶Ω" aria-label="ÈñãÂïüÂ∫´Â≠ò‰∏ÄË¶Ω">?</button>' : '';
    tdsHtml += `
      <td data-readonly="${isReadOnly ? '1' : '0'}" data-field="${col.FieldName}" class="${isPartNum ? 'partnum-field' : ''}">
        <span class="cell-view${roClass}">${v}</span>
        <input type="text"
          class="form-control form-control-sm cell-edit d-none w-100${roClass}"
          name="${inputName}"
          data-field="${col.FieldName}"
          data-init="${v}"
          value="${v}"${roAttr}>
        ${partNumBtn}
      </td>`;
  });
  tr.innerHTML = tdsHtml;
  tbody.appendChild(tr);
  makeRowEditable(tr);
  selectRow(tr);
  tr.querySelectorAll('.cell-edit').forEach(inp => {
    inp.addEventListener('input', () => { if (tr.dataset.state !== 'added') tr.dataset.state = 'modified'; });
  });
  window.__unsavedChanges = true;
  return tr;
}

function showPendingButtons(show) {
  document.getElementById('btnDetailConfirm')?.classList.toggle('d-none', !show);
  document.getElementById('btnDetailCancel')?.classList.toggle('d-none', !show);
}

function cancelPendingDetailRow() {
  if (!_pendingNewDetailRow) return false;
  _pendingNewDetailRow.remove();
  _pendingNewDetailRow = null;
  showPendingButtons(false);
  return true;
}

async function confirmPendingDetailRow() {
  if (!_pendingNewDetailRow) return;
  // ‰∫§Áµ¶Êó¢ÊúâÂÑ≤Â≠òÊµÅÁ®ãÔºàSaveOrderHeaderÔºâÔºåÊ±∫ÂÆöÊòØÂê¶ÂØ´ÂÖ• DB
  document.getElementById('orderHeaderForm')?.requestSubmit();
}

function onAddRowClick() {
  // Âè™ÂÖàÊñ∞Â¢ûÂâçÂè∞‰∏ÄÁ≠ÜÁ©∫Ë≥áÊñôÔºå‰∏çÁõ¥Êé•ÂØ´ÂÖ•Ë≥áÊñôÂ∫´
  const selected = document.querySelector('.erp-table tbody tr.row-selected');
  const blankRow = (selected && isBlankDetailRow(selected))
    ? selected
    : Array.from(document.querySelectorAll('.erp-table tbody tr')).find(isBlankDetailRow);
  if (blankRow) {
    if (_pendingNewDetailRow && _pendingNewDetailRow !== blankRow) _pendingNewDetailRow.remove();
    _pendingNewDetailRow = blankRow;
    primeBlankRow(blankRow);
    blankRow.dataset.state = 'added';
    makeRowEditable(blankRow);
    selectRow(blankRow);
    showPendingButtons(true);
    window.__unsavedChanges = true;
    return;
  }
  cancelPendingDetailRow();
  _pendingNewDetailRow = appendEmptyDetailRow();
  showPendingButtons(true);
}

// ===== ÈçµÁõ§Êç∑ÂæëÔºà‚Üë ‚Üì F7 F8ÔºâÔºåÂä†‰∏ä modal Áü≠Ë∑Ø =====
(function initDetailRowHotkeys(){
  const BLOCK_FIELDS = new Set(['item','Item']);
  let curColIdx = 0;
  function tdIndex(td){ return td ? Array.prototype.indexOf.call(td.parentElement.children, td) : 0; }
  function selectedRow(){ return document.querySelector('.erp-table tbody tr.row-selected'); }
  function getCellInput(tr, idx){
    if (!tr) return null;
    const td = tr.cells && tr.cells[idx] ? tr.cells[idx] : null;
    return (td && td.querySelector('.cell-edit')) || tr.querySelector('.cell-edit');
  }
  function focusCell(tr, idx){
    if (!tr) return;
    selectRow(tr); makeRowEditable(tr);
    const inp = getCellInput(tr, idx); if (inp){ inp.focus(); inp.select?.(); }
  }
  function syncView(td, val){
    const span = td && td.querySelector ? td.querySelector('.cell-view') : null;
    if (span) span.textContent = (val ?? '');
  }

  document.addEventListener('keydown', async (e) => {
    try{
      // ‚òÖ modal ÊâìÈñãÊôÇÔºåÂÆåÂÖ®‰∏çËôïÁêÜ
      if (window.__DICT_OPEN__) return;
      if (e.target.closest && e.target.closest('.modal')) return;

      const key = e.key;
      let input = e.target.closest?.('.cell-edit');
      let curTr, curTd;

      if (input && !input.classList.contains('d-none')) {
        curTd = input.closest('td');
        curTr = input.closest('tr');
        curColIdx = tdIndex(curTd);
      } else {
        curTr = selectedRow() || e.target.closest?.('tr');
        if (!curTr) return;
        makeRowEditable(curTr);
        input = getCellInput(curTr, curColIdx) || curTr.querySelector('.cell-edit');
        if (!input) return;
        curTd = input.closest('td');
      }

      const prevTr = curTr.previousElementSibling;
      const nextTr = curTr.nextElementSibling;

      if (key === 'ArrowUp'){ if (prevTr){ e.preventDefault(); focusCell(prevTr, curColIdx); } return; }
      if (key === 'ArrowDown'){
        e.preventDefault();
        if (nextTr){ focusCell(nextTr, curColIdx); return; }
        await onAddRowClick();
        const newTr = document.querySelector('.erp-table tbody tr:last-child');
        focusCell(newTr, curColIdx);
        return;
      }

      if (key === 'F7' || e.keyCode === 118){
        e.preventDefault();
        if (!prevTr) return;
        const prevMap = Object.create(null);
        prevTr.querySelectorAll('.cell-edit').forEach(inp => {
          prevMap[(inp.dataset.field||'').toLowerCase()] = inp;
        });
        curTr.querySelectorAll('.cell-edit').forEach(inp => {
          const f = (inp.dataset.field||'').toLowerCase();
          if (!f || BLOCK_FIELDS.has(f)) return;
          const src = prevMap[f]; if (!src) return;
          inp.value = src.value ?? '';
          inp.dispatchEvent(new Event('input', {bubbles:true}));
          syncView(inp.closest('td'), inp.value);
        });
        if (curTr.dataset.state !== 'added') curTr.dataset.state = 'modified';
        input.focus(); input.select?.();
        return;
      }

      if (key === 'F8' || e.keyCode === 119){
        e.preventDefault();
        if (!prevTr) return;
        const field = (input.dataset.field||'').trim();
        if (BLOCK_FIELDS.has(field)) return;
        const prevInput = getCellInput(prevTr, curColIdx); if (!prevInput) return;
        input.value = prevInput.value ?? '';
        input.dispatchEvent(new Event('input', {bubbles:true}));
        syncView(curTd, input.value);
        input.focus(); input.select?.();
        return;
      }
    }catch(err){ console.error('[detail hotkeys] error:', err); }
  });

  const tbody = document.querySelector('.erp-table tbody');
  if (tbody){
    tbody.addEventListener('click', (e) => {
      if (window.__DICT_OPEN__ || e.target.closest('.modal')) return;
      const td = e.target.closest('td'); if (td) curColIdx = tdIndex(td);
      const tr = e.target.closest('tr'); if (tr) selectRow(tr);
    });
    tbody.addEventListener('focusin', (e) => {
      if (window.__DICT_OPEN__ || e.target.closest('.modal')) return;
      const inp = e.target.closest('.cell-edit');
      if (inp){ curColIdx = tdIndex(inp.closest('td')); selectRow(inp.closest('tr')); }
    });
  }
})();

// 3-4 Âà™Èô§ÁõÆÂâçÈÅ∏ÂèñÂàó
async function onDeleteRowClick() {
  const tr = document.querySelector('.erp-table tbody tr.row-selected');
  if (!tr) { Swal.fire({icon:'info', title:'Ë´ãÂÖàÈªûÈÅ∏Ë¶ÅÂà™Èô§ÁöÑÊòéÁ¥∞Âàó'}); return; }

  const pn = tr.dataset.paperNum || PAGE.paperNum;
  const item = tr.dataset.item || '';
  if (!pn || !item) { Swal.fire({icon:'error', title:'ÁÑ°Ê≥ïÂà§Êñ∑ÂñÆËôüÊàñÈ†ÖÊ¨°'}); return; }

  const { isConfirmed } = await Swal.fire({
    icon: 'question', title: 'Âà™Èô§ÈÄô‰∏ÄÁ≠ÜÊòéÁ¥∞Ôºü', showCancelButton: true, confirmButtonText: 'Âà™Èô§', cancelButtonText: 'ÂèñÊ∂à'
  });
  if (!isConfirmed) return;

  if (tr.dataset.state === 'added') {
    const next = tr.nextElementSibling || tr.previousElementSibling;
    tr.remove(); if (next) selectRow(next);
    return;
  }

  try {
    const url = `/api/OrderHeaderApi/DeleteRow`
      + `?table=${encodeURIComponent(PAGE.detailTable)}`
      + `&paperNum=${encodeURIComponent(pn)}`
      + `&item=${encodeURIComponent(item)}`;
    const res = await fetch(url, { method: 'DELETE' });
    if (!res.ok) throw new Error(await res.text());
    const next = tr.nextElementSibling || tr.previousElementSibling;
    tr.remove(); if (next) selectRow(next);
    Swal.fire({icon:'success', title:'Âà™Èô§ÂÆåÊàê', timer:900, showConfirmButton:false});
  } catch (err) {
    Swal.fire({icon:'error', title:'Âà™Èô§Â§±Êïó', text: String(err)});
  }
}

// 3-5 Êï¥ÂàóÈÅ∏ÂèñÔºÜËÆìË©≤ÂàóÂèØÁ∑®ËºØ
const tbodyEl = document.querySelector('.erp-table tbody');
function selectRow(tr) {
  if (!tr) return;
  document.querySelectorAll('.erp-table tbody tr.row-selected').forEach(r => r.classList.remove('row-selected'));
  tr.classList.add('row-selected');
}
function makeRowEditable(tr) {
  tr.querySelectorAll('.cell-view').forEach(el => {
    if (el.classList.contains('readonly-cell')) return;
    el.classList.add('d-none');
  });
  tr.querySelectorAll('.cell-edit').forEach(el => {
    if (el.classList.contains('readonly-cell')) return;
    el.classList.remove('d-none');
  });
  const first = tr.querySelector('.cell-edit[data-field="PartNum"]:not(.readonly-cell)') || tr.querySelector('.cell-edit:not(.readonly-cell)');
  first?.focus(); first?.select?.();
}
tbodyEl.addEventListener('click',  e => {
  if (window.__DICT_OPEN__ || e.target.closest('.modal')) return;
  const tr = e.target.closest('tr'); if (tr) selectRow(tr);
});
tbodyEl.addEventListener('focusin', e => {
  if (window.__DICT_OPEN__ || e.target.closest('.modal')) return;
  const tr = e.target.closest('tr'); if (tr) selectRow(tr);
});
document.getElementById('btnAddDetailRow')?.addEventListener('click', onAddRowClick);
document.getElementById('btnRowDelete')?.addEventListener('click', onDeleteRowClick);
document.getElementById('btnDetailCancel')?.addEventListener('click', (e) => { e.preventDefault(); cancelPendingDetailRow(); });
document.getElementById('btnDetailConfirm')?.addEventListener('click', async (e) => { e.preventDefault(); await confirmPendingDetailRow(); });

// ============================
// 4) ÂÑ≤Â≠òÂñÆÈ†≠ÔºãÂñÆË∫´
// ============================
document.getElementById('orderHeaderForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const header = collectHeaderFormData();
  normalizeNumberFields(header, PAGE.headerFields);
  const details = collectDetails();
  normalizeDetailsNumbers(details, PAGE.detailFields);

  const payload = { ...header, Details: details, __headerTable: PAGE.headerSaveTable || PAGE.headerTable, __detailTable: PAGE.detailTable || undefined };

  try {
    const resp = await fetch('/api/OrderHeaderApi/SaveOrderHeader', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
    });
    if (resp.ok) {
      const result = await resp.json();
      if (result.updated) {
        await Swal.fire({ icon: 'success', title: 'ÂÑ≤Â≠òÊàêÂäüÔºÅ', timer: 1000, showConfirmButton: false });
        localStorage.setItem("afterSave", "1"); location.reload();
      } else {
        Swal.fire({ icon: 'info', title: 'Ê≤íÊúâË≥áÊñôÁï∞Âãï' });
      }
    } else {
      let msg = 'ÂÑ≤Â≠òÂ§±Êïó'; try { const txt = await resp.text(); msg = txt || msg; } catch {}
      Swal.fire({ icon: 'error', title: msg });
    }
  } catch (err) { Swal.fire({ icon: 'error', title: 'Á∂≤Ë∑ØÊàñ‰º∫ÊúçÂô®ÈåØË™§' }); }
});

// ============================
// 5) Ê™¢Ë¶ñ/Á∑®ËºØÊ®°ÂºèÂàáÊèõÔºàÈÅøÈñã modal ÂÖßÂÖÉÁ¥†Ôºâ
// ============================
const editBtn = document.getElementById('btnViewEditToggle');
if (editBtn) {
  let isEdit = false;

  function setLookupReadOnly(selectEl, readOnly) {
    if (!selectEl) return;
    if (selectEl instanceof HTMLSelectElement) {
      if (readOnly) {
        selectEl.disabled = false; // ÂøÖÈ†àÂèØÈªûÔºåÊâçËÉΩÂ±ïÈñãÈÅ∏È†Ö
        selectEl.dataset.lockedValue = selectEl.value ?? '';
        selectEl.classList.add('lookup-readonly');
        selectEl.setAttribute('aria-readonly', 'true');
        selectEl.title = 'ÁÄèË¶ΩÊ®°ÂºèÔºöÂèØÊü•Áúã‰∏ãÊãâÂÖßÂÆπÔºå‰∏çËÉΩ‰øÆÊîπ';
      } else {
        selectEl.classList.remove('lookup-readonly');
        selectEl.removeAttribute('aria-readonly');
        selectEl.title = '';
        selectEl.dataset.lockedValue = selectEl.value ?? '';
        selectEl.disabled = false;
      }
      return;
    }
    if (selectEl instanceof HTMLInputElement) {
      if (readOnly) {
        selectEl.readOnly = true;
        selectEl.dataset.lockedValue = selectEl.value ?? '';
        selectEl.classList.add('lookup-readonly');
        selectEl.setAttribute('aria-readonly', 'true');
        selectEl.title = 'ÁÄèË¶ΩÊ®°ÂºèÔºöÂèØÊü•ÁúãÂÖßÂÆπÔºå‰∏çËÉΩ‰øÆÊîπ';
      } else {
        selectEl.readOnly = false;
        selectEl.classList.remove('lookup-readonly');
        selectEl.removeAttribute('aria-readonly');
        selectEl.title = '';
        selectEl.dataset.lockedValue = selectEl.value ?? '';
      }
    }
  }

  function applyHeaderEditState(editing) {
    document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
      .forEach(el => {
        if (el.closest('.modal')) return;
        if (el.matches('.lookup-dropdown')) {
          setLookupReadOnly(el, !editing);
        } else if (el.matches('input[type="hidden"]')) {
          el.disabled = false;
        } else {
          el.disabled = !editing;
        }
      });
  }

  function applyToolbarEditState(editing) {
    const editOnlyIds = ['btnSubDetailAdd', 'btnSubDetailDelete', 'btnSaveHeader', 'btnCancelChanges'];
    editOnlyIds.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.disabled = !editing;
      el.classList.toggle('disabled', !editing);
    });

    const viewOnlyIds = ['btnSubSearch', 'btnSwitch', 'btnSubAddNew', 'btnPrint', 'btnCancel', 'btnPrev', 'btnNext'];
    viewOnlyIds.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      if (editing) {
        el.dataset.prevDisabled = el.disabled ? '1' : '0';
        el.disabled = true;
        el.classList.add('disabled');
      } else {
        const wasDisabled = el.dataset.prevDisabled === '1';
        el.disabled = wasDisabled;
        if (!wasDisabled) el.classList.remove('disabled');
        delete el.dataset.prevDisabled;
      }
    });
  }

  function syncDetailInputsFromView() {
    document.querySelectorAll('.erp-table tbody tr').forEach(tr => {
      tr.querySelectorAll('td').forEach(td => {
        const span = td.querySelector('.cell-view');
        const inp = td.querySelector('.cell-edit');
        if (!span || !inp) return;
        if (inp.classList.contains('readonly-cell')) return;
        const viewText = (span.textContent ?? '').trim();
        if (viewText === '') return;
        if (inp.value !== viewText) inp.value = viewText;
        inp.dataset.init = viewText;
      });
    });
  }

  // ÁÄèË¶ΩÊ®°ÂºèÔºö‰∏ãÊãâÂèØÂ±ïÈñã‰ΩÜ‰∏çÂèØËÆäÊõ¥
  document.addEventListener('change', (e) => {
    const sel = e.target;
    if (!(sel instanceof HTMLSelectElement)) return;
    if (!sel.matches('.erp-header-form select.lookup-dropdown')) return;
    if (sel.closest('.modal')) return;
    if (isEdit) return;

    const locked = sel.dataset.lockedValue ?? '';
    if ((sel.value ?? '') !== locked) {
      sel.value = locked;
    }
    e.stopPropagation();
  }, true);
  document.addEventListener('keydown', (e) => {
    const sel = e.target;
    if (!(sel instanceof HTMLSelectElement)) return;
    if (!sel.matches('.erp-header-form select.lookup-dropdown')) return;
    if (sel.closest('.modal')) return;
    if (isEdit) return;

    const blockKeys = ['ArrowUp', 'ArrowDown', 'Home', 'End', 'PageUp', 'PageDown', ' ', 'Enter'];
    if (blockKeys.includes(e.key)) {
      e.preventDefault();
      e.stopPropagation();
    }
  }, true);

  // Á∑®ËºØÊ®°ÂºèÔºölookup input Áî® Backspace/Delete Áõ¥Êé•Ê∏ÖÁ©∫ÔºàÈÅøÂÖçË¢´ÂÖ∂‰ªñ keydown ÊîîÊà™Ôºâ
  document.addEventListener('keydown', (e) => {
    const inp = e.target;
    if (!(inp instanceof HTMLInputElement)) return;
    if (!inp.matches('.erp-header-form input.lookup-dropdown')) return;
    if (inp.closest('.modal')) return;
    if (!isEdit) return;
    if (e.key !== 'Backspace' && e.key !== 'Delete') return;
    if (inp.readOnly) return;
    if (!inp.value) return;
    const init = inp.dataset.init ?? inp.dataset.selected ?? '';
    const start = inp.selectionStart ?? 0;
    const end = inp.selectionEnd ?? 0;
    const allSelected = start === 0 && end === inp.value.length;
    const unchanged = String(inp.value ?? '') === String(init ?? '');
    if (allSelected || unchanged) {
      inp.value = '';
      syncLookupLabel(inp);
      e.preventDefault();
      e.stopPropagation();
    }
  }, true);
  const getHeaderValueByLabel = (labelText) => {
    const $label = $('.header-label-item').filter(function () {
      return $(this).text().trim() === labelText;
    }).first();
    if (!$label.length) return null;
    const fieldName = $label.data('field');
    if (!fieldName) return null;
    const $li = $(`.draggable-field[data-field="${fieldName}"]`).first();
    if (!$li.length) return null;
    const $ctrl = $li.find('select, input, textarea').first();
    if (!$ctrl.length) return null;
    if ($ctrl.is('select')) return $ctrl.find('option:selected').text().trim();
    return ($ctrl.val() || '').toString().trim();
  };

  editBtn.addEventListener('click', function () {
    const status = getHeaderValueByLabel('ÂñÆÊìöÁãÄÊÖã') || '';
    if (window.BLOCK_STATUSES && window.BLOCK_STATUSES.includes(status)) {
      Swal.fire({ icon: 'warning', title: 'ÁÑ°Ê≥ï‰øÆÊîπ', text: `Ê≠§ÂñÆÊìöÁãÄÊÖãÁÇ∫„Äå${status}„ÄçÔºå‰∏çÂèØÈÄ≤Ë°å‰øÆÊîπ„ÄÇ`}); return;
    }
    isEdit = !isEdit; editBtn.textContent = isEdit ? '‰øùÁïô' : '‰øÆÊîπ';
    applyHeaderEditState(isEdit); // ‚òÖ ‰∏çÂΩ±Èüø modal Ë£°ÁöÑÊ¨Ñ‰Ωç
    applyToolbarEditState(isEdit);
    if (isEdit) syncDetailInputsFromView();
    document.querySelectorAll('.erp-table .cell-view').forEach(el => {
      if (el.classList.contains('readonly-cell')) return;
      el.classList.toggle('d-none', isEdit);
    });
    document.querySelectorAll('.erp-table .cell-edit').forEach(el => {
      if (el.classList.contains('readonly-cell')) return;
      el.classList.toggle('d-none', !isEdit);
    });
    document.querySelectorAll('.erp-table .cell-edit').forEach(inp => {
      inp.addEventListener('input', () => {
        const tr = inp.closest('tr'); if (tr && tr.dataset.state !== 'added') tr.dataset.state = 'modified';
      });
    });
  });

  window.addEventListener('load', () => {
    applyHeaderEditState(false);
    applyToolbarEditState(false);
    if (localStorage.getItem("afterSave") === "1") {
      localStorage.removeItem("afterSave");
      document.getElementById("btnViewEditToggle")?.click();
    }
  });
}

// ============================
// 6) Header ÁâàÈù¢ÊãñÊãâÂÑ≤Â≠ò / Lookup ‰∏ãÊãâÂàùÂßãÂåñÔºàjQueryÔºâ
// ============================
$(function () {
  let debounceTimer;
  const debounceSave = () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(saveLayoutChanges, 400); };

  function saveLayoutChanges() {
    const layout = [];
    const headerTopPad = 6;
    const hiddenTabs = $(".tab-pane").not(".show");
    hiddenTabs.addClass("temporary-show").addClass("show").css("display", "block");
    $(".draggable-field").each(function () {
      const $li = $(this);
      const $label = $(`.header-label-item[data-field="${$li.data("field")}"]`).first();
      const labelPos = $label.length ? $label.position() : null;
      const fieldTop = Math.max(0, Math.round($li.position().top) - headerTopPad);
      const fieldLeft = Math.round($li.position().left);
      const labTop = labelPos ? Math.max(0, Math.round(labelPos.top) - headerTopPad) : null;
      const labLeft = labelPos ? Math.round(labelPos.left) : null;
      layout.push({
        fieldName: $li.data("field"),
        top: fieldTop,
        left: fieldLeft,
        width: Math.round($li.outerWidth()),
        height: Math.round($li.outerHeight()),
        labTop: labTop,
        labLeft: labLeft,
        ishowWhere: parseInt($li.attr("data-tab")) || 1
      });
    });
    hiddenTabs.removeClass("show").removeClass("temporary-show").css("display", "");
    if (!layout.length) return;

    fetch("/api/TableFieldLayout/SaveHeaderLayout", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tableName: "@Model.HeaderTableName", layoutUpdates: layout })
    }).catch(()=>{});
  }

  $(".draggable-field").each(function () {
    const $li = $(this);
    $li.draggable({
      handle: ".field-drag-handle",
      helper: function () {
        const labelText = $('.header-label-item[data-field="' + $li.data('field') + '"]').text().trim();
        return $("<div>").text(labelText).css({
          width: "80px", height: $li.outerHeight() + "px",
          background: "#eef", border: "1px dashed #999", padding: "4px", "font-size": "0.9em"
        });
      },
      appendTo: "body", zIndex: 10000,
      start: function () { $(this).hide(); },
      stop: function (event, ui) {
        const $item = $(this);
        $item.show();

        // ‰ΩøÁî® helper ÊãñÊõ≥ÊôÇÔºåÂéüÂÖÉÁ¥†‰∏çÊúÉËá™ÂãïÊèõ‰ΩçÁΩÆÔºåÈÄôË£°ÊâãÂãïÊää top/left ÂØ´Âõû parent Â∫ßÊ®ôÁ≥ª
        const $parent = $item.parent();
        const parentOff = $parent.offset();
        if (parentOff) {
          $item.css({
            position: "absolute",
            top: Math.round(ui.offset.top - parentOff.top),
            left: Math.round(ui.offset.left - parentOff.left)
          });
        }

        debounceSave();
      }
    });
    $li.resizable({ handles: "e, se", minWidth: 50, minHeight: 22, stop: debounceSave });
  });

  function setLayoutEditEnabled(enabled) {
    const $body = $(document.body);
    const uid = (localStorage.getItem('erpLoginUserId') || window._userId || '').toString().trim().toLowerCase();
    const cachedAdmin = uid ? localStorage.getItem(`erpIsAdmin:${uid}`) === '1' : false;
    const bodyAdmin = document.body?.dataset?.isAdmin === '1';
    const canEnable = !!enabled && (window.__isAdmin === true || cachedAdmin || bodyAdmin);
    $body.toggleClass("layout-edit-enabled", canEnable);
    $(".draggable-field").each(function () {
      try { $(this).draggable(canEnable ? "enable" : "disable"); } catch {}
      try { $(this).resizable(canEnable ? "enable" : "disable"); } catch {}
    });
  }

  setLayoutEditEnabled(false);
  $(document).on("keydown", function (e) {
    if (e.key === "Shift" || e.shiftKey) {
      window.__layoutShiftDown = true;
      setLayoutEditEnabled(true);
    }
  });
  $(document).on("keyup", function (e) {
    if (e.key === "Shift" || !e.shiftKey) {
      window.__layoutShiftDown = false;
      setLayoutEditEnabled(false);
    }
  });
  window.addEventListener('adminStateReady', () => {
    if (window.__layoutShiftDown) setLayoutEditEnabled(true);
  });

  // ============================
  // 6-1) Â§öÈÅ∏/Áæ§ÁµÑÊãñÊõ≥/Â∞çÈΩäÔºàÂø´Êç∑ÈçµÔºâ
  //  - Ctrl/Meta+ÈªûÊìäÔºöÂàáÊèõÈÅ∏Âèñ
  //  - ÈªûÊìäÁ©∫ÁôΩÔºöÊ∏ÖÈô§ÈÅ∏Âèñ
  //  - ÊãñÊõ≥‰ªª‰∏ÄË¢´ÈÅ∏ÂèñÁöÑ labelÔºöÊï¥ÁµÑ‰∏ÄËµ∑ÁßªÂãï
  //  - L/R/T/BÔºöÂ∑¶/Âè≥/‰∏ä/‰∏ãÂ∞çÈΩäÔºà‰ª•ÊâÄÈÅ∏Áæ§ÁµÑÁöÑÊúÄÂ∑¶/ÊúÄÂè≥/ÊúÄ‰∏ä/ÊúÄ‰∏ãÁÇ∫Ê∫ñÔºâ
  //  - H/VÔºöÊ∞¥Âπ≥/ÂûÇÁõ¥Âπ≥ÂùáÂàÜ‰ΩàÔºà‰øùÁïôÊúÄÂ∑¶/ÊúÄÂè≥ Êàñ ÊúÄ‰∏ä/ÊúÄ‰∏ãÔºâ
  //  - ÊñπÂêëÈçµÔºöÂæÆË™øÔºàShift=10pxÔºâ
  // ============================
  const $doc = $(document);
  const SELECTED_CLASS = "md-selected";
  let dragGroupSnapshot = null; // { baseEl, baseTop, baseLeft, items:[{el, top,left}] }

  function $allFields() { return $(".draggable-field"); }
  function getLabelForField($field) {
    const fieldName = $field?.data("field");
    if (!fieldName) return $();
    return $(`.header-label-item[data-field="${fieldName}"]`).first();
  }
  function moveLabel($label, top, left) {
    if (!$label || !$label.length) return;
    $label.css({ position: "absolute", top: Math.max(0, top), left: Math.max(0, left) });
  }
  function $selected() { return $allFields().filter("." + SELECTED_CLASS); }
  function isTypingTarget(e) {
    const t = e?.target;
    if (!t) return false;
    const tag = (t.tagName || "").toLowerCase();
    return tag === "input" || tag === "textarea" || tag === "select" || t.isContentEditable;
  }
  function clearSelection() { $selected().removeClass(SELECTED_CLASS); }
  function toggleSelection($el) { $el.toggleClass(SELECTED_CLASS); }
  function selectOnly($el) { clearSelection(); $el.addClass(SELECTED_CLASS); }

  // ÈªûÈÅ∏ÊéßÂà∂ÔºàÁî® mousedownÔºåÈÅøÂÖçË∑üÊãñÊõ≥Ë°ùÁ™ÅÔºâ
  $doc.on("mousedown", ".field-drag-handle", function (e) {
    if (window.__DICT_OPEN__) return;
    const $field = $(this).closest(".draggable-field");
    if (!$field.length) return;

    // Ctrl/MetaÔºöÂàáÊèõÂ§öÈÅ∏ÔºõÂê¶ÂâáÈªûÂà∞Êú™ÈÅ∏ÂèñÁöÑÂ∞±ÂñÆÈÅ∏
    if (e.ctrlKey || e.metaKey) {
      toggleSelection($field);
    } else if (!$field.hasClass(SELECTED_CLASS)) {
      selectOnly($field);
    }
  });
  $doc.on("mousedown", ".header-label-item", function (e) {
    if (window.__DICT_OPEN__) return;
    const fieldName = $(this).data("field");
    if (!fieldName) return;
    const $field = $(`.draggable-field[data-field="${fieldName}"]`).first();
    if (!$field.length) return;

    if (e.ctrlKey || e.metaKey) {
      toggleSelection($field);
    } else if (!$field.hasClass(SELECTED_CLASS)) {
      selectOnly($field);
    }
  });
  $doc.on("mousedown", function (e) {
    if (window.__DICT_OPEN__) return;
    if ($(e.target).closest(".draggable-field, .header-label-item, .ui-resizable-handle, .modal").length) return;
    clearSelection();
  });

  function ensureDragGroupSnapshot($base) {
    const $sel = $selected();
    const $group = ($sel.length ? $sel : $base);
    if (!$base.hasClass(SELECTED_CLASS) && $sel.length) selectOnly($base);
    dragGroupSnapshot = {
      baseEl: $base.get(0),
      baseTop: Math.round($base.position().top),
      baseLeft: Math.round($base.position().left),
      items: $group.toArray().map(el => {
        const $el = $(el);
        const $label = getLabelForField($el);
        const labelPos = $label.length ? $label.position() : null;
        return {
          el,
          top: Math.round($el.position().top),
          left: Math.round($el.position().left),
          labelEl: $label.get(0) || null,
          labelTop: labelPos ? Math.round(labelPos.top) : null,
          labelLeft: labelPos ? Math.round(labelPos.left) : null
        };
      })
    };
  }

  // ËÆìÊãñÊõ≥ÊôÇËÉΩÂ§†Êï¥ÁµÑ‰∏ÄËµ∑ÁßªÂãïÔºàÁî® draggable ÁöÑ start/stop hookÔºâ
  $doc.on("dragstart", ".draggable-field", function () { /* noop */ });
    $allFields().each(function () {
      const $li = $(this);
      // jQuery UI draggable Â∑≤ÂàùÂßãÂåñÔºå‰∏äÈù¢Â∑≤Ë®≠ÂÆö stopÔºõÈÄôË£°Áî® option Ê≥®ÂÖ• start/stop2 Ë°åÁÇ∫
      $li.draggable("option", "start", function (event) {
        if (window.__DICT_OPEN__) return;
        ensureDragGroupSnapshot($(this));
        $(this).hide();
      });
      $li.draggable("option", "drag", function (event, ui) {
        const $item = $(this);
        if (!dragGroupSnapshot || dragGroupSnapshot.baseEl !== $item.get(0)) return;
        const $parent = $item.parent();
        const parentOff = $parent.offset();
        if (!parentOff) return;
        const newTop = Math.round(ui.offset.top - parentOff.top);
        const newLeft = Math.round(ui.offset.left - parentOff.left);
        const dy = newTop - dragGroupSnapshot.baseTop;
        const dx = newLeft - dragGroupSnapshot.baseLeft;
        dragGroupSnapshot.items.forEach(it => {
          if (it.labelEl && it.labelTop != null && it.labelLeft != null) {
            moveLabel($(it.labelEl), it.labelTop + dy, it.labelLeft + dx);
          }
        });
      });
      $li.draggable("option", "stop", function (event, ui) {
        const $item = $(this);
        $item.show();

      const $parent = $item.parent();
      const parentOff = $parent.offset();
      if (!parentOff) return;

      const newTop = Math.round(ui.offset.top - parentOff.top);
      const newLeft = Math.round(ui.offset.left - parentOff.left);

      // ÂñÆÈ°ÜÊàñÁæ§ÁµÑÔºö‰ª• base ÁöÑ delta Â•óÁî®Âà∞ÊâÄÊúâÈÅ∏Âèñ
      if (dragGroupSnapshot && dragGroupSnapshot.baseEl === $item.get(0)) {
        const dy = newTop - dragGroupSnapshot.baseTop;
        const dx = newLeft - dragGroupSnapshot.baseLeft;
        dragGroupSnapshot.items.forEach(it => {
          const $el = $(it.el);
          $el.css({
            position: "absolute",
            top: Math.max(0, it.top + dy),
            left: Math.max(0, it.left + dx)
          });
          if (it.labelEl && it.labelTop != null && it.labelLeft != null) {
            moveLabel($(it.labelEl), it.labelTop + dy, it.labelLeft + dx);
          }
        });
        dragGroupSnapshot = null;
        debounceSave();
        return;
      }

      // fallbackÔºàÁêÜË´ñ‰∏äËµ∞‰∏çÂà∞Ôºâ
      const oldPos = $item.position();
      const dy = newTop - Math.round(oldPos.top);
      const dx = newLeft - Math.round(oldPos.left);
      $item.css({ position: "absolute", top: newTop, left: newLeft });
      const $label = getLabelForField($item);
      if ($label.length) {
        const labelPos = $label.position();
        moveLabel($label, Math.round(labelPos.top) + dy, Math.round(labelPos.left) + dx);
      }
      dragGroupSnapshot = null;
      debounceSave();
    });
  });

  function applyToSelected(mutator) {
    const $sel = $selected();
    if (!$sel.length) return false;
    $sel.each(function () { mutator($(this)); });
    debounceSave();
    return true;
  }
  function alignSelected(mode) {
    const $sel = $selected();
    if ($sel.length < 2) return false;
    const boxes = $sel.toArray().map(el => {
      const $el = $(el);
      const p = $el.position();
      const w = $el.outerWidth();
      const h = $el.outerHeight();
      const $ctrl = $el.find('select, input, textarea').first();
      const ctrlOff = $ctrl.length ? $ctrl.offset() : null;
      const elOff = $el.offset();
      const ctrlLeftAbs = ctrlOff?.left ?? elOff.left;
      const ctrlTopAbs = ctrlOff?.top ?? elOff.top;
      const ctrlW = $ctrl.length ? $ctrl.outerWidth() : w;
      const ctrlH = $ctrl.length ? $ctrl.outerHeight() : h;
      return {
        $el,
        top: Math.round(p.top),
        left: Math.round(p.left),
        right: Math.round(p.left + w),
        bottom: Math.round(p.top + h),
        w,
        h,
        ctrlLeftAbs,
        ctrlRightAbs: ctrlLeftAbs + ctrlW,
        ctrlTopAbs,
        ctrlBottomAbs: ctrlTopAbs + ctrlH,
        ctrlW,
        ctrlH
      };
    });
    // L/RÔºöÂ∞çÈΩä„ÄåËº∏ÂÖ•Ê¨Ñ‰Ωç„Äç(select/input/textarea)ÔºåËÄåÈùû label
    const minCtrlLeftAbs = Math.min(...boxes.map(b => b.ctrlLeftAbs));
    const maxCtrlRightAbs = Math.max(...boxes.map(b => b.ctrlRightAbs));

    const minLeft = Math.min(...boxes.map(b => b.left));
    const maxRight = Math.max(...boxes.map(b => b.right));
    const minTop = Math.min(...boxes.map(b => b.top));
    const maxBottom = Math.max(...boxes.map(b => b.bottom));

    boxes.forEach(b => {
      if (mode === "L") {
        const delta = minCtrlLeftAbs - b.ctrlLeftAbs;
        b.$el.css("left", Math.max(0, Math.round(b.left + delta)));
      }
      if (mode === "R") {
        const targetCtrlLeftAbs = maxCtrlRightAbs - b.ctrlW;
        const delta = targetCtrlLeftAbs - b.ctrlLeftAbs;
        b.$el.css("left", Math.max(0, Math.round(b.left + delta)));
      }
      if (mode === "T") b.$el.css("top", minTop);
      if (mode === "B") b.$el.css("top", Math.max(0, maxBottom - b.h));
    });
    debounceSave();
    return true;
  }
  function distributeSelected(axis) {
    const $sel = $selected();
    if ($sel.length < 3) return false;
    const boxes = $sel.toArray().map(el => {
      const $el = $(el);
      const p = $el.position();
      const w = $el.outerWidth();
      const h = $el.outerHeight();
      return { $el, top: Math.round(p.top), left: Math.round(p.left), w, h };
    });
    if (axis === "H") {
      boxes.sort((a, b) => a.left - b.left);
      const first = boxes[0], last = boxes[boxes.length - 1];
      const span = (last.left - first.left);
      const gaps = boxes.length - 1;
      const step = gaps ? Math.round(span / gaps) : 0;
      boxes.forEach((b, i) => b.$el.css("left", Math.max(0, first.left + step * i)));
    } else {
      boxes.sort((a, b) => a.top - b.top);
      const first = boxes[0], last = boxes[boxes.length - 1];
      const span = (last.top - first.top);
      const gaps = boxes.length - 1;
      const step = gaps ? Math.round(span / gaps) : 0;
      boxes.forEach((b, i) => b.$el.css("top", Math.max(0, first.top + step * i)));
    }
    debounceSave();
    return true;
  }

  $doc.on("keydown", function (e) {
    if (window.__DICT_OPEN__) return;
    if (isTypingTarget(e)) return;
    const key = (e.key || "").toUpperCase();

    // Â∞çÈΩä
    if (key === "L" || key === "R" || key === "T" || key === "B") {
      if (alignSelected(key)) { e.preventDefault(); return; }
    }
    // ÂàÜ‰Ωà
    if (key === "H" || key === "V") {
      if (distributeSelected(key)) { e.preventDefault(); return; }
    }
    // ÊñπÂêëÈçµÂæÆË™ø
    const step = e.shiftKey ? 10 : 1;
    if (e.key === "ArrowLeft")  { if (applyToSelected($el => $el.css("left", Math.max(0, Math.round($el.position().left) - step)))) { e.preventDefault(); } return; }
    if (e.key === "ArrowRight") { if (applyToSelected($el => $el.css("left", Math.max(0, Math.round($el.position().left) + step)))) { e.preventDefault(); } return; }
    if (e.key === "ArrowUp")    { if (applyToSelected($el => $el.css("top",  Math.max(0, Math.round($el.position().top) - step)))) { e.preventDefault(); } return; }
    if (e.key === "ArrowDown")  { if (applyToSelected($el => $el.css("top",  Math.max(0, Math.round($el.position().top) + step)))) { e.preventDefault(); } return; }
  });

  $(".header-fields-tab").droppable({
    accept: ".draggable-field", tolerance: "pointer",
    over: function () { $(this).addClass("drop-hover"); },
    out:  function () { $(this).removeClass("drop-hover"); },
    drop: function (event, ui) {
      $(this).removeClass("drop-hover");
      const $zone = $(this), $item = $(ui.draggable);
      const newTabIndex = parseInt($zone.data("tab-index")) || 1;
      $item.appendTo($zone).attr("data-tab", newTabIndex).css({
        top: ui.offset.top - $zone.offset().top,
        left: ui.offset.left - $zone.offset().left,
        position: "absolute"
      });
      debounceSave();
    }
  });

  let dragTabSwitchTimer = null;
  $("#headerTabs button").droppable({
    accept: ".draggable-field",
    over: function () { const $tabBtn = $(this); dragTabSwitchTimer = setTimeout(() => { $tabBtn.trigger("click"); }, 600); },
    out:  function () { clearTimeout(dragTabSwitchTimer); }
  });

  function readHeaderFieldValue(fieldName) {
    const target = (fieldName || '').toLowerCase();
    if (!target) return '';
    const fields = document.querySelectorAll('form.erp-header-form input[name], form.erp-header-form textarea[name], form.erp-header-form select[name]');
    for (const el of fields) {
      const name = (el.getAttribute('name') || '').toLowerCase();
      if (name !== target) continue;
      if (el.type === 'checkbox') return el.checked ? '1' : '0';
      if (el.classList?.contains('lookup-dropdown')) {
        const hidden = el.closest('li')?.querySelector('input.lookup-key[name]');
        if (hidden) return (hidden.value ?? '').toString().trim();
        const raw = (el.value ?? '').toString().trim();
        return (raw.split(' - ')[0] || raw).trim();
      }
      return (el.value ?? '').toString().trim();
    }
    return '';
  }
  if (!window.readHeaderValue) window.readHeaderValue = readHeaderFieldValue;

  function normalizeLookupKey(value) {
    return (value ?? '').toString().trim().toLowerCase();
  }

  function resolveCondValue(fieldOrLabel) {
    const key = (fieldOrLabel || '').toString().trim();
    if (!key) return '';
    const direct = readHeaderFieldValue(key);
    if (direct) return direct;
    const labelEl = Array.from(document.querySelectorAll('.header-label-item'))
      .find(el => (el.textContent || '').trim() === key);
    const field = labelEl?.getAttribute('data-field') || '';
    if (!field) return '';
    return readHeaderFieldValue(field);
  }

  function getLookupLabel(key, keyToLabel) {
    if (!key || !keyToLabel) return '';
    if (keyToLabel[key] != null) return keyToLabel[key];
    const lower = normalizeLookupKey(key);
    return lower && keyToLabel[lower] != null ? keyToLabel[lower] : '';
  }

  function mapLookupKey(raw, labelToKey) {
    if (!raw || !labelToKey) return raw ?? '';
    if (labelToKey[raw] != null) return labelToKey[raw];
    const lower = normalizeLookupKey(raw);
    return lower && labelToKey[lower] != null ? labelToKey[lower] : raw;
  }

  function formatLookupDisplay(code, label) {
    if (!code) return '';
    const c = String(code);
    const l = label == null ? '' : String(label);
    if (!l) return c;
    if (l === c) return c;
    const cLower = c.toLowerCase();
    const lLower = l.toLowerCase();
    if (lLower === cLower) return l;
    if (lLower.startsWith(cLower + ' - ') || lLower.startsWith(cLower + '-') || lLower.startsWith(cLower + ' ')) return l;
    return `${c} - ${l}`;
  }

  $('.lookup-dropdown').each(function() {
    const $ctrl = $(this);
    const el = $ctrl[0];

    function loadLookupOptions() {
      if (!el || el.dataset.lookupLoading === '1') return;
      const table = (el.dataset.table || '').trim();
      const key = (el.dataset.key || '').trim();
      const result = (el.dataset.result || '').trim();
      const selected = el.dataset.selected ?? '';
      if (!table || !key || !result) return;

      const cond1Field = (el.dataset.cond1Field || '').trim();
      const cond1Source = (el.dataset.cond1Source || '').trim();
      const cond2Field = (el.dataset.cond2Field || '').trim();
      const cond2Source = (el.dataset.cond2Source || '').trim();
      const cond1ValueField = cond1Field || cond1Source;
      const cond2ValueField = cond2Field || cond2Source;
      const cond1Value = cond1ValueField ? resolveCondValue(cond1ValueField) : '';
      const cond2Value = cond2ValueField ? resolveCondValue(cond2ValueField) : '';
      const condKey = `${cond1Field}:${cond1Value}|${cond2Field}:${cond2Value}`;
      if (el.dataset.lookupLoaded === '1' && el.dataset.lookupCondKey === condKey) return;

      el.dataset.lookupCondKey = condKey;
      el.dataset.lookupLoading = '1';
      const url = `/api/TableFieldLayout/LookupData?table=${encodeURIComponent(table)}&key=${encodeURIComponent(key)}&result=${encodeURIComponent(result)}`
        + (cond1Field && cond1Value ? `&cond1Field=${encodeURIComponent(cond1Field)}&cond1Value=${encodeURIComponent(cond1Value)}` : '')
        + (cond2Field && cond2Value ? `&cond2Field=${encodeURIComponent(cond2Field)}&cond2Value=${encodeURIComponent(cond2Value)}` : '');

      const req = $.getJSON(url, function(data) {
        const rows = data || [];
        if ($ctrl.is('select')) {
          $ctrl.empty().append('<option value="">--Ë´ãÈÅ∏Êìá--</option>');
          rows.forEach(row => {
            const val = row.key;
            const label = Object.keys(row).filter(p => p.startsWith('result')).map(p => row[p]).join(' - ');
            const $opt = $('<option>').val(val).text(label);
            if (val == selected) $opt.attr('selected', true);
            $ctrl.append($opt);
          });
          $ctrl.next('.lookup-label').text($ctrl.find('option:selected').text());
          if ($ctrl.hasClass('lookup-readonly') && $ctrl[0]) {
            $ctrl[0].dataset.lockedValue = $ctrl.val() ?? '';
          }
          el.dataset.lookupLoaded = '1';
          return;
        }

        const inputEl = $ctrl[0];
        const listId = $ctrl.attr('list');
        let listEl = listId ? document.getElementById(listId) : null;
        if (!listEl) {
          listEl = document.createElement('datalist');
          if (listId) listEl.id = listId;
          inputEl.after(listEl);
        }
        listEl.innerHTML = '';

        const keyToLabel = {};
        const labelToKey = {};
        const addListOption = (value, label) => {
          if (!value) return;
          const opt = document.createElement('option');
          opt.value = value;
          if (label) opt.label = label;
          listEl.appendChild(opt);
        };
        rows.forEach(row => {
          const val = row.key;
          const label = Object.keys(row).filter(p => p.startsWith('result')).map(p => row[p]).join(' - ');
          const keyStr = val == null ? '' : String(val);
          keyToLabel[keyStr] = label;
          const normKey = normalizeLookupKey(keyStr);
          if (normKey && keyToLabel[normKey] == null) keyToLabel[normKey] = label;
          if (label) {
            labelToKey[label] = keyStr;
            const dispLower = normalizeLookupKey(label);
          if (dispLower && labelToKey[dispLower] == null) labelToKey[dispLower] = keyStr;
          }
          const display = formatLookupDisplay(keyStr, label);
          if (display) {
            labelToKey[display] = keyStr;
            const dispLower = normalizeLookupKey(display);
            if (dispLower && labelToKey[dispLower] == null) labelToKey[dispLower] = keyStr;
          }
          labelToKey[keyStr] = keyStr;
          if (normKey && labelToKey[normKey] == null) labelToKey[normKey] = keyStr;
          const displayVal = display || keyStr;
          addListOption(displayVal, keyStr);
          if (keyStr && displayVal !== keyStr) {
            addListOption(keyStr, displayVal);
          }
        });

        inputEl._lookupKeyToLabel = keyToLabel;
        inputEl._lookupLabelToKey = labelToKey;
        const initKey = selected ?? '';
        if (initKey !== '') inputEl.value = formatLookupDisplay(initKey, getLookupLabel(initKey, keyToLabel));
        const hidden = inputEl.closest('li')?.querySelector('input.lookup-key[name]');
        if (hidden) hidden.value = initKey;
        syncLookupLabel(inputEl);
        el.dataset.lookupLoaded = '1';
      });

      req.always(() => { delete el.dataset.lookupLoading; });
    }

    loadLookupOptions();

    if ($ctrl.is('select')) {
      $ctrl.on('change', function() {
        $(this).next('.lookup-label').text($(this).find('option:selected').text());
      });
      $ctrl.on('focus', function() {
        loadLookupOptions();
      });
    } else {
      $ctrl.on('input', function() {
        syncLookupLabel(this);
      });
      $ctrl.on('change', function() {
        const keyToLabel = this._lookupKeyToLabel || {};
        const labelToKey = this._lookupLabelToKey || {};
        const raw = (this.value ?? '').toString().trim();
        const key = mapLookupKey(raw, labelToKey) ?? raw;
        const label = getLookupLabel(key, keyToLabel);
        const display = formatLookupDisplay(key, label);
        if (display) this.value = display;
        syncLookupLabel(this);
      });
      $ctrl.on('focus', function() {
        loadLookupOptions();
        try {
          const len = (this.value || '').length;
          if (len) {
            this.setSelectionRange(0, len);
          } else {
            this.select();
          }
        } catch { }
      });
      $ctrl.on('keydown', function(e) {
        if (e.key !== 'Backspace' && e.key !== 'Delete') return;
        if (this.readOnly) return;
        if (!this.value) return;
        const init = this.dataset.init ?? this.dataset.selected ?? '';
        const start = this.selectionStart ?? 0;
        const end = this.selectionEnd ?? 0;
        const allSelected = start === 0 && end === this.value.length;
        const unchanged = String(this.value ?? '') === String(init ?? '');
        if (allSelected || unchanged) {
          this.value = '';
          syncLookupLabel(this);
          e.preventDefault();
        }
      });
    }
  });

  function setInitialTabHeights(offsetPx = 10) {
    const hiddenTabs = $(".tab-pane").not(".show");
    hiddenTabs.addClass("tmp-show").addClass("show").css("display", "block");
    $(".header-fields-tab").each(function () {
      let maxBottom = 0;
      $(this).children(".draggable-field").each(function () {
        const $el = $(this);
        maxBottom = Math.max(maxBottom, $el.position().top + $el.outerHeight());
      });
      $(this).height(Math.max(0, Math.ceil(maxBottom + offsetPx)));
    });
    hiddenTabs.removeClass("show tmp-show").css("display", "");
  }
  requestAnimationFrame(() => setInitialTabHeights(10));
});

// ============================
// 7) ‰∏ä‰∏ÄÁ≠Ü / ‰∏ã‰∏ÄÁ≠Ü
// ============================
const NAV_BTN_PREV = document.getElementById('btnPrev');
const NAV_BTN_NEXT = document.getElementById('btnNext');
let navIds = [], navIndex = -1;

function loadLastFilters() {
  try { const s = localStorage.getItem("orderListQueryFilters"); return s ? JSON.parse(s) : []; }
  catch { return []; }
}
function getDetailBasePath() { return location.pathname.replace(/\/[^\/]+$/, "/"); }
function gotoPaper(pn) { if (!pn) return; localStorage.setItem("lastViewedPaperNum", pn); location.href = getDetailBasePath() + pn; }
function updateNavButtons() {
  const hasPrev = navIndex > 0;
  const hasNext = navIndex >= 0 && navIndex < navIds.length - 1;
  NAV_BTN_PREV.disabled = !hasPrev;
  NAV_BTN_NEXT.disabled = !hasNext;
  NAV_BTN_PREV.onclick = () => hasPrev && gotoPaper(navIds[navIndex - 1]);
  NAV_BTN_NEXT.onclick = () => hasNext && gotoPaper(navIds[navIndex + 1]);
}
async function fetchIdListByApi(filters) {
  // ÂèñÂæóÊâÄÊúâ id ÂàóË°®ÔºåËµ∞ÈÄöÁî® DynamicTable API
  const itemId = (window._itemId || window._singleItemId || '').toString().trim();
  const res = await fetch('/api/DynamicTable/PagedQuery', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ table: PAGE.headerTable, itemId, filters: [...(filters || []), {Field:"page",Op:"",Value:"1"}, {Field:"pageSize",Op:"",Value:"999999"}] })
  });
  const json = await res.json();
  const rows = Array.isArray(json.data) ? json.data : [];
  return rows.map(r => r[PAGE.keyField]).filter(Boolean);
}
async function fetchIdListByPagedQuery(filters) {
  // Âêå‰∏äÔºåÁõ¥Êé•Áî® DynamicTable ÂèñÂæóÂ§ßÁ≠ÜÊï∏Êìö
  const itemId = (window._itemId || window._singleItemId || '').toString().trim();
  const fs = [...(filters || []), {Field:"page",Op:"",Value:"1"}, {Field:"pageSize",Op:"",Value:"999999"}];
  const res = await busyFetch('/api/DynamicTable/PagedQuery', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ table: PAGE.headerTable, itemId, filters: fs })
  },'ÂàáÊèõ‰∏≠‚Ä¶');
  const json = await res.json();
  const rows = Array.isArray(json.data) ? json.data : [];
  return rows.map(r => r[PAGE.keyField]).filter(Boolean);
}
async function initRowNavigation() {
  try {
    const filters = loadLastFilters();
    try { navIds = await fetchIdListByApi(filters); }
    catch { navIds = await fetchIdListByPagedQuery(filters); }
    navIndex = navIds.indexOf(PAGE.paperNum);
    updateNavButtons();
  } catch {
    NAV_BTN_PREV.disabled = true; NAV_BTN_NEXT.disabled = true;
  }
}
initRowNavigation();

// ============================
// 8) ÂÖ∂‰ªñÔºöÊääÊúÄÂæåÊ™¢Ë¶ñÁöÑÂñÆËôüÂ≠òÂú® localStorage
// ============================
localStorage.setItem("lastViewedPaperNum", window.selectedPaperNum);
function getHeaderValueByLabel(labelText) {
  const labelEl = Array.from(document.querySelectorAll('.header-label-item'))
    .find(el => (el.textContent || '').trim() === labelText);
  if (!labelEl) return '';
  const fieldName = labelEl.getAttribute('data-field') || '';
  if (!fieldName) return '';
  const li = document.querySelector(`.draggable-field[data-field="${CSS.escape(fieldName)}"]`);
  if (!li) return '';
  const ctrl = li.querySelector('select, input, textarea');
  if (!ctrl) return '';
  if (ctrl.tagName.toLowerCase() === 'select') {
    const opt = ctrl.options[ctrl.selectedIndex];
    return (opt?.text || opt?.value || '').trim();
  }
  return (ctrl.value || '').trim();
}

// ÂñÆË∫´ÊãñÊõ≥Ê¨Ñ‰ΩçÂØ¨Â∫¶Ë™øÊï¥
(function enableDetailColumnResize(){
  const table = document.querySelector('.erp-table');
  if (!table) return;

  const detailTableName = (PAGE.detailTable || '').replace(/^dbo\./i, '').trim().toLowerCase();
  const saveUrl = '/api/TableFieldLayout/SaveDetailLayout';
  let isDown = false, startX = 0, startWidth = 0, th, thIndex = -1;
  const ths = Array.from(table.querySelectorAll('thead th'));
  function columnCells(index){ return Array.from(table.querySelectorAll(`tbody tr td:nth-child(${index+1})`)); }

  let saveTimer = null;
  function debounceSave(){ clearTimeout(saveTimer); saveTimer = setTimeout(persistWidths, 400); }

  async function persistWidths(){
    try{
      const payload = { tableName: detailTableName, cols: ths.map(th => ({ fieldName: th.dataset.field, width: Math.round(th.getBoundingClientRect().width) })) };
      await fetch(saveUrl, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) }).catch(()=>{});
      localStorage.setItem(`colwidth:${detailTableName}`, JSON.stringify(payload.cols));
    }catch(e){}
  }

  (function applyInitialWidths(){
    try{
      const raw = localStorage.getItem(`colwidth:${detailTableName}`); if (!raw) return;
      const cols = JSON.parse(raw) || [];
      cols.forEach(c => {
        const th = ths.find(x => (x.dataset.field||'').toLowerCase() === (c.fieldName||'').toLowerCase());
        if (!th) return;
        th.style.width = `${c.width}px`;
        const idx = ths.indexOf(th);
        columnCells(idx).forEach(td => td.style.width = `${c.width}px`);
      });
    }catch(e){}
  })();

  ths.forEach((h, idx) => {
    const handle = h.querySelector('.col-resizer');
    if (!handle) return;
    handle.addEventListener('mousedown', (e) => {
      e.preventDefault();
      isDown = true; th = h; thIndex = idx;
      startX = e.pageX; startWidth = th.getBoundingClientRect().width;
      document.body.classList.add('resizing'); th.classList.add('resizing');
      columnCells(thIndex).forEach(td => td.classList.add('resizing'));
    });
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDown || !th) return;
    const dx = e.pageX - startX;
    const newW = Math.max(30, startWidth + dx);
    th.style.width = `${newW}px`;
    columnCells(thIndex).forEach(td => td.style.width = `${newW}px`);
  });

  document.addEventListener('mouseup', () => {
    if (!isDown) return;
    isDown = false;
    document.body.classList.remove('resizing');
    th?.classList.remove('resizing');
    columnCells(thIndex).forEach(td => td.classList.remove('resizing'));
    debounceSave();
    th = null; thIndex = -1;
  });
})();

function normalizeBool(val) {
  const s = (val ?? '').toString().trim().toLowerCase();
  return s === '1' || s === 'true' || s === 'y' || s === 'yes';
}

function syncLookupLabel(selectEl) {
  if (!selectEl) return;
  const label = selectEl.nextElementSibling;
  if (selectEl instanceof HTMLSelectElement) {
    if (label && label.classList.contains('lookup-label')) {
      const text = selectEl.options[selectEl.selectedIndex]?.text ?? '';
      label.textContent = text;
    }
    return;
  }
  if (selectEl instanceof HTMLInputElement) {
    const keyToLabel = selectEl._lookupKeyToLabel || {};
    const labelToKey = selectEl._lookupLabelToKey || {};
    const raw = selectEl.value ?? '';
    const key = mapLookupKey(raw, labelToKey) ?? raw;
    const labelText = getLookupLabel(key, keyToLabel);
    const display = formatLookupDisplay(key, labelText) || raw;
    if (labelText && raw !== display) {
      selectEl.value = display;
    }
    if (label && label.classList.contains('lookup-label')) {
      label.textContent = display;
    }
    const hidden = selectEl.closest('li')?.querySelector('input.lookup-key[name]');
    if (hidden) hidden.value = raw === '' ? '' : key;
  }
}

function captureHeaderInitValues() {
  document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
    .forEach(el => {
      if (el.closest('.modal')) return;
      if (el.dataset.init != null) return;
      if (el.type === 'checkbox') {
        el.dataset.init = el.checked ? '1' : '0';
      } else {
        el.dataset.init = el.value ?? '';
      }
    });
}

function resetHeaderForm() {
  document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
    .forEach(el => {
      if (el.closest('.modal')) return;
      const init = el.dataset.init ?? '';
      if (el.type === 'checkbox') {
        el.checked = normalizeBool(init);
      } else {
        el.value = init;
      }
      if (el.matches('.lookup-dropdown')) syncLookupLabel(el);
    });
}

function resetDetailTable() {
  const tbody = document.querySelector('.erp-table tbody');
  if (!tbody) return;
  Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
    const state = (tr.dataset.state || '').toString().toLowerCase();
    if (state === 'added') {
      tr.remove();
      return;
    }

    tr.dataset.state = 'unchanged';
    tr.querySelectorAll('.cell-edit').forEach(inp => {
      const init = inp.dataset.init ?? '';
      if (inp.type === 'checkbox') {
        inp.checked = normalizeBool(init);
      } else {
        inp.value = init;
      }
      const view = inp.closest('td')?.querySelector('.cell-view');
      if (view && inp.type !== 'checkbox') view.textContent = init;
      if (view && inp.type === 'checkbox') {
        const viewChk = view.querySelector('input.cell-view-checkbox');
        if (viewChk) viewChk.checked = normalizeBool(init);
      }
    });
    tr.querySelectorAll('.cell-view').forEach(el => el.classList.remove('d-none'));
    tr.querySelectorAll('.cell-edit').forEach(el => el.classList.add('d-none'));
  });
  _pendingNewDetailRow = null;
  showPendingButtons(false);
}

// Êú™ÂÑ≤Â≠òÊóóÊ®ô
window.__unsavedChanges = false;
document.addEventListener('input', (e) => {
  if (e.target.closest('.erp-header-form, .erp-table')) window.__unsavedChanges = true;
});
window.addEventListener('pageshow', () => { window.__unsavedChanges = false; });
window.addEventListener('load', () => { captureHeaderInitValues(); });

const cancelChangesBtn = document.getElementById('btnCancelChanges');
if (cancelChangesBtn) {
  cancelChangesBtn.addEventListener('click', () => {
    if (window.__unsavedChanges) {
      if (!confirm('ÂèñÊ∂àÊú™ÂÑ≤Â≠òÁöÑËÆäÊõ¥‰∏¶ÈÇÑÂéüË≥áÊñôÔºü')) return;
    }
    resetHeaderForm();
    resetDetailTable();
    window.__unsavedChanges = false;
  });
}
</script>


<style>
/* =========================================
   A) ÂÖ®Â±Ä/ÁâàÈù¢
   ========================================= */
body { background: #f7f9fb !important; }
.erp-detail-container { min-height: 100vh; padding: 12px 0; margin-left: 3vw; margin-right: 3vw; }

/* =========================================
   B) Header Ë°®ÂñÆ & Tabs
   ========================================= */
.erp-header-form,
.erp-header-form select,
.erp-header-form textarea,
.erp-header-form input { font-size: var(--field-value-size); }

.erp-header-form,
.erp-table-wrapper{
  padding-left: var(--detail-left-pad);
  max-width: var(--detail-max-width);
  width: 100%;
  box-sizing: border-box;
}

.erp-header-form .row{
  margin-left: 0;
  margin-right: 0;
  --bs-gutter-x: 0;
}

.erp-header-form select.form-select{
  font-size: 1em !important; height: 100% !important; min-height: 22px !important; line-height: 1.2 !important;
  padding: 2px 30px 2px 6px !important; appearance: none; -webkit-appearance: none; -moz-appearance: none;
  background-image: url('data:image/svg+xml;utf8,<svg width="11" height="11" fill="gray" xmlns="http://www.w3.org/2000/svg"><path d="M2 4.5l3.5 3.5L9 4.5" stroke="gray" stroke-width="2" fill="none" stroke-linecap="round"/></svg>');
  background-repeat: no-repeat; background-position: right 10px center; background-size: 14px 14px; box-shadow: none !important; border-radius: 0 !important;
  margin: 0 !important;
}
.header-fields-tab{
  position: relative; min-height: 120px; padding-top: 6px; padding-bottom: 8px;
  width: 100%;
  box-sizing: border-box;
  background: #eef2f9 !important; box-shadow: 0 2px 6px rgba(0,0,0,0.04);
}
.drop-hover{ background-color:#cce5ff !important; border-radius:4px; }

.erp-header-form .nav-tabs .nav-link{ border-radius:8px 8px 0 0 !important; padding:var(--tab-pad-y) var(--tab-pad-x); font-size:var(--field-label-size); font-weight:500; color:#235eb8; }
.erp-header-form .nav-tabs .nav-link.active{
  background:#fff; color:#124d8b; border-color:#bdd2f7 #bdd2f7 #fff #bdd2f7 !important; box-shadow:0 2px 6px 0 #e4ecf7; font-weight:bold;
}

.top-toolbar{
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.top-toolbar .toolbar-icon-row{
  display: flex;
  gap: 6px;
  align-items: center;
}
.top-toolbar .toolbar-main{
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.top-toolbar .toolbar-btn{
  font-size: var(--top-toolbar-font-size);
  height: var(--top-toolbar-btn-height);
  min-height: var(--top-toolbar-btn-height);
  padding: 0 6px;
  line-height: 1;
}
.top-toolbar .toolbar-btn-icon{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: var(--top-toolbar-btn-height);
  min-height: var(--top-toolbar-btn-height);
  padding: 0;
  width: 30px;
  border-radius: 8px;
  font-size: var(--top-toolbar-icon-font-size);
  line-height: 1;
}
.top-toolbar .toolbar-btn-icon .toolbar-icon{
  display: inline-block;
}
.top-toolbar #btnPrev .toolbar-icon,
.top-toolbar #btnNext .toolbar-icon,
.top-toolbar #btnSubDetailDelete .toolbar-icon{
  transform: translateY(-3px);
}
.top-toolbar .toolbar-btn:disabled{
  background: #9aa7bb;
  cursor: not-allowed;
  box-shadow: none;
  opacity: 0.7;
}
.top-toolbar .toolbar-btn-add{
  background: #0e9f4b;
}
.top-toolbar .toolbar-btn-del{
  background: #e04848;
}
.top-toolbar .toolbar-btn-cancel{
  background: #e04848;
}
.top-toolbar .toolbar-btn-check,
.top-toolbar .toolbar-btn-cancel{
  font-size: 18px;
}

/* draggable Ê¨Ñ‰ΩçÔºàÊ©´Êéí label + Êéß‰ª∂Ôºâ */
.draggable-field{ position:absolute; display:flex; flex-direction:column; box-sizing:border-box; overflow:hidden; background:transparent; border:1px dashed transparent; }
.draggable-field:hover{ border-color:#c7d3e1; }
.draggable-field.inline{ display:flex; flex-direction:row; align-items: center; gap:4px; flex:0 0 auto; min-width:0; max-width:100%; box-sizing:border-box; }
.header-label-item{ position:absolute; display:flex; align-items:center; justify-content:flex-end; text-align:right; font-size:var(--field-label-size); line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding:0 4px 0 2px; z-index:2; pointer-events:none; }
.field-drag-handle{ position:absolute; left:0; top:0; width:10px; height:100%; cursor:default; background:transparent; z-index:3; }
.draggable-field.inline .field-control{ flex:1 1 auto; height:100%; display:flex; }
.draggable-field.inline textarea,
.draggable-field.inline input,
.draggable-field.inline .form-select{
  flex:1 1 auto; width:100%; height:100%; min-height:22px; min-width:0; max-width:100%; line-height:1.2; resize:none; padding:4px 6px; font-size:0.95em; border-radius:0 !important; box-sizing:border-box;
  text-align: left;
}
.draggable-field.inline.field-number textarea,
.draggable-field.inline.field-number input,
.draggable-field.inline.field-number .form-select{
  text-align: right !important;
}
.erp-header-form textarea[data-align="right"],
.erp-header-form input[data-align="right"],
.erp-header-form select[data-align="right"]{
  text-align: right !important;
}
.erp-header-form .resizable-input{
  padding: 2px 4px !important;
  resize: none !important;
  overflow: hidden;
  white-space: nowrap;
}
.draggable-field.inline label{
  white-space: nowrap !important;
  overflow: visible !important;
  text-overflow: clip !important;
  max-width: none !important;
}
.partnum-field{ position: relative; }
.partnum-lookup-btn{
  position: absolute;
  top: 0;
  right: 0;
  height: 100%;
  width: 22px;
  border: 0;
  border-left: 1px solid #cfd7e6;
  background: #e9f1ff;
  color: #1f5fbf;
  font-weight: 700;
  line-height: 1;
  padding: 0;
  cursor: pointer;
}
.partnum-lookup-btn:hover{ background: #dbe9ff; }
.partnum-field textarea,
.partnum-field input,
.partnum-field select{
  padding-right: 26px !important;
}
.erp-table td.partnum-field .cell-view,
.erp-table td.partnum-field .cell-edit{
  padding-right: 26px !important;
}
.draggable-field.md-selected{
  border-radius: 8px;
  border-color:#5b8def;
  background:rgba(91,141,239,0.08);
}
.erp-header-form select.lookup-dropdown.lookup-readonly,
.erp-header-form input.lookup-dropdown.lookup-readonly{
  /* ÁÄèË¶ΩÊ®°ÂºèÂÖÅË®±Â±ïÈñã‰∏ãÊãâÔºå‰ΩÜ‰∏çÂÖÅË®±‰øÆÊîπÔºöÂ§ñËßÄÊØîÁÖß disabled ÁöÑÁÅ∞Â∫ï */
  background-color: var(--bs-secondary-bg, #e9ecef) !important;
  color: var(--bs-secondary-color, #6c757d) !important;
  opacity: 1; /* ÈÅøÂÖçÂÉè disabled ‰∏ÄÊ®£Êï¥È´îËÆäÊ∑° */
  cursor: default;
}
.erp-header-form select.lookup-dropdown.lookup-readonly:focus,
.erp-header-form input.lookup-dropdown.lookup-readonly:focus{
  border-color: #ced4da;
  box-shadow: none !important;
}
.erp-header-form select.lookup-dropdown option,
.erp-header-form select.lookup-dropdown optgroup{
  background-color: var(--bs-body-bg, #fff) !important;
  color: var(--bs-body-color, #212529) !important;
}
/* jQuery UI resizableÔºöËÆìÂè≥ÂÅ¥ÊãâÂØ¨ÊääÊâãÊõ¥Â•ΩÊäì */
.draggable-field.ui-resizable .ui-resizable-e{
  position: absolute;
  top: 0; right: 0; width: 10px; height: 100%;
  cursor: ew-resize; background: transparent;
  z-index: 5;
}
.draggable-field.ui-resizable:hover .ui-resizable-e{
  background: rgba(32,86,172,0.10);
}
.draggable-field.ui-resizable .ui-resizable-se{
  position: absolute;
  right: 0; bottom: 0; width: 14px; height: 14px;
  cursor: se-resize; background: transparent;
  z-index: 5;
}
.field-drag-handle,
.draggable-field.ui-resizable .ui-resizable-e,
.draggable-field.ui-resizable .ui-resizable-se{
  display: none;
}
.layout-edit-enabled .field-drag-handle,
.layout-edit-enabled .draggable-field.ui-resizable .ui-resizable-e,
.layout-edit-enabled .draggable-field.ui-resizable .ui-resizable-se{
  display: block;
}
.layout-edit-enabled .field-drag-handle{
  cursor: move;
}
.layout-edit-enabled .header-label-item{
  pointer-events: auto;
}

/* =========================================
   C) ÊòéÁ¥∞Ë°®Ê†ºÔºàË¶ñË¶∫ & Á∑®ËºØÔºâ
   ========================================= */
.erp-table-wrapper{
  background:#fff; box-shadow:0 4px 18px 0 #c3d4e6; max-width:1400px; overflow-x:auto;
  padding:8px !important; border-radius:0 0 13px 13px; border:1px solid #d6dbe5;
}
.erp-table{ width:100%; border-collapse:separate; border-spacing:0; font-size:1.06em; background:#fff; }
.erp-table thead tr{ background:#e7ecf3; }
.erp-table th, .erp-table td{
  box-sizing: border-box;
  background:#f1f5fb; padding:6px 8px; border-bottom:1px solid #c5d1e4; white-space:nowrap; text-align:center;
  font-weight:500; border-right:1px solid #dde4ed; height:34px;
}
.erp-table th:last-child, .erp-table td:last-child{ border-right:none; }
.erp-table th{ color:#124d8b; font-weight:700; font-size:.92em; letter-spacing:.5px; background:#e7ecf3; }
.erp-table tbody tr:nth-child(even){ background:#f6f9fd; }
.erp-table tbody tr:hover{ background:#eef7ff; }

/* È°ØÁ§∫/Á∑®ËºØÈõôÂ±§Ôºöspan È°ØÁ§∫„ÄÅinput Á∑®ËºØÔºàÂàáÊèõ displayÔºâ */
.erp-table th{ font-size: var(--field-label-size); }
.erp-table td{ position:relative; padding:0; font-size: var(--field-value-size); }
.erp-table td .cell-view{
  display:inline-block;
  width:100%;
  text-align:inherit;
  padding:0 4px;
  box-sizing:border-box;
}
.erp-table td.detail-number{ text-align: right; }
.erp-table td.detail-text{ text-align: left; }
.erp-table td .cell-edit{
  width:100% !important; height:100% !important; box-sizing:border-box; margin:0; border:none; border-radius:0;
  background:#fff !important; font-size:inherit !important; font-weight:inherit !important; font-family:inherit !important;
  line-height:inherit !important; text-align:inherit !important; padding:0 4px;
}
.erp-table td[style*="background-color"] .cell-edit{
  background-color: transparent !important;
}

/* Êï¥ÂàóÈÅ∏ÂèñÈ´ò‰∫ÆÔºÜÂ∑¶ÂÅ¥ËóçÊ¢ù */
.erp-table tbody tr.row-selected > td{ background:#fff8c6 !important; }
.erp-table tbody tr.row-selected > td:first-child{ position:relative; }
.erp-table tbody tr.row-selected > td:first-child::after{
  content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background:#0d6efd; border-radius:2px;
}
/* ÁßªÈô§È†êË®≠ focus ËóçÊ°Ü */
.erp-table td:focus, .erp-table td *:focus{ outline:none !important; box-shadow:none !important; }

/* =========================================
   D) ÂÖ∂ÂÆÉ
   ========================================= */
.highlight-red { color:#e53b2d; font-weight:700; }
.highlight-blue{ color:#2564b3; font-weight:700; }

/* --- Action Rail Âü∫Á§éÁâà‰Ωç & ÂÖßÂÆπÂè≥ÁßªÔºàÂõ∫ÂÆöÂú®Ê®£ÊùøÔºâ--- */
:root{
  --fab-left: 12px;
  --fab-width: 120px;
  --fab-gap: 14px;
  --rail-reserve: calc(var(--fab-left) + var(--fab-width) + var(--fab-gap));
}

.action-rail{
  position: fixed;
  left: var(--fab-left);
  top: 80px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 2px;
  z-index: 900;
  overflow-y: auto;
  overflow-x: visible;
}

body.with-toolbar .action-rail{
  top: calc(80px + var(--app-toolbar-height, 0px));
}

/* ÂÖßÂÆπÂæÄÂè≥È®∞Âá∫Á©∫ÈñìÔºõtoolbar ÂæÄÂõûË£úÔºåÁ∂≠ÊåÅË¶ñË¶∫Â∞çÈΩä */
.erp-detail-container{ margin-left: var(--rail-reserve); }
#topToolbar{ margin-left: calc(-1 * var(--rail-reserve)) !important; }

/* ÊåâÈàïÁöÑÂÖ±ÂêåÂ§ñËßÄÔºà‰øùÊåÅÂú®Ê®£ÊùøÔºåËÆìÊâÄÊúâÈ†ÅÈù¢‰∏ÄËá¥Ôºâ */
.fab{
  position: relative;
  width: var(--fab-width);
  min-width: 0;
  padding: 6px 8px;
  font-size: .92rem;
  letter-spacing: 0;
  white-space: normal;
  word-break: break-word;
  background:#f8f9fb;
  color:#1f5fbf;
  font-weight:600;
  border-radius:10px;
  cursor:pointer;
  box-shadow:0 2px 8px rgba(20,40,80,.12);
  border:1px solid #cfd7e6;
}
.fab:hover{
  background:#e9f1ff;
  border-color:#9fbaf0;
}
.fab:focus-visible{
  outline:2px solid #9fbaf0;
  outline-offset:2px;
}
.fab-red{ background:#dc3545; color:#fff; }
.fab-blue{ background:#3583dc; color:#fff; }
.erp-detail-container{ margin-left: var(--rail-reserve); margin-right: 3vw; padding: 12px 0; }
#btnCalcAmount { border: 0 !important; outline: none !important; -webkit-tap-highlight-color: transparent; }
#btnCalcAmount:focus, #btnCalcAmount:focus-visible, #btnCalcAmount:active { outline: none !important; box-shadow: 0 6px 16px rgba(0,0,0,.2) !important; }
#btnCalcAmount::-moz-focus-inner { border: 0 !important; }
#topToolbar{ margin-left: calc(-1 * var(--rail-reserve)) !important; padding-left: 0 !important; justify-content: flex-start !important; }
#topToolbar > .ms-2, #topToolbar .btn-toolbar{ margin-left: 0 !important; }

/* ËÆìË°®Ê†ºÁî®Âõ∫ÂÆöÂ∏ÉÂ±ÄÔºåÊ¨ÑÂØ¨ÊâçÊúÉÁÖß px ÁîüÊïà + ÊãñÊõ≥ÊääÊâã */
.erp-table { table-layout: fixed; }
.erp-table th { position: relative; }
.erp-table th .col-resizer{ position: absolute; top: 0; right: 0; bottom: 0; width: 8px; cursor: col-resize; user-select: none; z-index: 2; }
.erp-table th .col-resizer::before { content: none !important; }
.erp-table th.resizing, .erp-table td.resizing, body.resizing { cursor: col-resize !important; }
</style>
.erp-header-form { margin-bottom: 0; }
