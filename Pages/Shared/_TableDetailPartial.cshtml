@model dynamic
@using PcbErpApi.Helpers
@using System.Text.Json
@{
    // å–®é ­æ¬„ä½
    var headerFields = Model.HeaderTableFields; // å¯è¦–æ¬„ä½
    var headerData = Model.HeaderData; // å–®é ­è³‡æ–™ (Dictionary<string, object> æˆ–ä½ çš„å–®é ­Model)
    // å–®èº«
    var fields = Model.TableFields;
    var items = Model.Items;
    var tableTitle = ViewData["TableTitle"] as string ?? "";
    var showRowNumber = ViewData["ShowRowNumber"] as bool? ?? true;
    var headerFieldsList = ((IEnumerable<TableFieldViewModel>)Model.HeaderTableFields).ToList();
    var addApiUrl = ViewData["AddApiUrl"]?.ToString() ?? "";
    var detailRouteTemplate = ViewData["SubRouteTemplate"]?.ToString() ?? "";
    var tableName = ViewData["DictTableName"]?.ToString() ?? "";
    var keyFieldName = ViewData["KeyFieldName"]?.ToString() ?? "PaperNum";
    var queryRedirectUrl = ViewData["QueryRedirectUrl"]?.ToString() ?? "";
    var DeleteApiUrl = ViewData["DeleteApiUrl"]?.ToString() ?? "";

    var groupedTabs = headerFieldsList
        .Where(f => (f.iShowWhere ?? 1) > 0) // âœ éæ¿¾æ‰ iShowWhere ç‚º 0 çš„æ¬„ä½
        .GroupBy(f => f.iShowWhere ?? 1)
        .OrderBy(g => g.Key)
        .ToDictionary(g => g.Key, g => g.ToList());

    var lookupMap = ViewData["LookupDisplayMap"] as Dictionary<string, Dictionary<string, string>>;

    var PaperNum = headerData.ContainsKey("PaperNum") ? headerData["PaperNum"]?.ToString() ?? "" : "";

    var headerLookupMap = ViewData["HeaderLookupMap"] as Dictionary<string, string>;
        
}

<div class="erp-detail-container">
    <div id="topToolbar" class="d-flex align-items-center mb-4" style="gap:12px;">
        <div class="btn-group" role="group" aria-label="row-nav" style="gap:6px;">
            <button type="button" class="btn btn-outline-primary" id="btnPrev">ä¸Šä¸€ç­†</button>
            <button type="button" class="btn btn-outline-primary" id="btnNext">ä¸‹ä¸€ç­†</button>
        </div>
        <button type="submit" class="btn toolbar-btn" form="orderHeaderForm">
            å„²å­˜
        </button>
        <div class="ms-2">
            @await Html.PartialAsync("_TableToolbar", new TableToolbarModel {
                SearchBtnId = "btnSubSearch",
                AddBtnId = "btnSubAddNew",
                DeleteBtnId = "btnSubBatchDelete",
                QueryFields = ViewData["QueryFields"] as List<QueryFieldViewModel>,
                ModalId = "searchModal",
                ReportSpName = ViewData["ReportSpName"]?.ToString() ?? ""   // ğŸ‘ˆ å¾å¤–å±¤å†å‚³é€²ä¾†
            })
        </div>
    </div>

    <div class="action-rail">
      <button id="btnCalcAmount" class="fab">é‡‘é¡è¨ˆç®—</button>
      <button id="btnClearDetails" class="fab fab-red">æ¸…é™¤å–®èº«</button>
      <button id="btnSearchDetails" class="fab">æœå°‹</button> <!-- ğŸ‘ˆ æ–°çš„ -->
      <!-- ä¹‹å¾Œå¯ä»¥å†åŠ åˆ¥çš„æŒ‰éˆ• -->
    </div>


        <!-- å–®é ­å¯ç·¨è¼¯è¡¨å–® -->
        <form id="orderHeaderForm" class="erp-header-form">
        <div class="row">
            <!-- âœ… Tabs åˆ‡æ›åˆ— -->
            <ul class="nav nav-tabs" id="headerTabs" role="tablist">
                @foreach (var tab in groupedTabs.Keys)
                {
                    <li class="nav-item" role="presentation">
                        <button class="nav-link @(tab == 1 ? "active" : "")"
                                id="tab-@tab-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#tab-@tab"
                                type="button" role="tab">
                            åˆ†é  @tab
                        </button>
                    </li>
                }
            </ul>

                <!-- âœ… Tabs å°æ‡‰å…§å®¹ -->
              <div class="tab-content" id="headerTabContent">
                    @foreach (var tab in groupedTabs)
                    {
                        <div class="tab-pane fade @(tab.Key == 1 ? "show active" : "")"
                            id="tab-@tab.Key" role="tabpanel">
                            <ul class="list-unstyled header-fields-tab"
                                data-tab-index="@tab.Key"
                                style="position: relative">
                               @foreach (var field in tab.Value)
                                {
                                    object rawValue = null;
                                    headerData?.TryGetValue(field.FieldName, out rawValue);
                                    string displayText = "";

                                    // 1. lookup å„ªå…ˆé¡¯ç¤º
                                    if (headerLookupMap != null && headerLookupMap.TryGetValue(field.FieldName, out var lookupVal))
                                    {
                                        displayText = lookupVal;
                                    }
                                    else if (rawValue != null)
                                    {
                                        //è¼¸å‡ºæ ¼å¼ç”¨Helperè½‰å‹
                                        displayText = FormatHelper.FormatValue(rawValue, field.DataType, field.FormatStr);

                                        // âœ… é€™è£¡è£œï¼šæ•¸å€¼å‹è‹¥ç‚ºç©ºï¼Œé¡¯ç¤º 0
                                        if (string.IsNullOrWhiteSpace(displayText) && field.DataType?.ToLower() == "number")
                                        {
                                            displayText = "0";
                                        }
                                    }

                                    var top = field.iFieldTop ?? 0;
                                    var left = field.iFieldLeft ?? 0;
                                    var width = field.iFieldWidth ?? 160;
                                    var height = field.iFieldHeight ?? 44;

                                    var liClass = "draggable-field inline"; // æ°¸é æ©«æ’


                                     // åˆ¤æ–·æœ‰ lookup table è¨­å®š
                                    if (!string.IsNullOrWhiteSpace(field.LookupTable) &&
                                        !string.IsNullOrWhiteSpace(field.LookupKeyField) &&
                                        !string.IsNullOrWhiteSpace(field.LookupResultField))
                                    {
                                        // ä¸‹æ‹‰é¸å–®å…ƒä»¶ï¼ˆç”¨ selectï¼‰
                                        <li class="@liClass"
                                            data-field="@field.FieldName"
                                            data-tab="@tab.Key"
                                            style="top:@(field.iFieldTop ?? 0)px; left:@(field.iFieldLeft ?? 0)px; width:@(field.iFieldWidth ?? 160)px; height:@(field.iFieldHeight ?? 44)px;">
                                            <label>@field.DisplayLabel</label>
                                            <select class="form-select lookup-dropdown"
                                                    name="@field.FieldName"
                                                    data-table="@field.LookupTable"
                                                    data-key="@field.LookupKeyField"
                                                    data-result="@field.LookupResultField.Replace(" ", "")"
                                                    data-selected="@rawValue"> 
                                                <option value="">--è«‹é¸æ“‡--</option>
                                            </select>
                                        </li>
                                    }
                                    else
                                    {
                                        <li class="@liClass"
                                            data-field="@field.FieldName"
                                            data-tab="@tab.Key"
                                            style="top:@(top)px; left:@(left)px; width:@(width)px; height:@(height)px;">
                                            <label>@field.DisplayLabel</label>
                                            <textarea class="form-control resizable-input"
                                                    name="@field.FieldName">@displayText</textarea>
                                        </li>
                                    }
                                }
                            </ul>
                        </div>
                    }
                </div>
        </div>
    </form>
    <!-- å–®èº«æ˜ç´° table -->
    <div class="erp-table-wrapper">
    <div class="d-flex justify-content-start mb-2">
        <button type="button" id="btnAddDetailRow" class="btn btn-outline-secondary btn-sm">
            ï¼‹
        </button>
        <button type="button" class="btn btn-outline-danger btn-sm" id="btnRowDelete" title="åˆªé™¤ç•¶å‰åˆ—">ï¼</button>
    </div>
        <table class="erp-table">
            <thead>
                <tr>
                    @foreach(var col in fields)
                    {
                        <th>@col.DisplayLabel</th>
                    }
                </tr>
            </thead>
            <tbody>
                    @if (items != null)
                    {
                        var index = 1;
                        foreach (var item in items)
                        {
                            // é€™å…©å€‹å–å€¼ä½ æœ¬ä¾†å°±æœ‰
                            var paperNum = item.GetType().GetProperty("PaperNum")?.GetValue(item, null)?.ToString();
                            var itemNo   = item.GetType().GetProperty("Item")?.GetValue(item, null)?.ToString();

                            <tr data-paper-num="@paperNum" data-item="@itemNo" data-state="unchanged">
                                @foreach(var col in fields)
                                {
                                    object v = "";
                                    if (item is IDictionary<string, object> dict)
                                        dict.TryGetValue(col.FieldName, out v);
                                    else if (item is System.Dynamic.ExpandoObject exp)
                                    {
                                        var expDict = (IDictionary<string, object>)exp;
                                        expDict.TryGetValue(col.FieldName, out v);
                                    }
                                    else
                                    {
                                        var prop = item.GetType().GetProperty(col.FieldName);
                                        v = prop != null ? prop.GetValue(item, null) : "";
                                    }

                                    var rowKey = $"{paperNum}_{itemNo}";
                                    string display = null;
            
                                    if (lookupMap != null && lookupMap.TryGetValue(rowKey, out var dict2))
                                    {
                                        dict2.TryGetValue(col.FieldName, out display);
                                    }
                                        
                                        // è¨ˆç®—é¡¯ç¤ºå€¼ï¼Œå…ˆçœ‹ lookupï¼Œå…¶æ¬¡èµ°æ ¼å¼åŒ–
                                        string cellValue;
                                        if (!string.IsNullOrEmpty(display))
                                        {
                                            cellValue = display;
                                        }
                                        else
                                        {
                                            cellValue = FormatHelper.FormatValue(v, col.DataType, col.FormatStr);
                                        }

                                        // é å…ˆç®—å¥½ nameï¼Œé¿å… Razor è§£æéŒ¯èª¤
                                        var inputName = $"Details[{index}].{col.FieldName}";

                                        <td>                                        
                                            <span class="cell-view">@cellValue</span>

                                            <input type="text"
                                                class="form-control form-control-sm cell-edit d-none w-100"
                                                name="@inputName"
                                                data-field="@col.FieldName"         
                                                data-init="@cellValue"             
                                                value="@cellValue" />
                                                
                                        </td>

                                }
                            </tr>
                            index++;
                        }
                    }
            </tbody>
        </table>
    </div>
</div>



<!-- SweetAlert2 foræç¤º -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="~/js/toolbarHandler.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />

<!-- å‘¼å«å…ƒä»¶ -->
@await Html.PartialAsync("_OrderDetailPicker",
  new DetailPickerConfig{
      ModalId = "detailPicker",
      PaperNum = PaperNum,
      FetchApi = "/api/OrderDetailSearch/fetch",
      InsertApi = "/api/OrderDetailSearch/insert",
      //Dicts = new Dictionary<string, LookupConfig>{
      //  ["PartNum"] = new LookupConfig{ Table="SPOdOCXOrderPOChice",         Key="PartNum",          Result="PartNum,MatName" },
      //  ["CustomerPartNum"] = new LookupConfig{ Table="CustomerMaterial", Key="CustomerPartNum", Result="CustomerPartNum,CustomerName" }
      //}
  })

<script>
// ============================
// 0) é é¢å¸¸æ•¸ï¼Razor æ³¨å…¥
// ============================
const PAGE = {
  paperNum: "@PaperNum",
  keyField: "PaperNum",
  headerTable: ("@(Model.HeaderTableName ?? "")".trim() || "").toLowerCase(), // e.g. spodordermain
  detailTable: "@(tableName ?? "")".trim(),                                   // e.g. SpodOrderSub
  queryRedirectUrl: "@(ViewData["QueryRedirectUrl"])",
  addApiUrl: "@addApiUrl",
  deleteApiUrl: "@DeleteApiUrl",
  detailRouteTemplate: "@detailRouteTemplate",
  headerFields: @Html.Raw(JsonSerializer.Serialize(headerFieldsList)),
  detailFields: @Html.Raw(JsonSerializer.Serialize(fields))
};

// è®“å…¶å®ƒå·¥å…·å¯ä»¥å–åˆ°ç›®å‰å–®è™Ÿ
window.selectedPaperNum = '@(Model.HeaderData["PaperNum"] ?? "")';

// ============================
// 1) Toolbar Handler å•Ÿå‹•
// ============================
// èª¿ç”¨ä½ åŸæœ¬çš„å…±ç”¨ ToolbarHandlerï¼ˆç”¨å–®è™Ÿç•¶ keyï¼‰
// è‡ªå‹•æ¨å°æœ¬é çš„è·¯å¾‘æ¨£æ¿ï¼š/SpodOrderSub/{0}
  // ç›®å‰å–®è™Ÿ
  const PAPER_NUM = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(PaperNum ?? ""));
  // å¾å¾Œç«¯å‚³é€²ä¾†çš„ã€Œè¿”å›ä¸»é é¢ã€åŸºåº•è·¯å¾‘ï¼Œä¾‹å¦‚ "/SpodOrderMain"
  const QUERY_REDIRECT_URL = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
    ViewData["QueryRedirectUrl"]?.ToString() ?? ""
  ));

  const PAGE_PAPER_NUM = ("@PaperNum" || "").trim();
  const KEY_FIELD = ("@(keyFieldName ?? "PaperNum")" || "PaperNum").trim();

  // 1) å¾ä¸»ç¨‹å¼å¸¶é€²ä¾†çš„ã€Œè¿”å›ä¸»é é¢ã€åŸºåº•è·¯å¾‘ï¼Œè£œä¸Š /{0}
  const backToMainTpl = (PAGE.queryRedirectUrl || '').trim()
    ? PAGE.queryRedirectUrl.replace(/\/$/, '') + '/{0}'
    : '';

  // 2) å¾ä¼ºæœå™¨å¸¶ä¾†çš„å­é æ¨£æ¿ï¼ˆä¸»é â†’å–®èº«ï¼‰ï¼ŒæŠŠ {PaperNum} æ­£è¦åŒ–æˆ {0}
  const subTpl = (PAGE.detailRouteTemplate || '')
    .replace(/\{PaperNum\}/gi, '{0}');

  // 3) åœ¨å–®èº«é å„ªå…ˆç”¨ backToMainTplï¼ˆåˆ‡å›ä¸»é ï¼‰ï¼Œå¦å‰‡å°±ç”¨ subTplï¼ˆä¸»é åˆ‡åˆ°å–®èº«ï¼‰
  const finalSwitchTpl = backToMainTpl || subTpl;

  // é˜²å‘†ï¼šlog ä¸€ä¸‹
  console.debug('[Switch template]', finalSwitchTpl);

  new ToolbarHandler({
    searchBtnId: "btnSubSearch",
    addBtnId: "btnSubAddNew",
    deleteBtnId: "btnSubBatchDelete",
    getSelectedId: () => (PAGE.paperNum || window.selectedPaperNum || ''), // ç¢ºä¿æœ‰å–®è™Ÿ
    modalId: "searchModal",
    formId: "searchForm",
    addApiUrl: PAGE.addApiUrl,
    deleteApiUrlFn: id => `/api/${PAGE.deleteApiUrl}/${id || PAGE.paperNum}`,
    detailRouteTemplate: finalSwitchTpl,   // â† é€™è£¡æ›æˆå‰›ç®—å¥½çš„æ¨£æ¿
    tableName: "@tableName",
    renderTable: null,
    renderPagination: null,
    renderOrderCount: null,
    restoreSearchForm: null,
    queryRedirectUrl: PAGE.queryRedirectUrl
  });

// æ‰‹å‹•æ¥ç®¡ã€Œåˆ‡æ›ã€æŒ‰éˆ•ï¼šå–®èº«é  â†’ ä¸»é 
(function hookToggleBackToMain() {
  // æ‰¾åˆ°åˆ‡æ›éˆ•ï¼ˆæŒ‰ idï¼›æ‰¾ä¸åˆ°å†ä»¥æ–‡å­—æ¯”å°ï¼‰
  const rawBtn = document.getElementById('btnToggle') ||
    Array.from(document.querySelectorAll('button, a'))
      .find(el => (el.textContent || '').trim() === 'åˆ‡æ›');
  if (!rawBtn) return;

  // ç”¨ clone ç½®æ›æ‰åŸå…ƒç´ ï¼Œæ¸…ç©ºåŸæœ¬æ‰€æœ‰äº‹ä»¶ç›£è½ï¼ˆåŒ…å« ToolbarHandler ç¶çš„ï¼‰
  const btn = rawBtn.cloneNode(true);
  rawBtn.replaceWith(btn);

  // æˆ‘å€‘è‡ªå·±çš„è™•ç†å™¨ï¼ˆç”¨æ•ç²éšæ®µ + åœæ­¢å†’æ³¡ï¼Œä¿éšªï¼‰
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();

    const base = (QUERY_REDIRECT_URL || '').trim().replace(/\/$/, ''); // ä¾‹å¦‚ /SpodOrderMain
    if (!base) {
      Swal.fire({ icon: 'error', title: 'æœªæä¾›è¿”å›ä¸»é è·¯å¾‘' });
      return;
    }

    const id = (PAGE_PAPER_NUM || window.selectedPaperNum || '').trim();
    const sep = base.includes('?') ? '&' : '?';
    const url = id ? `${base}${sep}${encodeURIComponent(KEY_FIELD)}=${encodeURIComponent(id)}` : base;

    location.href = url;
  }, { capture: true });
})();

// ============================
// 2) å…±ç”¨å°å·¥å…·ï¼ˆæ•¸å€¼è™•ç†ã€å­—ä¸²åŒ–ï¼‰
// ============================
function normalizeNumberFields(obj, fieldDefs) {
  (fieldDefs || []).forEach(f => {
    if ((f.DataType || '').toLowerCase() === 'number') {
      const k = f.FieldName;
      if (obj[k] != null) obj[k] = obj[k].toString().replace(/,/g, '');
    }
  });
}
function normalizeDetailsNumbers(detailRows, fieldDefs) {
  const numberFields = (fieldDefs || [])
    .filter(f => (f.DataType || '').toLowerCase() === 'number')
    .map(f => f.FieldName.toLowerCase());
  detailRows.forEach(r => {
    numberFields.forEach(fn => {
      Object.keys(r).forEach(k => {
        if (k.toLowerCase() === fn && r[k] != null) r[k] = r[k].toString().replace(/,/g, '');
      });
    });
  });
}
// ä¾æ¬„ä½å‹åˆ¥æŠŠ raw è½‰å­—ä¸²ï¼ˆé¿å… [object Object]ï¼‰
function toCellString(raw, colMeta) {
  if (raw == null) return '';
  if (typeof raw === 'object') return '';
  let s = String(raw);
  const dt = (colMeta?.DataType || '').toLowerCase();
  if (dt.includes('date')) {
    const d = new Date(s); if (!isNaN(d)) return d.toISOString().slice(0,10);
  }
  if (dt === 'number') return s.replace(/,/g, '');
  return s;
}

// ============================
// 3) æ˜ç´°åˆ— æ”¶é›† / æ–°å¢ / åˆªé™¤ / æ•´åˆ—é¸å–
// ============================

// 3-1 æ”¶é›†ç›®å‰è¡¨æ ¼æ‰€æœ‰ã€Œæœ‰è®Šå‹•ã€çš„æ˜ç´°åˆ—
function collectDetails() {
  const rows = document.querySelectorAll('.erp-table tbody tr');
  const details = [];
  rows.forEach(tr => {
    let changed = (tr.dataset.state === 'added' || tr.dataset.state === 'deleted'); // æ–°å¢/åˆªé™¤ä¸€å®šé€
    const row = {
      __state: tr.dataset.state || 'modified',
      PaperNum: tr.dataset.paperNum || PAGE.paperNum
    };
    tr.querySelectorAll('.cell-edit').forEach(inp => {
      const field = inp.dataset.field;
      if (!field) return;
      const val = (inp.value ?? '').toString();
      row[field] = val;
      if (!changed && (val !== (inp.dataset.init ?? ''))) changed = true;
    });
    if (row.Item == null && tr.dataset.item) row.Item = tr.dataset.item;
    if (changed) {
      if (row.__state === 'unchanged') row.__state = 'modified';
      details.push(row);
    }
  });
  return details;
}

// 3-2 æ–°å¢ä¸€åˆ—ï¼ˆå‘¼å«å¾Œç«¯æ’ DBï¼Œå†å›å¡«åˆ°å‰ç«¯ä¸¦ç«‹åˆ»å¯ç·¨è¼¯ï¼‰
async function onAddRowClick() {
  if (!PAGE.detailTable) {
    Swal.fire({icon:'error', title:'æ‰¾ä¸åˆ°æ˜ç´°è¡¨åï¼ˆDETAIL_TABLEï¼‰'}); 
    return;
  }
  try {
    const res = await fetch('/api/OrderHeaderApi/AddDetailRow', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ detailTable: PAGE.detailTable, paperNum: PAGE.paperNum })
    });
    const json = await res.json();
    if (!res.ok || !json?.ok) throw new Error(json?.error || 'æ–°å¢å¤±æ•—');
    appendDetailRowFromServer(json.row || {});
  } catch (err) {
    Swal.fire({icon:'error', title:'æ–°å¢æ˜ç´°å¤±æ•—', text: String(err.message || err)});
  }
}

// 3-3 å°‡å¾Œç«¯æ–°æ’å…¥çš„é‚£ç­† row è¿½åŠ åˆ°è¡¨æ ¼ï¼›ç‹€æ…‹æ¨™æˆ unchangedï¼ˆå› ç‚ºå·²åœ¨ DBï¼‰
function appendDetailRowFromServer(row) {
  const tbody = document.querySelector('.erp-table tbody');
  const tr = document.createElement('tr');
  tr.dataset.paperNum = row.PaperNum || PAGE.paperNum;
  tr.dataset.item = row.Item;
  tr.dataset.state = 'unchanged';

  let tdsHtml = '';
  (PAGE.detailFields || []).forEach((col) => {
    const v = toCellString(row[col.FieldName], col);
    const inputName = `Details[${tbody.rows.length + 1}].${col.FieldName}`;
    tdsHtml += `
      <td>
        <span class="cell-view">${v}</span>
        <input type="text"
          class="form-control form-control-sm cell-edit d-none w-100"
          name="${inputName}"
          data-field="${col.FieldName}"
          data-init="${v}"
          value="${v}">
      </td>`;
  });
  tr.innerHTML = tdsHtml;
  tbody.appendChild(tr);

  // é€™åˆ—ç«‹åˆ»å¯ç·¨è¼¯ï¼‹é«˜äº®
  makeRowEditable(tr);
  selectRow(tr);

  // è¼¸å…¥ â‡’ æ¨™è¨˜ modifiedï¼ˆé™¤éæ˜¯æ–°å¢ï¼‰
  tr.querySelectorAll('.cell-edit').forEach(inp => {
    inp.addEventListener('input', () => {
      if (tr.dataset.state !== 'added') tr.dataset.state = 'modified';
    });
  });
}

// 3-4 åˆªé™¤ç›®å‰é¸å–åˆ—ï¼ˆæ–°åˆ—ï¼šå‰ç«¯ç§»é™¤ï¼›èˆŠåˆ—ï¼šå‘¼å«å¾Œç«¯åˆªé™¤ï¼‰
async function onDeleteRowClick() {
  const tr = document.querySelector('.erp-table tbody tr.row-selected');
  if (!tr) { Swal.fire({icon:'info', title:'è«‹å…ˆé»é¸è¦åˆªé™¤çš„æ˜ç´°åˆ—'}); return; }

  const pn = tr.dataset.paperNum || PAGE.paperNum;
  const item = tr.dataset.item || '';
  if (!pn || !item) {
    Swal.fire({icon:'error', title:'ç„¡æ³•åˆ¤æ–·å–®è™Ÿæˆ–é …æ¬¡'}); return;
  }

  const { isConfirmed } = await Swal.fire({
    icon: 'question', title: 'åˆªé™¤é€™ä¸€ç­†æ˜ç´°ï¼Ÿ', showCancelButton: true, confirmButtonText: 'åˆªé™¤', cancelButtonText: 'å–æ¶ˆ'
  });
  if (!isConfirmed) return;

  if (tr.dataset.state === 'added') { // æœªå…¥åº«
    const next = tr.nextElementSibling || tr.previousElementSibling;
    tr.remove(); if (next) selectRow(next);
    return;
  }

  try {
    const url = `/api/OrderHeaderApi/DeleteRow`
      + `?table=${encodeURIComponent(PAGE.detailTable)}`
      + `&paperNum=${encodeURIComponent(pn)}`
      + `&item=${encodeURIComponent(item)}`;
    const res = await fetch(url, { method: 'DELETE' });
    if (!res.ok) throw new Error(await res.text());

    const next = tr.nextElementSibling || tr.previousElementSibling;
    tr.remove(); if (next) selectRow(next);
    Swal.fire({icon:'success', title:'åˆªé™¤å®Œæˆ', timer:900, showConfirmButton:false});
  } catch (err) {
    Swal.fire({icon:'error', title:'åˆªé™¤å¤±æ•—', text: String(err)});
  }
}

// 3-5 æ•´åˆ—é¸å–ï¼†è®“è©²åˆ—å¯ç·¨è¼¯
const tbodyEl = document.querySelector('.erp-table tbody');
function selectRow(tr) {
  if (!tr) return;
  document.querySelectorAll('.erp-table tbody tr.row-selected')
    .forEach(r => r.classList.remove('row-selected'));
  tr.classList.add('row-selected');
}
function makeRowEditable(tr) {
  tr.querySelectorAll('.cell-view').forEach(el => el.classList.add('d-none'));
  tr.querySelectorAll('.cell-edit').forEach(el => el.classList.remove('d-none'));
  const first = tr.querySelector('.cell-edit[data-field="PartNum"]') || tr.querySelector('.cell-edit');
  first?.focus(); first?.select?.();
}
tbodyEl.addEventListener('click',  e => { const tr = e.target.closest('tr'); if (tr) selectRow(tr); });
tbodyEl.addEventListener('focusin', e => { const tr = e.target.closest('tr'); if (tr) selectRow(tr); });
document.getElementById('btnAddDetailRow')?.addEventListener('click', onAddRowClick);
document.getElementById('btnSubAddNew')?.addEventListener('click', (e)=>{ e.preventDefault(); onAddRowClick(); });
document.getElementById('btnRowDelete')?.addEventListener('click', onDeleteRowClick);

// ============================
// 4) å„²å­˜å–®é ­ï¼‹å–®èº«ï¼ˆçµ„ payload â†’ å‘¼å« APIï¼‰
// ============================
document.getElementById('orderHeaderForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const header = Object.fromEntries(new FormData(this));
  normalizeNumberFields(header, PAGE.headerFields);

  const details = collectDetails();
  normalizeDetailsNumbers(details, PAGE.detailFields);

  const payload = {
    ...header,
    Details: details,
    __headerTable: PAGE.headerTable,
    __detailTable: PAGE.detailTable || undefined
  };

  try {
    const resp = await fetch('/api/OrderHeaderApi/SaveOrderHeader', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
    });
    if (resp.ok) {
      const result = await resp.json();
      if (result.updated) {
        await Swal.fire({ icon: 'success', title: 'å„²å­˜æˆåŠŸï¼', timer: 1000, showConfirmButton: false });
        localStorage.setItem("afterSave", "1"); location.reload();
      } else {
        Swal.fire({ icon: 'info', title: 'æ²’æœ‰è³‡æ–™ç•°å‹•' });
      }
    } else {
      let msg = 'å„²å­˜å¤±æ•—'; try { const txt = await resp.text(); msg = txt || msg; } catch {}
      Swal.fire({ icon: 'error', title: msg });
    }
  } catch (err) {
    Swal.fire({ icon: 'error', title: 'ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤' });
  }
});

// ============================
// 5) æª¢è¦–/ç·¨è¼¯æ¨¡å¼åˆ‡æ›ï¼ˆè‹¥é é¢æœ‰è©²æŒ‰éˆ•ï¼‰
// ============================
const editBtn = document.getElementById('btnViewEditToggle');
if (editBtn) {
  let isEdit = false;
  const getHeaderValueByLabel = (labelText) => {
    const $li = $('.draggable-field').filter(function () {
      return $(this).children('label').first().text().trim() === labelText;
    }).first();
    if (!$li.length) return null;
    const $ctrl = $li.find('select, input, textarea').first();
    if (!$ctrl.length) return null;
    if ($ctrl.is('select')) return $ctrl.find('option:selected').text().trim();
    return ($ctrl.val() || '').toString().trim();
  };

  editBtn.addEventListener('click', function () {
    const status = getHeaderValueByLabel('å–®æ“šç‹€æ…‹') || '';
    if (window.BLOCK_STATUSES && window.BLOCK_STATUSES.includes(status)) {
      Swal.fire({ icon: 'warning', title: 'ç„¡æ³•ä¿®æ”¹', text: `æ­¤å–®æ“šç‹€æ…‹ç‚ºã€Œ${status}ã€ï¼Œä¸å¯é€²è¡Œä¿®æ”¹ã€‚`}); return;
    }
    isEdit = !isEdit; editBtn.textContent = isEdit ? 'ä¿ç•™' : 'ä¿®æ”¹';
    document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
      .forEach(el => el.disabled = !isEdit);
    document.querySelectorAll('.erp-table .cell-view').forEach(el => el.classList.toggle('d-none', isEdit));
    document.querySelectorAll('.erp-table .cell-edit').forEach(el => el.classList.toggle('d-none', !isEdit));
    document.querySelectorAll('.erp-table .cell-edit').forEach(inp => {
      inp.addEventListener('input', () => {
        const tr = inp.closest('tr'); if (tr && tr.dataset.state !== 'added') tr.dataset.state = 'modified';
      });
    });
  });

  // é é¢åˆ·æ–°å¾Œè‡ªå‹•å›åˆ°ç·¨è¼¯ç‹€æ…‹ï¼ˆè‹¥å‰›å‰›å­˜æª”æˆåŠŸï¼‰
  window.addEventListener('load', () => {
    document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
      .forEach(el => el.disabled = true);
    if (localStorage.getItem("afterSave") === "1") {
      localStorage.removeItem("afterSave");
      document.getElementById("btnViewEditToggle")?.click();
    }
  });
}

// ============================
// 6) Header ç‰ˆé¢æ‹–æ‹‰å„²å­˜ / Lookup ä¸‹æ‹‰åˆå§‹åŒ–ï¼ˆjQueryï¼‰
// ============================
$(function () {
  let debounceTimer;
  const debounceSave = () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(saveLayoutChanges, 400); };

  function saveLayoutChanges() {
    const layout = [];
    const hiddenTabs = $(".tab-pane").not(".show");
    hiddenTabs.addClass("temporary-show").addClass("show").css("display", "block");
    $(".draggable-field").each(function () {
      const $li = $(this);
      layout.push({
        fieldName: $li.data("field"),
        top: Math.round($li.position().top),
        left: Math.round($li.position().left),
        width: Math.round($li.outerWidth()),
        height: Math.round($li.outerHeight()),
        ishowWhere: parseInt($li.attr("data-tab")) || 1
      });
    });
    hiddenTabs.removeClass("show").removeClass("temporary-show").css("display", "");
    if (!layout.length) return;

    fetch("/api/TableFieldLayout/SaveHeaderLayout", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tableName: "@Model.HeaderTableName".toLowerCase(), layoutUpdates: layout })
    }).catch(()=>{});
  }

  // draggable + resizable
  $(".draggable-field").each(function () {
    const $li = $(this);
    $li.draggable({
      handle: "label",
      helper: function () {
        return $("<div>").text($(this).find("label").text()).css({
          width: "80px", height: $li.outerHeight() + "px",
          background: "#eef", border: "1px dashed #999", padding: "4px", "font-size": "0.9em"
        });
      },
      appendTo: "body", zIndex: 10000,
      start: function () { $(this).hide(); },
      stop:  function () { $(this).show(); }
    });
    $li.resizable({ handles: "se", minWidth: 50, minHeight: 30, stop: debounceSave });
  });

  // droppable å€åŸŸï¼ˆè·¨åˆ†é æ‹–æ›³ï¼‰
  $(".header-fields-tab").droppable({
    accept: ".draggable-field", tolerance: "pointer",
    over: function () { $(this).addClass("drop-hover"); },
    out:  function () { $(this).removeClass("drop-hover"); },
    drop: function (event, ui) {
      $(this).removeClass("drop-hover");
      const $zone = $(this);
      const $item = $(ui.draggable);
      const newTabIndex = parseInt($zone.data("tab-index")) || 1;
      $item.appendTo($zone).attr("data-tab", newTabIndex).css({
        top: ui.offset.top - $zone.offset().top,
        left: ui.offset.left - $zone.offset().left,
        position: "absolute"
      });
      debounceSave();
    }
  });

  // æ‹–éåˆ†é æ¨™ç±¤è‡ªå‹•åˆ‡æ›
  let dragTabSwitchTimer = null;
  $("#headerTabs button").droppable({
    accept: ".draggable-field",
    over: function () { const $tabBtn = $(this); dragTabSwitchTimer = setTimeout(() => { $tabBtn.trigger("click"); }, 600); },
    out:  function () { clearTimeout(dragTabSwitchTimer); }
  });

  // Lookup ä¸‹æ‹‰è¼‰å…¥
  $('.lookup-dropdown').each(function() {
    const $select = $(this);
    const table = $select.data('table'), key = $select.data('key'),
          result = $select.data('result'), selected = $select.data('selected');
    $.getJSON(`/api/TableFieldLayout/LookupData?table=${table}&key=${key}&result=${result}`, function(data) {
      $select.empty().append('<option value="">--è«‹é¸æ“‡--</option>');
      (data || []).forEach(row => {
        const val = row.key;
        const label = Object.keys(row).filter(p => p.startsWith('result')).map(p => row[p]).join(' - ');
        const $opt = $('<option>').val(val).text(label);
        if (val == selected) $opt.attr('selected', true);
        $select.append($opt);
      });
      $select.next('.lookup-label').text($select.find('option:selected').text());
    });
    $select.on('change', function() {
      $(this).next('.lookup-label').text($(this).find('option:selected').text());
    });
  });

  // Tab é«˜åº¦ä¸€æ¬¡æ€§èª¿æ•´ï¼ˆä»¥ä¾¿å®¹å™¨èƒ½åŒ…ä½æ¬„ä½ï¼‰
  function setInitialTabHeights(offsetPx = 10) {
    const hiddenTabs = $(".tab-pane").not(".show");
    hiddenTabs.addClass("tmp-show").addClass("show").css("display", "block");
    $(".header-fields-tab").each(function () {
      let maxBottom = 0;
      $(this).children(".draggable-field").each(function () {
        const $el = $(this);
        maxBottom = Math.max(maxBottom, $el.position().top + $el.outerHeight());
      });
      $(this).height(Math.max(0, Math.ceil(maxBottom + offsetPx)));
    });
    hiddenTabs.removeClass("show tmp-show").css("display", "");
  }
  requestAnimationFrame(() => setInitialTabHeights(10));
});

// ============================
// 7) ä¸Šä¸€ç­† / ä¸‹ä¸€ç­†ï¼ˆä¾åˆ—è¡¨æŸ¥è©¢çµæœï¼‰
// ============================
const NAV_BTN_PREV = document.getElementById('btnPrev');
const NAV_BTN_NEXT = document.getElementById('btnNext');
let navIds = [], navIndex = -1;

function loadLastFilters() {
  try { const s = localStorage.getItem("orderListQueryFilters"); return s ? JSON.parse(s) : []; }
  catch { return []; }
}
function getDetailBasePath() { return location.pathname.replace(/\/[^\/]+$/, "/"); }
function gotoPaper(pn) { if (!pn) return; localStorage.setItem("lastViewedPaperNum", pn); location.href = getDetailBasePath() + pn; }
function updateNavButtons() {
  const hasPrev = navIndex > 0;
  const hasNext = navIndex >= 0 && navIndex < navIds.length - 1;
  NAV_BTN_PREV.disabled = !hasPrev;
  NAV_BTN_NEXT.disabled = !hasNext;
  NAV_BTN_PREV.onclick = () => hasPrev && gotoPaper(navIds[navIndex - 1]);
  NAV_BTN_NEXT.onclick = () => hasNext && gotoPaper(navIds[navIndex + 1]);
}
async function fetchIdListByApi(filters) {
  const res = await fetch('/api/PagedQuery/IdList', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ table: PAGE.headerTable, keyField: PAGE.keyField, filters: filters || [] })
  });
  const json = await res.json();
  return Array.isArray(json.ids) ? json.ids : [];
}
async function fetchIdListByPagedQuery(filters) {
  const fs = [...(filters || []), {Field:"page",Op:"",Value:"1"}, {Field:"pageSize",Op:"",Value:"999999"}];
  const res = await fetch('/api/PagedQuery/PagedQuery', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ table: PAGE.headerTable, filters: fs })
  });
  const json = await res.json();
  const rows = Array.isArray(json.data) ? json.data : [];
  return rows.map(r => r[PAGE.keyField]).filter(Boolean);
}
async function initRowNavigation() {
  try {
    const filters = loadLastFilters();
    try { navIds = await fetchIdListByApi(filters); }
    catch { navIds = await fetchIdListByPagedQuery(filters); }
    navIndex = navIds.indexOf(PAGE.paperNum);
    updateNavButtons();
  } catch {
    NAV_BTN_PREV.disabled = true; NAV_BTN_NEXT.disabled = true;
  }
}
initRowNavigation();

// ============================
// 8) å…¶ä»–ï¼šæŠŠæœ€å¾Œæª¢è¦–çš„å–®è™Ÿå­˜åœ¨ localStorage
// ============================
localStorage.setItem("lastViewedPaperNum", window.selectedPaperNum);

// ä¾ header æ¬„ä½ã€Œæ¨™ç±¤æ–‡å­—ã€æŠ“é¡¯ç¤ºå€¼ï¼ˆselect å–æ–‡å­—ï¼Œå…¶å®ƒå– valueï¼‰
function getHeaderValueByLabel(labelText) {
  const li = Array.from(document.querySelectorAll('.draggable-field'))
    .find(el => (el.querySelector('label')?.textContent || '').trim() === labelText);
  if (!li) return '';
  const ctrl = li.querySelector('select, input, textarea');
  if (!ctrl) return '';
  if (ctrl.tagName.toLowerCase() === 'select') {
    const opt = ctrl.options[ctrl.selectedIndex];
    return (opt?.text || opt?.value || '').trim();
  }
  return (ctrl.value || '').trim();
}

// ============================
// 9) å…¶ä»–ï¼šé‡‘é¡è¨ˆç®—æŒ‰éˆ•ï¼ˆè‹¥é é¢æœ‰
document.getElementById('btnCalcAmount')?.addEventListener('click', async () => {
  const paper = (PAGE.paperNum || window.selectedPaperNum || '').trim();
  if (!paper) return Swal.fire({icon:'info', title:'æ²’æœ‰å–®è™Ÿ'});

  try {
    const resp = await fetch('/api/StoredProc/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        Key: 'CalcOrderAmount',      // å°æ‡‰ _registry çš„ key
        Args: { PaperNum: paper }    // å¿…å¡«åƒæ•¸
      })
    });

    const raw = await resp.text();
    let data;
    try { data = JSON.parse(raw); } catch { data = { ok:false, error: raw }; }

    if (resp.ok && data.ok) {
      Swal.fire({icon:'success', title:'è¨ˆç®—å®Œæˆ', timer:900, showConfirmButton:false});
      location.reload();
    } else {
      Swal.fire({icon:'error', title:'å‘¼å«å¤±æ•—', text: data.error || `HTTP ${resp.status}`});
    }
  } catch (e) {
    Swal.fire({icon:'error', title:'ç¶²è·¯éŒ¯èª¤', text: String(e)});
  }
});

document.getElementById('btnClearDetails')?.addEventListener('click', async () => {
  const paper = (PAGE.paperNum || window.selectedPaperNum || '').trim();
  const paperId = (PAGE.detailTable || '').trim().replace(/^dbo\./i, '');
  if (!paper)  return Swal.fire({icon:'info',  title:'æ²’æœ‰å–®è™Ÿ'});
  if (!paperId) return Swal.fire({icon:'info',  title:'ç¼ºå°‘å–®èº«è¡¨åï¼ˆPaperIdï¼‰'});

  // â‘  ç‹€æ…‹é™åˆ¶
  const status = getHeaderValueByLabel('å–®æ“šç‹€æ…‹') || '';
  const ALLOW  = ['ä½œæ¥­ä¸­', 'å¯©æ ¸ä¸­'];
  const BLOCK  = ['å·²ç¢ºèª', 'å·²çµæ¡ˆ', 'ä½œå»¢ä¸­'];

  if (BLOCK.includes(status) || !ALLOW.includes(status)) {
    return Swal.fire({
      icon: 'warning',
      title: 'æ­¤ç‹€æ…‹ä¸å¯æ¸…é™¤',
      html: `å–®æ“šç‹€æ…‹ï¼š<b>${status || 'ï¼ˆç©ºï¼‰'}</b>`
    });
  }

  // â‘¡ äºŒæ¬¡ç¢ºèª
  const { isConfirmed } = await Swal.fire({
    icon: 'warning',
    title: 'ç¢ºå®šè¦æ¸…é™¤é€™å¼µå–®çš„æ‰€æœ‰å–®èº«å—ï¼Ÿ',
    html: `å–®è™Ÿï¼š<b>${paper}</b><br>è¡¨ï¼š<code>${paperId}</code><br>ç‹€æ…‹ï¼š<b>${status}</b>`,
    showCancelButton: true, confirmButtonText: 'æ¸…é™¤', cancelButtonText: 'å–æ¶ˆ'
  });
  if (!isConfirmed) return;

  // â‘¢ å‘¼å« SP
  try {
    const resp = await fetch('/api/StoredProc/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        Key: 'ClearOrderDetails',
        Args: { PaperNum: paper, PaperId: paperId, Item: 0 }
      })
    });

    const raw = await resp.text();
    let data; try { data = JSON.parse(raw); } catch { data = { ok:false, error: raw }; }

    if (resp.ok && data.ok) {
      const msg = (data.rows != null) ? `å·²æ¸…é™¤ ${data.rows} ç­†` : 'æ¸…é™¤å®Œæˆ';
      await Swal.fire({icon:'success', title: msg, timer:900, showConfirmButton:false});
      location.reload();
    } else {
      Swal.fire({icon:'error', title:'æ¸…é™¤å¤±æ•—', text: data.error || `HTTP ${resp.status}`});
    }
  } catch (e) {
    Swal.fire({icon:'error', title:'ç¶²è·¯éŒ¯èª¤', text: String(e)});
  }
});

  // ç¶å®šå¤–é çš„ã€Œæœå°‹ã€æŒ‰éˆ•
  document.getElementById('btnSearchDetails')?.addEventListener('click', ()=>{
    const paper = (window.selectedPaperNum || '').trim();
    window.OrderDetailPicker_detailPicker.open({ paperNum: paper });
  });

  // å¯é¸ï¼šæ””æˆªå…ƒä»¶çš„ç¢ºå®šäº‹ä»¶
  $('#detailPicker').on('odp:confirmed', function(e, res){
    // ä¾‹å¦‚ï¼šä½ ä¸æƒ³ reloadï¼Œå¯åœ¨é€™è£¡è‡ªå·±è™•ç†
    // console.log('confirmed:', res);
  });
</script>

<style>
/* =========================================
   A) å…¨å±€/ç‰ˆé¢
   ========================================= */
body { background: #f7f9fb !important; }
.erp-detail-container { min-height: 100vh; padding: 32px 0; margin-left: 3vw; margin-right: 3vw; }

/* =========================================
   B) Header è¡¨å–® & Tabs
   ========================================= */
.erp-header-form,
.erp-header-form select,
.erp-header-form textarea,
.erp-header-form input { font-size: 0.95em; }

.erp-header-form select.form-select{
  font-size: 1em !important; height: 32px !important; min-height: 32px !important; line-height: 1.15 !important;
  padding: 2px 30px 2px 6px !important; appearance: none; -webkit-appearance: none; -moz-appearance: none;
  background-image: url('data:image/svg+xml;utf8,<svg width="11" height="11" fill="gray" xmlns="http://www.w3.org/2000/svg"><path d="M2 4.5l3.5 3.5L9 4.5" stroke="gray" stroke-width="2" fill="none" stroke-linecap="round"/></svg>');
  background-repeat: no-repeat; background-position: right 10px center; background-size: 14px 14px; box-shadow: none !important; border-radius: 5px !important;
}
.header-fields-tab{
  position: relative; min-height: 120px; padding-bottom: 8px;
  background: #eef2f9 !important; box-shadow: 0 2px 6px rgba(0,0,0,0.04);
}
.drop-hover{ background-color:#cce5ff !important; border-radius:4px; }

.erp-header-form .nav-tabs .nav-link{ border-radius:8px 8px 0 0 !important; padding:7px 18px; font-size:1.05em; font-weight:500; color:#235eb8; }
.erp-header-form .nav-tabs .nav-link.active{
  background:#fff; color:#124d8b; border-color:#bdd2f7 #bdd2f7 #fff #bdd2f7 !important; box-shadow:0 2px 6px 0 #e4ecf7; font-weight:bold;
}

/* draggable æ¬„ä½ï¼ˆæ©«æ’ label + æ§ä»¶ï¼‰ */
.draggable-field{ position:absolute; display:flex; flex-direction:column; box-sizing:border-box; overflow:hidden; background:transparent; }
.draggable-field.inline{ display:flex; flex-direction:row; align-items: center; gap:4px; flex:0 0 auto; min-width:100px; max-width:100%; }
.draggable-field label{ cursor:move; font-size:0.85em; margin:0 6px 0 0; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
.draggable-field.inline .field-control{ flex:1 1 auto; height:100%; display:flex; }
.draggable-field.inline textarea,
.draggable-field.inline input,
.draggable-field.inline .form-select{
  flex:1 1 auto; width:100%; height:100%; min-height:32px; line-height:1.2; resize:none; padding:4px 6px; font-size:0.95em;
}
.draggable-field.inline label{
  white-space: nowrap !important;     /* å–®åˆ—é¡¯ç¤º */
  overflow: visible !important;       /* ä¸è£åˆ‡ */
  text-overflow: clip !important;     /* ä¸é¡¯ç¤º â€¦ */
  max-width: none !important;         /* è®“æ¨™ç±¤å¯æ’é–‹ï¼ˆå¿…è¦æ™‚æ‰‹å‹•èª¿å¯¬ liï¼‰ */
}

/* =========================================
   C) æ˜ç´°è¡¨æ ¼ï¼ˆè¦–è¦º & ç·¨è¼¯ï¼‰
   ========================================= */
.erp-table-wrapper{
  background:#fff; box-shadow:0 4px 18px 0 #c3d4e6; max-width:1400px; overflow-x:auto;
  padding:8px !important; border-radius:0 0 13px 13px; border:1px solid #d6dbe5;
}
.erp-table{ width:100%; border-collapse:separate; border-spacing:0; font-size:1.06em; background:#fff; }
.erp-table thead tr{ background:#e7ecf3; }
.erp-table th, .erp-table td{
  background:#f1f5fb; padding:7px 12px; border-bottom:1px solid #c5d1e4; white-space:nowrap; text-align:center;
  font-weight:500; border-right:1px solid #dde4ed; height:34px;
}
.erp-table th:last-child, .erp-table td:last-child{ border-right:none; }
.erp-table th{ color:#124d8b; font-weight:700; font-size:1.05em; letter-spacing:1px; background:#e7ecf3; }
.erp-table tbody tr:nth-child(even){ background:#f6f9fd; }
.erp-table tbody tr:hover{ background:#eef7ff; }

/* é¡¯ç¤º/ç·¨è¼¯é›™å±¤ï¼šspan é¡¯ç¤ºã€input ç·¨è¼¯ï¼ˆåˆ‡æ› displayï¼‰ */
.erp-table td{ position:relative; padding:0; }
.erp-table td .cell-view{ display:inline-block; width:100%; text-align:inherit; }
.erp-table td .cell-edit{
  width:100% !important; height:100% !important; box-sizing:border-box; margin:0; border:none; border-radius:0;
  background:#fff !important; font-size:inherit !important; font-weight:inherit !important; font-family:inherit !important;
  line-height:inherit !important; text-align:inherit !important; padding:0 4px;
}

/* æ•´åˆ—é¸å–é«˜äº®ï¼†å·¦å´è—æ¢ */
.erp-table tbody tr.row-selected > td{ background:#fff8c6 !important; }
.erp-table tbody tr.row-selected > td:first-child{ position:relative; }
.erp-table tbody tr.row-selected > td:first-child::after{
  content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background:#0d6efd; border-radius:2px;
}
/* ç§»é™¤é è¨­ focus è—æ¡†ï¼ˆé¿å…åªçœ‹åˆ°æŸä¸€æ ¼æœ‰å¤–æ¡†ï¼‰ */
.erp-table td:focus, .erp-table td *:focus{ outline:none !important; box-shadow:none !important; }

/* =========================================
   D) å…¶å®ƒè‰²å½©å¼·èª¿ï¼ˆè‹¥æœ‰éœ€è¦ï¼‰
   ========================================= */
.highlight-red { color:#e53b2d; font-weight:700; }
.highlight-blue{ color:#2564b3; font-weight:700; }

/* =========================================
   E) å·¦å´æµ®å‹•æŒ‰éˆ•ç¾¤
   ========================================= */
/* æŠŠå·¦å´è¡Œå‹•è»Œé“ï¼ˆæµ®å‹•éˆ•ï¼‰é ç•™å¯¬åº¦æŠ½æˆè®Šæ•¸ */
:root{
  --fab-left: 12px;      /* æµ®å‹•éˆ•è·é›¢è¦–çª—å·¦å´ */
  --fab-width: 100px;    /* æµ®å‹•éˆ•å¯¦éš›å¯¬åº¦ï¼ˆå«å…§è·ï¼Œå¯å¾®èª¿ï¼‰ */
  --fab-gap: 20px;       /* æµ®å‹•éˆ•å³å´ç·©è¡ */
  --rail-reserve: calc(var(--fab-left) + var(--fab-width) + var(--fab-gap));
}

/* è®“æ•´å€‹æŒ‰éˆ•æ¬„å›ºå®šåœ¨å·¦å´ï¼›æ¯é¡†æŒ‰éˆ•åœ¨æ¬„ä½å…§å‚ç›´æ’åˆ— */
.action-rail{
  position: fixed;
  left: var(--fab-left);
  top: 80px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 900;
}


/* æµ®å‹•æŒ‰éˆ• */
.fab{
  position: relative; /* ä¸å†ç”¨ fixedï¼Œè®“å®ƒè·Ÿè‘— action-rail æ’åˆ— */
  min-width: var(--fab-width);
  padding: 8px 12px;
  background:#ffc107; color:#090101; font-weight:700;
  border-radius:10px; cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.2);
  border: 0;
}
.fab:hover{ filter:brightness(0.95); }

/* ç´…è‰²é¢¨æ ¼ï¼šæ¸…é™¤å–®èº« */
.fab-red{
  background:#dc3545; color:#fff;
}

/* å…§å®¹å®¹å™¨å·¦é‚Šé ç•™çš„å®‰å…¨é‚Šç•Œï¼ˆï¼ æŒ‰éˆ•ä½ç½® + æŒ‰éˆ•å¯¬ + ç·©è¡è·é›¢ï¼‰ */
/* ä»ä¿ç•™å…§å®¹æ•´é«”çš„å·¦å´é ç•™ç©ºé–“ï¼ˆé¿å…è¢«æµ®å‹•éˆ•æ“‹ä½ï¼‰ */
.erp-detail-container{
  margin-left: var(--rail-reserve);
  margin-right: 3vw;
  padding: 32px 0;
}
/* ç§»é™¤ã€Œé‡‘é¡è¨ˆç®—ã€æŒ‰éˆ•çš„é»‘è‰²å¤–æ¡†/outline */
#btnCalcAmount {
  border: 0 !important;
  outline: none !important;
  -webkit-tap-highlight-color: transparent; /* ç§»é™¤è¡Œå‹•è£ç½®é»æ“Šé«˜äº® */
}

/* é‡å°èšç„¦/æŒ‰ä¸‹ç‹€æ…‹å†ä¿éšªä¸€æ¬¡ */
#btnCalcAmount:focus,
#btnCalcAmount:focus-visible,
#btnCalcAmount:active {
  outline: none !important;
  box-shadow: 0 6px 16px rgba(0,0,0,.2) !important; /* ä¿ç•™é™°å½±ï¼Œä¸è¦é»‘æ¡† */
}

/* è‹¥ä½ æŠŠå®ƒæ”¹æˆ <button>ï¼ŒFirefox æœƒå¤šä¸€å±¤å…§æ¡†ï¼Œé †ä¾¿å»æ‰ */
#btnCalcAmount::-moz-focus-inner {
  border: 0 !important;
}

/* åªæœ‰æœ€ä¸Šé¢å·¥å…·åˆ—è¦ã€Œåƒå›å»ã€é‚£æ®µé ç•™å¯¬ï¼Œå¾€å·¦ç§»å›å» */
#topToolbar{
  margin-left: calc(-1 * var(--rail-reserve)) !important;
  padding-left: 0 !important;
  justify-content: flex-start !important;
}

/* è‹¥æŸäº›æ¡†æ¶æ¨£å¼é‚„åŠ äº†å·¦é‚Šè·ï¼Œå†ä¿éšªæ¸…æ‰ */
#topToolbar > .ms-2,
#topToolbar .btn-toolbar{
  margin-left: 0 !important;
}



</style>

