@model dynamic
@using PcbErpApi.Helpers
@using System.Text.Json
@using System.Collections.Generic
@using System.Linq
@{
    // å–®é ­æ¬„ä½
    var headerFields = Model.HeaderTableFields; // å¯è¦–æ¬„ä½
    var headerData = Model.HeaderData; // å–®é ­è³‡æ–™ (Dictionary<string, object> æˆ–ä½ çš„å–®é ­Model)
    // å–®èº«
    var fields = Model.TableFields;
    var items = Model.Items;
    var tableTitle = ViewData["TableTitle"] as string ?? "";
    var showRowNumber = ViewData["ShowRowNumber"] as bool? ?? true;
    var headerFieldsList = ((IEnumerable<TableFieldViewModel>)Model.HeaderTableFields).ToList();
    var headerTabBaseLabel = ViewData["HeaderTableDisplayLabel"]?.ToString() ?? "åˆ†é ";
    var addApiUrl = ViewData["AddApiUrl"]?.ToString() ?? "";
    var detailRouteTemplate = ViewData["SubRouteTemplate"]?.ToString() ?? "";
    var tableName = ViewData["DictTableName"]?.ToString() ?? "";
    var keyFieldName = ViewData["KeyFieldName"]?.ToString() ?? "PaperNum";
    var queryRedirectUrl = ViewData["QueryRedirectUrl"]?.ToString() ?? "";
    var DeleteApiUrl = ViewData["DeleteApiUrl"]?.ToString() ?? "";
    static int NormalizeShowWhere(int? v)
    {
        // æœ‰äº›å–®æ“šå­—å…¸çš„ iShowWhere æœƒæ˜¯ 0ï¼ˆä»£è¡¨ç¬¬ä¸€é ï¼‰ï¼Œè‹¥éæ¿¾æœƒå°è‡´å–®é ­æ•´æ®µæ¶ˆå¤±
        return (v.HasValue && v.Value > 0) ? v.Value : 1;
    }

    var groupedTabs = headerFieldsList
        .GroupBy(f => NormalizeShowWhere(f.iShowWhere))
        .OrderBy(g => g.Key)
        .ToDictionary(g => g.Key, g => g.ToList());

    var firstTabKey = groupedTabs.Keys.FirstOrDefault();
    if (firstTabKey <= 0) firstTabKey = 1;
    int GetDetailColWidth(TableFieldViewModel c)
    {
        int? byFieldWidth = (c?.iFieldWidth != null && c.iFieldWidth > 0) ? c.iFieldWidth.Value : null;
        int? byDisplaySize = null;

        if (c?.DisplaySize != null && c.DisplaySize > 0)
        {
            // ä»¥å­—å…ƒå¯¬åº¦ä¼°ç®—ï¼ˆDisplaySize é€šå¸¸æ˜¯å­—å…ƒæ•¸ï¼‰
            var w = c.DisplaySize.Value * 14;
            byDisplaySize = Math.Min(520, Math.Max(30, w));
        }

        if (byFieldWidth.HasValue && byDisplaySize.HasValue)
        {
            // è‹¥å…©è€…éƒ½æœ‰ï¼Œæ¡ç”¨è¼ƒå°è€…ï¼Œè®“ DisplaySize å¯ä»¥æŠŠæ¬„ä½ç¸®å°
            return Math.Min(Math.Min(520, Math.Max(30, byFieldWidth.Value)), byDisplaySize.Value);
        }

        if (byFieldWidth.HasValue)
            return Math.Min(520, Math.Max(30, byFieldWidth.Value));

        if (byDisplaySize.HasValue)
            return byDisplaySize.Value;

        return 120;
    }

    var detailTotalWidth = (fields as IEnumerable<TableFieldViewModel>)?.Sum(c => GetDetailColWidth(c)) ?? 0;

    var lookupMap = ViewData["LookupDisplayMap"] as Dictionary<string, Dictionary<string, string>>;

    // å®‰å…¨å–å–®é ­æ¬„ä½å€¼ï¼ˆå®¹è¨±å¤§å°å¯«ä¸åŒï¼‰
    string GetHeaderVal(string key)
    {
        var dict = headerData as IDictionary<string, object> ?? new Dictionary<string, object>(StringComparer.OrdinalIgnoreCase);
        if (dict.TryGetValue(key, out var v) && v != null) return v.ToString();
        var altKey = dict.Keys.FirstOrDefault(k => k.Equals(key, StringComparison.OrdinalIgnoreCase));
        if (!string.IsNullOrEmpty(altKey) && dict.TryGetValue(altKey, out v) && v != null) return v.ToString();
        return "";
    }

    var PaperNum = !string.IsNullOrWhiteSpace(keyFieldName)
        ? GetHeaderVal(keyFieldName)
        : GetHeaderVal("PaperNum");

    var headerLookupMap = ViewData["HeaderLookupMap"] as Dictionary<string, string>;

    string actionPartial = (ViewData["ActionRailPartial"] as string)
                           ?? "~/Pages/Shared/_ActionRail.Empty.cshtml";
        
}

<div class="erp-detail-container">
    <div id="topToolbar" class="top-toolbar mb-2" data-dict-table="@Model.HeaderTableName">
        <div class="toolbar-icon-row" role="group" aria-label="row-nav-and-sub-detail">
            <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btnPrev" title="ä¸Šä¸€ç­†" aria-label="ä¸Šä¸€ç­†"><span class="toolbar-icon">&laquo;</span></button>
            <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btnNext" title="ä¸‹ä¸€ç­†" aria-label="ä¸‹ä¸€ç­†"><span class="toolbar-icon">&raquo;</span></button>
            <button type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add" id="btnSubDetailAdd" title="æ–°å¢ç¬¬äºŒ/ç¬¬ä¸‰éšé …æ¬¡" aria-label="æ–°å¢ç¬¬äºŒæˆ–ç¬¬ä¸‰éšé …æ¬¡"><span class="toolbar-icon">+</span></button>
            <button type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-del" id="btnSubDetailDelete" title="åˆªæ¸›ç¬¬äºŒ/ç¬¬ä¸‰éšé …æ¬¡" aria-label="åˆªæ¸›ç¬¬äºŒæˆ–ç¬¬ä¸‰éšé …æ¬¡"><span class="toolbar-icon">-</span></button>
        <button type="submit" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add toolbar-btn-check" id="btnSaveHeader" form="orderHeaderForm" title="å„²å­˜" aria-label="å„²å­˜"><span class="toolbar-icon">âœ“</span></button>
            <button type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-cancel toolbar-btn-check" id="btnCancelChanges" title="å–æ¶ˆè®Šæ›´" aria-label="å–æ¶ˆè®Šæ›´"><span class="toolbar-icon">&times;</span></button>
        </div>
        <div class="toolbar-main">
        <div>
            @await Html.PartialAsync("_TableToolbar", new TableToolbarModel {
                SearchBtnId = "btnSubSearch",
                AddBtnId = "btnSubAddNew",
                DeleteBtnId = "btnSubBatchDelete",
                QueryFields = ViewData["QueryFields"] as List<QueryFieldViewModel>,
                ModalId = "searchModal",
                ReportSpName = ViewData["ReportSpName"]?.ToString() ?? ""   // ğŸ‘ˆ å¾å¤–å±¤å†å‚³é€²ä¾†
            })
        </div>
        </div>
    </div>

        <div class="action-rail">
          @await Html.PartialAsync(actionPartial, (object)Model)
        </div>

        <!-- å–®é ­å¯ç·¨è¼¯è¡¨å–® -->
        <form id="orderHeaderForm" class="erp-header-form" data-dict-table="@Model.HeaderTableName">
        <div class="row">
            <!-- âœ… Tabs åˆ‡æ›åˆ— -->
            <ul class="nav nav-tabs" id="headerTabs" role="tablist">
                @foreach (var tab in groupedTabs.Keys)
                {
                    <li class="nav-item" role="presentation">
                        <button class="nav-link @(tab == firstTabKey ? "active" : "")"
                                id="tab-@tab-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#tab-@tab"
                                type="button" role="tab">
                            @(tab <= 1 ? headerTabBaseLabel : $"{headerTabBaseLabel}{tab}")
                        </button>
                    </li>
                }
            </ul>

                <!-- âœ… Tabs å°æ‡‰å…§å®¹ -->
              <div class="tab-content" id="headerTabContent">
                    @foreach (var tab in groupedTabs)
                    {
                        <div class="tab-pane fade @(tab.Key == firstTabKey ? "show active" : "")"
                            id="tab-@tab.Key" role="tabpanel">
                            <ul class="list-unstyled header-fields-tab"
                                data-tab-index="@tab.Key"
                                style="position: relative">
                               @foreach (var field in tab.Value)
                                {
                                    object rawValue = null;
                                    headerData?.TryGetValue(field.FieldName, out rawValue);
                                    string displayText = "";

                                    // 1. lookup å„ªå…ˆé¡¯ç¤º
                                    if (headerLookupMap != null && headerLookupMap.TryGetValue(field.FieldName, out var lookupVal))
                                    {
                                        displayText = lookupVal;
                                    }
                                    else if (rawValue != null)
                                    {
                                        //è¼¸å‡ºæ ¼å¼ç”¨Helperè½‰å‹
                                        displayText = FormatHelper.FormatValue(rawValue, field.DataType, field.FormatStr);

                                        // âœ… é€™è£¡è£œï¼šæ•¸å€¼å‹è‹¥ç‚ºç©ºï¼Œé¡¯ç¤º 0
                                        if (string.IsNullOrWhiteSpace(displayText) && field.DataType?.ToLower() == "number")
                                        {
                                            displayText = "0";
                                        }
                                    }

                                    var top = field.iFieldTop ?? 0;
                                    var left = field.iFieldLeft ?? 0;
                                    var width = field.iFieldWidth ?? 160;
                                    var height = field.iFieldHeight ?? 44;

                                    var labTop = field.iLabTop ?? 0;
                                    var labLeft = field.iLabLeft ?? 0;
                                    var labWidth = field.iLabWidth;
                                    var labHeight = field.iLabHeight;
                                    var labStyle = $"top:{labTop}px; left:{labLeft}px;";
                                    if (labWidth.HasValue) { labStyle += $" width:{labWidth.Value}px;"; }
                                    if (labHeight.HasValue) { labStyle += $" height:{labHeight.Value}px;"; }

                                    var liClass = "draggable-field inline"; // æ°¸é æ©«æ’


                                    <li class="header-label-item"
                                        data-field="@field.FieldName"
                                        data-tab="@tab.Key"
                                        title="@field.FieldName"
                                        style="@labStyle">
                                        @field.DisplayLabel
                                    </li>

                                     // åˆ¤æ–·æœ‰ lookup table è¨­å®š
                                    if (!string.IsNullOrWhiteSpace(field.LookupTable) &&
                                        !string.IsNullOrWhiteSpace(field.LookupKeyField) &&
                                        !string.IsNullOrWhiteSpace(field.LookupResultField))
                                    {
                                        // ä¸‹æ‹‰é¸å–®å…ƒä»¶ï¼ˆç”¨ selectï¼‰
                                        <li class="@liClass"
                                            data-field="@field.FieldName"
                                            data-tab="@tab.Key"
                                            title="@field.FieldName"
                                            style="top:@(field.iFieldTop ?? 0)px; left:@(field.iFieldLeft ?? 0)px; width:@(field.iFieldWidth ?? 160)px; height:@(field.iFieldHeight ?? 44)px;">
                                            <span class="field-drag-handle" aria-hidden="true"></span>
                                            <select class="form-select lookup-dropdown"
                                                    name="@field.FieldName"
                                                    data-table="@field.LookupTable"
                                                    data-key="@field.LookupKeyField"
                                                    data-result="@field.LookupResultField.Replace(" ", "")"
                                                    data-selected="@rawValue"> 
                                                <option value="">--è«‹é¸æ“‡--</option>
                                            </select>
                                        </li>
                                    }
                                    else
                                    {
                                        <li class="@liClass"
                                            data-field="@field.FieldName"
                                            data-tab="@tab.Key"
                                            title="@field.FieldName"
                                            style="top:@(top)px; left:@(left)px; width:@(width)px; height:@(height)px;">
                                            <span class="field-drag-handle" aria-hidden="true"></span>
                                            <textarea class="form-control resizable-input"
                                                    name="@field.FieldName">@displayText</textarea>
                                        </li>
                                    }
                                }
                            </ul>
                        </div>
                    }
                </div>
        </div>
    </form>
    <!-- å–®èº«æ˜ç´° table -->
    <div class="erp-table-wrapper" data-dict-table="@tableName">
    <div class="d-flex justify-content-start mb-2">
        <button type="button" id="btnAddDetailRow" class="btn btn-outline-secondary btn-sm">
            ï¼‹
        </button>
        <button type="button" class="btn btn-outline-danger btn-sm" id="btnRowDelete" title="åˆªé™¤ç•¶å‰åˆ—">ï¼</button>
        <button type="button" class="btn btn-success btn-sm d-none" id="btnDetailConfirm">ç¢ºèª</button>
        <button type="button" class="btn btn-secondary btn-sm d-none" id="btnDetailCancel">å–æ¶ˆ</button>
    </div>
        <table class="erp-table" style="width:@(detailTotalWidth)px;">
            <thead>
              <tr>
                @foreach (var col in fields)   // â† ä¸è¦å¯« var dynamic
                {
                    var initWidth = GetDetailColWidth(col);

                    <th data-field="@col.FieldName"
                        style="width:@(initWidth)px; position:relative;"> 
                      <span class="th-text">@col.DisplayLabel</span>
                      <span class="col-resizer" draggable="false"></span>
                    </th>
                }
              </tr>
            </thead>
            <tbody>
                    @if (items != null)
                    {
                        var index = 1;
                        string GetValue(object obj, string fieldName)
                        {
                            if (obj == null) return "";
                            if (obj is IDictionary<string, object> dic)
                            {
                                var kv = dic.FirstOrDefault(k => string.Equals(k.Key, fieldName, StringComparison.OrdinalIgnoreCase));
                                return kv.Equals(default(KeyValuePair<string, object>)) ? "" : kv.Value?.ToString() ?? "";
                            }
                            var prop = obj.GetType().GetProperty(fieldName);
                            return prop != null ? prop.GetValue(obj, null)?.ToString() ?? "" : "";
                        }

                        foreach (var item in items)
                        {
                            var paperNum = GetValue(item, "PaperNum");
                            var itemNo   = GetValue(item, "Item");

                            <tr data-paper-num="@paperNum" data-item="@itemNo" data-state="unchanged">
                                @foreach(var col in fields)
                                {
                                    object v = "";
                                    if (item is IDictionary<string, object> dict)
                                        dict.TryGetValue(col.FieldName, out v);
                                    else if (item is System.Dynamic.ExpandoObject exp)
                                    {
                                        var expDict = (IDictionary<string, object>)exp;
                                        expDict.TryGetValue(col.FieldName, out v);
                                    }
                                    else
                                    {
                                        var prop = item.GetType().GetProperty(col.FieldName);
                                        v = prop != null ? prop.GetValue(item, null) : "";
                                    }

                                    var rowKey = $"{paperNum}_{itemNo}";
                                    string display = null;
            
                                    if (lookupMap != null && lookupMap.TryGetValue(rowKey, out var dict2))
                                    {
                                        dict2.TryGetValue(col.FieldName, out display);
                                    }
                                        
                                        // è¨ˆç®—é¡¯ç¤ºå€¼ï¼Œå…ˆçœ‹ lookupï¼Œå…¶æ¬¡èµ°æ ¼å¼åŒ–
                                        string cellValue;
                                        if (!string.IsNullOrEmpty(display))
                                        {
                                            cellValue = display;
                                        }
                                        else
                                        {
                                            cellValue = FormatHelper.FormatValue(v, col.DataType, col.FormatStr);
                                        }

                                        // é å…ˆç®—å¥½ nameï¼Œé¿å… Razor è§£æéŒ¯èª¤
                                        var inputName = $"Details[{index}].{col.FieldName}";

                                        <td>                                        
                                            <span class="cell-view">@cellValue</span>

                                            <input type="text"
                                                class="form-control form-control-sm cell-edit d-none w-100"
                                                name="@inputName"
                                                data-field="@col.FieldName"         
                                                data-init="@cellValue"             
                                                value="@cellValue" />
                                                
                                        </td>

                                }
                            </tr>
                            index++;
                        }
                    }
            </tbody>
        </table>
    </div>
</div>



<!-- SweetAlert2 foræç¤º -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="~/js/toolbarHandler.js?v=@DateTime.Now.Ticks"></script>
<script src="~/js/gridToolbarTemplate.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />

<!-- å‘¼å«å…ƒä»¶ -->
@await Html.PartialAsync("_OrderDetailPicker",
  new DetailPickerConfig{
      ModalId       = "detailPicker",
      PaperNum      = PaperNum,
      FetchApi      = "/api/OrderDetailSearch/fetch",
      InsertApi     = "/api/OrderDetailSearch/insert",
      DictTableName = "SPOdOCXOrderPOChice",   // â˜… ä½ è¦çš„è¾­å…¸è¡¨
      DictUrlBase   = "/DataDict/EditList"     // â˜… ä½ å€‘èƒ½ç›´æ¥ GET çš„è¾­å…¸é ï¼ˆè‹¥æ˜¯ /CURdTableField/EditList å°±æ”¹é‚£æ¢ï¼‰
  })


<script>
//2025.11.10
  window._tableName = "@Model.HeaderTableName";  // ä¾‹å¦‚ï¼šSPOdMPSOutMainï¼ˆä¿ç•™æ­£ç¢ºå¤§å°å¯«ï¼‰
</script>


<script>
// ============================
// 0) é é¢å¸¸æ•¸ï¼Razor æ³¨å…¥
// ============================
const PAGE = {
  paperNum: "@PaperNum",
  keyField: "PaperNum",
  headerTable: ("@(Model.HeaderTableName ?? "")".trim() || "").toLowerCase(), // e.g. spodordermain
  detailTable: "@(tableName ?? "")".trim(),                                   // e.g. SpodOrderSub
  queryRedirectUrl: "@(ViewData["QueryRedirectUrl"])",
  addApiUrl: "@addApiUrl",
  deleteApiUrl: "@DeleteApiUrl",
  detailRouteTemplate: "@detailRouteTemplate",
  headerFields: @Html.Raw(JsonSerializer.Serialize(headerFieldsList)),
  detailFields: @Html.Raw(JsonSerializer.Serialize(fields))
};

// æ”¾åœ¨æœ€å‰é¢ï¼ˆè¾­å…¸é–‹é—œï¼‰
window.__DICT_OPEN__ = false;

// è®“å…¶å®ƒå·¥å…·å¯ä»¥å–åˆ°ç›®å‰å–®è™Ÿ
window.selectedPaperNum = '@(PaperNum)';

// â˜… æŒ‡å®šè¾­å…¸è¡¨
document.addEventListener('DOMContentLoaded', () => {
  window['OrderDetailPicker_detailPicker']?.setDictTableName('SPOdOCXOrderPOChice');
});

// â˜… ç¶å®šè¾­å…¸ Modal é¡¯ç¤º/é—œé–‰ï¼Œé–ç„¦é»
$('#detailPicker')
  .on('shown.bs.modal', function () {
    window.__DICT_OPEN__ = true;
    $(this).find('input,textarea,select').filter(':visible:enabled').first().trigger('focus');
  })
  .on('hidden.bs.modal', function () {
    window.__DICT_OPEN__ = false;
  });

// â˜… é˜²æ­¢ã€Œå„²å­˜ã€æŒ‰éˆ•è¢«è‡ªå‹•èšç„¦
(function guardSaveButtonFocus(){
  const saveBtn = document.querySelector('#topToolbar button[type="submit"]');
  if (!saveBtn) return;
  $('#detailPicker').on('shown.bs.modal', function(){
    saveBtn.setAttribute('data-prev-tabindex', saveBtn.getAttribute('tabindex') ?? '');
    saveBtn.setAttribute('tabindex', '-1');
    saveBtn.blur();
  });
  $('#detailPicker').on('hidden.bs.modal', function(){
    const prev = saveBtn.getAttribute('data-prev-tabindex');
    if (prev === '') saveBtn.removeAttribute('tabindex');
    else saveBtn.setAttribute('tabindex', prev);
    saveBtn.removeAttribute('data-prev-tabindex');
  });
})();

// ============================
// 1) Toolbar Handler å•Ÿå‹•
// ============================
// è‡ªå‹•æ¨å°æœ¬é çš„è·¯å¾‘æ¨£æ¿ï¼š/SpodOrderSub/{0}
const PAPER_NUM = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(PaperNum ?? ""));
const QUERY_REDIRECT_URL = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
  ViewData["QueryRedirectUrl"]?.ToString() ?? ""
));

const PAGE_PAPER_NUM = ("@PaperNum" || "").trim();
const KEY_FIELD = ("@(keyFieldName ?? "PaperNum")" || "PaperNum").trim();

const backToMainTpl = (PAGE.queryRedirectUrl || '').trim()
  ? PAGE.queryRedirectUrl.replace(/\/$/, '') + '/{0}'
  : '';
const subTpl = (PAGE.detailRouteTemplate || '').replace(/\{PaperNum\}/gi, '{0}');
const finalSwitchTpl = backToMainTpl || subTpl;

console.debug('[Switch template]', finalSwitchTpl);
console.debug('[Sub template for new]', subTpl);

new ToolbarHandler({
  searchBtnId: "btnSubSearch",
  addBtnId: "btnSubAddNew",
  deleteBtnId: "btnSubBatchDelete",
  getSelectedId: () => (PAGE.paperNum || window.selectedPaperNum || ''),
  modalId: "searchModal",
  formId: "searchForm",
  addApiUrl: PAGE.addApiUrl,
  deleteApiUrlFn: id => `/api/${PAGE.deleteApiUrl}/${id || PAGE.paperNum}`,
  paperAction: { url: '/api/PaperAction/DoAction', paperId: "@Model.HeaderTableName", eoc: 0, aftFinished: 2 },
  detailRouteTemplate: subTpl,  // ä½¿ç”¨å–®èº«é è·¯å¾‘ï¼Œæ–°å¢å¾Œè·³è½‰åˆ°å–®èº«é 
  tableName: "@tableName",
  renderTable: null,
  renderPagination: null,
  renderOrderCount: null,
  restoreSearchForm: null,
  queryRedirectUrl: PAGE.queryRedirectUrl
});

// å–®èº«é  â†’ ä¸»é  åˆ‡æ›
(function hookToggleBackToMain() {
  const rawBtn = document.getElementById('btnToggle') ||
    Array.from(document.querySelectorAll('button, a'))
      .find(el => (el.textContent || '').trim() === 'åˆ‡æ›');
  if (!rawBtn) return;
  const btn = rawBtn.cloneNode(true);
  rawBtn.replaceWith(btn);
  btn.addEventListener('click', (e) => {
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    const base = (QUERY_REDIRECT_URL || '').trim().replace(/\/$/, '');
    if (!base) { Swal.fire({ icon: 'error', title: 'æœªæä¾›è¿”å›ä¸»é è·¯å¾‘' }); return; }
    const id = (PAGE_PAPER_NUM || window.selectedPaperNum || '').trim();
    const sep = base.includes('?') ? '&' : '?';
    const url = id ? `${base}${sep}${encodeURIComponent(KEY_FIELD)}=${encodeURIComponent(id)}` : base;
    location.href = url;
  }, { capture: true });
})();

// ============================
// 2) å…±ç”¨å°å·¥å…·ï¼ˆæ•¸å€¼è™•ç†ã€å­—ä¸²åŒ–ï¼‰
// ============================
function normalizeNumberFields(obj, fieldDefs) {
  (fieldDefs || []).forEach(f => {
    if ((f.DataType || '').toLowerCase() === 'number') {
      const k = f.FieldName;
      if (obj[k] != null) obj[k] = obj[k].toString().replace(/,/g, '');
    }
  });
}
function normalizeDetailsNumbers(detailRows, fieldDefs) {
  const numberFields = (fieldDefs || [])
    .filter(f => (f.DataType || '').toLowerCase() === 'number')
    .map(f => f.FieldName.toLowerCase());
  detailRows.forEach(r => {
    numberFields.forEach(fn => {
      Object.keys(r).forEach(k => {
        if (k.toLowerCase() === fn && r[k] != null) r[k] = r[k].toString().replace(/,/g, '');
      });
    });
  });
}
function toCellString(raw, colMeta) {
  if (raw == null) return '';
  if (typeof raw === 'object') return '';
  let s = String(raw);
  const dt = (colMeta?.DataType || '').toLowerCase();
  if (dt.includes('date')) {
    const d = new Date(s); if (!isNaN(d)) return d.toISOString().slice(0,10);
  }
  if (dt === 'number') return s.replace(/,/g, '');
  return s;
}
function withTemporarilyEnabled(formEl, callback) {
  const disabledEls = Array.from(formEl.querySelectorAll('input:disabled, select:disabled, textarea:disabled'));
  disabledEls.forEach(el => el.disabled = false);
  try { return callback(); } finally { disabledEls.forEach(el => el.disabled = true); }
}
function collectHeaderFormData() {
  const form = document.getElementById('orderHeaderForm');
  return withTemporarilyEnabled(form, () => Object.fromEntries(new FormData(form)));
}
function getPaperNum() {
  const p1 = (PAGE.paperNum || window.selectedPaperNum || '').trim();
  if (p1) return p1;
  const header = collectHeaderFormData();
  return (header.PaperNum || header.papernum || '').toString().trim();
}

// ============================
// 3) æ˜ç´°åˆ— æ”¶é›† / æ–°å¢ / åˆªé™¤ / æ•´åˆ—é¸å–
// ============================
function collectDetails() {
  const rows = document.querySelectorAll('.erp-table tbody tr');
  const details = [];
  rows.forEach(tr => {
    let changed = (tr.dataset.state === 'added' || tr.dataset.state === 'deleted');
    const row = { __state: tr.dataset.state || 'modified', PaperNum: tr.dataset.paperNum || PAGE.paperNum };
    tr.querySelectorAll('.cell-edit').forEach(inp => {
      const field = inp.dataset.field; if (!field) return;
      const val = (inp.value ?? '').toString();
      row[field] = val;
      if (!changed && (val !== (inp.dataset.init ?? ''))) changed = true;
    });
    if (row.Item == null && tr.dataset.item) row.Item = tr.dataset.item;
    if (changed) { if (row.__state === 'unchanged') row.__state = 'modified'; details.push(row); }
  });
  return details;
}

let _pendingNewDetailRow = null;

function computeNextItemNumber() {
  const rows = Array.from(document.querySelectorAll('.erp-table tbody tr'));
  let maxItem = 0;
  rows.forEach(tr => {
    const v = (tr.dataset.item || '').toString().trim();
    const n = parseInt(v, 10);
    if (!isNaN(n) && n > maxItem) maxItem = n;
  });
  return maxItem + 1;
}

function isBlankDetailRow(tr) {
  if (!tr) return false;
  const inputs = Array.from(tr.querySelectorAll('.cell-edit'));
  if (!inputs.length) return false;
  let hasValue = false;
  inputs.forEach(inp => {
    const f = (inp.dataset.field || '').toString().toLowerCase();
    if (f === 'papernum' || f === 'item') return;
    const val = (inp.value ?? '').toString().trim();
    if (val === '') return;
    if (/^[-â€“â€”]+$/.test(val)) return;
    if (/^[0-9.,]+$/.test(val)) {
      const num = parseFloat(val.replace(/,/g, ''));
      if (Number.isFinite(num) && num === 0) return;
    }
    hasValue = true;
  });
  return !hasValue;
}

function primeBlankRow(tr) {
  if (!tr) return;
  const pn = PAGE.paperNum || getPaperNum();
  const nextItem = computeNextItemNumber();
  if (!tr.dataset.paperNum) tr.dataset.paperNum = pn;
  if (!tr.dataset.item) tr.dataset.item = String(nextItem);
  tr.querySelectorAll('.cell-edit').forEach(inp => {
    const f = (inp.dataset.field || '').toString().toLowerCase();
    if (f === 'papernum' && !inp.value) {
      inp.value = tr.dataset.paperNum || pn;
      inp.dataset.init = inp.value;
      const span = inp.closest('td')?.querySelector('.cell-view');
      if (span) span.textContent = inp.value;
    }
    if (f === 'item' && !inp.value) {
      inp.value = tr.dataset.item || String(nextItem);
      inp.dataset.init = inp.value;
      const span = inp.closest('td')?.querySelector('.cell-view');
      if (span) span.textContent = inp.value;
    }
  });
}

function appendEmptyDetailRow() {
  const tbody = document.querySelector('.erp-table tbody');
  const tr = document.createElement('tr');
  const pn = PAGE.paperNum || getPaperNum();
  const nextItem = computeNextItemNumber();
  tr.dataset.paperNum = pn;
  tr.dataset.item = String(nextItem);
  tr.dataset.state = 'added';

  let tdsHtml = '';
  (PAGE.detailFields || []).forEach((col) => {
    let v = '';
    if ((col.FieldName || '').toLowerCase() === 'papernum') v = pn;
    if ((col.FieldName || '').toLowerCase() === 'item') v = String(nextItem);

    const inputName = `Details[${tbody.rows.length + 1}].${col.FieldName}`;
    tdsHtml += `
      <td>
        <span class="cell-view">${v}</span>
        <input type="text"
          class="form-control form-control-sm cell-edit d-none w-100"
          name="${inputName}"
          data-field="${col.FieldName}"
          data-init="${v}"
          value="${v}">
      </td>`;
  });
  tr.innerHTML = tdsHtml;
  tbody.appendChild(tr);
  makeRowEditable(tr);
  selectRow(tr);
  tr.querySelectorAll('.cell-edit').forEach(inp => {
    inp.addEventListener('input', () => { if (tr.dataset.state !== 'added') tr.dataset.state = 'modified'; });
  });
  window.__unsavedChanges = true;
  return tr;
}

function showPendingButtons(show) {
  document.getElementById('btnDetailConfirm')?.classList.toggle('d-none', !show);
  document.getElementById('btnDetailCancel')?.classList.toggle('d-none', !show);
}

function cancelPendingDetailRow() {
  if (!_pendingNewDetailRow) return false;
  _pendingNewDetailRow.remove();
  _pendingNewDetailRow = null;
  showPendingButtons(false);
  return true;
}

async function confirmPendingDetailRow() {
  if (!_pendingNewDetailRow) return;
  // äº¤çµ¦æ—¢æœ‰å„²å­˜æµç¨‹ï¼ˆSaveOrderHeaderï¼‰ï¼Œæ±ºå®šæ˜¯å¦å¯«å…¥ DB
  document.getElementById('orderHeaderForm')?.requestSubmit();
}

function onAddRowClick() {
  // åªå…ˆæ–°å¢å‰å°ä¸€ç­†ç©ºè³‡æ–™ï¼Œä¸ç›´æ¥å¯«å…¥è³‡æ–™åº«
  const selected = document.querySelector('.erp-table tbody tr.row-selected');
  const blankRow = (selected && isBlankDetailRow(selected))
    ? selected
    : Array.from(document.querySelectorAll('.erp-table tbody tr')).find(isBlankDetailRow);
  if (blankRow) {
    if (_pendingNewDetailRow && _pendingNewDetailRow !== blankRow) _pendingNewDetailRow.remove();
    _pendingNewDetailRow = blankRow;
    primeBlankRow(blankRow);
    blankRow.dataset.state = 'added';
    makeRowEditable(blankRow);
    selectRow(blankRow);
    showPendingButtons(true);
    window.__unsavedChanges = true;
    return;
  }
  cancelPendingDetailRow();
  _pendingNewDetailRow = appendEmptyDetailRow();
  showPendingButtons(true);
}

// ===== éµç›¤æ·å¾‘ï¼ˆâ†‘ â†“ F7 F8ï¼‰ï¼ŒåŠ ä¸Š modal çŸ­è·¯ =====
(function initDetailRowHotkeys(){
  const BLOCK_FIELDS = new Set(['item','Item']);
  let curColIdx = 0;
  function tdIndex(td){ return td ? Array.prototype.indexOf.call(td.parentElement.children, td) : 0; }
  function selectedRow(){ return document.querySelector('.erp-table tbody tr.row-selected'); }
  function getCellInput(tr, idx){
    if (!tr) return null;
    const td = tr.cells && tr.cells[idx] ? tr.cells[idx] : null;
    return (td && td.querySelector('.cell-edit')) || tr.querySelector('.cell-edit');
  }
  function focusCell(tr, idx){
    if (!tr) return;
    selectRow(tr); makeRowEditable(tr);
    const inp = getCellInput(tr, idx); if (inp){ inp.focus(); inp.select?.(); }
  }
  function syncView(td, val){
    const span = td && td.querySelector ? td.querySelector('.cell-view') : null;
    if (span) span.textContent = (val ?? '');
  }

  document.addEventListener('keydown', async (e) => {
    try{
      // â˜… modal æ‰“é–‹æ™‚ï¼Œå®Œå…¨ä¸è™•ç†
      if (window.__DICT_OPEN__) return;
      if (e.target.closest && e.target.closest('.modal')) return;

      const key = e.key;
      let input = e.target.closest?.('.cell-edit');
      let curTr, curTd;

      if (input && !input.classList.contains('d-none')) {
        curTd = input.closest('td');
        curTr = input.closest('tr');
        curColIdx = tdIndex(curTd);
      } else {
        curTr = selectedRow() || e.target.closest?.('tr');
        if (!curTr) return;
        makeRowEditable(curTr);
        input = getCellInput(curTr, curColIdx) || curTr.querySelector('.cell-edit');
        if (!input) return;
        curTd = input.closest('td');
      }

      const prevTr = curTr.previousElementSibling;
      const nextTr = curTr.nextElementSibling;

      if (key === 'ArrowUp'){ if (prevTr){ e.preventDefault(); focusCell(prevTr, curColIdx); } return; }
      if (key === 'ArrowDown'){
        e.preventDefault();
        if (nextTr){ focusCell(nextTr, curColIdx); return; }
        await onAddRowClick();
        const newTr = document.querySelector('.erp-table tbody tr:last-child');
        focusCell(newTr, curColIdx);
        return;
      }

      if (key === 'F7' || e.keyCode === 118){
        e.preventDefault();
        if (!prevTr) return;
        const prevMap = Object.create(null);
        prevTr.querySelectorAll('.cell-edit').forEach(inp => {
          prevMap[(inp.dataset.field||'').toLowerCase()] = inp;
        });
        curTr.querySelectorAll('.cell-edit').forEach(inp => {
          const f = (inp.dataset.field||'').toLowerCase();
          if (!f || BLOCK_FIELDS.has(f)) return;
          const src = prevMap[f]; if (!src) return;
          inp.value = src.value ?? '';
          inp.dispatchEvent(new Event('input', {bubbles:true}));
          syncView(inp.closest('td'), inp.value);
        });
        if (curTr.dataset.state !== 'added') curTr.dataset.state = 'modified';
        input.focus(); input.select?.();
        return;
      }

      if (key === 'F8' || e.keyCode === 119){
        e.preventDefault();
        if (!prevTr) return;
        const field = (input.dataset.field||'').trim();
        if (BLOCK_FIELDS.has(field)) return;
        const prevInput = getCellInput(prevTr, curColIdx); if (!prevInput) return;
        input.value = prevInput.value ?? '';
        input.dispatchEvent(new Event('input', {bubbles:true}));
        syncView(curTd, input.value);
        input.focus(); input.select?.();
        return;
      }
    }catch(err){ console.error('[detail hotkeys] error:', err); }
  });

  const tbody = document.querySelector('.erp-table tbody');
  if (tbody){
    tbody.addEventListener('click', (e) => {
      if (window.__DICT_OPEN__ || e.target.closest('.modal')) return;
      const td = e.target.closest('td'); if (td) curColIdx = tdIndex(td);
      const tr = e.target.closest('tr'); if (tr) selectRow(tr);
    });
    tbody.addEventListener('focusin', (e) => {
      if (window.__DICT_OPEN__ || e.target.closest('.modal')) return;
      const inp = e.target.closest('.cell-edit');
      if (inp){ curColIdx = tdIndex(inp.closest('td')); selectRow(inp.closest('tr')); }
    });
  }
})();

// 3-4 åˆªé™¤ç›®å‰é¸å–åˆ—
async function onDeleteRowClick() {
  const tr = document.querySelector('.erp-table tbody tr.row-selected');
  if (!tr) { Swal.fire({icon:'info', title:'è«‹å…ˆé»é¸è¦åˆªé™¤çš„æ˜ç´°åˆ—'}); return; }

  const pn = tr.dataset.paperNum || PAGE.paperNum;
  const item = tr.dataset.item || '';
  if (!pn || !item) { Swal.fire({icon:'error', title:'ç„¡æ³•åˆ¤æ–·å–®è™Ÿæˆ–é …æ¬¡'}); return; }

  const { isConfirmed } = await Swal.fire({
    icon: 'question', title: 'åˆªé™¤é€™ä¸€ç­†æ˜ç´°ï¼Ÿ', showCancelButton: true, confirmButtonText: 'åˆªé™¤', cancelButtonText: 'å–æ¶ˆ'
  });
  if (!isConfirmed) return;

  if (tr.dataset.state === 'added') {
    const next = tr.nextElementSibling || tr.previousElementSibling;
    tr.remove(); if (next) selectRow(next);
    return;
  }

  try {
    const url = `/api/OrderHeaderApi/DeleteRow`
      + `?table=${encodeURIComponent(PAGE.detailTable)}`
      + `&paperNum=${encodeURIComponent(pn)}`
      + `&item=${encodeURIComponent(item)}`;
    const res = await fetch(url, { method: 'DELETE' });
    if (!res.ok) throw new Error(await res.text());
    const next = tr.nextElementSibling || tr.previousElementSibling;
    tr.remove(); if (next) selectRow(next);
    Swal.fire({icon:'success', title:'åˆªé™¤å®Œæˆ', timer:900, showConfirmButton:false});
  } catch (err) {
    Swal.fire({icon:'error', title:'åˆªé™¤å¤±æ•—', text: String(err)});
  }
}

// 3-5 æ•´åˆ—é¸å–ï¼†è®“è©²åˆ—å¯ç·¨è¼¯
const tbodyEl = document.querySelector('.erp-table tbody');
function selectRow(tr) {
  if (!tr) return;
  document.querySelectorAll('.erp-table tbody tr.row-selected').forEach(r => r.classList.remove('row-selected'));
  tr.classList.add('row-selected');
}
function makeRowEditable(tr) {
  tr.querySelectorAll('.cell-view').forEach(el => el.classList.add('d-none'));
  tr.querySelectorAll('.cell-edit').forEach(el => el.classList.remove('d-none'));
  const first = tr.querySelector('.cell-edit[data-field="PartNum"]') || tr.querySelector('.cell-edit');
  first?.focus(); first?.select?.();
}
tbodyEl.addEventListener('click',  e => {
  if (window.__DICT_OPEN__ || e.target.closest('.modal')) return;
  const tr = e.target.closest('tr'); if (tr) selectRow(tr);
});
tbodyEl.addEventListener('focusin', e => {
  if (window.__DICT_OPEN__ || e.target.closest('.modal')) return;
  const tr = e.target.closest('tr'); if (tr) selectRow(tr);
});
document.getElementById('btnAddDetailRow')?.addEventListener('click', onAddRowClick);
document.getElementById('btnRowDelete')?.addEventListener('click', onDeleteRowClick);
document.getElementById('btnDetailCancel')?.addEventListener('click', (e) => { e.preventDefault(); cancelPendingDetailRow(); });
document.getElementById('btnDetailConfirm')?.addEventListener('click', async (e) => { e.preventDefault(); await confirmPendingDetailRow(); });

// ============================
// 4) å„²å­˜å–®é ­ï¼‹å–®èº«
// ============================
document.getElementById('orderHeaderForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const header = collectHeaderFormData();
  normalizeNumberFields(header, PAGE.headerFields);
  const details = collectDetails();
  normalizeDetailsNumbers(details, PAGE.detailFields);

  const payload = { ...header, Details: details, __headerTable: PAGE.headerTable, __detailTable: PAGE.detailTable || undefined };

  try {
    const resp = await fetch('/api/OrderHeaderApi/SaveOrderHeader', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
    });
    if (resp.ok) {
      const result = await resp.json();
      if (result.updated) {
        await Swal.fire({ icon: 'success', title: 'å„²å­˜æˆåŠŸï¼', timer: 1000, showConfirmButton: false });
        localStorage.setItem("afterSave", "1"); location.reload();
      } else {
        Swal.fire({ icon: 'info', title: 'æ²’æœ‰è³‡æ–™ç•°å‹•' });
      }
    } else {
      let msg = 'å„²å­˜å¤±æ•—'; try { const txt = await resp.text(); msg = txt || msg; } catch {}
      Swal.fire({ icon: 'error', title: msg });
    }
  } catch (err) { Swal.fire({ icon: 'error', title: 'ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤' }); }
});

// ============================
// 5) æª¢è¦–/ç·¨è¼¯æ¨¡å¼åˆ‡æ›ï¼ˆé¿é–‹ modal å…§å…ƒç´ ï¼‰
// ============================
const editBtn = document.getElementById('btnViewEditToggle');
if (editBtn) {
  let isEdit = false;

  function setLookupReadOnly(selectEl, readOnly) {
    if (!selectEl) return;
    if (readOnly) {
      selectEl.disabled = false; // å¿…é ˆå¯é»ï¼Œæ‰èƒ½å±•é–‹é¸é …
      selectEl.dataset.lockedValue = selectEl.value ?? '';
      selectEl.classList.add('lookup-readonly');
      selectEl.setAttribute('aria-readonly', 'true');
      selectEl.title = 'ç€è¦½æ¨¡å¼ï¼šå¯æŸ¥çœ‹ä¸‹æ‹‰å…§å®¹ï¼Œä¸èƒ½ä¿®æ”¹';
    } else {
      selectEl.classList.remove('lookup-readonly');
      selectEl.removeAttribute('aria-readonly');
      selectEl.title = '';
      selectEl.dataset.lockedValue = selectEl.value ?? '';
      selectEl.disabled = false;
    }
  }

  function applyHeaderEditState(editing) {
    document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
      .forEach(el => {
        if (el.closest('.modal')) return;
        if (el.matches('select.lookup-dropdown')) {
          setLookupReadOnly(el, !editing);
        } else {
          el.disabled = !editing;
        }
      });
  }

  function applyToolbarEditState(editing) {
    const editOnlyIds = ['btnSubDetailAdd', 'btnSubDetailDelete', 'btnSaveHeader', 'btnCancelChanges'];
    editOnlyIds.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.disabled = !editing;
      el.classList.toggle('disabled', !editing);
    });

    const viewOnlyIds = ['btnSubSearch', 'btnSwitch', 'btnSubAddNew', 'btnPrint', 'btnCancel', 'btnPrev', 'btnNext'];
    viewOnlyIds.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      if (editing) {
        el.dataset.prevDisabled = el.disabled ? '1' : '0';
        el.disabled = true;
        el.classList.add('disabled');
      } else {
        const wasDisabled = el.dataset.prevDisabled === '1';
        el.disabled = wasDisabled;
        if (!wasDisabled) el.classList.remove('disabled');
        delete el.dataset.prevDisabled;
      }
    });
  }

  // ç€è¦½æ¨¡å¼ï¼šä¸‹æ‹‰å¯å±•é–‹ä½†ä¸å¯è®Šæ›´
  document.addEventListener('change', (e) => {
    const sel = e.target;
    if (!(sel instanceof HTMLSelectElement)) return;
    if (!sel.matches('.erp-header-form select.lookup-dropdown')) return;
    if (sel.closest('.modal')) return;
    if (isEdit) return;

    const locked = sel.dataset.lockedValue ?? '';
    if ((sel.value ?? '') !== locked) {
      sel.value = locked;
    }
    e.stopPropagation();
  }, true);
  document.addEventListener('keydown', (e) => {
    const sel = e.target;
    if (!(sel instanceof HTMLSelectElement)) return;
    if (!sel.matches('.erp-header-form select.lookup-dropdown')) return;
    if (sel.closest('.modal')) return;
    if (isEdit) return;

    const blockKeys = ['ArrowUp', 'ArrowDown', 'Home', 'End', 'PageUp', 'PageDown', ' ', 'Enter'];
    if (blockKeys.includes(e.key)) {
      e.preventDefault();
      e.stopPropagation();
    }
  }, true);
  const getHeaderValueByLabel = (labelText) => {
    const $label = $('.header-label-item').filter(function () {
      return $(this).text().trim() === labelText;
    }).first();
    if (!$label.length) return null;
    const fieldName = $label.data('field');
    if (!fieldName) return null;
    const $li = $(`.draggable-field[data-field="${fieldName}"]`).first();
    if (!$li.length) return null;
    const $ctrl = $li.find('select, input, textarea').first();
    if (!$ctrl.length) return null;
    if ($ctrl.is('select')) return $ctrl.find('option:selected').text().trim();
    return ($ctrl.val() || '').toString().trim();
  };

  editBtn.addEventListener('click', function () {
    const status = getHeaderValueByLabel('å–®æ“šç‹€æ…‹') || '';
    if (window.BLOCK_STATUSES && window.BLOCK_STATUSES.includes(status)) {
      Swal.fire({ icon: 'warning', title: 'ç„¡æ³•ä¿®æ”¹', text: `æ­¤å–®æ“šç‹€æ…‹ç‚ºã€Œ${status}ã€ï¼Œä¸å¯é€²è¡Œä¿®æ”¹ã€‚`}); return;
    }
    isEdit = !isEdit; editBtn.textContent = isEdit ? 'ä¿ç•™' : 'ä¿®æ”¹';
    applyHeaderEditState(isEdit); // â˜… ä¸å½±éŸ¿ modal è£¡çš„æ¬„ä½
    applyToolbarEditState(isEdit);
    document.querySelectorAll('.erp-table .cell-view').forEach(el => el.classList.toggle('d-none', isEdit));
    document.querySelectorAll('.erp-table .cell-edit').forEach(el => el.classList.toggle('d-none', !isEdit));
    document.querySelectorAll('.erp-table .cell-edit').forEach(inp => {
      inp.addEventListener('input', () => {
        const tr = inp.closest('tr'); if (tr && tr.dataset.state !== 'added') tr.dataset.state = 'modified';
      });
    });
  });

  window.addEventListener('load', () => {
    applyHeaderEditState(false);
    applyToolbarEditState(false);
    if (localStorage.getItem("afterSave") === "1") {
      localStorage.removeItem("afterSave");
      document.getElementById("btnViewEditToggle")?.click();
    }
  });
}

// ============================
// 6) Header ç‰ˆé¢æ‹–æ‹‰å„²å­˜ / Lookup ä¸‹æ‹‰åˆå§‹åŒ–ï¼ˆjQueryï¼‰
// ============================
$(function () {
  let debounceTimer;
  const debounceSave = () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(saveLayoutChanges, 400); };

  function saveLayoutChanges() {
    const layout = [];
    const hiddenTabs = $(".tab-pane").not(".show");
    hiddenTabs.addClass("temporary-show").addClass("show").css("display", "block");
    $(".draggable-field").each(function () {
      const $li = $(this);
      layout.push({
        fieldName: $li.data("field"),
        top: Math.round($li.position().top),
        left: Math.round($li.position().left),
        width: Math.round($li.outerWidth()),
        height: Math.round($li.outerHeight()),
        ishowWhere: parseInt($li.attr("data-tab")) || 1
      });
    });
    hiddenTabs.removeClass("show").removeClass("temporary-show").css("display", "");
    if (!layout.length) return;

    fetch("/api/TableFieldLayout/SaveHeaderLayout", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tableName: "@Model.HeaderTableName", layoutUpdates: layout })
    }).catch(()=>{});
  }

  $(".draggable-field").each(function () {
    const $li = $(this);
    $li.draggable({
      handle: ".field-drag-handle",
      helper: function () {
        const labelText = $('.header-label-item[data-field="' + $li.data('field') + '"]').text().trim();
        return $("<div>").text(labelText).css({
          width: "80px", height: $li.outerHeight() + "px",
          background: "#eef", border: "1px dashed #999", padding: "4px", "font-size": "0.9em"
        });
      },
      appendTo: "body", zIndex: 10000,
      start: function () { $(this).hide(); },
      stop: function (event, ui) {
        const $item = $(this);
        $item.show();

        // ä½¿ç”¨ helper æ‹–æ›³æ™‚ï¼ŒåŸå…ƒç´ ä¸æœƒè‡ªå‹•æ›ä½ç½®ï¼Œé€™è£¡æ‰‹å‹•æŠŠ top/left å¯«å› parent åº§æ¨™ç³»
        const $parent = $item.parent();
        const parentOff = $parent.offset();
        if (parentOff) {
          $item.css({
            position: "absolute",
            top: Math.round(ui.offset.top - parentOff.top),
            left: Math.round(ui.offset.left - parentOff.left)
          });
        }

        debounceSave();
      }
    });
    $li.resizable({ handles: "e, se", minWidth: 50, minHeight: 30, stop: debounceSave });
  });

  function setLayoutEditEnabled(enabled) {
    const $body = $(document.body);
    $body.toggleClass("layout-edit-enabled", !!enabled);
    $(".draggable-field").each(function () {
      try { $(this).draggable(enabled ? "enable" : "disable"); } catch {}
      try { $(this).resizable(enabled ? "enable" : "disable"); } catch {}
    });
  }

  setLayoutEditEnabled(false);
  $(document).on("keydown", function (e) {
    if (e.key === "Shift") setLayoutEditEnabled(true);
  });
  $(document).on("keyup", function (e) {
    if (e.key === "Shift") setLayoutEditEnabled(false);
  });

  // ============================
  // 6-1) å¤šé¸/ç¾¤çµ„æ‹–æ›³/å°é½Šï¼ˆå¿«æ·éµï¼‰
  //  - Ctrl/Meta+é»æ“Šï¼šåˆ‡æ›é¸å–
  //  - é»æ“Šç©ºç™½ï¼šæ¸…é™¤é¸å–
  //  - æ‹–æ›³ä»»ä¸€è¢«é¸å–çš„ labelï¼šæ•´çµ„ä¸€èµ·ç§»å‹•
  //  - L/R/T/Bï¼šå·¦/å³/ä¸Š/ä¸‹å°é½Šï¼ˆä»¥æ‰€é¸ç¾¤çµ„çš„æœ€å·¦/æœ€å³/æœ€ä¸Š/æœ€ä¸‹ç‚ºæº–ï¼‰
  //  - H/Vï¼šæ°´å¹³/å‚ç›´å¹³å‡åˆ†ä½ˆï¼ˆä¿ç•™æœ€å·¦/æœ€å³ æˆ– æœ€ä¸Š/æœ€ä¸‹ï¼‰
  //  - æ–¹å‘éµï¼šå¾®èª¿ï¼ˆShift=10pxï¼‰
  // ============================
  const $doc = $(document);
  const SELECTED_CLASS = "md-selected";
  let dragGroupSnapshot = null; // { baseEl, baseTop, baseLeft, items:[{el, top,left}] }

  function $allFields() { return $(".draggable-field"); }
  function $selected() { return $allFields().filter("." + SELECTED_CLASS); }
  function isTypingTarget(e) {
    const t = e?.target;
    if (!t) return false;
    const tag = (t.tagName || "").toLowerCase();
    return tag === "input" || tag === "textarea" || tag === "select" || t.isContentEditable;
  }
  function clearSelection() { $selected().removeClass(SELECTED_CLASS); }
  function toggleSelection($el) { $el.toggleClass(SELECTED_CLASS); }
  function selectOnly($el) { clearSelection(); $el.addClass(SELECTED_CLASS); }

  // é»é¸æ§åˆ¶ï¼ˆç”¨ mousedownï¼Œé¿å…è·Ÿæ‹–æ›³è¡çªï¼‰
  $doc.on("mousedown", ".field-drag-handle", function (e) {
    if (window.__DICT_OPEN__) return;
    const $field = $(this).closest(".draggable-field");
    if (!$field.length) return;

    // Ctrl/Metaï¼šåˆ‡æ›å¤šé¸ï¼›å¦å‰‡é»åˆ°æœªé¸å–çš„å°±å–®é¸
    if (e.ctrlKey || e.metaKey) {
      toggleSelection($field);
    } else if (!$field.hasClass(SELECTED_CLASS)) {
      selectOnly($field);
    }
  });
  $doc.on("mousedown", ".header-label-item", function (e) {
    if (window.__DICT_OPEN__) return;
    const fieldName = $(this).data("field");
    if (!fieldName) return;
    const $field = $(`.draggable-field[data-field="${fieldName}"]`).first();
    if (!$field.length) return;

    if (e.ctrlKey || e.metaKey) {
      toggleSelection($field);
    } else if (!$field.hasClass(SELECTED_CLASS)) {
      selectOnly($field);
    }
  });
  $doc.on("mousedown", function (e) {
    if (window.__DICT_OPEN__) return;
    if ($(e.target).closest(".draggable-field, .header-label-item, .ui-resizable-handle, .modal").length) return;
    clearSelection();
  });

  function ensureDragGroupSnapshot($base) {
    const $sel = $selected();
    const $group = ($sel.length ? $sel : $base);
    if (!$base.hasClass(SELECTED_CLASS) && $sel.length) selectOnly($base);
    dragGroupSnapshot = {
      baseEl: $base.get(0),
      baseTop: Math.round($base.position().top),
      baseLeft: Math.round($base.position().left),
      items: $group.toArray().map(el => {
        const $el = $(el);
        return { el, top: Math.round($el.position().top), left: Math.round($el.position().left) };
      })
    };
  }

  // è®“æ‹–æ›³æ™‚èƒ½å¤ æ•´çµ„ä¸€èµ·ç§»å‹•ï¼ˆç”¨ draggable çš„ start/stop hookï¼‰
  $doc.on("dragstart", ".draggable-field", function () { /* noop */ });
  $allFields().each(function () {
    const $li = $(this);
    // jQuery UI draggable å·²åˆå§‹åŒ–ï¼Œä¸Šé¢å·²è¨­å®š stopï¼›é€™è£¡ç”¨ option æ³¨å…¥ start/stop2 è¡Œç‚º
    $li.draggable("option", "start", function (event) {
      if (window.__DICT_OPEN__) return;
      ensureDragGroupSnapshot($(this));
      $(this).hide();
    });
    $li.draggable("option", "stop", function (event, ui) {
      const $item = $(this);
      $item.show();

      const $parent = $item.parent();
      const parentOff = $parent.offset();
      if (!parentOff) return;

      const newTop = Math.round(ui.offset.top - parentOff.top);
      const newLeft = Math.round(ui.offset.left - parentOff.left);

      // å–®é¡†æˆ–ç¾¤çµ„ï¼šä»¥ base çš„ delta å¥—ç”¨åˆ°æ‰€æœ‰é¸å–
      if (dragGroupSnapshot && dragGroupSnapshot.baseEl === $item.get(0)) {
        const dy = newTop - dragGroupSnapshot.baseTop;
        const dx = newLeft - dragGroupSnapshot.baseLeft;
        dragGroupSnapshot.items.forEach(it => {
          const $el = $(it.el);
          $el.css({
            position: "absolute",
            top: Math.max(0, it.top + dy),
            left: Math.max(0, it.left + dx)
          });
        });
        dragGroupSnapshot = null;
        debounceSave();
        return;
      }

      // fallbackï¼ˆç†è«–ä¸Šèµ°ä¸åˆ°ï¼‰
      $item.css({ position: "absolute", top: newTop, left: newLeft });
      dragGroupSnapshot = null;
      debounceSave();
    });
  });

  function applyToSelected(mutator) {
    const $sel = $selected();
    if (!$sel.length) return false;
    $sel.each(function () { mutator($(this)); });
    debounceSave();
    return true;
  }
  function alignSelected(mode) {
    const $sel = $selected();
    if ($sel.length < 2) return false;
    const boxes = $sel.toArray().map(el => {
      const $el = $(el);
      const p = $el.position();
      const w = $el.outerWidth();
      const h = $el.outerHeight();
      const $ctrl = $el.find('select, input, textarea').first();
      const ctrlOff = $ctrl.length ? $ctrl.offset() : null;
      const elOff = $el.offset();
      const ctrlLeftAbs = ctrlOff?.left ?? elOff.left;
      const ctrlTopAbs = ctrlOff?.top ?? elOff.top;
      const ctrlW = $ctrl.length ? $ctrl.outerWidth() : w;
      const ctrlH = $ctrl.length ? $ctrl.outerHeight() : h;
      return {
        $el,
        top: Math.round(p.top),
        left: Math.round(p.left),
        right: Math.round(p.left + w),
        bottom: Math.round(p.top + h),
        w,
        h,
        ctrlLeftAbs,
        ctrlRightAbs: ctrlLeftAbs + ctrlW,
        ctrlTopAbs,
        ctrlBottomAbs: ctrlTopAbs + ctrlH,
        ctrlW,
        ctrlH
      };
    });
    // L/Rï¼šå°é½Šã€Œè¼¸å…¥æ¬„ä½ã€(select/input/textarea)ï¼Œè€Œé label
    const minCtrlLeftAbs = Math.min(...boxes.map(b => b.ctrlLeftAbs));
    const maxCtrlRightAbs = Math.max(...boxes.map(b => b.ctrlRightAbs));

    const minLeft = Math.min(...boxes.map(b => b.left));
    const maxRight = Math.max(...boxes.map(b => b.right));
    const minTop = Math.min(...boxes.map(b => b.top));
    const maxBottom = Math.max(...boxes.map(b => b.bottom));

    boxes.forEach(b => {
      if (mode === "L") {
        const delta = minCtrlLeftAbs - b.ctrlLeftAbs;
        b.$el.css("left", Math.max(0, Math.round(b.left + delta)));
      }
      if (mode === "R") {
        const targetCtrlLeftAbs = maxCtrlRightAbs - b.ctrlW;
        const delta = targetCtrlLeftAbs - b.ctrlLeftAbs;
        b.$el.css("left", Math.max(0, Math.round(b.left + delta)));
      }
      if (mode === "T") b.$el.css("top", minTop);
      if (mode === "B") b.$el.css("top", Math.max(0, maxBottom - b.h));
    });
    debounceSave();
    return true;
  }
  function distributeSelected(axis) {
    const $sel = $selected();
    if ($sel.length < 3) return false;
    const boxes = $sel.toArray().map(el => {
      const $el = $(el);
      const p = $el.position();
      const w = $el.outerWidth();
      const h = $el.outerHeight();
      return { $el, top: Math.round(p.top), left: Math.round(p.left), w, h };
    });
    if (axis === "H") {
      boxes.sort((a, b) => a.left - b.left);
      const first = boxes[0], last = boxes[boxes.length - 1];
      const span = (last.left - first.left);
      const gaps = boxes.length - 1;
      const step = gaps ? Math.round(span / gaps) : 0;
      boxes.forEach((b, i) => b.$el.css("left", Math.max(0, first.left + step * i)));
    } else {
      boxes.sort((a, b) => a.top - b.top);
      const first = boxes[0], last = boxes[boxes.length - 1];
      const span = (last.top - first.top);
      const gaps = boxes.length - 1;
      const step = gaps ? Math.round(span / gaps) : 0;
      boxes.forEach((b, i) => b.$el.css("top", Math.max(0, first.top + step * i)));
    }
    debounceSave();
    return true;
  }

  $doc.on("keydown", function (e) {
    if (window.__DICT_OPEN__) return;
    if (isTypingTarget(e)) return;
    const key = (e.key || "").toUpperCase();

    // å°é½Š
    if (key === "L" || key === "R" || key === "T" || key === "B") {
      if (alignSelected(key)) { e.preventDefault(); return; }
    }
    // åˆ†ä½ˆ
    if (key === "H" || key === "V") {
      if (distributeSelected(key)) { e.preventDefault(); return; }
    }
    // æ–¹å‘éµå¾®èª¿
    const step = e.shiftKey ? 10 : 1;
    if (e.key === "ArrowLeft")  { if (applyToSelected($el => $el.css("left", Math.max(0, Math.round($el.position().left) - step)))) { e.preventDefault(); } return; }
    if (e.key === "ArrowRight") { if (applyToSelected($el => $el.css("left", Math.max(0, Math.round($el.position().left) + step)))) { e.preventDefault(); } return; }
    if (e.key === "ArrowUp")    { if (applyToSelected($el => $el.css("top",  Math.max(0, Math.round($el.position().top) - step)))) { e.preventDefault(); } return; }
    if (e.key === "ArrowDown")  { if (applyToSelected($el => $el.css("top",  Math.max(0, Math.round($el.position().top) + step)))) { e.preventDefault(); } return; }
  });

  $(".header-fields-tab").droppable({
    accept: ".draggable-field", tolerance: "pointer",
    over: function () { $(this).addClass("drop-hover"); },
    out:  function () { $(this).removeClass("drop-hover"); },
    drop: function (event, ui) {
      $(this).removeClass("drop-hover");
      const $zone = $(this), $item = $(ui.draggable);
      const newTabIndex = parseInt($zone.data("tab-index")) || 1;
      $item.appendTo($zone).attr("data-tab", newTabIndex).css({
        top: ui.offset.top - $zone.offset().top,
        left: ui.offset.left - $zone.offset().left,
        position: "absolute"
      });
      debounceSave();
    }
  });

  let dragTabSwitchTimer = null;
  $("#headerTabs button").droppable({
    accept: ".draggable-field",
    over: function () { const $tabBtn = $(this); dragTabSwitchTimer = setTimeout(() => { $tabBtn.trigger("click"); }, 600); },
    out:  function () { clearTimeout(dragTabSwitchTimer); }
  });

  $('.lookup-dropdown').each(function() {
    const $select = $(this);
    const table = $select.data('table'), key = $select.data('key'),
          result = $select.data('result'), selected = $select.data('selected');
    $.getJSON(`/api/TableFieldLayout/LookupData?table=${table}&key=${key}&result=${result}`, function(data) {
      $select.empty().append('<option value="">--è«‹é¸æ“‡--</option>');
      (data || []).forEach(row => {
        const val = row.key;
        const label = Object.keys(row).filter(p => p.startsWith('result')).map(p => row[p]).join(' - ');
        const $opt = $('<option>').val(val).text(label);
        if (val == selected) $opt.attr('selected', true);
        $select.append($opt);
      });
      $select.next('.lookup-label').text($select.find('option:selected').text());
      // è‹¥æ˜¯ç€è¦½æ¨¡å¼ï¼ˆreadonlyï¼‰ï¼Œåœ¨ä¸‹æ‹‰è³‡æ–™è¼‰å…¥å¾ŒåŒæ­¥ lockedValueï¼Œé¿å…è®Šæ›´æ™‚å›å¾©æˆç©ºå€¼
      if ($select.hasClass('lookup-readonly') && $select[0]) {
        $select[0].dataset.lockedValue = $select.val() ?? '';
      }
    });
    $select.on('change', function() {
      $(this).next('.lookup-label').text($(this).find('option:selected').text());
    });
  });

  function setInitialTabHeights(offsetPx = 10) {
    const hiddenTabs = $(".tab-pane").not(".show");
    hiddenTabs.addClass("tmp-show").addClass("show").css("display", "block");
    $(".header-fields-tab").each(function () {
      let maxBottom = 0;
      $(this).children(".draggable-field").each(function () {
        const $el = $(this);
        maxBottom = Math.max(maxBottom, $el.position().top + $el.outerHeight());
      });
      $(this).height(Math.max(0, Math.ceil(maxBottom + offsetPx)));
    });
    hiddenTabs.removeClass("show tmp-show").css("display", "");
  }
  requestAnimationFrame(() => setInitialTabHeights(10));
});

// ============================
// 7) ä¸Šä¸€ç­† / ä¸‹ä¸€ç­†
// ============================
const NAV_BTN_PREV = document.getElementById('btnPrev');
const NAV_BTN_NEXT = document.getElementById('btnNext');
let navIds = [], navIndex = -1;

function loadLastFilters() {
  try { const s = localStorage.getItem("orderListQueryFilters"); return s ? JSON.parse(s) : []; }
  catch { return []; }
}
function getDetailBasePath() { return location.pathname.replace(/\/[^\/]+$/, "/"); }
function gotoPaper(pn) { if (!pn) return; localStorage.setItem("lastViewedPaperNum", pn); location.href = getDetailBasePath() + pn; }
function updateNavButtons() {
  const hasPrev = navIndex > 0;
  const hasNext = navIndex >= 0 && navIndex < navIds.length - 1;
  NAV_BTN_PREV.disabled = !hasPrev;
  NAV_BTN_NEXT.disabled = !hasNext;
  NAV_BTN_PREV.onclick = () => hasPrev && gotoPaper(navIds[navIndex - 1]);
  NAV_BTN_NEXT.onclick = () => hasNext && gotoPaper(navIds[navIndex + 1]);
}
async function fetchIdListByApi(filters) {
  // å–å¾—æ‰€æœ‰ id åˆ—è¡¨ï¼Œèµ°é€šç”¨ DynamicTable API
  const res = await fetch('/api/DynamicTable/PagedQuery', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ table: PAGE.headerTable, filters: [...(filters || []), {Field:"page",Op:"",Value:"1"}, {Field:"pageSize",Op:"",Value:"999999"}] })
  });
  const json = await res.json();
  const rows = Array.isArray(json.data) ? json.data : [];
  return rows.map(r => r[PAGE.keyField]).filter(Boolean);
}
async function fetchIdListByPagedQuery(filters) {
  // åŒä¸Šï¼Œç›´æ¥ç”¨ DynamicTable å–å¾—å¤§ç­†æ•¸æ“š
  const fs = [...(filters || []), {Field:"page",Op:"",Value:"1"}, {Field:"pageSize",Op:"",Value:"999999"}];
  const res = await busyFetch('/api/DynamicTable/PagedQuery', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ table: PAGE.headerTable, filters: fs })
  },'åˆ‡æ›ä¸­â€¦');
  const json = await res.json();
  const rows = Array.isArray(json.data) ? json.data : [];
  return rows.map(r => r[PAGE.keyField]).filter(Boolean);
}
async function initRowNavigation() {
  try {
    const filters = loadLastFilters();
    try { navIds = await fetchIdListByApi(filters); }
    catch { navIds = await fetchIdListByPagedQuery(filters); }
    navIndex = navIds.indexOf(PAGE.paperNum);
    updateNavButtons();
  } catch {
    NAV_BTN_PREV.disabled = true; NAV_BTN_NEXT.disabled = true;
  }
}
initRowNavigation();

// ============================
// 8) å…¶ä»–ï¼šæŠŠæœ€å¾Œæª¢è¦–çš„å–®è™Ÿå­˜åœ¨ localStorage
// ============================
localStorage.setItem("lastViewedPaperNum", window.selectedPaperNum);
function getHeaderValueByLabel(labelText) {
  const labelEl = Array.from(document.querySelectorAll('.header-label-item'))
    .find(el => (el.textContent || '').trim() === labelText);
  if (!labelEl) return '';
  const fieldName = labelEl.getAttribute('data-field') || '';
  if (!fieldName) return '';
  const li = document.querySelector(`.draggable-field[data-field="${CSS.escape(fieldName)}"]`);
  if (!li) return '';
  const ctrl = li.querySelector('select, input, textarea');
  if (!ctrl) return '';
  if (ctrl.tagName.toLowerCase() === 'select') {
    const opt = ctrl.options[ctrl.selectedIndex];
    return (opt?.text || opt?.value || '').trim();
  }
  return (ctrl.value || '').trim();
}

// å–®èº«æ‹–æ›³æ¬„ä½å¯¬åº¦èª¿æ•´
(function enableDetailColumnResize(){
  const table = document.querySelector('.erp-table');
  if (!table) return;

  const detailTableName = (PAGE.detailTable || '').replace(/^dbo\./i, '').trim().toLowerCase();
  const saveUrl = '/api/TableFieldLayout/SaveDetailLayout';
  let isDown = false, startX = 0, startWidth = 0, th, thIndex = -1;
  const ths = Array.from(table.querySelectorAll('thead th'));
  function columnCells(index){ return Array.from(table.querySelectorAll(`tbody tr td:nth-child(${index+1})`)); }

  let saveTimer = null;
  function debounceSave(){ clearTimeout(saveTimer); saveTimer = setTimeout(persistWidths, 400); }

  async function persistWidths(){
    try{
      const payload = { tableName: detailTableName, cols: ths.map(th => ({ fieldName: th.dataset.field, width: Math.round(th.getBoundingClientRect().width) })) };
      await fetch(saveUrl, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) }).catch(()=>{});
      localStorage.setItem(`colwidth:${detailTableName}`, JSON.stringify(payload.cols));
    }catch(e){}
  }

  (function applyInitialWidths(){
    try{
      const raw = localStorage.getItem(`colwidth:${detailTableName}`); if (!raw) return;
      const cols = JSON.parse(raw) || [];
      cols.forEach(c => {
        const th = ths.find(x => (x.dataset.field||'').toLowerCase() === (c.fieldName||'').toLowerCase());
        if (!th) return;
        th.style.width = `${c.width}px`;
        const idx = ths.indexOf(th);
        columnCells(idx).forEach(td => td.style.width = `${c.width}px`);
      });
    }catch(e){}
  })();

  ths.forEach((h, idx) => {
    const handle = h.querySelector('.col-resizer');
    if (!handle) return;
    handle.addEventListener('mousedown', (e) => {
      e.preventDefault();
      isDown = true; th = h; thIndex = idx;
      startX = e.pageX; startWidth = th.getBoundingClientRect().width;
      document.body.classList.add('resizing'); th.classList.add('resizing');
      columnCells(thIndex).forEach(td => td.classList.add('resizing'));
    });
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDown || !th) return;
    const dx = e.pageX - startX;
    const newW = Math.max(30, startWidth + dx);
    th.style.width = `${newW}px`;
    columnCells(thIndex).forEach(td => td.style.width = `${newW}px`);
  });

  document.addEventListener('mouseup', () => {
    if (!isDown) return;
    isDown = false;
    document.body.classList.remove('resizing');
    th?.classList.remove('resizing');
    columnCells(thIndex).forEach(td => td.classList.remove('resizing'));
    debounceSave();
    th = null; thIndex = -1;
  });
})();

function normalizeBool(val) {
  const s = (val ?? '').toString().trim().toLowerCase();
  return s === '1' || s === 'true' || s === 'y' || s === 'yes';
}

function syncLookupLabel(selectEl) {
  const label = selectEl?.nextElementSibling;
  if (label && label.classList.contains('lookup-label')) {
    const text = selectEl.options[selectEl.selectedIndex]?.text ?? '';
    label.textContent = text;
  }
}

function captureHeaderInitValues() {
  document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
    .forEach(el => {
      if (el.closest('.modal')) return;
      if (el.dataset.init != null) return;
      if (el.type === 'checkbox') {
        el.dataset.init = el.checked ? '1' : '0';
      } else {
        el.dataset.init = el.value ?? '';
      }
    });
}

function resetHeaderForm() {
  document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select')
    .forEach(el => {
      if (el.closest('.modal')) return;
      const init = el.dataset.init ?? '';
      if (el.type === 'checkbox') {
        el.checked = normalizeBool(init);
      } else {
        el.value = init;
      }
      if (el.matches('select.lookup-dropdown')) syncLookupLabel(el);
    });
}

function resetDetailTable() {
  const tbody = document.querySelector('.erp-table tbody');
  if (!tbody) return;
  Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
    const state = (tr.dataset.state || '').toString().toLowerCase();
    if (state === 'added') {
      tr.remove();
      return;
    }

    tr.dataset.state = 'unchanged';
    tr.querySelectorAll('.cell-edit').forEach(inp => {
      const init = inp.dataset.init ?? '';
      if (inp.type === 'checkbox') {
        inp.checked = normalizeBool(init);
      } else {
        inp.value = init;
      }
      const view = inp.closest('td')?.querySelector('.cell-view');
      if (view && inp.type !== 'checkbox') view.textContent = init;
      if (view && inp.type === 'checkbox') {
        const viewChk = view.querySelector('input.cell-view-checkbox');
        if (viewChk) viewChk.checked = normalizeBool(init);
      }
    });
    tr.querySelectorAll('.cell-view').forEach(el => el.classList.remove('d-none'));
    tr.querySelectorAll('.cell-edit').forEach(el => el.classList.add('d-none'));
  });
  _pendingNewDetailRow = null;
  showPendingButtons(false);
}

// æœªå„²å­˜æ——æ¨™
window.__unsavedChanges = false;
document.addEventListener('input', (e) => {
  if (e.target.closest('.erp-header-form, .erp-table')) window.__unsavedChanges = true;
});
window.addEventListener('pageshow', () => { window.__unsavedChanges = false; });
window.addEventListener('load', () => { captureHeaderInitValues(); });

const cancelChangesBtn = document.getElementById('btnCancelChanges');
if (cancelChangesBtn) {
  cancelChangesBtn.addEventListener('click', () => {
    if (window.__unsavedChanges) {
      if (!confirm('å–æ¶ˆæœªå„²å­˜çš„è®Šæ›´ä¸¦é‚„åŸè³‡æ–™ï¼Ÿ')) return;
    }
    resetHeaderForm();
    resetDetailTable();
    window.__unsavedChanges = false;
  });
}
</script>


<style>
/* =========================================
   A) å…¨å±€/ç‰ˆé¢
   ========================================= */
body { background: #f7f9fb !important; }
.erp-detail-container { min-height: 100vh; padding: 12px 0; margin-left: 3vw; margin-right: 3vw; }

/* =========================================
   B) Header è¡¨å–® & Tabs
   ========================================= */
.erp-header-form,
.erp-header-form select,
.erp-header-form textarea,
.erp-header-form input { font-size: var(--field-value-size); }

.erp-header-form,
.erp-table-wrapper{
  padding-left: var(--detail-left-pad);
  max-width: var(--detail-max-width);
  width: 100%;
  box-sizing: border-box;
}

.erp-header-form .row{
  margin-left: 0;
  margin-right: 0;
  --bs-gutter-x: 0;
}

.erp-header-form select.form-select{
  font-size: 1em !important; height: 32px !important; min-height: 32px !important; line-height: 1.15 !important;
  padding: 2px 30px 2px 6px !important; appearance: none; -webkit-appearance: none; -moz-appearance: none;
  background-image: url('data:image/svg+xml;utf8,<svg width="11" height="11" fill="gray" xmlns="http://www.w3.org/2000/svg"><path d="M2 4.5l3.5 3.5L9 4.5" stroke="gray" stroke-width="2" fill="none" stroke-linecap="round"/></svg>');
  background-repeat: no-repeat; background-position: right 10px center; background-size: 14px 14px; box-shadow: none !important; border-radius: 5px !important;
}
.header-fields-tab{
  position: relative; min-height: 120px; padding-bottom: 8px;
  width: 100%;
  box-sizing: border-box;
  background: #eef2f9 !important; box-shadow: 0 2px 6px rgba(0,0,0,0.04);
}
.drop-hover{ background-color:#cce5ff !important; border-radius:4px; }

.erp-header-form .nav-tabs .nav-link{ border-radius:8px 8px 0 0 !important; padding:var(--tab-pad-y) var(--tab-pad-x); font-size:var(--field-label-size); font-weight:500; color:#235eb8; }
.erp-header-form .nav-tabs .nav-link.active{
  background:#fff; color:#124d8b; border-color:#bdd2f7 #bdd2f7 #fff #bdd2f7 !important; box-shadow:0 2px 6px 0 #e4ecf7; font-weight:bold;
}

.top-toolbar{
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.top-toolbar .toolbar-icon-row{
  display: flex;
  gap: 6px;
  align-items: center;
}
.top-toolbar .toolbar-main{
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.top-toolbar .toolbar-btn{
  font-size: var(--top-toolbar-font-size);
  height: var(--top-toolbar-btn-height);
  min-height: var(--top-toolbar-btn-height);
  padding: 0 12px;
  line-height: 1;
}
.top-toolbar .toolbar-btn-icon{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: var(--top-toolbar-btn-height);
  min-height: var(--top-toolbar-btn-height);
  padding: 0;
  width: 30px;
  border-radius: 8px;
  font-size: var(--top-toolbar-icon-font-size);
  line-height: 1;
}
.top-toolbar .toolbar-btn-icon .toolbar-icon{
  display: inline-block;
}
.top-toolbar #btnPrev .toolbar-icon,
.top-toolbar #btnNext .toolbar-icon,
.top-toolbar #btnSubDetailDelete .toolbar-icon{
  transform: translateY(-3px);
}
.top-toolbar .toolbar-btn:disabled{
  background: #9aa7bb;
  cursor: not-allowed;
  box-shadow: none;
  opacity: 0.7;
}
.top-toolbar .toolbar-btn-add{
  background: #0e9f4b;
}
.top-toolbar .toolbar-btn-del{
  background: #e04848;
}
.top-toolbar .toolbar-btn-cancel{
  background: #e04848;
}
.top-toolbar .toolbar-btn-check,
.top-toolbar .toolbar-btn-cancel{
  font-size: 18px;
}

/* draggable æ¬„ä½ï¼ˆæ©«æ’ label + æ§ä»¶ï¼‰ */
.draggable-field{ position:absolute; display:flex; flex-direction:column; box-sizing:border-box; overflow:hidden; background:transparent; border:1px dashed transparent; }
.draggable-field:hover{ border-color:#c7d3e1; }
.draggable-field.inline{ display:flex; flex-direction:row; align-items: center; gap:4px; flex:0 0 auto; min-width:100px; max-width:100%; }
.header-label-item{ position:absolute; display:flex; align-items:center; justify-content:flex-end; text-align:right; font-size:var(--field-label-size); line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding:0 4px 0 2px; z-index:2; }
.field-drag-handle{ position:absolute; left:0; top:0; width:10px; height:100%; cursor:default; background:transparent; z-index:3; }
.draggable-field.inline .field-control{ flex:1 1 auto; height:100%; display:flex; }
.draggable-field.inline textarea,
.draggable-field.inline input,
.draggable-field.inline .form-select{
  flex:1 1 auto; width:100%; height:100%; min-height:32px; line-height:1.2; resize:none; padding:4px 6px; font-size:0.95em;
  text-align: left;
}
.draggable-field.inline label{
  white-space: nowrap !important;
  overflow: visible !important;
  text-overflow: clip !important;
  max-width: none !important;
}
.draggable-field.md-selected{
  border-radius: 8px;
  border-color:#5b8def;
  background:rgba(91,141,239,0.08);
}
.erp-header-form select.lookup-dropdown.lookup-readonly{
  /* ç€è¦½æ¨¡å¼å…è¨±å±•é–‹ä¸‹æ‹‰ï¼Œä½†ä¸å…è¨±ä¿®æ”¹ï¼šå¤–è§€æ¯”ç…§ disabled çš„ç°åº• */
  background-color: var(--bs-secondary-bg, #e9ecef) !important;
  color: var(--bs-secondary-color, #6c757d) !important;
  opacity: 1; /* é¿å…åƒ disabled ä¸€æ¨£æ•´é«”è®Šæ·¡ */
  cursor: default;
}
.erp-header-form select.lookup-dropdown.lookup-readonly:focus{
  border-color: #ced4da;
  box-shadow: none !important;
}
/* jQuery UI resizableï¼šè®“å³å´æ‹‰å¯¬æŠŠæ‰‹æ›´å¥½æŠ“ */
.draggable-field.ui-resizable .ui-resizable-e{
  position: absolute;
  top: 0; right: 0; width: 10px; height: 100%;
  cursor: ew-resize; background: transparent;
  z-index: 5;
}
.draggable-field.ui-resizable:hover .ui-resizable-e{
  background: rgba(32,86,172,0.10);
}
.draggable-field.ui-resizable .ui-resizable-se{
  position: absolute;
  right: 0; bottom: 0; width: 14px; height: 14px;
  cursor: se-resize; background: transparent;
  z-index: 5;
}
.field-drag-handle,
.draggable-field.ui-resizable .ui-resizable-e,
.draggable-field.ui-resizable .ui-resizable-se{
  display: none;
}
.layout-edit-enabled .field-drag-handle,
.layout-edit-enabled .draggable-field.ui-resizable .ui-resizable-e,
.layout-edit-enabled .draggable-field.ui-resizable .ui-resizable-se{
  display: block;
}
.layout-edit-enabled .field-drag-handle{
  cursor: move;
}

/* =========================================
   C) æ˜ç´°è¡¨æ ¼ï¼ˆè¦–è¦º & ç·¨è¼¯ï¼‰
   ========================================= */
.erp-table-wrapper{
  background:#fff; box-shadow:0 4px 18px 0 #c3d4e6; max-width:1400px; overflow-x:auto;
  padding:8px !important; border-radius:0 0 13px 13px; border:1px solid #d6dbe5;
}
.erp-table{ width:100%; border-collapse:separate; border-spacing:0; font-size:1.06em; background:#fff; }
.erp-table thead tr{ background:#e7ecf3; }
.erp-table th, .erp-table td{
  box-sizing: border-box;
  background:#f1f5fb; padding:6px 8px; border-bottom:1px solid #c5d1e4; white-space:nowrap; text-align:center;
  font-weight:500; border-right:1px solid #dde4ed; height:34px;
}
.erp-table th:last-child, .erp-table td:last-child{ border-right:none; }
.erp-table th{ color:#124d8b; font-weight:700; font-size:.92em; letter-spacing:.5px; background:#e7ecf3; }
.erp-table tbody tr:nth-child(even){ background:#f6f9fd; }
.erp-table tbody tr:hover{ background:#eef7ff; }

/* é¡¯ç¤º/ç·¨è¼¯é›™å±¤ï¼šspan é¡¯ç¤ºã€input ç·¨è¼¯ï¼ˆåˆ‡æ› displayï¼‰ */
.erp-table th{ font-size: var(--field-label-size); }
.erp-table td{ position:relative; padding:0; font-size: var(--field-value-size); }
.erp-table td .cell-view{ display:inline-block; width:100%; text-align:inherit; }
.erp-table td .cell-edit{
  width:100% !important; height:100% !important; box-sizing:border-box; margin:0; border:none; border-radius:0;
  background:#fff !important; font-size:inherit !important; font-weight:inherit !important; font-family:inherit !important;
  line-height:inherit !important; text-align:inherit !important; padding:0 4px;
}

/* æ•´åˆ—é¸å–é«˜äº®ï¼†å·¦å´è—æ¢ */
.erp-table tbody tr.row-selected > td{ background:#fff8c6 !important; }
.erp-table tbody tr.row-selected > td:first-child{ position:relative; }
.erp-table tbody tr.row-selected > td:first-child::after{
  content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background:#0d6efd; border-radius:2px;
}
/* ç§»é™¤é è¨­ focus è—æ¡† */
.erp-table td:focus, .erp-table td *:focus{ outline:none !important; box-shadow:none !important; }

/* =========================================
   D) å…¶å®ƒ
   ========================================= */
.highlight-red { color:#e53b2d; font-weight:700; }
.highlight-blue{ color:#2564b3; font-weight:700; }

/* --- Action Rail åŸºç¤ç‰ˆä½ & å…§å®¹å³ç§»ï¼ˆå›ºå®šåœ¨æ¨£æ¿ï¼‰--- */
:root{
  --fab-left: 12px;
  --fab-width: 120px;
  --fab-gap: 14px;
  --rail-reserve: calc(var(--fab-left) + var(--fab-width) + var(--fab-gap));
}

.action-rail{
  position: fixed;
  left: var(--fab-left);
  top: 80px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 900;
  overflow-y: auto;
  overflow-x: visible;
}

body.with-toolbar .action-rail{
  top: calc(80px + var(--app-toolbar-height, 0px));
}

/* å…§å®¹å¾€å³é¨°å‡ºç©ºé–“ï¼›toolbar å¾€å›è£œï¼Œç¶­æŒè¦–è¦ºå°é½Š */
.erp-detail-container{ margin-left: var(--rail-reserve); }
#topToolbar{ margin-left: calc(-1 * var(--rail-reserve)) !important; }

/* æŒ‰éˆ•çš„å…±åŒå¤–è§€ï¼ˆä¿æŒåœ¨æ¨£æ¿ï¼Œè®“æ‰€æœ‰é é¢ä¸€è‡´ï¼‰ */
.fab{
  position: relative;
  width: var(--fab-width);
  min-width: 0;
  padding: 6px 8px;
  font-size: .92rem;
  letter-spacing: 0;
  white-space: normal;
  word-break: break-word;
  background:#ffc107;
  color:#090101;
  font-weight:700;
  border-radius:10px;
  cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.2);
  border:0;
}
.fab:hover{ filter:brightness(0.95); }
.fab-red{ background:#dc3545; color:#fff; }
.fab-blue{ background:#3583dc; color:#fff; }
.erp-detail-container{ margin-left: var(--rail-reserve); margin-right: 3vw; padding: 12px 0; }
#btnCalcAmount { border: 0 !important; outline: none !important; -webkit-tap-highlight-color: transparent; }
#btnCalcAmount:focus, #btnCalcAmount:focus-visible, #btnCalcAmount:active { outline: none !important; box-shadow: 0 6px 16px rgba(0,0,0,.2) !important; }
#btnCalcAmount::-moz-focus-inner { border: 0 !important; }
#topToolbar{ margin-left: calc(-1 * var(--rail-reserve)) !important; padding-left: 0 !important; justify-content: flex-start !important; }
#topToolbar > .ms-2, #topToolbar .btn-toolbar{ margin-left: 0 !important; }

/* è®“è¡¨æ ¼ç”¨å›ºå®šå¸ƒå±€ï¼Œæ¬„å¯¬æ‰æœƒç…§ px ç”Ÿæ•ˆ + æ‹–æ›³æŠŠæ‰‹ */
.erp-table { table-layout: fixed; }
.erp-table th { position: relative; }
.erp-table th .col-resizer{ position: absolute; top: 0; right: 0; bottom: 0; width: 8px; cursor: col-resize; user-select: none; z-index: 2; }
.erp-table th .col-resizer::before { content: none !important; }
.erp-table th.resizing, .erp-table td.resizing, body.resizing { cursor: col-resize !important; }
</style>
.erp-header-form { margin-bottom: 0; }
