@model TableToolbarModel
<div class="btn-toolbar" style="gap:6px;">
    <div id="toolbarCountBox" class="toolbar-count-box mode-view" aria-live="polite">
        <div id="toolbarHeaderCount" class="count-line">--/--</div>
        <div id="toolbarDetailCount" class="count-line">--</div>
    </div>
    <button id="@Model.SearchBtnId" class="btn toolbar-btn" type="button"><i class="bi bi-search"></i>@Model.SearchText</button>
    <button id="btnSwitch" class="btn toolbar-btn secondary" type="button"><i class="bi bi-arrow-left-right"></i>切換</button>
    <button id="@Model.AddBtnId" class="btn toolbar-btn" type="button"><i class="bi bi-plus-lg"></i>@Model.AddText</button>
    <button id="btnViewEditToggle" class="btn toolbar-btn" type="button"><i class="bi bi-pencil-square"></i>修改</button>
    <button id="btnConfirm" class="btn toolbar-btn success-outline" type="button" ><i class="bi bi-check2-circle"></i>確認</button>
    <button id="btnCancel" class="btn toolbar-btn danger" type="button"><i class="bi bi-x-circle"></i>退審</button>
    <button id="@Model.DeleteBtnId" class="btn toolbar-btn danger" type="button"><i class="bi bi-trash3"></i>@Model.DeleteText</button>
    <span class="print-panel-wrap">
        <button id="btnPrint" class="btn toolbar-btn secondary" type="button"><i class="bi bi-printer"></i>列印</button>
        <div id="printPanel" class="print-panel d-none"></div>
    </span>
    <button id="btnPaperTrace" class="btn toolbar-btn secondary" type="button"><i class="bi bi-pin-map"></i>追蹤</button>
    <button id="btnPaperLog" class="btn toolbar-btn secondary" type="button"><i class="bi bi-clock-history"></i>紀錄</button>
</div>
<!-- 查詢條件彈窗 -->

@if (Model.QueryFields != null) {
    <div class="modal fade" id="@(Model.ModalId ?? "searchModal")">
        <div class="modal-dialog modal-lg">
            @await Html.PartialAsync("_QueryPanelPartial", Model.QueryFields)
        </div>
    </div>
}

@if (ViewData["QueryFieldModalsRendered"] == null)
{
    ViewData["QueryFieldModalsRendered"] = true;
    <div class="modal fade" id="queryFieldSelectModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content query-field-select-modal">
                <div class="modal-header">
                    <h5 class="modal-title">設定查詢項目</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="qf-top-row">
                        <div class="qf-config">
                            <label class="qf-config-label">比對條件</label>
                            <select id="qfEqual" class="form-select form-select-sm qf-config-select"></select>
                        </div>
                        <div class="qf-order">
                            <button id="qfUp" class="btn btn-outline-secondary btn-sm" type="button">上移</button>
                            <button id="qfDown" class="btn btn-outline-secondary btn-sm" type="button">下移</button>
                        </div>
                    </div>
                    <div class="qf-main-row">
                        <div class="qf-panel">
                            <div class="qf-title">可用欄位</div>
                            <div class="qf-table-wrap">
                                <table class="qf-table">
                                    <thead>
                                        <tr><th class="qf-col-field">欄位名稱</th><th class="qf-col-table">表格名稱</th></tr>
                                    </thead>
                                </table>
                                <div id="qfAllFields" class="qf-list" tabindex="0"></div>
                            </div>
                        </div>
                        <div class="qf-actions">
                            <button id="qfAdd" class="btn btn-outline-primary qf-action-btn" type="button">▶</button>
                            <button id="qfAddAll" class="btn btn-outline-primary qf-action-btn" type="button">▶▶</button>
                            <button id="qfRemove" class="btn btn-outline-secondary qf-action-btn" type="button">◀</button>
                            <button id="qfRemoveAll" class="btn btn-outline-secondary qf-action-btn" type="button">◀◀</button>
                        </div>
                        <div class="qf-panel">
                            <div class="qf-title">已選欄位</div>
                            <div class="qf-table-wrap">
                                <table class="qf-table">
                                    <thead>
                                        <tr><th class="qf-col-field">欄位名稱</th><th class="qf-col-table">表格名稱</th></tr>
                                    </thead>
                                </table>
                                <div id="qfSelectedFields" class="qf-list" tabindex="0"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="qfSave" class="btn btn-success">確定</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="queryDefaultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content query-default-modal">
                <div class="modal-header">
                    <h5 class="modal-title">預設設定</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>欄位</th>
                                    <th>條件</th>
                                    <th>預設值</th>
                                </tr>
                            </thead>
                            <tbody id="qfDefaultBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="qfDefaultSave" class="btn btn-success">確定</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>
}

<script>
    const _reportSpName = "@(Model.ReportSpName)";
    // 原本：const fetcher = window.http || window.busyFetch || fetch.bind(window);
    const fetcher = (input, init, msg) => {
        if (typeof window.http === "function") return window.http(input, init);
        if (typeof window.busyFetch === "function") return window.busyFetch(input, init, msg);
        return fetch(input, init);
    };

    const printPanelStyle = document.createElement('style');
    printPanelStyle.textContent = `
.print-panel-wrap { position: relative; display: inline-block; }
.print-panel {
  position: absolute;
  top: calc(100% + 8px);
  left: 0;
  display: inline-block;
  width: max-content;
  min-width: 10rem;
  max-width: 360px;
  padding: .5rem 0;
  background: #fff;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: .5rem;
  box-shadow: 0 .5rem 1rem rgba(0,0,0,.175);
  z-index: 1000;
}
.print-panel.d-none { display: none; }
.print-panel-empty { color: #6b7280; padding: .35rem 1rem; }
.print-acc { display: block; max-height: 240px; overflow: auto; }
.print-acc-item { border: 0; background: transparent; }
.print-acc-item[open] { background: transparent; box-shadow: none; }
.print-acc-item summary {
  cursor: pointer;
  padding: .35rem 1rem;
  font-weight: 500;
  color: #212529;
  display: block;
  border-radius: 0;
}
.print-acc-item summary:hover { background: #2d5fa8; color: #fff; }
.print-acc-item summary:active { background: #264f8f; color: #fff; }
.print-acc-item[open] > summary { background: #28579a; color: #fff; }
.print-acc-item summary::-webkit-details-marker { display: none; }
.print-acc-item summary::marker { content: ""; }
.print-acc-item summary::-moz-list-bullet { font-size: 0; }
.print-acc-summary::after {
  content: '';
}
`;
    document.head.appendChild(printPanelStyle);


    document.addEventListener("DOMContentLoaded", function () {
        const btn = document.getElementById('btnViewEditToggle');

        // 先宣告：要封鎖的狀態
        const BLOCK_STATUSES = ['已確認', '已結案', '已作廢'];

        // 先宣告：讀單據狀態（找 label=單據狀態 的那個 li）
        function getHeaderValueByLabel(labelText) {
            const $label = $('.header-label-item').filter(function () {
            return $(this).text().trim() === labelText;
            }).first();
            if (!$label.length) return null;
            const fieldName = $label.data('field');
            if (!fieldName) return null;
            const $li = $(`.draggable-field[data-field="${fieldName}"]`).first();
            if (!$li.length) return null;

            const $ctrl = $li.find('select, input, textarea').first();
            if (!$ctrl.length) return null;

            if ($ctrl.is('select')) return $ctrl.find('option:selected').text().trim();
            return ($ctrl.val() || '').toString().trim();
        }

        let isEdit = false; // 預設瀏覽

        // 頁面載入時預設全部 disabled（lookup 欄位交給 _DetailHeaderSection 控制）
        document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select').forEach(el => {
            if (el.classList.contains('lookup-dropdown')) return;
            el.disabled = true;
        });

        // 執行 Inherited
        const executeInherited = async (hookName, context) => {
            const itemId = window._itemId || window._singleItemId || '';
            if (!itemId) return { ok: true };

            const hooks = window.InheritedActionHooks || {};
            const hookFn = hooks[itemId]?.[hookName] || hooks[hookName];

            if (typeof hookFn === 'function') {
                try {
                    const result = await hookFn(context);
                    if (result === false) {
                        return { ok: false, reason: 'hook-canceled' };
                    }
                    return { ok: true, data: result };
                } catch (err) {
                    console.error(`[Inherited] ${hookName} 執行失敗:`, err);
                    return { ok: false, reason: 'hook-error', error: err };
                }
            }

            return { ok: true };
        };

        const btnConfirm = document.getElementById('btnConfirm');
        if (btnConfirm) {
            const buildConfirmPayload = (tableName, paperNum, userId, extra) => ({
                paperId: tableName,
                paperNum: paperNum,
                userId: userId,
                eoc: 1,
                aftFinished: 1,
                itemId: window._itemId || window._singleItemId || '',
                useId: window._useId || 'A001',
                globalId: window._globalId || '',
                ...extra
            });

            const runConfirm = async (tableName, paperNum, userId, extra = {}) => {
                const resp = await fetcher('/api/PaperAction/DoAction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(buildConfirmPayload(tableName, paperNum, userId, extra))
                }, '確認中…');

                if (!resp.ok) {
                    let msg = '確認失敗';
                    try {
                        const err = await resp.json();
                        msg = err.message || err.Message || msg;
                    } catch {
                        try { msg = await resp.text() || msg; } catch {}
                    }
                    Swal.fire({ icon: 'error', title: msg });
                    return;
                }

                const data = await resp.json().catch(() => ({}));
                if (data?.needConfirm) {
                    const confirm = await Swal.fire({
                        title: data.confirmMessage || '是否要繼續？',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: '確定',
                        cancelButtonText: '取消'
                    });

                    if (!confirm.isConfirmed) {
                        if (data.confirmType === 'autoExam') {
                            await runConfirm(tableName, paperNum, userId, { ...extra, autoExam: false });
                        }
                        return;
                    }

                    const next = { ...extra };
                    if (data.confirmType === 'paperMsg') next.acceptPaperMsg = true;
                    if (data.confirmType === 'beforeSql') next.acceptBeforeSql = true;
                    if (data.confirmType === 'autoExam') next.autoExam = true;
                    await runConfirm(tableName, paperNum, userId, next);
                    return;
                }

                // Hook: afterConfirm
                await executeInherited('afterConfirm', { tableName, paperNum, userId, result: data });

                if (data.transferPrompt) {
                    const ask = await Swal.fire({
                        title: data.transferMessage || '是否要檢視拋轉的單據？',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: '是',
                        cancelButtonText: '否'
                    });
                    if (ask.isConfirmed) {
                        document.getElementById('btnPrint')?.click();
                    }
                }

                location.reload();
            };

            btnConfirm.addEventListener('click', async function () {
                const tableName = window._headerRealTableName || window._headerTableName || window._tableName;
                const paperNum = window.selectedPaperNum;
                const userId = window._userId || localStorage.getItem('erpLoginUserId') || 'admin';

                if (!tableName) {
                    Swal.fire({ icon: 'warning', title: '尚未設定送審 Table', text: '請檢查頁面是否正確設定 HeaderTableName' });
                    return;
                }

                if (!paperNum) {
                    Swal.fire({ icon: 'warning', title: '查無單號！' });
                    return;
                }

                if (typeof window.saveHeaderForm === 'function') {
                    const saved = await window.saveHeaderForm();
                    if (!saved || saved.ok === false) return;
                }

                const result = await Swal.fire({
                    title: '確定要執行確認？',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: '確定',
                    cancelButtonText: '取消'
                });
                if (!result.isConfirmed) return;

                // Hook: beforeConfirm
                const beforeHook = await executeInherited('beforeConfirm', { tableName, paperNum, userId });
                if (!beforeHook.ok) {
                    if (beforeHook.reason === 'hook-canceled') return;
                    if (beforeHook.reason === 'hook-error') {
                        Swal.fire({ icon: 'error', title: 'Hook 執行失敗', text: beforeHook.error?.message || String(beforeHook.error) });
                        return;
                    }
                }

                await runConfirm(tableName, paperNum, userId);
            });
        }


        const btnCancel = document.getElementById('btnCancel');
        if (btnCancel) {
            btnCancel.addEventListener('click', async function () {
                // 自動抓取正確的 tableName (從 HeaderTableName)
                const tableName = window._headerRealTableName || window._headerTableName || window._tableName;
                const paperNum = window.selectedPaperNum;
                const userId = window._userId || localStorage.getItem('erpLoginUserId') || 'admin';

                if (!tableName) {
                    Swal.fire({ icon: 'warning', title: '尚未設定送審 Table', text: '請檢查頁面是否正確設定 HeaderTableName' });
                    return;
                }

                if (!paperNum) {
                    Swal.fire({ icon: 'warning', title: '查無單號！' });
                    return;
                }

                const result = await Swal.fire({
                    title: '確定要執行退審？',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: '確定',
                    cancelButtonText: '取消'
                });
                if (!result.isConfirmed) return;

                // 建立共用的 context 物件，讓 beforeCancel 和 afterCancel 可以共享資料
                const hookContext = { tableName, paperNum, userId };

                // Hook: beforeCancel
                const beforeHook = await executeInherited('beforeCancel', hookContext);
                if (!beforeHook.ok) {
                    if (beforeHook.reason === 'hook-canceled') return;
                    if (beforeHook.reason === 'hook-error') {
                        Swal.fire({ icon: 'error', title: 'Hook 執行失敗', text: beforeHook.error?.message || String(beforeHook.error) });
                        return;
                    }
                }

                if (typeof window.saveHeaderForm === 'function') {
                    const saved = await window.saveHeaderForm();
                    if (!saved || saved.ok === false) return;
                }

                const runReject = async (extra = {}) => {
                    try {
                        const resp = await fetcher('/api/PaperAction/DoAction', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                paperId: tableName,
                                paperNum: paperNum,
                                userId: userId,
                                eoc: 0,
                                aftFinished: 3, // 退審時 AftFinished 設為 3 (審核中)
                                itemId: window._itemId || window._singleItemId || '',
                                useId: window._useId || 'A001',
                                ...extra
                            })
                        }, '退審中…');

                        if (!resp.ok) {
                            let msg = '退審失敗';
                            try {
                                const err = await resp.json();
                                msg = err.message || err.Message || msg;
                            } catch {
                                try { msg = await resp.text() || msg; } catch {}
                            }
                            Swal.fire({ icon: 'error', title: msg });
                            return;
                        }

                        const data = await resp.json().catch(() => ({}));
                        // 注意：API 回傳的欄位名稱是 PascalCase (NeedConfirm, ConfirmType 等)
                        const needConfirm = data?.NeedConfirm || data?.needConfirm;
                        const confirmType = data?.ConfirmType || data?.confirmType;
                        const confirmMessage = data?.ConfirmMessage || data?.confirmMessage;

                        if (needConfirm) {
                            if (confirmType === 'rejExamNotes') {
                                const noteResp = await Swal.fire({
                                    icon: 'question',
                                    title: '確認退審',
                                    input: 'textarea',
                                    inputPlaceholder: '請輸入退審原因',
                                    showCancelButton: true,
                                    confirmButtonText: '確定退審',
                                    cancelButtonText: '取消',
                                    inputValidator: (value) => {
                                        if (!value || !value.trim()) return '請輸入退審原因';
                                    }
                                });
                                if (!noteResp.isConfirmed) return;
                                await runReject({ rejectNotes: noteResp.value || '' });
                                return;
                            }

                            const confirm = await Swal.fire({
                                title: confirmMessage || '確定要退審？',
                                icon: 'question',
                                showCancelButton: true,
                                confirmButtonText: '確定退審',
                                cancelButtonText: '取消'
                            });
                            if (!confirm.isConfirmed) return;
                            await runReject({ acceptRejMsg: true });
                            return;
                        }

                        // Hook: afterCancel - 使用同一個 hookContext，包含 beforeCancel 設定的資料
                        hookContext.result = data;
                        await executeInherited('afterCancel', hookContext);

                        location.reload();
                    } catch (err) {
                        console.error('[退審] runReject 發生錯誤:', err);
                        Swal.fire({ icon: 'error', title: '退審錯誤', text: err.message });
                    }
                };

                await runReject();
            });
        }

        const btnPrint = document.getElementById('btnPrint');
        const printPanel = document.getElementById('printPanel');
        let printOptionsCache = null;

        const buildPrintPayload = (opt, paperNum) => ({
            spName: opt?.SpName || _reportSpName,
            reportName: opt?.ReportName || _reportSpName,
            params: { PaperNum: paperNum }
        });

        const renderPrintPanel = (options) => {
            if (!printPanel) return;
            if (!options || options.length === 0) {
                printPanel.innerHTML = '<div class="print-panel-empty">沒有可用的列印設定</div>';
                return;
            }
            const acc = options.map((o, i) => {
                const label = o.ItemName || o.ReportName || o.SpName;
                return `
<details class="print-acc-item">
  <summary class="print-acc-summary" data-print-idx="${i}">${label}</summary>
</details>`;
            }).join('');
            printPanel.innerHTML = `<div class="print-acc">${acc}</div>`;
        };

        const fetchPrintOptions = async () => {
            const paperId = window._headerTableName || window._tableName || "";
            if (!paperId) return [];
            try {
                const optResp = await fetch(`/api/report/paper-options?paperId=${encodeURIComponent(paperId)}`);
                if (!optResp.ok) return [];
                const optData = await optResp.json();
                return (optData?.ok && Array.isArray(optData.list)) ? optData.list : [];
            } catch {
                return [];
            }
        };

        const togglePrintPanel = async () => {
            if (!printPanel) return;
            if (!printPanel.classList.contains('d-none')) {
                printPanel.classList.add('d-none');
                return;
            }
            if (printOptionsCache === null) {
                printOptionsCache = await fetchPrintOptions();
            }
            renderPrintPanel(printOptionsCache);
            printPanel.classList.remove('d-none');
        };

        if (btnPrint) {
            btnPrint.addEventListener('click', async () => {
                const paperNum = window.selectedPaperNum || document.querySelector('[name="PaperNum"]')?.value;
                if (!paperNum) { Swal.fire({ icon:'warning', title:'查無單號！' }); return; }

                if (printOptionsCache === null) {
                    printOptionsCache = await fetchPrintOptions();
                }

                // 若沒有任何設定，沿用舊的直接列印
                if (!printOptionsCache || printOptionsCache.length === 0) {
                    if (!_reportSpName) {
                        Swal.fire({ icon:'warning', title:'沒有可用的列印設定' });
                        return;
                    }
                    const payload = buildPrintPayload(null, paperNum);
                    const res = await fetch('/api/report/generate-url', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) {
                        Swal.fire({ icon:'error', title:'報表產生失敗', text: await res.text() });
                        return;
                    }
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    Swal.fire({
                        html: `<iframe src="${url}" width="100%" height="600px" frameborder="0"></iframe>`,
                        width: '80%', heightAuto: false, showCloseButton: true, showConfirmButton: false,
                        willClose: () => URL.revokeObjectURL(url)
                    });
                    return;
                }

                await togglePrintPanel();
            });
        }

        if (printPanel) {
            document.addEventListener('click', (e) => {
                if (printPanel.classList.contains('d-none')) return;
                if (btnPrint && (btnPrint.contains(e.target) || printPanel.contains(e.target))) return;
                printPanel.classList.add('d-none');
            });

            printPanel.addEventListener('click', async (e) => {
                const summary = e.target.closest('.print-acc-summary');
                if (!summary) return;
                e.preventDefault();
                const idx = parseInt(summary.dataset.printIdx, 10);
                if (Number.isNaN(idx)) return;
                const paperNum = window.selectedPaperNum || document.querySelector('[name="PaperNum"]')?.value;
                if (!paperNum) { Swal.fire({ icon:'warning', title:'查無單號！' }); return; }
                const selected = (printOptionsCache && printOptionsCache[idx]) ? printOptionsCache[idx] : null;
                const payload = buildPrintPayload(selected, paperNum);

                const res = await fetch('/api/report/generate-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    Swal.fire({ icon:'error', title:'報表產生失敗', text: await res.text() });
                    return;
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                Swal.fire({
                    html: `<iframe src="${url}" width="100%" height="600px" frameborder="0"></iframe>`,
                    width: '80%', heightAuto: false, showCloseButton: true, showConfirmButton: false,
                    willClose: () => URL.revokeObjectURL(url)
                });
                printPanel.classList.add('d-none');
            });
        }

        const btnSwitch = document.getElementById("btnSwitch");
        if (btnSwitch) {
            btnSwitch.addEventListener("click", function () {
                // 這裡直接取選中的單號（優先用選取列，避免使用到過期的全域值）
                let id = (window.getSelectedId && window.getSelectedId()) || window.selectedPaperNum;
                if (!id) {
                    const row = document.querySelector('#dataTbody tr.selected');
                    id = row?.getAttribute('data-paper-num') || id;
                }

                if (!id) {
                    Swal.fire({ icon: 'warning', title: '請先選擇一筆單據' });
                    return;
                }

                // 這個 template 從 Razor 傳進來，已經有 "/SpodOrderSubs/{PaperNum}" 之類的
                const tpl = window._detailRouteTemplate; 
                if (!tpl) {
                    Swal.fire({ icon: 'error', title: '未設定切換路徑' });
                    return;
                }

                const url = tpl.replace("{PaperNum}", id);
                window.location.href = url;
            });
        }

        if (!window.__queryFieldModalInit) {
        window.__queryFieldModalInit = true;
        const qfModalEl = document.getElementById("queryFieldSelectModal");
        const qfDefaultModalEl = document.getElementById("queryDefaultModal");
        const qfAllEl = document.getElementById("qfAllFields");
        const qfSelectedEl = document.getElementById("qfSelectedFields");
        const qfDefaultBody = document.getElementById("qfDefaultBody");
        const btnQfSelect = document.getElementById("btnQueryFieldSelect");
        const btnQfDefault = document.getElementById("btnQueryDefault");
        const btnQfSave = document.getElementById("qfSave");
        const btnQfDefaultSave = document.getElementById("qfDefaultSave");

        let qfCache = null;
        let qfEquals = null;
        let reopenSearchOnClose = false;
        let pendingOpen = null;

        const searchModalEl = document.getElementById("searchModal");
        if (qfModalEl && qfModalEl.parentElement !== document.body) document.body.appendChild(qfModalEl);
        if (qfDefaultModalEl && qfDefaultModalEl.parentElement !== document.body) document.body.appendChild(qfDefaultModalEl);

        const getItemId = () => (window._itemId || window._singleItemId || "").toString().trim();
        const getDictTable = () => (window._dictTableName || window._tableName || "").toString().trim();

        const fetchEquals = async () => {
            if (qfEquals) return qfEquals;
            try {
                const res = await fetcher("/api/DictSetupApi/QueryEquals?all=1", null, "載入比對條件…");
                if (!res.ok) throw new Error(await res.text());
                const list = await res.json();
                qfEquals = Array.isArray(list) ? list : [];
            } catch {
                qfEquals = [
                    { value: "=", text: "=" },
                    { value: ">=", text: ">=" },
                    { value: "<=", text: "<=" },
                    { value: "like", text: "like" }
                ];
            }
            return qfEquals;
        };

        const loadPaperSelected = async (equalValue = null) => {
            if (qfCache && equalValue == null) return qfCache;
            const itemId = getItemId();
            const table = getDictTable();
            if (!itemId || !table) return null;
            const eq = equalValue != null ? `&equal=${encodeURIComponent(equalValue)}` : "";
            const res = await fetcher(`/api/DictSetupApi/PaperSelectedList?itemId=${encodeURIComponent(itemId)}&table=${encodeURIComponent(table)}${eq}`, null, "載入查詢項目…");
            if (!res.ok) return null;
            const data = await res.json();
            if (equalValue == null) qfCache = data || null;
            return data || null;
        };

        const buildItem = (item, fieldName, tableName) => {
            const div = document.createElement("div");
            div.className = "qf-item";
            div.dataset.value = item.columnName || item.ColumnName || "";
            div.dataset.columnName = item.columnName || item.ColumnName || "";
            div.dataset.columnCaption = item.columnCaption || item.ColumnCaption || "";
            div.dataset.tableName = item.tableName || item.TableName || "";
            div.dataset.aliasName = item.aliasName || item.AliasName || "";
            div.dataset.dataType = item.dataType ?? item.DataType ?? "";
            div.dataset.defaultEqual = item.defaultEqual || item.DefaultEqual || "";
            div.dataset.defaultValue = item.defaultValue || item.DefaultValue || "";
            div.dataset.controlType = item.controlType ?? item.ControlType ?? "";
            div.dataset.commandText = item.commandText || item.CommandText || "";
            div.dataset.defaultType = item.defaultType ?? item.DefaultType ?? "";
            div.dataset.editMask = item.editMask || item.EditMask || "";
            div.dataset.superId = item.superId || item.SuperId || "";
            div.dataset.paramValue = item.paramValue || item.ParamValue || "";
            div.dataset.paramType = item.paramType ?? item.ParamType ?? "";
            div.dataset.iReadOnly = item.iReadOnly ?? item.IReadOnly ?? "";
            div.dataset.iVisible = item.iVisible ?? item.IVisible ?? "";
            div.dataset.tableKind = item.tableKind || item.TableKind || "";

            const fieldSpan = document.createElement("span");
            fieldSpan.className = "qf-item-field";
            fieldSpan.textContent = fieldName;

            const tableSpan = document.createElement("span");
            tableSpan.className = "qf-item-table";
            tableSpan.textContent = tableName;

            div.appendChild(fieldSpan);
            div.appendChild(tableSpan);

            div.addEventListener("click", (e) => {
                if (!e.ctrlKey && !e.shiftKey) {
                    div.parentElement.querySelectorAll(".qf-item.selected").forEach(el => el.classList.remove("selected"));
                }
                div.classList.toggle("selected");
            });

            return div;
        };

        const renderFieldSelect = async () => {
            if (!qfAllEl || !qfSelectedEl) return;
            qfAllEl.innerHTML = "";
            qfSelectedEl.innerHTML = "";

            const currentEqual = document.getElementById("qfEqual")?.value || "";
            const data = await loadPaperSelected(currentEqual || null);
            if (!data) return;

            const selected = Array.isArray(data.selected) ? data.selected : [];
            const allFields = Array.isArray(data.allFields) ? data.allFields : [];

            const selectedKey = new Set(selected.map(x => (x.columnName || x.ColumnName || "").toLowerCase()));

            const getFieldName = (item) => {
                const caption = item.columnCaption || item.ColumnCaption || item.columnName || item.ColumnName || "";
                const alias = (item.aliasName || item.AliasName || "").toString();
                const prefix = alias ? `${alias}.` : "";
                return `${prefix}${caption}`.trim();
            };
            const getTableName = (item) => (item.tableName || item.TableName || "").toString();

            selected.forEach(item => {
                const fieldName = getFieldName(item);
                const tableName = getTableName(item);
                qfSelectedEl.appendChild(buildItem(item, fieldName, tableName));
            });

            allFields.forEach(item => {
                const key = (item.columnName || item.ColumnName || "").toLowerCase();
                if (!key || selectedKey.has(key)) return;
                const fieldName = getFieldName(item);
                const tableName = getTableName(item);
                qfAllEl.appendChild(buildItem(item, fieldName, tableName));
            });
        };

        const moveItems = (fromEl, toEl, moveAll = false) => {
            if (!fromEl || !toEl) return;
            const items = moveAll
                ? Array.from(fromEl.querySelectorAll(".qf-item"))
                : Array.from(fromEl.querySelectorAll(".qf-item.selected"));
            items.forEach(item => {
                item.classList.remove("selected");
                toEl.appendChild(item);
            });
        };

        const moveOrder = (listEl, dir) => {
            if (!listEl) return;
            const selected = Array.from(listEl.querySelectorAll(".qf-item.selected"));
            if (selected.length === 0) return;
            const all = Array.from(listEl.querySelectorAll(".qf-item"));
            if (dir < 0) {
                selected.forEach(item => {
                    const idx = all.indexOf(item);
                    if (idx > 0) listEl.insertBefore(item, all[idx - 1]);
                });
            } else {
                for (let i = selected.length - 1; i >= 0; i--) {
                    const item = selected[i];
                    const idx = all.indexOf(item);
                    if (idx >= 0 && idx < all.length - 1) {
                        listEl.insertBefore(all[idx + 1], item);
                    }
                }
            }
        };

        const collectSelectedPayload = () => {
            if (!qfSelectedEl) return [];
            const list = Array.from(qfSelectedEl.querySelectorAll(".qf-item"));
            return list.map((item, idx) => ({
                columnName: item.dataset.columnName || item.dataset.value,
                columnCaption: item.dataset.columnCaption || item.dataset.columnName || item.dataset.value,
                tableName: item.dataset.tableName || getDictTable(),
                aliasName: item.dataset.aliasName || "",
                dataType: Number(item.dataset.dataType || 0),
                sortOrder: idx + 1,
                defaultEqual: item.dataset.defaultEqual || "like",
                defaultValue: item.dataset.defaultValue || "",
                controlType: Number(item.dataset.controlType || 0),
                commandText: item.dataset.commandText || "",
                defaultType: Number(item.dataset.defaultType || 0),
                editMask: item.dataset.editMask || "",
                superId: item.dataset.superId || "",
                paramValue: item.dataset.paramValue || "",
                paramType: Number(item.dataset.paramType || 0),
                iReadOnly: Number(item.dataset.iReadOnly || 0),
                iVisible: Number(item.dataset.iVisible || 1),
                tableKind: item.dataset.tableKind || ""
            }));
        };

        const saveSelected = async (items) => {
            const itemId = getItemId();
            const table = getDictTable();
            if (!itemId || !table) return false;
            const res = await fetcher("/api/DictSetupApi/PaperSelected", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ itemId, table, items })
            }, "儲存查詢設定…");
            if (!res.ok) return false;
            qfCache = null;
            if (window.QueryFieldsManager && typeof window.QueryFieldsManager.refresh === "function") {
                window.QueryFieldsManager.refresh().catch(() => {});
            }
            return true;
        };

        const renderDefaultTable = async () => {
            if (!qfDefaultBody) return;
            qfDefaultBody.innerHTML = "";
            const data = await loadPaperSelected();
            if (!data) return;
            const selected = Array.isArray(data.selected) ? data.selected : [];
            const equals = await fetchEquals();

            selected.forEach(item => {
                const tr = document.createElement("tr");
                const name = item.columnName || item.ColumnName || "";
                const caption = item.columnCaption || item.ColumnCaption || name;

                const tdName = document.createElement("td");
                tdName.textContent = `${name} ${caption}`.trim();

                const tdEq = document.createElement("td");
                const sel = document.createElement("select");
                sel.className = "form-select form-select-sm";
                sel.dataset.columnName = name;
                equals.forEach(eq => {
                    const opt = document.createElement("option");
                    opt.value = eq.value ?? eq.Value ?? eq;
                    opt.textContent = eq.text ?? eq.Text ?? eq;
                    sel.appendChild(opt);
                });
                const defEq = (item.defaultEqual || item.DefaultEqual || "").toString().toLowerCase();
                const hit = Array.from(sel.options).find(o => o.value.toLowerCase() === defEq);
                if (hit) sel.value = hit.value;
                tdEq.appendChild(sel);

                const tdVal = document.createElement("td");
                const inp = document.createElement("input");
                inp.className = "form-control form-control-sm";
                inp.value = item.defaultValue || item.DefaultValue || "";
                inp.dataset.columnName = name;
                tdVal.appendChild(inp);

                tr.appendChild(tdName);
                tr.appendChild(tdEq);
                tr.appendChild(tdVal);
                qfDefaultBody.appendChild(tr);
            });
        };

        const ensureEqualOptions = async () => {
            const sel = document.getElementById("qfEqual");
            if (!sel) return;
            if (sel.options.length) return;
            const equals = await fetchEquals();
            const allOpt = document.createElement("option");
            allOpt.value = "";
            allOpt.textContent = "全部";
            sel.appendChild(allOpt);
            equals.forEach(eq => {
                const text = (eq.text ?? eq.Text ?? eq).toString();
                const value = eq.value ?? eq.Value ?? eq;
                if (text === "全部" || value === "") return;
                const opt = document.createElement("option");
                opt.value = value;
                opt.textContent = text;
                sel.appendChild(opt);
            });
            const defaultValue = "=";
            const hit = Array.from(sel.options).find(o => o.value === defaultValue);
            sel.value = hit ? defaultValue : (sel.options[0]?.value ?? "");
        };

        const showModalAfterCleanup = (which) => {
            const target = which === "default" ? qfDefaultModalEl : qfModalEl;
            if (!target || !window.bootstrap) return;
            document.querySelectorAll(".modal-backdrop").forEach(b => b.remove());
            const modal = bootstrap.Modal.getOrCreateInstance(target);
            modal.show();
        };

        const openQueryModal = async (which) => {
            pendingOpen = which;
            const searchModal = searchModalEl ? bootstrap.Modal.getInstance(searchModalEl) : null;
            if (searchModal) {
                reopenSearchOnClose = true;
                searchModal.hide();
                return;
            }
            showModalAfterCleanup(which);
        };

        btnQfSelect?.addEventListener("click", async () => {
            await ensureEqualOptions();
            await renderFieldSelect();
            await openQueryModal("field");
        });

        btnQfDefault?.addEventListener("click", async () => {
            await renderDefaultTable();
            await openQueryModal("default");
        });

        document.getElementById("qfAdd")?.addEventListener("click", () => moveItems(qfAllEl, qfSelectedEl));
        document.getElementById("qfAddAll")?.addEventListener("click", () => moveItems(qfAllEl, qfSelectedEl, true));
        document.getElementById("qfRemove")?.addEventListener("click", () => moveItems(qfSelectedEl, qfAllEl));
        document.getElementById("qfRemoveAll")?.addEventListener("click", () => moveItems(qfSelectedEl, qfAllEl, true));
        document.getElementById("qfUp")?.addEventListener("click", () => moveOrder(qfSelectedEl, -1));
        document.getElementById("qfDown")?.addEventListener("click", () => moveOrder(qfSelectedEl, 1));

        btnQfSave?.addEventListener("click", async () => {
            const items = collectSelectedPayload();
            const ok = await saveSelected(items);
            if (ok && qfModalEl && window.bootstrap) {
                bootstrap.Modal.getOrCreateInstance(qfModalEl).hide();
            }
        });

        btnQfDefaultSave?.addEventListener("click", async () => {
            if (!qfDefaultBody || !qfSelectedEl) return;
            const map = new Map();
            qfDefaultBody.querySelectorAll("tr").forEach(tr => {
                const name = tr.querySelector("select")?.dataset?.columnName || "";
                const eq = tr.querySelector("select")?.value || "";
                const val = tr.querySelector("input")?.value || "";
                if (name) map.set(name.toLowerCase(), { eq, val });
            });
            qfSelectedEl.querySelectorAll(".qf-item").forEach(item => {
                const key = (item.dataset.columnName || item.dataset.value || "").toLowerCase();
                const hit = map.get(key);
                if (!hit) return;
                item.dataset.defaultEqual = hit.eq;
                item.dataset.defaultValue = hit.val;
            });
            const items = collectSelectedPayload();
            const ok = await saveSelected(items);
            if (ok && qfDefaultModalEl && window.bootstrap) {
                bootstrap.Modal.getOrCreateInstance(qfDefaultModalEl).hide();
            }
        });

        qfModalEl?.addEventListener("hidden.bs.modal", () => {
            if (!reopenSearchOnClose) return;
            reopenSearchOnClose = false;
            if (searchModalEl && window.bootstrap) {
                bootstrap.Modal.getOrCreateInstance(searchModalEl).show();
            }
        });
        qfDefaultModalEl?.addEventListener("hidden.bs.modal", () => {
            if (!reopenSearchOnClose) return;
            reopenSearchOnClose = false;
            if (searchModalEl && window.bootstrap) {
                bootstrap.Modal.getOrCreateInstance(searchModalEl).show();
            }
        });

        searchModalEl?.addEventListener("hidden.bs.modal", async () => {
            if (!pendingOpen) return;
            const which = pendingOpen;
            pendingOpen = null;
            if (which === "field") {
                await ensureEqualOptions();
                await renderFieldSelect();
            }
            showModalAfterCleanup(which);
        });

        document.getElementById("qfEqual")?.addEventListener("change", async () => {
            await renderFieldSelect();
        });
        }


    });
</script>
<style>
    .toolbar {
    display: flex;
    gap: 18px;
    }


    .toolbar-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    background: #fff;
    color: #2a4a7a;
    border: 1px solid #b9c7de;
    border-radius: 11px;
    font-size: var(--top-toolbar-font-size);
    font-weight: 500;
    padding: 5px 10px;
    box-shadow: none;
    transition: background 0.18s, transform 0.11s, border-color 0.18s, color 0.18s;
    cursor: pointer;
    }

    .toolbar-btn.primary {
    background: #2564b3;
    border-color: #2564b3;
    color: #fff;
    box-shadow: 0 2px 8px rgba(37, 100, 179, 0.25);
    }

    .toolbar-btn.success {
    background: #0e9f4b;
    border-color: #0e9f4b;
    color: #fff;
    box-shadow: 0 2px 8px rgba(14, 159, 75, 0.25);
    }

    .toolbar-btn.danger {
    background: #fff;
    border: 1px solid #e07b7b;
    color: #b33939;
    box-shadow: none;
    }

    .toolbar-btn:hover, .toolbar-btn:focus {
    background: #eef3fb;
    border-color: #9fb2d2;
    transform: translateY(-1px) scale(1.02);
    }

    .toolbar-btn.primary:hover, .toolbar-btn.primary:focus {
    background: #215aa2;
    border-color: #215aa2;
    color: #fff;
    }

    .toolbar-btn.secondary {
    background: #fff;
    border-color: #c5ccd8;
    color: #4b5563;
    box-shadow: none;
    }

    .toolbar-btn.secondary:hover, .toolbar-btn.secondary:focus {
    background: #f3f4f6;
    border-color: #b9c2cf;
    color: #374151;
    }

    .toolbar-btn.success:hover, .toolbar-btn.success:focus {
    background: #0c8b43;
    border-color: #0c8b43;
    color: #fff;
    }

    .toolbar-btn.success-outline {
    background: #fff;
    border-color: #37a765;
    color: #1e7b44;
    box-shadow: none;
    }

    .toolbar-btn.success-outline:hover, .toolbar-btn.success-outline:focus {
    background: #effbf3;
    border-color: #2f995a;
    color: #1a6e3d;
    }

    .toolbar-btn.danger:hover, .toolbar-btn.danger:focus {
    background: #fff1f1;
    border-color: #d86a6a;
    color: #a93131;
    }

    .toolbar-btn i {
    font-size: 1.08em;
    }

    .query-field-select-modal .qf-top-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    }
    .query-field-select-modal .qf-config {
    display: flex;
    align-items: center;
    gap: 8px;
    }
    .query-field-select-modal .qf-config-label {
    min-width: 60px;
    text-align: right;
    }
    .query-field-select-modal .qf-config-select {
    width: 100px;
    }
    .query-field-select-modal .qf-order {
    display: flex;
    gap: 6px;
    }
    .query-field-select-modal .qf-main-row {
    display: flex;
    gap: 6px;
    align-items: stretch;
    }
    .query-field-select-modal .qf-panel {
    flex: 1;
    min-width: 0;
    }
    .query-field-select-modal .qf-actions {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 0 2px;
    flex-shrink: 0;
    }
    .query-field-select-modal .qf-action-btn {
    width: 42px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    }
    .query-field-select-modal .qf-title {
    font-weight: 600;
    margin-bottom: 6px;
    }
    .query-field-select-modal .modal-header {
    padding: 6px 12px;
    }
    .query-field-select-modal .qf-table-wrap {
    border: 1px solid #ced4da;
    border-radius: 4px;
    overflow: hidden;
    }
    .query-field-select-modal .qf-table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
    margin: 0;
    }
    .query-field-select-modal .qf-table thead {
    background: #e9ecef;
    }
    .query-field-select-modal .qf-table th {
    padding: 6px 8px;
    font-size: 12px;
    font-weight: 600;
    color: #495057;
    text-align: left;
    border-bottom: 1px solid #ced4da;
    }
    .query-field-select-modal .qf-col-field {
    width: 55%;
    }
    .query-field-select-modal .qf-col-table {
    width: 45%;
    }
    .query-field-select-modal .qf-list {
    height: 300px;
    overflow-y: auto;
    background: #fff;
    }
    .query-field-select-modal .qf-list:focus {
    outline: none;
    }
    .query-field-select-modal .qf-item {
    display: flex;
    padding: 4px 8px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    user-select: none;
    }
    .query-field-select-modal .qf-item:hover {
    background: #f8f9fa;
    }
    .query-field-select-modal .qf-item.selected {
    background: #0d6efd;
    color: #fff;
    }
    .query-field-select-modal .qf-item.selected .qf-item-table {
    color: #fff;
    }
    .query-field-select-modal .qf-item-field {
    width: 55%;
    font-size: 13px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    }
    .query-field-select-modal .qf-item-table {
    width: 45%;
    font-size: 13px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    }
    #queryFieldSelectModal,
    #queryDefaultModal {
    z-index: 10960;
    }
</style>
