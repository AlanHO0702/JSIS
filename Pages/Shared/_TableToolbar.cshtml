@model TableToolbarModel
<div class="btn-toolbar" style="gap:6px;">
    <div id="toolbarCountBox" class="toolbar-count-box mode-view" aria-live="polite">
        <div id="toolbarHeaderCount" class="count-line">--/--</div>
        <div id="toolbarDetailCount" class="count-line">--</div>
    </div>
    <button id="@Model.SearchBtnId" class="btn toolbar-btn" type="button"><i class="bi bi-search"></i>@Model.SearchText</button>
    <button id="btnSwitch" class="btn toolbar-btn" type="button"><i class="bi bi-arrow-left-right"></i>切換</button>
    <button id="btnViewEditToggle" class="btn toolbar-btn" type="button"><i class="bi bi-pencil-square"></i>修改</button>
    <button id="@Model.AddBtnId" class="btn toolbar-btn" type="button"><i class="bi bi-plus-lg"></i>@Model.AddText</button>
    <button id="btnConfirm" class="btn toolbar-btn success" type="button" ><i class="bi bi-check2-circle"></i>確認</button>
    <button id="btnCancel" class="btn toolbar-btn danger" type="button"><i class="bi bi-x-circle"></i>退審</button>
    <button id="@Model.DeleteBtnId" class="btn toolbar-btn danger" type="button"><i class="bi bi-trash3"></i>@Model.DeleteText</button>
    <span class="print-panel-wrap">
        <button id="btnPrint" class="btn toolbar-btn" type="button"><i class="bi bi-printer"></i>列印</button>
        <div id="printPanel" class="print-panel d-none"></div>
    </span>
    <button id="btnPaperTrace" class="btn toolbar-btn" type="button"><i class="bi bi-pin-map"></i>追蹤</button>
    <button id="btnPaperLog" class="btn toolbar-btn" type="button"><i class="bi bi-clock-history"></i>紀錄</button>
</div>
<!-- 查詢條件彈窗 -->

@if (Model.QueryFields != null) {
    <div class="modal fade" id="@(Model.ModalId ?? "searchModal")">
        <div class="modal-dialog modal-lg">
            @await Html.PartialAsync("_QueryPanelPartial", Model.QueryFields)
        </div>
    </div>
}

<script>
    const _reportSpName = "@(Model.ReportSpName)";
    // 原本：const fetcher = window.http || window.busyFetch || fetch.bind(window);
    const fetcher = (...args) =>
    (window.http || window.busyFetch || fetch.bind(window))(...args);

    const printPanelStyle = document.createElement('style');
    printPanelStyle.textContent = `
.print-panel-wrap { position: relative; display: inline-block; }
.print-panel {
  position: absolute;
  top: calc(100% + 8px);
  left: 0;
  display: inline-block;
  width: max-content;
  min-width: 10rem;
  max-width: 360px;
  padding: .5rem 0;
  background: #fff;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: .5rem;
  box-shadow: 0 .5rem 1rem rgba(0,0,0,.175);
  z-index: 1000;
}
.print-panel.d-none { display: none; }
.print-panel-empty { color: #6b7280; padding: .35rem 1rem; }
.print-acc { display: block; max-height: 240px; overflow: auto; }
.print-acc-item { border: 0; background: transparent; }
.print-acc-item[open] { background: transparent; box-shadow: none; }
.print-acc-item summary {
  cursor: pointer;
  padding: .35rem 1rem;
  font-weight: 500;
  color: #212529;
  display: block;
  border-radius: 0;
}
.print-acc-item summary:hover { background: #2d5fa8; color: #fff; }
.print-acc-item summary:active { background: #264f8f; color: #fff; }
.print-acc-item[open] > summary { background: #28579a; color: #fff; }
.print-acc-item summary::-webkit-details-marker { display: none; }
.print-acc-item summary::marker { content: ""; }
.print-acc-item summary::-moz-list-bullet { font-size: 0; }
.print-acc-summary::after {
  content: '';
}
`;
    document.head.appendChild(printPanelStyle);


    document.addEventListener("DOMContentLoaded", function () {
        const btn = document.getElementById('btnViewEditToggle');
        if (!btn) return;

        // 先宣告：要封鎖的狀態
        const BLOCK_STATUSES = ['已確認', '已結案', '已作廢'];

        // 先宣告：讀單據狀態（找 label=單據狀態 的那個 li）
        function getHeaderValueByLabel(labelText) {
            const $label = $('.header-label-item').filter(function () {
            return $(this).text().trim() === labelText;
            }).first();
            if (!$label.length) return null;
            const fieldName = $label.data('field');
            if (!fieldName) return null;
            const $li = $(`.draggable-field[data-field="${fieldName}"]`).first();
            if (!$li.length) return null;

            const $ctrl = $li.find('select, input, textarea').first();
            if (!$ctrl.length) return null;

            if ($ctrl.is('select')) return $ctrl.find('option:selected').text().trim();
            return ($ctrl.val() || '').toString().trim();
        }

        let isEdit = false; // 預設瀏覽

        // 頁面載入時預設全部 disabled（lookup 欄位交給 _DetailHeaderSection 控制）
        document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select').forEach(el => {
            if (el.classList.contains('lookup-dropdown')) return;
            el.disabled = true;
        });

        // 執行 Inherited
        const executeInherited = async (hookName, context) => {
            const itemId = window._itemId || window._singleItemId || '';
            if (!itemId) return { ok: true };

            const hooks = window.InheritedActionHooks || {};
            const hookFn = hooks[itemId]?.[hookName] || hooks[hookName];

            if (typeof hookFn === 'function') {
                try {
                    const result = await hookFn(context);
                    if (result === false) {
                        return { ok: false, reason: 'hook-canceled' };
                    }
                    return { ok: true, data: result };
                } catch (err) {
                    console.error(`[Inherited] ${hookName} 執行失敗:`, err);
                    return { ok: false, reason: 'hook-error', error: err };
                }
            }

            return { ok: true };
        };

        const btnConfirm = document.getElementById('btnConfirm');
        if (btnConfirm) {
            btnConfirm.addEventListener('click', async function () {
                // 自動抓取正確的 tableName (從 HeaderTableName)
                const tableName = window._headerTableName || window._tableName;
                const paperNum = window.selectedPaperNum;
                const userId = window._userId || 'admin';  // TODO: 換成實際登入者

                if (!tableName) {
                    Swal.fire({ icon: 'warning', title: '尚未設定送審 Table', text: '請檢查頁面是否正確設定 HeaderTableName' });
                    return;
                }

                if (!paperNum) {
                    Swal.fire({ icon: 'warning', title: '查無單號！' });
                    return;
                }

                const result = await Swal.fire({
                    title: '確定要執行確認？',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: '確定',
                    cancelButtonText: '取消'
                });
                if (!result.isConfirmed) return;

                // Hook: beforeConfirm
                const beforeHook = await executeInherited('beforeConfirm', { tableName, paperNum, userId });
                if (!beforeHook.ok) {
                    if (beforeHook.reason === 'hook-canceled') return;
                    if (beforeHook.reason === 'hook-error') {
                        Swal.fire({ icon: 'error', title: 'Hook 執行失敗', text: beforeHook.error?.message || String(beforeHook.error) });
                        return;
                    }
                }

                // DoAction: 確認
                const resp = await fetcher('/api/PaperAction/DoAction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paperId: tableName,
                        paperNum: paperNum,
                        userId: userId,
                        eoc: 1,
                        aftFinished: 1
                    })
                }, '確認中…');
                if (resp.ok) {
                    const data = await resp.json();

                    // Hook: afterConfirm
                    await executeInherited('afterConfirm', { tableName, paperNum, userId, result: data });

                    Swal.fire({ icon: 'success', title: data.message || '確認成功' });
                    location.reload();
                } else {
                    const msg = await resp.text();
                    Swal.fire({ icon: 'error', title: msg || '確認失敗' });
                }
            });
        }


        const btnCancel = document.getElementById('btnCancel');
        if (btnCancel) {
            btnCancel.addEventListener('click', async function () {
                // 自動抓取正確的 tableName (從 HeaderTableName)
                const tableName = window._headerTableName || window._tableName;
                const paperNum = window.selectedPaperNum;
                const userId = window._userId || 'admin';  // TODO: 換成實際登入者

                if (!tableName) {
                    Swal.fire({ icon: 'warning', title: '尚未設定送審 Table', text: '請檢查頁面是否正確設定 HeaderTableName' });
                    return;
                }

                if (!paperNum) {
                    Swal.fire({ icon: 'warning', title: '查無單號！' });
                    return;
                }

                const result = await Swal.fire({
                    title: '確定要執行退審？',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: '確定',
                    cancelButtonText: '取消'
                });
                if (!result.isConfirmed) return;

                // Hook: beforeCancel
                const beforeHook = await executeInherited('beforeCancel', { tableName, paperNum, userId });
                if (!beforeHook.ok) {
                    if (beforeHook.reason === 'hook-canceled') return;
                    if (beforeHook.reason === 'hook-error') {
                        Swal.fire({ icon: 'error', title: 'Hook 執行失敗', text: beforeHook.error?.message || String(beforeHook.error) });
                        return;
                    }
                }

                // DoAction: 退審
                const resp = await fetcher('/api/PaperAction/DoAction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paperId: tableName,
                        paperNum: paperNum,
                        userId: userId,
                        eoc: 0,
                        aftFinished: 3 // 退審時 AftFinished 設為 3 (審核中)
                    })
                }, '退審中…');
                if (resp.ok) {
                    const data = await resp.json();

                    // Hook: afterCancel
                    await executeInherited('afterCancel', { tableName, paperNum, userId, result: data });

                    Swal.fire({ icon: 'success', title: data.message || '退審成功' });
                    location.reload();
                } else {
                    const msg = await resp.text();
                    Swal.fire({ icon: 'error', title: msg || '退審失敗' });
                }
            });
        }

        const btnPrint = document.getElementById('btnPrint');
        const printPanel = document.getElementById('printPanel');
        let printOptionsCache = null;

        const buildPrintPayload = (opt, paperNum) => ({
            spName: opt?.SpName || _reportSpName,
            reportName: opt?.ReportName || _reportSpName,
            params: { PaperNum: paperNum }
        });

        const renderPrintPanel = (options) => {
            if (!printPanel) return;
            if (!options || options.length === 0) {
                printPanel.innerHTML = '<div class="print-panel-empty">沒有可用的列印設定</div>';
                return;
            }
            const acc = options.map((o, i) => {
                const label = o.ItemName || o.ReportName || o.SpName;
                return `
<details class="print-acc-item">
  <summary class="print-acc-summary" data-print-idx="${i}">${label}</summary>
</details>`;
            }).join('');
            printPanel.innerHTML = `<div class="print-acc">${acc}</div>`;
        };

        const fetchPrintOptions = async () => {
            const paperId = window._headerTableName || window._tableName || "";
            if (!paperId) return [];
            try {
                const optResp = await fetch(`/api/report/paper-options?paperId=${encodeURIComponent(paperId)}`);
                if (!optResp.ok) return [];
                const optData = await optResp.json();
                return (optData?.ok && Array.isArray(optData.list)) ? optData.list : [];
            } catch {
                return [];
            }
        };

        const togglePrintPanel = async () => {
            if (!printPanel) return;
            if (!printPanel.classList.contains('d-none')) {
                printPanel.classList.add('d-none');
                return;
            }
            if (printOptionsCache === null) {
                printOptionsCache = await fetchPrintOptions();
            }
            renderPrintPanel(printOptionsCache);
            printPanel.classList.remove('d-none');
        };

        if (btnPrint) {
            btnPrint.addEventListener('click', async () => {
                const paperNum = window.selectedPaperNum || document.querySelector('[name="PaperNum"]')?.value;
                if (!paperNum) { Swal.fire({ icon:'warning', title:'查無單號！' }); return; }

                if (printOptionsCache === null) {
                    printOptionsCache = await fetchPrintOptions();
                }

                // 若沒有任何設定，沿用舊的直接列印
                if (!printOptionsCache || printOptionsCache.length === 0) {
                    if (!_reportSpName) {
                        Swal.fire({ icon:'warning', title:'沒有可用的列印設定' });
                        return;
                    }
                    const payload = buildPrintPayload(null, paperNum);
                    const res = await fetch('/api/report/generate-url', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) {
                        Swal.fire({ icon:'error', title:'報表產生失敗', text: await res.text() });
                        return;
                    }
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    Swal.fire({
                        html: `<iframe src="${url}" width="100%" height="600px" frameborder="0"></iframe>`,
                        width: '80%', heightAuto: false, showCloseButton: true, showConfirmButton: false,
                        willClose: () => URL.revokeObjectURL(url)
                    });
                    return;
                }

                await togglePrintPanel();
            });
        }

        if (printPanel) {
            document.addEventListener('click', (e) => {
                if (printPanel.classList.contains('d-none')) return;
                if (btnPrint && (btnPrint.contains(e.target) || printPanel.contains(e.target))) return;
                printPanel.classList.add('d-none');
            });

            printPanel.addEventListener('click', async (e) => {
                const summary = e.target.closest('.print-acc-summary');
                if (!summary) return;
                e.preventDefault();
                const idx = parseInt(summary.dataset.printIdx, 10);
                if (Number.isNaN(idx)) return;
                const paperNum = window.selectedPaperNum || document.querySelector('[name="PaperNum"]')?.value;
                if (!paperNum) { Swal.fire({ icon:'warning', title:'查無單號！' }); return; }
                const selected = (printOptionsCache && printOptionsCache[idx]) ? printOptionsCache[idx] : null;
                const payload = buildPrintPayload(selected, paperNum);

                const res = await fetch('/api/report/generate-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    Swal.fire({ icon:'error', title:'報表產生失敗', text: await res.text() });
                    return;
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                Swal.fire({
                    html: `<iframe src="${url}" width="100%" height="600px" frameborder="0"></iframe>`,
                    width: '80%', heightAuto: false, showCloseButton: true, showConfirmButton: false,
                    willClose: () => URL.revokeObjectURL(url)
                });
                printPanel.classList.add('d-none');
            });
        }

        const btnSwitch = document.getElementById("btnSwitch");
        if (btnSwitch) {
            btnSwitch.addEventListener("click", function () {
                // 這裡直接取選中的單號
                const id = (window.getSelectedId && window.getSelectedId()) 
                            || window.selectedPaperNum;

                if (!id) {
                    Swal.fire({ icon: 'warning', title: '請先選擇一筆單據' });
                    return;
                }

                // 這個 template 從 Razor 傳進來，已經有 "/SpodOrderSubs/{PaperNum}" 之類的
                const tpl = window._detailRouteTemplate; 
                if (!tpl) {
                    Swal.fire({ icon: 'error', title: '未設定切換路徑' });
                    return;
                }

                const url = tpl.replace("{PaperNum}", id);
                window.location.href = url;
            });
        }



    });
</script>
<style>
    .toolbar {
    display: flex;
    gap: 18px;
    }

    .toolbar-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    background: #2564b3;
    color: #fff;
    border: none;
    border-radius: 11px;
    font-size: var(--top-toolbar-font-size);
    font-weight: 500;
    padding: 5px 10px;
    box-shadow: 0 2px 10px 0 #c5d9f1;
    transition: background 0.18s, transform 0.11s;
    cursor: pointer;
    }

    .toolbar-btn.success {
    background: #0e9f4b;
    }
    .toolbar-btn.danger {
    background: #df3c4b;
    }

    .toolbar-btn:hover, .toolbar-btn:focus {
    transform: translateY(-1px) scale(1.03);
    }

    .toolbar-btn i {
    font-size: 1.08em;
    }

</style>
