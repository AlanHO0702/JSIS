@model TableToolbarModel
<div class="btn-toolbar" style="gap:12px;">
    <button id="@Model.SearchBtnId" class="btn toolbar-btn" type="button">@Model.SearchText</button>
    <button id="btnSwitch" class="btn toolbar-btn" type="button">åˆ‡æ›</button>
    <button id="btnViewEditToggle" class="btn toolbar-btn" type="button">ä¿®æ”¹</button>
    <button id="@Model.AddBtnId" class="btn toolbar-btn" type="button">@Model.AddText</button>
    <button id="btnConfirm" class="btn toolbar-btn success" type="button" >ç¢ºèª</button>
    <button id="btnCancel" class="btn toolbar-btn danger" type="button">é€€å¯©</button>
    <button id="@Model.DeleteBtnId" class="btn toolbar-btn danger" type="button">@Model.DeleteText</button>
    <button id="btnPrint" class="btn toolbar-btn" type="button">å°å–®æ“š</button>
</div>
<!-- æŸ¥è©¢æ¢ä»¶å½ˆçª— -->

@if (Model.QueryFields != null) {
    <div class="modal fade" id="@(Model.ModalId ?? "searchModal")">
        <div class="modal-dialog modal-lg">
            @await Html.PartialAsync("_QueryPanelPartial", Model.QueryFields)
        </div>
    </div>
}


<script>
    const _reportSpName = "@(Model.ReportSpName)";
    // åŸæœ¬ï¼šconst fetcher = window.http || window.busyFetch || fetch.bind(window);
    const fetcher = (...args) =>
    (window.http || window.busyFetch || fetch.bind(window))(...args);


    document.addEventListener("DOMContentLoaded", function () {
        const btn = document.getElementById('btnViewEditToggle');
        if (!btn) return;

        // å…ˆå®£å‘Šï¼šè¦å°é–çš„ç‹€æ…‹
        const BLOCK_STATUSES = ['å·²ç¢ºèª', 'å·²çµæ¡ˆ', 'å·²ä½œå»¢'];

        // å…ˆå®£å‘Šï¼šè®€å–®æ“šç‹€æ…‹ï¼ˆæ‰¾ label=å–®æ“šç‹€æ…‹ çš„é‚£å€‹ liï¼‰
        function getHeaderValueByLabel(labelText) {
            const $li = $('.draggable-field').filter(function () {
            return $(this).children('label').first().text().trim() === labelText;
            }).first();
            if (!$li.length) return null;

            const $ctrl = $li.find('select, input, textarea').first();
            if (!$ctrl.length) return null;

            if ($ctrl.is('select')) return $ctrl.find('option:selected').text().trim();
            return ($ctrl.val() || '').toString().trim();
        }

        let isEdit = false; // é è¨­ç€è¦½

        // é é¢è¼‰å…¥æ™‚é è¨­å…¨éƒ¨ disabled
        document.querySelectorAll('.erp-header-form input, .erp-header-form textarea, .erp-header-form select').forEach(el => {
            el.disabled = true;
        });

        const btnConfirm = document.getElementById('btnConfirm');
        if (btnConfirm) {
            btnConfirm.addEventListener('click', async function () {
                // å‡è¨­æœ‰å…¨åŸŸè®Šæ•¸ tableNameã€paperNumã€userId
                const tableName = window._tableName || 'SPOdOrderMain'; // é è¨­è¡¨å
                const paperNum = window.selectedPaperNum;
                //const paperNum = document.querySelector('[name="PaperNum"]')?.value || window._paperNum;
                const userId = window._userId || 'admin';  // TODO: æ›æˆå¯¦éš›ç™»å…¥è€…

                if (!paperNum) {
                    Swal.fire({ icon: 'warning', title: 'æŸ¥ç„¡å–®è™Ÿï¼' });
                    return;
                }

                const result = await Swal.fire({
                    title: 'ç¢ºå®šè¦åŸ·è¡Œç¢ºèªï¼Ÿ',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ç¢ºå®š',
                    cancelButtonText: 'å–æ¶ˆ'
                });
                if (!result.isConfirmed) return;

                // ä½ å¯ä»¥è®“ EOC/AtFinished å¾Œç«¯é è¨­ï¼Œä¹Ÿå¯ä»¥åœ¨é€™é‚Šé¸
                const resp = await fetcher('/api/PaperAction/DoAction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paperId: tableName,
                        paperNum: paperNum,
                        userId: userId,
                        eoc: 1,
                        aftFinished: 1
                    })
                }, 'ç¢ºèªä¸­â€¦');
                if (resp.ok) {
                    const data = await resp.json();
                    Swal.fire({ icon: 'success', title: data.message || 'ç¢ºèªæˆåŠŸ' });
                    location.reload(); // ç¢ºèªæˆåŠŸå¾Œé‡æ–°è¼‰å…¥é é¢
                } else {
                    const msg = await resp.text();
                    Swal.fire({ icon: 'error', title: msg || 'ç¢ºèªå¤±æ•—' });
                }
            });
        }


        const btnCancel = document.getElementById('btnCancel');
        if (btnCancel) {
            btnCancel.addEventListener('click', async function () {
                // å‡è¨­æœ‰å…¨åŸŸè®Šæ•¸ tableNameã€paperNumã€userId
                const tableName = window._tableName || 'SPOdOrderMain'; // é è¨­è¡¨å
                const paperNum = window.selectedPaperNum;
                const userId = window._userId || 'admin';  // TODO: æ›æˆå¯¦éš›ç™»å…¥è€…

                if (!paperNum) {
                    Swal.fire({ icon: 'warning', title: 'æŸ¥ç„¡å–®è™Ÿï¼' });
                    return;
                }

                const result = await Swal.fire({
                    title: 'ç¢ºå®šè¦åŸ·è¡Œé€€å¯©ï¼Ÿ',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ç¢ºå®š',
                    cancelButtonText: 'å–æ¶ˆ'
                });
                if (!result.isConfirmed) return;

                // ä½ å¯ä»¥è®“ EOC/AtFinished å¾Œç«¯é è¨­ï¼Œä¹Ÿå¯ä»¥åœ¨é€™é‚Šé¸
                const resp = await fetcher('/api/PaperAction/DoAction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paperId: tableName,
                        paperNum: paperNum,
                        userId: userId,
                        eoc: 0,
                        aftFinished: 3 // é€€å¯©æ™‚ AftFinished è¨­ç‚º 0
                    })
                }, 'é€€å¯©ä¸­â€¦');
                if (resp.ok) {
                    const data = await resp.json();
                    Swal.fire({ icon: 'success', title: data.message || 'é€€å¯©æˆåŠŸ' });
                    location.reload(); // é€€å¯©æˆåŠŸå¾Œé‡æ–°è¼‰å…¥é é¢
                } else {
                    const msg = await resp.text();
                    Swal.fire({ icon: 'error', title: msg || 'é€€å¯©å¤±æ•—' });
                }
            });
        }

        const btnPrint = document.getElementById('btnPrint');
        if (btnPrint) {
            btnPrint.addEventListener('click', async function () {
                // å–å¾—å–®è™Ÿï¼ˆå¯ä¾ä½ å°ˆæ¡ˆçš„å–æ³•ï¼‰
                const paperNum = window.selectedPaperNum 
                            || document.querySelector('[name="PaperNum"]')?.value;

                if (!paperNum) {
                    Swal.fire({ icon: 'warning', title: 'æŸ¥ç„¡å–®è™Ÿï¼' });
                    return;
                }
                
                if (!_reportSpName) {
                    Swal.fire({ icon: 'warning', title: 'ç¼ºå°‘å ±è¡¨å°æ‡‰çš„ SP åç¨±ï¼' });
                    return;
                }

                // å‘¼å«å¾Œç«¯ API
                const res = await fetch("/api/report/generate-url", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        paperNum: paperNum, 
                        spName: _reportSpName,// ğŸ‘ˆ é€™è£¡æŒ‡å®šè¦è·‘å“ªå€‹ SP
                        reportName: _reportSpName
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    const reportUrl = data.reportUrl;

                    // âœ… é€™è£¡æœ‰å…©ç¨®åšæ³•ï¼š
                    // 1. ç›´æ¥é–‹æ–°è¦–çª—
                    /*
                    window.open(reportUrl, "_blank");
                    */
                    // 2. æˆ–è€…ç”¨ SweetAlert2 é¡¯ç¤º iframe é è¦½
                    
                    Swal.fire({
                        //title: 'å ±è¡¨é è¦½',
                        html: `<iframe src="${reportUrl}" width="100%" height="600px" frameborder="0"></iframe>`,
                        width: '80%',
                        heightAuto: false,
                        showCloseButton: true,
                        showConfirmButton: false
                    });
                    
                } else {
                    Swal.fire({ icon: 'error', title: 'âŒ å ±è¡¨ç”¢ç”Ÿå¤±æ•—ï¼' });
                }
            });
        }

        const btnSwitch = document.getElementById("btnSwitch");
        if (btnSwitch) {
            btnSwitch.addEventListener("click", function () {
                // é€™è£¡ç›´æ¥å–é¸ä¸­çš„å–®è™Ÿ
                const id = (window.getSelectedId && window.getSelectedId()) 
                            || window.selectedPaperNum;

                if (!id) {
                    Swal.fire({ icon: 'warning', title: 'è«‹å…ˆé¸æ“‡ä¸€ç­†å–®æ“š' });
                    return;
                }

                // é€™å€‹ template å¾ Razor å‚³é€²ä¾†ï¼Œå·²ç¶“æœ‰ "/SpodOrderSubs/{PaperNum}" ä¹‹é¡çš„
                const tpl = window._detailRouteTemplate; 
                if (!tpl) {
                    Swal.fire({ icon: 'error', title: 'æœªè¨­å®šåˆ‡æ›è·¯å¾‘' });
                    return;
                }

                const url = tpl.replace("{PaperNum}", id);
                window.location.href = url;
            });
        }



    });
</script>
<style>
    .toolbar {
    display: flex;
    gap: 18px;
    }

    .toolbar-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #2564b3;
    color: #fff;
    border: none;
    border-radius: 11px;
    font-size: 1.08em;
    font-weight: 500;
    padding: 6px 14px;
    box-shadow: 0 2px 10px 0 #c5d9f1;
    transition: background 0.18s, transform 0.11s;
    cursor: pointer;
    }

    .toolbar-btn.success {
    background: #0e7444;
    }
    .toolbar-btn.danger {
    background: #df3c4b;
    }

    .toolbar-btn:hover, .toolbar-btn:focus {
    transform: translateY(-1px) scale(1.03);
    }

    .toolbar-btn i {
    font-size: 1.08em;
    }

</style>