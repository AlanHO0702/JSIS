@model dynamic
@{
    var paperNum = ViewData["PaperNum"]?.ToString() ?? "";
    var tabs = ViewData["Tabs"] as dynamic[] ?? Array.Empty<dynamic>();
    var tabFieldDicts = ViewData["TabFieldDicts"] as Dictionary<string, Dictionary<string, string>> ?? new();
}

<!-- SweetAlert2 å¼•å…¥ -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- å¤šåˆ†é å®¹å™¨ -->
<div class="multi-tab-detail">
    <!-- Tab æ¨™ç±¤åˆ— -->
    <ul class="nav nav-tabs" role="tablist">
        @for (int i = 0; i < tabs.Length; i++)
        {
            var tab = tabs[i];
            var isActive = i == 0 ? "active" : "";
            <li class="nav-item" role="presentation">
                <button class="nav-link @isActive"
                        id="tab-@tab.Id"
                        data-bs-toggle="tab"
                        data-bs-target="#content-@tab.Id"
                        data-api-url="@tab.ApiUrl"
                        data-tab-id="@tab.Id"
                        type="button"
                        role="tab">
                    @tab.Title
                </button>
            </li>
        }
    </ul>

    <!-- Tab å…§å®¹å€ -->
    <div class="tab-content mt-3">
        @for (int i = 0; i < tabs.Length; i++)
        {
            var tab = tabs[i];
            var isActive = i == 0 ? "show active" : "";
            <div class="tab-pane fade @isActive"
                 id="content-@tab.Id"
                 role="tabpanel">
                <!-- è¼‰å…¥ä¸­æç¤º -->
                <div class="loading-indicator text-center py-5" style="display:@(i == 0 ? "block" : "none");">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">è¼‰å…¥ä¸­...</p>
                </div>

                <!-- è¡¨æ ¼å®¹å™¨ -->
                <div class="table-container" data-tab-id="@tab.Id" data-dict-table="@tab.DictTable">
                    <!-- å‹•æ…‹è¼‰å…¥çš„è¡¨æ ¼æœƒæ’å…¥é€™è£¡ -->
                </div>
            </div>
        }
    </div>
</div>

<script>
(function() {
    const paperNum = '@paperNum';
    const loadedTabs = new Set();
    const fieldDicts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(tabFieldDicts));
    const tabsData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(tabs));

    function cleanTableName(t) {
        return (t || '').toString().replace(/^dbo\./i, '').trim().toLowerCase();
    }

    function getDictTableOfTab(container, tabId) {
        return (container?.dataset?.dictTable || tabsData?.find(x => x?.Id === tabId)?.DictTable || '').toString();
    }

    async function fetchFieldWidths(dictTable) {
        const tn = cleanTableName(dictTable);
        if (!tn) return new Map();
        try {
            const res = await fetch(`/api/TableFieldLayout/DictFields?table=${encodeURIComponent(tn)}&lang=TW`);
            if (!res.ok) return new Map();
            const rows = await res.json();
            const map = new Map();
            (rows || []).forEach(r => {
                const field = (r.fieldName || r.FieldName || '').toString();
                const w = r.fieldWidth ?? r.FieldWidth;
                const ds = r.displaySize ?? r.DisplaySize;
                if (!field) return;
                const px = Number.isFinite(w) ? Number(w) : (Number.isFinite(ds) ? Number(ds) * 10 : null);
                if (px && px > 0) map.set(field.toLowerCase(), Math.round(px));
            });
            return map;
        } catch {
            return new Map();
        }
    }

    function applyColumnWidth(table, ths, index, width) {
        const w = Math.max(30, Math.round(width));
        const th = ths[index];
        if (!th) return;
        th.style.width = `${w}px`;
        Array.from(table.querySelectorAll(`tbody tr td:nth-child(${index + 1})`)).forEach(td => td.style.width = `${w}px`);
    }

    function applySavedWidths(table, dictTable, fields) {
        const tn = cleanTableName(dictTable);
        if (!tn) return;
        try {
            const raw = localStorage.getItem(`colwidth:${tn}`);
            if (!raw) return;
            const cols = JSON.parse(raw) || [];
            const ths = Array.from(table.querySelectorAll('thead th'));
            cols.forEach(c => {
                const f = (c.fieldName || '').toString();
                const w = Number(c.width);
                if (!f || !Number.isFinite(w)) return;
                const idx = fields.findIndex(x => x.toLowerCase() === f.toLowerCase());
                if (idx >= 0) applyColumnWidth(table, ths, idx, w);
            });
        } catch {}
    }

    // æ¬„å¯¬æ‹–æ›³ç‹€æ…‹ï¼ˆå…¨é å…±ç”¨ä¸€æ¬¡ï¼Œé¿å…æ¯å€‹ tab é‡è¤‡æ› document äº‹ä»¶ï¼‰
    const resizeState = {
        active: false,
        table: null,
        ths: [],
        dictTable: '',
        thIndex: -1,
        startX: 0,
        startWidth: 0,
        saveTimer: null
    };
    async function persistWidths() {
        const { table, ths, dictTable } = resizeState;
        const tn = cleanTableName(dictTable);
        if (!table || !ths.length || !tn) return;
        try {
            const payload = {
                tableName: tn,
                cols: ths.map(th => ({ fieldName: th.dataset.field, width: Math.round(th.getBoundingClientRect().width) }))
            };
            await fetch('/api/TableFieldLayout/SaveDetailLayout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(() => {});
            localStorage.setItem(`colwidth:${tn}`, JSON.stringify(payload.cols));
        } catch {}
    }
    function debouncePersist() {
        clearTimeout(resizeState.saveTimer);
        resizeState.saveTimer = setTimeout(persistWidths, 400);
    }
    document.addEventListener('mousemove', (e) => {
        if (!resizeState.active || !resizeState.table) return;
        const dx = e.pageX - resizeState.startX;
        const newW = Math.max(30, resizeState.startWidth + dx);
        applyColumnWidth(resizeState.table, resizeState.ths, resizeState.thIndex, newW);
    });
    document.addEventListener('mouseup', () => {
        if (!resizeState.active) return;
        resizeState.active = false;
        document.body.classList.remove('resizing');
        resizeState.ths.forEach(th => th.classList.remove('resizing'));
        Array.from(resizeState.table.querySelectorAll('tbody td.resizing')).forEach(td => td.classList.remove('resizing'));
        debouncePersist();
        resizeState.table = null;
        resizeState.ths = [];
        resizeState.dictTable = '';
        resizeState.thIndex = -1;
    });

    function initColumnResize(table, dictTable, fields) {
        if (!table) return;
        const ths = Array.from(table.querySelectorAll('thead th'));
        ths.forEach((th, idx) => {
            const handle = th.querySelector('.col-resizer');
            if (!handle) return;
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                resizeState.active = true;
                resizeState.table = table;
                resizeState.ths = ths;
                resizeState.dictTable = dictTable;
                resizeState.thIndex = idx;
                resizeState.startX = e.pageX;
                resizeState.startWidth = th.getBoundingClientRect().width;
                document.body.classList.add('resizing');
                th.classList.add('resizing');
                Array.from(table.querySelectorAll(`tbody tr td:nth-child(${idx + 1})`)).forEach(td => td.classList.add('resizing'));
            });
        });
    }

    // æš´éœ²ç‚ºå…¨åŸŸè®Šæ•¸æ–¹ä¾¿é™¤éŒ¯
    window._debugFieldDicts = fieldDicts;
    window._debugTabsData = tabsData;

    // Tab åˆ‡æ›äº‹ä»¶
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', async function(e) {
            const tabId = this.dataset.tabId;
            const apiUrl = this.dataset.apiUrl;
            const contentPane = document.getElementById(`content-${tabId}`);

            // å–å¾—å®¹å™¨å…ƒç´ 
            const container = contentPane.querySelector('.table-container');

            // æ›´æ–°ç•¶å‰è¾­å…¸è¡¨åç¨±çµ¦ F3 ä½¿ç”¨
            if (container && container.dataset.dictTable) {
                window._dictTableName = container.dataset.dictTable;
            }

            // å¦‚æœå·²ç¶“è¼‰å…¥é,ç›´æ¥é¡¯ç¤º
            if (loadedTabs.has(tabId)) {
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            const loading = contentPane.querySelector('.loading-indicator');
            loading.style.display = 'block';

            // æ¸…é™¤èˆŠçš„è¡¨æ ¼ï¼ˆä¿ç•™æŒ‰éˆ•ï¼‰
            const existingTable = container.querySelector('.erp-table-wrapper');
            if (existingTable) existingTable.remove();
            const existingAlert = container.querySelector('.alert');
            if (existingAlert) existingAlert.remove();

            try {
                // AJAX è¼‰å…¥è³‡æ–™
                const response = await fetch(`${apiUrl}?PaperNum=${paperNum}`);

                // æª¢æŸ¥ HTTP ç‹€æ…‹
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`API éŒ¯èª¤ (${response.status}):`, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                }

                // æª¢æŸ¥ Content-Type æ˜¯å¦ç‚º JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('å›æ‡‰ä¸æ˜¯ JSON:', text.substring(0, 200));
                    throw new Error('API å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ API æ˜¯å¦æ­£å¸¸é‹ä½œ');
                }

                const data = await response.json();

                // æ¸²æŸ“è¡¨æ ¼
                await renderTable(container, data, tabId);

                // æ¨™è¨˜ç‚ºå·²è¼‰å…¥
                loadedTabs.add(tabId);
            } catch (error) {
                console.error(`è¼‰å…¥åˆ†é  ${tabId} å¤±æ•—:`, error);
                container.insertAdjacentHTML('beforeend', `<div class="alert alert-danger">è¼‰å…¥å¤±æ•—: ${error.message}</div>`);
            } finally {
                loading.style.display = 'none';
            }
        });
    });

    // æ¸²æŸ“è¡¨æ ¼å‡½å¼
    async function renderTable(container, data, tabId) {
        if (!Array.isArray(data) || data.length === 0) {
            container.insertAdjacentHTML('beforeend', '<div class="alert alert-info">ç„¡è³‡æ–™</div>');
            return;
        }

        const dict = fieldDicts[tabId] || {};
        const dictTable = getDictTableOfTab(container, tabId);

        // Debug è¼¸å‡º
        console.log(`ğŸ” [renderTable] tabId: ${tabId}`);
        console.log(`ğŸ” [renderTable] å­—å…¸æ¬„ä½æ•¸é‡: ${Object.keys(dict).length}`);
        console.log(`ğŸ” [renderTable] å­—å…¸æ¬„ä½:`, Object.keys(dict));

        // åªé¡¯ç¤ºå­—å…¸ä¸­æœ‰çš„æ¬„ä½ï¼ˆVisible == 1 çš„æ¬„ä½ï¼‰
        // å¦‚æœå­—å…¸ç‚ºç©ºï¼Œå‰‡é¡¯ç¤ºæ‰€æœ‰æ¬„ä½ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
        const allFields = Object.keys(data[0]);
        console.log(`ğŸ” [renderTable] API å›å‚³æ¬„ä½æ•¸é‡: ${allFields.length}`);
        console.log(`ğŸ” [renderTable] API å›å‚³æ¬„ä½:`, allFields);

        const fields = Object.keys(dict).length > 0
            ? Object.keys(dict).filter(f => allFields.includes(f))  // åªé¡¯ç¤ºå­—å…¸ä¸­ä¸”è³‡æ–™æœ‰çš„æ¬„ä½
            : allFields;  // å¦‚æœæ²’æœ‰å­—å…¸ï¼Œé¡¯ç¤ºæ‰€æœ‰æ¬„ä½

        console.log(`ğŸ” [renderTable] éæ¿¾å¾Œè¦é¡¯ç¤ºçš„æ¬„ä½æ•¸é‡: ${fields.length}`);
        console.log(`ğŸ” [renderTable] éæ¿¾å¾Œè¦é¡¯ç¤ºçš„æ¬„ä½:`, fields);

        if (fields.length === 0) {
            container.insertAdjacentHTML('beforeend', '<div class="alert alert-warning">æ²’æœ‰å¯é¡¯ç¤ºçš„æ¬„ä½</div>');
            return;
        }

        // å»ºç«‹è¡¨æ ¼ - ä½¿ç”¨ erp-table æ¨£å¼ï¼Œä¸¦åœ¨å…§éƒ¨åŠ å…¥ +- æŒ‰éˆ•
        let html = '<div class="erp-table-wrapper">';

        // +- æŒ‰éˆ•æ”¾åœ¨ wrapper å…§éƒ¨
        html += `
            <div class="d-flex justify-content-start mb-2 tab-action-buttons">
                <button type="button" class="btn btn-outline-secondary btn-sm btn-add-row" data-tab-id="${tabId}">
                    ï¼‹
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm ms-1 btn-delete-row" data-tab-id="${tabId}" title="åˆªé™¤ç•¶å‰åˆ—">
                    ï¼
                </button>
            </div>
        `;

        html += '<table class="erp-table"><thead><tr>';

        // è¡¨é ­ - ä½¿ç”¨å­—å…¸å–å¾—ä¸­æ–‡åç¨±
        fields.forEach(field => {
            const displayName = dict[field] || field;
            html += `<th data-field="${field}" style="position:relative;"><span class="th-text">${displayName}</span><span class="col-resizer" draggable="false"></span></th>`;
        });
        html += '</tr></thead><tbody>';

        // è¡¨èº«
        data.forEach((row, index) => {
            const paperNum = row.PaperNum || row.paperNum || '';
            const item = row.Item || row.item || index + 1;
            html += `<tr data-paper-num="${paperNum}" data-item="${item}" data-state="unchanged">`;
            fields.forEach(field => {
                const value = row[field] ?? '';
                html += `<td><span class="cell-view">${value}</span></td>`;
            });
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        container.insertAdjacentHTML('beforeend', html);

        const table = container.querySelector('.erp-table-wrapper table.erp-table');
        if (table) {
            applySavedWidths(table, dictTable, fields);
            const widthMap = await fetchFieldWidths(dictTable);
            if (widthMap.size) {
                const ths = Array.from(table.querySelectorAll('thead th'));
                fields.forEach((f, idx) => {
                    const w = widthMap.get(f.toLowerCase());
                    if (w) applyColumnWidth(table, ths, idx, w);
                });
                try {
                    const tn = cleanTableName(dictTable);
                    const cols = fields.map((f, idx) => ({ fieldName: f, width: Math.round(ths[idx].getBoundingClientRect().width) }));
                    localStorage.setItem(`colwidth:${tn}`, JSON.stringify(cols));
                } catch {}
            }
            initColumnResize(table, dictTable, fields);
        }

        // ç¶å®šåˆ—é¸å–äº‹ä»¶
        const tableWrapper = container.querySelector('.erp-table-wrapper');
        if (tableWrapper) {
            tableWrapper.querySelectorAll('tr').forEach(tr => {
                tr.addEventListener('click', function() {
                    // ç§»é™¤å…¶ä»–åˆ—çš„é¸å–ç‹€æ…‹
                    tableWrapper.querySelectorAll('tr.row-selected').forEach(r => r.classList.remove('row-selected'));
                    // é¸å–ç•¶å‰åˆ—
                    this.classList.add('row-selected');
                });
            });
        }
    }

    // é é¢è¼‰å…¥æ™‚,ç«‹å³è¼‰å…¥ç¬¬ä¸€å€‹ Tabï¼ˆè¨‚å–®æ˜ç´°æª”ï¼‰
    console.log('ğŸ“‹ [MultiTab] åˆå§‹åŒ–å¤šåˆ†é è¼‰å…¥...');
    console.log('ğŸ“‹ [MultiTab] tabsData:', tabsData);

    // çµ±ä¸€ä½¿ç”¨ async å‡½å¼è¼‰å…¥ç¬¬ä¸€å€‹é ç±¤
    async function loadFirstTab() {
        console.log('ğŸš€ [MultiTab] loadFirstTab() å‡½å¼å·²åŸ·è¡Œ');

        // ç›´æ¥å¾ tabsData å–å¾—ç¬¬ä¸€å€‹é ç±¤è³‡è¨Šï¼ˆé¿å… DOM å±¬æ€§è®€å–å•é¡Œï¼‰
        if (!tabsData || tabsData.length === 0) {
            console.error(`âŒ [MultiTab] tabsData ç‚ºç©º`);
            return;
        }

        const firstTabData = tabsData[0];
        console.log('ğŸ“¦ [MultiTab] firstTabData:', firstTabData);

        // ä½¿ç”¨åŒ¿åå‹åˆ¥çš„å±¬æ€§åç¨±ï¼ˆé¦–å­—æ¯å¤§å¯«ï¼‰
        const tabId = firstTabData.Id;
        const apiUrl = firstTabData.ApiUrl;

        // è¨­å®šç¬¬ä¸€å€‹é ç±¤çš„è¾­å…¸è¡¨åçµ¦ F3 ä½¿ç”¨
        if (firstTabData.DictTable) {
            window._dictTableName = firstTabData.DictTable;
        }

        console.log(`ğŸ”„ [MultiTab] é–‹å§‹è¼‰å…¥ç¬¬ä¸€å€‹é ç±¤: ${tabId}`);
        console.log(`ğŸ“ [MultiTab] API URL: ${apiUrl}?PaperNum=${paperNum}`);

        const contentPane = document.getElementById(`content-${tabId}`);
        console.log('ğŸ“¦ [MultiTab] contentPane:', contentPane);

        if (!contentPane) {
            console.error(`âŒ [MultiTab] æ‰¾ä¸åˆ° contentPane: content-${tabId}`);
            return;
        }

        if (loadedTabs.has(tabId)) {
            console.log(`â„¹ï¸ [MultiTab] é ç±¤ ${tabId} å·²è¼‰å…¥ï¼Œè·³é`);
            return;
        }

        const loading = contentPane.querySelector('.loading-indicator');
        const container = contentPane.querySelector('.table-container');
        loading.style.display = 'block';

        // æ¸…é™¤èˆŠçš„è¡¨æ ¼ï¼ˆä¿ç•™æŒ‰éˆ•ï¼‰
        const existingTable = container.querySelector('.erp-table-wrapper');
        if (existingTable) existingTable.remove();
        const existingAlert = container.querySelector('.alert');
        if (existingAlert) existingAlert.remove();

        const startTime = Date.now();

        try {
            // AJAX è¼‰å…¥è³‡æ–™
            const response = await fetch(`${apiUrl}?PaperNum=${paperNum}`);
            console.log(`ğŸ“¡ [MultiTab] æ”¶åˆ°å›æ‡‰ (${Date.now() - startTime}ms):`, response.status, response.statusText);

            // æª¢æŸ¥ HTTP ç‹€æ…‹
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`âŒ [MultiTab] API éŒ¯èª¤ (${response.status}):`, errorText);
                throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
            }

            // æª¢æŸ¥ Content-Type æ˜¯å¦ç‚º JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('âŒ [MultiTab] å›æ‡‰ä¸æ˜¯ JSON:', text.substring(0, 200));
                throw new Error('API å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ API æ˜¯å¦æ­£å¸¸é‹ä½œ');
            }

            const data = await response.json();
            console.log(`âœ… [MultiTab] è³‡æ–™è¼‰å…¥æˆåŠŸ (${Date.now() - startTime}ms):`, data.length, 'ç­†è³‡æ–™');

            // æ¸²æŸ“è¡¨æ ¼
            await renderTable(container, data, tabId);

            // æ¨™è¨˜ç‚ºå·²è¼‰å…¥
            loadedTabs.add(tabId);
        } catch (error) {
            console.error(`âŒ [MultiTab] è¼‰å…¥åˆ†é  ${tabId} å¤±æ•—:`, error);
            container.insertAdjacentHTML('beforeend', `
                <div class="alert alert-danger m-3">
                    <h5 class="alert-heading">âš ï¸ è¼‰å…¥å¤±æ•—</h5>
                    <p class="mb-0">${error.message}</p>
                    <hr>
                    <small class="text-muted">è«‹æª¢æŸ¥ Console ä»¥æŸ¥çœ‹è©³ç´°éŒ¯èª¤è¨Šæ¯</small>
                </div>`);
        } finally {
            loading.style.display = 'none';
            console.log(`ğŸ [MultiTab] è¼‰å…¥å®Œæˆ (${Date.now() - startTime}ms)`);
        }
    }

    // ä½¿ç”¨ setTimeout ç¢ºä¿ DOM å®Œå…¨å°±ç·’å¾ŒåŸ·è¡Œ
    setTimeout(() => loadFirstTab(), 100);

    // ========== æ–°å¢/åˆªé™¤åˆ—åŠŸèƒ½ ==========

    // ä½¿ç”¨äº‹ä»¶å§”æ´¾ç¶å®šæ–°å¢æŒ‰éˆ•ï¼ˆå› ç‚ºæŒ‰éˆ•æ˜¯å‹•æ…‹ç”Ÿæˆçš„ï¼‰
    document.addEventListener('click', async function(e) {
        if (!e.target.classList.contains('btn-add-row')) return;

        const btn = e.target;
        const tabId = btn.dataset.tabId;
        const tabPane = document.getElementById(`content-${tabId}`);
        const container = tabPane.querySelector('.table-container');
        const tbody = container.querySelector('tbody');

        if (!tbody) {
            Swal.fire({
                icon: 'error',
                title: 'éŒ¯èª¤',
                text: 'æ‰¾ä¸åˆ°è¡¨æ ¼å…§å®¹'
            });
            return;
        }

        // å–å¾—è©²åˆ†é çš„ API URL
        const tabButton = document.querySelector(`[data-bs-target="#content-${tabId}"]`);
        const apiUrl = tabButton.dataset.apiUrl;

        // å»ºç«‹æ–°åˆ—ï¼ˆæš«æ™‚åœ¨å‰ç«¯æ–°å¢ï¼Œé‚„æ²’å„²å­˜åˆ°è³‡æ–™åº«ï¼‰
        const dict = fieldDicts[tabId] || {};
        const fields = Object.keys(dict).length > 0 ? Object.keys(dict) : [];

        if (fields.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'ç„¡æ³•å–å¾—æ¬„ä½è³‡è¨Š',
                text: 'è«‹ç¢ºèªè³‡æ–™å­—å…¸è¨­å®šæ˜¯å¦æ­£ç¢º'
            });
            return;
        }

        // è¨ˆç®—æ–°çš„ Item ç·¨è™Ÿ
        const rows = tbody.querySelectorAll('tr');
        let maxItem = 0;
        rows.forEach(row => {
            const item = parseInt(row.dataset.item) || 0;
            if (item > maxItem) maxItem = item;
        });
        const newItem = maxItem + 1;

        // å»ºç«‹æ–°åˆ— HTML
        let html = `<tr data-paper-num="${paperNum}" data-item="${newItem}" data-state="added" class="row-selected">`;
        fields.forEach(field => {
            html += `<td><span class="cell-view"></span></td>`;
        });
        html += '</tr>';

        // ç§»é™¤å…¶ä»–åˆ—çš„é¸å–ç‹€æ…‹
        tbody.querySelectorAll('tr.row-selected').forEach(r => r.classList.remove('row-selected'));

        // æ’å…¥æ–°åˆ—
        tbody.insertAdjacentHTML('beforeend', html);

        // ç¶å®šæ–°åˆ—çš„é»æ“Šäº‹ä»¶
        const newRow = tbody.querySelector('tr:last-child');
        newRow.addEventListener('click', function() {
            tbody.querySelectorAll('tr.row-selected').forEach(r => r.classList.remove('row-selected'));
            this.classList.add('row-selected');
        });

        console.log(`âœ… æ–°å¢åˆ—: ${tabId}, Item: ${newItem}`);
    });

    // ä½¿ç”¨äº‹ä»¶å§”æ´¾ç¶å®šåˆªé™¤æŒ‰éˆ•ï¼ˆå› ç‚ºæŒ‰éˆ•æ˜¯å‹•æ…‹ç”Ÿæˆçš„ï¼‰
    document.addEventListener('click', async function(e) {
        if (!e.target.classList.contains('btn-delete-row')) return;

        const btn = e.target;
        const tabId = btn.dataset.tabId;
        const tabPane = document.getElementById(`content-${tabId}`);
        const container = tabPane.querySelector('.table-container');
        const tbody = container.querySelector('tbody');

        if (!tbody) {
            Swal.fire({
                icon: 'error',
                title: 'éŒ¯èª¤',
                text: 'æ‰¾ä¸åˆ°è¡¨æ ¼å…§å®¹'
            });
            return;
        }

        const selectedRow = tbody.querySelector('tr.row-selected');
        if (!selectedRow) {
            Swal.fire({
                icon: 'info',
                title: 'è«‹å…ˆé¸å–è¦åˆªé™¤çš„åˆ—'
            });
            return;
        }

        const paperNum = selectedRow.dataset.paperNum;
        const item = selectedRow.dataset.item;
        const state = selectedRow.dataset.state;

        // ä½¿ç”¨ SweetAlert2 ç¢ºèªå°è©±æ¡†
        const { isConfirmed } = await Swal.fire({
            icon: 'question',
            title: 'ç¢ºå®šè¦åˆªé™¤é€™ä¸€ç­†æ˜ç´°ï¼Ÿ',
            text: `é …æ¬¡ï¼š${item}`,
            showCancelButton: true,
            confirmButtonText: 'åˆªé™¤',
            cancelButtonText: 'å–æ¶ˆ',
            confirmButtonColor: '#dc3545'
        });

        if (!isConfirmed) {
            return;
        }

        // å¦‚æœæ˜¯æ–°å¢ä½†æœªå„²å­˜çš„åˆ—ï¼Œç›´æ¥ç§»é™¤
        if (state === 'added') {
            const next = selectedRow.nextElementSibling || selectedRow.previousElementSibling;
            selectedRow.remove();
            if (next) next.classList.add('row-selected');
            console.log(`âœ… åˆªé™¤æœªå„²å­˜çš„åˆ—: Item ${item}`);
            return;
        }

        // å·²å„²å­˜çš„åˆ—ï¼Œå‘¼å« API åˆªé™¤
        try {
            const tabButton = document.querySelector(`[data-bs-target="#content-${tabId}"]`);
            const apiUrl = tabButton.dataset.apiUrl;

            // å¾ apiUrl å–å¾—è³‡æ–™è¡¨åç¨±ï¼Œä¾‹å¦‚ /api/FmedIssueMat -> FmedIssueMat
            const tableName = apiUrl.split('/').pop();

            const deleteUrl = `/api/${tableName}/${encodeURIComponent(paperNum)}/${encodeURIComponent(item)}`;

            console.log(`ğŸ—‘ï¸ åˆªé™¤ API: ${deleteUrl}`);

            const response = await fetch(deleteUrl, { method: 'DELETE' });

            if (!response.ok) {
                // å˜—è©¦è§£æå¾Œç«¯çš„éŒ¯èª¤è¨Šæ¯
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const errorData = await response.json();
                    if (errorData && errorData.error) {
                        errorMessage = errorData.error;
                    }
                } catch (e) {
                    // å¦‚æœä¸æ˜¯ JSON æ ¼å¼ï¼Œå˜—è©¦è®€å–ç´”æ–‡å­—
                    try {
                        const errorText = await response.text();
                        if (errorText) errorMessage = errorText;
                    } catch (e2) {
                        // ä¿æŒåŸæœ¬çš„éŒ¯èª¤è¨Šæ¯
                    }
                }
                throw new Error(errorMessage);
            }

            const next = selectedRow.nextElementSibling || selectedRow.previousElementSibling;
            selectedRow.remove();
            if (next) next.classList.add('row-selected');

            console.log(`âœ… åˆªé™¤æˆåŠŸ: Item ${item}`);
            Swal.fire({
                icon: 'success',
                title: 'åˆªé™¤å®Œæˆ',
                timer: 1500,
                showConfirmButton: false
            });
        } catch (error) {
            console.error('åˆªé™¤å¤±æ•—:', error);
            Swal.fire({
                icon: 'error',
                title: 'åˆªé™¤å¤±æ•—',
                text: error.message,
                confirmButtonText: 'ç¢ºå®š'
            });
        }
    });
})();
</script>

<style>
.multi-tab-detail {
    padding: 1rem 0;
}

.multi-tab-detail .nav-tabs {
    border-bottom: 2px solid #dee2e6;
}

.multi-tab-detail .nav-link {
    color: #495057;
    border: none;
    border-bottom: 3px solid transparent;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s;
}

.multi-tab-detail .nav-link:hover {
    background-color: #f8f9fa;
    border-bottom-color: #6c757d;
}

.multi-tab-detail .nav-link.active {
    color: #0d6efd;
    background-color: transparent;
    border-bottom-color: #0d6efd;
    font-weight: 600;
}

.multi-tab-detail .table-container {
    margin-top: 1rem;
}

/* erp-table å®Œæ•´æ¨£å¼ */
.multi-tab-detail .erp-table-wrapper {
    background: #fff;
    box-shadow: 0 4px 18px 0 #c3d4e6;
    max-width: 1400px;
    overflow-x: auto;
    padding: 8px !important;
    border-radius: 0 0 13px 13px;
    border: 1px solid #d6dbe5;
    max-height: 600px;
}

.multi-tab-detail .erp-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 1.06em;
    background: #fff;
    table-layout: fixed; /* æ¬„å¯¬æ‹–æ›³éœ€å›ºå®šå¸ƒå±€ */
}

.multi-tab-detail .erp-table thead tr {
    background: #e7ecf3;
}

.multi-tab-detail .erp-table th,
.multi-tab-detail .erp-table td {
    background: #f1f5fb;
    padding: 7px 12px;
    border-bottom: 1px solid #c5d1e4;
    white-space: nowrap;
    text-align: center;
    font-weight: 500;
    border-right: 1px solid #dde4ed;
    height: 34px;
}

.multi-tab-detail .erp-table th:last-child,
.multi-tab-detail .erp-table td:last-child {
    border-right: none;
}

.multi-tab-detail .erp-table th {
    color: #124d8b;
    font-weight: 700;
    font-size: 1.05em;
    letter-spacing: 1px;
    background: #e7ecf3;
    position: sticky;
    top: 0;
    z-index: 10;
}

.multi-tab-detail .erp-table th { position: relative; }
.multi-tab-detail .erp-table th .col-resizer{
    position: absolute;
    top: 0; right: 0; bottom: 0;
    width: 8px;
    cursor: col-resize;
    user-select: none;
    z-index: 20;
}
.multi-tab-detail .erp-table th.resizing,
.multi-tab-detail .erp-table td.resizing,
body.resizing { cursor: col-resize !important; }

.multi-tab-detail .erp-table tbody tr:nth-child(even) {
    background: #f6f9fd;
}

.multi-tab-detail .erp-table tbody tr:hover {
    background: #eef7ff;
}

.multi-tab-detail .erp-table td {
    position: relative;
    padding: 0;
}

.multi-tab-detail .erp-table td .cell-view {
    display: inline-block;
    width: 100%;
    text-align: inherit;
    padding: 7px 12px;
}

/* é¸å–åˆ—çš„æ¨£å¼ */
.multi-tab-detail .erp-table tbody tr {
    cursor: pointer;
}

.multi-tab-detail .erp-table tbody tr.row-selected {
    background-color: #d1e7ff !important;
    border-left: 3px solid #0d6efd;
}

.multi-tab-detail .erp-table tbody tr.row-selected td {
    background-color: #d1e7ff !important;
}

/* æ–°å¢ä½†æœªå„²å­˜çš„åˆ— */
.multi-tab-detail .erp-table tbody tr[data-state="added"] {
    background-color: #fff3cd !important;
}

.multi-tab-detail .erp-table tbody tr[data-state="added"] td {
    background-color: #fff3cd !important;
}
</style>
