@model dynamic
@{
    var paperNum = ViewData["PaperNum"]?.ToString() ?? "";
    var tabs = ViewData["Tabs"] as dynamic[] ?? Array.Empty<dynamic>();
    var tabFieldDicts = ViewData["TabFieldDicts"] as Dictionary<string, Dictionary<string, string>> ?? new();
    var allowEdit = (ViewData["MultiTabAllowEdit"] as bool?) ?? true;
}

<!-- SweetAlert2 引入 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- 多分頁容器 -->
<div class="multi-tab-detail">
    <!-- Tab 標籤列 -->
    <ul class="nav nav-tabs" role="tablist">
        @for (int i = 0; i < tabs.Length; i++)
        {
            var tab = tabs[i];
            var isActive = i == 0 ? "active" : "";
            <li class="nav-item" role="presentation">
                <button class="nav-link @isActive"
                        id="tab-@tab.Id"
                        data-bs-toggle="tab"
                        data-bs-target="#content-@tab.Id"
                        data-api-url="@tab.ApiUrl"
                        data-tab-id="@tab.Id"
                        type="button"
                        role="tab">
                    @tab.Title
                </button>
            </li>
        }
    </ul>

    <!-- Tab 內容區 -->
    <div class="tab-content mt-3">
        @for (int i = 0; i < tabs.Length; i++)
        {
            var tab = tabs[i];
            var isActive = i == 0 ? "show active" : "";
            <div class="tab-pane fade @isActive"
                 id="content-@tab.Id"
                 role="tabpanel">
         
                <div class="loading-indicator text-center py-5" style="display:@(i == 0 ? "block" : "none");">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">載入中...</p>
                </div>
                <div class="table-container" data-tab-id="@tab.Id" data-dict-table="@tab.DictTable">
                
                </div>
            </div>
        }
    </div>
</div>

<script>
(function() {
    const paperNum = '@paperNum';
    const allowEdit = @(allowEdit ? "true" : "false");
    const loadedTabs = new Set();
    const fieldDicts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(tabFieldDicts));
    const tabsData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(tabs));

    function cleanTableName(t) {
        return (t || '').toString().replace(/^dbo\./i, '').trim().toLowerCase();
    }

    function getDictTableOfTab(container, tabId) {
        return (container?.dataset?.dictTable || tabsData?.find(x => x?.Id === tabId)?.DictTable || '').toString();
    }

    function withPaperNum(apiUrl) {
        const base = (apiUrl || '').toString();
        const sep = base.includes('?') ? '&' : '?';
        return `${base}${sep}PaperNum=${encodeURIComponent(paperNum)}`;
    }

    // Dict meta cache (datatype/format/width...)
    const DICT_META_CACHE = new Map(); // tn -> Map(fieldLower -> { dataType, formatStr })

    async function fetchDictMeta(dictTable) {
        const tn = cleanTableName(dictTable);
        if (!tn) return new Map();
        if (DICT_META_CACHE.has(tn)) return DICT_META_CACHE.get(tn);
        try {
            const res = await fetch(`/api/TableFieldLayout/DictFields?table=${encodeURIComponent(tn)}&lang=TW`);
            if (!res.ok) {
                const empty = new Map();
                DICT_META_CACHE.set(tn, empty);
                return empty;
            }
            const rows = await res.json();
            const map = new Map();
            (rows || []).forEach(r => {
                const field = (r.fieldName || r.FieldName || '').toString();
                if (!field) return;
                map.set(field.toLowerCase(), {
                    dataType: (r.dataType || r.DataType || '').toString(),
                    formatStr: (r.formatStr || r.FormatStr || '').toString(),
                    comboStyle: Number(r.comboStyle ?? r.ComboStyle ?? 0)
                });
            });
            DICT_META_CACHE.set(tn, map);
            return map;
        } catch {
            const empty = new Map();
            DICT_META_CACHE.set(tn, empty);
            return empty;
        }
    }

    function escapeHtml(v) {
        return String(v ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function extractRowData(tr) {
        try {
            if (!tr) return null;
            const obj = {};
            tr.querySelectorAll('input.cell-edit[data-field]').forEach(inp => {
                const f = (inp.dataset.field || '').toString();
                if (!f) return;
                if (inp.type === 'checkbox') obj[f] = inp.checked ? '1' : '0';
                else obj[f] = inp.value;
            });
            if (tr.dataset && tr.dataset.paperNum && obj.PaperNum === undefined) obj.PaperNum = tr.dataset.paperNum;
            if (tr.dataset && tr.dataset.item && obj.Item === undefined) obj.Item = tr.dataset.item;
            return obj;
        } catch {
            return null;
        }
    }

    function pad2(n) { return String(n).padStart(2, '0'); }

    function tryParseDate(raw) {
        if (raw == null || raw === '') return null;
        if (raw instanceof Date && !isNaN(raw)) return raw;
        const s = String(raw).trim();
        if (!s) return null;
        const d = new Date(s);
        return isNaN(d) ? null : d;
    }

    function parseDecimalsFromFormat(fmt) {
        const s = (fmt || '').toString();
        const dot = s.lastIndexOf('.');
        if (dot < 0) return null;
        const tail = s.slice(dot + 1);
        const m = tail.match(/0+/);
        if (!m) return Math.min(6, tail.length);
        return Math.min(8, m[0].length);
    }

    function formatCellValue(raw, meta) {
        if (raw == null) return '';
        const s = String(raw);
        if (s === '') return '';

        const dataType = (meta?.dataType || '').toLowerCase();
        const fmt = (meta?.formatStr || '').toLowerCase();

        // Date / DateTime -> show date only (yyyy/MM/dd)
        if (dataType.includes('date') || fmt.includes('yyyy/mm/dd') || fmt.includes('yyyy-mm-dd')) {
            const d = tryParseDate(raw);
            if (!d) return s;
            return `${d.getFullYear()}/${pad2(d.getMonth() + 1)}/${pad2(d.getDate())}`;
        }

        // Number formatting
        if (dataType.includes('int') || dataType.includes('decimal') || dataType.includes('numeric') || dataType.includes('money') || dataType.includes('float') || dataType.includes('real')) {
            const n = Number(String(raw).replace(/,/g, ''));
            if (!Number.isFinite(n)) return s;
            const decimals = parseDecimalsFromFormat(meta?.formatStr);
            if (decimals != null) return n.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
            return n.toLocaleString();
        }

        return s;
    }

    async function fetchFieldWidths(dictTable) {
        const tn = cleanTableName(dictTable);
        if (!tn) return new Map();
        try {
            const res = await fetch(`/api/TableFieldLayout/DictFields?table=${encodeURIComponent(tn)}&lang=TW`);
            if (!res.ok) return new Map();
            const rows = await res.json();
            const map = new Map();
            (rows || []).forEach(r => {
                const field = (r.fieldName || r.FieldName || '').toString();
                const w = r.fieldWidth ?? r.FieldWidth;
                const ds = r.displaySize ?? r.DisplaySize;
                if (!field) return;
                const px = Number.isFinite(w) ? Number(w) : (Number.isFinite(ds) ? Number(ds) * 10 : null);
                if (px && px > 0) map.set(field.toLowerCase(), Math.round(px));
            });
            return map;
        } catch {
            return new Map();
        }
    }

    function applyColumnWidth(table, ths, index, width) {
        const w = Math.max(30, Math.round(width));
        const th = ths[index];
        if (!th) return;
        th.style.width = `${w}px`;
        Array.from(table.querySelectorAll(`tbody tr td:nth-child(${index + 1})`)).forEach(td => td.style.width = `${w}px`);
    }

    function applySavedWidths(table, dictTable, fields) {
        const tn = cleanTableName(dictTable);
        if (!tn) return;
        try {
            const raw = localStorage.getItem(`colwidth:${tn}`);
            if (!raw) return;
            const cols = JSON.parse(raw) || [];
            const ths = Array.from(table.querySelectorAll('thead th'));
            cols.forEach(c => {
                const f = (c.fieldName || '').toString();
                const w = Number(c.width);
                if (!f || !Number.isFinite(w)) return;
                const idx = fields.findIndex(x => x.toLowerCase() === f.toLowerCase());
                if (idx >= 0) applyColumnWidth(table, ths, idx, w);
            });
        } catch {}
    }

    // 欄寬拖曳狀態（全頁共用一次，避免每個 tab 重複掛 document 事件）
    const resizeState = {
        active: false,
        table: null,
        ths: [],
        dictTable: '',
        thIndex: -1,
        startX: 0,
        startWidth: 0,
        saveTimer: null
    };
    async function persistWidths(snapshot) {
        const table = snapshot?.table;
        const ths = snapshot?.ths || [];
        const dictTable = snapshot?.dictTable || '';
        const tn = cleanTableName(dictTable);
        if (!table || !ths.length || !tn) return;
        try {
            const payload = {
                tableName: tn,
                cols: ths.map(th => ({ fieldName: th.dataset.field, width: Math.round(th.getBoundingClientRect().width) }))
            };
            await fetch('/api/TableFieldLayout/SaveDetailLayout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(() => {});
            localStorage.setItem(`colwidth:${tn}`, JSON.stringify(payload.cols));
        } catch {}
    }
    function debouncePersist(snapshot) {
        clearTimeout(resizeState.saveTimer);
        const snap = snapshot ? { ...snapshot } : null;
        resizeState.saveTimer = setTimeout(() => persistWidths(snap), 400);
    }
    document.addEventListener('mousemove', (e) => {
        if (!resizeState.active || !resizeState.table) return;
        const dx = e.pageX - resizeState.startX;
        const newW = Math.max(30, resizeState.startWidth + dx);
        applyColumnWidth(resizeState.table, resizeState.ths, resizeState.thIndex, newW);
    });
    document.addEventListener('mouseup', () => {
        if (!resizeState.active) return;
        resizeState.active = false;
        document.body.classList.remove('resizing');
        resizeState.ths.forEach(th => th.classList.remove('resizing'));
        Array.from(resizeState.table.querySelectorAll('tbody td.resizing')).forEach(td => td.classList.remove('resizing'));
        // 用 snapshot 避免先清空 state 導致儲存失效
        debouncePersist({ table: resizeState.table, ths: resizeState.ths, dictTable: resizeState.dictTable });
        resizeState.table = null;
        resizeState.ths = [];
        resizeState.dictTable = '';
        resizeState.thIndex = -1;
    });

    function initColumnResize(table, dictTable, fields) {
        if (!table) return;
        const ths = Array.from(table.querySelectorAll('thead th'));
        ths.forEach((th, idx) => {
            const handle = th.querySelector('.col-resizer');
            if (!handle) return;
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                resizeState.active = true;
                resizeState.table = table;
                resizeState.ths = ths;
                resizeState.dictTable = dictTable;
                resizeState.thIndex = idx;
                resizeState.startX = e.pageX;
                resizeState.startWidth = th.getBoundingClientRect().width;
                document.body.classList.add('resizing');
                th.classList.add('resizing');
                Array.from(table.querySelectorAll(`tbody tr td:nth-child(${idx + 1})`)).forEach(td => td.classList.add('resizing'));
            });
        });
    }

    // 暴露為全域變數方便除錯
    window._debugFieldDicts = fieldDicts;
    window._debugTabsData = tabsData;

    // Tab 切換事件
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', async function(e) {
            const tabId = this.dataset.tabId;
            const apiUrl = this.dataset.apiUrl;
            const contentPane = document.getElementById(`content-${tabId}`);

            // 取得容器元素
            const container = contentPane.querySelector('.table-container');

            // 更新當前辭典表名稱給 F3 使用
            if (container && container.dataset.dictTable) {
                window._dictTableName = container.dataset.dictTable;
            }

            // 如果已經載入過,直接顯示
            if (loadedTabs.has(tabId)) {
                return;
            }

            // 顯示載入中
            const loading = contentPane.querySelector('.loading-indicator');
            loading.style.display = 'block';

            // 清除舊的表格（保留按鈕）
            const existingTable = container.querySelector('.erp-table-wrapper');
            if (existingTable) existingTable.remove();
            const existingAlert = container.querySelector('.alert');
            if (existingAlert) existingAlert.remove();

            try {
                // AJAX 載入資料
                const response = await fetch(withPaperNum(apiUrl));

                // 檢查 HTTP 狀態
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`API 錯誤 (${response.status}):`, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                }

                // 檢查 Content-Type 是否為 JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('回應不是 JSON:', text.substring(0, 200));
                    throw new Error('API 回應格式錯誤，請檢查 API 是否正常運作');
                }

                const data = await response.json();

                // 渲染表格
                await renderTable(container, data, tabId);

                // 標記為已載入
                loadedTabs.add(tabId);
            } catch (error) {
                console.error(`載入分頁 ${tabId} 失敗:`, error);
                container.insertAdjacentHTML('beforeend', `<div class="alert alert-danger">載入失敗: ${error.message}</div>`);
            } finally {
                loading.style.display = 'none';
            }
        });
    });

    // 渲染表格函式
    async function renderTable(container, data, tabId) {
        // ✅ 先清除舊的 alert，避免重複顯示「無資料」
        const existingAlerts = container.querySelectorAll('.alert');
        existingAlerts.forEach(a => a.remove());

        if (!Array.isArray(data) || data.length === 0) {
            container.insertAdjacentHTML('beforeend', '<div class="alert alert-info">無資料</div>');
            return;
        }

        const dict = fieldDicts[tabId] || {};
        const dictTable = getDictTableOfTab(container, tabId);
        const metaMap = await fetchDictMeta(dictTable);



        // 只顯示字典中有的欄位（Visible == 1 的欄位）
        // 如果字典為空，則顯示所有欄位（向後兼容）
        const allFields = Object.keys(data[0]);

        const fields = Object.keys(dict).length > 0
            ? Object.keys(dict).filter(f => allFields.includes(f))  // 只顯示字典中且資料有的欄位
            : allFields;  // 如果沒有字典，顯示所有欄位


        if (fields.length === 0) {
            container.insertAdjacentHTML('beforeend', '<div class="alert alert-warning">沒有可顯示的欄位</div>');
            return;
        }

        // 建立表格 - 使用 erp-table 樣式
        let html = '<div class="erp-table-wrapper">';

        if (allowEdit) {
            // +- 按鈕放在 wrapper 內部
            html += `
                <div class="d-flex justify-content-start mb-2 tab-action-buttons">
                    <button type="button" class="btn btn-outline-secondary btn-sm btn-add-row" data-tab-id="${tabId}">
                        ＋
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm ms-1 btn-delete-row" data-tab-id="${tabId}" title="刪除當前列">
                        －
                    </button>
                </div>
            `;
        }

        html += '<table class="erp-table"><thead><tr>';

        // 表頭 - 使用字典取得中文名稱
        fields.forEach(field => {
            const displayName = dict[field] || field;
            html += `<th data-field="${field}" style="position:relative;"><span class="th-text">${displayName}</span><span class="col-resizer" draggable="false"></span></th>`;
        });
        html += '</tr></thead><tbody>';

        // 表身
        data.forEach((row, index) => {
            const paperNum = row.PaperNum || row.paperNum || '';
            const item = row.Item || row.item || index + 1;
            html += `<tr data-paper-num="${paperNum}" data-item="${item}" data-state="unchanged">`;
            fields.forEach(field => {
                const raw = row[field] ?? '';
                const meta = metaMap.get(field.toLowerCase());
                const value = formatCellValue(raw, meta);
                // ✅ 雙元素：顯示模式 + 編輯模式
                html += `<td>
                    <span class="cell-view">${escapeHtml(value)}</span>
                    <input type="text"
                           class="cell-edit d-none"
                           data-field="${field}"
                           value="${escapeHtml(raw)}">
                </td>`;
            });
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        container.insertAdjacentHTML('beforeend', html);

        // 依辭典設定把「勾選框(ComboStyle=1)」欄位轉成 checkbox 顯示/編輯
        (function applyCheckboxCells() {
            try {
                const wrapper = container.querySelector('.erp-table-wrapper');
                const table = wrapper?.querySelector('table.erp-table');
                if (!table) return;

                const checkboxIndexes = [];
                fields.forEach((f, idx) => {
                    const meta = metaMap.get(String(f).toLowerCase()) || {};
                    if (Number(meta.comboStyle || 0) === 1) checkboxIndexes.push(idx);
                });
                if (!checkboxIndexes.length) return;

                const rows = Array.from(table.querySelectorAll('tbody tr'));
                rows.forEach(tr => {
                    const tds = Array.from(tr.querySelectorAll('td'));
                    checkboxIndexes.forEach(idx => {
                        const td = tds[idx];
                        if (!td) return;
                        const edit = td.querySelector('input.cell-edit[data-field]');
                        const view = td.querySelector('.cell-view');
                        if (!edit || !view) return;
                        if (edit.type === 'checkbox') return;

                        const raw = (edit.value ?? '').toString().trim().toLowerCase();
                        const checked = raw === '1' || raw === 'true' || raw === 'y' || raw === 'yes';

                        view.innerHTML = `<input type="checkbox" class="cell-view-checkbox" disabled ${checked ? 'checked' : ''}>`;

                        const chk = document.createElement('input');
                        chk.type = 'checkbox';
                        chk.className = edit.className;
                        chk.dataset.field = edit.dataset.field || '';
                        chk.checked = checked;
                        edit.replaceWith(chk);
                    });
                });
            } catch { }
        })();

        const table = container.querySelector('.erp-table-wrapper table.erp-table');
        if (table) {
            applySavedWidths(table, dictTable, fields);
            const widthMap = await fetchFieldWidths(dictTable);
            if (widthMap.size) {
                const ths = Array.from(table.querySelectorAll('thead th'));
                fields.forEach((f, idx) => {
                    const w = widthMap.get(f.toLowerCase());
                    if (w) applyColumnWidth(table, ths, idx, w);
                });
                try {
                    const tn = cleanTableName(dictTable);
                    const cols = fields.map((f, idx) => ({ fieldName: f, width: Math.round(ths[idx].getBoundingClientRect().width) }));
                    localStorage.setItem(`colwidth:${tn}`, JSON.stringify(cols));
                } catch {}
            }
            initColumnResize(table, dictTable, fields);
        }

        // 綁定列選取事件（只綁 tbody，避免點到表頭也被當作選取）
        const tableWrapper = container.querySelector('.erp-table-wrapper');
        if (tableWrapper) {
            const tbody = tableWrapper.querySelector('tbody');
            const rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];
            rows.forEach(tr => {
                tr.addEventListener('click', function() {
                    // 移除其他列的選取狀態
                    tableWrapper.querySelectorAll('tr.row-selected').forEach(r => r.classList.remove('row-selected'));
                    // 選取當前列
                    this.classList.add('row-selected');
                    try {
                        const rowData = extractRowData(this);
                        window.dispatchEvent(new CustomEvent('multiTabRowSelected', { detail: { tabId, rowData } }));
                    } catch {}
                });
            });

            // 需要第三階聯動時：預設自動選取第一筆（例如 Paper3L）
            if (window.__multiTabAutoSelectFirstRow) {
                const hasSelected = !!tableWrapper.querySelector('tbody tr.row-selected');
                const first = tbody ? tbody.querySelector('tr') : null;
                if (!hasSelected && first) {
                    first.classList.add('row-selected');
                    try {
                        const rowData = extractRowData(first);
                        window.dispatchEvent(new CustomEvent('multiTabRowSelected', { detail: { tabId, rowData } }));
                    } catch {}
                }
            }
        }
    }



    // 統一使用 async 函式載入第一個頁籤
    async function loadFirstTab() {
 

        // 直接從 tabsData 取得第一個頁籤資訊（避免 DOM 屬性讀取問題）
        if (!tabsData || tabsData.length === 0) {
            console.error(`❌ [MultiTab] tabsData 為空`);
            return;
        }

        const firstTabData = tabsData[0];
  

        // 使用匿名型別的屬性名稱（首字母大寫）
        const tabId = firstTabData.Id;
        const apiUrl = firstTabData.ApiUrl;

        // 設定第一個頁籤的辭典表名給 F3 使用
        if (firstTabData.DictTable) {
            window._dictTableName = firstTabData.DictTable;
        }

        const contentPane = document.getElementById(`content-${tabId}`);

        if (!contentPane) {
            console.error(`❌ [MultiTab] 找不到 contentPane: content-${tabId}`);
            return;
        }

        if (loadedTabs.has(tabId)) {
            return;
        }

        const loading = contentPane.querySelector('.loading-indicator');
        const container = contentPane.querySelector('.table-container');
        loading.style.display = 'block';

        // 清除舊的表格（保留按鈕）
        const existingTable = container.querySelector('.erp-table-wrapper');
        if (existingTable) existingTable.remove();
        const existingAlert = container.querySelector('.alert');
        if (existingAlert) existingAlert.remove();

        const startTime = Date.now();

        try {
            // AJAX 載入資料
            const response = await fetch(withPaperNum(apiUrl));
        
            // 檢查 HTTP 狀態
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`❌ [MultiTab] API 錯誤 (${response.status}):`, errorText);
                throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
            }

            // 檢查 Content-Type 是否為 JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('❌ [MultiTab] 回應不是 JSON:', text.substring(0, 200));
                throw new Error('API 回應格式錯誤，請檢查 API 是否正常運作');
            }

            const data = await response.json();
        

            // 渲染表格
            await renderTable(container, data, tabId);

            // 標記為已載入
            loadedTabs.add(tabId);
        } catch (error) {
            console.error(`❌ [MultiTab] 載入分頁 ${tabId} 失敗:`, error);
            container.insertAdjacentHTML('beforeend', `
                <div class="alert alert-danger m-3">
                    <h5 class="alert-heading">⚠️ 載入失敗</h5>
                    <p class="mb-0">${error.message}</p>
                    <hr>
                    <small class="text-muted">請檢查 Console 以查看詳細錯誤訊息</small>
                </div>`);
        } finally {
            loading.style.display = 'none';
    
        }
    }

    // 使用 setTimeout 確保 DOM 完全就緒後執行
    setTimeout(() => loadFirstTab(), 100);

    // ========== 新增/刪除列功能 ==========

    // 使用事件委派綁定新增按鈕（因為按鈕是動態生成的）
    document.addEventListener('click', async function(e) {
        if (!allowEdit) return;
        if (!e.target.classList.contains('btn-add-row')) return;

        const btn = e.target;
        const tabId = btn.dataset.tabId;
        const tabPane = document.getElementById(`content-${tabId}`);
        const container = tabPane.querySelector('.table-container');
        const tbody = container.querySelector('tbody');

        if (!tbody) {
            Swal.fire({
                icon: 'error',
                title: '錯誤',
                text: '找不到表格內容'
            });
            return;
        }

        // 取得該分頁的 API URL
        const tabButton = document.querySelector(`[data-bs-target="#content-${tabId}"]`);
        const apiUrl = tabButton.dataset.apiUrl;

        // 建立新列（暫時在前端新增，還沒儲存到資料庫）
        const dict = fieldDicts[tabId] || {};
        const fields = Object.keys(dict).length > 0 ? Object.keys(dict) : [];

        if (fields.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: '無法取得欄位資訊',
                text: '請確認資料字典設定是否正確'
            });
            return;
        }

        // 計算新的 Item 編號
        const rows = tbody.querySelectorAll('tr');
        let maxItem = 0;
        rows.forEach(row => {
            const item = parseInt(row.dataset.item) || 0;
            if (item > maxItem) maxItem = item;
        });
        const newItem = maxItem + 1;

        // 建立新列 HTML
        let html = `<tr data-paper-num="${paperNum}" data-item="${newItem}" data-state="added" class="row-selected">`;
        fields.forEach(field => {
            // ✅ 雙元素：顯示模式 + 編輯模式
            html += `<td>
                <span class="cell-view"></span>
                <input type="text"
                       class="cell-edit d-none"
                       data-field="${field}"
                       value="">
            </td>`;
        });
        html += '</tr>';

        // 移除其他列的選取狀態
        tbody.querySelectorAll('tr.row-selected').forEach(r => r.classList.remove('row-selected'));

        // 插入新列
        tbody.insertAdjacentHTML('beforeend', html);

        // 綁定新列的點擊事件
        const newRow = tbody.querySelector('tr:last-child');
        newRow.addEventListener('click', function() {
            tbody.querySelectorAll('tr.row-selected').forEach(r => r.classList.remove('row-selected'));
            this.classList.add('row-selected');
            try {
                const rowData = extractRowData(this);
                window.dispatchEvent(new CustomEvent('multiTabRowSelected', { detail: { tabId, rowData } }));
            } catch {}
        });


    });

    // 使用事件委派綁定刪除按鈕（因為按鈕是動態生成的）
    document.addEventListener('click', async function(e) {
        if (!allowEdit) return;
        if (!e.target.classList.contains('btn-delete-row')) return;

        const btn = e.target;
        const tabId = btn.dataset.tabId;
        const tabPane = document.getElementById(`content-${tabId}`);
        const container = tabPane.querySelector('.table-container');
        const tbody = container.querySelector('tbody');

        if (!tbody) {
            Swal.fire({
                icon: 'error',
                title: '錯誤',
                text: '找不到表格內容'
            });
            return;
        }

        const selectedRow = tbody.querySelector('tr.row-selected');
        if (!selectedRow) {
            Swal.fire({
                icon: 'info',
                title: '請先選取要刪除的列'
            });
            return;
        }

        const paperNum = selectedRow.dataset.paperNum;
        const item = selectedRow.dataset.item;
        const state = selectedRow.dataset.state;

        // 使用 SweetAlert2 確認對話框
        const { isConfirmed } = await Swal.fire({
            icon: 'question',
            title: '確定要刪除這一筆明細？',
            text: `項次：${item}`,
            showCancelButton: true,
            confirmButtonText: '刪除',
            cancelButtonText: '取消',
            confirmButtonColor: '#dc3545'
        });

        if (!isConfirmed) {
            return;
        }

        // 如果是新增但未儲存的列，直接移除
        if (state === 'added') {
            const next = selectedRow.nextElementSibling || selectedRow.previousElementSibling;
            selectedRow.remove();
            if (next) next.classList.add('row-selected');
          
            return;
        }

        // 已儲存的列，呼叫 API 刪除
        try {
            const tabButton = document.querySelector(`[data-bs-target="#content-${tabId}"]`);
            const apiUrl = tabButton.dataset.apiUrl;

            // 從 apiUrl 取得資料表名稱，例如 /api/FmedIssueMat -> FmedIssueMat
            const tableName = apiUrl.split('/').pop();

            const deleteUrl = `/api/${tableName}/${encodeURIComponent(paperNum)}/${encodeURIComponent(item)}`;


            const response = await fetch(deleteUrl, { method: 'DELETE' });

            if (!response.ok) {
                // 嘗試解析後端的錯誤訊息
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const errorData = await response.json();
                    if (errorData && errorData.error) {
                        errorMessage = errorData.error;
                    }
                } catch (e) {
                    // 如果不是 JSON 格式，嘗試讀取純文字
                    try {
                        const errorText = await response.text();
                        if (errorText) errorMessage = errorText;
                    } catch (e2) {
                        // 保持原本的錯誤訊息
                    }
                }
                throw new Error(errorMessage);
            }

            const next = selectedRow.nextElementSibling || selectedRow.previousElementSibling;
            selectedRow.remove();
            if (next) next.classList.add('row-selected');

 
            Swal.fire({
                icon: 'success',
                title: '刪除完成',
                timer: 1500,
                showConfirmButton: false
            });
        } catch (error) {
            console.error('刪除失敗:', error);
            Swal.fire({
                icon: 'error',
                title: '刪除失敗',
                text: error.message,
                confirmButtonText: '確定'
            });
        }
    });
})();
</script>

<style>
.multi-tab-detail {
    /* 單頭/單身間距：縮小上方留白 */
    padding: .05rem 0 0;
}

.multi-tab-detail .nav-tabs {
    border-bottom: 2px solid #dee2e6;
}

.multi-tab-detail .nav-link {
    color: #495057;
    border: none;
    border-bottom: 3px solid transparent;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s;
}

.multi-tab-detail .nav-link:hover {
    background-color: #f8f9fa;
    border-bottom-color: #6c757d;
}

.multi-tab-detail .nav-link.active {
    color: #0d6efd;
    background-color: transparent;
    border-bottom-color: #0d6efd;
    font-weight: 600;
}

.multi-tab-detail .table-container {
    margin-top: .2rem;
}

/* erp-table 完整樣式 */
.multi-tab-detail .erp-table-wrapper {
    background: #fff;
    box-shadow: 0 4px 18px 0 #c3d4e6;
    max-width: 1400px;
    overflow-x: auto;
    padding: 8px !important;
    border-radius: 0 0 13px 13px;
    border: 1px solid #d6dbe5;
    max-height: 600px;
}

.multi-tab-detail .erp-table {
    /* 欄位少時不要硬撐滿容器寬度：依欄寬縮排，容器保留空白 */
    width: max-content;
    display: inline-table;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 1.06em;
    background: #fff;
    table-layout: fixed; /* 欄寬拖曳需固定布局 */
}

.multi-tab-detail .erp-table thead tr {
    background: #e7ecf3;
}

.multi-tab-detail .erp-table th,
.multi-tab-detail .erp-table td {
    background: #f1f5fb;
    padding: 0;  /* ← 改為 0，由內部元素控制 padding */
    border-bottom: 1px solid #c5d1e4;
    white-space: nowrap;
    text-align: center;
    font-weight: 500;
    border-right: 1px solid #dde4ed;
    height: 34px;
}

.multi-tab-detail .erp-table th:last-child,
.multi-tab-detail .erp-table td:last-child {
    border-right: none;
}

.multi-tab-detail .erp-table th {
    color: #124d8b;
    font-weight: 700;
    font-size: 1.05em;
    letter-spacing: 1px;
    background: #e7ecf3;
    position: sticky;
    top: 0;
    z-index: 10;
}

.multi-tab-detail .erp-table th { position: relative; }
.multi-tab-detail .erp-table th .col-resizer{
    position: absolute;
    top: 0; right: 0; bottom: 0;
    width: 8px;
    cursor: col-resize;
    user-select: none;
    z-index: 20;
}
.multi-tab-detail .erp-table th.resizing,
.multi-tab-detail .erp-table td.resizing,
body.resizing { cursor: col-resize !important; }

.multi-tab-detail .erp-table tbody tr:nth-child(even) {
    background: #f6f9fd;
}

.multi-tab-detail .erp-table tbody tr:hover {
    background: #eef7ff;
}

.multi-tab-detail .erp-table td {
    position: relative;
    padding: 0;
}

/* ✅ 檢視模式的 span 樣式 */
.multi-tab-detail .erp-table td .cell-view {
    display: block;  /* ← 改用 block，讓它填滿整個 td */
    width: 100%;
    min-height: 34px;  /* ← 最小高度確保一致 */
    text-align: inherit;
    padding: 7px 12px;
    box-sizing: border-box;
    white-space: nowrap;
    line-height: 20px;  /* ← 固定行高 */
}

/* ✅ 編輯模式的 input 樣式（融入表格，與 SpodOrderSub 一致） */
.multi-tab-detail .erp-table td {
    position: relative;
}

.multi-tab-detail .erp-table .cell-edit {
    display: block;  /* ← 改用 block，與 .cell-view 一致 */
    width: 100% !important;
    min-height: 34px;  /* ← 與 .cell-view 相同的最小高度 */
    box-sizing: border-box;
    margin: 0;
    border: none;
    border-radius: 0;
    background: #fff !important;
    font-size: inherit !important;
    font-weight: inherit !important;
    font-family: inherit !important;
    line-height: 20px !important;  /* ← 與 .cell-view 相同的行高 */
    text-align: inherit !important;
    padding: 7px 12px;  /* ← 與 .cell-view 完全相同的 padding */
    white-space: nowrap;
}

.multi-tab-detail .erp-table .cell-edit:focus {
    outline: 2px solid #0d6efd;
    outline-offset: -2px;
    background: #fffef0 !important;  /* ← focus 時淡黃色背景 */
}

.multi-tab-detail .cell-view-checkbox{
    transform: scale(1.05);
    pointer-events: none;
}

/* 選取列的樣式 */
.multi-tab-detail .erp-table tbody tr {
    cursor: pointer;
}

.multi-tab-detail .erp-table tbody tr.row-selected {
    background-color: #d1e7ff !important;
    border-left: 3px solid #0d6efd;
}

.multi-tab-detail .erp-table tbody tr.row-selected td {
    background-color: #d1e7ff !important;
}

/* 新增但未儲存的列 */
.multi-tab-detail .erp-table tbody tr[data-state="added"] {
    background-color: #fff3cd !important;
}

.multi-tab-detail .erp-table tbody tr[data-state="added"] td {
    background-color: #fff3cd !important;
}

/* ✅ 已修改但未儲存的列 */
.multi-tab-detail .erp-table tbody tr[data-state="modified"] {
    background-color: #e7f3ff !important;
}

.multi-tab-detail .erp-table tbody tr[data-state="modified"] td {
    background-color: #e7f3ff !important;
}
</style>
