@model dynamic
@{
    var paperNum = ViewData["PaperNum"]?.ToString() ?? "";
    var tabs = ViewData["Tabs"] as List<(string Id, string Title, string ApiUrl)> ?? new();
    var tabFieldDicts = ViewData["TabFieldDicts"] as Dictionary<string, Dictionary<string, string>> ?? new();
}

<!-- 多分頁容器 -->
<div class="multi-tab-detail">
    <!-- Tab 標籤列 -->
    <ul class="nav nav-tabs" role="tablist">
        @for (int i = 0; i < tabs.Count; i++)
        {
            var tab = tabs[i];
            var isActive = i == 0 ? "active" : "";
            <li class="nav-item" role="presentation">
                <button class="nav-link @isActive"
                        id="tab-@tab.Id"
                        data-bs-toggle="tab"
                        data-bs-target="#content-@tab.Id"
                        data-api-url="@tab.ApiUrl"
                        data-tab-id="@tab.Id"
                        type="button"
                        role="tab">
                    @tab.Title
                </button>
            </li>
        }
    </ul>

    <!-- Tab 內容區 -->
    <div class="tab-content mt-3">
        @for (int i = 0; i < tabs.Count; i++)
        {
            var tab = tabs[i];
            var isActive = i == 0 ? "show active" : "";
            <div class="tab-pane fade @isActive"
                 id="content-@tab.Id"
                 role="tabpanel">
                <!-- 載入中提示 -->
                <div class="loading-indicator text-center py-5" style="display:none;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">載入中...</p>
                </div>

                <!-- 表格容器 -->
                <div class="table-container">
                    <!-- 動態載入的表格會插入這裡 -->
                </div>
            </div>
        }
    </div>
</div>

<script>
(function() {
    const paperNum = '@paperNum';
    const loadedTabs = new Set();
    const fieldDicts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(tabFieldDicts));

    // Tab 切換事件
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', async function(e) {
            const tabId = this.dataset.tabId;
            const apiUrl = this.dataset.apiUrl;
            const contentPane = document.getElementById(`content-${tabId}`);

            // 如果已經載入過,直接顯示
            if (loadedTabs.has(tabId)) {
                return;
            }

            // 顯示載入中
            const loading = contentPane.querySelector('.loading-indicator');
            const container = contentPane.querySelector('.table-container');
            loading.style.display = 'block';
            container.innerHTML = '';

            try {
                // AJAX 載入資料
                const response = await fetch(`${apiUrl}?PaperNum=${paperNum}`);

                // 檢查 HTTP 狀態
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`API 錯誤 (${response.status}):`, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                }

                // 檢查 Content-Type 是否為 JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('回應不是 JSON:', text.substring(0, 200));
                    throw new Error('API 回應格式錯誤，請檢查 API 是否正常運作');
                }

                const data = await response.json();

                // 渲染表格
                renderTable(container, data, tabId);

                // 標記為已載入
                loadedTabs.add(tabId);
            } catch (error) {
                console.error(`載入分頁 ${tabId} 失敗:`, error);
                container.innerHTML = `<div class="alert alert-danger">載入失敗: ${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        });
    });

    // 渲染表格函式
    function renderTable(container, data, tabId) {
        if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML = '<div class="alert alert-info">無資料</div>';
            return;
        }

        // 取得欄位名稱
        const fields = Object.keys(data[0]);
        const dict = fieldDicts[tabId] || {};

        // 建立表格
        let html = '<table class="table table-striped table-hover table-sm"><thead><tr>';

        // 表頭 - 使用字典取得中文名稱
        fields.forEach(field => {
            const displayName = dict[field] || field;
            html += `<th>${displayName}</th>`;
        });
        html += '</tr></thead><tbody>';

        // 表身
        data.forEach(row => {
            html += '<tr>';
            fields.forEach(field => {
                const value = row[field] ?? '';
                html += `<td>${value}</td>`;
            });
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // 頁面載入時,觸發第一個 Tab 的載入
    const firstTab = document.querySelector('[data-bs-toggle="tab"]');
    if (firstTab) {
        firstTab.dispatchEvent(new Event('shown.bs.tab'));
    }
})();
</script>

<style>
.multi-tab-detail {
    padding: 1rem 0;
}

.multi-tab-detail .nav-tabs {
    border-bottom: 2px solid #dee2e6;
}

.multi-tab-detail .nav-link {
    color: #495057;
    border: none;
    border-bottom: 3px solid transparent;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s;
}

.multi-tab-detail .nav-link:hover {
    background-color: #f8f9fa;
    border-bottom-color: #6c757d;
}

.multi-tab-detail .nav-link.active {
    color: #0d6efd;
    background-color: transparent;
    border-bottom-color: #0d6efd;
    font-weight: 600;
}

.multi-tab-detail .table-container {
    overflow-x: auto;
    max-height: 600px;
}

.multi-tab-detail table {
    width: 100%;
    font-size: 0.9rem;
}

.multi-tab-detail th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 10;
}
</style>
