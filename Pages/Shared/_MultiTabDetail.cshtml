@model dynamic
@{
    var paperNum = ViewData["PaperNum"]?.ToString() ?? "";
    var tabs = ViewData["Tabs"] as dynamic[] ?? Array.Empty<dynamic>();
    var tabFieldDicts = ViewData["TabFieldDicts"] as Dictionary<string, Dictionary<string, string>> ?? new();
    var allowEdit = (ViewData["MultiTabAllowEdit"] as bool?) ?? true;
}

<!-- SweetAlert2 引入 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- 多分頁容器 -->
<div class="multi-tab-detail">
    <!-- Tab 標籤列 -->
    <ul class="nav nav-tabs" role="tablist">
        @for (int i = 0; i < tabs.Length; i++)
        {
            var tab = tabs[i];
            var isActive = i == 0 ? "active" : "";
            <li class="nav-item" role="presentation">
                <button class="nav-link @isActive"
                        id="tab-@tab.Id"
                        data-bs-toggle="tab"
                        data-bs-target="#content-@tab.Id"
                        data-api-url="@tab.ApiUrl"
                        data-tab-id="@tab.Id"
                        type="button"
                        role="tab">
                    @tab.Title
                </button>
            </li>
        }
    </ul>

    <!-- Tab 內容區 -->
    <div class="tab-content mt-0">
        @for (int i = 0; i < tabs.Length; i++)
        {
            var tab = tabs[i];
            var isActive = i == 0 ? "show active" : "";
            <div class="tab-pane fade @isActive"
                 id="content-@tab.Id"
                 role="tabpanel">
         
                <div class="loading-indicator text-center py-5" style="display:@(i == 0 ? "block" : "none");">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">載入中...</p>
                </div>
                <div class="table-container" data-tab-id="@tab.Id" data-dict-table="@tab.DictTable">
                
                </div>
            </div>
        }
    </div>
</div>

<script>
(function() {
    const paperNum = '@paperNum';
    const allowEdit = @(allowEdit ? "true" : "false");
    const loadedTabs = new Set();
    const fieldDicts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(tabFieldDicts));
    const tabsData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(tabs));
    window._multiTabTabs = tabsData;
    window._multiTabSelectedRows = window._multiTabSelectedRows || {};
    if (!window.__activeDetailGrid) window.__activeDetailGrid = 'multitab';

    function getHeaderEditState() {
        if (typeof window.__headerIsEdit === 'boolean') return window.__headerIsEdit;
        const btn = document.getElementById('btnViewEditToggle');
        return !!btn && (btn.textContent || '').trim() === '保留';
    }

    function applyMultiTabEditMode(isEdit) {
        const effectiveEdit = (typeof isEdit === 'boolean') ? isEdit : getHeaderEditState();
        const canEdit = !!effectiveEdit && allowEdit;
        document.querySelectorAll('.multi-tab-detail .erp-table .cell-view')
            .forEach(el => el.classList.toggle('d-none', canEdit));
        document.querySelectorAll('.multi-tab-detail .erp-table .cell-edit')
            .forEach(el => el.classList.toggle('d-none', !canEdit));
    }

    window.addEventListener('headerEditModeChanged', (e) => {
        applyMultiTabEditMode(!!(e?.detail?.isEdit));
    });

    document.querySelectorAll('.multi-tab-detail .nav-link').forEach(btn => {
        btn.addEventListener('shown.bs.tab', () => {
            if (typeof window.__updateToolbarCounts === 'function') {
                window.__updateToolbarCounts();
            }
        });
    });

    function cleanTableName(t) {
        return (t || '').toString().replace(/^dbo\./i, '').trim().toLowerCase();
    }

    function getDictTableOfTab(container, tabId) {
        return (container?.dataset?.dictTable || tabsData?.find(x => x?.Id === tabId)?.DictTable || '').toString();
    }

    function withPaperNum(apiUrl) {
        const base = (apiUrl || '').toString();
        const sep = base.includes('?') ? '&' : '?';
        return `${base}${sep}PaperNum=${encodeURIComponent(paperNum)}`;
    }

    // Dict meta cache (datatype/format/width...)
    const DICT_META_CACHE = new Map(); // tn -> Map(fieldLower -> { dataType, formatStr, comboStyle })
    const LOOKUP_META_CACHE = new Map(); // tn -> Map(fieldLower -> { table, key, result })
    const LOOKUP_DATA_CACHE = new Map(); // tn -> Map(fieldLower -> Map(key -> label))
    const READONLY_META_CACHE = new Map(); // tn -> Map(fieldLower -> boolean)

    async function fetchDictMeta(dictTable) {
        const tn = cleanTableName(dictTable);
        if (!tn) return new Map();
        if (DICT_META_CACHE.has(tn)) return DICT_META_CACHE.get(tn);
        try {
            const res = await fetch(`/api/TableFieldLayout/DictFields?table=${encodeURIComponent(tn)}&lang=TW`);
            if (!res.ok) {
                const empty = new Map();
                DICT_META_CACHE.set(tn, empty);
                return empty;
            }
            const rows = await res.json();
            const map = new Map();
            (rows || []).forEach(r => {
                const field = (r.fieldName || r.FieldName || '').toString();
                if (!field) return;
                map.set(field.toLowerCase(), {
                    dataType: (r.dataType || r.DataType || '').toString(),
                    formatStr: (r.formatStr || r.FormatStr || '').toString(),
                    comboStyle: Number(r.comboStyle ?? r.ComboStyle ?? 0)
                });
            });
            DICT_META_CACHE.set(tn, map);
            return map;
        } catch {
            const empty = new Map();
            DICT_META_CACHE.set(tn, empty);
            return empty;
        }
    }

    async function fetchLookupMeta(dictTable) {
        const tn = cleanTableName(dictTable);
        if (!tn) return new Map();
        if (LOOKUP_META_CACHE.has(tn)) return LOOKUP_META_CACHE.get(tn);
        try {
            const res = await fetch(`/api/TableFieldLayout/GetTableFieldsFull?table=${encodeURIComponent(tn)}&lang=TW`);
            if (!res.ok) {
                const empty = new Map();
                LOOKUP_META_CACHE.set(tn, empty);
                return empty;
            }
            const rows = await res.json();
            const map = new Map();
            (rows || []).forEach(r => {
                const field = (r.fieldName || r.FieldName || '').toString();
                if (!field) return;
                const table = (r.lookupTable || r.LookupTable || '').toString();
                const key = (r.lookupKeyField || r.LookupKeyField || '').toString();
                const result = (r.lookupResultField || r.LookupResultField || '').toString();
                const ocxTable = (r.ocxLKTableName || r.OCXLKTableName || '').toString();
                const ocxResult = (r.ocxLKResultName || r.OCXLKResultName || '').toString();
                const ocxKeyField = (r.keyFieldName || r.KeyFieldName || '').toString();
                const ocxKeySelf = (r.keySelfName || r.KeySelfName || '').toString();
                if (table && key && result) {
                    map.set(field.toLowerCase(), { field, table, key, result, keySelf: '', source: 'lookup' });
                    return;
                }
                if (ocxTable && ocxKeyField && ocxResult) {
                    map.set(field.toLowerCase(), { field, table: ocxTable, key: ocxKeyField, result: ocxResult, keySelf: ocxKeySelf, source: 'ocx' });
                }
            });
            LOOKUP_META_CACHE.set(tn, map);
            return map;
        } catch {
            const empty = new Map();
            LOOKUP_META_CACHE.set(tn, empty);
            return empty;
        }
    }

    async function fetchReadOnlyMeta(dictTable) {
        const tn = cleanTableName(dictTable);
        if (!tn) return new Map();
        if (READONLY_META_CACHE.has(tn)) return READONLY_META_CACHE.get(tn);
        try {
            const res = await fetch(`/api/TableFieldLayout/GetTableFieldsFull?table=${encodeURIComponent(tn)}&lang=TW`);
            if (!res.ok) {
                const empty = new Map();
                READONLY_META_CACHE.set(tn, empty);
                return empty;
            }
            const rows = await res.json();
            const map = new Map();
            (rows || []).forEach(r => {
                const field = (r.fieldName || r.FieldName || '').toString();
                if (!field) return;
                const ro = Number(r.readOnly ?? r.ReadOnly ?? 0) === 1;
                map.set(field.toLowerCase(), ro);
            });
            READONLY_META_CACHE.set(tn, map);
            return map;
        } catch {
            const empty = new Map();
            READONLY_META_CACHE.set(tn, empty);
            return empty;
        }
    }

    async function fetchLookupMaps(dictTable) {
        const tn = cleanTableName(dictTable);
        if (!tn) return new Map();
        if (LOOKUP_DATA_CACHE.has(tn)) return LOOKUP_DATA_CACHE.get(tn);
        const meta = await fetchLookupMeta(dictTable);
        const fieldMap = new Map();
        for (const [field, cfg] of meta.entries()) {
            try {
                const url = `/api/TableFieldLayout/LookupData?table=${encodeURIComponent(cfg.table)}&key=${encodeURIComponent(cfg.key)}&result=${encodeURIComponent(cfg.result)}`;
                const res = await fetch(url);
                if (!res.ok) continue;
                const data = await res.json();
                const map = new Map();
                (data || []).forEach(row => {
                    const key = row.key == null ? '' : String(row.key);
                    if (key === '') return;
                    const label = Object.keys(row)
                        .filter(p => p.startsWith('result'))
                        .map(p => row[p])
                        .filter(v => v != null && typeof v !== 'object' && String(v).trim() !== '')
                        .map(v => String(v))
                        .join(' - ');
                    const trimmed = key.trim();
                    map.set(key, label || key);
                    if (trimmed && trimmed !== key) map.set(trimmed, label || trimmed);
                });
                fieldMap.set(field, map);
            } catch { }
        }
        LOOKUP_DATA_CACHE.set(tn, fieldMap);
        return fieldMap;
    }

    function escapeHtml(v) {
        return String(v ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function extractRowData(tr) {
        try {
            if (!tr) return null;
            const obj = {};
            tr.querySelectorAll('input.cell-edit[data-field]').forEach(inp => {
                const f = (inp.dataset.field || '').toString();
                if (!f) return;
                if (inp.type === 'checkbox') obj[f] = inp.checked ? '1' : '0';
                else obj[f] = inp.value;
            });
            if (tr.dataset && tr.dataset.paperNum && obj.PaperNum === undefined) obj.PaperNum = tr.dataset.paperNum;
            if (tr.dataset && tr.dataset.item && obj.Item === undefined) obj.Item = tr.dataset.item;
            return obj;
        } catch {
            return null;
        }
    }

    function normalizeFieldKey(k) { return (k || '').toString().trim().toLowerCase(); }

    function getValueCaseInsensitive(obj, key) {
        if (!obj || !key) return undefined;
        const k = normalizeFieldKey(key);
        const hitKey = Object.keys(obj).find(x => normalizeFieldKey(x) === k);
        return hitKey ? obj[hitKey] : undefined;
    }

    function pad2(n) { return String(n).padStart(2, '0'); }

    function tryParseDate(raw) {
        if (raw == null || raw === '') return null;
        if (raw instanceof Date && !isNaN(raw)) return raw;
        const s = String(raw).trim();
        if (!s) return null;
        const d = new Date(s);
        return isNaN(d) ? null : d;
    }

    function parseDecimalsFromFormat(fmt) {
        const s = (fmt || '').toString();
        const dot = s.lastIndexOf('.');
        if (dot < 0) return null;
        const tail = s.slice(dot + 1);
        const m = tail.match(/0+/);
        if (!m) return Math.min(6, tail.length);
        return Math.min(8, m[0].length);
    }

    function formatCellValue(raw, meta, lookupMap, row, lookupMeta, allowLookup, lookupKeyOverride) {
        if (raw == null) return '';
        if (typeof raw === 'object') return '';
        const s = String(raw);
        if (s === '[object Object]') return '';

        if (allowLookup && lookupMap) {
            let key = lookupKeyOverride != null ? String(lookupKeyOverride) : s;
            if ((!key || key.trim() === '') && (lookupMeta?.keySelf || lookupMeta?.key)) {
                const fallbackKey = lookupMeta?.keySelf || lookupMeta?.key || '';
                const fallback = getValueCaseInsensitive(row, fallbackKey);
                key = fallback == null ? '' : String(fallback);
            }
            if (key && lookupMap.has(key)) return lookupMap.get(key) ?? key;
            const trimmed = key ? key.trim() : '';
            if (trimmed && lookupMap.has(trimmed)) return lookupMap.get(trimmed) ?? trimmed;
        }

        if (s === '') return '';
        if (s.includes(' - ') && !allowLookup) {
            return s.split(' - ')[0].trim();
        }

        const dataType = (meta?.dataType || '').toLowerCase();
        const fmt = (meta?.formatStr || '').toLowerCase();

        // Date / DateTime -> show date only (yyyy/MM/dd)
        if (dataType.includes('date') || fmt.includes('yyyy/mm/dd') || fmt.includes('yyyy-mm-dd')) {
            const d = tryParseDate(raw);
            if (!d) return s;
            return `${d.getFullYear()}/${pad2(d.getMonth() + 1)}/${pad2(d.getDate())}`;
        }

        // Number formatting
        if (dataType.includes('int') || dataType.includes('decimal') || dataType.includes('numeric') || dataType.includes('money') || dataType.includes('float') || dataType.includes('real')) {
            const n = Number(String(raw).replace(/,/g, ''));
            if (!Number.isFinite(n)) return s;
            const decimals = parseDecimalsFromFormat(meta?.formatStr);
            if (decimals != null) return n.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
            return n.toLocaleString();
        }

        return s;
    }

    const LOOKUP_EMPTY_LABEL = '--請選擇--';

    function buildLookupList(field, lookupMap, currentKey) {
        const list = document.createElement('div');
        list.className = 'lookup-dropdown-list';
        list.dataset.field = field;

        const addItem = (key, label) => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'lookup-dropdown-item';
            item.dataset.key = key == null ? '' : String(key);
            item.textContent = label == null ? String(key ?? '') : String(label);
            if ((currentKey ?? '') === (key ?? '')) item.classList.add('is-selected');
            list.appendChild(item);
        };

        addItem('', LOOKUP_EMPTY_LABEL);
        for (const [key, label] of lookupMap.entries()) {
            if (key == null || String(key) === '') continue;
            addItem(String(key), label);
        }
        return list;
    }

    function positionDropdown(list, anchor) {
        if (!list || !anchor) return;
        const rect = anchor.getBoundingClientRect();
        const spaceBelow = window.innerHeight - rect.bottom;
        const maxHeight = Math.max(140, Math.min(260, spaceBelow - 8));
        const placeBelow = spaceBelow >= 140;
        list.style.position = 'fixed';
        list.style.left = `${Math.max(6, rect.left)}px`;
        list.style.top = placeBelow ? `${rect.bottom}px` : `${Math.max(6, rect.top - maxHeight)}px`;
        list.style.minWidth = `${Math.max(120, rect.width)}px`;
        list.style.maxHeight = `${maxHeight}px`;
    }

    function openLookupDropdown(td, field, lookupMap) {
        if (!td || !lookupMap || lookupMap.size === 0) return;
        const existing = document.querySelector('.lookup-dropdown-list');
        if (existing) existing.remove();

        const edit = td.querySelector('.cell-edit[data-field]');
        const view = td.querySelector('.cell-view');
        if (!edit || !view) return;

        const isReadOnly = td.dataset.readonly === '1' || edit.dataset.readonly === '1';
        if (isReadOnly) return;
        const canApply = allowEdit && getHeaderEditState() && !isReadOnly;
        const currentKey = edit.type === 'checkbox' ? (edit.checked ? '1' : '0') : (edit.value ?? '');
        const list = buildLookupList(field, lookupMap, currentKey);

        const cleanup = () => {
            list.remove();
            document.removeEventListener('mousedown', onDocDown, true);
            window.removeEventListener('resize', onResize, true);
        };

        const setRowFieldValue = (tr, fieldName, value, viewText) => {
            if (!tr || !fieldName) return;
            const target = Array.from(tr.querySelectorAll('input.cell-edit[data-field]'))
                .find(inp => (inp.dataset.field || '').toString().toLowerCase() === fieldName.toLowerCase());
            if (!target) return;
            target.value = value ?? '';
            const cell = target.closest('td');
            const viewEl = cell?.querySelector('.cell-view');
            if (viewEl) viewEl.textContent = viewText ?? value ?? '';
        };

        const updateRowCache = (tr, fieldName, value) => {
            if (!tr || !fieldName) return;
            const container = tr.closest('.table-container');
            const tabId = container?.dataset?.tabId;
            if (!tabId) return;
            const rowData = window._multiTabSelectedRows?.[tabId];
            if (!rowData) return;
            rowData[fieldName] = value ?? '';
        };

        const applySelection = (newKey, label) => {
            if (!canApply) {
                cleanup();
                return;
            }
            const tr = td.closest('tr');
            const keyField = (td.dataset.lookupKeyField || '').toString();
            const keyValue = newKey ?? '';
            edit.value = keyValue ?? '';
            view.textContent = keyValue ?? '';
            view.dataset.initView = keyValue ?? '';
            setRowFieldValue(tr, field, keyValue, keyValue);
            // Force repaint even if view/edit toggles are out of sync
            requestAnimationFrame(() => {
                if (view) view.textContent = keyValue ?? '';
                if (edit) edit.value = keyValue ?? '';
            });

            if (keyField && keyField.toLowerCase() !== (field || '').toString().toLowerCase()) {
                setRowFieldValue(tr, keyField, keyValue, keyValue);
            }

            updateRowCache(tr, field, keyValue);
            if (keyField) updateRowCache(tr, keyField, keyValue);

            if (tr && tr.dataset.state !== 'added') tr.dataset.state = 'modified';
            window.__unsavedChanges = true;
            try {
                edit.dispatchEvent(new Event('input', { bubbles: true }));
                edit.dispatchEvent(new Event('change', { bubbles: true }));
            } catch {}
            cleanup();
        };

        const onDocDown = (e) => {
            if (list.contains(e.target)) return;
            cleanup();
        };
        const onResize = () => cleanup();

        const onPick = (e) => {
            const item = e.target.closest('.lookup-dropdown-item');
            if (!item) return;
            e.preventDefault();
            e.stopPropagation();
            const key = item.dataset.key ?? '';
            const label = item.textContent ?? key;
            applySelection(key, label);
        };
        list.addEventListener('pointerdown', onPick);
        list.addEventListener('mousedown', onPick);
        list.addEventListener('click', onPick);

        document.body.appendChild(list);
        positionDropdown(list, td);
        document.addEventListener('mousedown', onDocDown, true);
        window.addEventListener('resize', onResize, true);
    }

    async function fetchFieldWidths(dictTable) {
        const tn = cleanTableName(dictTable);
        if (!tn) return new Map();
        try {
            const res = await fetch(`/api/TableFieldLayout/DictFields?table=${encodeURIComponent(tn)}&lang=TW`);
            if (!res.ok) return new Map();
            const rows = await res.json();
            const map = new Map();
            (rows || []).forEach(r => {
                const field = (r.fieldName || r.FieldName || '').toString();
                const w = r.fieldWidth ?? r.FieldWidth;
                const ds = r.displaySize ?? r.DisplaySize;
                if (!field) return;
                const px = Number.isFinite(w) ? Number(w) : (Number.isFinite(ds) ? Number(ds) * 10 : null);
                if (px && px > 0) map.set(field.toLowerCase(), Math.round(px));
            });
            return map;
        } catch {
            return new Map();
        }
    }

    function applyColumnWidth(table, ths, index, width) {
        const w = Math.max(30, Math.round(width));
        const th = ths[index];
        if (!th) return;
        th.style.width = `${w}px`;
        Array.from(table.querySelectorAll(`tbody tr td:nth-child(${index + 1})`)).forEach(td => td.style.width = `${w}px`);
    }

    function applySavedWidths(table, dictTable, fields) {
        const tn = cleanTableName(dictTable);
        if (!tn) return;
        try {
            const raw = localStorage.getItem(`colwidth:${tn}`);
            if (!raw) return;
            const cols = JSON.parse(raw) || [];
            const ths = Array.from(table.querySelectorAll('thead th'));
            cols.forEach(c => {
                const f = (c.fieldName || '').toString();
                const w = Number(c.width);
                if (!f || !Number.isFinite(w)) return;
                const idx = fields.findIndex(x => x.toLowerCase() === f.toLowerCase());
                if (idx >= 0) applyColumnWidth(table, ths, idx, w);
            });
        } catch {}
    }

    const DETAIL_DEFAULTS_CACHE = new Map(); // tn -> defaults
    async function fetchDetailDefaults(dictTable) {
        const tn = cleanTableName(dictTable);
        if (!tn) return {};
        if (DETAIL_DEFAULTS_CACHE.has(tn)) return DETAIL_DEFAULTS_CACHE.get(tn);
        try {
            const res = await fetch(`/api/OrderHeaderApi/DetailDefaults?table=${encodeURIComponent(tn)}`);
            if (!res.ok) {
                DETAIL_DEFAULTS_CACHE.set(tn, {});
                return {};
            }
            const data = await res.json();
            const defs = data?.defaults || {};
            DETAIL_DEFAULTS_CACHE.set(tn, defs);
            return defs;
        } catch {
            DETAIL_DEFAULTS_CACHE.set(tn, {});
            return {};
        }
    }

    // 欄寬拖曳狀態（全頁共用一次，避免每個 tab 重複掛 document 事件）
    const resizeState = {
        active: false,
        table: null,
        ths: [],
        dictTable: '',
        thIndex: -1,
        startX: 0,
        startWidth: 0,
        saveTimer: null
    };
    async function persistWidths(snapshot) {
        const table = snapshot?.table;
        const ths = snapshot?.ths || [];
        const dictTable = snapshot?.dictTable || '';
        const tn = cleanTableName(dictTable);
        if (!table || !ths.length || !tn) return;
        try {
            const payload = {
                tableName: tn,
                cols: ths.map(th => ({ fieldName: th.dataset.field, width: Math.round(th.getBoundingClientRect().width) }))
            };
            await fetch('/api/TableFieldLayout/SaveDetailLayout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(() => {});
            localStorage.setItem(`colwidth:${tn}`, JSON.stringify(payload.cols));
        } catch {}
    }
    function debouncePersist(snapshot) {
        clearTimeout(resizeState.saveTimer);
        const snap = snapshot ? { ...snapshot } : null;
        resizeState.saveTimer = setTimeout(() => persistWidths(snap), 400);
    }
    document.addEventListener('mousemove', (e) => {
        if (!resizeState.active || !resizeState.table) return;
        const dx = e.pageX - resizeState.startX;
        const newW = Math.max(30, resizeState.startWidth + dx);
        applyColumnWidth(resizeState.table, resizeState.ths, resizeState.thIndex, newW);
    });
    document.addEventListener('mouseup', () => {
        if (!resizeState.active) return;
        resizeState.active = false;
        document.body.classList.remove('resizing');
        resizeState.ths.forEach(th => th.classList.remove('resizing'));
        Array.from(resizeState.table.querySelectorAll('tbody td.resizing')).forEach(td => td.classList.remove('resizing'));
        // 用 snapshot 避免先清空 state 導致儲存失效
        debouncePersist({ table: resizeState.table, ths: resizeState.ths, dictTable: resizeState.dictTable });
        resizeState.table = null;
        resizeState.ths = [];
        resizeState.dictTable = '';
        resizeState.thIndex = -1;
    });

    function initColumnResize(table, dictTable, fields) {
        if (!table) return;
        const ths = Array.from(table.querySelectorAll('thead th'));
        ths.forEach((th, idx) => {
            const handle = th.querySelector('.col-resizer');
            if (!handle) return;
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                resizeState.active = true;
                resizeState.table = table;
                resizeState.ths = ths;
                resizeState.dictTable = dictTable;
                resizeState.thIndex = idx;
                resizeState.startX = e.pageX;
                resizeState.startWidth = th.getBoundingClientRect().width;
                document.body.classList.add('resizing');
                th.classList.add('resizing');
                Array.from(table.querySelectorAll(`tbody tr td:nth-child(${idx + 1})`)).forEach(td => td.classList.add('resizing'));
            });
        });
    }

    // 暴露為全域變數方便除錯
    window._debugFieldDicts = fieldDicts;
    window._debugTabsData = tabsData;

    // Tab 切換事件
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', async function(e) {
            const tabId = this.dataset.tabId;
            const apiUrl = this.dataset.apiUrl;
            const contentPane = document.getElementById(`content-${tabId}`);

            // 取得容器元素
            const container = contentPane.querySelector('.table-container');

            // 更新當前辭典表名稱給 F3 使用
            if (container && container.dataset.dictTable) {
                window._dictTableName = container.dataset.dictTable;
            }

            // 如果已經載入過,直接顯示
            if (loadedTabs.has(tabId)) {
                return;
            }

            // 顯示載入中
            const loading = contentPane.querySelector('.loading-indicator');
            loading.style.display = 'block';

            // 清除舊的表格（保留按鈕）
            const existingTable = container.querySelector('.erp-table-wrapper');
            if (existingTable) existingTable.remove();
            const existingAlert = container.querySelector('.alert');
            if (existingAlert) existingAlert.remove();

            try {
                // AJAX 載入資料
                const response = await fetch(withPaperNum(apiUrl));

                // 檢查 HTTP 狀態
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`API 錯誤 (${response.status}):`, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                }

                // 檢查 Content-Type 是否為 JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('回應不是 JSON:', text.substring(0, 200));
                    throw new Error('API 回應格式錯誤，請檢查 API 是否正常運作');
                }

                const data = await response.json();

                // 渲染表格
                await renderTable(container, data, tabId);

                // 標記為已載入
                loadedTabs.add(tabId);
            } catch (error) {
                console.error(`載入分頁 ${tabId} 失敗:`, error);
                container.insertAdjacentHTML('beforeend', `<div class="alert alert-danger">載入失敗: ${error.message}</div>`);
            } finally {
                loading.style.display = 'none';
            }
        });
    });

    // 渲染表格函式
    async function renderTable(container, data, tabId) {
        // ✅ 先清除舊的 alert，避免重複顯示「無資料」
        const existingAlerts = container.querySelectorAll('.alert');
        existingAlerts.forEach(a => a.remove());

        const rows = Array.isArray(data) ? data : [];

        const dict = fieldDicts[tabId] || {};
        const dictTable = getDictTableOfTab(container, tabId);
        const dictKey = cleanTableName(dictTable);
        window._detailFieldDicts = window._detailFieldDicts || {};
        if (dictKey) {
            window._detailFieldDicts[dictKey] = dict;
        }
        const metaMap = await fetchDictMeta(dictTable);
        const readOnlyMap = await fetchReadOnlyMeta(dictTable);
        if (dictKey) {
            window._detailFieldReadOnlyMap = window._detailFieldReadOnlyMap || {};
            window._detailFieldReadOnlyMap[dictKey] = Object.fromEntries(readOnlyMap.entries());
        }
        const lookupMeta = await fetchLookupMeta(dictTable);
        const lookupMaps = await fetchLookupMaps(dictTable);
        const lookupResultMap = new Map();
        for (const [fieldLower, cfg] of lookupMeta.entries()) {
            const resultLower = (cfg?.result || '').toString().toLowerCase();
            if (!resultLower) continue;
            const map = lookupMaps.get(fieldLower);
            if (!map) continue;
            if (!lookupResultMap.has(resultLower)) lookupResultMap.set(resultLower, { map, meta: cfg });
        }



        // 只顯示字典中有的欄位（Visible == 1 的欄位）
        // 如果字典為空，則顯示所有欄位（向後兼容）
        const allFields = rows.length > 0 ? Object.keys(rows[0]) : [];

        let fields = Object.keys(dict).length > 0
            ? Object.keys(dict).filter(f => (allFields.length ? allFields.includes(f) : true))
            : allFields;  // 如果沒有字典，顯示所有欄位


        if (fields.length === 0) {
            container.insertAdjacentHTML('beforeend', '<div class="alert alert-warning">沒有可顯示的欄位</div>');
            return;
        }

        const defaults = await fetchDetailDefaults(dictTable);
        const lookupFieldSet = new Set();
        const lookupMetaMap = {};

        // 建立表格 - 使用 erp-table 樣式
        let html = '<div class="erp-table-wrapper">';

        html += '<table class="erp-table"><thead><tr>';

        // 表頭 - 使用字典取得中文名稱
        fields.forEach(field => {
            const displayName = dict[field] || field;
            html += `<th data-field="${field}" style="position:relative;"><span class="th-text">${displayName}</span><span class="col-resizer" draggable="false"></span></th>`;
        });
        html += '</tr></thead><tbody>';

        const renderRow = (row, index, options) => {
            const opts = options || {};
            const isAdded = opts.isAdded === true;
            const paperNum = row.PaperNum || row.paperNum || '';
            const item = (row.Item ?? row.item);
            const itemVal = item == null ? (index + 1) : item;
            const state = opts.state || (isAdded ? "added" : "unchanged");
            const selClass = opts.selected ? " row-selected" : (isAdded ? " row-selected" : "");
            const viewClass = "cell-view";
            const editClass = "cell-edit d-none";
            html += `<tr data-paper-num="${paperNum}" data-item="${itemVal}" data-state="${state}" class="${selClass.trim()}">`;
            fields.forEach(field => {
                  let rawValue = row[field] ?? '';
                const fieldLower = field.toLowerCase();
                const meta = metaMap.get(fieldLower);
                const isReadOnly = readOnlyMap.get(fieldLower) === true;
                const roClass = isReadOnly ? ' readonly-cell' : '';
                const roAttr = isReadOnly ? ' data-readonly="1" readonly' : ' data-readonly="0"';
                let lookupMap = lookupMaps.get(fieldLower);
                let metaLookup = lookupMeta.get(fieldLower);
                if (!metaLookup) {
                    const alt = lookupResultMap.get(fieldLower);
                    if (alt) {
                        metaLookup = alt.meta;
                        lookupMap = alt.map;
                    }
                }
                const displayName = dict[field] || field;
                  const metaKeySelf = (metaLookup?.keySelf || '').toString().toLowerCase();
                  const metaKey = (metaLookup?.key || '').toString().toLowerCase();
                  const metaResult = (metaLookup?.result || '').toString().toLowerCase();
                  const isResultField = metaResult !== '' && metaResult === fieldLower;
                  const allowLookup = !!(metaLookup && metaLookup.table && metaLookup.key && metaLookup.result)
                      && (isResultField || (fieldLower !== metaKeySelf && fieldLower !== metaKey));
                  const metaFieldLower = (metaLookup?.field || '').toString().toLowerCase();
                  const canDropdown = !!(metaLookup?.source === 'lookup'
                      && lookupMap && lookupMap.size
                      && ((metaFieldLower && metaFieldLower === fieldLower) || (metaResult && metaResult === fieldLower)));
                  if (canDropdown) lookupFieldSet.add(field);
                  if (canDropdown) {
                      lookupMetaMap[fieldLower] = { key: metaLookup?.key || '', result: metaLookup?.result || '' };
                  }
                let lookupKeyOverride = null;
                  if (allowLookup && metaLookup?.source === 'ocx') {
                      const candidates = [];
                      if (metaLookup?.keySelf) candidates.push(metaLookup.keySelf);
                      if (metaLookup?.key) candidates.push(metaLookup.key);
                    for (const alt of candidates) {
                        const keyVal = getValueCaseInsensitive(row, alt);
                        if (keyVal != null && String(keyVal).trim() !== '') {
                            lookupKeyOverride = keyVal;
                            break;
                        }
                    }
                }
                    const keyStr = lookupKeyOverride == null ? '' : String(lookupKeyOverride).trim();
                    const keyIsEmpty = keyStr === '';
                    const keyFieldName = metaLookup?.source === 'ocx' ? (metaLookup?.keySelf || metaLookup?.key || '') : '';
                    const keyRawVal = keyFieldName ? getValueCaseInsensitive(row, keyFieldName) : null;
                    const keyRawStr = keyRawVal == null ? '' : String(keyRawVal).trim();
                    const keySourceMissing = !!keyFieldName && keyRawStr === '';
                    if (keySourceMissing) {
                        rawValue = '';
                    }
                    const rawStr = rawValue == null ? '' : String(rawValue);
                    const canLookup = allowLookup && !canDropdown && !keySourceMissing && (rawStr !== '' || !keyIsEmpty);
                    const value = formatCellValue(rawValue, meta, lookupMap, row, metaLookup, canLookup, lookupKeyOverride);
                  // ? 雙元素：顯示模式 + 編輯模式
                    const keyFieldAttr = canDropdown ? ` data-lookup-key-field="${escapeHtml(metaLookup?.key || '')}"` : "";
                    const resultFieldAttr = canDropdown ? ` data-lookup-result-field="${escapeHtml(metaLookup?.result || '')}"` : "";
                    const lookupAttr = canDropdown
                        ? ` class="lookup-cell" data-lookup-field="${escapeHtml(field)}"${keyFieldAttr}${resultFieldAttr}`
                        : "";
                    const tdReadOnlyAttr = ` data-readonly="${isReadOnly ? '1' : '0'}"`;
                    html += `<td${lookupAttr}${tdReadOnlyAttr}>
                        <span class="${viewClass}${roClass}" data-init-view="${escapeHtml(value)}" data-readonly="${isReadOnly ? '1' : '0'}">${escapeHtml(value)}</span>
                        <input type="text"
                               class="${editClass}${roClass}"
                               data-field="${field}"
                               data-init="${escapeHtml(rawValue)}"
                               value="${escapeHtml(rawValue)}"${roAttr}>
                    </td>`;
            });
            html += '</tr>';
        };

        if (rows.length > 0) {
            rows.forEach((row, index) => renderRow(row, index, { isAdded: false }));
        } else {
            const blank = {};
            blank.Item = "";
            renderRow(blank, 0, { state: "empty", selected: false, isAdded: false });
            try {
                window._multiTabSelectedRows = window._multiTabSelectedRows || {};
                window._multiTabSelectedRows[tabId] = blank;
                window.dispatchEvent(new CustomEvent('multiTabRowSelected', { detail: { tabId, rowData: blank } }));
            } catch { }
        }

        html += '</tbody></table></div>';
        container.insertAdjacentHTML('beforeend', html);
        window._multiTabLookupFields = window._multiTabLookupFields || {};
        window._multiTabLookupFields[tabId] = Array.from(lookupFieldSet);
        window._multiTabLookupMeta = window._multiTabLookupMeta || {};
        window._multiTabLookupMeta[tabId] = lookupMetaMap;
        applyMultiTabEditMode(!!window.__headerIsEdit);
        if (typeof window.__updateToolbarCounts === 'function') {
            window.__updateToolbarCounts();
        }

        // 依辭典設定把「勾選框(ComboStyle=1)」欄位轉成 checkbox 顯示/編輯
        (function applyCheckboxCells() {
            try {
                const wrapper = container.querySelector('.erp-table-wrapper');
                const table = wrapper?.querySelector('table.erp-table');
                if (!table) return;

                const checkboxIndexes = [];
                fields.forEach((f, idx) => {
                    const meta = metaMap.get(String(f).toLowerCase()) || {};
                    if (Number(meta.comboStyle || 0) === 1) checkboxIndexes.push(idx);
                });
                if (!checkboxIndexes.length) return;

                const rows = Array.from(table.querySelectorAll('tbody tr'));
                rows.forEach(tr => {
                    const tds = Array.from(tr.querySelectorAll('td'));
                    checkboxIndexes.forEach(idx => {
                        const td = tds[idx];
                        if (!td) return;
                        const edit = td.querySelector('input.cell-edit[data-field]');
                        const view = td.querySelector('.cell-view');
                        if (!edit || !view) return;
                        if (edit.type === 'checkbox') return;

                        const raw = (edit.value ?? '').toString().trim().toLowerCase();
                        const checked = raw === '1' || raw === 'true' || raw === 'y' || raw === 'yes';

                        view.innerHTML = `<input type="checkbox" class="cell-view-checkbox" disabled ${checked ? 'checked' : ''}>`;

                        const chk = document.createElement('input');
                        chk.type = 'checkbox';
                        chk.className = edit.className;
                        chk.dataset.field = edit.dataset.field || '';
                        chk.dataset.init = edit.dataset.init || '';
                        chk.dataset.readonly = edit.dataset.readonly || '0';
                        chk.checked = checked;
                        if (chk.dataset.readonly === '1') chk.disabled = true;
                        edit.replaceWith(chk);
                    });
                });
            } catch { }
        })();

        const table = container.querySelector('.erp-table-wrapper table.erp-table');
        if (table) {
            applySavedWidths(table, dictTable, fields);
            const widthMap = await fetchFieldWidths(dictTable);
            if (widthMap.size) {
                const ths = Array.from(table.querySelectorAll('thead th'));
                fields.forEach((f, idx) => {
                    const w = widthMap.get(f.toLowerCase());
                    if (w) applyColumnWidth(table, ths, idx, w);
                });
                try {
                    const tn = cleanTableName(dictTable);
                    const cols = fields.map((f, idx) => ({ fieldName: f, width: Math.round(ths[idx].getBoundingClientRect().width) }));
                    localStorage.setItem(`colwidth:${tn}`, JSON.stringify(cols));
                } catch {}
            }
            initColumnResize(table, dictTable, fields);
        }

        // 綁定列選取事件（委派到 tbody，確保點擊/編輯儲存格也能選取整列）
        const tableWrapper = container.querySelector('.erp-table-wrapper');
        if (tableWrapper) {
            const tbody = tableWrapper.querySelector('tbody');
            if (tbody) {
                const selectRow = (tr) => {
                    if (!tr) return;
                    const sameKey = (() => {
                        try {
                            const prev = window._multiTabSelectedRows?.[tabId] || null;
                            if (!prev) return false;
                            const prevItem = (prev.Item ?? prev.item ?? '').toString();
                            const prevPaper = (prev.PaperNum ?? prev.paperNum ?? '').toString();
                            const curItem = (tr.dataset.item || '').toString();
                            const curPaper = (tr.dataset.paperNum || '').toString();
                            return prevItem === curItem && prevPaper === curPaper;
                        } catch {
                            return false;
                        }
                    })();
                    tableWrapper.querySelectorAll('tr.row-selected').forEach(r => r.classList.remove('row-selected'));
                    tr.classList.add('row-selected');
                    if (!sameKey) {
                        try {
                            const rowData = extractRowData(tr);
                            if (rowData) {
                                window._multiTabSelectedRows[tabId] = rowData;
                            }
                            window.dispatchEvent(new CustomEvent('multiTabRowSelected', { detail: { tabId, rowData } }));
                        } catch {}
                    }
                };
                tbody.addEventListener('click', (e) => {
                    window.__activeDetailGrid = 'multitab';
                    const tr = e.target.closest('tr');
                    if (tr && tbody.contains(tr)) selectRow(tr);
                    if (typeof window.__updateToolbarCounts === 'function') {
                        window.__updateToolbarCounts();
                    }
                });
                tbody.addEventListener('focusin', (e) => {
                    window.__activeDetailGrid = 'multitab';
                    const tr = e.target.closest('tr');
                    if (tr && tbody.contains(tr)) selectRow(tr);
                    if (typeof window.__updateToolbarCounts === 'function') {
                        window.__updateToolbarCounts();
                    }
                });
                tbody.addEventListener('dblclick', (e) => {
                    const td = e.target.closest('td');
                    if (!td || !tbody.contains(td)) return;
                    const field = td.dataset.lookupField;
                    if (!field) return;
                    const fieldLower = field.toLowerCase();
                    const map = lookupMaps.get(fieldLower);
                    if (!map || map.size === 0) return;
                    openLookupDropdown(td, field, map);
                });
            }

            // 需要第三階聯動時：預設自動選取第一筆（例如 Paper3L）
            if (window.__multiTabAutoSelectFirstRow) {
                const hasSelected = !!tableWrapper.querySelector('tbody tr.row-selected');
                const first = tbody ? tbody.querySelector('tr') : null;
                if (!hasSelected && first) {
                    first.classList.add('row-selected');
                    try {
                        const rowData = extractRowData(first);
                        if (rowData) {
                            window._multiTabSelectedRows[tabId] = rowData;
                        }
                        window.dispatchEvent(new CustomEvent('multiTabRowSelected', { detail: { tabId, rowData } }));
                    } catch {}
                }
            }
        }
    }



    // 統一使用 async 函式載入第一個頁籤
    async function loadFirstTab() {
 

        // 直接從 tabsData 取得第一個頁籤資訊（避免 DOM 屬性讀取問題）
        if (!tabsData || tabsData.length === 0) {
            console.error(`❌ [MultiTab] tabsData 為空`);
            return;
        }

        const firstTabData = tabsData[0];
  

        // 使用匿名型別的屬性名稱（首字母大寫）
        const tabId = firstTabData.Id;
        const apiUrl = firstTabData.ApiUrl;

        // 設定第一個頁籤的辭典表名給 F3 使用
        if (firstTabData.DictTable) {
            window._dictTableName = firstTabData.DictTable;
        }

        const contentPane = document.getElementById(`content-${tabId}`);

        if (!contentPane) {
            console.error(`❌ [MultiTab] 找不到 contentPane: content-${tabId}`);
            return;
        }

        if (loadedTabs.has(tabId)) {
            return;
        }

        const loading = contentPane.querySelector('.loading-indicator');
        const container = contentPane.querySelector('.table-container');
        loading.style.display = 'block';

        // 清除舊的表格（保留按鈕）
        const existingTable = container.querySelector('.erp-table-wrapper');
        if (existingTable) existingTable.remove();
        const existingAlert = container.querySelector('.alert');
        if (existingAlert) existingAlert.remove();

        const startTime = Date.now();

        try {
            // AJAX 載入資料
            const response = await fetch(withPaperNum(apiUrl));
        
            // 檢查 HTTP 狀態
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`❌ [MultiTab] API 錯誤 (${response.status}):`, errorText);
                throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
            }

            // 檢查 Content-Type 是否為 JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('❌ [MultiTab] 回應不是 JSON:', text.substring(0, 200));
                throw new Error('API 回應格式錯誤，請檢查 API 是否正常運作');
            }

            const data = await response.json();
        

            // 渲染表格
            await renderTable(container, data, tabId);

            // 標記為已載入
            loadedTabs.add(tabId);
        } catch (error) {
            console.error(`❌ [MultiTab] 載入分頁 ${tabId} 失敗:`, error);
            container.insertAdjacentHTML('beforeend', `
                <div class="alert alert-danger m-3">
                    <h5 class="alert-heading">⚠️ 載入失敗</h5>
                    <p class="mb-0">${error.message}</p>
                    <hr>
                    <small class="text-muted">請檢查 Console 以查看詳細錯誤訊息</small>
                </div>`);
        } finally {
            loading.style.display = 'none';
    
        }
    }

    // 使用 setTimeout 確保 DOM 完全就緒後執行
    setTimeout(() => loadFirstTab(), 100);

    function normalizeBool(val) {
        const s = (val ?? '').toString().trim().toLowerCase();
        return s === '1' || s === 'true' || s === 'y' || s === 'yes';
    }

    function resetMultiTabEdits() {
        document.querySelectorAll('.multi-tab-detail table.erp-table').forEach(table => {
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            rows.forEach(tr => {
                const state = (tr.dataset.state || '').toString().toLowerCase();
                if (state === 'added') {
                    tr.remove();
                    return;
                }

                tr.dataset.state = 'unchanged';
                tr.querySelectorAll('td').forEach(td => {
                    const edit = td.querySelector('.cell-edit[data-field]');
                    const view = td.querySelector('.cell-view');
                    if (!edit) return;

                    const init = edit.dataset.init ?? '';
                    if (edit.type === 'checkbox') {
                        const checked = normalizeBool(init);
                        edit.checked = checked;
                        const viewChk = view?.querySelector('input.cell-view-checkbox');
                        if (viewChk) viewChk.checked = checked;
                    } else {
                        edit.value = init;
                        if (view) {
                            view.textContent = view.dataset.initView ?? init;
                        }
                    }
                });

                tr.querySelectorAll('.cell-view').forEach(el => el.classList.remove('d-none'));
                tr.querySelectorAll('.cell-edit').forEach(el => el.classList.add('d-none'));
            });
        });
    }

    window.resetMultiTabEdits = resetMultiTabEdits;
})();
</script>

<style>
.multi-tab-detail {
    /* 單頭/單身間距：縮小上方留白 */
    padding: .05rem 0 0;
    padding-left: var(--detail-left-pad);
    max-width: var(--detail-max-width);
    width: 100%;
    box-sizing: border-box;
}

.multi-tab-detail .nav-tabs {
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 0;
}

.multi-tab-detail .nav-link {
    color: #235eb8;
    border: 1px solid transparent;
    border-radius: 8px 8px 0 0;
    padding: var(--tab-pad-y) var(--tab-pad-x);
    background: transparent;
    transition: color 0.2s ease-in-out, background 0.2s ease-in-out, border-color 0.2s ease-in-out;
    font-size: var(--field-label-size);
    font-weight: 500;
}

.multi-tab-detail .nav-link:hover {
    background-color: #f5f7fb;
    border-color: #dee2e6 #dee2e6 #fff #dee2e6;
}

.multi-tab-detail .nav-link.active {
    color: #124d8b;
    background-color: #ffffff;
    border-color: #bdd2f7 #bdd2f7 #fff #bdd2f7;
    box-shadow: 0 2px 6px 0 #e4ecf7;
    font-weight: 700;
}

.multi-tab-detail .table-container {
    margin-top: 0;
}

/* erp-table 完整樣式 */
.multi-tab-detail .erp-table-wrapper {
    background: #fff;
    box-shadow: 0 4px 18px 0 #c3d4e6;
    max-width: 100%;
    width: 100%;
    overflow-x: auto;
    padding: 8px !important;
    border-radius: 0 0 13px 13px;
    border: 1px solid #d6dbe5;
    max-height: 600px;
}

.multi-tab-detail .erp-table {
    /* 欄位少時不要硬撐滿容器寬度：依欄寬縮排，容器保留空白 */
    width: max-content;
    display: inline-table;
    border-collapse: separate;
    border-spacing: 0;
    font-size: var(--field-value-size);
    background: #fff;
    table-layout: fixed; /* 欄寬拖曳需固定布局 */
}

.multi-tab-detail .erp-table thead tr {
    background: #e7ecf3;
}

.multi-tab-detail .erp-table th,
.multi-tab-detail .erp-table td {
    background: #f1f5fb;
    padding: 0;  /* ← 改為 0，由內部元素控制 padding */
    border-bottom: 1px solid #c5d1e4;
    white-space: nowrap;
    text-align: center;
    font-weight: 500;
    border-right: 1px solid #dde4ed;
    height: 34px;
}

.multi-tab-detail .erp-table th:last-child,
.multi-tab-detail .erp-table td:last-child {
    border-right: none;
}

.multi-tab-detail .erp-table th {
    color: #124d8b;
    font-weight: 700;
    font-size: var(--field-label-size);
    letter-spacing: .5px;
    background: #e7ecf3;
    position: sticky;
    top: 0;
    z-index: 10;
}

.multi-tab-detail .erp-table th { position: relative; }
.multi-tab-detail .erp-table th .col-resizer{
    position: absolute;
    top: 0; right: 0; bottom: 0;
    width: 8px;
    cursor: col-resize;
    user-select: none;
    z-index: 20;
}
.multi-tab-detail .erp-table th.resizing,
.multi-tab-detail .erp-table td.resizing,
body.resizing { cursor: col-resize !important; }

.multi-tab-detail .erp-table tbody tr:nth-child(even) {
    background: #f6f9fd;
}

.multi-tab-detail .erp-table tbody tr:hover {
    background: #eef7ff;
}

.multi-tab-detail .erp-table td {
    position: relative;
    padding: 0;
}

/* ✅ 檢視模式的 span 樣式 */
.multi-tab-detail .erp-table td .cell-view {
    display: block;  /* ← 改用 block，讓它填滿整個 td */
    width: 100%;
    min-height: 34px;  /* ← 最小高度確保一致 */
    text-align: inherit;
    padding: 7px 12px;
    box-sizing: border-box;
    white-space: nowrap;
    line-height: 20px;  /* ← 固定行高 */
}

/* ✅ 編輯模式的 input 樣式（融入表格，與 SpodOrderSub 一致） */
.multi-tab-detail .erp-table td {
    position: relative;
}

.multi-tab-detail .erp-table .cell-edit {
    display: block;  /* ← 改用 block，與 .cell-view 一致 */
    width: 100% !important;
    min-height: 34px;  /* ← 與 .cell-view 相同的最小高度 */
    box-sizing: border-box;
    margin: 0;
    border: none;
    border-radius: 0;
    background: #fff !important;
    font-size: inherit !important;
    font-weight: inherit !important;
    font-family: inherit !important;
    line-height: 20px !important;  /* ← 與 .cell-view 相同的行高 */
    text-align: inherit !important;
    padding: 7px 12px;  /* ← 與 .cell-view 完全相同的 padding */
    white-space: nowrap;
}

.multi-tab-detail .erp-table .cell-edit:focus {
    outline: 2px solid #0d6efd;
    outline-offset: -2px;
    background: #fffef0 !important;  /* ← focus 時淡黃色背景 */
}

.multi-tab-detail .erp-table td.lookup-cell .cell-view,
.multi-tab-detail .erp-table td.lookup-cell .cell-edit {
    background: #fff7e0 !important;
}

.multi-tab-detail .erp-table td .cell-view.readonly-cell,
.multi-tab-detail .erp-table td .cell-edit.readonly-cell {
    background: #e9ecef !important;
    color: #6c757d !important;
    cursor: not-allowed;
}
.multi-tab-detail .erp-table td .cell-edit.readonly-cell:focus {
    outline: none;
    background: #e9ecef !important;
}

.lookup-dropdown-list {
    z-index: 2000;
    background: #fff;
    border: 1px solid #b6c2d9;
    border-radius: 6px;
    box-shadow: 0 8px 20px rgba(30, 41, 59, 0.18);
    overflow: auto;
}

.lookup-dropdown-item {
    display: block;
    width: 100%;
    border: 0;
    background: transparent;
    text-align: left;
    padding: 6px 10px;
    font-size: var(--field-value-size);
    cursor: pointer;
}

.lookup-dropdown-item:hover,
.lookup-dropdown-item:focus {
    background: #e2e8f0;
    outline: none;
}

.lookup-dropdown-item.is-selected {
    background: #dbeafe;
}

.multi-tab-detail .cell-view-checkbox{
    transform: scale(1.05);
    pointer-events: none;
}

/* 選取列的樣式 */
.multi-tab-detail .erp-table tbody tr {
    cursor: pointer;
}

.multi-tab-detail .erp-table tbody tr.row-selected {
    background-color: #d1e7ff !important;
    border-left: 3px solid #0d6efd;
}

.multi-tab-detail .erp-table tbody tr.row-selected td {
    background-color: #d1e7ff !important;
}

/* 新增但未儲存的列 */
.multi-tab-detail .erp-table tbody tr[data-state="added"] {
    background-color: #fff3cd !important;
}

.multi-tab-detail .erp-table tbody tr[data-state="added"] td {
    background-color: #fff3cd !important;
}

/* ✅ 已修改但未儲存的列 */
.multi-tab-detail .erp-table tbody tr[data-state="modified"] {
    background-color: #e7f3ff !important;
}

.multi-tab-detail .erp-table tbody tr[data-state="modified"] td {
    background-color: #e7f3ff !important;
}
</style>


