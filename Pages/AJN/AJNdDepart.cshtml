@page
@model PcbErpApi.Pages.AJN.AJNdDepartModel
@{
    ViewData["Title"] = "éƒ¨é–€ä¸»æª”";
}

<style>
    /* è®“ body å’Œ html ä½”æ»¿å…¨è¢å¹• */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .container-fluid {
        height: 98vh;
        display: flex;
        flex-direction: column;
        padding: 0.75rem;
        box-sizing: border-box;
    }

    .depart-container {
        display: flex;
        flex: 1;
        min-height: 0;
        gap: 5px;
        margin-top: 0;
    }

    .tree-panel {
        flex: 0 0 450px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        background: #fff;
        overflow-y: auto;
        box-shadow: 0 2px 12px 0 #c3d4e6;
        min-height: 0;
    }

    .grid-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        overflow: hidden;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: #fff;
        box-shadow: 0 2px 12px 0 #c3d4e6;
    }

    /* è®“è¡¨æ ¼å®¹å™¨å¡«æ»¿å¯ç”¨ç©ºé–“ */
    .grid-panel .table-wrapper {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        margin: 0 !important;
        padding: 0 !important;
    }

    .grid-panel .card {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        height: 100%;
    }

    .grid-panel .card-body {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
    }

    /* ç§»é™¤è¡¨æ ¼å…§éƒ¨çš„å‚ç›´å·è»¸ï¼Œå¢åŠ é«˜åº¦ */
    .grid-panel .table-fix-wrapper {
        max-height: none !important;
        overflow-x: auto !important;
        overflow-y: visible !important;
        flex: 1;
    }

    /* è‡ªå®šç¾©æ©«å‘å·è»¸æ¨£å¼ */
    .grid-panel .table-fix-wrapper::-webkit-scrollbar {
        height: 12px;
    }

    .grid-panel .table-fix-wrapper::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 6px;
    }

    .grid-panel .table-fix-wrapper::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 6px;
    }

    .grid-panel .table-fix-wrapper::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* æ¨¹ç‹€é¢æ¿å·è»¸æ¨£å¼ */
    .tree-panel::-webkit-scrollbar {
        width: 8px;
    }

    .tree-panel::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .tree-panel::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .tree-panel::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .tree-node {
        padding: 8px 12px;
        margin: 4px 0;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s;
        user-select: none;
    }

    .tree-node:hover {
        background: #f0f8ff;
    }

    .tree-node.selected {
        background: #e6f2ff;
        border-left: 4px solid #2564b3;
        padding-left: 8px;
    }

    .tree-node.disabled {
        color: #999;
        text-decoration: line-through;
    }

    .tree-node-icon {
        display: inline-block;
        width: 20px;
        text-align: center;
        margin-right: 5px;
    }

    .tree-children {
        margin-left: 24px;
    }

    .tree-toggle {
        display: inline-block;
        width: 16px;
        height: 16px;
        line-height: 14px;
        text-align: center;
        margin-right: 4px;
        cursor: pointer;
        border-radius: 3px;
        font-size: 12px;
        background: #e9ecef;
    }

    .tree-toggle:hover {
        background: #dee2e6;
    }

    .tree-title {
        font-weight: 600;
        color: #2564b3;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e9ecef;
    }

    .toolbar-controls {
        margin-bottom: 15px;
    }

    .btn-refresh {
        background: #28a745;
        color: white;
        border: none;
        padding: 6px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-refresh:hover {
        background: #218838;
    }

    .page-title {
        font-size: 36px;
        font-weight: 900;
        font-family: "Microsoft JhengHei", "Segoe UI", Arial, sans-serif;
        color: #1E6FFF; /* äº®è—è‰² */
        letter-spacing: 2px;
        margin-bottom: 1rem;
        text-align: center;
    }
</style>

<div class="container-fluid mt-3">
    <div class="depart-container">
        <!-- å·¦å´ï¼šè¡¨æ ¼åˆ—è¡¨ -->
        <div class="grid-panel">
            <script>window._dictTableName = "@(ViewData["DictTableName"] ?? Model.TableName)";</script>
            @await Html.PartialAsync("~/Pages/Shared/_TableSingleGrid.cshtml", Model, ViewData)
        </div>

        <!-- å³å´ï¼šæ¨¹ç‹€çµæ§‹ -->
        <div class="tree-panel">
            <div class="tree-title">
                <i class="bi bi-diagram-3"></i> éƒ¨é–€çµ„ç¹”æ¶æ§‹
            </div>
            <div id="departmentTree"></div>
        </div>
    </div>
</div>

@await Html.PartialAsync("_FieldDictModal", Model.FieldDictList, ViewData)
<script src="~/js/fieldDictModal.js"></script>

<script>
    let departmentTreeData = [];
    let expandedNodes = new Set(); // è¨˜éŒ„å·²å±•é–‹çš„ç¯€é»

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadDepartmentTree();
    });

    // è¼‰å…¥éƒ¨é–€æ¨¹ç‹€çµæ§‹
    async function loadDepartmentTree() {
        try {
            const response = await fetch('/api/AJNdDepart/tree');
            if (!response.ok) throw new Error('è¼‰å…¥éƒ¨é–€è³‡æ–™å¤±æ•—');

            departmentTreeData = await response.json();
            renderTree();
        } catch (error) {
            console.error('è¼‰å…¥éƒ¨é–€æ¨¹ç‹€çµæ§‹éŒ¯èª¤:', error);
            alert('è¼‰å…¥éƒ¨é–€è³‡æ–™å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
    }

    // æ¸²æŸ“æ¨¹ç‹€çµæ§‹
    function renderTree() {
        const container = document.getElementById('departmentTree');
        container.innerHTML = '';

        if (!departmentTreeData || departmentTreeData.length === 0) {
            container.innerHTML = '<div style="color: #999; padding: 20px; text-align: center;">å°šç„¡éƒ¨é–€è³‡æ–™</div>';
            return;
        }

        // åªé¡¯ç¤ºå±¤åˆ¥ç‚º 0 æˆ– null çš„é ‚å±¤éƒ¨é–€
        departmentTreeData.forEach(node => {
            const levelNo = node.LEVelNo; // API è¿”å›çš„æ˜¯ PascalCase
            if (levelNo === 0 || levelNo === null || levelNo === undefined) {
                container.appendChild(createTreeNode(node, 0));
            }
        });
    }

    // å»ºç«‹æ¨¹ç‹€ç¯€é»
    function createTreeNode(node, level) {
        const div = document.createElement('div');
        const levelNo = node.LEVelNo; // API è¿”å›çš„æ˜¯ PascalCase
        const departId = node.DepartId; // API è¿”å›çš„æ˜¯ PascalCase

        // ç¯€é»å®¹å™¨
        const nodeDiv = document.createElement('div');
        nodeDiv.className = 'tree-node';

        // æª¢æŸ¥æ˜¯å¦åœç”¨
        if (node.IsStop === 1) {
            nodeDiv.classList.add('disabled');
        }

        // å±•é–‹/æ”¶åˆæŒ‰éˆ•ï¼ˆåªæœ‰ç•¶æœ‰å­ç¯€é»æ™‚æ‰é¡¯ç¤ºï¼‰
        if (node.HasChildren && node.Children && node.Children.length > 0) {
            const toggle = document.createElement('span');
            toggle.className = 'tree-toggle';
            const isExpanded = expandedNodes.has(departId);
            toggle.innerHTML = isExpanded ? 'âˆ’' : '+';
            toggle.onclick = function(e) {
                e.stopPropagation();
                toggleNode(departId);
            };
            nodeDiv.appendChild(toggle);
        } else {
            // æ²’æœ‰å­ç¯€é»ï¼Œä¸é¡¯ç¤ºç®­é ­ï¼ŒåªåŠ ç©ºç™½
            const spacer = document.createElement('span');
            spacer.style.display = 'inline-block';
            spacer.style.width = '20px';
            nodeDiv.appendChild(spacer);
        }

        // åœ–ç¤º
        const icon = document.createElement('span');
        icon.className = 'tree-node-icon';
        if (levelNo === 0 || levelNo === null || levelNo === undefined) {
            icon.innerHTML = 'ğŸ¢'; // æœ€ä¸Šå±¤éƒ¨é–€
        } else if (node.HasChildren) {
            icon.innerHTML = 'ğŸ“'; // æœ‰å­éƒ¨é–€
        } else {
            icon.innerHTML = 'ğŸ“„'; // æ²’æœ‰å­éƒ¨é–€
        }
        nodeDiv.appendChild(icon);

        // æ–‡å­—
        const text = document.createElement('span');
        text.textContent = `${departId} - ${node.DepartName || ''}`;
        if (node.IsStop === 1) {
            text.textContent += ' (åœç”¨)';
        }
        nodeDiv.appendChild(text);

        div.appendChild(nodeDiv);

        // å­ç¯€é»ï¼ˆå¦‚æœå·²å±•é–‹ä¸”æœ‰å­ç¯€é»ï¼‰
        if (node.Children && node.Children.length > 0) {
            const childrenDiv = document.createElement('div');
            childrenDiv.className = 'tree-children';

            // æ ¹æ“šæ˜¯å¦å±•é–‹ä¾†æ±ºå®šé¡¯ç¤ºç‹€æ…‹
            const isExpanded = expandedNodes.has(departId);
            childrenDiv.style.display = isExpanded ? 'block' : 'none';

            node.Children.forEach(child => {
                childrenDiv.appendChild(createTreeNode(child, level + 1));
            });
            div.appendChild(childrenDiv);
        }

        return div;
    }

    // åˆ‡æ›ç¯€é»å±•é–‹/æ”¶åˆ
    function toggleNode(departId) {
        if (expandedNodes.has(departId)) {
            expandedNodes.delete(departId);
        } else {
            expandedNodes.add(departId);
        }
        renderTree(); // é‡æ–°æ¸²æŸ“
    }

    // åˆ·æ–°æ¨¹ç‹€çµæ§‹ï¼ˆåœ¨æ–°å¢/ä¿®æ”¹/åˆªé™¤å¾Œå‘¼å«ï¼‰
    function refreshTree() {
        loadDepartmentTree();
    }
</script>