@page "/EMOdProdInfo"
@model PcbErpApi.Pages.EMOdProdInfo.IndexModel
@using System.Text.Json
@{
    Layout = "_Layout";
    ViewData["Title"] = Model.PageTitle;
}

<partial name="~/Pages/Shared/_TableSingleGrid.cshtml" model="Model" />

@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", ViewData["FieldDictList"], ViewData)
@if (!string.IsNullOrWhiteSpace(Model.DictTableName))
{
    <script>window._dictTableName = '@Model.DictTableName';</script>
}
@if (ViewData["LoadError"] is string loadErr && !string.IsNullOrWhiteSpace(loadErr))
{
    <div class="alert alert-danger mt-2">資料載入錯誤：@loadErr</div>
}
<script>
  window._singleItemId = '@Model.ItemId';
  window._singleRealTable = '@Model.TableName';
  window._emodProdInfoDetailUrl = '@Url.Page("Detail")';
  window._emodProdInfoKeyFields = @Html.Raw(JsonSerializer.Serialize((Model.KeyFields != null && Model.KeyFields.Count > 0) ? Model.KeyFields : new List<string> { "PartNum", "Revision" }));
</script>
<script>
  window.SingleGridCustomHandlers = window.SingleGridCustomHandlers || {};
  window.SingleGridCustomHandlers.openDetail = function(ctx) {
    const keys = Array.isArray(window._emodProdInfoKeyFields) ? window._emodProdInfoKeyFields : [];
    const row = ctx && ctx.selectedRow;
    if (!row) {
      alert('請先選擇一筆工程資料');
      return;
    }
    const qs = new URLSearchParams();
    keys.forEach(k => {
      const v = row[k] ?? row[k?.toLowerCase()] ?? '';
      if (v !== undefined && v !== null && v !== '') {
        qs.append(k, v);
      }
    });
    if (!qs.toString()) {
      alert('找不到工程資料主鍵，請先在辭典標記主鍵欄位');
      return;
    }
    const url = window._emodProdInfoDetailUrl + '?' + qs.toString();
    window.location.href = url;
  };
</script>
<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>
