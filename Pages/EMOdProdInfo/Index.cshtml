@page
@model PcbErpApi.Pages.EMOdProdInfo.IndexModel
@{
    ViewData["Title"] = "EMOdProdInfo 工程資料維護";
}


<div class="container py-4">
    <h3 class="mb-4 fw-bold">EMOdProdInfo 工程資料維護</h3>
    <button type="button" class="btn btn-outline-info mb-3" onclick="showDictModal()">資料欄位說明 (F3)</button>
    <form method="post" class="bg-white rounded-3 shadow p-4">

        <!-- 主分頁籤（規格/表單） -->
        <ul class="nav nav-tabs mb-3" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="spec-tab" data-bs-toggle="tab" data-bs-target="#spec" type="button" role="tab" aria-controls="spec" aria-selected="true">規格</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="form-tab" data-bs-toggle="tab" data-bs-target="#form" type="button" role="tab" aria-controls="form" aria-selected="false">表單</button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- (下方規格與表單內容省略，照你現在的內容放) -->
              <div class="tab-content" id="mainTabContent">
           <!-- ===== 規格 ===== -->
            <div class="tab-pane fade show active" id="spec" role="tabpanel" aria-labelledby="spec-tab">
                <!-- 次分頁籤略... -->
                <div class="tab-content" id="specSubTabContent">
                    <!-- 外層工程主檔（動態產生）-->
                    <div class="tab-pane fade show active" id="sub-main" role="tabpanel" aria-labelledby="sub-main-tab">
                        <div class="row mb-3">
                            @if (Model.DynamicFields != null && Model.DynamicFields.Any())
                            {
                                @foreach (var field in Model.DynamicFields)
                                {
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">@((!string.IsNullOrWhiteSpace(field.DisplayLabel) ? field.DisplayLabel : field.FieldName))</label>
                                        <input class="form-control"
                                            name="DynamicFormData[@field.FieldName]"
                                            value="@(Model.DynamicFormData.ContainsKey(field.FieldName) ? Model.DynamicFormData[field.FieldName] : "")"
                                            placeholder="" />
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="col-12 text-danger">沒有要顯示的欄位 (DynamicFields)</div>
                            }
                        </div>
                    </div>
                    <!-- 其它 tab-pane... -->
                </div>
            </div>

            <!-- ===== 表單 ===== -->
            <div class="tab-pane fade" id="form" role="tabpanel" aria-labelledby="form-tab">
                <!-- 表單分頁 -->
                <ul class="nav nav-pills mb-3" id="formSubTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="sub-press-tab" data-bs-toggle="pill" data-bs-target="#sub-press" type="button" role="tab" aria-controls="sub-press" aria-selected="true">
                            壓合明細/替代料
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sub-size-tab" data-bs-toggle="pill" data-bs-target="#sub-size" type="button" role="tab" aria-controls="sub-size" aria-selected="false">
                            板材尺寸明細
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sub-layout-tab" data-bs-toggle="pill" data-bs-target="#sub-layout" type="button" role="tab" aria-controls="sub-layout" aria-selected="false">
                            裁板/排版圖
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="formSubTabContent">
                    <!-- 壓合明細/替代料 -->
                    <div class="tab-pane fade show active" id="sub-press" role="tabpanel" aria-labelledby="sub-press-tab">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">壓合層別</label>
                                <input class="form-control" asp-for="PressLayer" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">替代料號</label>
                                <input class="form-control" asp-for="AltMaterialNo" />
                            </div>
                        </div>
                    </div>
                    <!-- 板材尺寸明細 -->
                    <div class="tab-pane fade" id="sub-size" role="tabpanel" aria-labelledby="sub-size-tab">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">材料型號</label>
                                <input class="form-control" asp-for="MaterialModel" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">材料尺寸</label>
                                <input class="form-control" asp-for="MaterialSize" />
                            </div>
                        </div>
                    </div>
                    <!-- 裁板/排版圖 -->
                    <div class="tab-pane fade" id="sub-layout" role="tabpanel" aria-labelledby="sub-layout-tab">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">排版圖號</label>
                                <input class="form-control" asp-for="LayoutNo" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">備註</label>
                                <input class="form-control" asp-for="LayoutRemark" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <div class="text-end mt-4">
            <button type="submit" class="btn btn-primary px-4">儲存</button>
            <button type="reset" class="btn btn-outline-secondary ms-2 px-4">重設</button>
        </div>
    </form>
</div>

<!-- 資料辭典 Modal -->
<div class="modal fade" id="dictModal" tabindex="-1" aria-labelledby="dictModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dictModalLabel">EMOdProdInfo 欄位說明</h5>
        <button type="button" class="btn btn-success ms-2" onclick="saveAllDictFields()">全部儲存</button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered table-sm align-middle">
          <thead>
            <tr>
              <th>欄位名稱</th>
              <th>顯示名稱</th>
              <th>型別</th>
              <th>說明</th>
              <th>序號</th>
              <th>可視</th>
            </tr>
          </thead>
          <tbody id="dictTableBody">
                @foreach (var d in Model.FieldDictList)
                {
                    <tr data-fieldname="@d.FieldName">
                        <td>@d.FieldName</td>
                        <td><input data-field="DisplayLabel" value="@d.DisplayLabel" /></td>
                        <td><input data-field="DataType"  value="@d.DataType" /></td>
                        <td><input data-field="FieldNote" value="@d.FieldNote" /></td>
                        <td><input data-field="SerialNum" type="number" value="@d.SerialNum" style="width:60px;" /></td>
                        <td><input data-field="Visible" type="checkbox" @(d.Visible == 1 ? "checked" : "") /></td>
                    </tr>
                }
            </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- 傳遞 Dictionary 資料到前端 -->
<script>
function showDictModal() {
    let modal = new bootstrap.Modal(document.getElementById('dictModal'));
    modal.show();
}

// 支援 F3 快捷鍵開啟
document.addEventListener('keydown', function(e){
    if(e.key === 'F3') {
        e.preventDefault();
        showDictModal();
    }
});

// 單列儲存
function saveDictField(btn) {
    let $tr = btn.closest('tr');
    let fieldName = $tr.getAttribute('data-fieldname');
    let DisplayLabel = $tr.querySelector('input[data-field="DisplayLabel"]').value;
    let DataType = $tr.querySelector('input[data-field="DataType"]').value;
    let FieldNote = $tr.querySelector('input[data-field="FieldNote"]').value;
    let SerialNum = $tr.querySelector('input[data-field="SerialNum"]').value;
    let Visible = $tr.querySelector('input[data-field="Visible"]').checked ? 1 : 0;

    fetch('/api/DictApi/UpdateDictFields', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })

    .then(res => res.json())
    .then(result => {
        if (result.success) {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
            btn.innerText = "已儲存";
            setTimeout(() => {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
                btn.innerText = "儲存";
            }, 1000);
        } else {
            alert(result.message || "儲存失敗");
        }
    });
}
function saveAllDictFields() {
    const rows = document.querySelectorAll('#dictTableBody tr');
    const data = Array.from(rows).map(tr => {
        const serialNumValue = tr.querySelector('input[data-field="SerialNum"]').value;
        const visibleValue = tr.querySelector('input[data-field="Visible"]').checked ? 1 : 0;
        return {
            FieldName: tr.getAttribute('data-fieldname'),
            DisplayLabel: tr.querySelector('input[data-field="DisplayLabel"]').value,
            DataType: tr.querySelector('input[data-field="DataType"]').value,
            FieldNote: tr.querySelector('input[data-field="FieldNote"]').value,
            SerialNum: serialNumValue === "" ? null : parseInt(serialNumValue, 10),
            Visible: visibleValue
        };
    });

    fetch('/api/DictApi/UpdateDictFields', { // 注意這裡！
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            alert("全部儲存成功！");
            location.reload();
        } else {
            alert(result.message || "儲存失敗！");
        }
    });
}


</script>
