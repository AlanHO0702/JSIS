@page
@model PcbErpApi.Pages.FunctionSetupModel
@{
    ViewData["Title"] = "功能設定";
    Layout = "_Layout";
}

<div class="fs-page">
  <div class="fs-header">
    <div class="fs-head-meta">
      <div class="fs-meta-item">
        <span class="fs-meta-label">功能代碼</span>
        <input id="fsItemCode" class="fs-meta-input" readonly value="@Model.ItemId" />
      </div>
      <div class="fs-meta-item">
        <span class="fs-meta-label">功能名稱</span>
        <input id="fsItemName" class="fs-meta-input fs-meta-wide" readonly value="" />
      </div>
      <div class="fs-meta-item">
        <span class="fs-meta-label">使用模板</span>
        <select id="fsItemTemplate" class="fs-meta-input fs-meta-wide"></select>
        <button id="fsTemplateLookupBtn" type="button" class="btn btn-outline-secondary btn-sm fs-template-lookup">LOOKUP</button>
      </div>
      <div class="fs-meta-item">
        <input id="fsItemTemplateName" class="fs-meta-input fs-meta-wide" readonly value="" />
      </div>
    </div>
  </div>

  <div class="fs-tabs">
    <button class="fs-tab-btn active" data-tab="dict">辭典設定</button>
    <button class="fs-tab-btn" data-tab="sys">系統按鈕控制</button>
    <button class="fs-tab-btn" data-tab="custom">自訂按鈕</button>
    <button class="fs-tab-btn" data-tab="other">設定</button>
  </div>

  <section class="fs-pane active" data-pane="dict">
    <div class="fs-actions fs-toolbar" aria-label="辭典第一階工具列">
      <button id="dictAdd" type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列">+</button>
      <button id="dictDelete" type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列">-</button>
      <button id="dictSave" type="button" class="fs-ibtn" title="儲存更新" aria-label="儲存更新">&#10003;</button>
      <button id="dictReload" type="button" class="fs-ibtn" title="還原未儲存變更" aria-label="還原未儲存變更">&#10005;</button>
    </div>
    <div class="dict-wrap">
      <div class="dict-upper">
        <div class="table-responsive">
          <table class="table table-bordered table-sm align-middle mb-0" id="dictTable" data-dict-table="CURdOCXTableSetUp">
            <thead>
              <tr>
                <th data-field="TableName">DD資料表名稱</th>
                <th data-field="TableKind">資料表區分</th>
                <th data-field="MDKey">對應Master的KEY</th>
                <th data-field="LocateKeys">IndexFieldNames</th>
                <th data-field="OrderByField">排序欄位</th>
                <th data-field="FilterSQL">Filter SQL</th>
                <th data-field="RunSQLAfterAdd">新增後執行SQL</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="dict-split"></div>
      <div class="dict-lower">
        <div class="fs-actions fs-toolbar fs-toolbar-sub" aria-label="辭典第二階工具列">
          <button type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列" disabled>+</button>
          <button type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列" disabled>-</button>
          <button id="tableNameSave" type="button" class="fs-ibtn" title="儲存 TableName" aria-label="儲存 TableName">&#10003;</button>
          <button id="tableNameReload" type="button" class="fs-ibtn" title="還原未儲存變更" aria-label="還原未儲存變更">&#10005;</button>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-sm align-middle mb-0" id="tableNameTable" data-dict-table="CURdTableName">
            <thead>
              <tr>
                <th data-field="TableName">資料表名稱</th>
                <th data-field="DisplayLabel">顯示標籤</th>
                <th data-field="TableNote">資料表註解</th>
                <th data-field="SerialNum">序號</th>
                <th data-field="TableType">資料表類型</th>
                <th data-field="LevelNo">層級</th>
                <th data-field="SystemId">系統別</th>
                <th data-field="SuperId">上層ID</th>
                <th data-field="RealTableName">實際資料表</th>
                <th data-field="OrderByField">排序欄位</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <section class="fs-pane" data-pane="sys">
    <div class="fs-actions fs-toolbar" aria-label="系統按鈕工具列">
      <button id="sysAdd" type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列">+</button>
      <button id="sysDelete" type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列">-</button>
      <button id="sysSave" type="button" class="fs-ibtn" title="儲存" aria-label="儲存">&#10003;</button>
      <button id="sysReload" type="button" class="fs-ibtn" title="還原未儲存變更" aria-label="還原未儲存變更">&#10005;</button>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle" id="sysTable" data-dict-table="CURdOCXItemSysButton">
        <thead>
          <tr>
            <th data-field="SerialNum" style="width:72px;">序號</th>
            <th data-field="ButtonName" style="min-width:120px;">按鈕代碼</th>
            <th data-field="bVisiable" style="width:60px;">顯示</th>
            <th data-field="CustCaption" style="min-width:150px;">顯示名稱(中)</th>
            <th data-field="CustCaptionEN" style="min-width:150px;">顯示名稱(英)</th>
            <th data-field="CustHint" style="min-width:150px;">說明(中)</th>
            <th data-field="CustHintEN" style="min-width:150px;">說明(英)</th>
            <th data-field="bShowMsg" style="width:80px;">顯示訊息</th>
            <th data-field="sCustMsg" style="min-width:200px;">自訂訊息</th>
            <th data-field="bShowMsgAft" style="width:100px;">完成後訊息</th>
            <th data-field="sCustMsgAft" style="min-width:200px;">完成訊息</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="fs-pane" data-pane="custom">
    <div class="fs-actions fs-toolbar" aria-label="自訂按鈕第一階工具列">
      <button id="cbAdd" type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列">+</button>
      <button id="cbDelete" type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列">-</button>
      <button id="cbSave" type="button" class="fs-ibtn" title="儲存" aria-label="儲存">&#10003;</button>
      <button id="cbReload" type="button" class="fs-ibtn" title="還原未儲存變更" aria-label="還原未儲存變更">&#10005;</button>
    </div>
    <div class="table-responsive fs-custom-top">
      <table class="table table-bordered table-sm align-middle" id="cbTable" data-dict-table="CURdOCXItemCustButton">
        <thead>
          <tr>
            <th data-field="SerialNum">序號</th>
            <th data-field="ButtonName">按鈕代碼</th>
            <th data-field="CustCaption">按鈕名稱(中)</th>
            <th data-field="CustCaptionEN">按鈕名稱(英)</th>
            <th data-field="CustHint">提示(中)</th>
            <th data-field="CustHintEN">提示(英)</th>
            <th data-field="OCXName">OCXName</th>
            <th data-field="CoClassName">CoClassName</th>
            <th data-field="SpName">SpName</th>
            <th data-field="bVisible">bVisible</th>
            <th data-field="ChkCanUpdate">ChkCanUpdate</th>
            <th data-field="bNeedNum">bNeedNum</th>
            <th data-field="DesignType">DesignType</th>
            <th data-field="SearchTemplate">SearchTemplate</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="fs-custom-bottom">
      <div class="fs-actions fs-toolbar fs-toolbar-sub mb-1" aria-label="自訂按鈕第二階工具列">
        <button type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列" disabled>+</button>
        <button type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列" disabled>-</button>
        <button type="button" class="fs-ibtn" title="儲存明細" aria-label="儲存明細" disabled>&#10003;</button>
        <button id="cbDetailReload" type="button" class="fs-ibtn" title="還原未儲存變更" aria-label="還原未儲存變更">&#10005;</button>
      </div>
      <div class="small text-muted mb-2">目前按鈕：<span id="cbCurrentBtn">（未選擇）</span></div>
      <div class="fs-subtabs">
        <button class="fs-subtab-btn active" data-subtab="sp">設定(1)</button>
        <button class="fs-subtab-btn" data-subtab="ik">設定(2)</button>
      </div>
      <div class="fs-subpane active" data-subpane="sp">
        <div class="card">
          <div class="card-header py-1">設定(1) CURdOCXSearchParams</div>
          <div class="table-responsive">
            <table class="table table-bordered table-sm mb-0" id="spTable" data-dict-table="CURdOCXSearchParams">
              <thead>
                <tr>
                  <th data-field="ParamSN">序</th>
                  <th data-field="ParamName">參數代碼</th>
                  <th data-field="DisplayName">外顯名稱</th>
                  <th data-field="EditMask">格式</th>
                  <th data-field="SuperId">上層參數</th>
                  <th data-field="ControlType">控制項</th>
                  <th data-field="DefaultType">預設型態</th>
                  <th data-field="CommandText">CommandText</th>
                  <th data-field="DefaultValue">DefaultValue</th>
                  <th data-field="ParamValue">ParamValue</th>
                  <th data-field="ParamType">ParamType</th>
                  <th data-field="iReadOnly">唯讀</th>
                  <th data-field="iVisible">可視</th>
                  <th data-field="TableKind">TableKind</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="fs-subpane" data-subpane="ik">
        <div class="card">
          <div class="card-header py-1">設定(2) CURdOCXItmCusBtnInsKey</div>
          <div class="table-responsive">
            <table class="table table-bordered table-sm mb-0" id="ikTable" data-dict-table="CURdOCXItmCusBtnInsKey">
              <thead>
                <tr>
                  <th data-field="SeqNum">順序</th>
                  <th data-field="KeyFieldName">鍵值欄位</th>
                  <th data-field="PositionType">資料來源位置</th>
                  <th data-field="PositionTypeName">名稱</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="fs-pane" data-pane="other">
    <div class="fs-actions fs-toolbar" aria-label="設定工具列">
      <button id="orAdd" type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列">+</button>
      <button id="orDelete" type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列">-</button>
      <button id="orSave" type="button" class="fs-ibtn" title="儲存" aria-label="儲存">&#10003;</button>
      <button id="orReload" type="button" class="fs-ibtn" title="還原未儲存變更" aria-label="還原未儲存變更">&#10005;</button>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle" id="otherRuleTable" data-dict-table="CURdOCXItemOtherRule">
        <thead>
          <tr>
            <th data-field="RuleId">規則代碼</th>
            <th data-field="Lk_RuleName">規則名稱</th>
            <th data-field="DLLValue">DLL 值</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<partial name="Shared/_FieldDictModal" model="@(new List<CURdTableField>())" />
<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>

<div class="modal fade" id="templateLookupModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="width: 560px; max-width: 560px;">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h5 class="modal-title">模板查詢</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-2 pb-2" style="height: 440px; display:flex; flex-direction:column;">
        <div class="d-flex gap-2 mb-2">
          <input type="text" id="templateLookupFilterCode" class="form-control form-control-sm" placeholder="模板代碼" />
          <input type="text" id="templateLookupFilterName" class="form-control form-control-sm" placeholder="模板名稱" />
        </div>
        <div style="border:1px solid #d8deed; border-radius:6px; flex:1; overflow:auto;">
          <table class="table table-sm table-hover table-bordered mb-0" id="templateLookupTable">
            <thead style="position:sticky;top:0;z-index:1;background:#f5f8ff;">
              <tr>
                <th style="width:45%;">使用模板</th>
                <th style="width:55%;">模板名稱</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer py-2">
        <button id="templateLookupConfirmBtn" type="button" class="btn btn-primary btn-sm">確定</button>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<script>
const itemId = "@Model.ItemId";
let dictCurrentRow = null;
let customRows = [];
let selectedCustomIdx = -1;
let otherRuleOptions = [];
const dictMetaCache = {};
let templateOptions = [];
let selectedTemplateLookupRow = null;
let templateLookupModalInstance = null;
let currentTemplateCode = "";
const dictFieldAliasMap = {
  CustCaptionEN: ["CustCaptionE"],
  CustHintEN: ["CustHintE"],
  CustCaptionE: ["CustCaptionEN"],
  CustHintE: ["CustHintEN"]
};
const dictGridMap = {
  dictTable: "CURdOCXTableSetUp",
  tableNameTable: "CURdTableName",
  sysTable: "CURdOCXItemSysButton",
  cbTable: "CURdOCXItemCustButton",
  spTable: "CURdOCXSearchParams",
  ikTable: "CURdOCXItmCusBtnInsKey",
  otherRuleTable: "CURdOCXItemOtherRule"
};

const pick = (o, ...keys) => { for (const k of keys) if (o && o[k] != null) return o[k]; return ""; };
const esc = (s) => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;");
const num = (v) => { const s = String(v ?? "").trim(); if (!s) return null; const n = Number(s); return Number.isFinite(n) ? n : null; };

document.querySelectorAll(".fs-tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const tab = btn.dataset.tab;
    document.querySelectorAll(".fs-tab-btn").forEach(b => b.classList.toggle("active", b === btn));
    document.querySelectorAll(".fs-pane").forEach(p => p.classList.toggle("active", p.dataset.pane === tab));
  });
});

document.querySelectorAll(".fs-subtab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const tab = btn.dataset.subtab;
    document.querySelectorAll(".fs-subtab-btn").forEach(b => b.classList.toggle("active", b === btn));
    document.querySelectorAll(".fs-subpane").forEach(p => p.classList.toggle("active", p.dataset.subpane === tab));
  });
});

document.getElementById("dictAdd").addEventListener("click", addDictRow);
document.getElementById("dictDelete").addEventListener("click", deleteDictRow);
document.getElementById("dictReload").addEventListener("click", () => loadDict().catch(ex => alert(ex.message || ex)));
document.getElementById("dictSave").addEventListener("click", () => saveDict().catch(ex => alert(ex.message || ex)));
document.getElementById("tableNameReload").addEventListener("click", () => reloadTableName().catch(ex => alert(ex.message || ex)));
document.getElementById("tableNameSave").addEventListener("click", () => saveTableName().catch(ex => alert(ex.message || ex)));
document.getElementById("sysAdd").addEventListener("click", addSysRow);
document.getElementById("sysDelete").addEventListener("click", deleteSysRow);
document.getElementById("sysReload").addEventListener("click", () => loadSys().catch(ex => alert(ex.message || ex)));
document.getElementById("sysSave").addEventListener("click", () => saveSys().catch(ex => alert(ex.message || ex)));
document.getElementById("cbReload").addEventListener("click", () => loadCustom().catch(ex => alert(ex.message || ex)));
document.getElementById("cbAdd").addEventListener("click", addCustomRow);
document.getElementById("cbDelete").addEventListener("click", deleteCustomRow);
document.getElementById("cbSave").addEventListener("click", () => saveCustom().catch(ex => alert(ex.message || ex)));
document.getElementById("cbDetailReload").addEventListener("click", () => reloadCustomDetail().catch(ex => alert(ex.message || ex)));
document.getElementById("orAdd").addEventListener("click", addOtherRuleRow);
document.getElementById("orDelete").addEventListener("click", deleteOtherRuleRow);
document.getElementById("orSave").addEventListener("click", () => saveOtherRule().catch(ex => alert(ex.message || ex)));
document.getElementById("orReload").addEventListener("click", () => loadOtherRule().catch(ex => alert(ex.message || ex)));
document.getElementById("fsTemplateLookupBtn").addEventListener("click", openTemplateLookup);
document.getElementById("templateLookupConfirmBtn").addEventListener("click", confirmTemplateLookup);
document.getElementById("templateLookupFilterCode").addEventListener("input", renderTemplateLookupRows);
document.getElementById("templateLookupFilterName").addEventListener("input", renderTemplateLookupRows);
document.getElementById("fsItemTemplate").addEventListener("change", async (e) => {
  try {
    await setTemplateValueAndSave(String(e.target.value || "").trim());
  } catch (ex) {
    alert(ex.message || ex);
  }
});

window.SUPPRESS_DICT_FETCH_ALERT = true;
window._dictTableName = "CURdOCXTableSetUp";

async function loadAll(){
  if (!itemId) { alert("缺少 itemId，請從功能項目維護頁進入。"); return; }
  await initGridDictionaryMeta();
  await loadHeaderMeta();
  await Promise.all([loadDict(), loadSys(), loadCustom(), loadOtherRule()]);
  bindDictContextFromFocus();
}

async function loadHeaderMeta() {
  try {
    const res = await fetch(`/api/QuickLaunch/Item/${encodeURIComponent(itemId)}`);
    if (!res.ok) return;
    const item = await res.json();
    const programName = pick(item, "programName", "ProgramName", "itemName", "ItemName");

    const nameInput = document.getElementById("fsItemName");
    const tplInput = document.getElementById("fsItemTemplate");
    const ocxTemplete = String(pick(item, "ocxTemplete", "OcxTemplete", "OCXTemplete") || "").trim();
    await ensureTemplateOptionsLoaded();
    if (nameInput) nameInput.value = programName || "";
    if (tplInput) tplInput.value = ocxTemplete || "";
    currentTemplateCode = ocxTemplete || "";
    applyTemplateNameByCode(ocxTemplete);
  } catch {}
}

async function ensureTemplateOptionsLoaded(forceReload = false) {
  if (!forceReload && templateOptions.length > 0) return;
  const select = document.getElementById("fsItemTemplate");
  if (!select) return;
  try {
    const res = await fetch("/api/EditItemApi/OcxTempleteOptions");
    if (!res.ok) return;
    const rows = await res.json();
    templateOptions = Array.isArray(rows) ? rows : [];
  } catch {
    templateOptions = [];
  }
  const optionsHtml = [`<option value=""></option>`]
    .concat((templateOptions || []).map(x => {
      const code = String(x?.OcxTemplete || "").trim();
      const name = String(x?.OcxTempleteName || "").trim();
      return `<option value="${esc(code)}">${esc(code)}${name ? ` - ${esc(name)}` : ""}</option>`;
    }))
    .join("");
  select.innerHTML = optionsHtml;
}

function applyTemplateNameByCode(code) {
  const tplNameInput = document.getElementById("fsItemTemplateName");
  if (!tplNameInput) return;
  const hit = (templateOptions || []).find(x =>
    String(x?.OcxTemplete || "").trim().toLowerCase() === String(code || "").trim().toLowerCase()
  );
  tplNameInput.value = String(hit?.OcxTempleteName || "").trim() || "單據(JS ERP)";
}

async function setTemplateValueAndSave(code) {
  const normalized = String(code || "").trim();
  const select = document.getElementById("fsItemTemplate");
  const previousCode = String(currentTemplateCode || "").trim();
  if (select) select.value = normalized;
  applyTemplateNameByCode(normalized);

  if (!itemId) {
    currentTemplateCode = normalized;
    return;
  }

  try {
    await saveHeaderTemplate(normalized);
    currentTemplateCode = normalized;
  } catch (ex) {
    if (select) select.value = previousCode;
    applyTemplateNameByCode(previousCode);
    throw ex;
  }
}

async function saveHeaderTemplate(code) {
  const res = await fetch("/api/EditItemApi/UpdateOcxTemplete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ItemId: itemId, OcxTemplete: code || "" })
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok || data?.success !== true) throw new Error(data?.message || "更新使用模板失敗");
}

function getTemplateLookupModal() {
  if (!templateLookupModalInstance) {
    const el = document.getElementById("templateLookupModal");
    templateLookupModalInstance = bootstrap.Modal.getOrCreateInstance(el);
  }
  return templateLookupModalInstance;
}

function renderTemplateLookupRows() {
  const codeFilter = String(document.getElementById("templateLookupFilterCode").value || "").trim().toUpperCase();
  const nameFilter = String(document.getElementById("templateLookupFilterName").value || "").trim().toUpperCase();
  const rows = (templateOptions || []).filter(x => {
    const code = String(x?.OcxTemplete || "").toUpperCase();
    const name = String(x?.OcxTempleteName || "").toUpperCase();
    const okCode = !codeFilter || code.includes(codeFilter);
    const okName = !nameFilter || name.includes(nameFilter);
    return okCode && okName;
  });

  const tbody = document.querySelector("#templateLookupTable tbody");
  selectedTemplateLookupRow = null;
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="2" class="text-center text-muted py-3">查無資料</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(x => {
    const code = String(x?.OcxTemplete || "").trim();
    const name = String(x?.OcxTempleteName || "").trim();
    return `<tr data-code="${esc(code)}" data-name="${esc(name)}">
      <td>${esc(code)}</td><td>${esc(name)}</td>
    </tr>`;
  }).join("");

  tbody.querySelectorAll("tr[data-code]").forEach(tr => {
    tr.addEventListener("click", () => {
      tbody.querySelectorAll("tr").forEach(x => x.classList.remove("table-primary"));
      tr.classList.add("table-primary");
      selectedTemplateLookupRow = tr;
    });
    tr.addEventListener("dblclick", async () => {
      selectedTemplateLookupRow = tr;
      await confirmTemplateLookup();
    });
  });

  const current = String(document.getElementById("fsItemTemplate")?.value || "").trim().toLowerCase();
  if (current) {
    const hit = Array.from(tbody.querySelectorAll("tr[data-code]"))
      .find(tr => String(tr.dataset.code || "").trim().toLowerCase() === current);
    if (hit) {
      hit.classList.add("table-primary");
      selectedTemplateLookupRow = hit;
    }
  }
}

async function openTemplateLookup() {
  await ensureTemplateOptionsLoaded(true);
  document.getElementById("templateLookupFilterCode").value = "";
  document.getElementById("templateLookupFilterName").value = "";
  renderTemplateLookupRows();
  getTemplateLookupModal().show();
}

async function confirmTemplateLookup() {
  if (!selectedTemplateLookupRow) {
    if (window.Swal) {
      Swal.fire({ icon: "warning", title: "請先選擇模板", timer: 1400, showConfirmButton: false });
    } else {
      alert("請先選擇模板");
    }
    return;
  }
  const code = selectedTemplateLookupRow.dataset.code || "";
  try {
    await setTemplateValueAndSave(code);
    getTemplateLookupModal().hide();
  } catch (ex) {
    alert(ex.message || ex);
  }
}

function bindDictContextFromFocus() {
  document.querySelectorAll("[data-dict-table]").forEach(el => {
    const fn = () => {
      const t = el.dataset.dictTable || "";
      if (t) window._dictTableName = t;
    };
    el.addEventListener("focusin", fn);
    el.addEventListener("pointerdown", fn);
  });
}

async function ensureDictMeta(dictTable) {
  const key = String(dictTable || "").trim();
  if (!key) return {};
  if (dictMetaCache[key]) return dictMetaCache[key];
  const res = await fetch(`/api/TableFieldLayout/GetTableFieldsFull?table=${encodeURIComponent(key)}&lang=TW`);
  if (!res.ok) { dictMetaCache[key] = {}; return dictMetaCache[key]; }
  const rows = await res.json();
  const map = {};
  (rows || []).forEach(r => {
    const name = String(r?.FieldName || "").trim();
    if (!name) return;
    map[name.toLowerCase()] = r;
  });
  dictMetaCache[key] = map;
  return map;
}

function getMetaWidthPx(meta) {
  const w1 = Number(meta?.iFieldWidth ?? 0);
  if (Number.isFinite(w1) && w1 > 0) return w1;
  const w2 = Number(meta?.DisplaySize ?? 0);
  if (Number.isFinite(w2) && w2 > 0) return Math.max(70, w2 * 10);
  return 0;
}

async function applyGridDictionaryMeta(tableId) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const dictTable = table.dataset.dictTable || dictGridMap[tableId] || "";
  if (!dictTable) return;
  const metaMap = await ensureDictMeta(dictTable);

  table.querySelectorAll("thead th[data-field]").forEach(th => {
    const field = String(th.dataset.field || "").trim();
    if (!field) return;
    const candidates = [field, ...(dictFieldAliasMap[field] || [])];
    let meta = null;
    for (const name of candidates) {
      meta = metaMap[String(name).toLowerCase()];
      if (meta) break;
    }
    if (!meta) return;
    const label = String(meta.DisplayLabel || "").trim();
    if (label) th.textContent = label;
    const px = getMetaWidthPx(meta);
    if (px > 0) {
      th.style.minWidth = `${px}px`;
      th.style.width = `${px}px`;
      th.style.maxWidth = `${px}px`;
    }
  });
}

function applyGridColumnWidths(tableId) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const headers = Array.from(table.querySelectorAll("thead th"));
  const rows = Array.from(table.querySelectorAll("tbody tr"));
  if (!headers.length || !rows.length) return;

  headers.forEach((th, idx) => {
    const width = String(th.style.width || th.style.minWidth || "").trim();
    if (!width) return;
    rows.forEach(tr => {
      const td = tr.children[idx];
      if (!td) return;
      td.style.width = width;
      td.style.minWidth = width;
      td.style.maxWidth = width;
    });
  });
}

async function refreshGridLayout(tableId) {
  await applyGridDictionaryMeta(tableId);
  applyGridColumnWidths(tableId);
}

async function initGridDictionaryMeta() {
  for (const tableId of Object.keys(dictGridMap)) {
    try { await refreshGridLayout(tableId); } catch {}
  }
}

function createDictRow(r = {}){
  const tr = document.createElement("tr");
  tr.dataset.tableName = r.TableName || "";
  tr.innerHTML = `
    <td><input class="form-control form-control-sm" value="${esc(r.TableName)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(r.TableKind)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(r.MDKey)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(r.LocateKeys)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(r.OrderByField)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(r.FilterSQL)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(r.RunSQLAfterAdd)}"></td>`;
  tr.addEventListener("click", async () => {
    document.querySelectorAll("#dictTable tbody tr").forEach(x => x.classList.remove("active"));
    tr.classList.add("active");
    tr.dataset.tableName = tr.querySelector("td:nth-child(1) input")?.value?.trim() || "";
    dictCurrentRow = tr;
    await loadTableName(tr.dataset.tableName);
  });
  return tr;
}

function addDictRow(){
  const tbody = document.querySelector("#dictTable tbody");
  const tr = createDictRow({});
  tbody.appendChild(tr);
  applyGridColumnWidths("dictTable");
  tr.click();
}

function deleteDictRow(){
  const tr = document.querySelector("#dictTable tbody tr.active");
  if (!tr) return;
  tr.remove();
  dictCurrentRow = null;
  document.querySelector("#tableNameTable tbody").innerHTML = '<tr><td colspan="10" class="text-center text-muted">請先選上方資料列</td></tr>';
}

async function loadDict(){
  const res = await fetch(`/api/DictSetupApi/Table/ByItem/${encodeURIComponent(itemId)}`);
  if (!res.ok) throw new Error("載入辭典設定失敗");
  const rows = await res.json();
  const tbody = document.querySelector("#dictTable tbody");
  tbody.innerHTML = "";
  dictCurrentRow = null;
  document.querySelector("#tableNameTable tbody").innerHTML = '<tr><td colspan="10" class="text-center text-muted">請先選上方資料列</td></tr>';
  rows.forEach(r => {
    tbody.appendChild(createDictRow(r));
  });
  await refreshGridLayout("dictTable");
}

async function loadTableName(tableName){
  const res = await fetch(`/api/DictSetupApi/TableName/${encodeURIComponent(tableName)}`);
  const tbody = document.querySelector("#tableNameTable tbody");
  if (!res.ok) { tbody.innerHTML = '<tr><td colspan="10" class="text-center text-warning">查無資料</td></tr>'; return; }
  const d = await res.json();
  tbody.innerHTML = `<tr data-table-name="${esc(d.TableName)}">
    <td>${esc(d.TableName)}</td>
    <td><input class="form-control form-control-sm" value="${esc(d.DisplayLabel)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(d.TableNote)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(d.SerialNum)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(d.TableType)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(d.LevelNo)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(d.SystemId)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(d.SuperId)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(d.RealTableName)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(d.OrderByField)}"></td>
  </tr>`;
  await refreshGridLayout("tableNameTable");
}

async function reloadTableName(){
  if (dictCurrentRow?.dataset?.tableName) {
    await loadTableName(dictCurrentRow.dataset.tableName);
    return;
  }
  const first = document.querySelector("#dictTable tbody tr");
  if (!first) return;
  first.classList.add("active");
  dictCurrentRow = first;
  await loadTableName(first.dataset.tableName || "");
}

async function saveDict(){
  const payload = Array.from(document.querySelectorAll("#dictTable tbody tr")).map(tr => {
    const t = tr.querySelectorAll("td");
    return {
      ItemId: itemId,
      TableName: t[0].querySelector("input").value,
      TableKind: t[1].querySelector("input").value,
      MDKey: t[2].querySelector("input").value,
      LocateKeys: t[3].querySelector("input").value,
      OrderByField: t[4].querySelector("input").value,
      FilterSQL: t[5].querySelector("input").value,
      RunSQLAfterAdd: t[6].querySelector("input").value
    };
  });
  const res = await fetch("/api/DictSetupApi/Table/UpdateByItem", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  const data = await res.json();
  if (!res.ok || data?.success !== true) throw new Error(data?.message || "儲存失敗");
  alert(`更新成功（${data.count} 筆）`);
}

async function saveTableName(){
  const tr = document.querySelector("#tableNameTable tbody tr[data-table-name]");
  if (!tr) return;
  const t = tr.querySelectorAll("td");
  const payload = {
    TableName: tr.dataset.tableName,
    DisplayLabel: t[1].querySelector("input").value,
    TableNote: t[2].querySelector("input").value,
    SerialNum: num(t[3].querySelector("input").value),
    TableType: num(t[4].querySelector("input").value),
    LevelNo: num(t[5].querySelector("input").value),
    SystemId: t[6].querySelector("input").value,
    SuperId: t[7].querySelector("input").value,
    RealTableName: t[8].querySelector("input").value,
    OrderByField: t[9].querySelector("input").value
  };
  const res = await fetch("/api/DictSetupApi/TableName/Update", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  const data = await res.json();
  if (!res.ok || data?.success !== true) throw new Error(data?.message || "儲存失敗");
  alert("TableName 更新成功");
}

function createSysRow(r = {}, isNew = false){
  const tr = document.createElement("tr");
  tr.dataset.buttonName = r.ButtonName || "";
  tr.innerHTML = `
    <td><input class="form-control form-control-sm text-end" value="${esc(r.SerialNum)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(r.ButtonName)}" ${isNew ? "" : "readonly"}></td>
    <td class="text-center"><input type="checkbox" class="form-check-input" ${Number(r.bVisiable) === 1 ? "checked" : ""}></td>
    <td><input class="form-control form-control-sm" value="${esc(r.CustCaption)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(r.CustCaptionEN)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(r.CustHint)}"></td>
    <td><input class="form-control form-control-sm" value="${esc(r.CustHintEN)}"></td>
    <td class="text-center"><input type="checkbox" class="form-check-input" ${Number(r.bShowMsg) === 1 ? "checked" : ""}></td>
    <td><input class="form-control form-control-sm" value="${esc(r.sCustMsg)}"></td>
    <td class="text-center"><input type="checkbox" class="form-check-input" ${Number(r.bShowMsgAft) === 1 ? "checked" : ""}></td>
    <td><input class="form-control form-control-sm" value="${esc(r.sCustMsgAft)}"></td>`;
  tr.addEventListener("click", () => {
    document.querySelectorAll("#sysTable tbody tr").forEach(x => x.classList.remove("active"));
    tr.classList.add("active");
  });
  return tr;
}

function addSysRow(){
  const tbody = document.querySelector("#sysTable tbody");
  const nextSerial = (tbody.querySelectorAll("tr").length + 1) * 10;
  const tr = createSysRow({ SerialNum: nextSerial, bVisiable: 1 }, true);
  tbody.appendChild(tr);
  applyGridColumnWidths("sysTable");
  tr.click();
}

function deleteSysRow(){
  const tr = document.querySelector("#sysTable tbody tr.active");
  if (!tr) return;
  tr.remove();
}

async function loadSys(){
  const res = await fetch(`/api/DictSetupApi/SysButton/ByItem/${encodeURIComponent(itemId)}`);
  if (!res.ok) throw new Error("載入系統按鈕失敗");
  const rows = await res.json();
  const tbody = document.querySelector("#sysTable tbody");
  tbody.innerHTML = "";
  rows.forEach(r => {
    tbody.appendChild(createSysRow(r, false));
  });
  await refreshGridLayout("sysTable");
}

async function saveSys(){
  const payload = Array.from(document.querySelectorAll("#sysTable tbody tr")).map(tr => {
    const t = tr.querySelectorAll("td");
    const buttonName = tr.dataset.buttonName || t[1].querySelector("input").value.trim();
    if (!buttonName) return null;
    return {
      ItemId: itemId,
      ButtonName: buttonName,
      SerialNum: num(t[0].querySelector("input").value),
      bVisiable: t[2].querySelector("input").checked ? 1 : 0,
      CustCaption: t[3].querySelector("input").value,
      CustCaptionEN: t[4].querySelector("input").value,
      CustHint: t[5].querySelector("input").value,
      CustHintEN: t[6].querySelector("input").value,
      bShowMsg: t[7].querySelector("input").checked ? 1 : 0,
      sCustMsg: t[8].querySelector("input").value,
      bShowMsgAft: t[9].querySelector("input").checked ? 1 : 0,
      sCustMsgAft: t[10].querySelector("input").value
    };
  }).filter(x => x);
  const res = await fetch("/api/DictSetupApi/SysButton/Save", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  const data = await res.json();
  if (!res.ok || data?.success !== true) throw new Error(data?.message || "儲存失敗");
  alert(`已儲存 ${data.count} 筆系統按鈕設定`);
}

function appendCustomRow(r){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input class="form-control form-control-sm" value="${esc(pick(r,"SerialNum","serialNum"))}"></td>
    <td><input class="form-control form-control-sm" value="${esc(pick(r,"ButtonName","buttonName"))}"></td>
    <td><input class="form-control form-control-sm" value="${esc(pick(r,"CustCaption","custCaption"))}"></td>
    <td><input class="form-control form-control-sm" value="${esc(pick(r,"CustCaptionE","custCaptionE"))}"></td>
    <td><input class="form-control form-control-sm" value="${esc(pick(r,"CustHint","custHint"))}"></td>
    <td><input class="form-control form-control-sm" value="${esc(pick(r,"CustHintE","custHintE"))}"></td>
    <td><input class="form-control form-control-sm" value="${esc(pick(r,"OCXName","ocxName"))}"></td>
    <td><input class="form-control form-control-sm" value="${esc(pick(r,"CoClassName","coClassName"))}"></td>
    <td><input class="form-control form-control-sm" value="${esc(pick(r,"SpName","spName"))}"></td>
    <td><input class="form-control form-control-sm" value="${esc(pick(r,"bVisible","BVisible","visible"))}"></td>
    <td><input class="form-control form-control-sm" value="${esc(pick(r,"ChkCanUpdate","chkCanUpdate","canUpdate"))}"></td>
    <td><input class="form-control form-control-sm" value="${esc(pick(r,"bNeedNum","BNeedNum","needNum"))}"></td>
    <td><input class="form-control form-control-sm" value="${esc(pick(r,"DesignType","designType"))}"></td>
    <td><input class="form-control form-control-sm" value="${esc(pick(r,"SearchTemplate","searchTemplate"))}"></td>`;
  tr.addEventListener("click", () => selectCustomRow(tr));
  document.querySelector("#cbTable tbody").appendChild(tr);
}

async function loadCustom(){
  const res = await fetch(`/api/CustomButtonApi/ByItem/${encodeURIComponent(itemId)}`);
  if (!res.ok) throw new Error("載入自訂按鈕失敗");
  customRows = await res.json();
  const tbody = document.querySelector("#cbTable tbody");
  tbody.innerHTML = "";
  selectedCustomIdx = -1;
  customRows.forEach(appendCustomRow);
  await refreshGridLayout("cbTable");
  document.querySelector("#spTable tbody").innerHTML = "";
  document.querySelector("#ikTable tbody").innerHTML = "";
  document.getElementById("cbCurrentBtn").textContent = "（未選擇）";
}

function addCustomRow(){
  appendCustomRow({ SerialNum: (document.querySelectorAll("#cbTable tbody tr").length + 1) * 10 });
  applyGridColumnWidths("cbTable");
}

function deleteCustomRow(){
  const tr = document.querySelector("#cbTable tbody tr.table-primary");
  if (!tr) return;
  tr.remove();
  selectedCustomIdx = -1;
  document.getElementById("cbCurrentBtn").textContent = "（未選擇）";
  document.querySelector("#spTable tbody").innerHTML = "";
  document.querySelector("#ikTable tbody").innerHTML = "";
}

async function selectCustomRow(tr){
  document.querySelectorAll("#cbTable tbody tr").forEach(x => x.classList.remove("table-primary"));
  tr.classList.add("table-primary");
  selectedCustomIdx = Array.from(tr.parentElement.children).indexOf(tr);
  const btnName = tr.querySelector("td:nth-child(2) input").value.trim();
  document.getElementById("cbCurrentBtn").textContent = btnName || "（未命名）";
  if (!btnName) return;
  const res = await fetch(`/api/CustomButtonApi/Detail/${encodeURIComponent(itemId)}/${encodeURIComponent(btnName)}`);
  if (!res.ok) return;
  const d = await res.json();
  const sp = pick(d, "SearchParams", "searchParams") || [];
  const ik = pick(d, "InsertKeys", "insertKeys") || [];
  document.querySelector("#spTable tbody").innerHTML = sp.map(x => `<tr>
      <td>${esc(pick(x,"ParamSN","paramSN"))}</td><td>${esc(pick(x,"ParamName","paramName"))}</td><td>${esc(pick(x,"DisplayName","displayName"))}</td>
      <td>${esc(pick(x,"EditMask","editMask"))}</td><td>${esc(pick(x,"SuperId","superId"))}</td><td>${esc(pick(x,"ControlType","controlType"))}</td>
      <td>${esc(pick(x,"DefaultType","defaultType"))}</td><td>${esc(pick(x,"CommandText","commandText"))}</td><td>${esc(pick(x,"DefaultValue","defaultValue"))}</td>
      <td>${esc(pick(x,"ParamValue","paramValue"))}</td><td>${esc(pick(x,"ParamType","paramType"))}</td><td>${esc(pick(x,"iReadOnly","iReadOnly"))}</td>
      <td>${esc(pick(x,"iVisible","iVisible"))}</td><td>${esc(pick(x,"TableKind","tableKind"))}</td></tr>`).join("");
  document.querySelector("#ikTable tbody").innerHTML = ik.map(x => `<tr>
      <td>${esc(pick(x,"SeqNum","seqNum"))}</td><td>${esc(pick(x,"KeyFieldName","keyFieldName"))}</td>
      <td>${esc(pick(x,"PositionType","positionType"))}</td><td>${esc(pick(x,"PositionTypeName","positionTypeName"))}</td></tr>`).join("");
  await refreshGridLayout("spTable");
  await refreshGridLayout("ikTable");
}

async function reloadCustomDetail(){
  const tr = document.querySelector("#cbTable tbody tr.table-primary");
  if (tr) {
    await selectCustomRow(tr);
    return;
  }
  const first = document.querySelector("#cbTable tbody tr");
  if (!first) return;
  await selectCustomRow(first);
}

async function saveCustom(){
  const payload = Array.from(document.querySelectorAll("#cbTable tbody tr")).map(tr => {
    const t = tr.querySelectorAll("td");
    return {
      ItemId: itemId,
      SerialNum: num(t[0].querySelector("input").value),
      ButtonName: t[1].querySelector("input").value.trim(),
      CustCaption: t[2].querySelector("input").value,
      CustCaptionE: t[3].querySelector("input").value,
      CustHint: t[4].querySelector("input").value,
      CustHintE: t[5].querySelector("input").value,
      OCXName: t[6].querySelector("input").value,
      CoClassName: t[7].querySelector("input").value,
      SpName: t[8].querySelector("input").value,
      bVisible: num(t[9].querySelector("input").value),
      ChkCanUpdate: num(t[10].querySelector("input").value),
      bNeedNum: num(t[11].querySelector("input").value),
      DesignType: num(t[12].querySelector("input").value),
      SearchTemplate: t[13].querySelector("input").value
    };
  });
  const res = await fetch("/api/CustomButtonApi/Save", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  const data = await res.json();
  if (!res.ok || data?.success !== true) throw new Error(data?.message || "儲存失敗");
  alert(`已儲存 ${data.count} 筆自訂按鈕`);
  await loadCustom();
}

function createOtherRuleRow(r = {}) {
  const tr = document.createElement("tr");
  const currentRuleId = pick(r, "RuleId", "ruleId");
  const currentRuleName = pick(r, "Lk_RuleName", "RuleName", "ruleName");
  const hasCurrent = (otherRuleOptions || []).some(x => String(pick(x, "RuleId", "ruleId")) === String(currentRuleId || ""));
  const normalizedOptions = [...(otherRuleOptions || [])];
  if (currentRuleId && !hasCurrent) {
    normalizedOptions.unshift({ RuleId: currentRuleId, RuleName: currentRuleName || currentRuleId });
  }
  const opts = normalizedOptions.map(x => {
    const rid = String(pick(x, "RuleId", "ruleId"));
    const rnm = String(pick(x, "RuleName", "ruleName"));
    const selected = rid === String(currentRuleId || "") ? "selected" : "";
    return `<option value="${esc(rid)}" data-name="${esc(rnm)}" ${selected}>${esc(rid)} - ${esc(rnm)}</option>`;
  }).join("");

  tr.innerHTML = `
    <td><select class="form-select form-select-sm">${opts}</select></td>
    <td><input class="form-control form-control-sm" value="${esc(currentRuleName)}" readonly></td>
    <td><input class="form-control form-control-sm" value="${esc(pick(r, "DLLValue", "dllValue"))}"></td>`;

  const sel = tr.querySelector("td:nth-child(1) select");
  const ruleNameInput = tr.querySelector("td:nth-child(2) input");
  if (!ruleNameInput.value) {
    ruleNameInput.value = sel.options[sel.selectedIndex]?.getAttribute("data-name") || "";
  }
  sel.addEventListener("change", () => {
    const text = sel.options[sel.selectedIndex]?.getAttribute("data-name") || "";
    ruleNameInput.value = text;
  });

  tr.addEventListener("click", () => {
    document.querySelectorAll("#otherRuleTable tbody tr").forEach(x => x.classList.remove("active"));
    tr.classList.add("active");
  });
  return tr;
}

async function loadOtherRuleOptions() {
  const res = await fetch("/api/DictSetupApi/OtherRule/Options");
  if (!res.ok) { otherRuleOptions = []; return; }
  otherRuleOptions = await res.json();
}

async function loadOtherRule() {
  await loadOtherRuleOptions();
  const res = await fetch(`/api/DictSetupApi/OtherRule/ByItem/${encodeURIComponent(itemId)}`);
  if (!res.ok) throw new Error("載入設定失敗");
  const rows = await res.json();
  const tbody = document.querySelector("#otherRuleTable tbody");
  tbody.innerHTML = "";
  (rows || []).forEach(r => tbody.appendChild(createOtherRuleRow(r)));
  await refreshGridLayout("otherRuleTable");
}

function addOtherRuleRow() {
  const tbody = document.querySelector("#otherRuleTable tbody");
  const tr = createOtherRuleRow({});
  tbody.appendChild(tr);
  applyGridColumnWidths("otherRuleTable");
  tr.click();
}

function deleteOtherRuleRow() {
  const tr = document.querySelector("#otherRuleTable tbody tr.active");
  if (!tr) return;
  tr.remove();
}

async function saveOtherRule() {
  const payload = Array.from(document.querySelectorAll("#otherRuleTable tbody tr")).map(tr => {
    const t = tr.querySelectorAll("td");
    const ruleId = t[0].querySelector("select").value.trim();
    if (!ruleId) return null;
    return {
      ItemId: itemId,
      RuleId: ruleId,
      DLLValue: t[2].querySelector("input").value
    };
  }).filter(x => x);

  const res = await fetch(`/api/DictSetupApi/OtherRule/Save?itemId=${encodeURIComponent(itemId)}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if (!res.ok || data?.success !== true) throw new Error(data?.message || "儲存失敗");
  alert(`已儲存 ${data.count} 筆設定`);
  await loadOtherRule();
}

loadAll().catch(ex => alert(ex.message || ex));
</script>

<style>
:root {
  --fs-bg: #f3f4fb;
  --fs-surface: #ffffff;
  --fs-border: #dfe5f3;
  --fs-muted: #5b6784;
  --fs-text: #222c47;
  --fs-primary: #4f46e5;
  --fs-primary-soft: #e8ebff;
  --fs-row-active: #e7f0ff;
}

.fs-page {
  background: linear-gradient(180deg, #f7f7fd 0%, #f1f3fb 100%);
  border: 1px solid var(--fs-border);
  border-radius: 14px;
  padding: 8px;
  color: var(--fs-text);
  font-size: 12px;
}

.fs-header {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 8px;
  padding: 6px 8px;
  margin-bottom: 6px;
  border: 1px solid var(--fs-border);
  border-radius: 12px;
  background: var(--fs-surface);
  box-shadow: 0 4px 12px rgba(67, 84, 138, 0.08);
}

.fs-title {
  font-size: 14px;
  color: #1f2a4d;
  font-weight: 700;
}
.fs-head-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-left: 0;
}
.fs-meta-item {
  display: flex;
  align-items: center;
  gap: 4px;
}
.fs-meta-label {
  font-size: 12px;
  color: #334265;
  white-space: nowrap;
}
.fs-meta-input {
  height: 24px;
  min-width: 110px;
  padding: 0 6px;
  border: 1px solid #cfd7eb;
  border-radius: 6px;
  background: #f7f9ff;
  color: #1f2a4d;
  font-size: 12px;
}
.fs-meta-wide {
  min-width: 190px;
}
.fs-template-lookup {
  height: 24px !important;
  min-height: 24px !important;
  padding: 0 10px !important;
  line-height: 22px;
  border-radius: 6px !important;
}

.fs-tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 6px;
  padding: 4px;
  border: 1px solid var(--fs-border);
  border-radius: 12px;
  background: var(--fs-surface);
}

.fs-tab-btn {
  border: 1px solid transparent;
  background: transparent;
  color: var(--fs-muted);
  padding: 4px 10px;
  border-radius: 9px;
  font-size: 13px;
  font-weight: 500;
  transition: all 0.15s ease;
}
.fs-tab-btn:hover {
  background: #f3f6ff;
  color: #24335f;
}
.fs-tab-btn.active {
  background: var(--fs-primary-soft);
  border-color: #ccd5ff;
  color: #2f3ea8;
  font-weight: 700;
}

.fs-pane {
  display: none;
  border: 1px solid var(--fs-border);
  border-radius: 12px;
  background: var(--fs-surface);
  padding: 6px;
  box-shadow: 0 4px 12px rgba(67, 84, 138, 0.08);
}
.fs-pane.active { display: block; }

.fs-page .btn {
  border-radius: 9px;
  font-size: 12px;
  min-height: 28px;
  padding: 3px 10px;
}

.fs-page .btn-primary {
  border-color: var(--fs-primary);
  background: var(--fs-primary);
  color: #fff;
}
.fs-page .btn-primary:hover {
  border-color: #4438d8;
  background: #4438d8;
}

.fs-page .btn-outline-secondary {
  border-color: #cfd7eb;
  background: #fff;
  color: #304064;
}
.fs-page .btn-outline-secondary:hover {
  border-color: #b9c5e3;
  background: #f7f9ff;
  color: #263656;
}

.fs-actions {
  display: flex;
  gap: 2px;
  margin-bottom: 4px;
  padding: 2px 3px;
  border: 1px solid #c7c7c7;
  border-radius: 0;
  background: #efefef;
}

.fs-toolbar-sub {
  border-left: 0;
  border-right: 0;
  border-top: 0;
  margin-bottom: 0;
}

.fs-ibtn {
  width: 24px;
  height: 22px;
  min-width: 24px;
  border: 1px solid #9fa7b3;
  background: linear-gradient(180deg, #fbfbfb 0%, #e5e8ed 100%);
  color: #111;
  font-size: 13px;
  line-height: 1;
  text-align: center;
  padding: 0;
  border-radius: 0;
}

.fs-ibtn:hover:not(:disabled) {
  background: linear-gradient(180deg, #ffffff 0%, #dbe2ec 100%);
  border-color: #7d8796;
}

.fs-ibtn:active:not(:disabled) {
  background: linear-gradient(180deg, #d9dee6 0%, #f7f9fc 100%);
}

.fs-ibtn:disabled {
  color: #9aa1ad;
  background: #f2f2f2;
  border-color: #c7ccd5;
  cursor: default;
}

.dict-wrap {
  display: flex;
  flex-direction: column;
  border: 1px solid var(--fs-border);
  border-radius: 10px;
  background: #f7f9ff;
  height: 62vh;
  overflow: hidden;
}
.dict-upper { flex: 0 0 52%; overflow: auto; background: #fff; }
.dict-split { flex: 0 0 3px; background: #e7ecfa; }
.dict-lower { flex: 1; overflow: auto; background: #fff; }

.fs-custom-top {
  max-height: 220px;
  overflow: auto;
  border: 1px solid var(--fs-border);
  border-radius: 10px;
  background: #fff;
}
.fs-custom-bottom { margin-top: 6px; }

.fs-subtabs {
  display: flex;
  gap: 4px;
  margin-bottom: 4px;
}

.fs-subtab-btn {
  border: 1px solid #c8d2ef;
  background: #f7f9ff;
  color: #324264;
  padding: 2px 10px;
  height: 24px;
  border-radius: 6px;
  font-size: 12px;
}

.fs-subtab-btn.active {
  background: #e8edff;
  border-color: #b7c5ef;
  color: #24337f;
  font-weight: 600;
}

.fs-subpane { display: none; }
.fs-subpane.active { display: block; }

.fs-page .table {
  margin-bottom: 0;
  border-color: #e7ecf8;
}
.fs-page .table th,
.fs-page .table td {
  border-color: #e7ecf8 !important;
  font-size: 12px;
  padding: 1px 3px;
  white-space: nowrap;
  vertical-align: middle;
  line-height: 1.25;
}
.fs-page .table thead th {
  background: #f3f6ff;
  color: #304064;
  font-weight: 600;
}
.fs-page .table tbody tr:hover td {
  background: #f8faff;
}

.fs-page .table .form-control,
.fs-page .table textarea.form-control,
.fs-page .table .form-select {
  border: none;
  border-radius: 0;
  background: transparent;
  box-shadow: none;
  font-size: 12px;
  min-height: 20px;
  height: 20px;
  padding: 0 2px;
  line-height: 20px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: clip;
}
.fs-page .table .form-control:focus,
.fs-page .table textarea.form-control:focus,
.fs-page .table .form-select:focus {
  background: #eef3ff;
  box-shadow: inset 0 0 0 1px #c8d3ee;
}
.fs-page .table textarea.form-control {
  min-height: 20px;
  height: 20px;
  overflow-x: auto;
  overflow-y: hidden;
  resize: none;
}
.fs-page .table .form-check-input {
  border-color: #bbc8e5;
}

#dictTable tbody tr.active td,
#sysTable tbody tr.active td,
#cbTable tbody tr.table-primary td,
#otherRuleTable tbody tr.active td {
  background: var(--fs-row-active) !important;
}

.fs-page .card {
  border: 1px solid var(--fs-border);
  border-radius: 10px;
  background: #fff;
  overflow: hidden;
}
.fs-page .card-header {
  border-bottom: 1px solid #e5ebf8;
  background: #f6f8ff;
  color: #304064;
  font-size: 12px;
  font-weight: 600;
  padding: 4px 8px !important;
}
.fs-page .card .table-responsive {
  background: #fff;
}

.fs-page .table-responsive,
.dict-upper .table-responsive,
.dict-lower .table-responsive,
.fs-custom-top {
  overflow-x: auto !important;
}

#dictTable,
#tableNameTable,
#sysTable,
#cbTable,
#spTable,
#ikTable,
#otherRuleTable {
  width: max-content;
}

@@media (max-width: 992px) {
  .fs-header { flex-direction: column; align-items: flex-start; }
  .fs-tabs { flex-wrap: wrap; }
  .dict-wrap { height: 68vh; }
  .fs-head-meta { width: 100%; }
  .fs-meta-input,
  .fs-meta-wide { min-width: 140px; }
}
</style>
