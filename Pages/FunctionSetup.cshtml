@page
@model PcbErpApi.Pages.FunctionSetupModel
@{
    ViewData["Title"] = "功能設定";
    Layout = "_Layout";
}

<div class="fs-page">
  <div class="fs-header">
    <div class="fs-head-meta">
      <div class="fs-meta-item">
        <span class="fs-meta-label">功能代碼</span>
        <input id="fsItemCode" class="fs-meta-input" readonly value="@Model.ItemId" />
      </div>
      <div class="fs-meta-item">
        <span class="fs-meta-label">功能名稱</span>
        <input id="fsItemName" class="fs-meta-input fs-meta-wide" readonly value="" />
      </div>
      <div class="fs-meta-item">
        <span class="fs-meta-label">使用模板</span>
        <select id="fsItemTemplate" class="fs-meta-input fs-meta-wide"></select>
        <button id="fsTemplateLookupBtn" type="button" class="btn btn-outline-secondary btn-sm fs-template-lookup">LOOKUP</button>
      </div>
      <div class="fs-meta-item">
        <input id="fsItemTemplateName" class="fs-meta-input fs-meta-wide" readonly value="" />
      </div>
    </div>
  </div>

  <div class="fs-tabs">
    <button class="fs-tab-btn active" data-tab="dict">辭典設定</button>
    <button class="fs-tab-btn" data-tab="sys">系統按鈕控制</button>
    <button class="fs-tab-btn" data-tab="custom">自訂按鈕</button>
    <button class="fs-tab-btn" data-tab="other">設定</button>
  </div>

  <section class="fs-pane active" data-pane="dict">
    <div class="fs-actions fs-toolbar" aria-label="辭典第一階工具列">
      <button id="dictAdd" type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列">+</button>
      <button id="dictDelete" type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列">-</button>
      <button id="dictSave" type="button" class="fs-ibtn" title="儲存更新" aria-label="儲存更新">&#10003;</button>
      <button id="dictReload" type="button" class="fs-ibtn" title="還原未儲存變更" aria-label="還原未儲存變更">&#10005;</button>
    </div>
    <div class="dict-wrap">
      <div class="dict-upper">
        <div class="table-responsive">
          <table class="table table-bordered table-sm align-middle mb-0" id="dictTable" data-dict-table="CURdOCXTableSetUp">
            <thead><tr></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="dict-split"></div>
      <div class="dict-lower">
        <div class="fs-actions fs-toolbar fs-toolbar-sub" aria-label="辭典第二階工具列">
          <button type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列" disabled>+</button>
          <button type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列" disabled>-</button>
          <button id="tableNameSave" type="button" class="fs-ibtn" title="儲存 TableName" aria-label="儲存 TableName">&#10003;</button>
          <button id="tableNameReload" type="button" class="fs-ibtn" title="還原未儲存變更" aria-label="還原未儲存變更">&#10005;</button>
          <button id="tableNameFieldSetup" type="button" class="fs-ibtn" style="width:auto;padding:0 6px;" title="開啟欄位辭典設定" aria-label="欄位設定">欄位設定</button>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-sm align-middle mb-0" id="tableNameTable" data-dict-table="CURdTableName">
            <thead><tr></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <section class="fs-pane" data-pane="sys">
    <div class="fs-actions fs-toolbar" aria-label="系統按鈕工具列">
      <button id="sysAdd" type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列">+</button>
      <button id="sysDelete" type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列">-</button>
      <button id="sysSave" type="button" class="fs-ibtn" title="儲存" aria-label="儲存">&#10003;</button>
      <button id="sysReload" type="button" class="fs-ibtn" title="還原未儲存變更" aria-label="還原未儲存變更">&#10005;</button>
      <button id="sysImport" type="button" class="fs-ibtn" style="width:auto;padding:0 6px;" title="匯入系統按鈕預設值" aria-label="匯入">匯 入</button>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle" id="sysTable" data-dict-table="CURdOCXItemSysButton">
        <thead><tr></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="fs-pane" data-pane="custom">
    <div class="fs-actions fs-toolbar" aria-label="自訂按鈕第一階工具列">
      <button id="cbAdd" type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列">+</button>
      <button id="cbDelete" type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列">-</button>
      <button id="cbSave" type="button" class="fs-ibtn" title="儲存" aria-label="儲存">&#10003;</button>
      <button id="cbReload" type="button" class="fs-ibtn" title="還原未儲存變更" aria-label="還原未儲存變更">&#10005;</button>
    </div>
    <div class="table-responsive fs-custom-top">
      <table class="table table-bordered table-sm align-middle" id="cbTable" data-dict-table="CURdOCXItemCustButton">
        <thead><tr></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="fs-custom-bottom">
      <div id="cbConfigForm" class="fs-config-form" style="display:none;">
        <div class="fs-cfg-row">
          <label class="fs-cfg-label">使用模版</label>
          <input id="cfgOCXName" class="fs-cfg-input" type="text" />
          <label class="fs-cfg-label">Dialog的Caption</label>
          <input id="cfgDialogCaption" class="fs-cfg-input" type="text" />
        </div>
      </div>
      <div class="fs-subtabs">
        <button class="fs-subtab-btn active" data-subtab="sp">設定(1)</button>
        <button class="fs-subtab-btn" data-subtab="ik">設定(2)</button>
        <button class="fs-subtab-btn" data-subtab="cs" style="display:none;">呼叫sp設定</button>
        <button class="fs-subtab-btn" data-subtab="tp" style="display:none;">傳遞資料給被呼叫的DLL之設定</button>
      </div>
      <div class="fs-subpane active" data-subpane="sp">
        <div id="spConfigForm" class="fs-config-form" style="display:none;">
          <div class="fs-cfg-row">
            <label class="fs-cfg-label">Select Sp Name</label>
            <input id="cfgSpName" class="fs-cfg-input" type="text" />
            <label class="fs-cfg-label">「取代已存在」之CheckBox</label>
            <input id="cfgReplaceExists" class="fs-cfg-input fs-cfg-narrow" type="number" min="0" value="0" />
            <select id="cfgReplaceExistsDd" class="fs-cfg-input" style="width:120px;">
              <option value="0">預設UnCheck</option>
              <option value="1">預設Check</option>
              <option value="255">隱藏</option>
            </select>
          </div>
          <div class="fs-cfg-row">
            <label class="fs-cfg-label">DD TableName</label>
            <input id="cfgMultiSelectDD" class="fs-cfg-input" type="text" />
            <button id="cfgFieldSetupBtn" type="button" class="fs-ibtn" style="width:auto;padding:0 6px;" title="開啟 DD TableName 欄位辭典">欄位設定</button>
            <label class="fs-cfg-label">輸入條件後列印</label>
            <label class="fs-cfg-label">Rpt檔名</label>
            <input id="cfgPrintRptName" class="fs-cfg-input" type="text" />
          </div>
        </div>
        <div class="fs-sp-layout">
          <div class="fs-sp-left">
            <div class="card">
              <div class="card-header py-1 d-flex align-items-center gap-1">
                <button id="spAdd" type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列">+</button>
                <button id="spDelete" type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列">-</button>
                <button id="spSave" type="button" class="fs-ibtn" title="儲存" aria-label="儲存">&#10003;</button>
                <button id="spReload" type="button" class="fs-ibtn" title="還原" aria-label="還原">&#10005;</button>
                <button id="spFetchParams" type="button" class="fs-ibtn" style="width:auto;padding:0 6px;font-size:11px;" title="抓取參數">&#8615; 抓取參數</button>
              </div>
              <div class="table-responsive">
                <table class="table table-bordered table-sm mb-0" id="spTable" data-dict-table="CURdOCXSearchParams">
                  <thead><tr></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="fs-sp-right" id="spDetailPanel" style="display:none;">
            <div class="card">
              <div class="card-header py-1">參數明細</div>
              <div class="card-body p-2">
                <div class="fs-sp-detail-field">
                  <label class="fs-sp-detail-label">下拉選單.SQL</label>
                  <textarea id="spCommandText" class="fs-sp-detail-textarea" rows="3"></textarea>
                </div>
                <div class="fs-sp-detail-field">
                  <label class="fs-sp-detail-label">預設型態</label>
                  <select id="spDefaultType" class="fs-sp-detail-select">
                    <option value="">--</option>
                    <option value="0">0 - 無</option>
                    <option value="1">1 - 固定值</option>
                    <option value="2">2 - SQL</option>
                  </select>
                </div>
                <div class="fs-sp-detail-field">
                  <label class="fs-sp-detail-label">預設值.SQL</label>
                  <textarea id="spDefaultValue" class="fs-sp-detail-textarea" rows="3"></textarea>
                </div>
                <div class="fs-sp-detail-field">
                  <label class="fs-sp-detail-label">上層參數</label>
                  <input id="spSuperIdInput" class="fs-sp-detail-input" type="text" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="fs-subpane" data-subpane="ik">
        <div id="ikConfigForm" class="fs-config-form" style="display:none;">
          <div class="fs-cfg-row">
            <label class="fs-cfg-label">Execute Sp Name</label>
            <input id="cfgIkExecSpName" class="fs-cfg-input" type="text" />
            <label class="fs-cfg-label">限制匯入筆數</label>
            <input id="cfgIkAllowSelCount" class="fs-cfg-input fs-cfg-narrow" type="number" min="0" value="0" />
            <span class="fs-cfg-hint">(0 代表不限制)</span>
          </div>
        </div>
        <div class="card">
          <div class="card-header py-1 d-flex align-items-center gap-1">
            <button id="ikAdd" type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列">+</button>
            <button id="ikDelete" type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列">-</button>
            <button id="ikSave" type="button" class="fs-ibtn" title="儲存" aria-label="儲存">&#10003;</button>
            <button id="ikReload" type="button" class="fs-ibtn" title="還原" aria-label="還原">&#10005;</button>
            <button id="ikFetchParams" type="button" class="fs-ibtn" style="width:auto;padding:0 6px;font-size:11px;" title="抓取參數">&#8615; 抓取參數</button>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered table-sm mb-0" id="ikTable" data-dict-table="CURdOCXItmCusBtnInsKey">
              <thead><tr></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="fs-subpane" data-subpane="cs">
        <div id="csConfigForm" class="fs-config-form" style="display:none;">
          <div class="fs-cfg-row">
            <label class="fs-cfg-label">Sp Name</label>
            <input id="cfgCsSpName" class="fs-cfg-input" type="text" />
            <label class="fs-cfg-label" style="margin-left:12px;">有傳回值</label>
            <input id="cfgCsSpHasResult" type="checkbox" style="width:auto;flex:none;" />
          </div>
        </div>
        <div class="card">
          <div class="card-header py-1 d-flex align-items-center gap-1">
            <button id="csAdd" type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列">+</button>
            <button id="csDelete" type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列">-</button>
            <button id="csSave" type="button" class="fs-ibtn" title="儲存" aria-label="儲存">&#10003;</button>
            <button id="csReload" type="button" class="fs-ibtn" title="還原" aria-label="還原">&#10005;</button>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered table-sm mb-0" id="csTable" data-dict-table="CURdOCXItmCusBtnParam">
              <thead><tr></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="fs-subpane" data-subpane="tp">
        <div class="card">
          <div class="card-header py-1 d-flex align-items-center gap-1">
            <button id="tpAdd" type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列">+</button>
            <button id="tpDelete" type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列">-</button>
            <button id="tpSave" type="button" class="fs-ibtn" title="儲存" aria-label="儲存">&#10003;</button>
            <button id="tpReload" type="button" class="fs-ibtn" title="還原" aria-label="還原">&#10005;</button>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered table-sm mb-0" id="tpTable" data-dict-table="CURdOCXItmCusBtnTranPm">
              <thead><tr></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="fs-pane" data-pane="other">
    <div class="fs-actions fs-toolbar" aria-label="設定工具列">
      <button id="orAdd" type="button" class="fs-ibtn" title="新增一列" aria-label="新增一列">+</button>
      <button id="orDelete" type="button" class="fs-ibtn" title="刪除選取列" aria-label="刪除選取列">-</button>
      <button id="orSave" type="button" class="fs-ibtn" title="儲存" aria-label="儲存">&#10003;</button>
      <button id="orReload" type="button" class="fs-ibtn" title="還原未儲存變更" aria-label="還原未儲存變更">&#10005;</button>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle" id="otherRuleTable" data-dict-table="CURdOCXItemOtherRule">
        <thead><tr></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<partial name="Shared/_FieldDictModal" model="@(new List<CURdTableField>())" />
<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>

<div class="modal fade" id="templateLookupModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="width: 560px; max-width: 560px;">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h5 class="modal-title">模板查詢</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-2 pb-2" style="height: 440px; display:flex; flex-direction:column;">
        <div class="d-flex gap-2 mb-2">
          <input type="text" id="templateLookupFilterCode" class="form-control form-control-sm" placeholder="模板代碼" />
          <input type="text" id="templateLookupFilterName" class="form-control form-control-sm" placeholder="模板名稱" />
        </div>
        <div style="border:1px solid #d8deed; border-radius:6px; flex:1; overflow:auto;">
          <table class="table table-sm table-hover table-bordered mb-0" id="templateLookupTable">
            <thead style="position:sticky;top:0;z-index:1;background:#f5f8ff;">
              <tr>
                <th style="width:45%;">使用模板</th>
                <th style="width:55%;">模板名稱</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer py-2">
        <button id="templateLookupConfirmBtn" type="button" class="btn btn-primary btn-sm">確定</button>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<script>
const itemId = "@Model.ItemId";
let dictCurrentRow = null;
let customRows = [];
let selectedCustomIdx = -1;
let otherRuleOptions = [];
const dictMetaCache = {};
let templateOptions = [];
let selectedTemplateLookupRow = null;
let templateLookupModalInstance = null;
let currentTemplateCode = "";
const dictFieldAliasMap = {
  CustCaptionEN: ["CustCaptionE"],
  CustHintEN: ["CustHintE"],
  CustCaptionE: ["CustCaptionEN"],
  CustHintE: ["CustHintEN"]
};
const dictGridMap = {
  dictTable: "CURdOCXTableSetUp",
  tableNameTable: "CURdTableName",
  sysTable: "CURdOCXItemSysButton",
  cbTable: "CURdOCXItemCustButton",
  spTable: "CURdOCXSearchParams",
  ikTable: "CURdOCXItmCusBtnInsKey",
  csTable: "CURdOCXItmCusBtnParam",
  tpTable: "CURdOCXItmCusBtnTranPm",
  otherRuleTable: "CURdOCXItemOtherRule"
};

const pick = (o, ...keys) => { for (const k of keys) if (o && o[k] != null) return o[k]; return ""; };
const esc = (s) => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;");
const num = (v) => { const s = String(v ?? "").trim(); if (!s) return null; const n = Number(s); return Number.isFinite(n) ? n : null; };

// Lookup 快取與載入
const lookupCache = {};
function getLookupCacheKey(table, key, result) { return `${table}|${key}|${result}`; }

async function fetchLookupOptions(lookupTable, keyField, resultField) {
  const cacheKey = getLookupCacheKey(lookupTable, keyField, resultField);
  if (lookupCache[cacheKey]) return lookupCache[cacheKey];
  try {
    const params = new URLSearchParams({ table: lookupTable, key: keyField, result: resultField });
    const res = await fetch(`/api/TableFieldLayout/LookupData?${params}`);
    if (!res.ok) return [];
    const list = await res.json();
    // list = [{ key, result0, result1, ... }]
    const opts = list.map(r => {
      const parts = [];
      for (let i = 0; ; i++) { if (r[`result${i}`] == null) break; parts.push(String(r[`result${i}`])); }
      return { value: String(r.key ?? ""), label: parts.join(" - ") || String(r.key ?? ""), parts };
    });
    lookupCache[cacheKey] = opts;
    return opts;
  } catch { return []; }
}

async function preloadLookups(dictTable) {
  const metaMap = dictMetaCache[dictTable];
  if (!metaMap) return;
  const promises = [];
  for (const meta of Object.values(metaMap)) {
    const lt = String(meta.LookupTable || "").trim();
    const lk = String(meta.LookupKeyField || "").trim();
    const lr = String(meta.LookupResultField || "").trim();
    if (lt && lk && lr) promises.push(fetchLookupOptions(lt, lk, lr));
  }
  await Promise.all(promises);
}

function getLookupMeta(dictTable, fieldName) {
  const meta = dictMetaCache[dictTable]?.[fieldName.toLowerCase()];
  if (!meta) return null;
  const lt = String(meta.LookupTable || "").trim();
  const lk = String(meta.LookupKeyField || "").trim();
  const lr = String(meta.LookupResultField || "").trim();
  if (!lt || !lk || !lr) return null;
  const opts = lookupCache[getLookupCacheKey(lt, lk, lr)];
  if (!opts) return null;
  return { opts, resultCols: lr.split(",").map(s => s.trim()) };
}

function buildSelectHtml(opts, value, disabled = false) {
  const v = String(value ?? "");
  let html = `<select class="form-select form-select-sm" ${disabled ? "disabled" : ""}>`;
  html += `<option value="">--</option>`;
  opts.forEach(o => {
    const pj = esc(JSON.stringify(o.parts || []));
    html += `<option value="${esc(o.value)}" data-parts="${pj}" ${o.value === v ? "selected" : ""}>${esc(o.label)}</option>`;
  });
  html += `</select>`;
  return html;
}

function fsCell(dictTable, fieldName, value, attrs = "") {
  const meta = dictMetaCache[dictTable]?.[fieldName.toLowerCase()];
  if (Number(meta?.ComboStyle ?? 0) === 1) {
    const checked = Number(value) === 1 || value === true || value === "1" || value === "True";
    return `<td data-field="${esc(fieldName)}" class="text-center"><input type="checkbox" class="form-check-input" ${checked ? "checked" : ""} ${attrs}></td>`;
  }
  const lk = getLookupMeta(dictTable, fieldName);
  if (lk) return `<td data-field="${esc(fieldName)}">${buildSelectHtml(lk.opts, value, false)}</td>`;
  return `<td data-field="${esc(fieldName)}"><input class="form-control form-control-sm" value="${esc(value ?? "")}" ${attrs}></td>`;
}

function fsDisplayCell(dictTable, fieldName, value) {
  const meta = dictMetaCache[dictTable]?.[fieldName.toLowerCase()];
  if (Number(meta?.ComboStyle ?? 0) === 1) {
    const checked = Number(value) === 1 || value === true || value === "1" || value === "True";
    return `<td data-field="${esc(fieldName)}" class="text-center"><input type="checkbox" class="form-check-input" ${checked ? "checked" : ""} disabled></td>`;
  }
  const lk = getLookupMeta(dictTable, fieldName);
  if (lk) return `<td data-field="${esc(fieldName)}">${buildSelectHtml(lk.opts, value, false)}</td>`;
  return `<td data-field="${esc(fieldName)}">${esc(value ?? "")}</td>`;
}

function fsReadCell(td) {
  const inp = td.querySelector("input");
  if (!inp) {
    const sel = td.querySelector("select");
    return sel ? sel.value : (td.textContent || "").trim();
  }
  return inp.type === "checkbox" ? (inp.checked ? 1 : 0) : inp.value;
}

function fsReadField(tr, fieldName) {
  const td = tr.querySelector(`td[data-field="${fieldName}"]`);
  return td ? fsReadCell(td) : "";
}

document.querySelectorAll(".fs-tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const tab = btn.dataset.tab;
    document.querySelectorAll(".fs-tab-btn").forEach(b => b.classList.toggle("active", b === btn));
    document.querySelectorAll(".fs-pane").forEach(p => p.classList.toggle("active", p.dataset.pane === tab));
  });
});

document.querySelectorAll(".fs-subtab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const tab = btn.dataset.subtab;
    document.querySelectorAll(".fs-subtab-btn").forEach(b => b.classList.toggle("active", b === btn));
    document.querySelectorAll(".fs-subpane").forEach(p => p.classList.toggle("active", p.dataset.subpane === tab));
  });
});

document.getElementById("dictAdd").addEventListener("click", addDictRow);
document.getElementById("dictDelete").addEventListener("click", deleteDictRow);
document.getElementById("dictReload").addEventListener("click", () => loadDict().catch(ex => alert(ex.message || ex)));
document.getElementById("dictSave").addEventListener("click", () => saveDict().catch(ex => alert(ex.message || ex)));
document.getElementById("tableNameReload").addEventListener("click", () => reloadTableName().catch(ex => alert(ex.message || ex)));
document.getElementById("tableNameSave").addEventListener("click", () => saveTableName().catch(ex => alert(ex.message || ex)));
document.getElementById("tableNameFieldSetup").addEventListener("click", () => {
  const tr = document.querySelector("#tableNameTable tbody tr[data-table-name]");
  const tableName = tr?.dataset?.tableName || "";
  if (!tableName) { alert("請先選取上方資料列"); return; }
  if (typeof window.showDictModal === "function") {
    window.showDictModal("fieldDictModal", tableName);
  }
});
document.getElementById("sysAdd").addEventListener("click", addSysRow);
document.getElementById("sysDelete").addEventListener("click", deleteSysRow);
document.getElementById("sysReload").addEventListener("click", () => loadSys().catch(ex => alert(ex.message || ex)));
document.getElementById("sysSave").addEventListener("click", () => saveSys().catch(ex => alert(ex.message || ex)));
document.getElementById("sysImport").addEventListener("click", async () => {
  if (!confirm("確定要匯入系統按鈕預設值？現有資料將被覆蓋。")) return;
  try {
    const res = await fetch(`/api/DictSetupApi/SysButton/Import/${encodeURIComponent(itemId)}`, { method: "POST" });
    const data = await res.json();
    if (!res.ok || data?.success !== true) throw new Error(data?.message || "匯入失敗");
    alert("匯入完成");
    await loadSys();
  } catch (ex) { alert(ex.message || ex); }
});
document.getElementById("cbReload").addEventListener("click", () => loadCustom().catch(ex => alert(ex.message || ex)));
document.getElementById("cbAdd").addEventListener("click", addCustomRow);
document.getElementById("cbDelete").addEventListener("click", deleteCustomRow);
document.getElementById("cbSave").addEventListener("click", () => saveCustom().catch(ex => alert(ex.message || ex)));
document.getElementById("orAdd").addEventListener("click", addOtherRuleRow);
document.getElementById("orDelete").addEventListener("click", deleteOtherRuleRow);
document.getElementById("orSave").addEventListener("click", () => saveOtherRule().catch(ex => alert(ex.message || ex)));
document.getElementById("orReload").addEventListener("click", () => loadOtherRule().catch(ex => alert(ex.message || ex)));
document.getElementById("fsTemplateLookupBtn").addEventListener("click", openTemplateLookup);
document.getElementById("templateLookupConfirmBtn").addEventListener("click", confirmTemplateLookup);
document.getElementById("templateLookupFilterCode").addEventListener("input", renderTemplateLookupRows);
document.getElementById("templateLookupFilterName").addEventListener("input", renderTemplateLookupRows);
document.getElementById("fsItemTemplate").addEventListener("change", async (e) => {
  try {
    await setTemplateValueAndSave(String(e.target.value || "").trim());
  } catch (ex) {
    alert(ex.message || ex);
  }
});

window.SUPPRESS_DICT_FETCH_ALERT = true;
window._dictTableName = "CURdOCXTableSetUp";

async function loadAll(){
  if (!itemId) { alert("缺少 itemId，請從功能項目維護頁進入。"); return; }
  await initGridDictionaryMeta();
  await loadHeaderMeta();
  await Promise.all([loadDict(), loadSys(), loadCustom(), loadOtherRule()]);
  bindDictContextFromFocus();
}

async function loadHeaderMeta() {
  try {
    const res = await fetch(`/api/QuickLaunch/Item/${encodeURIComponent(itemId)}`);
    if (!res.ok) return;
    const item = await res.json();
    const programName = pick(item, "programName", "ProgramName", "itemName", "ItemName");

    const nameInput = document.getElementById("fsItemName");
    const tplInput = document.getElementById("fsItemTemplate");
    const ocxTemplete = String(pick(item, "ocxTemplete", "OcxTemplete", "OCXTemplete") || "").trim();
    await ensureTemplateOptionsLoaded();
    if (nameInput) nameInput.value = programName || "";
    if (tplInput) tplInput.value = ocxTemplete || "";
    currentTemplateCode = ocxTemplete || "";
    applyTemplateNameByCode(ocxTemplete);
  } catch {}
}

async function ensureTemplateOptionsLoaded(forceReload = false) {
  if (!forceReload && templateOptions.length > 0) return;
  const select = document.getElementById("fsItemTemplate");
  if (!select) return;
  try {
    const res = await fetch("/api/EditItemApi/OcxTempleteOptions");
    if (!res.ok) return;
    const rows = await res.json();
    templateOptions = Array.isArray(rows) ? rows : [];
  } catch {
    templateOptions = [];
  }
  const optionsHtml = [`<option value=""></option>`]
    .concat((templateOptions || []).map(x => {
      const code = String(x?.OcxTemplete || "").trim();
      const name = String(x?.OcxTempleteName || "").trim();
      return `<option value="${esc(code)}">${esc(code)}${name ? ` - ${esc(name)}` : ""}</option>`;
    }))
    .join("");
  select.innerHTML = optionsHtml;
}

function applyTemplateNameByCode(code) {
  const tplNameInput = document.getElementById("fsItemTemplateName");
  if (!tplNameInput) return;
  const hit = (templateOptions || []).find(x =>
    String(x?.OcxTemplete || "").trim().toLowerCase() === String(code || "").trim().toLowerCase()
  );
  tplNameInput.value = String(hit?.OcxTempleteName || "").trim() || "單據(JS ERP)";
}

async function setTemplateValueAndSave(code) {
  const normalized = String(code || "").trim();
  const select = document.getElementById("fsItemTemplate");
  const previousCode = String(currentTemplateCode || "").trim();
  if (select) select.value = normalized;
  applyTemplateNameByCode(normalized);

  if (!itemId) {
    currentTemplateCode = normalized;
    return;
  }

  try {
    await saveHeaderTemplate(normalized);
    currentTemplateCode = normalized;
  } catch (ex) {
    if (select) select.value = previousCode;
    applyTemplateNameByCode(previousCode);
    throw ex;
  }
}

async function saveHeaderTemplate(code) {
  const res = await fetch("/api/EditItemApi/UpdateOcxTemplete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ItemId: itemId, OcxTemplete: code || "" })
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok || data?.success !== true) throw new Error(data?.message || "更新使用模板失敗");
}

function getTemplateLookupModal() {
  if (!templateLookupModalInstance) {
    const el = document.getElementById("templateLookupModal");
    templateLookupModalInstance = bootstrap.Modal.getOrCreateInstance(el);
  }
  return templateLookupModalInstance;
}

function renderTemplateLookupRows() {
  const codeFilter = String(document.getElementById("templateLookupFilterCode").value || "").trim().toUpperCase();
  const nameFilter = String(document.getElementById("templateLookupFilterName").value || "").trim().toUpperCase();
  const rows = (templateOptions || []).filter(x => {
    const code = String(x?.OcxTemplete || "").toUpperCase();
    const name = String(x?.OcxTempleteName || "").toUpperCase();
    const okCode = !codeFilter || code.includes(codeFilter);
    const okName = !nameFilter || name.includes(nameFilter);
    return okCode && okName;
  });

  const tbody = document.querySelector("#templateLookupTable tbody");
  selectedTemplateLookupRow = null;
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="2" class="text-center text-muted py-3">查無資料</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(x => {
    const code = String(x?.OcxTemplete || "").trim();
    const name = String(x?.OcxTempleteName || "").trim();
    return `<tr data-code="${esc(code)}" data-name="${esc(name)}">
      <td>${esc(code)}</td><td>${esc(name)}</td>
    </tr>`;
  }).join("");

  tbody.querySelectorAll("tr[data-code]").forEach(tr => {
    tr.addEventListener("click", () => {
      tbody.querySelectorAll("tr").forEach(x => x.classList.remove("table-primary"));
      tr.classList.add("table-primary");
      selectedTemplateLookupRow = tr;
    });
    tr.addEventListener("dblclick", async () => {
      selectedTemplateLookupRow = tr;
      await confirmTemplateLookup();
    });
  });

  const current = String(document.getElementById("fsItemTemplate")?.value || "").trim().toLowerCase();
  if (current) {
    const hit = Array.from(tbody.querySelectorAll("tr[data-code]"))
      .find(tr => String(tr.dataset.code || "").trim().toLowerCase() === current);
    if (hit) {
      hit.classList.add("table-primary");
      selectedTemplateLookupRow = hit;
    }
  }
}

async function openTemplateLookup() {
  await ensureTemplateOptionsLoaded(true);
  document.getElementById("templateLookupFilterCode").value = "";
  document.getElementById("templateLookupFilterName").value = "";
  renderTemplateLookupRows();
  getTemplateLookupModal().show();
}

async function confirmTemplateLookup() {
  if (!selectedTemplateLookupRow) {
    if (window.Swal) {
      Swal.fire({ icon: "warning", title: "請先選擇模板", timer: 1400, showConfirmButton: false });
    } else {
      alert("請先選擇模板");
    }
    return;
  }
  const code = selectedTemplateLookupRow.dataset.code || "";
  try {
    await setTemplateValueAndSave(code);
    getTemplateLookupModal().hide();
  } catch (ex) {
    alert(ex.message || ex);
  }
}

function bindDictContextFromFocus() {
  document.querySelectorAll("[data-dict-table]").forEach(el => {
    const fn = () => {
      const t = el.dataset.dictTable || "";
      if (t) window._dictTableName = t;
    };
    el.addEventListener("focusin", fn);
    el.addEventListener("pointerdown", fn);
  });
}

async function ensureDictMeta(dictTable) {
  const key = String(dictTable || "").trim();
  if (!key) return {};
  if (dictMetaCache[key]) return dictMetaCache[key];
  const res = await fetch(`/api/TableFieldLayout/GetTableFieldsFull?table=${encodeURIComponent(key)}&lang=TW`);
  if (!res.ok) { dictMetaCache[key] = {}; return dictMetaCache[key]; }
  const rows = await res.json();
  const map = {};
  (rows || []).forEach(r => {
    const name = String(r?.FieldName || "").trim();
    if (!name) return;
    map[name.toLowerCase()] = r;
  });
  dictMetaCache[key] = map;
  return map;
}

function getMetaWidthPx(meta) {
  const w1 = Number(meta?.iFieldWidth ?? 0);
  if (Number.isFinite(w1) && w1 > 0) return w1;
  const w2 = Number(meta?.DisplaySize ?? 0);
  if (Number.isFinite(w2) && w2 > 0) return Math.max(70, w2 * 10);
  return 0;
}

function getDictVisibleFields(dictTable) {
  const metaMap = dictMetaCache[dictTable];
  if (!metaMap) return [];
  return Object.values(metaMap)
    .filter(m => Number(m.Visible ?? 1) === 1)
    .sort((a, b) => {
      const sa = Number(a.SerialNum ?? 99999);
      const sb = Number(b.SerialNum ?? 99999);
      return sa - sb;
    })
    .map(m => ({
      fieldName: String(m.FieldName || "").trim(),
      label: String(m.DisplayLabel || m.FieldName || "").trim(),
      meta: m
    }));
}

function buildDynamicHeaders(tableId) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const dictTable = dictGridMap[tableId] || "";
  if (!dictTable) return;
  const fields = getDictVisibleFields(dictTable);
  if (!fields.length) return;
  let theadTr = table.querySelector("thead tr");
  if (!theadTr) {
    let thead = table.querySelector("thead");
    if (!thead) { thead = document.createElement("thead"); table.prepend(thead); }
    theadTr = document.createElement("tr");
    thead.appendChild(theadTr);
  }
  theadTr.innerHTML = "";
  fields.forEach(f => {
    const th = document.createElement("th");
    th.dataset.field = f.fieldName;
    th.textContent = f.label;
    const px = getMetaWidthPx(f.meta);
    if (px > 0) {
      th.style.minWidth = "48px";
      th.style.width = `${px}px`;
    }
    theadTr.appendChild(th);
  });
}

function pickField(obj, fieldName) {
  if (!obj) return "";
  if (obj[fieldName] != null) return obj[fieldName];
  const lower = fieldName.toLowerCase();
  for (const k of Object.keys(obj)) {
    if (k.toLowerCase() === lower) return obj[k];
  }
  const aliases = dictFieldAliasMap[fieldName] || [];
  for (const alias of aliases) {
    if (obj[alias] != null) return obj[alias];
    for (const k of Object.keys(obj)) {
      if (k.toLowerCase() === alias.toLowerCase()) return obj[k];
    }
  }
  return "";
}

function buildDynamicRow(tableId, data, editable = true) {
  const table = document.getElementById(tableId);
  if (!table) return document.createElement("tr");
  const dictTable = dictGridMap[tableId] || "";
  const ths = Array.from(table.querySelectorAll("thead th[data-field]"));
  const tr = document.createElement("tr");
  ths.forEach(th => {
    const fieldName = th.dataset.field;
    const value = pickField(data, fieldName);
    tr.insertAdjacentHTML("beforeend",
      editable ? fsCell(dictTable, fieldName, value) : fsDisplayCell(dictTable, fieldName, value));
  });
  return tr;
}

async function applyGridDictionaryMeta(tableId) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const dictTable = table.dataset.dictTable || dictGridMap[tableId] || "";
  if (!dictTable) return;
  const metaMap = await ensureDictMeta(dictTable);

  table.querySelectorAll("thead th[data-field]").forEach(th => {
    const field = String(th.dataset.field || "").trim();
    if (!field) return;
    const candidates = [field, ...(dictFieldAliasMap[field] || [])];
    let meta = null;
    for (const name of candidates) {
      meta = metaMap[String(name).toLowerCase()];
      if (meta) break;
    }
    if (!meta) return;
    const visible = Number(meta.Visible ?? 1) === 1;
    th.style.display = visible ? "" : "none";
    const label = String(meta.DisplayLabel || "").trim();
    if (label) {
      Array.from(th.childNodes).forEach(n => { if (n.nodeType === Node.TEXT_NODE) n.remove(); });
      th.insertBefore(document.createTextNode(label), th.firstChild);
    }
    const px = getMetaWidthPx(meta);
    if (px > 0) {
      th.style.minWidth = `48px`;
      th.style.width = `${px}px`;
      th.style.maxWidth = "";
    }
  });

  // 依辭典 SerialNum 排序欄位
  const theadTr = table.querySelector("thead tr");
  if (!theadTr) return;
  const ths = Array.from(theadTr.querySelectorAll("th[data-field]"));
  const getOrder = (th) => {
    const field = th.dataset.field || "";
    const candidates = [field, ...(dictFieldAliasMap[field] || [])];
    for (const name of candidates) {
      const m = metaMap[String(name).toLowerCase()];
      if (m) return Number(m.SerialNum ?? 99999);
    }
    return 99999;
  };
  const sorted = [...ths].sort((a, b) => getOrder(a) - getOrder(b));
  const orderChanged = sorted.some((th, i) => th !== ths[i]);
  if (orderChanged) {
    sorted.forEach(th => theadTr.appendChild(th));
    table.querySelectorAll("tbody tr").forEach(tr => {
      sorted.forEach(th => {
        const field = th.dataset.field;
        const td = tr.querySelector(`td[data-field="${field}"]`);
        if (td) tr.appendChild(td);
      });
    });
  }
}

function applyGridColumnWidths(tableId) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const headers = Array.from(table.querySelectorAll("thead th[data-field]"));
  const rows = Array.from(table.querySelectorAll("tbody tr"));
  if (!headers.length || !rows.length) return;

  headers.forEach(th => {
    const field = th.dataset.field;
    const hidden = th.style.display === "none";
    const width = String(th.style.width || th.style.minWidth || "").trim();
    rows.forEach(tr => {
      const td = tr.querySelector(`td[data-field="${field}"]`);
      if (!td) return;
      td.style.display = hidden ? "none" : "";
      if (!hidden && width) {
        td.style.width = width;
        td.style.minWidth = width;
        td.style.maxWidth = width;
      }
    });
  });
}

function ensureFsResizeHandles(tableId) {
  const table = document.getElementById(tableId);
  if (!table) return;
  table.querySelectorAll("thead th").forEach(th => {
    if (!th.querySelector(".fs-col-resizer")) {
      const handle = document.createElement("span");
      handle.className = "fs-col-resizer";
      th.appendChild(handle);
    }
  });
}

async function refreshGridLayout(tableId) {
  await applyGridDictionaryMeta(tableId);
  ensureFsResizeHandles(tableId);
  applyGridColumnWidths(tableId);
}

async function initGridDictionaryMeta() {
  for (const tableId of Object.keys(dictGridMap)) {
    try {
      await ensureDictMeta(dictGridMap[tableId]);
      buildDynamicHeaders(tableId);
      await preloadLookups(dictGridMap[tableId]);
      await refreshGridLayout(tableId);
    } catch {}
  }
  for (const tableId of Object.keys(dictGridMap)) {
    enableFsColumnResize(tableId);
  }
}

function enableFsColumnResize(tableId) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const dictTable = dictGridMap[tableId] || "";
  if (!dictTable) return;
  if (table.dataset.fsResizeInit) return;
  table.dataset.fsResizeInit = "1";

  let isDown = false, startX = 0, startW = 0, activeTh = null;
  let saveTimer = null;

  const persistWidths = () => {
    const currentThs = Array.from(table.querySelectorAll("thead th[data-field]"));
    const cols = currentThs.map(th => ({
      fieldName: th.dataset.field,
      width: Math.round(th.getBoundingClientRect().width)
    }));
    if (!cols.length) return;
    fetch("/api/TableFieldLayout/SaveDetailLayout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tableName: dictTable, cols })
    }).catch(() => {});
    delete dictMetaCache[dictTable];
  };

  const debounceSave = () => {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(persistWidths, 400);
  };

  table.querySelector("thead").addEventListener("mousedown", (e) => {
    const handle = e.target.closest(".fs-col-resizer");
    if (!handle) return;
    const th = handle.closest("th");
    if (!th) return;
    e.preventDefault();
    e.stopPropagation();
    isDown = true;
    activeTh = th;
    startX = e.pageX;
    startW = th.getBoundingClientRect().width;
    document.body.classList.add("fs-resizing");
  });

  document.addEventListener("mousemove", (e) => {
    if (!isDown || !activeTh) return;
    const newW = Math.max(48, startW + (e.pageX - startX));
    activeTh.style.width = `${newW}px`;
    activeTh.style.minWidth = `48px`;
    activeTh.style.maxWidth = "";
  });

  document.addEventListener("mouseup", () => {
    if (!isDown) return;
    isDown = false;
    document.body.classList.remove("fs-resizing");
    if (activeTh) {
      applyGridColumnWidths(tableId);
      debounceSave();
    }
    activeTh = null;
  });
}

function createDictRow(r = {}){
  const tr = buildDynamicRow("dictTable", r, true);
  attachLookupChangeHandlers(tr, "dictTable");
  tr.dataset.tableName = r.TableName || "";
  tr.addEventListener("click", async () => {
    document.querySelectorAll("#dictTable tbody tr").forEach(x => x.classList.remove("active"));
    tr.classList.add("active");
    tr.dataset.tableName = String(fsReadField(tr, "TableName")).trim();
    dictCurrentRow = tr;
    await loadTableName(tr.dataset.tableName);
  });
  return tr;
}

function addDictRow(){
  const tbody = document.querySelector("#dictTable tbody");
  const tr = createDictRow({});
  tbody.appendChild(tr);
  applyGridColumnWidths("dictTable");
  tr.click();
}

function deleteDictRow(){
  const tr = document.querySelector("#dictTable tbody tr.active");
  if (!tr) return;
  tr.remove();
  dictCurrentRow = null;
  document.querySelector("#tableNameTable tbody").innerHTML = '<tr><td colspan="99" class="text-center text-muted">請先選上方資料列</td></tr>';
}

async function loadDict(){
  await ensureDictMeta(dictGridMap.dictTable);
  buildDynamicHeaders("dictTable");
  await preloadLookups(dictGridMap.dictTable);
  const res = await fetch(`/api/DictSetupApi/Table/ByItem/${encodeURIComponent(itemId)}`);
  if (!res.ok) throw new Error("載入辭典設定失敗");
  const rows = await res.json();
  const tbody = document.querySelector("#dictTable tbody");
  tbody.innerHTML = "";
  dictCurrentRow = null;
  document.querySelector("#tableNameTable tbody").innerHTML = "";
  rows.forEach(r => {
    tbody.appendChild(createDictRow(r));
  });
  await refreshGridLayout("dictTable");
}

async function loadTableName(tableName){
  await ensureDictMeta(dictGridMap.tableNameTable);
  buildDynamicHeaders("tableNameTable");
  await preloadLookups(dictGridMap.tableNameTable);
  const res = await fetch(`/api/DictSetupApi/TableName/${encodeURIComponent(tableName)}`);
  const tbody = document.querySelector("#tableNameTable tbody");
  if (!res.ok) { tbody.innerHTML = '<tr><td class="text-center text-warning">查無資料</td></tr>'; return; }
  const d = await res.json();
  const tr = buildDynamicRow("tableNameTable", d, true);
  tr.dataset.tableName = d.TableName || "";
  tbody.innerHTML = "";
  tbody.appendChild(tr);
  await refreshGridLayout("tableNameTable");
}

async function reloadTableName(){
  if (dictCurrentRow?.dataset?.tableName) {
    await loadTableName(dictCurrentRow.dataset.tableName);
    return;
  }
  const first = document.querySelector("#dictTable tbody tr");
  if (!first) return;
  first.classList.add("active");
  dictCurrentRow = first;
  await loadTableName(first.dataset.tableName || "");
}

async function saveDict(){
  const payload = Array.from(document.querySelectorAll("#dictTable tbody tr")).map(tr => {
    const row = { ItemId: itemId };
    tr.querySelectorAll("td[data-field]").forEach(td => {
      row[td.dataset.field] = fsReadCell(td);
    });
    return row;
  });
  const res = await fetch("/api/DictSetupApi/Table/UpdateByItem", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  const data = await res.json();
  if (!res.ok || data?.success !== true) throw new Error(data?.message || "儲存失敗");
  alert(`更新成功（${data.count} 筆）`);
}

async function saveTableName(){
  const tr = document.querySelector("#tableNameTable tbody tr[data-table-name]");
  if (!tr) return;
  const payload = { TableName: tr.dataset.tableName };
  tr.querySelectorAll("td[data-field]").forEach(td => {
    const f = td.dataset.field;
    const v = fsReadCell(td);
    payload[f] = (["SerialNum","TableType","LevelNo"].includes(f)) ? num(v) : v;
  });
  const res = await fetch("/api/DictSetupApi/TableName/Update", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  const data = await res.json();
  if (!res.ok || data?.success !== true) throw new Error(data?.message || "儲存失敗");
  alert("TableName 更新成功");
}

function createSysRow(r = {}, isNew = false){
  const tr = buildDynamicRow("sysTable", r, true);
  attachLookupChangeHandlers(tr, "sysTable");
  tr.dataset.buttonName = r.ButtonName || "";
  if (!isNew) {
    const btnTd = tr.querySelector('td[data-field="ButtonName"]');
    const inp = btnTd?.querySelector("input");
    if (inp) inp.readOnly = true;
  }
  tr.addEventListener("click", () => {
    document.querySelectorAll("#sysTable tbody tr").forEach(x => x.classList.remove("active"));
    tr.classList.add("active");
  });
  return tr;
}

function addSysRow(){
  const tbody = document.querySelector("#sysTable tbody");
  const nextSerial = (tbody.querySelectorAll("tr").length + 1) * 10;
  const tr = createSysRow({ SerialNum: nextSerial, bVisiable: 1 }, true);
  tbody.appendChild(tr);
  applyGridColumnWidths("sysTable");
  tr.click();
}

function deleteSysRow(){
  const tr = document.querySelector("#sysTable tbody tr.active");
  if (!tr) return;
  tr.remove();
}

async function loadSys(){
  await ensureDictMeta(dictGridMap.sysTable);
  buildDynamicHeaders("sysTable");
  await preloadLookups(dictGridMap.sysTable);
  const res = await fetch(`/api/DictSetupApi/SysButton/ByItem/${encodeURIComponent(itemId)}`);
  if (!res.ok) throw new Error("載入系統按鈕失敗");
  const rows = await res.json();
  const tbody = document.querySelector("#sysTable tbody");
  tbody.innerHTML = "";
  rows.forEach(r => {
    tbody.appendChild(createSysRow(r, false));
  });
  await refreshGridLayout("sysTable");
}

const sysIntFields = new Set(["SerialNum","bVisiable","bShowMsg","bShowMsgAft"]);

async function saveSys(){
  const payload = Array.from(document.querySelectorAll("#sysTable tbody tr")).map(tr => {
    const buttonName = tr.dataset.buttonName || String(fsReadField(tr, "ButtonName")).trim();
    if (!buttonName) return null;
    const row = { ItemId: itemId, ButtonName: buttonName };
    tr.querySelectorAll("td[data-field]").forEach(td => {
      const f = td.dataset.field;
      const v = fsReadCell(td);
      row[f] = sysIntFields.has(f) ? num(v) : v;
      const aliases = dictFieldAliasMap[f] || [];
      aliases.forEach(a => { row[a] = row[f]; });
    });
    return row;
  }).filter(x => x);
  const res = await fetch("/api/DictSetupApi/SysButton/Save", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  const data = await res.json();
  if (!res.ok || data?.success !== true) throw new Error(data?.message || "儲存失敗");
  alert(`已儲存 ${data.count} 筆系統按鈕設定`);
}

const cbConfigFields = ["SearchTemplate","DialogCaption","SpName","ExecSpName","MultiSelectDD","PrintRptName","ReplaceExists","AllowSelCount","bSpHasResult"];

function appendCustomRow(r){
  const tr = buildDynamicRow("cbTable", r, true);
  cbConfigFields.forEach(f => {
    if (!tr.querySelector(`td[data-field="${f}"]`)) {
      const dt = dictGridMap.cbTable;
      const td = document.createElement("td");
      td.dataset.field = f;
      td.style.display = "none";
      const meta = dictMetaCache[dt]?.[f.toLowerCase()];
      if (Number(meta?.ComboStyle ?? 0) === 1) {
        const val = pickField(r, f);
        const checked = Number(val) === 1 || val === true || val === "1" || val === "True";
        td.className = "text-center";
        td.innerHTML = `<input type="checkbox" class="form-check-input" ${checked ? "checked" : ""}>`;
      } else {
        td.innerHTML = `<input class="form-control form-control-sm" value="${esc(pickField(r, f) ?? "")}">`;
      }
      tr.appendChild(td);
    }
  });
  attachLookupChangeHandlers(tr, "cbTable");
  tr.addEventListener("click", () => selectCustomRow(tr));
  document.querySelector("#cbTable tbody").appendChild(tr);
}

async function loadCustom(){
  const dictTable = dictGridMap.cbTable;
  await ensureDictMeta(dictTable);
  buildDynamicHeaders("cbTable");
  await preloadLookups(dictTable);
  const res = await fetch(`/api/CustomButtonApi/ByItem/${encodeURIComponent(itemId)}`);
  if (!res.ok) throw new Error("載入自訂按鈕失敗");
  customRows = await res.json();
  const tbody = document.querySelector("#cbTable tbody");
  tbody.innerHTML = "";
  selectedCustomIdx = -1;
  customRows.forEach(appendCustomRow);
  await refreshGridLayout("cbTable");
  document.querySelector("#spTable tbody").innerHTML = "";
  document.querySelector("#ikTable tbody").innerHTML = "";
  document.querySelector("#csTable tbody").innerHTML = "";
  document.querySelector("#tpTable tbody").innerHTML = "";
}

function addCustomRow(){
  appendCustomRow({ SerialNum: (document.querySelectorAll("#cbTable tbody tr").length + 1) * 10 });
  applyGridColumnWidths("cbTable");
}

function deleteCustomRow(){
  const tr = document.querySelector("#cbTable tbody tr.table-primary");
  if (!tr) return;
  tr.remove();
  selectedCustomIdx = -1;
  document.querySelector("#spTable tbody").innerHTML = "";
  document.querySelector("#ikTable tbody").innerHTML = "";
  document.querySelector("#csTable tbody").innerHTML = "";
  document.querySelector("#tpTable tbody").innerHTML = "";
}

let selectedSpRow = null;
let selectedIkRow = null;
let selectedCsRow = null;
let selectedTpRow = null;

function selectIkRow(row) {
  document.querySelectorAll("#ikTable tbody tr").forEach(x => x.classList.remove("ik-selected"));
  row.classList.add("ik-selected");
  selectedIkRow = row;
}

function selectCsRow(row) {
  document.querySelectorAll("#csTable tbody tr").forEach(x => x.classList.remove("cs-selected"));
  row.classList.add("cs-selected");
  selectedCsRow = row;
}

function selectTpRow(row) {
  document.querySelectorAll("#tpTable tbody tr").forEach(x => x.classList.remove("tp-selected"));
  row.classList.add("tp-selected");
  selectedTpRow = row;
}

async function selectCustomRow(tr){
  document.querySelectorAll("#cbTable tbody tr").forEach(x => x.classList.remove("table-primary"));
  tr.classList.add("table-primary");
  selectedCustomIdx = Array.from(tr.parentElement.children).indexOf(tr);
  const btnName = String(fsReadField(tr, "ButtonName")).trim();

  const designType = num(fsReadField(tr, "DesignType"));
  const searchTpl = String(fsReadField(tr, "SearchTemplate")).trim();
  const configForm = document.getElementById("cbConfigForm");
  const spConfigForm = document.getElementById("spConfigForm");
  const spPanel = document.getElementById("spDetailPanel");
  const subtabSp = document.querySelector('.fs-subtab-btn[data-subtab="sp"]');
  const subtabIk = document.querySelector('.fs-subtab-btn[data-subtab="ik"]');
  const subtabCs = document.querySelector('.fs-subtab-btn[data-subtab="cs"]');
  const subtabTp = document.querySelector('.fs-subtab-btn[data-subtab="tp"]');
  const ikConfigForm = document.getElementById("ikConfigForm");
  const csConfigForm = document.getElementById("csConfigForm");

  // 先全部隱藏
  configForm.style.display = "none";
  spConfigForm.style.display = "none";
  spPanel.style.display = "none";
  subtabSp.style.display = "none";
  subtabIk.style.display = "none";
  subtabCs.style.display = "none";
  subtabTp.style.display = "none";
  ikConfigForm.style.display = "none";
  csConfigForm.style.display = "none";

  if (designType === 1) {
    configForm.style.display = "";
    spConfigForm.style.display = "";
    subtabSp.style.display = "";
    populateConfigForm(tr);
    spPanel.style.display = "";
    const showTab2 = searchTpl.toLowerCase() === "jsdpapersearchdll.dll";
    subtabIk.style.display = showTab2 ? "" : "none";
    ikConfigForm.style.display = showTab2 ? "" : "none";
    if (!subtabSp.classList.contains("active")) subtabSp.click();
  } else if (designType === 3) {
    subtabCs.style.display = "";
    csConfigForm.style.display = "";
    populateCsConfigForm(tr);
    if (!subtabCs.classList.contains("active")) subtabCs.click();
  } else if (designType === 0) {
    subtabTp.style.display = "";
    if (!subtabTp.classList.contains("active")) subtabTp.click();
  }

  clearSpDetailPanel();
  selectedSpRow = null;
  selectedIkRow = null;
  selectedCsRow = null;
  selectedTpRow = null;

  if (!btnName) return;

  // 根據 DesignType 載入對應的 dict 和資料
  const res = await fetch(`/api/CustomButtonApi/Detail/${encodeURIComponent(itemId)}/${encodeURIComponent(btnName)}`);
  if (!res.ok) return;
  const d = await res.json();

  if (designType === 1) {
    await ensureDictMeta(dictGridMap.spTable);
    await ensureDictMeta(dictGridMap.ikTable);
    buildDynamicHeaders("spTable");
    buildDynamicHeaders("ikTable");
    await preloadLookups(dictGridMap.spTable);
    await preloadLookups(dictGridMap.ikTable);
    const sp = pick(d, "SearchParams", "searchParams") || [];
    const ik = pick(d, "InsertKeys", "insertKeys") || [];
    const spTbody = document.querySelector("#spTable tbody");
    spTbody.innerHTML = "";
    sp.forEach(x => {
      const row = buildDynamicRow("spTable", x, false);
      row._spData = x;
      row.addEventListener("click", () => selectSpRow(row));
      attachLookupChangeHandlers(row, "spTable");
      spTbody.appendChild(row);
    });
    const ikTbody = document.querySelector("#ikTable tbody");
    ikTbody.innerHTML = "";
    ik.forEach(x => {
      const ikRow = buildDynamicRow("ikTable", x, false);
      ikRow._ikData = x;
      ikRow.addEventListener("click", () => selectIkRow(ikRow));
      attachLookupChangeHandlers(ikRow, "ikTable");
      ikTbody.appendChild(ikRow);
    });
    await refreshGridLayout("spTable");
    await refreshGridLayout("ikTable");
  } else if (designType === 3) {
    await ensureDictMeta(dictGridMap.csTable);
    buildDynamicHeaders("csTable");
    await preloadLookups(dictGridMap.csTable);
    const cs = pick(d, "CallSpParams", "callSpParams") || [];
    const csTbody = document.querySelector("#csTable tbody");
    csTbody.innerHTML = "";
    cs.forEach(x => {
      const csRow = buildDynamicRow("csTable", x, false);
      csRow._csData = x;
      csRow.addEventListener("click", () => selectCsRow(csRow));
      attachLookupChangeHandlers(csRow, "csTable");
      csTbody.appendChild(csRow);
    });
    await refreshGridLayout("csTable");
  } else if (designType === 0) {
    await ensureDictMeta(dictGridMap.tpTable);
    buildDynamicHeaders("tpTable");
    await preloadLookups(dictGridMap.tpTable);
    const tp = pick(d, "TranParams", "tranParams") || [];
    const tpTbody = document.querySelector("#tpTable tbody");
    tpTbody.innerHTML = "";
    tp.forEach(x => {
      const tpRow = buildDynamicRow("tpTable", x, false);
      tpRow._tpData = x;
      tpRow.addEventListener("click", () => selectTpRow(tpRow));
      attachLookupChangeHandlers(tpRow, "tpTable");
      tpTbody.appendChild(tpRow);
    });
    await refreshGridLayout("tpTable");
  }
}

function populateConfigForm(tr) {
  // 設定(1) 欄位
  document.getElementById("cfgOCXName").value = String(fsReadField(tr, "SearchTemplate")).trim();
  document.getElementById("cfgDialogCaption").value = String(fsReadField(tr, "DialogCaption")).trim();
  document.getElementById("cfgSpName").value = String(fsReadField(tr, "SpName")).trim();
  document.getElementById("cfgMultiSelectDD").value = String(fsReadField(tr, "MultiSelectDD")).trim();
  document.getElementById("cfgPrintRptName").value = String(fsReadField(tr, "PrintRptName")).trim();
  const reVal = String(fsReadField(tr, "ReplaceExists") || "0").trim();
  document.getElementById("cfgReplaceExists").value = reVal;
  document.getElementById("cfgReplaceExistsDd").value = reVal;
  // 設定(2) 欄位
  document.getElementById("cfgIkExecSpName").value = String(fsReadField(tr, "ExecSpName")).trim();
  document.getElementById("cfgIkAllowSelCount").value = String(fsReadField(tr, "AllowSelCount") || "0").trim();
}

function populateCsConfigForm(tr) {
  document.getElementById("cfgCsSpName").value = String(fsReadField(tr, "SpName")).trim();
  document.getElementById("cfgCsSpHasResult").checked = Number(fsReadField(tr, "bSpHasResult") || 0) === 1;
}

function writeToCbTableCell(tr, fieldName, value) {
  const td = tr.querySelector(`td[data-field="${fieldName}"]`);
  if (!td) return;
  const inp = td.querySelector("input");
  if (inp) {
    if (inp.type === "checkbox") inp.checked = Number(value) === 1;
    else inp.value = value;
  }
}

function initConfigFormSync() {
  const fieldMap = {
    cfgOCXName: "SearchTemplate",
    cfgDialogCaption: "DialogCaption",
    cfgSpName: "SpName",
    cfgMultiSelectDD: "MultiSelectDD",
    cfgPrintRptName: "PrintRptName",
    cfgReplaceExists: "ReplaceExists",
    cfgIkExecSpName: "ExecSpName",
    cfgIkAllowSelCount: "AllowSelCount",
    cfgCsSpName: "SpName"
  };
  Object.entries(fieldMap).forEach(([inputId, fieldName]) => {
    const el = document.getElementById(inputId);
    if (!el) return;
    el.addEventListener("input", () => {
      const tr = document.querySelector("#cbTable tbody tr.table-primary");
      if (tr) writeToCbTableCell(tr, fieldName, el.value);
    });
  });
  // bSpHasResult checkbox 同步
  document.getElementById("cfgCsSpHasResult").addEventListener("change", function() {
    const tr = document.querySelector("#cbTable tbody tr.table-primary");
    if (tr) writeToCbTableCell(tr, "bSpHasResult", this.checked ? 1 : 0);
  });
  // ReplaceExists: number ↔ dropdown 雙向同步
  const reNum = document.getElementById("cfgReplaceExists");
  const reDd = document.getElementById("cfgReplaceExistsDd");
  reNum.addEventListener("input", () => { reDd.value = reNum.value; });
  reDd.addEventListener("change", () => {
    reNum.value = reDd.value;
    const tr = document.querySelector("#cbTable tbody tr.table-primary");
    if (tr) writeToCbTableCell(tr, "ReplaceExists", reDd.value);
  });
  document.getElementById("cfgFieldSetupBtn").addEventListener("click", () => {
    const ddName = String(document.getElementById("cfgMultiSelectDD").value).trim();
    if (!ddName) { alert("請先填入 DD TableName"); return; }
    if (typeof window.showDictModal === "function") {
      window.showDictModal("fieldDictModal", ddName);
    }
  });
}

function selectSpRow(tr) {
  document.querySelectorAll("#spTable tbody tr").forEach(x => x.classList.remove("sp-selected"));
  tr.classList.add("sp-selected");
  selectedSpRow = tr;
  const data = tr._spData || {};
  document.getElementById("spCommandText").value = pick(data, "CommandText", "commandText") || "";
  document.getElementById("spDefaultType").value = String(pick(data, "DefaultType", "defaultType") ?? "");
  document.getElementById("spDefaultValue").value = pick(data, "DefaultValue", "defaultValue") || "";
  document.getElementById("spSuperIdInput").value = pick(data, "SuperId", "superId") || "";
}

function clearSpDetailPanel() {
  document.getElementById("spCommandText").value = "";
  document.getElementById("spDefaultType").value = "";
  document.getElementById("spDefaultValue").value = "";
  document.getElementById("spSuperIdInput").value = "";
}

function attachLookupChangeHandlers(tr, tableId) {
  const dictTable = dictGridMap[tableId] || "";
  if (!dictTable) return;
  tr.querySelectorAll("td[data-field]").forEach(td => {
    const fieldName = td.dataset.field;
    const lk = getLookupMeta(dictTable, fieldName);
    if (!lk) return;
    const sel = td.querySelector("select");
    if (!sel) return;
    // 初始填入名稱欄
    updateLookupNameCols(tr, sel, lk.resultCols);
    sel.addEventListener("change", () => {
      updateLookupNameCols(tr, sel, lk.resultCols);
      if (tr._spData) tr._spData[fieldName] = isNaN(Number(sel.value)) ? sel.value : Number(sel.value);
    });
  });
}

function updateLookupNameCols(tr, sel, resultCols) {
  const opt = sel.options[sel.selectedIndex];
  if (!opt) return;
  let parts;
  try { parts = JSON.parse(opt.dataset.parts || "[]"); } catch { parts = []; }
  resultCols.forEach((col, idx) => {
    const nameTd = tr.querySelector(`td[data-field="${col}"]`);
    if (!nameTd) return;
    const nameInp = nameTd.querySelector("input");
    const nameSel = nameTd.querySelector("select");
    if (nameSel) return; // 本身也是 select，不覆寫
    if (nameInp) nameInp.value = parts[idx] ?? "";
    else nameTd.textContent = parts[idx] ?? "";
  });
}

const spIntFields = new Set(["ControlType","DefaultType","ParamSN","ParamType",
  "iReadOnly","iVisible","iForInput","iDateTime"]);

document.getElementById("spSave").addEventListener("click", async () => {
  const cbTr = document.querySelector("#cbTable tbody tr.table-primary");
  if (!cbTr) { alert("請先選擇一筆自訂按鈕"); return; }
  const btnName = String(fsReadField(cbTr, "ButtonName")).trim();
  if (!btnName) { alert("ButtonName 為空"); return; }

  // 先把右側明細面板的值寫回 selectedSpRow._spData
  if (selectedSpRow && selectedSpRow._spData) {
    selectedSpRow._spData.CommandText = document.getElementById("spCommandText").value;
    selectedSpRow._spData.DefaultType = num(document.getElementById("spDefaultType").value);
    selectedSpRow._spData.DefaultValue = document.getElementById("spDefaultValue").value;
    selectedSpRow._spData.SuperId = document.getElementById("spSuperIdInput").value;
  }

  // 收集 spTable 所有列
  const rows = Array.from(document.querySelectorAll("#spTable tbody tr")).map(tr => {
    const base = tr._spData ? { ...tr._spData } : {};
    // 用 grid cell 的值覆蓋（含 lookup select 的修改）
    tr.querySelectorAll("td[data-field]").forEach(td => {
      const f = td.dataset.field;
      const val = fsReadCell(td);
      base[f] = spIntFields.has(f) ? num(val) : val;
    });
    base.ItemId = itemId;
    base.ButtonName = btnName;
    return base;
  });

  try {
    const res = await fetch("/api/CustomButtonApi/SaveSearchParams", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ItemId: itemId, ButtonName: btnName, Rows: rows })
    });
    const result = await res.json();
    if (!res.ok || result?.success !== true) throw new Error(result?.message || "儲存失敗");
    alert(`已儲存 ${result.count} 筆參數`);
    await selectCustomRow(cbTr);
  } catch (ex) { alert(ex.message || ex); }
});

// 設定(1) 抓取參數 — 使用 SpName
document.getElementById("spFetchParams").addEventListener("click", async () => {
  const tr = document.querySelector("#cbTable tbody tr.table-primary");
  if (!tr) { alert("請先選擇一筆自訂按鈕"); return; }
  const btnName = String(fsReadField(tr, "ButtonName")).trim();
  const spName = String(fsReadField(tr, "SpName")).trim();
  if (!btnName) { alert("ButtonName 為空"); return; }
  if (!spName) { alert("SpName 為空"); return; }
  if (!confirm(`確定要抓取參數？\nButtonName: ${btnName}\nSpName: ${spName}`)) return;
  try {
    const res = await fetch("/api/CustomButtonApi/FetchParams", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ItemId: itemId, ButtonName: btnName, ObjectName: spName })
    });
    const result = await res.json();
    if (!res.ok || result?.success !== true) throw new Error(result?.message || "抓取失敗");
    await selectCustomRow(tr);
  } catch (ex) { alert(ex.message || ex); }
});

// 設定(2) 抓取參數 — 使用 ExecSpName
document.getElementById("ikFetchParams").addEventListener("click", async () => {
  const tr = document.querySelector("#cbTable tbody tr.table-primary");
  if (!tr) { alert("請先選擇一筆自訂按鈕"); return; }
  const btnName = String(fsReadField(tr, "ButtonName")).trim();
  const spName = String(fsReadField(tr, "ExecSpName")).trim();
  if (!btnName) { alert("ButtonName 為空"); return; }
  if (!spName) { alert("ExecSpName 為空"); return; }
  if (!confirm(`確定要抓取參數？\nButtonName: ${btnName}\nExecSpName: ${spName}`)) return;
  try {
    const res = await fetch("/api/CustomButtonApi/FetchParams", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ItemId: itemId, ButtonName: btnName, ObjectName: spName })
    });
    const result = await res.json();
    if (!res.ok || result?.success !== true) throw new Error(result?.message || "抓取失敗");
    await selectCustomRow(tr);
  } catch (ex) { alert(ex.message || ex); }
});

async function reloadCustomDetail(){
  const tr = document.querySelector("#cbTable tbody tr.table-primary");
  if (tr) {
    await selectCustomRow(tr);
    return;
  }
  const first = document.querySelector("#cbTable tbody tr");
  if (!first) return;
  await selectCustomRow(first);
}

const cbIntFields = new Set(["SerialNum","bVisible","ChkCanUpdate","bNeedNum","DesignType",
  "bSpHasResult","AllowSelCount","ReplaceExists","bTranByGlobalId",
  "iMultiSelUseDtl","iEditGridType","NeediFlag","NeediSeqNum"]);

async function saveCustom(){
  const payload = Array.from(document.querySelectorAll("#cbTable tbody tr")).map(tr => {
    const row = { ItemId: itemId };
    tr.querySelectorAll("td[data-field]").forEach(td => {
      let fieldName = td.dataset.field;
      const aliases = dictFieldAliasMap[fieldName] || [];
      const val = fsReadCell(td);
      row[fieldName] = cbIntFields.has(fieldName) ? num(val) : val;
      aliases.forEach(a => { row[a] = row[fieldName]; });
    });
    if (!row.ButtonName) row.ButtonName = "";
    if (row.CustCaptionEN != null && row.CustCaptionE == null) row.CustCaptionE = row.CustCaptionEN;
    if (row.CustHintEN != null && row.CustHintE == null) row.CustHintE = row.CustHintEN;
    return row;
  });
  const res = await fetch("/api/CustomButtonApi/Save", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  const data = await res.json();
  if (!res.ok || data?.success !== true) throw new Error(data?.message || "儲存失敗");
  alert(`已儲存 ${data.count} 筆自訂按鈕`);
  await loadCustom();
}

function createOtherRuleRow(r = {}) {
  const currentRuleId = pick(r, "RuleId", "ruleId");
  const currentRuleName = pick(r, "Lk_RuleName", "RuleName", "ruleName");
  const hasCurrent = (otherRuleOptions || []).some(x => String(pick(x, "RuleId", "ruleId")) === String(currentRuleId || ""));
  const normalizedOptions = [...(otherRuleOptions || [])];
  if (currentRuleId && !hasCurrent) {
    normalizedOptions.unshift({ RuleId: currentRuleId, RuleName: currentRuleName || currentRuleId });
  }
  const opts = normalizedOptions.map(x => {
    const rid = String(pick(x, "RuleId", "ruleId"));
    const rnm = String(pick(x, "RuleName", "ruleName"));
    const selected = rid === String(currentRuleId || "") ? "selected" : "";
    return `<option value="${esc(rid)}" data-name="${esc(rnm)}" ${selected}>${esc(rid)} - ${esc(rnm)}</option>`;
  }).join("");

  const ths = Array.from(document.querySelectorAll("#otherRuleTable thead th[data-field]"));
  const tr = document.createElement("tr");
  ths.forEach(th => {
    const f = th.dataset.field;
    if (f === "RuleId") {
      tr.insertAdjacentHTML("beforeend", `<td data-field="RuleId"><input class="form-control form-control-sm" value="${esc(currentRuleId ?? "")}" readonly></td>`);
    } else if (f === "Lk_RuleName") {
      tr.insertAdjacentHTML("beforeend", `<td data-field="Lk_RuleName"><input class="form-control form-control-sm" value="${esc(currentRuleName)}" readonly></td>`);
    } else {
      tr.insertAdjacentHTML("beforeend", fsCell("CURdOCXItemOtherRule", f, pickField(r, f)));
    }
  });

  const ruleIdTd = tr.querySelector('td[data-field="RuleId"]');
  const ruleIdInput = tr.querySelector('td[data-field="RuleId"] input');
  const ruleNameInput = tr.querySelector('td[data-field="Lk_RuleName"] input');
  if (ruleIdTd && ruleIdInput && ruleNameInput) {
    const syncRuleName = () => {
      const selectedRuleId = String(ruleIdInput.value || "");
      const hit = normalizedOptions.find(x => String(pick(x, "RuleId", "ruleId")) === selectedRuleId);
      ruleNameInput.value = String(pick(hit, "RuleName", "ruleName") || "");
    };

    if (!ruleNameInput.value) syncRuleName();

    const closeEditor = (sel) => {
      if (!sel) return;
      ruleIdInput.value = sel.value || "";
      syncRuleName();
      sel.remove();
      ruleIdInput.style.display = "";
    };

    const openEditor = () => {
      if (ruleIdTd.querySelector("select")) return;
      const sel = document.createElement("select");
      sel.className = "form-select form-select-sm";
      sel.innerHTML = opts;
      if (Array.from(sel.options).some(o => o.value === String(ruleIdInput.value || ""))) {
        sel.value = String(ruleIdInput.value || "");
      }
      ruleIdInput.style.display = "none";
      ruleIdTd.appendChild(sel);
      sel.focus();
      if (typeof sel.showPicker === "function") {
        try { sel.showPicker(); } catch {}
      }
      sel.addEventListener("change", () => closeEditor(sel));
      sel.addEventListener("blur", () => closeEditor(sel));
      sel.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          e.preventDefault();
          sel.value = String(ruleIdInput.value || "");
          closeEditor(sel);
        }
      });
    };

    ruleIdTd.addEventListener("dblclick", () => openEditor());
  }

  tr.addEventListener("click", () => {
    document.querySelectorAll("#otherRuleTable tbody tr").forEach(x => x.classList.remove("active"));
    tr.classList.add("active");
  });
  return tr;
}

async function loadOtherRuleOptions() {
  const res = await fetch("/api/DictSetupApi/OtherRule/Options");
  if (!res.ok) { otherRuleOptions = []; return; }
  otherRuleOptions = await res.json();
}

async function loadOtherRule() {
  await loadOtherRuleOptions();
  await ensureDictMeta(dictGridMap.otherRuleTable);
  buildDynamicHeaders("otherRuleTable");
  await preloadLookups(dictGridMap.otherRuleTable);
  const res = await fetch(`/api/DictSetupApi/OtherRule/ByItem/${encodeURIComponent(itemId)}`);
  if (!res.ok) throw new Error("載入設定失敗");
  const rows = await res.json();
  const tbody = document.querySelector("#otherRuleTable tbody");
  tbody.innerHTML = "";
  (rows || []).forEach(r => tbody.appendChild(createOtherRuleRow(r)));
  await refreshGridLayout("otherRuleTable");
}

function addOtherRuleRow() {
  const tbody = document.querySelector("#otherRuleTable tbody");
  const tr = createOtherRuleRow({});
  tbody.appendChild(tr);
  applyGridColumnWidths("otherRuleTable");
  tr.click();
}

function deleteOtherRuleRow() {
  const tr = document.querySelector("#otherRuleTable tbody tr.active");
  if (!tr) return;
  tr.remove();
}

async function saveOtherRule() {
  const payload = Array.from(document.querySelectorAll("#otherRuleTable tbody tr")).map(tr => {
    const row = { ItemId: itemId };
    tr.querySelectorAll("td[data-field]").forEach(td => {
      row[td.dataset.field] = fsReadCell(td);
    });
    if (!String(row.RuleId || "").trim()) return null;
    return row;
  }).filter(x => x);

  const res = await fetch(`/api/DictSetupApi/OtherRule/Save?itemId=${encodeURIComponent(itemId)}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if (!res.ok || data?.success !== true) throw new Error(data?.message || "儲存失敗");
  alert(`已儲存 ${data.count} 筆設定`);
  await loadOtherRule();
}

// F3 開啟當前 grid 的辭典設定
document.addEventListener("keydown", (e) => {
  if (e.key !== "F3") return;
  e.preventDefault();
  // 找出目前可見的 grid 的 dict table
  const activePane = document.querySelector(".fs-pane.active");
  if (!activePane) return;
  const pane = activePane.dataset.pane;
  let dictTable = "";
  if (pane === "custom") {
    // 判斷目前的 subtab
    const activeSubtab = document.querySelector(".fs-subtab-btn.active");
    const sub = activeSubtab?.dataset?.subtab;
    if (sub === "sp") dictTable = dictGridMap.spTable;
    else if (sub === "ik") dictTable = dictGridMap.ikTable;
    else if (sub === "cs") dictTable = dictGridMap.csTable;
    else if (sub === "tp") dictTable = dictGridMap.tpTable;
    else dictTable = dictGridMap.cbTable;
  } else if (pane === "dict") dictTable = dictGridMap.dictTable;
  else if (pane === "sys") dictTable = dictGridMap.sysTable;
  else if (pane === "other") dictTable = dictGridMap.otherRuleTable;
  if (dictTable && typeof window.showDictModal === "function") {
    window.showDictModal("fieldDictModal", dictTable);
  }
});

initConfigFormSync();
loadAll().catch(ex => alert(ex.message || ex));
</script>

<style>
:root {
  --fs-bg: #f3f4fb;
  --fs-surface: #ffffff;
  --fs-border: #dfe5f3;
  --fs-muted: #5b6784;
  --fs-text: #222c47;
  --fs-primary: #4f46e5;
  --fs-primary-soft: #e8ebff;
  --fs-row-active: #e7f0ff;
}

.fs-page {
  background: linear-gradient(180deg, #f7f7fd 0%, #f1f3fb 100%);
  border: 1px solid var(--fs-border);
  border-radius: 14px;
  padding: 8px;
  color: var(--fs-text);
  font-size: 12px;
}

.fs-header {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 8px;
  padding: 3px 8px;
  margin-bottom: 3px;
  border: 1px solid var(--fs-border);
  border-radius: 12px;
  background: var(--fs-surface);
  box-shadow: 0 4px 12px rgba(67, 84, 138, 0.08);
}

.fs-title {
  font-size: 14px;
  color: #1f2a4d;
  font-weight: 700;
}
.fs-head-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-left: 0;
}
.fs-meta-item {
  display: flex;
  align-items: center;
  gap: 4px;
}
.fs-meta-label {
  font-size: 12px;
  color: #334265;
  white-space: nowrap;
}
.fs-meta-input {
  height: 24px;
  min-width: 110px;
  padding: 0 6px;
  border: 1px solid #cfd7eb;
  border-radius: 6px;
  background: #f7f9ff;
  color: #1f2a4d;
  font-size: 12px;
}
.fs-meta-wide {
  min-width: 190px;
}
.fs-template-lookup {
  height: 24px !important;
  min-height: 24px !important;
  padding: 0 10px !important;
  line-height: 22px;
  border-radius: 6px !important;
}

.fs-tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 3px;
  padding: 2px 4px;
  border: 1px solid var(--fs-border);
  border-radius: 12px;
  background: var(--fs-surface);
}

.fs-tab-btn {
  border: 1px solid transparent;
  background: transparent;
  color: var(--fs-muted);
  padding: 4px 10px;
  border-radius: 9px;
  font-size: 12px;
  font-weight: 500;
  transition: all 0.15s ease;
}
.fs-tab-btn:hover {
  background: #f3f6ff;
  color: #24335f;
}
.fs-tab-btn.active {
  background: var(--fs-primary-soft);
  border-color: #ccd5ff;
  color: #2f3ea8;
  font-weight: 600;
}

.fs-pane {
  display: none;
  border: 1px solid var(--fs-border);
  border-radius: 12px;
  background: var(--fs-surface);
  padding: 6px;
  box-shadow: 0 4px 12px rgba(67, 84, 138, 0.08);
}
.fs-pane.active { display: block; }

.fs-page .btn {
  border-radius: 9px;
  font-size: 12px;
  min-height: 28px;
  padding: 3px 10px;
}

.fs-page .btn-primary {
  border-color: var(--fs-primary);
  background: var(--fs-primary);
  color: #fff;
}
.fs-page .btn-primary:hover {
  border-color: #4438d8;
  background: #4438d8;
}

.fs-page .btn-outline-secondary {
  border-color: #cfd7eb;
  background: #fff;
  color: #304064;
}
.fs-page .btn-outline-secondary:hover {
  border-color: #b9c5e3;
  background: #f7f9ff;
  color: #263656;
}

.fs-actions {
  display: flex;
  gap: 2px;
  margin-bottom: 4px;
  padding: 2px 3px;
  border: 1px solid #c7c7c7;
  border-radius: 0;
  background: #efefef;
}

.fs-toolbar-sub {
  border-left: 0;
  border-right: 0;
  border-top: 0;
  margin-bottom: 0;
}

.fs-ibtn {
  width: 24px;
  height: 22px;
  min-width: 24px;
  border: 1px solid #9fa7b3;
  background: linear-gradient(180deg, #fbfbfb 0%, #e5e8ed 100%);
  color: #111;
  font-size: 13px;
  line-height: 1;
  text-align: center;
  padding: 0;
  border-radius: 0;
}

.fs-ibtn:hover:not(:disabled) {
  background: linear-gradient(180deg, #ffffff 0%, #dbe2ec 100%);
  border-color: #7d8796;
}

.fs-ibtn:active:not(:disabled) {
  background: linear-gradient(180deg, #d9dee6 0%, #f7f9fc 100%);
}

.fs-ibtn:disabled {
  color: #9aa1ad;
  background: #f2f2f2;
  border-color: #c7ccd5;
  cursor: default;
}

.dict-wrap {
  display: flex;
  flex-direction: column;
  border: 1px solid var(--fs-border);
  border-radius: 10px;
  background: #f7f9ff;
  height: 62vh;
  overflow: hidden;
}
.dict-upper { flex: 0 0 52%; overflow: auto; background: #fff; }
.dict-split { flex: 0 0 3px; background: #e7ecfa; }
.dict-lower { flex: 1; overflow: auto; background: #fff; }

.fs-custom-top {
  max-height: 220px;
  overflow: auto;
  border: 1px solid var(--fs-border);
  border-radius: 10px;
  background: #fff;
}
.fs-custom-bottom { margin-top: 6px; }

.fs-subtabs {
  display: flex;
  gap: 4px;
  margin-bottom: 4px;
}

.fs-subtab-btn {
  border: 1px solid #c8d2ef;
  background: #f7f9ff;
  color: #324264;
  padding: 2px 10px;
  height: 24px;
  border-radius: 6px;
  font-size: 12px;
}

.fs-subtab-btn.active {
  background: #e8edff;
  border-color: #b7c5ef;
  color: #24337f;
  font-weight: 600;
}

.fs-subpane { display: none; }
.fs-subpane.active { display: block; }

.fs-page .table {
  margin-bottom: 0;
  border-color: #e7ecf8;
}
.fs-page .table th,
.fs-page .table td {
  border-color: #e7ecf8 !important;
  font-size: 12px;
  padding: 1px 3px;
  white-space: nowrap;
  vertical-align: middle;
  line-height: 1.25;
}
.fs-page .table thead th {
  background: #f3f6ff;
  color: #304064;
  font-weight: 600;
}
.fs-page .table tbody tr:hover td {
  background: #f8faff;
}

.fs-page .table .form-control,
.fs-page .table textarea.form-control,
.fs-page .table .form-select {
  border: none;
  border-radius: 0;
  background: transparent;
  box-shadow: none;
  font-size: 12px;
  min-height: 18px;
  height: 18px;
  padding: 0 2px;
  line-height: 18px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: clip;
}
.fs-page .table .form-control:focus,
.fs-page .table textarea.form-control:focus,
.fs-page .table .form-select:focus {
  background: #eef3ff;
  box-shadow: inset 0 0 0 1px #c8d3ee;
}
.fs-page .table textarea.form-control {
  min-height: 18px;
  height: 18px;
  overflow-x: auto;
  overflow-y: hidden;
  resize: none;
}
.fs-page .table .form-check-input {
  border-color: #bbc8e5;
}

#dictTable tbody tr.active td,
#sysTable tbody tr.active td,
#cbTable tbody tr.table-primary td,
#otherRuleTable tbody tr.active td {
  background: var(--fs-row-active) !important;
}

.fs-page .card {
  border: 1px solid var(--fs-border);
  border-radius: 10px;
  background: #fff;
  overflow: hidden;
}
.fs-page .card-header {
  border-bottom: 1px solid #e5ebf8;
  background: #f6f8ff;
  color: #304064;
  font-size: 12px;
  font-weight: 600;
  padding: 4px 8px !important;
}
.fs-page .card .table-responsive {
  background: #fff;
}

.fs-page .table-responsive,
.dict-upper .table-responsive,
.dict-lower .table-responsive,
.fs-custom-top {
  overflow-x: auto !important;
}

#dictTable,
#tableNameTable,
#sysTable,
#cbTable,
#spTable,
#ikTable,
#csTable,
#tpTable,
#otherRuleTable {
  width: max-content;
}

/* 欄寬拖曳把手 */
.fs-page .table thead th {
  position: relative;
}
.fs-col-resizer {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  width: 8px;
  cursor: col-resize;
  user-select: none;
  z-index: 2;
}
.fs-col-resizer:hover {
  background: rgba(79, 70, 229, 0.18);
}
body.fs-resizing {
  cursor: col-resize !important;
  user-select: none !important;
}

/* DesignType=1 配置表單 */
.fs-config-form {
  border: 1px solid var(--fs-border);
  border-radius: 8px;
  background: #f9faff;
  padding: 3px 8px;
  margin-bottom: 4px;
}
.fs-cfg-row {
  display: flex;
  align-items: center;
  gap: 4px;
  flex-wrap: wrap;
  margin-bottom: 1px;
}
.fs-cfg-row:last-child { margin-bottom: 0; }
.fs-cfg-label {
  font-size: 11px;
  color: #334265;
  white-space: nowrap;
}
.fs-cfg-input {
  height: 20px;
  min-width: 120px;
  max-width: 220px;
  padding: 0 6px;
  border: 1px solid #cfd7eb;
  border-radius: 4px;
  background: #fff;
  color: #1f2a4d;
  font-size: 12px;
  flex: 1;
}
.fs-cfg-input:focus {
  border-color: var(--fs-primary);
  outline: none;
  box-shadow: 0 0 0 2px rgba(79,70,229,0.12);
}
.fs-cfg-narrow {
  max-width: 80px;
  min-width: 60px;
}
.fs-cfg-hint {
  font-size: 11px;
  color: #888;
  white-space: nowrap;
}

/* SearchParam 左右分欄 */
.fs-sp-layout {
  display: flex;
  gap: 6px;
}
.fs-sp-left {
  flex: 1;
  min-width: 0;
  overflow: auto;
}
.fs-sp-right {
  flex: 0 0 280px;
  min-width: 240px;
  max-width: 320px;
}
.fs-sp-detail-field { margin-bottom: 6px; }
.fs-sp-detail-label {
  display: block;
  font-size: 11px;
  color: #334265;
  font-weight: 600;
  margin-bottom: 2px;
}
.fs-sp-detail-textarea {
  width: 100%;
  font-size: 11px;
  font-family: 'Consolas','Courier New',monospace;
  border: 1px solid #cfd7eb;
  border-radius: 4px;
  padding: 4px;
  resize: vertical;
  min-height: 50px;
}
.fs-sp-detail-textarea:focus,
.fs-sp-detail-input:focus,
.fs-sp-detail-select:focus {
  border-color: var(--fs-primary);
  outline: none;
  box-shadow: 0 0 0 2px rgba(79,70,229,0.12);
}
.fs-sp-detail-input,
.fs-sp-detail-select {
  width: 100%;
  height: 24px;
  font-size: 12px;
  border: 1px solid #cfd7eb;
  border-radius: 4px;
  padding: 0 6px;
  background: #fff;
}
#spTable tbody tr.sp-selected td,
#ikTable tbody tr.ik-selected td,
#csTable tbody tr.cs-selected td,
#tpTable tbody tr.tp-selected td {
  background: var(--fs-row-active) !important;
}

@@media (max-width: 992px) {
  .fs-header { flex-direction: column; align-items: flex-start; }
  .fs-tabs { flex-wrap: wrap; }
  .dict-wrap { height: 68vh; }
  .fs-head-meta { width: 100%; }
  .fs-meta-input,
  .fs-meta-wide { min-width: 140px; }
  .fs-sp-layout { flex-direction: column; }
  .fs-sp-right { flex: none; max-width: 100%; min-width: 0; }
  .fs-cfg-input { min-width: 100px; }
}
</style>
