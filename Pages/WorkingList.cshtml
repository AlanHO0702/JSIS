@page
@using System.Reflection
@using PcbErpApi.Helpers
@using PcbErpApi.Models
@model PcbErpApi.Pages.WorkingListModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "工作清單";

    var visibleFields = Model.TableFields
        .Where(f => ToBool(f.Visible, defaultValue: true))
        .Where(f => Model.Rows.Columns.Contains(f.FieldName))
        .ToList();
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="~/js/fieldDictModal.js"></script>

@functions{
    private static bool ToBool(object? raw, bool defaultValue)
    {
        if (raw == null) return defaultValue;

        return raw switch
        {
            bool b => b,
            byte b => b != 0,
            sbyte b => b != 0,
            short n => n != 0,
            ushort n => n != 0,
            int n => n != 0,
            uint n => n != 0,
            long n => n != 0,
            ulong n => n != 0,
            decimal n => n != 0m,
            double n => Math.Abs(n) > double.Epsilon,
            float n => Math.Abs(n) > float.Epsilon,
            _ => ParseBool(raw.ToString(), defaultValue)
        };

        static bool ParseBool(string? text, bool fallback)
        {
            var s = text?.Trim();
            if (string.IsNullOrWhiteSpace(s)) return fallback;

            if (bool.TryParse(s, out var b)) return b;
            if (int.TryParse(s, out var n)) return n != 0;
            if (string.Equals(s, "Y", StringComparison.OrdinalIgnoreCase)) return true;
            if (string.Equals(s, "N", StringComparison.OrdinalIgnoreCase)) return false;

            return fallback;
        }
    }

    private static int ToColWidthPx(CURdTableField? f, int pxPerChar = 10)
    {
        try
        {
            var raw = f?.DisplaySize;
            if (raw == null) return 0;

            if (raw is int i && i > 0) return i * pxPerChar;

            int n;
            var s = raw.ToString();
            if (int.TryParse(s, out n) && n > 0) return n * pxPerChar;

            return 0;
        }
        catch { return 0; }
    }

    private static string GetFieldProp(CURdTableField? field, string propName)
    {
        if (field == null || string.IsNullOrWhiteSpace(propName)) return "";

        var prop = field.GetType().GetProperty(propName, BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase);
        return prop?.GetValue(field)?.ToString() ?? "";
    }

    private static string FormatCell(object? value, CURdTableField? field)
    {
        var dataType = GetFieldProp(field, "DataType");
        var formatStr = GetFieldProp(field, "FormatStr");

        var formatted = FormatHelper.FormatValue(value, dataType, formatStr);
        return formatted;
    }

    private static string GetRowValue(System.Data.DataRow row, string fieldName)
    {
        if (row.Table.Columns.Contains(fieldName))
        {
            return row[fieldName]?.ToString() ?? "";
        }
        return "";
    }
}

<style>
body {
    background: #f4f6fb;
    font-family: "Noto Sans TC", "Microsoft JhengHei", Arial, sans-serif;
}
.worklist-container {
    padding: 8px 12px;
    max-width: 100%;
    margin: 0;
}
.worklist-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #f6f7f9;
    border: 1px solid #d8dee8;
    border-radius: 10px;
    padding: 6px 8px;
    margin-bottom: 8px;
    box-shadow: 0 1px 2px rgba(20,40,80,0.06);
}
.worklist-toolbar .btn {
    height: 32px;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    padding-top: 0;
    padding-bottom: 0;
}
.worklist-table-container {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    overflow: auto;
    max-width: 100%;
    height: calc(100vh - 200px);
    max-height: calc(100vh - 200px);
    min-height: 320px;
}
.worklist-table {
    width: 100%;
    margin: 0;
    border-collapse: collapse;
    table-layout: fixed;
    font-size: .85rem;
}
.worklist-table thead {
    background: #f8f9fa;
}
.worklist-table thead th {
    padding: 4px 6px;
    font-weight: 600;
    color: #555;
    border: 1px solid #dee2e6;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 2;
    background: #f8f9fa;
    overflow: hidden;
    text-overflow: ellipsis;
    position: sticky;
}
.col-resizer {
    position: absolute;
    top: 0;
    right: 0;
    width: 5px;
    height: 100%;
    cursor: col-resize;
    user-select: none;
    z-index: 10;
}
.col-resizer:hover {
    background: rgba(0, 123, 255, 0.3);
}
.worklist-table tbody td {
    padding: 4px 6px;
    border: 1px solid #dee2e6;
    vertical-align: middle;
    background: #f3f3f3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.worklist-table tbody tr:hover td {
    background: #f1f5ff;
}
.worklist-table tbody tr.selected td {
    background: #e3f2fd !important;
    border-color: #90caf9;
}
</style>

<div class="worklist-container" data-current-userid="@Model.CurrentUserId" data-current-useid="@Model.CurrentUseId" data-dict-table="CURdOCXWorkingList">
    <div class="worklist-toolbar">
        <button type="button" class="btn btn-secondary" id="btnExit">關閉</button>
        <button type="button" class="btn btn-outline-primary" id="btnReGet">重取</button>
        <button type="button" class="btn btn-primary" id="btnOpenPaper">開啟</button>
        <div class="ms-auto text-secondary small">使用者：@Model.CurrentUserId</div>
    </div>

    <div class="worklist-table-container">
        @if (Model.Rows.Rows.Count > 0)
        {
            <table class="worklist-table" id="worklistTable">
                <colgroup>
                    @foreach (var f in visibleFields)
                    {
                        var w = ToColWidthPx(f, 10);
                        if (w > 0)
                        {
                            <col data-field="@f.FieldName" style="width:@($"{w}px");min-width:@($"{w}px")" />
                        }
                        else
                        {
                            <col data-field="@f.FieldName" />
                        }
                    }
                </colgroup>
                <thead>
                    <tr>
                        @foreach (var f in visibleFields)
                        {
                            <th data-field="@f.FieldName">
                                @(string.IsNullOrWhiteSpace(f.DisplayLabel) ? f.FieldName : f.DisplayLabel)
                                <div class="col-resizer"></div>
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                @foreach (System.Data.DataRow row in Model.Rows.Rows)
                {
                    var paperId = GetRowValue(row, "PaperId");
                    var paperNum = GetRowValue(row, "PaperNum");
                    <tr data-paperid="@paperId" data-papernum="@paperNum">
                        @foreach (var f in visibleFields)
                        {
                            var value = row[f.FieldName];
                            <td title="@FormatCell(value, f)">@FormatCell(value, f)</td>
                        }
                    </tr>
                }
                </tbody>
            </table>
        }
        else
        {
            <div class="text-center text-muted p-5">目前沒有未完成單據</div>
        }
    </div>
</div>

@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", new List<PcbErpApi.Models.CURdTableField>())

<script>
(() => {
    const table = document.getElementById('worklistTable');
    const btnOpen = document.getElementById('btnOpenPaper');
    const btnReget = document.getElementById('btnReGet');
    const btnExit = document.getElementById('btnExit');

    const selectRow = (row) => {
        table.querySelectorAll('tbody tr').forEach(r => r.classList.remove('selected'));
        row.classList.add('selected');
    };

    if (table) {
        table.querySelectorAll('tbody tr').forEach(row => {
            row.addEventListener('click', () => selectRow(row));
            row.addEventListener('dblclick', () => openSelected());
        });
    }

    const openSelected = async () => {
        const row = table?.querySelector('tbody tr.selected');
        if (!row) {
            Swal.fire('提示', '請先選擇一筆資料', 'info');
            return;
        }
        const paperId = (row.getAttribute('data-paperid') || '').trim();
        const paperNum = (row.getAttribute('data-papernum') || '').trim();
        const userId = (document.querySelector('.worklist-container')?.dataset?.currentUserid
            || localStorage.getItem('erpLoginUserId') || '').toString().trim();
        const useId = (document.querySelector('.worklist-container')?.dataset?.currentUseid
            || localStorage.getItem('erpLoginBUId') || '').toString().trim();
        if (!paperId || !paperNum) {
            Swal.fire('錯誤', '沒有單據種類或單據號碼', 'error');
            return;
        }
        try {
            if (!userId || !useId) throw new Error('缺少使用者/公司別');
            const response = await fetch('/api/Flow/ResolveItemIdByFromType', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paperId, paperNum, userId, useId })
            });
            if (!response.ok) throw new Error('查詢 ItemId 失敗');
            const data = await response.json();
            const itemId = data.itemId || paperId;
            const url = `/DynamicTemplate/Paper/${itemId}/${paperNum}`;
            window.open(url, '_blank');
        } catch (error) {
            const url = `/DynamicTemplate/Paper/${paperId}/${paperNum}`;
            window.open(url, '_blank');
        }
    };

    btnOpen?.addEventListener('click', openSelected);
    btnReget?.addEventListener('click', () => window.location.reload());
    btnExit?.addEventListener('click', () => window.location.href = '/FontIndex');
})();

// 欄位寬度拖曳調整與儲存
(function() {
    const table = document.getElementById('worklistTable');
    if (!table) return;

    const colGroupCols = Array.from(table.querySelectorAll('colgroup col'));
    const ths = Array.from(table.querySelectorAll('thead th'));
    const tableName = 'CURdOCXWorkingList';

    const colMap = {};
    colGroupCols.forEach(col => {
        const field = col.getAttribute('data-field');
        if (field) colMap[field.toLowerCase()] = col;
    });

    let dragState = null;

    ths.forEach(th => {
        const field = th.getAttribute('data-field');
        const resizer = th.querySelector('.col-resizer');
        if (!field || !resizer) return;

        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const col = colMap[field.toLowerCase()];
            const startX = e.clientX;
            const startWidth = (col?.getBoundingClientRect().width) || th.getBoundingClientRect().width;
            dragState = { field, startX, startWidth };
            document.body.style.cursor = 'col-resize';
        });
    });

    document.addEventListener('mousemove', (e) => {
        if (!dragState) return;
        const delta = e.clientX - dragState.startX;
        const newW = Math.max(40, dragState.startWidth + delta);
        const col = colMap[dragState.field.toLowerCase()];
        if (col) {
            col.style.width = `${newW}px`;
            col.style.minWidth = `${newW}px`;
        }
        const th = ths.find(t => (t.getAttribute('data-field') || '').toLowerCase() === dragState.field.toLowerCase());
        if (th) th.style.width = `${newW}px`;
    });

    document.addEventListener('mouseup', async () => {
        if (!dragState) return;

        const col = colMap[dragState.field.toLowerCase()];
        const th = ths.find(t => (t.getAttribute('data-field') || '').toLowerCase() === dragState.field.toLowerCase());
        const width = col?.getBoundingClientRect().width || th?.getBoundingClientRect().width || dragState.startWidth;
        const fieldName = dragState.field;

        dragState = null;
        document.body.style.cursor = '';

        try {
            await fetch('/api/DictSetupApi/FieldWidth/Save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tableName: tableName,
                    fieldName: fieldName,
                    widthPx: Math.round(width)
                })
            });
        } catch (err) {
            console.warn('儲存欄位寬度失敗', err);
        }
    });
})();

</script>
