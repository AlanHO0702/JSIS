@page "/CCS/{itemId}/{systemId:int?}"
@model PcbErpApi.Pages.CCS.CC000054Model
@using System.Text.Json
@{
    Layout = "_Layout";
    ViewData["Title"] = Model.PageTitle;
}

<partial name="~/Pages/Shared/_TableSingleGrid.cshtml" model="Model" />

@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", ViewData["FieldDictList"], ViewData)
<!-- 單檔專用：新增客戶/廠商彈窗 -->
<div class="modal fade" id="cc000054AddModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">新增</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body ccs-add-modal-body">
        <div class="ccs-add-row">
          <label class="ccs-add-label" id="addCodeLabel">客戶編號</label>
          <div class="ccs-add-inline">
            <input type="text" class="form-control form-control-sm ccs-add-code-select" id="addCompanyId" autocomplete="off">
            <input type="text" class="form-control form-control-sm ccs-add-short" id="addShortName" readonly>
          </div>
        </div>
        <div class="ccs-add-row">
          <label class="ccs-add-label" id="addNameLabel">簡稱</label>
          <input type="text" class="form-control form-control-sm" id="addCompanyName" placeholder="">
        </div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-light btn-sm border" id="btnAddConfirm">確定</button>
        <button type="button" class="btn btn-light btn-sm border" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="cc000054QueryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">客戶廠商資料查詢</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body ccs-query-modal-body">
        <div class="ccs-query-grid">
          <label class="ccs-query-label" id="qLblSubClass">客戶分類</label>
          <select class="form-select form-select-sm" id="qSubClass"></select>

          <label class="ccs-query-label" id="qLblCompanyLike">客戶編號(模糊查詢)</label>
          <input type="text" class="form-control form-control-sm" id="qCompanyLike">

          <label class="ccs-query-label" id="qLblCompanyStart">客戶編號起</label>
          <input type="text" class="form-control form-control-sm" id="qCompanyStart" list="qCompanyList">

          <label class="ccs-query-label" id="qLblCompanyEnd">客戶編號迄</label>
          <input type="text" class="form-control form-control-sm" id="qCompanyEnd" list="qCompanyList">

          <label class="ccs-query-label" id="qLblShortName">客戶簡稱</label>
          <input type="text" class="form-control form-control-sm" id="qShortName">

          <label class="ccs-query-label">電話</label>
          <div class="ccs-query-inline3">
            <select class="form-select form-select-sm" id="qPhoneCond">
              <option value="0">開頭以</option>
              <option value="1">包含</option>
            </select>
            <input type="text" class="form-control form-control-sm" id="qPhone">
          </div>

          <label class="ccs-query-label">傳真</label>
          <div class="ccs-query-inline3">
            <select class="form-select form-select-sm" id="qFaxCond">
              <option value="0">開頭以</option>
              <option value="1">包含</option>
            </select>
            <input type="text" class="form-control form-control-sm" id="qFax">
          </div>

          <label class="ccs-query-label" id="qLblUniFormId">統一編號(模糊查詢)</label>
          <input type="text" class="form-control form-control-sm" id="qUniFormId">

          <label class="ccs-query-label" id="qLblName">客戶名稱(模糊查詢)</label>
          <input type="text" class="form-control form-control-sm" id="qCompanyName">

          <label class="ccs-query-label" id="qLblAddr">客戶地址(模糊查詢)</label>
          <input type="text" class="form-control form-control-sm" id="qCompanyAddr">

          <label class="ccs-query-label">營業項目(模糊查詢)</label>
          <input type="text" class="form-control form-control-sm" id="qBnsItem">

          <label class="ccs-query-label" id="qLblSales">業務員</label>
          <select class="form-select form-select-sm" id="qSalesId"></select>
        </div>
        <datalist id="qCompanyList"></datalist>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-light btn-sm border" id="btnCompanySelectSearch">查詢</button>
        <button type="button" class="btn btn-light btn-sm border" id="btnCompanySelectClear">清除</button>
        <button type="button" class="btn btn-light btn-sm border" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="showSystemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">檢視身分</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2 mb-2">
          <div class="col-12">
            <label class="form-label mb-1">公司代碼</label>
            <input id="ssCompanyId" class="form-control form-control-sm" readonly />
          </div>
          <div class="col-12">
            <label class="form-label mb-1">簡稱</label>
            <input id="ssShortName" class="form-control form-control-sm" readonly />
          </div>
          <div class="col-12">
            <label class="form-label mb-1">公司名稱</label>
            <input id="ssCompanyName" class="form-control form-control-sm" readonly />
          </div>
        </div>
        <div class="ss-check-grid">
          <label><input type="checkbox" id="ssSys1" disabled /> 銷售客戶</label>
          <label><input type="checkbox" id="ssSys2" disabled /> 供應商</label>
          <label><input type="checkbox" id="ssSys3" disabled /> 製程委外廠商</label>
          <label><input type="checkbox" id="ssSys4" disabled /> 製令委外廠商</label>
          <label><input type="checkbox" id="ssSys5" disabled /> 進出口廠商</label>
          <label><input type="checkbox" id="ssSys6" disabled /> 其他廠商</label>
          <label><input type="checkbox" id="ssSys7" disabled /> 經銷商</label>
          <label id="ssSys8Row" class="d-none"><input type="checkbox" id="ssSys8" disabled /> 廢棄物廠商</label>
          <label id="ssSys9Row"><input type="checkbox" id="ssSys9" disabled /> 未成交客戶</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">確定</button>
      </div>
    </div>
  </div>
</div>
@if (!string.IsNullOrWhiteSpace(Model.DictTableName))
{
    <script>window._dictTableName = '@Model.DictTableName';</script>
}
@if (ViewData["LoadError"] is string loadErr && !string.IsNullOrWhiteSpace(loadErr))
{
    <div class="alert alert-danger mt-2">資料載入錯誤：@loadErr</div>
}
<script>
  window._singleItemId = '@Model.ItemId';
  window._singleRealTable = '@Model.TableName';
  window._cc000054DetailUrl = '@Url.Page("CC000054Detail", new { itemId = Model.ItemId })';
  window._cc000054KeyFields = @Html.Raw(JsonSerializer.Serialize((Model.KeyFields != null && Model.KeyFields.Count > 0) ? Model.KeyFields : new List<string> { "CompanyId" }));
  window._cc000054SystemId = @Model.SystemId;
  window._cc000054CanAdd = @((ViewData["CCSCanAdd"] as bool? ?? false).ToString().ToLowerInvariant());
</script>
<script>
// 單檔專用：強制查詢提交時帶入參數並重導向（避免共用樣板被覆蓋）
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('singleGridQueryForm');
  const btn = document.getElementById('btnQuerySubmit');
  const currentUrl = new URL(window.location.href);
  const pageSizeVal = currentUrl.searchParams.get('pageSize') || '50';
  if (form) {
    form.setAttribute('method', 'get');
    form.setAttribute('action', window.location.pathname);
    // 確保 pageIndex/pageSize 都有
    let hiddenPage = form.querySelector('input[name="pageIndex"]');
    if (!hiddenPage) {
      hiddenPage = document.createElement('input');
      hiddenPage.type = 'hidden';
      hiddenPage.name = 'pageIndex';
      form.appendChild(hiddenPage);
    }
    let hiddenSize = form.querySelector('input[name="pageSize"]');
    if (!hiddenSize) {
      hiddenSize = document.createElement('input');
      hiddenSize.type = 'hidden';
      hiddenSize.name = 'pageSize';
      form.appendChild(hiddenSize);
    }
    hiddenSize.value = pageSizeVal;

    const ensureSubmit = (e) => {
      if (e) e.preventDefault();
      hiddenPage.value = '1';
      // 移除空欄位，避免殘留舊值
      Array.from(form.elements).forEach(el => {
        if (!el.name || el.type === 'hidden') return;
        const val = (el.value || '').toString().trim();
        if (!val) {
          // 若空，先暫時 disabled，提交時不帶入查詢參數
          el.disabled = true;
          setTimeout(() => { el.disabled = false; }, 0);
        }
      });
      form.submit();
    };
    form.addEventListener('submit', ensureSubmit);
    btn?.addEventListener('click', ensureSubmit);
  }

  const handleSubmit = (e) => {
    if (e) e.preventDefault();
    const url = new URL(window.location.href);
    url.searchParams.delete('pageIndex');
    url.searchParams.set('pageIndex', '1');
    if (form) {
      Array.from(form.elements).forEach(el => {
        if (!el.name) return;
        const val = (el.value || '').toString().trim();
        if (val) url.searchParams.set(el.name, val);
        else url.searchParams.delete(el.name);
      });
    }
    window.location.href = url.toString();
  };
  form?.addEventListener('submit', handleSubmit);
    btn?.addEventListener('click', handleSubmit);

  // 再加一層保險：監聽查詢按鈕點擊，直接從 modal 組 URL
  document.addEventListener('click', (e) => {
    const target = e.target;
    if (!(target instanceof HTMLElement)) return;
    if (target.id !== 'btnQuerySubmit') return;
    e.preventDefault();
    e.stopImmediatePropagation();
    const url = new URL(window.location.origin + window.location.pathname);
    const qs = new URLSearchParams();
    qs.set('pageIndex', '1');
    qs.set('pageSize', pageSizeVal);
    if (form) {
      const fd = new FormData(form);
      for (const [k, v] of fd.entries()) {
        const val = (v || '').toString().trim();
        if (!val) continue;
        qs.set(k, val);
      }
    } else {
      document.querySelectorAll('#singleGridQueryModal input[name]').forEach((inp) => {
        const name = inp.getAttribute('name') || '';
        if (!name) return;
        const val = (inp.value || '').toString().trim();
        if (val) qs.set(name, val);
      });
    }
    url.search = qs.toString();
    window.location.href = url.toString();
  }, true);

  // 單檔專用：新增按鈕與提交
  const initAddButton = () => {
    const addBtn = document.getElementById('btnAddCustomer');
    if (!window._cc000054CanAdd) {
      if (addBtn) addBtn.classList.add('d-none');
      return;
    }
    if (!addBtn) return;

    // 固定擺到主工具列：修改後、明細前
    const toolbarMainGroup = document.querySelector('.toolbar-main .d-flex.gap-2');
    const editBtn = document.getElementById('btnEditToggle');
    if (toolbarMainGroup) {
      if (editBtn && editBtn.parentElement === toolbarMainGroup) {
        editBtn.insertAdjacentElement('afterend', addBtn);
      } else {
        toolbarMainGroup.appendChild(addBtn);
      }
    }

    const addModalEl = document.getElementById('cc000054AddModal');
    const addCompanyId = document.getElementById('addCompanyId');
    const addCompanyName = document.getElementById('addCompanyName');
    const addShortName = document.getElementById('addShortName');
    const addCodeLabel = document.getElementById('addCodeLabel');
    const btnAddConfirm = document.getElementById('btnAddConfirm');
    const modal = addModalEl && window.bootstrap ? bootstrap.Modal.getOrCreateInstance(addModalEl) : null;

    let emptyShortName = '0';
    let initLoaded = false;

    const renderCodeLabel = () => {
      const sid = Number(window._cc000054SystemId || 1);
      if (addCodeLabel) addCodeLabel.textContent = sid === 1 ? '客戶編號' : '廠商編號';
    };

    const resetAddForm = () => {
      if (addCompanyId) addCompanyId.value = '';
      if (addCompanyName) addCompanyName.value = '';
      if (addShortName) addShortName.value = '';
    };

    const syncShortName = async () => {
      const cid = (addCompanyId?.value || '').trim();
      if (!cid) {
        if (addShortName) addShortName.value = '';
        return;
      }
      try {
        const resp = await fetch(`/api/CCSCompanyAdd/company?companyId=${encodeURIComponent(cid)}`);
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data?.success) throw new Error(data?.message || resp.statusText || 'load company failed');
        if (addShortName) addShortName.value = (data.shortName || '').toString();
        if (emptyShortName !== '1' && addShortName && addCompanyName && !addCompanyName.value.trim()) {
          addCompanyName.value = addShortName.value.trim();
        }
      } catch (err) {
        if (addShortName) addShortName.value = '';
        alert('讀取客廠簡稱失敗：' + err);
      }
    };

    const loadAddInit = async () => {
      const q = new URLSearchParams();
      q.set('itemId', (window._singleItemId || 'CC000054').toString());
      q.set('systemId', (window._cc000054SystemId || '1').toString());
      const resp = await fetch(`/api/CCSCompanyAdd/init?${q.toString()}`);
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data?.success) {
        throw new Error(data?.message || resp.statusText || 'init failed');
      }

      emptyShortName = (data.emptyShortName ?? '0').toString();
      if (addCompanyId) {
        const current = (addCompanyId.value || '').trim();
        // 純輸入模式：不顯示下拉清單，只保留可手打代碼
        if (current) addCompanyId.value = current;
      }
      initLoaded = true;
    };

    const addCompany = async (companyId, companyName, overwrite, allowOtherSubSystem) => {
      const body = {
        itemId: (window._singleItemId || 'CC000054').toString(),
        systemId: Number(window._cc000054SystemId || 1),
        companyId,
        companyName,
        overwrite,
        allowOtherSubSystem
      };
      const resp = await fetch('/api/CCSCompanyAdd/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data?.message || resp.statusText || 'add failed');
      return data;
    };

    const openAddDialog = async () => {
      try {
        renderCodeLabel();
        if (!initLoaded) await loadAddInit();
        resetAddForm();
        modal?.show();
        addCompanyId?.focus();
      } catch (err) {
        alert('讀取新增清單失敗：' + err);
      }
    };

    addBtn?.addEventListener('click', openAddDialog);

    addCompanyId?.addEventListener('change', syncShortName);
    addCompanyId?.addEventListener('blur', syncShortName);

    btnAddConfirm?.addEventListener('click', async () => {
      const cid = (addCompanyId?.value || '').trim();
      const cname = (addCompanyName?.value || '').trim();
      if (!cid || !cname) {
        alert('客戶/廠商編號與簡稱不可空白');
        return;
      }

      try {
        const warnResp = await fetch(`/api/CCSCompanyAdd/check-shortname?shortName=${encodeURIComponent(cname)}`);
        const warnData = await warnResp.json().catch(() => ({}));
        if (warnResp.ok && warnData?.success && !!warnData.exists) {
          alert('提示：系統內已有此簡稱的客廠資料。');
        }
      } catch {
      }

      try {
        let overwrite = false;
        let allowOther = false;
        while (true) {
          const result = await addCompany(cid, cname, overwrite, allowOther);
          if (result?.success) {
            modal?.hide();
            const systemId = result.systemId || window._cc000054SystemId || 1;
            const detailUrl = `${window._cc000054DetailUrl}?CompanyId=${encodeURIComponent(cid)}&systemId=${encodeURIComponent(systemId)}`;
            window.location.href = detailUrl;
            return;
          }
          if (result?.needOverwriteConfirm && !overwrite) {
            if (!confirm('查詢到有舊資料,是否覆蓋客戶舊資料?')) return;
            overwrite = true;
            continue;
          }
          if (result?.needOtherSubSystemConfirm && !allowOther) {
            if (!confirm('此代碼已存在其他分類中，確定要新增?')) return;
            allowOther = true;
            continue;
          }
          if ((result?.code || '') === 'DUPLICATE_CODE') {
            alert('代碼重複!!');
            return;
          }
          alert((result?.message || '新增失敗').toString());
          return;
        }
      } catch (err) {
        alert('新增失敗：' + err);
      }
    });

    const qs = new URLSearchParams(window.location.search || '');
    if (qs.get('openAdd') === '1') {
      openAddDialog();
      qs.delete('openAdd');
      const newQuery = qs.toString();
      const newUrl = `${window.location.pathname}${newQuery ? `?${newQuery}` : ''}`;
      window.history.replaceState({}, '', newUrl);
    }
  };

  const initOuterToolbarButtons = () => {
    const toolbarMainGroup = document.querySelector('.toolbar-main .d-flex.gap-2');
    if (!toolbarMainGroup) return;
    const bars = Array.from(document.querySelectorAll('#customButtonBarBottom'));
    const allBtns = [];
    bars.forEach(bar => {
      bar.querySelectorAll('button[data-custom-btn]').forEach(btn => allBtns.push(btn));
    });
    const byName = (name) => allBtns.find(b => ((b.dataset.buttonName || '').toLowerCase() === name.toLowerCase())) || null;
    const btnDetail = byName('openDetail');
    const btnQuery = document.getElementById('btnOpenQuery');
    const btnShowSystem = byName('showSystem');
    const btnAdd = document.getElementById('btnAddCustomer');
    const btnDelete = byName('deletePaper');
    const btnEdit = document.getElementById('btnEditToggle');
    const btnLog = byName('showLog');
    const btnReject = byName('rejectPaper');
    const ordered = [btnDetail, btnQuery, btnShowSystem, btnAdd, btnDelete, btnEdit, btnLog, btnReject].filter(Boolean);

    ordered.forEach(btn => {
      btn.classList.add('toolbar-btn');
      btn.classList.remove('btn-sm', 'singlegrid-custom-btn');
      if (btn.parentElement !== toolbarMainGroup) toolbarMainGroup.appendChild(btn);
      else toolbarMainGroup.appendChild(btn);
    });
    bars.forEach(bar => bar.classList.add('d-none'));
    const excelBtn = document.getElementById('btnExportExcel');
    if (excelBtn) excelBtn.classList.add('d-none');
    if (btnEdit) {
      btnEdit.classList.remove('d-none');
      btnEdit.innerHTML = '<i class="bi bi-pencil-square"></i>修改';
      btnEdit.addEventListener('click', (ev) => {
        ev.preventDefault();
        ev.stopImmediatePropagation();
        alert('外頁不可直接修改，請先進入明細頁再按修改。');
      }, true);
    }
  };

  const initCompanySelectQuery = () => {
    const queryModalEl = document.getElementById('cc000054QueryModal');
    const queryModal = queryModalEl && window.bootstrap ? bootstrap.Modal.getOrCreateInstance(queryModalEl) : null;
    const btnCompanySelectSearch = document.getElementById('btnCompanySelectSearch');
    const btnCompanySelectClear = document.getElementById('btnCompanySelectClear');
    const qCompanyList = document.getElementById('qCompanyList');
    const qSubClass = document.getElementById('qSubClass');
    const qSalesId = document.getElementById('qSalesId');
    const qPhoneCond = document.getElementById('qPhoneCond');
    const qFaxCond = document.getElementById('qFaxCond');

    let loaded = false;
    let queryInitPromise = null;
    let showSales = true;
    let systemId = Number(window._cc000054SystemId || 1);

    const labels = {
      companyLike: document.getElementById('qLblCompanyLike'),
      companyStart: document.getElementById('qLblCompanyStart'),
      companyEnd: document.getElementById('qLblCompanyEnd'),
      shortName: document.getElementById('qLblShortName'),
      uniFormId: document.getElementById('qLblUniFormId'),
      name: document.getElementById('qLblName'),
      addr: document.getElementById('qLblAddr'),
      subClass: document.getElementById('qLblSubClass'),
      sales: document.getElementById('qLblSales')
    };

    const setVendorLabels = () => {
      if (labels.companyLike) labels.companyLike.textContent = '廠商編號(模糊查詢)';
      if (labels.companyStart) labels.companyStart.textContent = '廠商編號起';
      if (labels.companyEnd) labels.companyEnd.textContent = '廠商編號迄';
      if (labels.shortName) labels.shortName.textContent = '廠商簡稱';
      if (labels.name) labels.name.textContent = '廠商名稱(模糊查詢)';
      if (labels.addr) labels.addr.textContent = '廠商地址(模糊查詢)';
      if (labels.subClass) labels.subClass.textContent = '廠商分類';
    };

    const toggleSalesRow = (visible) => {
      const salesLabel = labels.sales;
      const salesInput = document.getElementById('qSalesId');
      if (!salesLabel || !salesInput) return;
      salesLabel.classList.toggle('d-none', !visible);
      salesInput.classList.toggle('d-none', !visible);
    };

    const getInput = (id) => document.getElementById(id);
    const clearQueryForm = () => {
      [
        'qCompanyLike', 'qCompanyStart', 'qCompanyEnd', 'qShortName', 'qPhone', 'qFax',
        'qUniFormId', 'qCompanyName', 'qCompanyAddr', 'qBnsItem'
      ].forEach(id => {
        const el = getInput(id);
        if (el) el.value = '';
      });
      if (qPhoneCond) qPhoneCond.value = '0';
      if (qFaxCond) qFaxCond.value = '0';
      if (qSubClass) qSubClass.value = '';
      if (qSalesId) qSalesId.value = '';
    };

    const applyQueryToModal = () => {
      const qs = new URLSearchParams(window.location.search || '');
      const map = [
        ['qCompanyLike', 'cs_companyLike'],
        ['qCompanyStart', 'cs_companyStart'],
        ['qCompanyEnd', 'cs_companyEnd'],
        ['qShortName', 'cs_shortName'],
        ['qPhoneCond', 'cs_phoneCond'],
        ['qPhone', 'cs_phone'],
        ['qFaxCond', 'cs_faxCond'],
        ['qFax', 'cs_fax'],
        ['qUniFormId', 'cs_uniFormId'],
        ['qCompanyName', 'cs_companyName'],
        ['qCompanyAddr', 'cs_companyAddr'],
        ['qBnsItem', 'cs_bnsItem'],
        ['qSubClass', 'cs_subClass'],
        ['qSalesId', 'cs_salesId']
      ];
      map.forEach(([id, key]) => {
        const el = getInput(id);
        if (el) el.value = qs.get(key) || '';
      });
      if (!qs.get('cs_phoneCond') && qPhoneCond) qPhoneCond.value = '0';
      if (!qs.get('cs_faxCond') && qFaxCond) qFaxCond.value = '0';
    };

    const loadQueryInit = async () => {
      if (loaded) return;
      if (queryInitPromise) return queryInitPromise;
      queryInitPromise = (async () => {
      const q = new URLSearchParams();
      q.set('itemId', (window._singleItemId || 'CC000054').toString());
      q.set('systemId', (window._cc000054SystemId || '1').toString());
      const resp = await fetch(`/api/CCSCompanyAdd/query-init?${q.toString()}`);
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data?.success) {
        throw new Error(data?.message || resp.statusText || 'query-init failed');
      }

      systemId = Number(data.systemId || window._cc000054SystemId || 1);
      showSales = !!data.showSales;
      if (![1, 9, 103].includes(systemId)) setVendorLabels();
      toggleSalesRow(showSales);

      if (qCompanyList) {
        qCompanyList.innerHTML = '';
        (Array.isArray(data.companyList) ? data.companyList : []).forEach(r => {
          const id = (r.companyId ?? r.CompanyId ?? '').toString();
          if (!id) return;
          const opt = document.createElement('option');
          opt.value = id;
          qCompanyList.appendChild(opt);
        });
      }

      if (qSubClass) {
        qSubClass.innerHTML = '<option value=""></option>';
        (Array.isArray(data.subClassList) ? data.subClassList : []).forEach(r => {
          const val = (r.subSystemId ?? r.SubSystemId ?? '').toString();
          const name = (r.subSystemName ?? r.SubSystemName ?? '').toString();
          if (!val) return;
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = `${val}${name ? ' ' + name : ''}`;
          qSubClass.appendChild(opt);
        });
      }

      if (qSalesId) {
        qSalesId.innerHTML = '<option value=""></option>';
        (Array.isArray(data.users) ? data.users : []).forEach(r => {
          const id = (r.userId ?? r.UserId ?? '').toString();
          const name = (r.userName ?? r.UserName ?? '').toString();
          if (!id) return;
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = `${id}${name ? ' ' + name : ''}`;
          qSalesId.appendChild(opt);
        });
      }

      loaded = true;
      applyQueryToModal();
      })();
      try {
        await queryInitPromise;
      } finally {
        queryInitPromise = null;
      }
    };

    document.addEventListener('click', async (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      if (target.id !== 'btnOpenQuery') return;
      e.preventDefault();
      e.stopImmediatePropagation();
      try {
        if (!loaded || (qSubClass && qSubClass.options.length <= 1)) await loadQueryInit();
        applyQueryToModal();
        queryModal?.show();
      } catch (err) {
        alert('讀取查詢條件失敗：' + err);
      }
    }, true);

    btnCompanySelectClear?.addEventListener('click', clearQueryForm);
    btnCompanySelectSearch?.addEventListener('click', () => {
      const url = new URL(window.location.origin + window.location.pathname);
      const setParam = (key, id) => {
        const el = getInput(id);
        const val = (el?.value || '').toString().trim();
        if (val) url.searchParams.set(key, val);
      };
      url.searchParams.set('pageIndex', '1');
      url.searchParams.set('pageSize', pageSizeVal);
      setParam('cs_companyLike', 'qCompanyLike');
      setParam('cs_companyStart', 'qCompanyStart');
      setParam('cs_companyEnd', 'qCompanyEnd');
      setParam('cs_shortName', 'qShortName');
      setParam('cs_phoneCond', 'qPhoneCond');
      setParam('cs_phone', 'qPhone');
      setParam('cs_faxCond', 'qFaxCond');
      setParam('cs_fax', 'qFax');
      setParam('cs_uniFormId', 'qUniFormId');
      setParam('cs_companyName', 'qCompanyName');
      setParam('cs_companyAddr', 'qCompanyAddr');
      setParam('cs_bnsItem', 'qBnsItem');
      setParam('cs_subClass', 'qSubClass');
      if (showSales) setParam('cs_salesId', 'qSalesId');
      window.location.href = url.toString();
    });

    // Preload once so first open equals second open.
    loadQueryInit().catch(() => { });
  };

  initAddButton();
  initOuterToolbarButtons();
  initCompanySelectQuery();
});
</script>
<script>
  window.SingleGridCustomHandlers = window.SingleGridCustomHandlers || {};
  const withJwtHeaders = (init = {}) => {
    const jwt = localStorage.getItem("jwtId");
    const headers = Object.assign({}, init.headers || {});
    if (jwt) headers["X-JWTID"] = jwt;
    return { ...init, headers };
  };
  const fetchJsonWithTimeout = async (url, timeoutMs = 6000) => {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    try {
      const resp = await fetch(url, withJwtHeaders({ signal: ctrl.signal }));
      const json = await resp.json().catch(() => ({}));
      return { ok: resp.ok && json?.ok !== false, json, status: resp.status };
    } catch (err) {
      return { ok: false, json: { error: String(err) }, status: 0 };
    } finally {
      clearTimeout(t);
    }
  };
  window.SingleGridCustomHandlers.rejectPaper = async function(ctx) {
    const row = (ctx && ctx.selectedRow) || {};
    const keys = Object.keys(row || {});
    const idKey = keys.find(k => String(k).toLowerCase() === 'companyid');
    const paperNum = idKey ? String(row[idKey] || '').trim() : '';
    if (!paperNum) {
      alert('請先選取一筆資料');
      return;
    }
    if (!confirm(`確定要撤除：${paperNum} ?`)) return;

    const payload = {
      paperId: (window._singleRealTable || 'AJNdCompany').toString(),
      paperNum,
      itemId: (window._singleItemId || 'CC000054').toString(),
      userId: (window._userId || localStorage.getItem('erpLoginUserId') || 'admin').toString(),
      useId: (window._useId || 'A001').toString(),
      rejectNotes: ''
    };
    try {
      const resp = await fetch('/api/PaperAction/RejectForEdit', withJwtHeaders({
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }));
      const json = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(json?.message || resp.statusText || '撤除失敗');
      alert(json?.message || '撤除完成');
    } catch (err) {
      alert('撤除失敗：' + err);
    }
  };
  window.SingleGridCustomHandlers.deletePaper = async function(ctx) {
    const row = (ctx && ctx.selectedRow) || {};
    const keys = Object.keys(row || {});
    const idKey = keys.find(k => String(k).toLowerCase() === 'companyid');
    const paperNum = idKey ? String(row[idKey] || '').trim() : '';
    if (!paperNum) {
      alert('請先選取一筆資料');
      return;
    }
    if (!confirm(`確定要刪除：${paperNum} ?`)) return;

    const payload = {
      paperId: (window._singleRealTable || 'AJNdCompany').toString(),
      paperNum,
      itemId: (window._singleItemId || 'CC000054').toString(),
      userId: (window._userId || localStorage.getItem('erpLoginUserId') || 'admin').toString(),
      useId: (window._useId || 'A001').toString(),
      eoc: 0,
      aftFinished: 2
    };
    try {
      const resp = await fetch('/api/PaperAction/DoAction', withJwtHeaders({
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }));
      const json = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(json?.message || resp.statusText || '刪除失敗');
      alert(json?.message || '刪除完成');
      location.reload();
    } catch (err) {
      alert('刪除失敗：' + err);
    }
  };
  window.SingleGridCustomHandlers.showLog = async function(ctx) {
    const row = (ctx && ctx.selectedRow) || {};
    const keys = Object.keys(row || {});
    const idKey = keys.find(k => String(k).toLowerCase() === 'companyid');
    const paperNum = idKey ? String(row[idKey] || '').trim() : '';
    if (!paperNum) {
      alert('請先選取一筆資料');
      return;
    }
    if (typeof window.openCcsUpdateLog === 'function') {
      await window.openCcsUpdateLog({
        paperId: (window._singleRealTable || 'AJNdCompany').toString(),
        paperNum,
        itemId: (window._singleItemId || 'CC000054').toString()
      });
      return;
    }
    alert('記錄視窗尚未載入');
  };
  window.SingleGridCustomHandlers.showSystem = async function(ctx) {
    const row = (ctx && ctx.selectedRow) || {};
    const keys = Object.keys(row || {});
    const idKey = keys.find(k => String(k).toLowerCase() === 'companyid');
    const cid = idKey ? String(row[idKey] || '').trim() : '';
    if (!cid) {
      alert('請先選取一筆資料');
      return;
    }

    const modalEl = document.getElementById('showSystemModal');
    const modal = modalEl && window.bootstrap ? bootstrap.Modal.getOrCreateInstance(modalEl) : null;
    if (!modalEl || !modal) return;

    const setChecked = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.checked = Number(value || 0) === 1;
    };
    const setVal = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.value = value || '';
    };

    setVal('ssCompanyId', cid);
    setVal('ssShortName', '');
    setVal('ssCompanyName', '');
    ['ssSys1','ssSys2','ssSys3','ssSys4','ssSys5','ssSys6','ssSys7','ssSys8','ssSys9'].forEach(id => setChecked(id, 0));

    try {
      const resp = await fetch(`/api/CCSCompanyAdd/show-system?companyId=${encodeURIComponent(cid)}`);
      const json = await resp.json().catch(() => ({}));
      if (!resp.ok || !json?.success) throw new Error(json?.message || resp.statusText || 'load failed');
      const d = json.data || {};
      setVal('ssCompanyId', d.companyId || d.CompanyId || cid);
      setVal('ssShortName', d.shortName || d.ShortName || '');
      setVal('ssCompanyName', d.companyName || d.CompanyName || '');
      setChecked('ssSys1', d.sys_1 ?? d.Sys_1);
      setChecked('ssSys2', d.sys_2 ?? d.Sys_2);
      setChecked('ssSys3', d.sys_3 ?? d.Sys_3);
      setChecked('ssSys4', d.sys_4 ?? d.Sys_4);
      setChecked('ssSys5', d.sys_5 ?? d.Sys_5);
      setChecked('ssSys6', d.sys_6 ?? d.Sys_6);
      setChecked('ssSys7', d.sys_7 ?? d.Sys_7);
      setChecked('ssSys8', d.sys_8 ?? d.Sys_8);
      setChecked('ssSys9', d.sys_9 ?? d.Sys_9);

      const sys8Row = document.getElementById('ssSys8Row');
      const sys9Row = document.getElementById('ssSys9Row');
      const currentSystemId = Number(window._cc000054SystemId || 0);
      const showSys8 = Number(d.sys_8 ?? d.Sys_8 ?? 0) === 1 || currentSystemId === 8;
      const showSys9 = !!(d.hasSystem9 ?? d.HasSystem9 ?? true);
      sys8Row?.classList.toggle('d-none', !showSys8);
      sys9Row?.classList.toggle('d-none', !showSys9);
    } catch (err) {
      alert('讀取檢視身分失敗：' + err);
    }

    modal.show();
  };
  window.SingleGridCustomHandlers.openDetail = function(ctx) {
    const keys = Array.isArray(window._cc000054KeyFields) ? window._cc000054KeyFields : [];
    const row = ctx && ctx.selectedRow;
    if (!row) {
      alert('請先選取一筆資料');
      return;
    }
    const qs = new URLSearchParams();
    keys.forEach(k => {
      const v = row[k] ?? row[k?.toLowerCase()] ?? '';
      if (v !== undefined && v !== null && v !== '') {
        qs.append(k, v);
      }
    });
    if (!qs.toString()) {
      alert('找不到主鍵欄位，無法開啟明細');
      return;
    }
    const url = window._cc000054DetailUrl + '?' + qs.toString();
    const sysId = window._cc000054SystemId || '';
    const finalUrl = sysId ? `${url}&systemId=${encodeURIComponent(sysId)}` : url;
    window.location.href = finalUrl;
  };
</script>
<style>
#cc000054AddModal .modal-dialog {
  max-width: 340px;
}

#cc000054AddModal .modal-content {
  border-radius: 4px;
  border: 1px solid #b8b8b8;
  box-shadow: 0 8px 24px rgba(0,0,0,0.18);
}

#cc000054AddModal .modal-header {
  padding: 8px 10px;
}

#cc000054AddModal .modal-title {
  font-size: 16px;
  font-weight: 500;
}

.ccs-add-modal-body {
  padding: 10px 12px 8px;
}

.ccs-add-row {
  display: grid;
  grid-template-columns: 56px 1fr;
  gap: 8px;
  align-items: center;
  margin-bottom: 8px;
}

.ccs-add-label {
  text-align: right;
  margin: 0;
  font-size: 14px;
}

.ccs-add-inline {
  display: grid;
  grid-template-columns: 1fr 100px;
  gap: 6px;
}

.ccs-add-code-select,
.ccs-add-short,
#addCompanyName {
  height: 28px;
  border-radius: 0;
  font-size: 14px;
}


#cc000054AddModal .modal-footer {
  padding: 6px 10px 10px;
  border-top: 0;
}

#cc000054AddModal .modal-footer .btn {
  min-width: 72px;
  border-radius: 2px;
}

#cc000054QueryModal .modal-dialog {
  max-width: 620px;
}

.ccs-query-modal-body {
  padding: 10px 12px 6px;
}

.ccs-query-grid {
  display: grid;
  grid-template-columns: 170px 1fr;
  gap: 8px 10px;
  align-items: center;
}

.ccs-query-label {
  text-align: right;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.2;
}

.ccs-query-inline3 {
  display: grid;
  grid-template-columns: 110px minmax(0, 1fr);
  gap: 6px;
}

#cc000054QueryModal .form-control-sm,
#cc000054QueryModal .form-select-sm {
  height: 32px;
}

#cc000054QueryModal .modal-footer .btn {
  min-width: 72px;
}

#customButtonBarBottom {
  display: none !important;
}

#showSystemModal .ss-check-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 6px 12px;
}
</style>
<script src="~/js/ccsUpdateLog.js" asp-append-version="true"></script>
<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>






