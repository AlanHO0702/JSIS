@page "/CCS/{itemId}/Detail"
@model PcbErpApi.Pages.CCS.CC000054DetailModel
@using System.Text.Json
@{
    Layout = "_Layout";
    var cfg = Model.Config;
    var firstKey = Model.MasterKeyValues.FirstOrDefault(kv => string.Equals(kv.Key, "CompanyId", StringComparison.OrdinalIgnoreCase));
    var masterKeyVal = firstKey.Value ?? Model.MasterKeyValues.FirstOrDefault().Value ?? "";
    if (string.IsNullOrWhiteSpace(masterKeyVal))
    {
        masterKeyVal = Request.Query["CompanyId"].FirstOrDefault()
            ?? Request.Query["companyId"].FirstOrDefault()
            ?? Request.Query["CompanyyId"].FirstOrDefault()
            ?? "";
    }
}

@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", null, ViewData)
<script src="~/js/editableGrid.js"></script>

@if (cfg == null)
{
    <div class="alert alert-warning mt-3">初始化客戶主檔畫面失敗，請稍後再試。</div>
}
else
{
    <div class="ccs-detail-page" data-item-id="@Model.ItemId">
    <div class="top-toolbar matinfo-toolbar singlegrid-toolbar mb-1 mt-1">
        <div class="toolbar-icon-row">
            <button id="btnNavFirst" type="button" class="btn toolbar-btn toolbar-btn-icon" title="第一筆" aria-label="第一筆">
                <i class="bi bi-chevron-bar-left toolbar-icon"></i>
            </button>
            <button id="btnNavPrev" type="button" class="btn toolbar-btn toolbar-btn-icon" title="上一筆" aria-label="上一筆">
                <i class="bi bi-chevron-left toolbar-icon"></i>
            </button>
            <button id="btnNavNext" type="button" class="btn toolbar-btn toolbar-btn-icon" title="下一筆" aria-label="下一筆">
                <i class="bi bi-chevron-right toolbar-icon"></i>
            </button>
            <button id="btnNavLast" type="button" class="btn toolbar-btn toolbar-btn-icon" title="最後一筆" aria-label="最後一筆">
                <i class="bi bi-chevron-bar-right toolbar-icon"></i>
            </button>
        </div>
        <div class="toolbar-main matinfo-toolbar-actions">
            <a class="btn toolbar-btn" id="btnBackList" href="@Url.Page("CC000054", new { itemId = Model.ItemId, systemId = Model.SystemId })"><i class="bi bi-arrow-return-left"></i>回列表</a>
            <button type="button" class="btn toolbar-btn" id="btnTopQuery"><i class="bi bi-search"></i>查詢</button>
            <button type="button" class="btn toolbar-btn" id="btnTopShowSys"><i class="bi bi-person-badge"></i>檢視身分</button>
            <button type="button" class="btn toolbar-btn" id="btnTopEdit"><i class="bi bi-pencil-square"></i>編修</button>
            <button type="button" class="btn toolbar-btn success d-none" id="btnTopSave"><i class="bi bi-check2-circle"></i>儲存</button>
            <button type="button" class="btn toolbar-btn" id="btnTopAdd"><i class="bi bi-plus-lg"></i>新增</button>
        </div>
    </div>

    <div id="cc000054-master-form"
         class="position-relative mf-container"
         data-dict="@cfg?.MasterDict"
         data-dict-table="@cfg?.MasterDict"
         style="min-height:190px;"></div>

    <div class="ccs-panel" style="margin-top:2px;">
        <div class="p-1">
            <ul class="nav nav-tabs ccs-tabs matinfo-tabs" role="tablist">
                @for (int i = 0; i < Model.ExtraTabs.Count; i++)
                {
                    var tab = Model.ExtraTabs[i];
                    var active = i == 0 ? "active" : "";
                    <li class="nav-item" role="presentation">
                        <button class="nav-link @active"
                                id="tab-@tab.Key-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#tab-@tab.Key"
                                type="button"
                                role="tab"
                                aria-controls="tab-@tab.Key"
                                aria-selected="@(i == 0 ? "true" : "false")"
                                data-table="@tab.TableName"
                                data-dict="@tab.DictName"
                                data-keyfields="@string.Join(",", tab.KeyFields ?? Enumerable.Empty<string>())"
                                data-extra-keys="@string.Join(";", tab.ExtraKeys?.Select(k => $"{k.Key}={k.Value}") ?? Array.Empty<string>())">
                            @tab.Title
                        </button>
                    </li>
                }
            </ul>
            <div class="tab-content ccs-form">
                @for (int i = 0; i < Model.ExtraTabs.Count; i++)
                {
                    var tab = Model.ExtraTabs[i];
                    var active = i == 0 ? "show active" : "";
                    <div class="tab-pane fade @active" id="tab-@tab.Key" role="tabpanel" aria-labelledby="tab-@tab.Key-tab" data-form="@((tab.IsForm ? "1" : "0"))">
                        @if (tab.IsForm)
                        {
                            
                          <div id="form-@tab.Key"
                                class="position-relative mf-container"
                                data-dict="@tab.DictName"
                                data-dict-table="@tab.DictName"
                                style="min-height:170px;"></div>
                           
                        }
                        else
                        {
                            <div class="table-responsive" data-tab-key="@tab.Key">
                                <table class="table table-sm table-hover align-middle mb-0"
                                       id="grid-@tab.Key"
                                       data-table-name="@tab.TableName"
                                       data-dict-name="@tab.DictName"
                                       data-dict-table="@tab.DictName"
                                       data-key-fields="@string.Join(",", tab.KeyFields ?? Enumerable.Empty<string>())">
                                    <thead class="table-light">
                                        <tr><th class="text-center text-muted">載入中...</th></tr>
                                    </thead>
                                    <tbody>
                                        <tr><td class="text-center text-muted py-3">請點選上方主檔資料</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-2 d-flex gap-2 tab-local-controls d-none">
                                <button type="button" class="btn btn-outline-primary btn-sm" data-btn="edit" data-tab="@tab.Key">編輯</button>
                                <button type="button" class="btn btn-success btn-sm d-none" data-btn="save" data-tab="@tab.Key">儲存</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" data-btn="add" data-tab="@tab.Key">新增</button>
                                <button type="button" class="btn btn-outline-success btn-sm d-none" data-btn="confirm" data-tab="@tab.Key">確定</button>
                                <button type="button" class="btn btn-outline-danger btn-sm d-none" data-btn="cancel" data-tab="@tab.Key">取消</button>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
    </div>

    <div class="modal fade" id="showSystemModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">檢視身分</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row g-2 mb-2">
              <div class="col-12">
                <label class="form-label mb-1">公司代碼</label>
                <input id="ssCompanyId" class="form-control form-control-sm" readonly />
              </div>
              <div class="col-12">
                <label class="form-label mb-1">簡稱</label>
                <input id="ssShortName" class="form-control form-control-sm" readonly />
              </div>
              <div class="col-12">
                <label class="form-label mb-1">公司名稱</label>
                <input id="ssCompanyName" class="form-control form-control-sm" readonly />
              </div>
            </div>
            <div class="ss-check-grid">
              <label><input type="checkbox" id="ssSys1" disabled /> 銷售客戶</label>
              <label><input type="checkbox" id="ssSys2" disabled /> 供應商</label>
              <label><input type="checkbox" id="ssSys3" disabled /> 製程委外廠商</label>
              <label><input type="checkbox" id="ssSys4" disabled /> 製令委外廠商</label>
              <label><input type="checkbox" id="ssSys5" disabled /> 進出口廠商</label>
              <label><input type="checkbox" id="ssSys6" disabled /> 其他廠商</label>
              <label><input type="checkbox" id="ssSys7" disabled /> 經銷商</label>
              <label id="ssSys8Row" class="d-none"><input type="checkbox" id="ssSys8" disabled /> 廢棄物廠商</label>
              <label id="ssSys9Row"><input type="checkbox" id="ssSys9" disabled /> 未成交客戶</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">確定</button>
          </div>
        </div>
      </div>
    </div>
}

<script>
// Render field value in view mode.
function makeValueElement(field, rawVal) {
  const isCheckbox = Number(field?.ComboStyle ?? 0) === 1;
  if (isCheckbox) {
    const wrap = document.createElement('div');
    wrap.className = 'form-check m-0 d-inline-flex align-items-center';
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.className = 'form-check-input';
    chk.disabled = true;
    const val = rawVal == null ? '' : String(rawVal).toLowerCase();
    chk.checked = val === '1' || val === 'true' || val === 'y';
    wrap.appendChild(chk);
    return wrap;
  }
  const span = document.createElement('span');
  span.textContent = rawVal == null ? '' : rawVal;
  span.style.display = 'block';
  span.style.border = '1px solid #e5e7eb';
  span.style.background = '#f8fafc';
  span.style.padding = '1px 5px';
  span.style.borderRadius = '4px';
  span.style.minHeight = '14px';
  return span;
}

// ?梁嚗?鞈?颲剖摨扳?頧?銝??雿捆?函敶ｇ?銝餅??????堆?
function getLayoutRect(f) {
  const topPad = 6;
  const fieldGapX = 10;
  const n = (v, d = 0) => {
    const x = Number(v);
    return Number.isFinite(x) ? x : d;
  };

  const fTop = n(f.iFieldTop, 0) + topPad;
  const fLeft = n(f.iFieldLeft, 0);
  const rawFWidth = n(f.iFieldWidth, 0);
  const rawFHeight = n(f.iFieldHeight, 0);
  const fWidth = rawFWidth > 0 ? rawFWidth : 160;
  const fHeight = rawFHeight > 0 ? rawFHeight : 22;

  const hasLabel = !!String(f?.DisplayLabel ?? '').trim();
  const lTop = hasLabel ? (n(f.iLabTop, n(f.iFieldTop, 0)) + topPad) : fTop;
  const lLeft = hasLabel ? n(f.iLabLeft, 0) : fLeft;
  const rawLWidth = n(f.iLabWidth, 0);
  const rawLHeight = n(f.iLabHeight, 0);
  const lWidth = hasLabel ? (rawLWidth > 0 ? rawLWidth : 90) : 0;
  const lHeight = hasLabel ? (rawLHeight > 0 ? rawLHeight : fHeight) : 0;

  // Use field rect as the primary anchor; labels are rendered with relative offsets.
  // This matches dictionary coordinates more closely and avoids oversized field wrappers.
  const boxTop = fTop;
  const boxLeft = fLeft;
  const boxRight = fLeft + fWidth;
  const boxBottom = fTop + fHeight;

  const adjustedFieldLeft = hasLabel ? fieldGapX : 0;
  const adjustedFieldWidth = Math.max(40, fWidth - adjustedFieldLeft);

  return {
    boxTop,
    boxLeft,
    boxWidth: Math.max(8, boxRight - boxLeft),
    boxHeight: Math.max(8, boxBottom - boxTop),
    labTop: lTop - boxTop,
    labLeft: lLeft - boxLeft,
    labWidth: lWidth,
    labHeight: lHeight,
    fieldTop: fTop - boxTop,
    fieldLeft: (fLeft - boxLeft) + adjustedFieldLeft,
    fieldWidth: adjustedFieldWidth,
    fieldHeight: fHeight
  };
}
</script>

<script>
function getShowWhereValue(field) {
  const raw = field?.iShowWhere ?? field?.IShowWhere ?? field?.ishowWhere ?? field?.ISHOWWHERE ?? 1;
  const n = Number(raw);
  return Number.isFinite(n) ? n : 1;
}

function filterVisibleFields(dictArr, showWhere = 1) {
  const list = (Array.isArray(dictArr) ? dictArr : [])
    .filter(f => (f.Visible ?? 1) == 1)
    .filter(f => getShowWhereValue(f) === showWhere)
    .filter(f => {
      const nums = [f?.iFieldTop, f?.iFieldLeft, f?.iLabTop, f?.iLabLeft]
        .map(v => Number(v))
        .filter(v => Number.isFinite(v));
      if (nums.length === 0) return true;
      return nums.some(v => v > 0);
    })
    .sort((a,b) => (a.SerialNum ?? 9999) - (b.SerialNum ?? 9999));

  // Some dictionaries include duplicated layout rows for the same field
  // (e.g., copied panel/page design). Keep one entry per field name.
  const seen = new Map();
  for (const f of list) {
    const key = String(f?.FieldName || '').trim().toLowerCase();
    if (!key) continue;
    if (!seen.has(key)) {
      seen.set(key, f);
      continue;
    }
    const cur = seen.get(key);
    const curScore = (Number(cur?.iFieldTop) || 0) + (Number(cur?.iFieldLeft) || 0) + ((Number(cur?.SerialNum) || 0) / 1000);
    const nextScore = (Number(f?.iFieldTop) || 0) + (Number(f?.iFieldLeft) || 0) + ((Number(f?.SerialNum) || 0) / 1000);
    if (nextScore < curScore) seen.set(key, f);
  }
  return Array.from(seen.values()).sort((a,b) => (a.SerialNum ?? 9999) - (b.SerialNum ?? 9999));
}

const __lookupCache = new Map();
const __formRenderToken = Object.create(null);

function getLookupMeta(field) {
  const table = (field?.LookupTable || '').trim();
  const result = (field?.LookupResultField || '').trim();
  if (!table || !result) return null;
  const parts = result.split(',').map(x => x.trim()).filter(Boolean);
  if (parts.length < 2) return null;
  return {
    table,
    keyField: parts[0],
    nameField: parts[1]
  };
}

async function getLookupRows(table) {
  const key = (table || '').toLowerCase();
  if (!key) return [];
  if (__lookupCache.has(key)) return __lookupCache.get(key);
  try {
    const url = `/api/CommonTable/TopRows?table=${encodeURIComponent(table)}&top=5000`;
    const rows = await fetch(url).then(r => r.ok ? r.json() : []);
    const arr = Array.isArray(rows) ? rows : [];
    __lookupCache.set(key, arr);
    return arr;
  } catch {
    __lookupCache.set(key, []);
    return [];
  }
}

async function resolveLookupName(field, codeVal) {
  const meta = getLookupMeta(field);
  const code = codeVal == null ? '' : String(codeVal).trim();
  if (!meta || !code) return '';
  const rows = await getLookupRows(meta.table);
  const hit = rows.find(r => String(r?.[meta.keyField] ?? '').trim() === code);
  return String(hit?.[meta.nameField] ?? '').trim();
}

function makeLookupValueElement(code, name) {
  const wrap = document.createElement('div');
  wrap.className = 'mf-lk-view';

  const left = document.createElement('span');
  left.className = 'mf-lk-code';
  left.textContent = code == null ? '' : String(code);

  const right = document.createElement('span');
  right.className = 'mf-lk-name';
  right.textContent = name == null ? '' : String(name);

  wrap.append(left, right);
  return wrap;
}

function getLookupCodeWidth(fieldWidth) {
  const w = Number(fieldWidth) || 0;
  return Math.max(52, Math.min(96, Math.floor(w * 0.36)));
}

const __layoutEditEnabled = (() => {
  try {
    const q = new URLSearchParams(window.location.search || '');
    return q.get('layoutEdit') === '1';
  } catch {
    return false;
  }
})();
</script>

<script>
// Enable form layout drag/resize save only when layoutEdit=1.
function enableFormLayoutEditing(container, dictName) {
  if (!__layoutEditEnabled) return;
  if (!container || !dictName) return;
  const tableName = (dictName || '').trim().toLowerCase();
  const fields = Array.from(container.querySelectorAll('.mf-field'));
  const saveUrl = "/api/TableFieldLayout/SaveHeaderLayout";
  let dragTarget = null, startX = 0, startY = 0, startLeft = 0, startTop = 0;
  let resizeTarget = null, startW = 0, startH = 0;
  let dragGroup = [];
  let groupStart = new Map();
  let saveTimer = null;

  const debounceSave = () => {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      const layout = fields.map(f => ({
        fieldName: f.dataset.field || '',
        top: Math.round(f.offsetTop),
        left: Math.round(f.offsetLeft),
        width: Math.round(f.offsetWidth),
        height: Math.round(f.offsetHeight),
        ishowWhere: 1
      })).filter(x => x.fieldName);
      if (!layout.length || !tableName) return;
      fetch(saveUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tableName, layoutUpdates: layout })
      }).catch(()=>{});
    }, 300);
  };

  // multi-select
  const selected = new Set();
  const clearSelection = () => {
    selected.forEach(el => el.classList.remove('mf-selected'));
    selected.clear();
  };
  const selectField = (el, additive) => {
    if (!additive) clearSelection();
    if (selected.has(el)) {
      if (additive) {
        selected.delete(el);
        el.classList.remove('mf-selected');
      }
    } else {
      selected.add(el);
      el.classList.add('mf-selected');
    }
  };

  container.addEventListener('pointerdown', (e) => {
    if (e.target === container) clearSelection();
    if (container.dataset.formKey) currentFormKey = container.dataset.formKey;
  });

  fields.forEach(f => {
    const label = f.querySelector('label');
    const resizer = f.querySelector('.mf-resizer');
    f.style.cursor = 'move';
    f.style.userSelect = 'none';

    f.addEventListener('click', (e) => {
      e.stopPropagation();
      selectField(f, e.ctrlKey || e.metaKey);
      if (container.dataset.formKey) currentFormKey = container.dataset.formKey;
    });

    if (label) {
      label.addEventListener('mousedown', (e) => {
        if (container.dataset.editing === '1') return;
        e.preventDefault();
        dragTarget = f;
        startX = e.clientX;
        startY = e.clientY;
        const isMulti = selected.size > 0 && selected.has(f);
        dragGroup = isMulti ? Array.from(selected) : [f];
        groupStart = new Map(dragGroup.map(el => [el, { l: el.offsetLeft, t: el.offsetTop }]));
        startLeft = f.offsetLeft;
        startTop = f.offsetTop;
        document.body.classList.add('resizing');
      });
    }

    if (resizer) {
      resizer.addEventListener('mousedown', (e) => {
        if (container.dataset.editing === '1') return;
        e.preventDefault();
        e.stopPropagation();
        resizeTarget = f;
        startX = e.clientX;
        startY = e.clientY;
        startW = f.offsetWidth;
        startH = f.offsetHeight;
        document.body.classList.add('resizing');
      });
    }
  });

  document.addEventListener('mousemove', (e) => {
    if (dragTarget) {
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      dragGroup.forEach(el => {
        const pos = groupStart.get(el) || { l: el.offsetLeft, t: el.offsetTop };
        el.style.left = `${Math.max(0, pos.l + dx)}px`;
        el.style.top = `${Math.max(0, pos.t + dy)}px`;
      });
    }
    if (resizeTarget) {
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      resizeTarget.style.width = `${Math.max(50, startW + dx)}px`;
      resizeTarget.style.height = `${Math.max(30, startH + dy)}px`;
    }
  });

  document.addEventListener('mouseup', () => {
    if (dragTarget || resizeTarget) {
      document.body.classList.remove('resizing');
      debounceSave();
    }
    dragTarget = null;
    resizeTarget = null;
  });
}
</script>

<script>
  const formState = {}; // { [tabKey]: { tableName, dictName, extras, keyFields, editable } }
  let currentFormKey = 'master';
  let formEditMode = false;

  document.addEventListener('DOMContentLoaded', () => {
  const tabs = Array.from(document.querySelectorAll('[data-table][data-dict]'));
  let currentCompany = '@masterKeyVal' || null;
  if (!currentCompany) {
    const q = new URLSearchParams(window.location.search || '');
    currentCompany = q.get('CompanyId') || q.get('companyId') || q.get('CompanyyId') || null;
  }
  const tabState = {};
  const tabMeta = {}; // grid metadata
  let hasGridPendingAdd = false;

  function getDict(dictName) {
    return fetch(`/api/TableFieldLayout/GetTableFieldsFull?table=${encodeURIComponent(dictName)}`)
      .then(r => r.json());
  }

  function buildTable(tabKey, dict, rows, extras = [], tableNameOverride = '') {
    const table = document.getElementById(`grid-${tabKey}`);
    if (!table) return;
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    if (!thead || !tbody) return;

    const dictArr = Array.isArray(dict) ? dict : [];
    const visibleFields = filterVisibleFields(dictArr, 1);
    const pkFields = dictArr.filter(f => (f.PK ?? 0) === 1);
    const attrKeys = (table.dataset.keyFields || '').split(',').map(s => s.trim()).filter(Boolean);
    const pkKeyNames = pkFields.map(f => f.FieldName).filter(Boolean);
    const keyFields = [...new Set([...attrKeys, ...pkKeyNames])];
    const tableName = table.dataset.tableName || table.dataset.dictName || tableNameOverride || '';
    const hasCompanyField = [...visibleFields, ...pkFields].some(f => (f.FieldName || '').toLowerCase() === 'companyid');
    const serialField = [...visibleFields, ...pkFields].find(f => (f.FieldName || '').toLowerCase() === 'serialnum');

    tabMeta[tabKey] = {
      type: 'grid',
      dict: visibleFields,
      pkFields,
      extras,
      keyFields,
      tableName,
      hasCompanyField,
      serialField
    };

    // build head
    thead.innerHTML = '';
    const trHead = document.createElement('tr');
    visibleFields.forEach(f => {
      const th = document.createElement('th');
      th.textContent = f.DisplayLabel || f.FieldName;
      th.dataset.field = f.FieldName;
      th.style.minWidth = (Number(f.DisplaySize || 0) * 10 || 80) + 'px';
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);

    // build body
    tbody.innerHTML = '';
    if (!Array.isArray(rows) || rows.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = trHead.children.length || 1;
      td.className = 'text-center text-muted py-3';
      td.textContent = '無資料';
      tr.appendChild(td);
      tbody.appendChild(tr);
    } else {
      rows.forEach(row => {
        const tr = document.createElement('tr');
        visibleFields.forEach(f => {
          const td = document.createElement('td');
          td.dataset.field = f.FieldName;
          const raw = row[f.FieldName];
          const span = makeValueElement(f, raw);
          span.classList.add('cell-view');
          const inp = document.createElement('input');
          inp.className = 'form-control form-control-sm cell-edit d-none';
          inp.name = f.FieldName;
          inp.value = raw == null ? '' : raw;
          inp.dataset.raw = raw == null ? '' : raw;
          inp.dataset.readonly = (f.ReadOnly ?? 0) != 0 ? '1' : '0';
          if ((f.ReadOnly ?? 0) != 0) {
            inp.classList.add('readonly-cell');
            inp.setAttribute('readonly','readonly');
          }
          td.append(span, inp);
          tr.appendChild(td);
        });
        // hidden PK ?????謓舀????
        pkFields
          .filter(f => (f.Visible ?? 1) == 0)
          .forEach(f => {
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.className = 'mmd-pk-hidden';
            hidden.name = f.FieldName;
            const lower = (f.FieldName || '').toLowerCase();
            const extraVal = extras.find(kv => (kv.key || '').toLowerCase() === lower)?.value;
            hidden.value = row[f.FieldName] ?? extraVal ?? (lower === 'companyid' ? currentCompany || '' : '');
            tr.appendChild(hidden);
          });
        // Keep hidden PK values for non-visible key fields.
        if (!hasCompanyField) {
          const hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.className = 'mmd-pk-hidden';
          hidden.name = 'CompanyId';
          hidden.value = currentCompany || '';
          tr.appendChild(hidden);
        }
        tbody.appendChild(tr);
      });
    }

    const wrapper = table.closest('.table-responsive');
    tabState[tabKey] = window.makeEditableGrid({
      wrapper,
      table,
      tableName,
      keyFields
    });
    syncGridButtons(tabKey);
  }

  function parseExtraKeys(raw) {
    const list = [];
    (raw || '').split(';').forEach(pair => {
      const [k,v] = pair.split('=');
      if (k && v !== undefined) list.push({ key: k.trim(), value: v.trim() });
    });
    return list;
  }

  const syncGridButtons = (tabKey) => {
    const pane = document.getElementById(`tab-${tabKey}`);
    const ctrls = pane?.querySelector('.tab-local-controls');
    if (!ctrls) return;
    ctrls.classList.remove('d-none');
    const editing = !!tabState[tabKey]?.isEdit?.();
    const hasAdd = !!pane.querySelector('tr[data-state="added"]');
    const btnEdit = ctrls.querySelector('[data-btn="edit"]');
    const btnSave = ctrls.querySelector('[data-btn="save"]');
    const btnAdd = ctrls.querySelector('[data-btn="add"]');
    const btnConfirm = ctrls.querySelector('[data-btn="confirm"]');
    const btnCancel = ctrls.querySelector('[data-btn="cancel"]');
    if (btnEdit) btnEdit.textContent = editing ? '瀏覽' : '編輯';
    btnSave?.classList.toggle('d-none', !editing);
    btnAdd?.classList.remove('d-none');
    btnConfirm?.classList.toggle('d-none', !hasAdd);
    btnCancel?.classList.toggle('d-none', !hasAdd);
  };

  const addBlankGridRow = (tabKey) => {
    const meta = tabMeta[tabKey];
    const table = document.getElementById(`grid-${tabKey}`);
    const tbody = table?.querySelector('tbody');
    if (!meta || !table || !tbody) return;
    if (!meta.dict || !meta.dict.length) return;

    // Remove placeholder row before adding a new row.
    tbody.querySelectorAll('tr').forEach(tr => {
      if (tr.querySelector('.text-muted') && !tr.dataset.state) tr.remove();
    });

    const extrasMap = {};
    (meta.extras || []).forEach(kv => extrasMap[(kv.key || '').toLowerCase()] = kv.value);
    const serialField = meta.serialField;
    let nextSerial = '';
    if (serialField) {
      const existing = Array.from(tbody.querySelectorAll('tr')).map(r => {
        const cell = r.querySelector(`input[name="${serialField.FieldName}"]`) || r.querySelector(`td[data-field="${serialField.FieldName}"] .cell-edit`);
        const val = cell?.value || cell?.textContent || '';
        return Number.parseInt(val, 10) || 0;
      });
      nextSerial = (Math.max(0, ...existing) + 1).toString();
    }

    const tr = document.createElement('tr');
    tr.dataset.state = 'added';
    meta.dict.forEach(f => {
      const td = document.createElement('td');
      td.dataset.field = f.FieldName;
      const span = makeValueElement(f, '');
      span.classList.add('cell-view');
      const inp = document.createElement('input');
      inp.className = 'form-control form-control-sm cell-edit d-none';
      inp.name = f.FieldName;
      let val = '';
      const lower = (f.FieldName || '').toLowerCase();
      if (lower === 'companyid') {
        val = currentCompany || '';
      } else if (lower === 'serialnum') {
        val = nextSerial || '';
      } else if (lower === 'useid') {
        val = 'A001';
      } else if (extrasMap[lower] !== undefined) {
        val = extrasMap[lower];
      }
      if (!val && lower === 'asstype') val = '0';
      if (!val && lower === 'language') val = '0';
      inp.value = val;
      inp.defaultValue = val;
      inp.dataset.raw = val;
      inp.dataset.readonly = (f.ReadOnly ?? 0) != 0 ? '1' : '0';
      if ((f.ReadOnly ?? 0) != 0) {
        inp.classList.add('readonly-cell');
        inp.setAttribute('readonly','readonly');
      }
      td.append(span, inp);
      tr.appendChild(td);
    });
    // ?梯? PK 甈?
    (meta.pkFields || []).filter(f => (f.Visible ?? 1) == 0).forEach(f => {
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.className = 'mmd-pk-hidden';
      hidden.name = f.FieldName;
      const lower = (f.FieldName || '').toLowerCase();
      if (lower === 'companyid') {
        hidden.value = currentCompany || '';
      } else {
        let serialVal = '';
        if (lower === 'serialnum') {
          serialVal = nextSerial || '';
        }
        let val = serialVal || '';
        if (!val && lower === 'useid') val = 'A001';
        if (!val && lower === 'asstype') val = '0';
        if (!val && lower === 'language') val = '0';
        if (!val && extrasMap[lower] !== undefined) val = extrasMap[lower];
        hidden.value = val;
      }
      tr.appendChild(hidden);
    });
    // Ensure CompanyId hidden key exists when column is not visible.
    if (!meta.hasCompanyField) {
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.className = 'mmd-pk-hidden';
      hidden.name = 'CompanyId';
      hidden.value = currentCompany || '';
      tr.appendChild(hidden);
    }
    tbody.prepend(tr);
    tabState[tabKey]?.toggleEdit?.(true);
    hasGridPendingAdd = true;
    setTopEditUI(true);
    syncGridButtons(tabKey);
  };

  const toggleGridEdit = (tabKey, editable) => {
    const editor = tabState[tabKey];
    if (!editor) return;
    editor.toggleEdit(editable);
    setTopEditUI(editable);
    if (!editable) cancelGridAdd(tabKey, { keepEditingFlag: true });
    syncGridButtons(tabKey);
  };

  const saveGridChanges = async (tabKey) => {
    const editor = tabState[tabKey];
    if (!editor) return;
    const res = await editor.saveChanges();
    if (res.ok) {
      alert('儲存成功');
      toggleGridEdit(tabKey, false);
      if (currentCompany) loadTabData(tabKey, currentCompany);
    } else {
      alert('儲存失敗: ' + (res.text || ''));
    }
  };

  const cancelGridAdd = (tabKey, opts = {}) => {
    const table = document.getElementById(`grid-${tabKey}`);
    const tbody = table?.querySelector('tbody');
    if (!tbody) return;
    tbody.querySelectorAll('tr[data-state="added"]').forEach(tr => tr.remove());
    hasGridPendingAdd = false;
    if (!opts.keepEditingFlag) setTopEditUI(false);
    syncGridButtons(tabKey);
  };

  const getActiveFormTabKey = () => {
    const activeBtn = document.querySelector('[data-bs-toggle="tab"].active');
    if (!activeBtn) return null;
    const key = activeBtn.dataset.tabKey || activeBtn.dataset.tab || activeBtn.id?.replace('tab-','').replace('-tab','');
    if (!key) return null;
    const pane = document.getElementById(`tab-${key}`);
    if (pane?.getAttribute('data-form') === '1') return key;
    return null;
  };

  async function renderForm(tabKey, dictName, tableName, companyId, extras = []) {
    const host = tabKey === 'master'
      ? document.getElementById('cc000054-master-form')
      : document.getElementById(`form-${tabKey}`);
    if (!host || !dictName || !tableName || !companyId) return;
    try {
      const token = ((__formRenderToken[tabKey] || 0) + 1);
      __formRenderToken[tabKey] = token;
      const extraParams = extras.map(kv => `&keyNames=${encodeURIComponent(kv.key)}&keyValues=${encodeURIComponent(kv.value)}`).join("");
      const [dict, rows] = await Promise.all([
        fetch(`/api/TableFieldLayout/GetTableFieldsFull?table=${encodeURIComponent(dictName)}`).then(r => r.json()),
        fetch(`/api/CommonTable/ByKeys?table=${encodeURIComponent(tableName)}&keyNames=CompanyId&keyValues=${encodeURIComponent(companyId)}${extraParams}`).then(r => r.json())
      ]);
      if (__formRenderToken[tabKey] !== token) return;
      const data = Array.isArray(rows) ? rows[0] || {} : {};
      const fields = filterVisibleFields(dict, 1);
      const pkFields = Array.isArray(dict) ? dict.filter(f => (f.PK ?? 0) === 1).map(f => f.FieldName).filter(Boolean) : [];
      host.dataset.dictName = dictName;
      const container = document.createElement('div');
      container.className = tabKey === 'master'
        ? 'position-relative mf-container'
        : 'position-relative mf-container mf-form';
      container.dataset.dictTable = dictName;
      container.dataset.formKey = tabKey;

      const sortedFields = [...fields].sort((a,b)=>(a.SerialNum ?? 0)-(b.SerialNum ?? 0));
      for (const f of sortedFields) {
          const layout = getLayoutRect(f);
          const val = data[f.FieldName] ?? '';

          const wrapper = document.createElement('div');
          wrapper.className = 'mf-field';
          wrapper.dataset.field = f.FieldName;
          wrapper.style.position = 'absolute';
          wrapper.style.top = `${layout.boxTop}px`;
          wrapper.style.left = `${layout.boxLeft}px`;
          wrapper.style.width = `${layout.boxWidth}px`;
          wrapper.style.height = `${layout.boxHeight}px`;
          wrapper.style.minHeight = `${layout.boxHeight}px`;
          wrapper.style.overflow = 'visible';

          const hasLabelText = !!String(f.DisplayLabel || '').trim();
          const label = document.createElement('label');
          label.textContent = f.DisplayLabel || f.FieldName;
          label.style.position = 'absolute';
          label.style.top = `${layout.boxTop + layout.labTop}px`;
          label.style.left = `${layout.boxLeft + layout.labLeft}px`;
          label.style.width = `${layout.labWidth}px`;
          label.style.height = `${layout.labHeight}px`;
          label.style.lineHeight = `${layout.labHeight}px`;
          label.style.textAlign = 'right';
          label.style.whiteSpace = 'nowrap';
          label.style.margin = '0';
          label.classList.add('mf-label');

          const lookupMeta = getLookupMeta(f);
          if (lookupMeta) {
            wrapper.dataset.lookupTable = lookupMeta.table;
            wrapper.dataset.lookupKeyField = lookupMeta.keyField;
            wrapper.dataset.lookupNameField = lookupMeta.nameField;
          }
          const lookupName = lookupMeta ? await resolveLookupName(f, val) : '';
          if (__formRenderToken[tabKey] !== token) return;
          const span = lookupMeta
            ? makeLookupValueElement(val, lookupName)
            : makeValueElement(f, val);
          span.classList.add('mf-view');
          span.style.position = 'absolute';
          span.style.top = `${layout.fieldTop}px`;
          span.style.left = `${layout.fieldLeft}px`;
          span.style.width = `${layout.fieldWidth}px`;
          span.style.height = `${layout.fieldHeight}px`;
          span.style.minHeight = `${layout.fieldHeight}px`;

          let editor;
          let lookupNameEditor = null;
          if (Number(f.ComboStyle ?? 0) === 1) {
            editor = document.createElement('input');
            editor.type = 'checkbox';
            editor.className = 'form-check-input mf-edit d-none';
            editor.name = f.FieldName;
            editor.checked = String(val).toLowerCase() === '1' || String(val).toLowerCase() === 'true';
            editor.style.position = 'absolute';
            editor.style.top = `${layout.fieldTop + 4}px`;
            editor.style.left = `${layout.fieldLeft + 4}px`;
          } else {
            const useTextarea = (layout.fieldHeight >= 40);
            if (useTextarea) {
              editor = document.createElement('textarea');
              editor.rows = Math.max(1, Math.round(layout.fieldHeight / 18));
            } else {
              editor = document.createElement('input');
              editor.type = 'text';
            }
            editor.className = 'form-control form-control-sm mf-edit d-none mf-input';
            editor.name = f.FieldName;
            editor.value = val == null ? '' : val;
            editor.style.position = 'absolute';
            editor.style.top = `${layout.fieldTop}px`;
            editor.style.left = `${layout.fieldLeft}px`;
            const codeWidth = lookupMeta ? getLookupCodeWidth(layout.fieldWidth) : layout.fieldWidth;
            editor.style.width = `${codeWidth}px`;
            editor.style.height = `${layout.fieldHeight}px`;
            editor.style.minHeight = `${layout.fieldHeight}px`;
            if (lookupMeta) {
              lookupNameEditor = document.createElement('input');
              lookupNameEditor.type = 'text';
              lookupNameEditor.className = 'form-control form-control-sm mf-lk-edit-name d-none';
              lookupNameEditor.readOnly = true;
              lookupNameEditor.value = lookupName || '';
              lookupNameEditor.style.position = 'absolute';
              lookupNameEditor.style.top = `${layout.fieldTop}px`;
              lookupNameEditor.style.left = `${layout.fieldLeft + codeWidth}px`;
              lookupNameEditor.style.width = `${Math.max(60, layout.fieldWidth - codeWidth)}px`;
              lookupNameEditor.style.height = `${layout.fieldHeight}px`;
              lookupNameEditor.style.minHeight = `${layout.fieldHeight}px`;
              editor.addEventListener('input', () => {
                resolveLookupName(f, editor.value || '').then((nm) => {
                  if (lookupNameEditor) lookupNameEditor.value = nm || '';
                });
              });
            }
          }
          if (Number(f.ReadOnly ?? 0) === 1) {
            editor.setAttribute('readonly', 'readonly');
            editor.dataset.readonly = '1';
          }

          const resizer = document.createElement('span');
          resizer.className = 'mf-resizer';

          if (hasLabelText) container.appendChild(label);
          wrapper.append(span, editor);
          if (lookupNameEditor) wrapper.appendChild(lookupNameEditor);
          wrapper.appendChild(resizer);
          container.appendChild(wrapper);
      }

      if (__formRenderToken[tabKey] !== token) return;
      host.replaceChildren(container);
      let maxBottom = 0;
      container.querySelectorAll('.mf-field').forEach(el => {
        const top = parseFloat(el.style.top || '0') || 0;
        const h = parseFloat(el.style.height || '0') || 0;
        maxBottom = Math.max(maxBottom, top + h);
      });
      container.querySelectorAll('.mf-label').forEach(el => {
        const top = parseFloat(el.style.top || '0') || 0;
        const h = parseFloat(el.style.height || '0') || 0;
        maxBottom = Math.max(maxBottom, top + h);
      });
      if (maxBottom > 0) {
        const targetHeight = Math.max(120, Math.ceil(maxBottom + 6));
        host.style.minHeight = `${targetHeight}px`;
        // Master keeps fixed container height; tab forms keep compact auto layout.
        if (tabKey === 'master') host.style.height = `${targetHeight}px`;
        else host.style.height = 'auto';
      }
      enableFormLayoutEditing(container, dictName);
      const tabBtn = tabKey === 'master' ? null : document.getElementById(`tab-${tabKey}-tab`);
      const btnKeys = (tabBtn?.dataset?.keyfields || "").split(',').map(s=>s.trim()).filter(Boolean);
      const keyFields = pkFields.length ? pkFields : (btnKeys.length ? btnKeys : ['CompanyId']);
      const extraKeysNames = extras.map(kv => kv.key);
      formState[tabKey] = {
        tableName,
        dictName,
        extras,
        keyFields: [...new Set([...keyFields, ...extraKeysNames])],
        editable: formEditMode
      };
      if (tabKey === 'master') {
        document.dispatchEvent(new CustomEvent('md-master-selected', {
          detail: { rowData: data || {} }
        }));
      }
    } catch (err) {
      console.error('render form tab failed', err);
    }
  }

  async function loadTabData(tabKey, companyId) {
    const btn = document.getElementById(`tab-${tabKey}-tab`);
    if (!btn) return;
    const tableName = btn.dataset.table;
    const dictName = btn.dataset.dict || tableName;
    const pane = document.getElementById(`tab-${tabKey}`);
    const isForm = pane?.getAttribute('data-form') === '1';
    const extras = parseExtraKeys(btn.dataset.extraKeys || "");
    if (!tableName || !companyId) return;

    try {
      if (isForm) {
        await renderForm(tabKey, dictName, tableName, companyId, extras);
        setFormMode(tabKey, !!formEditMode);
        return;
      }

      const extraParams = extras.map(kv => `&keyNames=${encodeURIComponent(kv.key)}&keyValues=${encodeURIComponent(kv.value)}`).join("");
      const url = `/api/CommonTable/ByKeys?table=${encodeURIComponent(tableName)}&keyNames=CompanyId&keyValues=${encodeURIComponent(companyId)}${extraParams}`;
      const [dict, rows] = await Promise.all([
        getDict(dictName),
        fetch(url).then(r => r.json())
      ]);
      buildTable(tabKey, dict || [], Array.isArray(rows) ? rows : [], extras, tableName);
    } catch (err) {
      console.error('load tab data failed', tabKey, err);
      const table = document.getElementById(`grid-${tabKey}`);
      const thead = table?.querySelector('thead');
      const tbody = table?.querySelector('tbody');
      if (thead) thead.innerHTML = '<tr><th class="text-center text-muted">載入失敗</th></tr>';
      if (tbody) tbody.innerHTML = '<tr><td class="text-center text-danger py-3">分頁資料載入失敗，請確認主檔鍵值或稍後再試。</td></tr>';
    }
  }

  document.addEventListener('md-master-selected', (ev) => {
    const row = ev?.detail?.rowData;
    if (!row) return;
    currentCompany = row.CompanyId || row.companyid || row.COMPANYID;
    if (!currentCompany) return;
    tabs.forEach(btn => {
      const isActive = btn.classList.contains('active');
      if (isActive) loadTabData(btn.dataset.tabKey || btn.dataset.target || btn.id.replace('tab-','').replace('-tab',''), currentCompany);
    });
  });

  tabs.forEach(btn => {
    const tabKey = btn.id.replace('tab-','').replace('-tab','');
    btn.dataset.tabKey = tabKey;
    btn.addEventListener('shown.bs.tab', () => {
      // Keep dictionary target in sync for F3 field dictionary editor.
      if (btn.dataset.dict) window._dictTableName = btn.dataset.dict;
      if (currentCompany) loadTabData(tabKey, currentCompany);
      const pane = document.getElementById(`tab-${tabKey}`);
      const isForm = pane?.getAttribute('data-form') === '1';
      if (formEditMode && isForm) {
        setFormMode(tabKey, true);
      }
      if (!isForm) {
        syncGridButtons(tabKey);
        setTopEditUI(!!tabState[tabKey]?.isEdit?.());
      }
    });
  });

  // per-tab buttons
  document.querySelectorAll('[data-btn]').forEach(b => {
    b.addEventListener('click', async () => {
      const tabKey = b.dataset.tab;
      const btnType = b.dataset.btn;
      const pane = document.getElementById(`tab-${tabKey}`);
      const isForm = pane?.getAttribute('data-form') === '1';
      if (isForm) {
        if (btnType === 'edit') {
          applyFormEditMode(!formState[tabKey]?.editable);
        } else if (btnType === 'save' || btnType === 'confirm') {
          const res = await saveFormChanges(tabKey);
          if (res?.ok) {
            alert('儲存成功');
            applyFormEditMode(false);
            if (currentCompany) loadTabData(tabKey, currentCompany);
          } else {
            alert('儲存失敗: ' + (res?.text || ''));
          }
        }
        return;
      }
      if (btnType === 'edit') {
        toggleGridEdit(tabKey, !(tabState[tabKey]?.isEdit?.()));
      } else if (btnType === 'save') {
        await saveGridChanges(tabKey);
      } else if (btnType === 'add') {
        addBlankGridRow(tabKey);
      } else if (btnType === 'confirm') {
        await saveGridChanges(tabKey);
      } else if (btnType === 'cancel') {
        cancelGridAdd(tabKey);
      }
      syncGridButtons(tabKey);
    });
  });

  // Top toolbar actions apply to current active tab.
  const topEdit = document.getElementById('btnTopEdit');
  const topSave = document.getElementById('btnTopSave');
  const topAdd  = document.getElementById('btnTopAdd');
  const topQuery = document.getElementById('btnTopQuery');
  const topShowSys = document.getElementById('btnTopShowSys');
  const navFirst = document.getElementById('btnNavFirst');
  const navPrev = document.getElementById('btnNavPrev');
  const navNext = document.getElementById('btnNavNext');
  const navLast = document.getElementById('btnNavLast');
  const topConfirm = document.createElement('button');
  topConfirm.type = 'button';
  topConfirm.className = 'btn toolbar-btn d-none';
  topConfirm.id = 'btnTopConfirm';
  topConfirm.textContent = '確定';
  topSave?.insertAdjacentElement('afterend', topConfirm);
  const topCancel = document.createElement('button');
  topCancel.type = 'button';
  topCancel.className = 'btn toolbar-btn d-none';
  topCancel.id = 'btnTopCancel';
  topCancel.textContent = '取消';
  topConfirm.insertAdjacentElement('afterend', topCancel);

  const setTopEditUI = (editing) => {
    topSave?.classList.toggle('d-none', !editing);
    document.body.classList.toggle('ccs-editing', !!editing);
    if (topEdit) {
      topEdit.innerHTML = editing
        ? '<i class="bi bi-eye"></i>瀏覽'
        : '<i class="bi bi-pencil-square"></i>編修';
      topEdit.classList.toggle('primary', editing);
    }
    topAdd?.classList.toggle('d-none', editing);
    topConfirm?.classList.toggle('d-none', !(editing && hasGridPendingAdd));
    topCancel?.classList.toggle('d-none', !(editing && hasGridPendingAdd));
  };

  const applyFormEditMode = (editable) => {
    formEditMode = editable;
    setFormMode('master', editable);
    const activeFormKey = getActiveFormTabKey();
    if (activeFormKey) setFormMode(activeFormKey, editable);
    setTopEditUI(editable);
  };

  const setFormMode = (tabKey, editable) => {
    const host = tabKey === 'master'
      ? document.getElementById('cc000054-master-form')
      : document.getElementById(`form-${tabKey}`);
    if (!host) return;
    // In edit mode: show input controls; in browse mode: show view values.
    host.dataset.editing = editable ? '1' : '0';
    host.querySelectorAll('.mf-field').forEach(f => {
      f.style.cursor = editable ? 'text' : 'default';
      f.style.userSelect = editable ? 'auto' : 'none';
    });
    host.querySelectorAll('.mf-resizer').forEach(r => {
      r.style.display = (!editable && __layoutEditEnabled) ? 'block' : 'none';
    });
    host.querySelectorAll('.mf-field').forEach(f => {
      const view = f.querySelector('.mf-view');
      const edit = f.querySelector('.mf-edit');
      const lkEditName = f.querySelector('.mf-lk-edit-name');
      if (!view || !edit) return;
      // Keep same visual layout in both modes: always show edit controls.
      view.classList.add('d-none');
      edit.classList.remove('d-none');
      if (lkEditName) lkEditName.classList.remove('d-none');

      const forceDisabled = (!editable) || (edit.dataset.readonly === '1');
      if (edit.tagName === 'INPUT' && edit.type === 'checkbox') {
        edit.disabled = forceDisabled;
      } else {
        if (forceDisabled) {
          edit.setAttribute('readonly', 'readonly');
          edit.setAttribute('disabled', 'disabled');
        } else {
          edit.removeAttribute('readonly');
          edit.removeAttribute('disabled');
        }
      }
      if (lkEditName) {
        lkEditName.setAttribute('readonly', 'readonly');
        lkEditName.setAttribute('disabled', 'disabled');
      }
    });
    if (formState[tabKey]) formState[tabKey].editable = editable;
  };

  const saveFormChanges = async (tabKey) => {
    const state = formState[tabKey];
    if (!state || !currentCompany) return { ok:false, text:'no state' };
    const host = tabKey === 'master' ? document.getElementById('cc000054-master-form') : document.getElementById(`form-${tabKey}`);
    if (!host) return { ok:false, text:'no host' };
    const data = {};
    host.querySelectorAll('.mf-edit').forEach(el => {
      const name = el.name || '';
      if (!name) return;
      if (el.type === 'checkbox') {
        data[name] = el.checked ? '1' : '0';
      } else {
        data[name] = el.value ?? '';
      }
    });
    const keys = state.keyFields?.length ? state.keyFields : ['CompanyId'];
    keys.forEach(k => {
      if (data[k] == null || data[k] === '') data[k] = currentCompany;
    });
    (state.extras || []).forEach(kv => {
      data[kv.key] = kv.value;
    });
    const payload = {
      TableName: state.tableName,
      KeyFields: keys,
      Data: [ data ]
    };
    let resp, txt;
    try {
      resp = await fetch("/api/CommonTable/SaveTableChanges", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      txt = await resp.text();
      if (!resp.ok) return { ok:false, text:txt || resp.statusText };
      return { ok:true, text:txt };
    } catch (err) {
      return { ok:false, text: String(err) };
    }
  };

  const triggerTabAction = (action) => {
    const activeTabBtn = document.querySelector('[data-bs-toggle="tab"].active');
    const activeTabKey = activeTabBtn ? (activeTabBtn.dataset.tab || activeTabBtn.dataset.tabKey || activeTabBtn.id?.replace('tab-','').replace('-tab','')) : '';
    const pane = activeTabKey ? document.getElementById(`tab-${activeTabKey}`) : null;
    const isForm = (!pane && !!formState['master']) || (pane?.getAttribute('data-form') === '1');
    const activeFormKey = getActiveFormTabKey();
    if (isForm) {
      if (action === 'edit') {
        applyFormEditMode(!formEditMode);
      } else if (action === 'save') {
        if (!formEditMode) return;
        const toSave = ['master'];
        if (activeFormKey && activeFormKey !== 'master') toSave.push(activeFormKey);
        (async () => {
          for (const key of toSave) {
            const res = await saveFormChanges(key);
            if (!res.ok) {
              alert(`儲存失敗(${key}): ${res.text || ''}`);
              return;
            }
          }
          alert('儲存成功');
          applyFormEditMode(false);
          if (currentCompany && activeFormKey && activeFormKey !== 'master') loadTabData(activeFormKey, currentCompany);
        })();
      } else if (action === 'add') {
        document.getElementById('btnBackList')?.click();
      } else if (action === 'cancel') {
        applyFormEditMode(false);
      }
      return;
    }
    if (!activeTabKey) return;
    if (action === 'edit') {
      toggleGridEdit(activeTabKey, !(tabState[activeTabKey]?.isEdit?.()));
    } else if (action === 'save') {
      saveGridChanges(activeTabKey);
    } else if (action === 'add') {
      addBlankGridRow(activeTabKey);
    } else if (action === 'cancel') {
      cancelGridAdd(activeTabKey);
      toggleGridEdit(activeTabKey, false);
    }
  };

  topEdit?.addEventListener('click', () => triggerTabAction('edit'));
  topSave?.addEventListener('click', () => {
    if (hasGridPendingAdd) {
      triggerTabAction('save');
      hasGridPendingAdd = false;
      setTopEditUI(false);
    } else {
      triggerTabAction('save');
    }
  });
  topAdd?.addEventListener('click', () => triggerTabAction('add'));
  topCancel?.addEventListener('click', () => triggerTabAction('cancel'));
  topConfirm?.addEventListener('click', () => triggerTabAction('save'));
  topQuery?.addEventListener('click', () => document.getElementById('btnBackList')?.click());
  topShowSys?.addEventListener('click', async () => {
    const cid = String(currentCompany || '').trim();
    if (!cid) {
      alert('尚未選取公司代碼');
      return;
    }
    const modalEl = document.getElementById('showSystemModal');
    const modal = modalEl && window.bootstrap ? bootstrap.Modal.getOrCreateInstance(modalEl) : null;
    if (!modalEl || !modal) return;

    const setChecked = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.checked = Number(value || 0) === 1;
    };
    const setVal = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.value = value || '';
    };

    setVal('ssCompanyId', cid);
    setVal('ssShortName', '');
    setVal('ssCompanyName', '');
    ['ssSys1','ssSys2','ssSys3','ssSys4','ssSys5','ssSys6','ssSys7','ssSys8','ssSys9'].forEach(id => setChecked(id, 0));

    try {
      const resp = await fetch(`/api/CCSCompanyAdd/show-system?companyId=${encodeURIComponent(cid)}`);
      const json = await resp.json().catch(() => ({}));
      if (!resp.ok || !json?.success) throw new Error(json?.message || resp.statusText || 'load failed');
      const d = json.data || {};
      setVal('ssCompanyId', d.companyId || d.CompanyId || cid);
      setVal('ssShortName', d.shortName || d.ShortName || '');
      setVal('ssCompanyName', d.companyName || d.CompanyName || '');
      setChecked('ssSys1', d.sys_1 ?? d.Sys_1);
      setChecked('ssSys2', d.sys_2 ?? d.Sys_2);
      setChecked('ssSys3', d.sys_3 ?? d.Sys_3);
      setChecked('ssSys4', d.sys_4 ?? d.Sys_4);
      setChecked('ssSys5', d.sys_5 ?? d.Sys_5);
      setChecked('ssSys6', d.sys_6 ?? d.Sys_6);
      setChecked('ssSys7', d.sys_7 ?? d.Sys_7);
      setChecked('ssSys8', d.sys_8 ?? d.Sys_8);
      setChecked('ssSys9', d.sys_9 ?? d.Sys_9);

      const sys8Row = document.getElementById('ssSys8Row');
      const sys9Row = document.getElementById('ssSys9Row');
      const showSys8 = Number(d.sys_8 ?? d.Sys_8 ?? 0) === 1 || Number('@Model.SystemId') === 8;
      const showSys9 = !!(d.hasSystem9 ?? d.HasSystem9 ?? true);
      sys8Row?.classList.toggle('d-none', !showSys8);
      sys9Row?.classList.toggle('d-none', !showSys9);
    } catch (err) {
      alert('讀取檢視身分失敗：' + err);
    }

    modal.show();
  });
  const navState = { companyIds: null };
  const fetchNavCompanyIds = async () => {
    if (Array.isArray(navState.companyIds) && navState.companyIds.length > 0) return navState.companyIds;
    const sysId = Number('@Model.SystemId');
    const subSysId = Number('@Model.SubSystemId');
    try {
      const rows = await fetch('/api/CommonTable/TopRows?table=AJNdCompanySystem&top=50000')
        .then(r => r.ok ? r.json() : []);
      const list = Array.isArray(rows) ? rows : [];
      const set = new Set();
      list.forEach(r => {
        const sid = Number(r?.SystemId ?? r?.systemId ?? 0);
        const ssid = Number(r?.SubSystemId ?? r?.subSystemId ?? 0);
        const cid = String(r?.CompanyId ?? r?.companyId ?? '').trim();
        if (!cid) return;
        if (sid !== sysId) return;
        if (subSysId > 0 && ssid !== subSysId) return;
        set.add(cid);
      });
      navState.companyIds = Array.from(set).sort((a, b) => a.localeCompare(b));
    } catch {
      navState.companyIds = [];
    }
    return navState.companyIds;
  };
  const gotoCompany = (cid) => {
    if (!cid) return;
    const u = new URL(window.location.href);
    u.searchParams.set('CompanyId', cid);
    u.searchParams.set('systemId', String('@Model.SystemId'));
    window.location.href = u.toString();
  };
  const moveNav = async (mode) => {
    const ids = await fetchNavCompanyIds();
    if (!Array.isArray(ids) || ids.length === 0) return;
    const cur = String(currentCompany || '').trim();
    let idx = ids.findIndex(x => x === cur);
    if (idx < 0) idx = 0;
    if (mode === 'first') idx = 0;
    else if (mode === 'prev') idx = Math.max(0, idx - 1);
    else if (mode === 'next') idx = Math.min(ids.length - 1, idx + 1);
    else if (mode === 'last') idx = ids.length - 1;
    gotoCompany(ids[idx]);
  };
  navFirst?.addEventListener('click', () => moveNav('first'));
  navPrev?.addEventListener('click', () => moveNav('prev'));
  navNext?.addEventListener('click', () => moveNav('next'));
  navLast?.addEventListener('click', () => moveNav('last'));

  const loadAllTabs = () => {
    tabs.forEach(btn => {
      const key = btn.dataset.tabKey || btn.dataset.tab || btn.id?.replace('tab-','').replace('-tab','');
      if (key && currentCompany) loadTabData(key, currentCompany);
    });
  };
  (async () => {
    if (!currentCompany) return;
    await renderForm('master', '@(cfg?.MasterDict ?? cfg?.MasterTable ?? string.Empty)', '@(cfg?.MasterTable ?? string.Empty)', currentCompany, []);
    setFormMode('master', !!formEditMode);
    loadAllTabs();
  })();

  const setDictTarget = (dictName) => {
    if (!dictName) return;
    window._dictTableName = dictName;
  };

  // ??澈??澈???憸脣???
  setDictTarget('@(cfg?.MasterDict ?? cfg?.MasterTable ?? string.Empty)');

  document.addEventListener('click', (ev) => {
    const formArea = ev.target.closest('.mf-container[data-dict-table]');
    if (formArea?.dataset?.dictTable) {
      if (formArea.dataset.formKey) currentFormKey = formArea.dataset.formKey;
      setDictTarget(formArea.dataset.dictTable);
      return;
    }
    const tabBtn = ev.target.closest('button[data-bs-toggle="tab"][data-dict]');
    if (tabBtn?.dataset?.dict) {
      setDictTarget(tabBtn.dataset.dict);
      return;
    }
    const grid = ev.target.closest('table[data-dict-name], table[data-table-name]');
    if (grid) {
      setDictTarget(grid.dataset.dictName || grid.dataset.tableName);
    }
  });
});
</script>
<style>
.ccs-detail-page {
  --top-toolbar-icon-font-size: 16px;
  --top-toolbar-font-size: 14px;
  --top-toolbar-btn-height: 36px;
  --field-border: #cfd7e6;
  --panel-border: #d8e0ee;
  --panel-bg: #edf2fb;
  --tab-bg: #eef3ff;
  --tab-active: #ffffff;
  --tab-active-border: #9fb3d8;
  --label-color: #1d3b6b;
}
.ccs-detail-page .top-toolbar {
  display: flex;
  justify-content: flex-start;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
  width: 100%;
  margin: 4px 0 8px 0;
  border: none;
  border-radius: 0;
  background: transparent;
  padding: 2px 0;
}
.ccs-detail-page .toolbar-icon-row,
.ccs-detail-page .toolbar-main {
  display: flex;
  gap: 4px;
  align-items: center;
  flex-wrap: wrap;
}
.ccs-detail-page .toolbar-main {
  justify-content: flex-start;
  flex-wrap: wrap;
}
.ccs-detail-page .toolbar-btn {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: #fff;
  color: #1d2b4f;
  border: 1px solid var(--field-border);
  border-radius: 10px;
  font-size: calc(var(--top-toolbar-font-size) - 1px);
  font-weight: 500;
  height: var(--top-toolbar-btn-height);
  min-height: var(--top-toolbar-btn-height);
  padding: 0 10px;
  box-shadow: none;
  text-decoration: none;
  transition: background 0.18s, transform 0.11s, border-color 0.18s;
}
.ccs-detail-page .toolbar-btn i {
  font-size: 1.05em;
}
.ccs-detail-page .toolbar-btn:hover,
.ccs-detail-page .toolbar-btn:focus {
  transform: translateY(-1px) scale(1.02);
  color: #1d2b4f;
  background: #f8fbff;
  border-color: #b9c8de;
}
.ccs-detail-page .toolbar-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}
.ccs-detail-page .toolbar-btn-icon {
  justify-content: center;
  width: 30px;
  padding: 0;
  border-radius: 8px;
  font-size: var(--top-toolbar-icon-font-size);
  line-height: 1;
}
.ccs-detail-page .toolbar-btn.primary {
  background: #1e4db7;
  border-color: #1e4db7;
  color: #fff;
}
.ccs-detail-page .toolbar-btn.success {
  border-color: #9fd6b3;
  color: #0e7a3a;
}
.ccs-detail-page .ccs-panel {
  border: none;
  border-radius: 0;
  background: transparent;
  box-shadow: none;
  margin-top: 8px !important;
}
.ccs-detail-page .ccs-tabs {
  margin-top: 6px;
  margin-bottom: 0;
  display: flex !important;
  gap: 2px;
  flex-wrap: nowrap;
  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;
  border: 2px solid var(--tab-active-border);
  border-bottom: none;
  border-radius: 8px 8px 0 0;
  padding: 2px 4px;
  background: var(--tab-bg);
  box-shadow: none;
}
.ccs-detail-page .ccs-tabs .nav-item {
  flex: 0 0 auto;
  display: block !important;
}
.ccs-detail-page .ccs-tabs .nav-link {
  display: inline-flex !important;
  align-items: center;
  height: 24px;
  line-height: 1.15;
  padding: 2px 8px;
  font-size: 0.82rem;
  color: #204a87;
  border: 1px solid transparent;
  border-radius: 6px;
  background: transparent;
}
.ccs-detail-page .ccs-tabs .nav-link.active {
  color: #111827;
  background: var(--tab-active);
  border-color: var(--tab-active-border) var(--tab-active-border) #fff;
  font-weight: 700;
}
.ccs-detail-page .ccs-form {
  border: 2px solid var(--tab-active-border);
  border-top: none;
  border-radius: 0 0 8px 8px;
  background: #fff;
  box-shadow: none;
  padding: 6px 8px 10px 8px;
}
.ccs-detail-page .tab-pane {
  padding: 0;
}
.ccs-detail-page .mf-container {
  min-height: 180px;
  padding: 0;
  border: none;
  border-radius: 0;
  background: transparent;
}
.ccs-detail-page .tab-pane[data-form="1"] > .mf-container {
  border: none;
  border-radius: 0;
  background: transparent;
}
.ccs-detail-page #cc000054-master-form {
  min-height: 190px !important;
  border: 1px solid var(--panel-border);
  border-radius: 8px;
  background: var(--panel-bg);
  box-shadow: none;
  margin-bottom: 8px;
}
.ccs-detail-page .mf-label {
  font-size: 12px !important;
  font-weight: 400 !important;
  color: var(--label-color);
}
.ccs-detail-page .mf-field .mf-view,
.ccs-detail-page .mf-field .mf-edit {
  box-sizing: border-box;
  border-radius: 0 !important;
  font-size: 12px !important;
}
.ccs-detail-page .mf-field .mf-view {
  padding: 0 4px !important;
  border: 1px solid var(--field-border) !important;
  background: #fff !important;
  color: #0f172a;
}
.ccs-detail-page .mf-field .mf-view.mf-lk-view {
  display: grid !important;
  grid-template-columns: minmax(52px, 38%) 1fr;
  gap: 0;
  padding: 0 !important;
}
.ccs-detail-page .mf-lk-view .mf-lk-code,
.ccs-detail-page .mf-lk-view .mf-lk-name {
  display: block;
  min-height: 100%;
  line-height: 18px;
  padding: 0 4px;
  border: none;
}
.ccs-detail-page .mf-lk-view .mf-lk-code {
  border-right: 1px solid var(--field-border);
}
.ccs-detail-page .mf-field .mf-edit.mf-input {
  padding: 0 4px !important;
  border: 1px solid var(--field-border) !important;
  background: #fff !important;
  color: #0f172a !important;
  box-shadow: none !important;
}
.ccs-detail-page .mf-field .mf-lk-edit-name {
  padding: 0 4px !important;
  border: 1px solid var(--field-border) !important;
  border-left: none !important;
  border-radius: 0 !important;
  font-size: 12px !important;
  background: #f8faff !important;
  color: #0f172a !important;
  box-shadow: none !important;
}
.ccs-detail-page .mf-field .mf-edit.mf-input:focus {
  border-color: #5b8def !important;
  box-shadow: 0 0 0 2px rgba(91, 141, 239, 0.15) !important;
}
.ccs-detail-page .tab-local-controls {
  display: none !important;
}
.ccs-detail-page .table-responsive {
  border: none;
  border-radius: 0;
  background: transparent;
  padding: 0;
}
.ccs-detail-page .table tbody td {
  border-color: var(--field-border) !important;
}
.ccs-detail-page .table {
  border: 1px solid var(--field-border);
  border-radius: 0 !important;
  margin-bottom: 0;
}
.ccs-detail-page .table thead th {
  background: #f2f6ff;
  color: #204a87;
  border-color: var(--field-border) !important;
}
body.ccs-editing .ccs-detail-page .ccs-tabs .nav-link.active {
  background: #1e4db7;
  color: #fff;
  border-color: #1e4db7;
}
body.ccs-editing .ccs-detail-page .mf-container[data-editing="1"] .mf-edit:not([readonly]):not([disabled]),
body.ccs-editing .ccs-detail-page .mf-container[data-editing="1"] .mf-lk-edit-name:not([readonly]):not([disabled]) {
  background: #fff7cc !important;
  border-color: #f59e0b !important;
}
.ss-check-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 4px;
  padding: 4px 0;
}
.ss-check-grid label {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0;
  font-size: 14px;
}
</style>

<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>
