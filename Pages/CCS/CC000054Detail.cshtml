@page "/CCS/{itemId}/Detail"
@model PcbErpApi.Pages.CCS.CC000054DetailModel
@using System.Text.Json
@{
    Layout = "_Layout";
    var cfg = Model.Config;
    var firstKey = Model.MasterKeyValues.FirstOrDefault(kv => string.Equals(kv.Key, "CompanyId", StringComparison.OrdinalIgnoreCase));
    var masterKeyVal = firstKey.Value ?? Model.MasterKeyValues.FirstOrDefault().Value ?? "";
    if (string.IsNullOrWhiteSpace(masterKeyVal))
    {
        masterKeyVal = Request.Query["CompanyId"].FirstOrDefault()
            ?? Request.Query["companyId"].FirstOrDefault()
            ?? Request.Query["CompanyyId"].FirstOrDefault()
            ?? "";
    }
}

@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", null, ViewData)
<script src="~/js/editableGrid.js"></script>
<div class="modal fade" id="cc000054DetailAddModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">新增</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body ccs-add-modal-body">
        <div class="ccs-add-row">
          <label class="ccs-add-label" id="detailAddCodeLabel">客戶編號</label>
          <div class="ccs-add-inline">
            <input type="text" class="form-control form-control-sm ccs-add-code-select" id="detailAddCompanyId" autocomplete="off">
            <input type="text" class="form-control form-control-sm ccs-add-short" id="detailAddShortName" readonly>
          </div>
        </div>
        <div class="ccs-add-row">
          <label class="ccs-add-label">簡稱</label>
          <input type="text" class="form-control form-control-sm" id="detailAddCompanyName">
        </div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-light btn-sm border" id="btnDetailAddConfirm">確定</button>
        <button type="button" class="btn btn-light btn-sm border" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="cc000054DetailQueryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">客戶廠商資料查詢</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body ccs-query-modal-body">
        <div class="ccs-query-grid">
          <label class="ccs-query-label" id="dqLblSubClass">客戶分類</label>
          <select class="form-select form-select-sm" id="dqSubClass"></select>

          <label class="ccs-query-label" id="dqLblCompanyLike">客戶編號(模糊查詢)</label>
          <input type="text" class="form-control form-control-sm" id="dqCompanyLike">

          <label class="ccs-query-label" id="dqLblCompanyStart">客戶編號起</label>
          <input type="text" class="form-control form-control-sm" id="dqCompanyStart" list="dqCompanyList">

          <label class="ccs-query-label" id="dqLblCompanyEnd">客戶編號迄</label>
          <input type="text" class="form-control form-control-sm" id="dqCompanyEnd" list="dqCompanyList">

          <label class="ccs-query-label" id="dqLblShortName">客戶簡稱</label>
          <input type="text" class="form-control form-control-sm" id="dqShortName">

          <label class="ccs-query-label">電話</label>
          <div class="ccs-query-inline3">
            <select class="form-select form-select-sm" id="dqPhoneCond">
              <option value="0">開頭以</option>
              <option value="1">包含</option>
            </select>
            <input type="text" class="form-control form-control-sm" id="dqPhone">
          </div>

          <label class="ccs-query-label">傳真</label>
          <div class="ccs-query-inline3">
            <select class="form-select form-select-sm" id="dqFaxCond">
              <option value="0">開頭以</option>
              <option value="1">包含</option>
            </select>
            <input type="text" class="form-control form-control-sm" id="dqFax">
          </div>

          <label class="ccs-query-label" id="dqLblUniFormId">統一編號(模糊查詢)</label>
          <input type="text" class="form-control form-control-sm" id="dqUniFormId">

          <label class="ccs-query-label" id="dqLblName">客戶名稱(模糊查詢)</label>
          <input type="text" class="form-control form-control-sm" id="dqCompanyName">

          <label class="ccs-query-label" id="dqLblAddr">客戶地址(模糊查詢)</label>
          <input type="text" class="form-control form-control-sm" id="dqCompanyAddr">

          <label class="ccs-query-label">營業項目(模糊查詢)</label>
          <input type="text" class="form-control form-control-sm" id="dqBnsItem">

          <label class="ccs-query-label" id="dqLblSales">業務員</label>
          <select class="form-select form-select-sm" id="dqSalesId"></select>
        </div>
        <datalist id="dqCompanyList"></datalist>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-light btn-sm border" id="btnDetailQuerySearch">查詢</button>
        <button type="button" class="btn btn-light btn-sm border" id="btnDetailQueryClear">清除</button>
        <button type="button" class="btn btn-light btn-sm border" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

@if (cfg == null)
{
    <div class="alert alert-warning mt-3">初始化客戶主檔畫面失敗，請稍後再試。</div>
}
else
{
    <div class="table-wrapper ccs-detail-wrapper">
    <div class="card shadow-sm border-0">
    <div class="card-body">
    <div class="ccs-detail-page" data-item-id="@Model.ItemId">
    <div class="top-toolbar singlegrid-toolbar">
        <div class="toolbar-icon-row">
            <button id="btnNavFirst" type="button" class="btn toolbar-btn toolbar-btn-icon" title="第一筆" aria-label="第一筆">
                <i class="bi bi-chevron-bar-left toolbar-icon"></i>
            </button>
            <button id="btnNavPrev" type="button" class="btn toolbar-btn toolbar-btn-icon" title="上一筆" aria-label="上一筆">
                <i class="bi bi-chevron-left toolbar-icon"></i>
            </button>
            <button id="btnNavNext" type="button" class="btn toolbar-btn toolbar-btn-icon" title="下一筆" aria-label="下一筆">
                <i class="bi bi-chevron-right toolbar-icon"></i>
            </button>
            <button id="btnNavLast" type="button" class="btn toolbar-btn toolbar-btn-icon" title="最後一筆" aria-label="最後一筆">
                <i class="bi bi-chevron-bar-right toolbar-icon"></i>
            </button>
        </div>
        <div class="toolbar-main">
            <div class="d-flex gap-2 flex-wrap align-items-center">
                <div id="detailCountBox" class="toolbar-count-box mode-view">
                    <div id="detailModeText" class="count-line">瀏覽模式</div>
                    <div id="detailCountText" class="count-line">0 / 0</div>
                </div>
                <a class="btn toolbar-btn" id="btnBackList" href="@Url.Page("CC000054", new { itemId = Model.ItemId, systemId = Model.SystemId })"><i class="bi bi-arrow-return-left"></i>回列表</a>
                <button type="button" class="btn toolbar-btn" id="btnTopQuery"><i class="bi bi-search"></i>查詢</button>
                <button type="button" class="btn toolbar-btn" id="btnTopShowSys"><i class="bi bi-person-badge"></i>檢視身分</button>
                <button type="button" class="btn toolbar-btn" id="btnTopAdd"><i class="bi bi-plus-lg"></i>新增</button>
                <button type="button" class="btn toolbar-btn" id="btnTopDelete"><i class="bi bi-trash3"></i>刪除</button>
                <button type="button" class="btn toolbar-btn" id="btnTopEdit"><i class="bi bi-pencil-square"></i>修改</button>
                <button type="button" class="btn toolbar-btn" id="btnTopLog"><i class="bi bi-clock-history"></i>記錄</button>
                <button type="button" class="btn toolbar-btn" id="btnTopReject"><i class="bi bi-arrow-counterclockwise"></i>撤除</button>
                <button type="button" class="btn toolbar-btn d-none" id="btnTopSave"><i class="bi bi-bookmark-check"></i>保留</button>
            </div>
        </div>
    </div>

    <div id="cc000054-master-form"
         class="position-relative mf-container"
         data-dict="@cfg?.MasterDict"
         data-dict-table="@cfg?.MasterDict"
         style="min-height:190px;"></div>

    <div class="ccs-panel">
        <div class="p-1">
            <ul class="nav nav-tabs ccs-tabs matinfo-tabs" role="tablist">
                @for (int i = 0; i < Model.ExtraTabs.Count; i++)
                {
                    var tab = Model.ExtraTabs[i];
                    var active = i == 0 ? "active" : "";
                    <li class="nav-item" role="presentation">
                        <button class="nav-link @active"
                                id="tab-@tab.Key-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#tab-@tab.Key"
                                type="button"
                                role="tab"
                                aria-controls="tab-@tab.Key"
                                aria-selected="@(i == 0 ? "true" : "false")"
                                data-table="@tab.TableName"
                                data-dict="@tab.DictName"
                                title="@tab.TableName"
                                data-keyfields="@string.Join(",", tab.KeyFields ?? Enumerable.Empty<string>())"
                                data-extra-keys="@string.Join(";", tab.ExtraKeys?.Select(k => $"{k.Key}={k.Value}") ?? Array.Empty<string>())">
                            @tab.Title
                        </button>
                    </li>
                }
            </ul>
            <div class="tab-content ccs-form">
                @for (int i = 0; i < Model.ExtraTabs.Count; i++)
                {
                    var tab = Model.ExtraTabs[i];
                    var active = i == 0 ? "show active" : "";
                    <div class="tab-pane fade @active" id="tab-@tab.Key" role="tabpanel" aria-labelledby="tab-@tab.Key-tab" data-form="@((tab.IsForm ? "1" : "0"))">
                        @if (tab.IsForm)
                        {
                            
                          <div id="form-@tab.Key"
                                class="position-relative mf-container"
                                data-dict="@tab.DictName"
                                data-dict-table="@tab.DictName"
                                style="min-height:170px;"></div>
                           
                        }
                        else
                        {
                            <div class="ccs-subgrid-box">
                                <div class="tab-icon-toolbar d-none" data-tab-icon-toolbar="@tab.Key">
                                    <button type="button" class="btn btn-outline-secondary btn-icon ccs-tool-add" data-tab-tool="add" data-tab="@tab.Key" title="新增" aria-label="新增"><i class="bi bi-plus-lg"></i></button>
                                    <button type="button" class="btn btn-outline-secondary btn-icon ccs-tool-del" data-tab-tool="delete" data-tab="@tab.Key" title="刪除" aria-label="刪除"><i class="bi bi-dash-lg"></i></button>
                                    <button type="button" class="btn btn-outline-secondary btn-icon ccs-tool-save" data-tab-tool="save" data-tab="@tab.Key" title="儲存" aria-label="儲存"><i class="bi bi-check-lg"></i></button>
                                    <button type="button" class="btn btn-outline-secondary btn-icon ccs-tool-cancel" data-tab-tool="cancel" data-tab="@tab.Key" title="取消" aria-label="取消"><i class="bi bi-x-lg"></i></button>
                                    <button type="button" class="btn btn-outline-secondary btn-icon ccs-tool-refresh" data-tab-tool="edit" data-tab="@tab.Key" title="重新整理" aria-label="重新整理"><i class="bi bi-arrow-clockwise"></i></button>
                                    @if (string.Equals(tab.Key, "attach", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button type="button" class="btn btn-outline-secondary btn-sm ccs-tool-text" data-tab-tool="setpath" data-tab="@tab.Key">指定路徑及檔名</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm ccs-tool-text" data-tab-tool="preview" data-tab="@tab.Key">檢視檔案</button>
                                    }
                                </div>
                                <div class="table-responsive ccs-subgrid-wrap" data-tab-key="@tab.Key">
                                    <table class="table table-sm table-hover align-middle mb-0 ccs-subgrid-table"
                                           id="grid-@tab.Key"
                                           data-table-name="@tab.TableName"
                                           data-dict-name="@tab.DictName"
                                           data-dict-table="@tab.DictName"
                                           data-key-fields="@string.Join(",", tab.KeyFields ?? Enumerable.Empty<string>())">
                                        <thead class="table-light">
                                            <tr><th class="text-center text-muted">載入中...</th></tr>
                                        </thead>
                                        <tbody>
                                            <tr><td class="text-center text-muted py-3">請點選上方主檔資料</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="mt-2 d-flex gap-2 tab-local-controls d-none">
                                <button type="button" class="btn btn-outline-primary btn-sm" data-btn="edit" data-tab="@tab.Key">編輯</button>
                                <button type="button" class="btn btn-success btn-sm d-none" data-btn="save" data-tab="@tab.Key">儲存</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" data-btn="add" data-tab="@tab.Key">新增</button>
                                <button type="button" class="btn btn-outline-success btn-sm d-none" data-btn="confirm" data-tab="@tab.Key">確定</button>
                                <button type="button" class="btn btn-outline-danger btn-sm d-none" data-btn="cancel" data-tab="@tab.Key">取消</button>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
    </div>
    </div>
    </div>
    </div>

    <div class="modal fade" id="showSystemModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">檢視身分</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row g-2 mb-2">
              <div class="col-12">
                <label class="form-label mb-1">公司代碼</label>
                <input id="ssCompanyId" class="form-control form-control-sm" readonly />
              </div>
              <div class="col-12">
                <label class="form-label mb-1">簡稱</label>
                <input id="ssShortName" class="form-control form-control-sm" readonly />
              </div>
              <div class="col-12">
                <label class="form-label mb-1">公司名稱</label>
                <input id="ssCompanyName" class="form-control form-control-sm" readonly />
              </div>
            </div>
            <div class="ss-check-grid">
              <label><input type="checkbox" id="ssSys1" disabled /> 銷售客戶</label>
              <label><input type="checkbox" id="ssSys2" disabled /> 供應商</label>
              <label><input type="checkbox" id="ssSys3" disabled /> 製程委外廠商</label>
              <label><input type="checkbox" id="ssSys4" disabled /> 製令委外廠商</label>
              <label><input type="checkbox" id="ssSys5" disabled /> 進出口廠商</label>
              <label><input type="checkbox" id="ssSys6" disabled /> 其他廠商</label>
              <label><input type="checkbox" id="ssSys7" disabled /> 經銷商</label>
              <label id="ssSys8Row" class="d-none"><input type="checkbox" id="ssSys8" disabled /> 廢棄物廠商</label>
              <label id="ssSys9Row"><input type="checkbox" id="ssSys9" disabled /> 未成交客戶</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">確定</button>
          </div>
        </div>
      </div>
    </div>
}

<script>
// Render field value in view mode.
function makeValueElement(field, rawVal) {
  const isCheckbox = Number(field?.ComboStyle ?? 0) === 1;
  if (isCheckbox) {
    const wrap = document.createElement('div');
    wrap.className = 'form-check m-0 d-inline-flex align-items-center';
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.className = 'form-check-input';
    chk.disabled = true;
    const val = rawVal == null ? '' : String(rawVal).toLowerCase();
    chk.checked = val === '1' || val === 'true' || val === 'y';
    wrap.appendChild(chk);
    return wrap;
  }
  const span = document.createElement('span');
  span.textContent = rawVal == null ? '' : rawVal;
  span.style.display = 'block';
  span.style.border = '1px solid #e5e7eb';
  span.style.background = '#f8fafc';
  span.style.padding = '1px 5px';
  span.style.borderRadius = '4px';
  span.style.minHeight = '14px';
  return span;
}

// ?梁嚗?鞈?颲剖摨扳?頧?銝??雿捆?函敶ｇ?銝餅??????堆?
function getLayoutRect(f) {
  const topPad = 6;
  const fieldGapX = 10;
  const n = (v, d = 0) => {
    const x = Number(v);
    return Number.isFinite(x) ? x : d;
  };

  const fTop = n(f.iFieldTop, 0) + topPad;
  const fLeft = n(f.iFieldLeft, 0);
  const rawFWidth = n(f.iFieldWidth, 0);
  const rawFHeight = n(f.iFieldHeight, 0);
  const fWidth = rawFWidth > 0 ? rawFWidth : 160;
  const fHeight = rawFHeight > 0 ? rawFHeight : 22;

  const hasLabel = !!String(f?.DisplayLabel ?? '').trim();
  const lTop = hasLabel ? (n(f.iLabTop, n(f.iFieldTop, 0)) + topPad) : fTop;
  const lLeft = hasLabel ? n(f.iLabLeft, 0) : fLeft;
  const rawLWidth = n(f.iLabWidth, 0);
  const rawLHeight = n(f.iLabHeight, 0);
  const lWidth = hasLabel ? (rawLWidth > 0 ? rawLWidth : 90) : 0;
  const lHeight = hasLabel ? (rawLHeight > 0 ? rawLHeight : fHeight) : 0;

  // Use field rect as the primary anchor; labels are rendered with relative offsets.
  // This matches dictionary coordinates more closely and avoids oversized field wrappers.
  const boxTop = fTop;
  const boxLeft = fLeft;
  const boxRight = fLeft + fWidth;
  const boxBottom = fTop + fHeight;

  const adjustedFieldLeft = hasLabel ? fieldGapX : 0;
  const adjustedFieldWidth = Math.max(40, fWidth - adjustedFieldLeft);

  return {
    boxTop,
    boxLeft,
    boxWidth: Math.max(8, boxRight - boxLeft),
    boxHeight: Math.max(8, boxBottom - boxTop),
    labTop: lTop - boxTop,
    labLeft: lLeft - boxLeft,
    labWidth: lWidth,
    labHeight: lHeight,
    fieldTop: fTop - boxTop,
    fieldLeft: (fLeft - boxLeft) + adjustedFieldLeft,
    fieldWidth: adjustedFieldWidth,
    fieldHeight: fHeight
  };
}
</script>

<script>
function getShowWhereValue(field) {
  const raw = field?.iShowWhere ?? field?.IShowWhere ?? field?.ishowWhere ?? field?.ISHOWWHERE ?? 1;
  const n = Number(raw);
  return Number.isFinite(n) ? n : 1;
}

function filterVisibleFields(dictArr, showWhere = 1) {
  const list = (Array.isArray(dictArr) ? dictArr : [])
    .filter(f => (f.Visible ?? 1) == 1)
    .filter(f => getShowWhereValue(f) === showWhere)
    .filter(f => {
      const nums = [f?.iFieldTop, f?.iFieldLeft, f?.iLabTop, f?.iLabLeft]
        .map(v => Number(v))
        .filter(v => Number.isFinite(v));
      if (nums.length === 0) return true;
      return nums.some(v => v > 0);
    })
    .sort((a,b) => (a.SerialNum ?? 9999) - (b.SerialNum ?? 9999));

  // Some dictionaries include duplicated layout rows for the same field
  // (e.g., copied panel/page design). Keep one entry per field name.
  const seen = new Map();
  for (const f of list) {
    const key = String(f?.FieldName || '').trim().toLowerCase();
    if (!key) continue;
    if (!seen.has(key)) {
      seen.set(key, f);
      continue;
    }
    const cur = seen.get(key);
    const curScore = (Number(cur?.iFieldTop) || 0) + (Number(cur?.iFieldLeft) || 0) + ((Number(cur?.SerialNum) || 0) / 1000);
    const nextScore = (Number(f?.iFieldTop) || 0) + (Number(f?.iFieldLeft) || 0) + ((Number(f?.SerialNum) || 0) / 1000);
    if (nextScore < curScore) seen.set(key, f);
  }
  return Array.from(seen.values()).sort((a,b) => (a.SerialNum ?? 9999) - (b.SerialNum ?? 9999));
}

const __lookupCache = new Map();
const __formRenderToken = Object.create(null);

function getLookupMeta(field) {
  const table = (field?.LookupTable || '').trim();
  const keyFieldRaw = (field?.LookupKeyField || '').trim();
  const result = (field?.LookupResultField || '').trim();
  if (!table || !result) return null;
  const parts = result.split(',').map(x => x.trim()).filter(Boolean);
  const keyField = keyFieldRaw || parts[0] || '';
  const nameField = parts.length >= 2 ? parts[1] : (parts[0] || '');
  if (!keyField || !nameField) return null;
  return {
    table,
    keyField,
    nameField
  };
}

function pickRowValueCI(row, fieldName) {
  if (!row || !fieldName) return '';
  const exact = row[fieldName];
  if (exact != null) return exact;
  const key = String(fieldName).toLowerCase();
  const hit = Object.keys(row).find(k => String(k).toLowerCase() === key);
  return hit ? row[hit] : '';
}

async function getLookupRows(table) {
  const key = (table || '').toLowerCase();
  if (!key) return [];
  if (__lookupCache.has(key)) return __lookupCache.get(key);
  try {
    const url = `/api/CommonTable/TopRows?table=${encodeURIComponent(table)}&top=5000`;
    const rows = await fetch(url).then(r => r.ok ? r.json() : []);
    const arr = Array.isArray(rows) ? rows : [];
    __lookupCache.set(key, arr);
    return arr;
  } catch {
    __lookupCache.set(key, []);
    return [];
  }
}

async function resolveLookupName(field, codeVal) {
  const meta = getLookupMeta(field);
  const code = codeVal == null ? '' : String(codeVal).trim();
  if (!meta || !code) return '';
  const rows = await getLookupRows(meta.table);
  const hit = rows.find(r => String(pickRowValueCI(r, meta.keyField) ?? '').trim() === code);
  return String(pickRowValueCI(hit, meta.nameField) ?? '').trim();
}

async function normalizeLookupCodeName(field, rawVal) {
  const meta = getLookupMeta(field);
  let code = rawVal == null ? '' : String(rawVal).trim();
  if (!meta || !code) return { code, name: '' };

  const rows = await getLookupRows(meta.table);
  const findByCode = (c) => rows.find(r => String(pickRowValueCI(r, meta.keyField) ?? '').trim() === c);

  let hit = findByCode(code);
  if (hit) return { code, name: String(pickRowValueCI(hit, meta.nameField) ?? '').trim() };

  const firstToken = code.split(/\s+/).filter(Boolean)[0] || '';
  if (firstToken && firstToken !== code) {
    hit = findByCode(firstToken);
    if (hit) return { code: firstToken, name: String(pickRowValueCI(hit, meta.nameField) ?? '').trim() };
    return { code: firstToken, name: code.slice(firstToken.length).trim() };
  }

  return { code, name: '' };
}

function makeLookupValueElement(code, name) {
  const wrap = document.createElement('div');
  wrap.className = 'mf-lk-view';

  const left = document.createElement('span');
  left.className = 'mf-lk-code';
  left.textContent = code == null ? '' : String(code);

  const right = document.createElement('span');
  right.className = 'mf-lk-name';
  right.textContent = name == null ? '' : String(name);

  wrap.append(left, right);
  return wrap;
}

function getLookupCodeWidth(fieldWidth) {
  const w = Number(fieldWidth) || 0;
  return Math.max(52, Math.min(96, Math.floor(w * 0.36)));
}

const __layoutEditEnabled = (() => {
  try {
    const q = new URLSearchParams(window.location.search || '');
    return q.get('layoutEdit') === '1';
  } catch {
    return false;
  }
})();
</script>

<script>
// Enable form layout drag/resize save only when layoutEdit=1.
function enableFormLayoutEditing(container, dictName) {
  if (!__layoutEditEnabled) return;
  if (!container || !dictName) return;
  const tableName = (dictName || '').trim().toLowerCase();
  const fields = Array.from(container.querySelectorAll('.mf-field'));
  const saveUrl = "/api/TableFieldLayout/SaveHeaderLayout";
  let dragTarget = null, startX = 0, startY = 0, startLeft = 0, startTop = 0;
  let resizeTarget = null, startW = 0, startH = 0;
  let dragGroup = [];
  let groupStart = new Map();
  let saveTimer = null;

  const debounceSave = () => {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      const layout = fields.map(f => ({
        fieldName: f.dataset.field || '',
        top: Math.round(f.offsetTop),
        left: Math.round(f.offsetLeft),
        width: Math.round(f.offsetWidth),
        height: Math.round(f.offsetHeight),
        ishowWhere: 1
      })).filter(x => x.fieldName);
      if (!layout.length || !tableName) return;
      fetch(saveUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tableName, layoutUpdates: layout })
      }).catch(()=>{});
    }, 300);
  };

  // multi-select
  const selected = new Set();
  const clearSelection = () => {
    selected.forEach(el => el.classList.remove('mf-selected'));
    selected.clear();
  };
  const selectField = (el, additive) => {
    if (!additive) clearSelection();
    if (selected.has(el)) {
      if (additive) {
        selected.delete(el);
        el.classList.remove('mf-selected');
      }
    } else {
      selected.add(el);
      el.classList.add('mf-selected');
    }
  };

  container.addEventListener('pointerdown', (e) => {
    if (e.target === container) clearSelection();
    if (container.dataset.formKey) currentFormKey = container.dataset.formKey;
  });

  fields.forEach(f => {
    const label = f.querySelector('label');
    const resizer = f.querySelector('.mf-resizer');
    f.style.cursor = 'move';
    f.style.userSelect = 'none';

    f.addEventListener('click', (e) => {
      e.stopPropagation();
      selectField(f, e.ctrlKey || e.metaKey);
      if (container.dataset.formKey) currentFormKey = container.dataset.formKey;
    });

    if (label) {
      label.addEventListener('mousedown', (e) => {
        if (container.dataset.editing === '1') return;
        e.preventDefault();
        dragTarget = f;
        startX = e.clientX;
        startY = e.clientY;
        const isMulti = selected.size > 0 && selected.has(f);
        dragGroup = isMulti ? Array.from(selected) : [f];
        groupStart = new Map(dragGroup.map(el => [el, { l: el.offsetLeft, t: el.offsetTop }]));
        startLeft = f.offsetLeft;
        startTop = f.offsetTop;
        document.body.classList.add('resizing');
      });
    }

    if (resizer) {
      resizer.addEventListener('mousedown', (e) => {
        if (container.dataset.editing === '1') return;
        e.preventDefault();
        e.stopPropagation();
        resizeTarget = f;
        startX = e.clientX;
        startY = e.clientY;
        startW = f.offsetWidth;
        startH = f.offsetHeight;
        document.body.classList.add('resizing');
      });
    }
  });

  document.addEventListener('mousemove', (e) => {
    if (dragTarget) {
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      dragGroup.forEach(el => {
        const pos = groupStart.get(el) || { l: el.offsetLeft, t: el.offsetTop };
        el.style.left = `${Math.max(0, pos.l + dx)}px`;
        el.style.top = `${Math.max(0, pos.t + dy)}px`;
      });
    }
    if (resizeTarget) {
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      resizeTarget.style.width = `${Math.max(50, startW + dx)}px`;
      resizeTarget.style.height = `${Math.max(30, startH + dy)}px`;
    }
  });

  document.addEventListener('mouseup', () => {
    if (dragTarget || resizeTarget) {
      document.body.classList.remove('resizing');
      debounceSave();
    }
    dragTarget = null;
    resizeTarget = null;
  });
}
</script>

<script>
  const formState = {}; // { [tabKey]: { tableName, dictName, extras, keyFields, editable } }
  let currentFormKey = 'master';
  let formEditMode = false;

  document.addEventListener('DOMContentLoaded', () => {
  const tabs = Array.from(document.querySelectorAll('[data-table][data-dict]'));
  window._ccsDetailTabTables = tabs.map(btn => ({
    tabKey: btn.dataset.tabKey || btn.dataset.tab || (btn.id || '').replace('tab-','').replace('-tab',''),
    title: (btn.textContent || '').trim(),
    table: btn.dataset.table || '',
    dict: btn.dataset.dict || ''
  }));
  let currentCompany = '@masterKeyVal' || null;
  if (!currentCompany) {
    const q = new URLSearchParams(window.location.search || '');
    currentCompany = q.get('CompanyId') || q.get('companyId') || q.get('CompanyyId') || null;
  }
  const tabState = {};
  const tabMeta = {}; // grid metadata
  const iconToolbarTabs = new Set(['assistant', 'outaddr', 'bank', 'bankcredit', 'creditline', 'bankassure', 'forwarder', 'quota', 'xout', 'attach']);
  let hasGridPendingAdd = false;
  const detailBaseUrl = '@Url.Page("CC000054Detail", new { itemId = Model.ItemId, systemId = Model.SystemId })';
  const detailSystemId = Number('@Model.SystemId');

  const initDetailAddDialog = () => {
    const modalEl = document.getElementById('cc000054DetailAddModal');
    const modal = modalEl && window.bootstrap ? bootstrap.Modal.getOrCreateInstance(modalEl) : null;
    const addCodeLabel = document.getElementById('detailAddCodeLabel');
    const addCompanyId = document.getElementById('detailAddCompanyId');
    const addCompanyName = document.getElementById('detailAddCompanyName');
    const addShortName = document.getElementById('detailAddShortName');
    const btnConfirm = document.getElementById('btnDetailAddConfirm');
    if (!modal || !addCompanyId || !addCompanyName || !addShortName || !btnConfirm) return;

    let emptyShortName = '0';
    let initLoaded = false;

    const renderCodeLabel = () => {
      if (addCodeLabel) addCodeLabel.textContent = detailSystemId === 1 ? '客戶編號' : '廠商編號';
    };
    const reset = () => {
      addCompanyId.value = '';
      addCompanyName.value = '';
      addShortName.value = '';
    };
    const loadInit = async () => {
      const q = new URLSearchParams();
      q.set('itemId', ('@Model.ItemId' || 'CC000054').toString());
      q.set('systemId', String(detailSystemId || 1));
      const resp = await fetch(`/api/CCSCompanyAdd/init?${q.toString()}`);
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data?.success) throw new Error(data?.message || resp.statusText || 'init failed');
      emptyShortName = String(data.emptyShortName ?? '0');
      initLoaded = true;
    };
    const syncShortName = async () => {
      const cid = (addCompanyId.value || '').trim();
      if (!cid) { addShortName.value = ''; return; }
      const resp = await fetch(`/api/CCSCompanyAdd/company?companyId=${encodeURIComponent(cid)}`);
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data?.success) {
        addShortName.value = '';
        throw new Error(data?.message || resp.statusText || 'load company failed');
      }
      addShortName.value = String(data.shortName || '');
      if (emptyShortName !== '1' && !addCompanyName.value.trim()) addCompanyName.value = addShortName.value.trim();
    };
    const addCompany = async (companyId, companyName, overwrite, allowOtherSubSystem) => {
      const body = {
        itemId: ('@Model.ItemId' || 'CC000054').toString(),
        systemId: detailSystemId || 1,
        companyId,
        companyName,
        overwrite,
        allowOtherSubSystem
      };
      const resp = await fetch('/api/CCSCompanyAdd/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data?.message || resp.statusText || 'add failed');
      return data;
    };

    window.openCcsDetailAddDialog = async () => {
      try {
        renderCodeLabel();
        if (!initLoaded) await loadInit();
        reset();
        modal.show();
        addCompanyId.focus();
      } catch (err) {
        alert('讀取新增清單失敗：' + err);
      }
    };

    addCompanyId.addEventListener('change', () => syncShortName().catch(err => alert('讀取客廠簡稱失敗：' + err)));
    addCompanyId.addEventListener('blur', () => syncShortName().catch(() => { }));

    btnConfirm.addEventListener('click', async () => {
      const cid = (addCompanyId.value || '').trim();
      const cname = (addCompanyName.value || '').trim();
      if (!cid || !cname) { alert('客戶/廠商編號與簡稱不可空白'); return; }
      try {
        const warnResp = await fetch(`/api/CCSCompanyAdd/check-shortname?shortName=${encodeURIComponent(cname)}`);
        const warnData = await warnResp.json().catch(() => ({}));
        if (warnResp.ok && warnData?.success && !!warnData.exists) {
          alert('提示：系統內已有此簡稱的客廠資料。');
        }
      } catch { }
      let overwrite = false;
      let allowOther = false;
      try {
        while (true) {
          const result = await addCompany(cid, cname, overwrite, allowOther);
          if (result?.success) {
            modal.hide();
            const sysId = result.systemId || detailSystemId || 1;
            const u = new URL(detailBaseUrl, window.location.origin);
            u.searchParams.set('CompanyId', cid);
            u.searchParams.set('systemId', String(sysId));
            window.location.href = u.toString();
            return;
          }
          if (result?.needOverwriteConfirm && !overwrite) {
            if (!confirm('查詢到有舊資料,是否覆蓋客戶舊資料?')) return;
            overwrite = true;
            continue;
          }
          if (result?.needOtherSubSystemConfirm && !allowOther) {
            if (!confirm('此代碼已存在其他分類中，確定要新增?')) return;
            allowOther = true;
            continue;
          }
          if ((result?.code || '') === 'DUPLICATE_CODE') { alert('代碼重複!!'); return; }
          alert((result?.message || '新增失敗').toString());
          return;
        }
      } catch (err) {
        alert('新增失敗：' + err);
      }
    });
  };
  const initDetailQueryDialog = () => {
    const modalEl = document.getElementById('cc000054DetailQueryModal');
    const modal = modalEl && window.bootstrap ? bootstrap.Modal.getOrCreateInstance(modalEl) : null;
    const qCompanyList = document.getElementById('dqCompanyList');
    const qSubClass = document.getElementById('dqSubClass');
    const qSalesId = document.getElementById('dqSalesId');
    const qPhoneCond = document.getElementById('dqPhoneCond');
    const qFaxCond = document.getElementById('dqFaxCond');
    const btnSearch = document.getElementById('btnDetailQuerySearch');
    const btnClear = document.getElementById('btnDetailQueryClear');
    if (!modal || !btnSearch || !btnClear) return;

    let loaded = false;
    let queryInitPromise = null;
    let showSales = true;
    let systemId = detailSystemId || 1;
    const labels = {
      companyLike: document.getElementById('dqLblCompanyLike'),
      companyStart: document.getElementById('dqLblCompanyStart'),
      companyEnd: document.getElementById('dqLblCompanyEnd'),
      shortName: document.getElementById('dqLblShortName'),
      uniFormId: document.getElementById('dqLblUniFormId'),
      name: document.getElementById('dqLblName'),
      addr: document.getElementById('dqLblAddr'),
      subClass: document.getElementById('dqLblSubClass'),
      sales: document.getElementById('dqLblSales')
    };
    const setVendorLabels = () => {
      if (labels.companyLike) labels.companyLike.textContent = '廠商編號(模糊查詢)';
      if (labels.companyStart) labels.companyStart.textContent = '廠商編號起';
      if (labels.companyEnd) labels.companyEnd.textContent = '廠商編號迄';
      if (labels.shortName) labels.shortName.textContent = '廠商簡稱';
      if (labels.name) labels.name.textContent = '廠商名稱(模糊查詢)';
      if (labels.addr) labels.addr.textContent = '廠商地址(模糊查詢)';
      if (labels.subClass) labels.subClass.textContent = '廠商分類';
    };
    const toggleSalesRow = (visible) => {
      const salesLabel = labels.sales;
      const salesInput = document.getElementById('dqSalesId');
      if (!salesLabel || !salesInput) return;
      salesLabel.classList.toggle('d-none', !visible);
      salesInput.classList.toggle('d-none', !visible);
    };
    const getInput = (id) => document.getElementById(id);
    const clearForm = () => {
      ['dqCompanyLike','dqCompanyStart','dqCompanyEnd','dqShortName','dqPhone','dqFax','dqUniFormId','dqCompanyName','dqCompanyAddr','dqBnsItem']
        .forEach(id => { const el = getInput(id); if (el) el.value = ''; });
      if (qPhoneCond) qPhoneCond.value = '0';
      if (qFaxCond) qFaxCond.value = '0';
      if (qSubClass) qSubClass.value = '';
      if (qSalesId) qSalesId.value = '';
    };
    const applyQueryToModal = () => {
      const qs = new URLSearchParams(window.location.search || '');
      const map = [
        ['dqCompanyLike', 'cs_companyLike'],
        ['dqCompanyStart', 'cs_companyStart'],
        ['dqCompanyEnd', 'cs_companyEnd'],
        ['dqShortName', 'cs_shortName'],
        ['dqPhoneCond', 'cs_phoneCond'],
        ['dqPhone', 'cs_phone'],
        ['dqFaxCond', 'cs_faxCond'],
        ['dqFax', 'cs_fax'],
        ['dqUniFormId', 'cs_uniFormId'],
        ['dqCompanyName', 'cs_companyName'],
        ['dqCompanyAddr', 'cs_companyAddr'],
        ['dqBnsItem', 'cs_bnsItem'],
        ['dqSubClass', 'cs_subClass'],
        ['dqSalesId', 'cs_salesId']
      ];
      map.forEach(([id, key]) => {
        const el = getInput(id);
        if (el) el.value = qs.get(key) || '';
      });
      if (!qs.get('cs_phoneCond') && qPhoneCond) qPhoneCond.value = '0';
      if (!qs.get('cs_faxCond') && qFaxCond) qFaxCond.value = '0';
    };
    const loadQueryInit = async () => {
      if (loaded) return;
      if (queryInitPromise) return queryInitPromise;
      queryInitPromise = (async () => {
      const q = new URLSearchParams();
      q.set('itemId', ('@Model.ItemId' || 'CC000054').toString());
      q.set('systemId', String(detailSystemId || 1));
      const jwt = localStorage.getItem('jwtId');
      const resp = await fetch(`/api/CCSCompanyAdd/query-init?${q.toString()}`, {
        headers: jwt ? { 'X-JWTID': jwt } : {}
      });
      const txt = await resp.text();
      let data = {};
      try { data = txt ? JSON.parse(txt) : {}; } catch { data = {}; }
      if (!resp.ok || !data?.success) {
        const msg = data?.message || data?.error || txt || `${resp.status} ${resp.statusText || ''}`.trim() || 'query-init failed';
        throw new Error(msg);
      }
      systemId = Number(data.systemId || detailSystemId || 1);
      showSales = !!data.showSales;
      if (![1, 9, 103].includes(systemId)) setVendorLabels();
      toggleSalesRow(showSales);
      if (qCompanyList) {
        qCompanyList.innerHTML = '';
        (Array.isArray(data.companyList) ? data.companyList : []).forEach(r => {
          const id = (r.companyId ?? r.CompanyId ?? '').toString();
          if (!id) return;
          const opt = document.createElement('option');
          opt.value = id;
          qCompanyList.appendChild(opt);
        });
      }
      if (qSubClass) {
        qSubClass.innerHTML = '<option value=""></option>';
        (Array.isArray(data.subClassList) ? data.subClassList : []).forEach(r => {
          const val = (r.subSystemId ?? r.SubSystemId ?? '').toString();
          const name = (r.subSystemName ?? r.SubSystemName ?? '').toString();
          if (!val) return;
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = `${val}${name ? ' ' + name : ''}`;
          qSubClass.appendChild(opt);
        });
      }
      if (qSalesId) {
        qSalesId.innerHTML = '<option value=""></option>';
        (Array.isArray(data.users) ? data.users : []).forEach(r => {
          const id = (r.userId ?? r.UserId ?? '').toString();
          const name = (r.userName ?? r.UserName ?? '').toString();
          if (!id) return;
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = `${id}${name ? ' ' + name : ''}`;
          qSalesId.appendChild(opt);
        });
      }
      loaded = true;
      applyQueryToModal();
      })();
      try {
        await queryInitPromise;
      } finally {
        queryInitPromise = null;
      }
    };
    window.openCcsDetailQueryDialog = async () => {
      try {
        if (!loaded || (qSubClass && qSubClass.options.length <= 1)) await loadQueryInit();
        applyQueryToModal();
        modal.show();
        getInput('dqCompanyLike')?.focus();
      } catch (err) {
        alert('讀取查詢條件失敗：' + err);
      }
    };
    btnClear.addEventListener('click', clearForm);
    ['dqCompanyLike','dqCompanyStart','dqCompanyEnd','dqShortName','dqPhone','dqFax','dqUniFormId','dqCompanyName','dqCompanyAddr','dqBnsItem']
      .forEach(id => {
        const el = getInput(id);
        if (!el) return;
        el.addEventListener('keydown', (ev) => {
          if (ev.key !== 'Enter') return;
          ev.preventDefault();
          btnSearch.click();
        });
      });
    btnSearch.addEventListener('click', async () => {
      const setParam = (url, key, id) => {
        const el = getInput(id);
        const val = (el?.value || '').toString().trim();
        if (val) url.searchParams.set(key, val);
      };
      try {
        const listBase = document.getElementById('btnBackList')?.getAttribute('href') || '';
        const dataUrl = new URL(listBase || '@Url.Page("CC000054", new { itemId = Model.ItemId, systemId = Model.SystemId })', window.location.origin);
        dataUrl.searchParams.set('handler', 'Data');
        dataUrl.searchParams.set('pageIndex', '1');
        dataUrl.searchParams.set('pageSize', '1');
        setParam(dataUrl, 'cs_companyLike', 'dqCompanyLike');
        setParam(dataUrl, 'cs_companyStart', 'dqCompanyStart');
        setParam(dataUrl, 'cs_companyEnd', 'dqCompanyEnd');
        setParam(dataUrl, 'cs_shortName', 'dqShortName');
        setParam(dataUrl, 'cs_phoneCond', 'dqPhoneCond');
        setParam(dataUrl, 'cs_phone', 'dqPhone');
        setParam(dataUrl, 'cs_faxCond', 'dqFaxCond');
        setParam(dataUrl, 'cs_fax', 'dqFax');
        setParam(dataUrl, 'cs_uniFormId', 'dqUniFormId');
        setParam(dataUrl, 'cs_companyName', 'dqCompanyName');
        setParam(dataUrl, 'cs_companyAddr', 'dqCompanyAddr');
        setParam(dataUrl, 'cs_bnsItem', 'dqBnsItem');
        setParam(dataUrl, 'cs_subClass', 'dqSubClass');
        if (showSales) setParam(dataUrl, 'cs_salesId', 'dqSalesId');

        const resp = await fetch(dataUrl.toString());
        const json = await resp.json().catch(() => ({}));
        if (!resp.ok || !json?.success) throw new Error(json?.error || json?.message || resp.statusText || 'query failed');
        const first = Array.isArray(json.items) ? json.items[0] : null;
        if (!first) { alert('查無資料'); return; }
        const cidKey = Object.keys(first).find(k => String(k).toLowerCase() === 'companyid');
        const cid = cidKey ? String(first[cidKey] || '').trim() : '';
        if (!cid) { alert('查無公司代碼'); return; }
        modal.hide();
        const u = new URL('@Url.Page("CC000054Detail", new { itemId = Model.ItemId, systemId = Model.SystemId })', window.location.origin);
        u.searchParams.set('CompanyId', cid);
        u.searchParams.set('systemId', String(detailSystemId || 1));
        window.location.href = u.toString();
      } catch (err) {
        alert('查詢失敗：' + err);
      }
    });
    // Preload once so first open equals second open.
    loadQueryInit().catch(() => { });
  };

  function getDict(dictName) {
    return fetch(`/api/TableFieldLayout/GetTableFieldsFull?table=${encodeURIComponent(dictName)}`)
      .then(r => r.json());
  }
  initDetailAddDialog();
  initDetailQueryDialog();

  function buildGridViewText(field, rawVal) {
    const span = document.createElement('span');
    span.className = 'cell-view';
    if (Number(field?.ComboStyle ?? 0) === 1) {
      const v = String(rawVal ?? '').trim().toLowerCase();
      span.textContent = (v === '1' || v === 'true' || v === 'y') ? '✓' : '';
      return span;
    }
    span.textContent = rawVal == null ? '' : String(rawVal);
    return span;
  }

  async function enhanceGridLookupEditors(table, fields) {
    if (!table || !Array.isArray(fields) || !fields.length) return;
    const host = table.closest('.ccs-subgrid-wrap') || table.parentElement;
    if (!host) return;
    for (const f of fields) {
      const meta = getLookupMeta(f);
      if (!meta) continue;
      const safeField = String(f.FieldName || '').replace(/[^a-zA-Z0-9_-]/g, '_');
      const listId = `lk-grid-${table.id}-${safeField}`;
      let dl = host.querySelector(`#${listId}`);
      if (!dl) {
        dl = document.createElement('datalist');
        dl.id = listId;
        host.appendChild(dl);
      }
      const rows = await getLookupRows(meta.table);
      dl.innerHTML = '';
      rows.forEach(r => {
        const code = String(pickRowValueCI(r, meta.keyField) ?? '').trim();
        if (!code) return;
        const name = String(pickRowValueCI(r, meta.nameField) ?? '').trim();
        const opt = document.createElement('option');
        opt.value = code;
        opt.label = name ? `${code} ${name}` : code;
        dl.appendChild(opt);
      });
      table.querySelectorAll(`tbody .cell-edit[name="${f.FieldName}"]`).forEach(inp => {
        inp.setAttribute('list', listId);
        if (inp.dataset.lkBound === '1') return;
        inp.dataset.lkBound = '1';
        const norm = () => {
          const v = (inp.value || '').toString();
          const first = v.split(/\s+/).filter(Boolean)[0] || '';
          if (first !== v) inp.value = first;
        };
        inp.addEventListener('input', norm);
        inp.addEventListener('change', norm);
      });
    }
  }

  async function buildTable(tabKey, dict, rows, extras = [], tableNameOverride = '') {
    const table = document.getElementById(`grid-${tabKey}`);
    if (!table) return;
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    if (!thead || !tbody) return;

    const dictArr = Array.isArray(dict) ? dict : [];
    let visibleFields = filterVisibleFields(dictArr, 1);
    const pkFields = dictArr.filter(f => (f.PK ?? 0) === 1);
    const attrKeys = (table.dataset.keyFields || '').split(',').map(s => s.trim()).filter(Boolean);
    const pkKeyNames = pkFields.map(f => f.FieldName).filter(Boolean);
    const keyFields = [...new Set([...attrKeys, ...pkKeyNames])];
    if (!visibleFields.length) {
      const rawVisible = dictArr
        .filter(f => (f.Visible ?? 1) == 1)
        .sort((a, b) => (a.SerialNum ?? 9999) - (b.SerialNum ?? 9999));
      const dedup = new Map();
      rawVisible.forEach(f => {
        const k = String(f?.FieldName || '').trim().toLowerCase();
        if (k && !dedup.has(k)) dedup.set(k, f);
      });
      visibleFields = Array.from(dedup.values());
    }
    if (!visibleFields.length && keyFields.length) {
      visibleFields = keyFields.map(k => ({ FieldName: k, DisplayLabel: k, DisplaySize: 12, ReadOnly: 1 }));
    }
    const tableName = table.dataset.tableName || table.dataset.dictName || tableNameOverride || '';
    const hasCompanyField = [...visibleFields, ...pkFields].some(f => (f.FieldName || '').toLowerCase() === 'companyid');
    const serialField = [...visibleFields, ...pkFields].find(f => (f.FieldName || '').toLowerCase() === 'serialnum');

    tabMeta[tabKey] = {
      type: 'grid',
      dict: visibleFields,
      pkFields,
      extras,
      keyFields,
      tableName,
      hasCompanyField,
      serialField
    };

    // Rebind resizers after header rebuild.
    delete table.dataset.resizeBound;
    // build head
    thead.innerHTML = '';
    const trHead = document.createElement('tr');
    visibleFields.forEach(f => {
      const th = document.createElement('th');
      th.textContent = f.DisplayLabel || f.FieldName;
      th.dataset.field = f.FieldName;
      th.style.minWidth = (Number(f.DisplaySize || 0) * 10 || 80) + 'px';
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);

    // build body
    tbody.innerHTML = '';
    if (!Array.isArray(rows) || rows.length === 0) {
      const colCount = trHead.children.length || 1;
      const emptyRows = 1;
      for (let i = 0; i < emptyRows; i += 1) {
        const tr = document.createElement('tr');
        for (let c = 0; c < colCount; c += 1) {
          const td = document.createElement('td');
          td.innerHTML = '&nbsp;';
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    } else {
      rows.forEach(row => {
        const tr = document.createElement('tr');
        visibleFields.forEach(f => {
          const td = document.createElement('td');
          td.dataset.field = f.FieldName;
          const raw = row[f.FieldName];
          const span = buildGridViewText(f, raw);
          const inp = document.createElement('input');
          inp.className = 'form-control form-control-sm cell-edit d-none';
          inp.name = f.FieldName;
          inp.value = raw == null ? '' : raw;
          inp.dataset.raw = raw == null ? '' : raw;
          inp.dataset.readonly = (f.ReadOnly ?? 0) != 0 ? '1' : '0';
          if ((f.ReadOnly ?? 0) != 0) {
            inp.classList.add('readonly-cell');
            inp.setAttribute('readonly','readonly');
          }
          td.append(span, inp);
          tr.appendChild(td);
        });
        // hidden PK ?????謓舀????
        pkFields
          .filter(f => (f.Visible ?? 1) == 0)
          .forEach(f => {
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.className = 'mmd-pk-hidden';
            hidden.name = f.FieldName;
            const lower = (f.FieldName || '').toLowerCase();
            const extraVal = extras.find(kv => (kv.key || '').toLowerCase() === lower)?.value;
            hidden.value = row[f.FieldName] ?? extraVal ?? (lower === 'companyid' ? currentCompany || '' : '');
            tr.appendChild(hidden);
          });
        // Keep hidden PK values for non-visible key fields.
        if (!hasCompanyField) {
          const hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.className = 'mmd-pk-hidden';
          hidden.name = 'CompanyId';
          hidden.value = currentCompany || '';
          tr.appendChild(hidden);
        }
        tbody.appendChild(tr);
      });
    }

    const wrapper = table.closest('.table-responsive');
    tabState[tabKey] = window.makeEditableGrid({
      wrapper,
      table,
      tableName,
      keyFields
    });
    await enhanceGridLookupEditors(table, visibleFields);
    applySubGridWidths(table);
    attachSubGridResizers(table);
    wireGridRowSelection(table);
    const firstRow = table.querySelector('tbody tr td[data-field]')?.closest('tr');
    if (firstRow) selectGridRow(table, firstRow);
    syncGridButtons(tabKey);
  }

  function applySubGridWidths(table) {
    if (!table) return;
    const widthMap = loadSubGridWidthMap(table);
    const ths = Array.from(table.querySelectorAll('thead th'));
    if (!ths.length) return;
    let total = 0;
    ths.forEach((th, idx) => {
      let w = Number(widthMap[idx] || th.dataset.w || 0);
      if (!Number.isFinite(w) || w <= 0) {
        w = Math.max(70, Math.round(th.getBoundingClientRect().width || 90));
      }
      th.dataset.w = String(w);
      th.style.width = `${w}px`;
      th.style.minWidth = `${w}px`;
      th.style.maxWidth = `${w}px`;
      table.querySelectorAll('tbody tr').forEach((tr) => {
        const td = tr.children[idx];
        if (!td) return;
        td.style.width = `${w}px`;
        td.style.minWidth = `${w}px`;
        td.style.maxWidth = `${w}px`;
      });
      total += w;
    });
    if (total > 0) {
      table.style.tableLayout = 'fixed';
      table.style.width = `${total}px`;
    }
  }

  function setSubGridColWidth(table, colIdx, width) {
    if (!table) return;
    const ths = Array.from(table.querySelectorAll('thead th'));
    const th = ths[colIdx];
    if (!th) return;
    const w = Math.max(60, Math.round(width || 60));
    th.dataset.w = String(w);
    th.style.width = `${w}px`;
    th.style.minWidth = `${w}px`;
    th.style.maxWidth = `${w}px`;
    table.querySelectorAll('tbody tr').forEach((tr) => {
      const td = tr.children[colIdx];
      if (!td) return;
      td.style.width = `${w}px`;
      td.style.minWidth = `${w}px`;
      td.style.maxWidth = `${w}px`;
    });
    const total = ths.reduce((s, h) => s + Math.max(60, Number(h.dataset.w || h.getBoundingClientRect().width || 80)), 0);
    table.style.tableLayout = 'fixed';
    table.style.width = `${total}px`;
    const map = loadSubGridWidthMap(table);
    map[colIdx] = w;
    saveSubGridWidthMap(table, map);
  }

  function attachSubGridResizers(table) {
    if (!table) return;
    const ths = Array.from(table.querySelectorAll('thead th'));
    if (!ths.length) return;
    ths.forEach((th, idx) => {
      th.style.position = 'relative';
      const old = th.querySelector('.col-resizer');
      if (old) old.remove();
      const h = document.createElement('span');
      h.className = 'col-resizer';
      h.addEventListener('click', (e) => e.stopPropagation());
      h.addEventListener('mousedown', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const startX = e.clientX;
        const startW = Number(th.dataset.w || th.getBoundingClientRect().width || 80);
        const onMove = (ev) => setSubGridColWidth(table, idx, startW + (ev.clientX - startX));
        const onUp = () => {
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
        };
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });
      th.appendChild(h);
    });
    table.dataset.resizeBound = '1';
  }

  function initAllTabGridResizers() {
    document.querySelectorAll('.ccs-subgrid-table').forEach((table) => {
      if (!(table instanceof HTMLTableElement)) return;
      if (!table.querySelector('thead th')) return;
      applySubGridWidths(table);
      attachSubGridResizers(table);
    });
  }

  function getSubGridWidthStorageKey(table) {
    if (!table) return null;
    const tabKey = table.id ? table.id.replace('grid-', '') : 'tab';
    const itemId = String('@Model.ItemId' || 'CC000054').trim();
    return `ccs:subgrid:width:${itemId}:${tabKey}`;
  }

  function loadSubGridWidthMap(table) {
    const key = getSubGridWidthStorageKey(table);
    if (!key) return {};
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return {};
      const obj = JSON.parse(raw);
      return (obj && typeof obj === 'object') ? obj : {};
    } catch {
      return {};
    }
  }

  function saveSubGridWidthMap(table, map) {
    const key = getSubGridWidthStorageKey(table);
    if (!key) return;
    try { localStorage.setItem(key, JSON.stringify(map || {})); } catch { }
  }

  function parseExtraKeys(raw) {
    const list = [];
    (raw || '').split(';').forEach(pair => {
      const [k,v] = pair.split('=');
      if (k && v !== undefined) list.push({ key: k.trim(), value: v.trim() });
    });
    return list;
  }

  const selectGridRow = (table, tr) => {
    if (!table || !tr) return;
    table.querySelectorAll('tbody tr').forEach(r => r.classList.remove('selected', 'table-active'));
    tr.classList.add('selected', 'table-active');
  };

  const wireGridRowSelection = (table) => {
    if (!table || table.dataset.rowSelectBound === '1') return;
    table.dataset.rowSelectBound = '1';
    table.addEventListener('click', (ev) => {
      const tr = ev.target?.closest?.('tbody tr');
      if (!tr) return;
      if (!tr.querySelector('td[data-field]')) return;
      selectGridRow(table, tr);
    });
  };

  const syncTabIconToolbar = (tabKey) => {
    const bar = document.querySelector(`[data-tab-icon-toolbar="${tabKey}"]`);
    if (!bar) return;
    const tabBtn = document.getElementById(`tab-${tabKey}-tab`);
    const tabTitle = (tabBtn?.textContent || '').trim();
    const key = String(tabKey || '').toLowerCase();
    const canShow = iconToolbarTabs.has(key)
      || tabTitle.includes('聯絡人')
      || tabTitle.includes('貨運地址')
      || tabTitle.includes('出貨地址')
      || tabTitle.includes('銀行資料')
      || tabTitle.includes('銀行授信')
      || tabTitle.includes('銀行保證')
      || tabTitle.toUpperCase().includes('FORWARDER')
      || tabTitle.includes('客戶要求')
      || tabTitle.includes('允收規範')
      || tabTitle.includes('附件')
      || tabTitle.toUpperCase().includes('XOUT');
    bar.classList.toggle('d-none', !canShow);
    if (!canShow) return;
    const editing = !!tabState[tabKey]?.isEdit?.();
    const btnSave = bar.querySelector('[data-tab-tool="save"]');
    const btnAdd = bar.querySelector('[data-tab-tool="add"]');
    const btnDelete = bar.querySelector('[data-tab-tool="delete"]');
    if (btnSave) btnSave.disabled = !editing;
    if (btnAdd) btnAdd.disabled = !editing;
    if (btnDelete) btnDelete.disabled = true;
  };

  const syncGridButtons = (tabKey) => {
    const pane = document.getElementById(`tab-${tabKey}`);
    const ctrls = pane?.querySelector('.tab-local-controls');
    if (!ctrls) return;
    ctrls.classList.remove('d-none');
    const editing = !!tabState[tabKey]?.isEdit?.();
    const hasAdd = !!pane.querySelector('tr[data-state="added"]');
    const btnEdit = ctrls.querySelector('[data-btn="edit"]');
    const btnSave = ctrls.querySelector('[data-btn="save"]');
    const btnAdd = ctrls.querySelector('[data-btn="add"]');
    const btnConfirm = ctrls.querySelector('[data-btn="confirm"]');
    const btnCancel = ctrls.querySelector('[data-btn="cancel"]');
    if (btnEdit) btnEdit.textContent = editing ? '瀏覽' : '編輯';
    btnSave?.classList.toggle('d-none', !editing);
    btnAdd?.classList.remove('d-none');
    btnConfirm?.classList.toggle('d-none', !hasAdd);
    btnCancel?.classList.toggle('d-none', !hasAdd);
    syncTabIconToolbar(tabKey);
  };

  const addBlankGridRow = (tabKey) => {
    const meta = tabMeta[tabKey];
    const table = document.getElementById(`grid-${tabKey}`);
    const tbody = table?.querySelector('tbody');
    if (!meta || !table || !tbody) return;
    if (!meta.dict || !meta.dict.length) return;

    // Remove placeholder row before adding a new row.
    tbody.querySelectorAll('tr').forEach(tr => {
      if (tr.querySelector('.text-muted') && !tr.dataset.state) tr.remove();
    });

    const extrasMap = {};
    (meta.extras || []).forEach(kv => extrasMap[(kv.key || '').toLowerCase()] = kv.value);
    const autoIncFieldName = (() => {
      const pick = (arr, rx) => (arr || []).find(f => rx.test(String(f?.FieldName || '')));
      const serial = meta.serialField?.FieldName;
      if (serial) return serial;
      const pkCandidates = (meta.pkFields || []);
      return (
        pick(pkCandidates, /^SerialNum$/i)?.FieldName
        || pick(pkCandidates, /Serial/i)?.FieldName
        || pick(pkCandidates, /^NumId$/i)?.FieldName
        || pick(pkCandidates, /Num/i)?.FieldName
        || ''
      );
    })();
    const autoIncFieldLower = String(autoIncFieldName || '').toLowerCase();
    let nextAutoInc = '';
    if (autoIncFieldName) {
      const existing = Array.from(tbody.querySelectorAll('tr')).map(r => {
        const fromVisible = r.querySelector(`input[name="${autoIncFieldName}"]`) || r.querySelector(`td[data-field="${autoIncFieldName}"] .cell-edit`);
        const fromHidden = r.querySelector(`input.mmd-pk-hidden[name="${autoIncFieldName}"]`);
        const val = fromVisible?.value ?? fromHidden?.value ?? fromVisible?.textContent ?? '';
        return Number.parseInt(String(val || '').trim(), 10) || 0;
      });
      nextAutoInc = String(Math.max(0, ...existing) + 1);
    }

    const tr = document.createElement('tr');
    tr.dataset.state = 'added';
    meta.dict.forEach(f => {
      const td = document.createElement('td');
      td.dataset.field = f.FieldName;
      const span = makeValueElement(f, '');
      span.classList.add('cell-view');
      const inp = document.createElement('input');
      inp.className = 'form-control form-control-sm cell-edit d-none';
      inp.name = f.FieldName;
      let val = '';
      const lower = (f.FieldName || '').toLowerCase();
      if (lower === 'companyid') {
        val = currentCompany || '';
      } else if (autoIncFieldLower && lower === autoIncFieldLower) {
        val = nextAutoInc || '';
      } else if (lower === 'useid') {
        val = 'A001';
      } else if (extrasMap[lower] !== undefined) {
        val = extrasMap[lower];
      }
      if (!val && lower === 'asstype') val = '0';
      if (!val && lower === 'language') val = '0';
      inp.value = val;
      inp.defaultValue = val;
      inp.dataset.raw = val;
      inp.dataset.readonly = (f.ReadOnly ?? 0) != 0 ? '1' : '0';
      if ((f.ReadOnly ?? 0) != 0) {
        inp.classList.add('readonly-cell');
        inp.setAttribute('readonly','readonly');
      }
      td.append(span, inp);
      tr.appendChild(td);
    });
    // ?梯? PK 甈?
    (meta.pkFields || []).filter(f => (f.Visible ?? 1) == 0).forEach(f => {
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.className = 'mmd-pk-hidden';
      hidden.name = f.FieldName;
      const lower = (f.FieldName || '').toLowerCase();
      if (lower === 'companyid') {
        hidden.value = currentCompany || '';
      } else {
        let autoIncVal = '';
        if (autoIncFieldLower && lower === autoIncFieldLower) {
          autoIncVal = nextAutoInc || '';
        }
        let val = autoIncVal || '';
        if (!val && lower === 'useid') val = 'A001';
        if (!val && lower === 'asstype') val = '0';
        if (!val && lower === 'language') val = '0';
        if (!val && extrasMap[lower] !== undefined) val = extrasMap[lower];
        hidden.value = val;
      }
      tr.appendChild(hidden);
    });
    // Ensure CompanyId hidden key exists when column is not visible.
    if (!meta.hasCompanyField) {
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.className = 'mmd-pk-hidden';
      hidden.name = 'CompanyId';
      hidden.value = currentCompany || '';
      tr.appendChild(hidden);
    }
    tbody.prepend(tr);
    selectGridRow(table, tr);
    enhanceGridLookupEditors(table, meta.dict);
    tabState[tabKey]?.toggleEdit?.(true);
    hasGridPendingAdd = true;
    setTopEditUI(true);
    syncGridButtons(tabKey);
  };

  const toggleGridEdit = (tabKey, editable) => {
    const editor = tabState[tabKey];
    if (!editor) return;
    editor.toggleEdit(editable);
    setTopEditUI(editable);
    if (!editable) cancelGridAdd(tabKey, { keepEditingFlag: true });
    syncGridButtons(tabKey);
  };

  const saveGridChanges = async (tabKey) => {
    const editor = tabState[tabKey];
    if (!editor) return;
    const res = await editor.saveChanges();
    if (res.ok) {
      alert('儲存成功');
      toggleGridEdit(tabKey, false);
      if (currentCompany) loadTabData(tabKey, currentCompany);
    } else {
      alert('儲存失敗: ' + (res.text || ''));
    }
  };

  const cancelGridAdd = (tabKey, opts = {}) => {
    const table = document.getElementById(`grid-${tabKey}`);
    const tbody = table?.querySelector('tbody');
    if (!tbody) return;
    tbody.querySelectorAll('tr[data-state="added"]').forEach(tr => tr.remove());
    hasGridPendingAdd = false;
    if (!opts.keepEditingFlag) setTopEditUI(false);
    syncGridButtons(tabKey);
  };

  const getActiveFormTabKey = () => {
    const activeBtn = document.querySelector('[data-bs-toggle="tab"].active');
    if (!activeBtn) return null;
    const key = activeBtn.dataset.tabKey || activeBtn.dataset.tab || activeBtn.id?.replace('tab-','').replace('-tab','');
    if (!key) return null;
    const pane = document.getElementById(`tab-${key}`);
    if (pane?.getAttribute('data-form') === '1') return key;
    return null;
  };

  async function renderForm(tabKey, dictName, tableName, companyId, extras = []) {
    const host = tabKey === 'master'
      ? document.getElementById('cc000054-master-form')
      : document.getElementById(`form-${tabKey}`);
    if (!host || !dictName || !tableName || !companyId) return;
    try {
      const token = ((__formRenderToken[tabKey] || 0) + 1);
      __formRenderToken[tabKey] = token;
      const extraParams = extras.map(kv => `&keyNames=${encodeURIComponent(kv.key)}&keyValues=${encodeURIComponent(kv.value)}`).join("");
      const [dict, rows] = await Promise.all([
        fetch(`/api/TableFieldLayout/GetTableFieldsFull?table=${encodeURIComponent(dictName)}`).then(r => r.json()),
        fetch(`/api/CommonTable/ByKeys?table=${encodeURIComponent(tableName)}&keyNames=CompanyId&keyValues=${encodeURIComponent(companyId)}${extraParams}`).then(r => r.json())
      ]);
      if (__formRenderToken[tabKey] !== token) return;
      const data = Array.isArray(rows) ? rows[0] || {} : {};
      const fields = filterVisibleFields(dict, 1);
      const pkFields = Array.isArray(dict) ? dict.filter(f => (f.PK ?? 0) === 1).map(f => f.FieldName).filter(Boolean) : [];
      host.dataset.dictName = dictName;
      const container = document.createElement('div');
      container.className = tabKey === 'master'
        ? 'position-relative mf-container'
        : 'position-relative mf-container mf-form';
      container.dataset.dictTable = dictName;
      container.dataset.formKey = tabKey;

      const sortedFields = [...fields].sort((a,b)=>(a.SerialNum ?? 0)-(b.SerialNum ?? 0));
      for (const f of sortedFields) {
          const layout = getLayoutRect(f);
          const val = data[f.FieldName] ?? '';

          const wrapper = document.createElement('div');
          wrapper.className = 'mf-field';
          wrapper.dataset.field = f.FieldName;
          wrapper.style.position = 'absolute';
          wrapper.style.top = `${layout.boxTop}px`;
          wrapper.style.left = `${layout.boxLeft}px`;
          wrapper.style.width = `${layout.boxWidth}px`;
          wrapper.style.height = `${layout.boxHeight}px`;
          wrapper.style.minHeight = `${layout.boxHeight}px`;
          wrapper.style.overflow = 'visible';

          const hasLabelText = !!String(f.DisplayLabel || '').trim();
          const label = document.createElement('label');
          label.textContent = f.DisplayLabel || f.FieldName;
          label.style.position = 'absolute';
          label.style.top = `${layout.boxTop + layout.labTop}px`;
          label.style.left = `${layout.boxLeft + layout.labLeft}px`;
          label.style.width = `${layout.labWidth}px`;
          label.style.height = `${layout.labHeight}px`;
          label.style.lineHeight = `${layout.labHeight}px`;
          label.style.textAlign = 'right';
          label.style.whiteSpace = 'nowrap';
          label.style.margin = '0';
          label.classList.add('mf-label');

          const lookupMeta = getLookupMeta(f);
          if (lookupMeta) {
            wrapper.dataset.lookupTable = lookupMeta.table;
            wrapper.dataset.lookupKeyField = lookupMeta.keyField;
            wrapper.dataset.lookupNameField = lookupMeta.nameField;
          }
          const lookupPair = lookupMeta ? await normalizeLookupCodeName(f, val) : { code: (val == null ? '' : String(val)), name: '' };
          const lookupCode = lookupPair.code ?? '';
          const lookupName = lookupPair.name ?? '';
          if (__formRenderToken[tabKey] !== token) return;
          const span = lookupMeta
            ? makeLookupValueElement(lookupCode, lookupName)
            : makeValueElement(f, val);
          span.classList.add('mf-view');
          span.style.position = 'absolute';
          span.style.top = `${layout.fieldTop}px`;
          span.style.left = `${layout.fieldLeft}px`;
          span.style.width = `${layout.fieldWidth}px`;
          span.style.height = `${layout.fieldHeight}px`;
          span.style.minHeight = `${layout.fieldHeight}px`;

          let editor;
          let lookupNameEditor = null;
          if (Number(f.ComboStyle ?? 0) === 1) {
            editor = document.createElement('input');
            editor.type = 'checkbox';
            editor.className = 'form-check-input mf-edit d-none';
            editor.name = f.FieldName;
            editor.checked = String(val).toLowerCase() === '1' || String(val).toLowerCase() === 'true';
            editor.dataset.original = editor.checked ? '1' : '0';
            editor.style.position = 'absolute';
            editor.style.top = `${layout.fieldTop + 4}px`;
            editor.style.left = `${layout.fieldLeft + 4}px`;
          } else {
            const useTextarea = !lookupMeta && (layout.fieldHeight >= 40);
            if (useTextarea) {
              editor = document.createElement('textarea');
              editor.rows = Math.max(1, Math.round(layout.fieldHeight / 18));
            } else {
              editor = document.createElement('input');
              editor.type = 'text';
            }
            editor.className = 'form-control form-control-sm mf-edit d-none mf-input';
            editor.name = f.FieldName;
            editor.value = lookupMeta ? lookupCode : (val == null ? '' : val);
            editor.dataset.original = lookupMeta ? lookupCode : (val == null ? '' : String(val));
            editor.style.position = 'absolute';
            editor.style.top = `${layout.fieldTop}px`;
            editor.style.left = `${layout.fieldLeft}px`;
            const codeWidth = lookupMeta ? getLookupCodeWidth(layout.fieldWidth) : layout.fieldWidth;
            editor.style.width = `${codeWidth}px`;
            editor.style.height = `${layout.fieldHeight}px`;
            editor.style.minHeight = `${layout.fieldHeight}px`;
            if (lookupMeta) {
              const listId = `lk-${tabKey}-${String(f.FieldName || '').replace(/[^a-zA-Z0-9_-]/g, '_')}`;
              editor.setAttribute('list', listId);
              const lookupRows = await getLookupRows(lookupMeta.table);
              if (Array.isArray(lookupRows) && lookupRows.length > 0) {
                const dl = document.createElement('datalist');
                dl.id = listId;
                for (const row of lookupRows) {
                  const code = String(pickRowValueCI(row, lookupMeta.keyField) ?? '').trim();
                  if (!code) continue;
                  const name = String(pickRowValueCI(row, lookupMeta.nameField) ?? '').trim();
                  const opt = document.createElement('option');
                  opt.value = code;
                  opt.label = name ? `${code} ${name}` : code;
                  dl.appendChild(opt);
                }
                wrapper.appendChild(dl);
              }
              lookupNameEditor = document.createElement('input');
              lookupNameEditor.type = 'text';
              lookupNameEditor.className = 'form-control form-control-sm mf-lk-edit-name d-none';
              lookupNameEditor.readOnly = true;
              lookupNameEditor.value = lookupName || '';
              lookupNameEditor.style.position = 'absolute';
              lookupNameEditor.style.top = `${layout.fieldTop}px`;
              lookupNameEditor.style.left = `${layout.fieldLeft + codeWidth}px`;
              lookupNameEditor.style.width = `${Math.max(60, layout.fieldWidth - codeWidth)}px`;
              lookupNameEditor.style.height = `${layout.fieldHeight}px`;
              lookupNameEditor.style.minHeight = `${layout.fieldHeight}px`;
              editor.addEventListener('input', () => {
                const currentCode = (editor.value || '').toString().split(/\s+/).filter(Boolean)[0] || '';
                if (currentCode !== editor.value) editor.value = currentCode;
                resolveLookupName(f, currentCode).then((nm) => {
                  if (lookupNameEditor) lookupNameEditor.value = nm || '';
                });
              });
              editor.addEventListener('change', () => {
                const currentCode = (editor.value || '').toString().split(/\s+/).filter(Boolean)[0] || '';
                if (currentCode !== editor.value) editor.value = currentCode;
                resolveLookupName(f, currentCode).then((nm) => {
                  if (lookupNameEditor) lookupNameEditor.value = nm || '';
                });
              });
              lookupNameEditor.addEventListener('mousedown', (ev) => {
                ev.preventDefault();
                editor.focus();
                const len = (editor.value || '').length;
                try { editor.setSelectionRange(len, len); } catch { }
              });
              lookupNameEditor.addEventListener('keydown', (ev) => {
                if (ev.key !== 'Delete' && ev.key !== 'Backspace') return;
                ev.preventDefault();
                editor.value = '';
                lookupNameEditor.value = '';
                editor.dispatchEvent(new Event('input', { bubbles: true }));
                editor.dispatchEvent(new Event('change', { bubbles: true }));
                editor.focus();
              });
            }
          }
          if (Number(f.ReadOnly ?? 0) === 1) {
            editor.setAttribute('readonly', 'readonly');
            editor.dataset.readonly = '1';
          }

          const resizer = document.createElement('span');
          resizer.className = 'mf-resizer';

          if (hasLabelText) container.appendChild(label);
          wrapper.append(span, editor);
          if (lookupNameEditor) wrapper.appendChild(lookupNameEditor);
          wrapper.appendChild(resizer);
          container.appendChild(wrapper);
      }

      if (__formRenderToken[tabKey] !== token) return;
      host.replaceChildren(container);
      let maxBottom = 0;
      container.querySelectorAll('.mf-field').forEach(el => {
        const top = parseFloat(el.style.top || '0') || 0;
        const h = parseFloat(el.style.height || '0') || 0;
        maxBottom = Math.max(maxBottom, top + h);
      });
      container.querySelectorAll('.mf-label').forEach(el => {
        const top = parseFloat(el.style.top || '0') || 0;
        const h = parseFloat(el.style.height || '0') || 0;
        maxBottom = Math.max(maxBottom, top + h);
      });
      if (maxBottom > 0) {
        const targetHeight = Math.max(120, Math.ceil(maxBottom + 6));
        host.style.minHeight = `${targetHeight}px`;
        // Master keeps fixed container height; tab forms keep compact auto layout.
        if (tabKey === 'master') host.style.height = `${targetHeight}px`;
        else host.style.height = 'auto';
      }
      enableFormLayoutEditing(container, dictName);
      const tabBtn = tabKey === 'master' ? null : document.getElementById(`tab-${tabKey}-tab`);
      const btnKeys = (tabBtn?.dataset?.keyfields || "").split(',').map(s=>s.trim()).filter(Boolean);
      const keyFields = tabKey === 'master'
        ? ['CompanyId', 'UseId']
        : (pkFields.length ? pkFields : (btnKeys.length ? btnKeys : ['CompanyId']));
      const extraKeysNames = extras.map(kv => kv.key);
      formState[tabKey] = {
        tableName,
        dictName,
        extras,
        keyFields: [...new Set([...keyFields, ...extraKeysNames])],
        lastRowData: data || {},
        editable: formEditMode
      };
      if (tabKey === 'master') {
        document.dispatchEvent(new CustomEvent('md-master-selected', {
          detail: { rowData: data || {} }
        }));
      }
    } catch (err) {
      console.error('render form tab failed', err);
    }
  }

  async function loadTabData(tabKey, companyId) {
    const btn = document.getElementById(`tab-${tabKey}-tab`);
    if (!btn) return;
    const tableName = btn.dataset.table;
    const dictName = btn.dataset.dict || tableName;
    const pane = document.getElementById(`tab-${tabKey}`);
    const isForm = pane?.getAttribute('data-form') === '1';
    const extras = parseExtraKeys(btn.dataset.extraKeys || "");
    if (!tableName || !companyId) return;

    try {
      if (isForm) {
        await renderForm(tabKey, dictName, tableName, companyId, extras);
        setFormMode(tabKey, !!formEditMode);
        return;
      }

      const extraParams = extras.map(kv => `&keyNames=${encodeURIComponent(kv.key)}&keyValues=${encodeURIComponent(kv.value)}`).join("");
      const url = `/api/CommonTable/ByKeys?table=${encodeURIComponent(tableName)}&keyNames=CompanyId&keyValues=${encodeURIComponent(companyId)}${extraParams}`;
      const [dict, rows] = await Promise.all([
        getDict(dictName),
        fetch(url).then(r => r.json())
      ]);
      await buildTable(tabKey, dict || [], Array.isArray(rows) ? rows : [], extras, tableName);
    } catch (err) {
      console.error('load tab data failed', tabKey, err);
      const table = document.getElementById(`grid-${tabKey}`);
      const thead = table?.querySelector('thead');
      const tbody = table?.querySelector('tbody');
      if (thead) thead.innerHTML = '<tr><th class="text-center text-muted">載入失敗</th></tr>';
      if (tbody) tbody.innerHTML = '<tr><td class="text-center text-danger py-3">分頁資料載入失敗，請確認主檔鍵值或稍後再試。</td></tr>';
    }
  }

  document.addEventListener('md-master-selected', (ev) => {
    const row = ev?.detail?.rowData;
    if (!row) return;
    currentCompany = row.CompanyId || row.companyid || row.COMPANYID;
    if (!currentCompany) return;
    tabs.forEach(btn => {
      const isActive = btn.classList.contains('active');
      if (isActive) loadTabData(btn.dataset.tabKey || btn.dataset.target || btn.id.replace('tab-','').replace('-tab',''), currentCompany);
    });
    setTimeout(() => initAllTabGridResizers(), 0);
  });

  tabs.forEach(btn => {
    const tabKey = btn.id.replace('tab-','').replace('-tab','');
    btn.dataset.tabKey = tabKey;
    btn.addEventListener('shown.bs.tab', () => {
      // Keep dictionary target in sync for F3 field dictionary editor.
      if (btn.dataset.dict) window._dictTableName = btn.dataset.dict;
      if (currentCompany) loadTabData(tabKey, currentCompany);
      const pane = document.getElementById(`tab-${tabKey}`);
      const isForm = pane?.getAttribute('data-form') === '1';
      if (formEditMode && isForm) {
        setFormMode(tabKey, true);
      }
      if (!isForm) {
        const table = document.getElementById(`grid-${tabKey}`);
        if (table) {
          applySubGridWidths(table);
          attachSubGridResizers(table);
        }
        syncGridButtons(tabKey);
        setTopEditUI(!!tabState[tabKey]?.isEdit?.());
      }
      initAllTabGridResizers();
    });
  });

  // per-tab buttons
  document.querySelectorAll('[data-btn]').forEach(b => {
    b.addEventListener('click', async () => {
      const tabKey = b.dataset.tab;
      const btnType = b.dataset.btn;
      const pane = document.getElementById(`tab-${tabKey}`);
      const isForm = pane?.getAttribute('data-form') === '1';
      if (isForm) {
        if (btnType === 'edit') {
          applyFormEditMode(!formState[tabKey]?.editable);
        } else if (btnType === 'save' || btnType === 'confirm') {
          const res = await saveFormChanges(tabKey);
          if (res?.ok) {
            alert('儲存成功');
            applyFormEditMode(false);
            if (currentCompany) loadTabData(tabKey, currentCompany);
          } else {
            alert('儲存失敗: ' + (res?.text || ''));
          }
        }
        return;
      }
      if (btnType === 'edit') {
        toggleGridEdit(tabKey, !(tabState[tabKey]?.isEdit?.()));
      } else if (btnType === 'save') {
        await saveGridChanges(tabKey);
      } else if (btnType === 'add') {
        addBlankGridRow(tabKey);
      } else if (btnType === 'confirm') {
        await saveGridChanges(tabKey);
      } else if (btnType === 'cancel') {
        cancelGridAdd(tabKey);
      }
      syncGridButtons(tabKey);
    });
  });

  document.querySelectorAll('[data-tab-tool]').forEach(b => {
    b.addEventListener('click', async () => {
      const tabKey = b.dataset.tab;
      const action = b.dataset.tabTool;
      if (!tabKey || !action) return;
      const attachFieldCandidates = ['PathAndName', 'FilePath', 'FullPath', 'CrossName', 'AttachName', 'FileName', 'PathName', 'AttachPath', 'Path'];
      const table = document.getElementById(`grid-${tabKey}`);
      const getAttachPathColumn = () => {
        const ths = Array.from(table?.querySelectorAll('thead th') || []);
        const byHeaderIdx = ths.findIndex(h => {
          const t = String(h?.textContent || '').trim().toLowerCase();
          return t.includes('路徑') || t.includes('檔名') || t.includes('path') || t.includes('file');
        });
        if (byHeaderIdx >= 0) {
          const th = ths[byHeaderIdx];
          return { idx: byHeaderIdx, field: String(th?.dataset?.field || '') };
        }
        const row = table?.querySelector('tbody tr');
        for (const n of attachFieldCandidates) {
          if (row?.querySelector(`.cell-edit[name="${n}"]`)) {
            const idx = ths.findIndex(h => String(h?.dataset?.field || '').toLowerCase() === String(n).toLowerCase());
            return { idx, field: n };
          }
        }
        // Fallback: first non-key / non-note column.
        const fallbackIdx = ths.findIndex(h => {
          const f = String(h?.dataset?.field || '').toLowerCase();
          if (!f) return false;
          return f !== 'serialnum' && f !== 'useid' && f !== 'notes' && f !== 'memo' && f !== 'remark';
        });
        if (fallbackIdx >= 0) {
          const th = ths[fallbackIdx];
          return { idx: fallbackIdx, field: String(th?.dataset?.field || '') };
        }
        return { idx: -1, field: '' };
      };
      const getSelectedAttachRow = () => {
        const bodyRows = Array.from(table?.querySelectorAll('tbody tr') || [])
          .filter(r => r.querySelector('td[data-field]'));
        const selected = table?.querySelector('tbody tr.selected, tbody tr.table-active');
        return selected || bodyRows[0] || null;
      };
      const getAttachCell = (row) => {
        if (!row) return null;
        const col = getAttachPathColumn();
        if (Number.isInteger(col.idx) && col.idx >= 0) {
          const byIdx = row.children?.[col.idx];
          if (byIdx) return byIdx;
        }
        if (col.field) {
          const byField = row.querySelector(`td[data-field="${col.field}"]`);
          if (byField) return byField;
        }
        return null;
      };
      const getAttachInput = (row) => {
        const cell = getAttachCell(row);
        return cell?.querySelector('.cell-edit') || null;
      };
      const getAttachPath = (row) => {
        const inp = getAttachInput(row);
        const fromInput = String(inp?.value || '').trim();
        if (fromInput) return fromInput;
        const cell = getAttachCell(row);
        const fromSpan = String(cell?.querySelector('.cell-view')?.textContent || '').trim();
        if (fromSpan) return fromSpan;
        const fromCell = String(cell?.textContent || '').trim();
        if (fromCell) return fromCell;
        return '';
      };
      const normalizeAttachPath = (raw) => {
        let s = String(raw || '').trim();
        if (!s) return '';
        s = s.replace(/^["']+|["']+$/g, '').trim();
        s = s.replace(/[;；]+$/g, '').trim();
        return s;
      };
      const toPreviewUrl = (raw) => {
        const s = normalizeAttachPath(raw);
        if (!s) return '';
        if (/^https?:\/\//i.test(s)) return s;
        if (/^\/api\//i.test(s)) return s;
        if (/^file:\/\//i.test(s)) {
          const local = decodeURIComponent(s.replace(/^file:\/\/\/?/i, '').replace(/\//g, '\\'));
          return `/api/MapPreview/file?path=${encodeURIComponent(local)}`;
        }
        return `/api/MapPreview/file?path=${encodeURIComponent(s)}`;
      };
      if (action === 'edit') {
        toggleGridEdit(tabKey, !(tabState[tabKey]?.isEdit?.()));
        return;
      }
      if (action === 'add') {
        addBlankGridRow(tabKey);
        return;
      }
      if (action === 'save') {
        await saveGridChanges(tabKey);
        return;
      }
      if (action === 'cancel') {
        cancelGridAdd(tabKey);
        toggleGridEdit(tabKey, false);
        return;
      }
      if (action === 'delete') {
        alert('此按鈕暫不開放');
        return;
      }
      if (action === 'setpath') {
        if (!tabState[tabKey]?.isEdit?.()) toggleGridEdit(tabKey, true);
        const row = getSelectedAttachRow();
        if (!row) { alert('請先選取一筆附件資料'); return; }
        selectGridRow(table, row);
        const input = getAttachInput(row);
        if (!input) { alert('找不到夾檔路徑欄位'); return; }
        if (input.readOnly || input.disabled) { alert('夾檔路徑欄位目前為唯讀，請先確認資料辭典設定。'); return; }
        input.focus();
        try {
          const len = String(input.value || '').length;
          input.setSelectionRange(len, len);
        } catch { }
        return;
      }
      if (action === 'preview') {
        const row = getSelectedAttachRow();
        if (!row) { alert('請先選取一筆附件資料'); return; }
        const rawPath = getAttachPath(row);
        if (!rawPath) { alert('目前附件路徑為空白'); return; }
        const openUrl = toPreviewUrl(rawPath);
        if (!openUrl) { alert('目前附件路徑為空白'); return; }
        const win = window.open(openUrl, '_blank', 'noopener');
        if (!win) alert('檢視失敗，請確認瀏覽器是否封鎖彈出視窗');
      }
    });
  });

  // Top toolbar actions apply to current active tab.
  const topEdit = document.getElementById('btnTopEdit');
  const topSave = document.getElementById('btnTopSave');
  const topAdd  = document.getElementById('btnTopAdd');
  const topDelete = document.getElementById('btnTopDelete');
  const topQuery = document.getElementById('btnTopQuery');
  const topReject = document.getElementById('btnTopReject');
  const topLog = document.getElementById('btnTopLog');
  const topShowSys = document.getElementById('btnTopShowSys');
  const detailCountBox = document.getElementById('detailCountBox');
  const detailModeText = document.getElementById('detailModeText');
  const detailCountText = document.getElementById('detailCountText');
  const navFirst = document.getElementById('btnNavFirst');
  const navPrev = document.getElementById('btnNavPrev');
  const navNext = document.getElementById('btnNavNext');
  const navLast = document.getElementById('btnNavLast');
  const mainToolbarGroup = document.querySelector('.ccs-detail-page .top-toolbar .toolbar-main > .d-flex');
  if (mainToolbarGroup) {
    const orderedIds = ['btnBackList', 'btnTopQuery', 'btnTopShowSys', 'btnTopAdd', 'btnTopDelete', 'btnTopEdit', 'btnTopLog', 'btnTopReject', 'btnTopSave'];
    orderedIds.forEach(id => {
      const el = document.getElementById(id);
      if (el && el.parentElement === mainToolbarGroup) mainToolbarGroup.appendChild(el);
    });
  }

  const setTopEditUI = (editing) => {
    topSave?.classList.toggle('d-none', !editing);
    document.body.classList.toggle('ccs-editing', !!editing);
    if (detailCountBox) {
      detailCountBox.classList.toggle('mode-edit', !!editing);
      detailCountBox.classList.toggle('mode-view', !editing);
    }
    if (detailModeText) {
      detailModeText.textContent = editing ? '修改模式' : '瀏覽模式';
    }
    if (topEdit) {
      topEdit.innerHTML = editing
        ? '<i class="bi bi-eye"></i>瀏覽'
        : '<i class="bi bi-pencil-square"></i>修改';
      topEdit.classList.toggle('primary', editing);
    }
    if (topAdd) topAdd.disabled = !!editing;
    if (topDelete) topDelete.disabled = !!editing;
  };

  const applyFormEditMode = (editable) => {
    formEditMode = editable;
    setFormMode('master', editable);
    const activeFormKey = getActiveFormTabKey();
    if (activeFormKey) setFormMode(activeFormKey, editable);
    setTopEditUI(editable);
  };

  const setFormMode = (tabKey, editable) => {
    const host = tabKey === 'master'
      ? document.getElementById('cc000054-master-form')
      : document.getElementById(`form-${tabKey}`);
    if (!host) return;
    // In edit mode: show input controls; in browse mode: show view values.
    host.dataset.editing = editable ? '1' : '0';
    host.querySelectorAll('.mf-field').forEach(f => {
      f.style.cursor = editable ? 'text' : 'default';
      f.style.userSelect = editable ? 'auto' : 'none';
    });
    host.querySelectorAll('.mf-resizer').forEach(r => {
      r.style.display = (!editable && __layoutEditEnabled) ? 'block' : 'none';
    });
    host.querySelectorAll('.mf-field').forEach(f => {
      const view = f.querySelector('.mf-view');
      const edit = f.querySelector('.mf-edit');
      const lkEditName = f.querySelector('.mf-lk-edit-name');
      if (!view || !edit) return;
      // Keep same visual layout in both modes: always show edit controls.
      view.classList.add('d-none');
      edit.classList.remove('d-none');
      if (lkEditName) lkEditName.classList.remove('d-none');

      const forceDisabled = (!editable) || (edit.dataset.readonly === '1');
      if (edit.tagName === 'INPUT' && edit.type === 'checkbox') {
        edit.disabled = forceDisabled;
      } else {
        if (forceDisabled) {
          edit.setAttribute('readonly', 'readonly');
          edit.setAttribute('disabled', 'disabled');
        } else {
          edit.removeAttribute('readonly');
          edit.removeAttribute('disabled');
        }
      }
      if (lkEditName) {
        lkEditName.setAttribute('readonly', 'readonly');
        if (!editable) lkEditName.setAttribute('disabled', 'disabled');
        else lkEditName.removeAttribute('disabled');
      }
    });
    if (formState[tabKey]) formState[tabKey].editable = editable;
  };

  const saveFormChanges = async (tabKey) => {
    const state = formState[tabKey];
    if (!state || !currentCompany) return { ok:false, text:'no state' };
    const host = tabKey === 'master' ? document.getElementById('cc000054-master-form') : document.getElementById(`form-${tabKey}`);
    if (!host) return { ok:false, text:'no host' };
    const keys = state.keyFields?.length ? state.keyFields : ['CompanyId'];
    const keySet = new Set((keys || []).map(k => String(k || '').toLowerCase()));
    const data = {};
    let changedNonKeyCount = 0;
    const extraMap = new Map((state.extras || []).map(kv => [String(kv.key || '').toLowerCase(), kv.value]));
    const lastRow = state.lastRowData || {};
    host.querySelectorAll('.mf-edit').forEach(el => {
      const name = el.name || '';
      if (!name) return;
      const lower = String(name).toLowerCase();
      const isKeyField = keySet.has(lower);
      // Readonly non-key fields should not be posted back to avoid wrong type writes.
      if (el.dataset.readonly === '1' && !isKeyField) return;
      const currentVal = el.type === 'checkbox' ? (el.checked ? '1' : '0') : (el.value ?? '');
      const originalVal = el.dataset.original ?? '';
      // Follow other modules: only submit key fields + changed values.
      if (!isKeyField && String(currentVal) === String(originalVal)) return;
      if (!isKeyField) changedNonKeyCount += 1;
      data[name] = currentVal;
    });
    keys.forEach(k => {
      if (!(data[k] == null || data[k] === '')) return;
      const lower = String(k || '').toLowerCase();
      if (lower === 'companyid') {
        data[k] = currentCompany;
        return;
      }
      if (lower === 'useid') {
        data[k] = lastRow[k] ?? lastRow.UseId ?? window._useId ?? localStorage.getItem('erpUseId') ?? 'A001';
        return;
      }
      if (extraMap.has(lower)) {
        data[k] = extraMap.get(lower) ?? '';
        return;
      }
      const oldVal = lastRow[k];
      if (oldVal != null && oldVal !== '') data[k] = oldVal;
    });
    // Same as sales-order style: no changed non-key fields => do not send save request.
    if (changedNonKeyCount === 0) return { ok:true, text:'no-changes' };
    (state.extras || []).forEach(kv => {
      data[kv.key] = kv.value;
    });
    const payload = {
      TableName: state.tableName,
      KeyFields: keys,
      Data: [ data ]
    };
    let resp, txt;
    try {
      resp = await fetch("/api/CommonTable/SaveTableChanges", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      txt = await resp.text();
      if (!resp.ok) return { ok:false, text:`${txt || resp.statusText}\n[fields:${Object.keys(data).join(',')}]` };
      return { ok:true, text:txt };
    } catch (err) {
      return { ok:false, text: `${String(err)}\n[fields:${Object.keys(data).join(',')}]` };
    }
  };

  const triggerTabAction = async (action) => {
    const activeTabBtn = document.querySelector('[data-bs-toggle="tab"].active');
    const activeTabKey = activeTabBtn ? (activeTabBtn.dataset.tab || activeTabBtn.dataset.tabKey || activeTabBtn.id?.replace('tab-','').replace('-tab','')) : '';
    const pane = activeTabKey ? document.getElementById(`tab-${activeTabKey}`) : null;
    const isForm = (!pane && !!formState['master']) || (pane?.getAttribute('data-form') === '1');
    const activeFormKey = getActiveFormTabKey();
    if (isForm) {
      if (action === 'edit') {
        applyFormEditMode(!formEditMode);
      } else if (action === 'save') {
        if (!formEditMode) return;
        const toSave = ['master'];
        if (activeFormKey && activeFormKey !== 'master') toSave.push(activeFormKey);
        (async () => {
          for (const key of toSave) {
            const res = await saveFormChanges(key);
            if (!res.ok) {
              alert(`儲存失敗(${key}): ${res.text || ''}`);
              return;
            }
          }
          alert('儲存成功');
          applyFormEditMode(false);
          if (currentCompany && activeFormKey && activeFormKey !== 'master') loadTabData(activeFormKey, currentCompany);
        })();
      } else if (action === 'add') {
        if (typeof window.openCcsDetailAddDialog === 'function') {
          await window.openCcsDetailAddDialog();
        } else {
          alert('新增視窗尚未初始化');
        }
      } else if (action === 'cancel') {
        applyFormEditMode(false);
      }
      return;
    }
    if (!activeTabKey) return;
    if (action === 'edit') {
      toggleGridEdit(activeTabKey, !(tabState[activeTabKey]?.isEdit?.()));
    } else if (action === 'save') {
      await saveGridChanges(activeTabKey);
    } else if (action === 'add') {
      addBlankGridRow(activeTabKey);
    } else if (action === 'cancel') {
      cancelGridAdd(activeTabKey);
      toggleGridEdit(activeTabKey, false);
    }
  };

  topEdit?.addEventListener('click', async () => { await triggerTabAction('edit'); });
  topSave?.addEventListener('click', async () => {
    if (hasGridPendingAdd) {
      await triggerTabAction('save');
      hasGridPendingAdd = false;
      setTopEditUI(false);
    } else {
      await triggerTabAction('save');
    }
  });
  topAdd?.addEventListener('click', async () => { await triggerTabAction('add'); });
  topDelete?.addEventListener('click', async () => {
    const paperNum = String(currentCompany || '').trim();
    if (!paperNum) { alert('尚未選取公司代碼'); return; }
    if (!confirm(`確定要刪除：${paperNum} ?`)) return;
    const payload = {
      paperId: 'AJNdCompany',
      paperNum,
      itemId: (window._singleItemId || 'CC000054').toString(),
      userId: (window._userId || localStorage.getItem('erpLoginUserId') || 'admin').toString(),
      useId: (window._useId || 'A001').toString(),
      eoc: 0,
      aftFinished: 2
    };
    try {
      const resp = await fetch('/api/PaperAction/DoAction', withJwtHeaders({
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }));
      const json = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(json?.message || resp.statusText || '刪除失敗');
      alert(json?.message || '刪除完成');
      location.href = '@Url.Page("CC000054", new { itemId = Model.ItemId, systemId = Model.SystemId })';
    } catch (err) {
      alert('刪除失敗：' + err);
    }
  });
  topQuery?.addEventListener('click', () => {
    if (typeof window.openCcsDetailQueryDialog === 'function') window.openCcsDetailQueryDialog();
  });
  const withJwtHeaders = (init = {}) => {
    const jwt = localStorage.getItem("jwtId");
    const headers = Object.assign({}, init.headers || {});
    if (jwt) headers["X-JWTID"] = jwt;
    return { ...init, headers };
  };
  const fetchJsonWithTimeout = async (url, timeoutMs = 6000) => {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    try {
      const resp = await fetch(url, withJwtHeaders({ signal: ctrl.signal }));
      const json = await resp.json().catch(() => ({}));
      return { ok: resp.ok && json?.ok !== false, json, status: resp.status };
    } catch (err) {
      return { ok: false, json: { error: String(err) }, status: 0 };
    } finally {
      clearTimeout(t);
    }
  };
  topLog?.addEventListener('click', async () => {
    const paperNum = String(currentCompany || '').trim();
    if (!paperNum) { alert('尚未選取公司代碼'); return; }
    if (typeof window.openCcsUpdateLog === 'function') {
      await window.openCcsUpdateLog({
        paperId: (window._singleRealTable || 'AJNdCompany').toString(),
        paperNum,
        itemId: (window._singleItemId || '@Model.ItemId').toString()
      });
      return;
    }
    alert('記錄視窗尚未載入');
  });
  topReject?.addEventListener('click', async () => {
    const paperNum = String(currentCompany || '').trim();
    if (!paperNum) { alert('尚未選取公司代碼'); return; }
    if (!confirm(`確定要撤除：${paperNum} ?`)) return;
    const payload = {
      paperId: (window._singleRealTable || 'AJNdCompany').toString(),
      paperNum,
      itemId: (window._singleItemId || '@Model.ItemId').toString(),
      userId: (window._userId || localStorage.getItem('erpLoginUserId') || 'admin').toString(),
      useId: (window._useId || 'A001').toString(),
      rejectNotes: ''
    };
    try {
      const resp = await fetch('/api/PaperAction/RejectForEdit', withJwtHeaders({
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }));
      const json = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(json?.message || resp.statusText || '撤除失敗');
      alert(json?.message || '撤除完成');
    } catch (err) {
      alert('撤除失敗：' + err);
    }
  });
  topShowSys?.addEventListener('click', async () => {
    const cid = String(currentCompany || '').trim();
    if (!cid) {
      alert('尚未選取公司代碼');
      return;
    }
    const modalEl = document.getElementById('showSystemModal');
    const modal = modalEl && window.bootstrap ? bootstrap.Modal.getOrCreateInstance(modalEl) : null;
    if (!modalEl || !modal) return;

    const setChecked = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.checked = Number(value || 0) === 1;
    };
    const setVal = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.value = value || '';
    };

    setVal('ssCompanyId', cid);
    setVal('ssShortName', '');
    setVal('ssCompanyName', '');
    ['ssSys1','ssSys2','ssSys3','ssSys4','ssSys5','ssSys6','ssSys7','ssSys8','ssSys9'].forEach(id => setChecked(id, 0));

    try {
      const resp = await fetch(`/api/CCSCompanyAdd/show-system?companyId=${encodeURIComponent(cid)}`);
      const json = await resp.json().catch(() => ({}));
      if (!resp.ok || !json?.success) throw new Error(json?.message || resp.statusText || 'load failed');
      const d = json.data || {};
      setVal('ssCompanyId', d.companyId || d.CompanyId || cid);
      setVal('ssShortName', d.shortName || d.ShortName || '');
      setVal('ssCompanyName', d.companyName || d.CompanyName || '');
      setChecked('ssSys1', d.sys_1 ?? d.Sys_1);
      setChecked('ssSys2', d.sys_2 ?? d.Sys_2);
      setChecked('ssSys3', d.sys_3 ?? d.Sys_3);
      setChecked('ssSys4', d.sys_4 ?? d.Sys_4);
      setChecked('ssSys5', d.sys_5 ?? d.Sys_5);
      setChecked('ssSys6', d.sys_6 ?? d.Sys_6);
      setChecked('ssSys7', d.sys_7 ?? d.Sys_7);
      setChecked('ssSys8', d.sys_8 ?? d.Sys_8);
      setChecked('ssSys9', d.sys_9 ?? d.Sys_9);

      const sys8Row = document.getElementById('ssSys8Row');
      const sys9Row = document.getElementById('ssSys9Row');
      const showSys8 = Number(d.sys_8 ?? d.Sys_8 ?? 0) === 1 || Number('@Model.SystemId') === 8;
      const showSys9 = !!(d.hasSystem9 ?? d.HasSystem9 ?? true);
      sys8Row?.classList.toggle('d-none', !showSys8);
      sys9Row?.classList.toggle('d-none', !showSys9);
    } catch (err) {
      alert('讀取檢視身分失敗：' + err);
    }

    modal.show();
  });
  const navState = { companyIds: null };
  const updateDetailCount = async () => {
    const ids = await fetchNavCompanyIds();
    const total = Array.isArray(ids) ? ids.length : 0;
    const cur = String(currentCompany || '').trim();
    const idx = total > 0 ? Math.max(0, ids.findIndex(x => x === cur)) + 1 : 0;
    if (detailCountText) detailCountText.textContent = `${idx} / ${total}`;
  };
  const fetchNavCompanyIds = async () => {
    if (Array.isArray(navState.companyIds) && navState.companyIds.length > 0) return navState.companyIds;
    const sysId = Number('@Model.SystemId');
    const subSysId = Number('@Model.SubSystemId');
    try {
      const rows = await fetch('/api/CommonTable/TopRows?table=AJNdCompanySystem&top=50000')
        .then(r => r.ok ? r.json() : []);
      const list = Array.isArray(rows) ? rows : [];
      const set = new Set();
      list.forEach(r => {
        const sid = Number(r?.SystemId ?? r?.systemId ?? 0);
        const ssid = Number(r?.SubSystemId ?? r?.subSystemId ?? 0);
        const cid = String(r?.CompanyId ?? r?.companyId ?? '').trim();
        if (!cid) return;
        if (sid !== sysId) return;
        if (subSysId > 0 && ssid !== subSysId) return;
        set.add(cid);
      });
      navState.companyIds = Array.from(set).sort((a, b) => a.localeCompare(b));
    } catch {
      navState.companyIds = [];
    }
    return navState.companyIds;
  };
  const gotoCompany = (cid) => {
    if (!cid) return;
    const u = new URL(window.location.href);
    u.searchParams.set('CompanyId', cid);
    u.searchParams.set('systemId', String('@Model.SystemId'));
    window.location.href = u.toString();
  };
  const moveNav = async (mode) => {
    const ids = await fetchNavCompanyIds();
    if (!Array.isArray(ids) || ids.length === 0) return;
    const cur = String(currentCompany || '').trim();
    let idx = ids.findIndex(x => x === cur);
    if (idx < 0) idx = 0;
    if (mode === 'first') idx = 0;
    else if (mode === 'prev') idx = Math.max(0, idx - 1);
    else if (mode === 'next') idx = Math.min(ids.length - 1, idx + 1);
    else if (mode === 'last') idx = ids.length - 1;
    gotoCompany(ids[idx]);
  };
  navFirst?.addEventListener('click', () => moveNav('first'));
  navPrev?.addEventListener('click', () => moveNav('prev'));
  navNext?.addEventListener('click', () => moveNav('next'));
  navLast?.addEventListener('click', () => moveNav('last'));
  updateDetailCount();

  const loadAllTabs = () => {
    tabs.forEach(btn => {
      const key = btn.dataset.tabKey || btn.dataset.tab || btn.id?.replace('tab-','').replace('-tab','');
      if (key && currentCompany) loadTabData(key, currentCompany);
    });
    setTimeout(() => initAllTabGridResizers(), 0);
  };
  (async () => {
    if (!currentCompany) return;
    await renderForm('master', '@(cfg?.MasterDict ?? cfg?.MasterTable ?? string.Empty)', '@(cfg?.MasterTable ?? string.Empty)', currentCompany, []);
    setFormMode('master', !!formEditMode);
    loadAllTabs();
    initAllTabGridResizers();
  })();

  const setDictTarget = (dictName) => {
    if (!dictName) return;
    window._dictTableName = dictName;
  };

  // ??澈??澈???憸脣???
  setDictTarget('@(cfg?.MasterDict ?? cfg?.MasterTable ?? string.Empty)');

  document.addEventListener('click', (ev) => {
    const formArea = ev.target.closest('.mf-container[data-dict-table]');
    if (formArea?.dataset?.dictTable) {
      if (formArea.dataset.formKey) currentFormKey = formArea.dataset.formKey;
      setDictTarget(formArea.dataset.dictTable);
      return;
    }
    const tabBtn = ev.target.closest('button[data-bs-toggle="tab"][data-dict]');
    if (tabBtn?.dataset?.dict) {
      setDictTarget(tabBtn.dataset.dict);
      return;
    }
    const grid = ev.target.closest('table[data-dict-name], table[data-table-name]');
    if (grid) {
      setDictTarget(grid.dataset.dictName || grid.dataset.tableName);
    }
  });

  document.addEventListener('keydown', (ev) => {
    if (ev.key !== 'Delete') return;
    const el = ev.target;
    if (!(el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement || el instanceof HTMLSelectElement)) return;
    if (!el.closest('.ccs-detail-page')) return;
    if (el.readOnly || el.disabled) return;
    if (!el.classList.contains('mf-edit') && !el.classList.contains('mf-lk-edit-name') && !el.classList.contains('cell-edit')) return;
    ev.preventDefault();
    if (el instanceof HTMLInputElement && el.type === 'checkbox') {
      el.checked = false;
      return;
    }
    if (el instanceof HTMLSelectElement) {
      if (!Array.from(el.options || []).some(o => o.value === '')) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '';
        el.insertBefore(opt, el.firstChild);
      }
      el.value = '';
      el.dispatchEvent(new Event('input', { bubbles: true }));
      el.dispatchEvent(new Event('change', { bubbles: true }));
      return;
    }
    el.value = '';
    el.dispatchEvent(new Event('input', { bubbles: true }));
    el.dispatchEvent(new Event('change', { bubbles: true }));
  });
});
</script>
<style>
.ccs-detail-wrapper {
  height: calc(100vh - var(--app-toolbar-height, 56px));
  display: flex;
  flex-direction: column;
}
.ccs-detail-wrapper > .card {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}
.ccs-detail-wrapper > .card > .card-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
  padding: 0 8px;
}
.ccs-detail-page {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
  --top-toolbar-icon-font-size: 26px;
  --top-toolbar-font-size: 15px;
  --top-toolbar-btn-height: 30px;
  --field-border: #b9c7de;
  --panel-border: #d8e0ee;
  --panel-bg: #edf2fb;
  --tab-bg: #eef3ff;
  --tab-active: #ffffff;
  --tab-active-border: #9fb3d8;
  --label-color: #1d3b6b;
}
.ccs-detail-page .top-toolbar {
  display: flex !important;
  align-items: center !important;
  gap: 6px !important;
  flex-wrap: wrap !important;
  width: 100% !important;
  margin: 0 !important;
  border-radius: 10px !important;
  background: #f6f7f9 !important;
  border: 1px solid #d8dee8 !important;
  padding: 4px 8px !important;
  box-shadow: 0 1px 2px rgba(20,40,80,0.06) !important;
  box-sizing: border-box !important;
}
.ccs-detail-page .singlegrid-toolbar {
  --top-toolbar-icon-font-size: 20px;
}
.ccs-detail-page .top-toolbar .toolbar-icon-row {
  display: flex !important;
  gap: 4px !important;
  align-items: center !important;
}
.ccs-detail-page .top-toolbar .toolbar-main {
  display: flex !important;
  align-items: center !important;
  gap: 6px !important;
  flex-wrap: nowrap !important;
  flex: 1 1 auto !important;
  min-width: 0 !important;
}
.ccs-detail-page .top-toolbar .toolbar-main > .d-flex {
  min-width: 0 !important;
  flex-wrap: wrap !important;
}
.ccs-detail-page .toolbar-count-box {
  display: inline-flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: var(--top-toolbar-btn-height, 36px);
  min-width: 74px;
  padding: 2px 8px;
  border-radius: 6px;
  font-weight: 700;
  line-height: 1.05;
  color: #fff;
  user-select: none;
}
.ccs-detail-page .toolbar-count-box .count-line { font-size: .75rem; }
.ccs-detail-page .toolbar-count-box.mode-view { background: #1e4db7; }
.ccs-detail-page .toolbar-count-box.mode-edit { background: #f00000; }
.ccs-detail-page .toolbar-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  background: #fff;
  color: #2a4a7a;
  border: 1px solid #b9c7de;
  border-radius: 11px;
  font-size: var(--top-toolbar-font-size);
  font-weight: 500;
  cursor: pointer;
  box-shadow: none;
  transition: background .18s, transform .11s, border-color .18s, color .18s;
  height: var(--top-toolbar-btn-height);
  min-height: var(--top-toolbar-btn-height);
  line-height: 1;
  padding: 0 6px;
  text-decoration: none;
}
.ccs-detail-page .toolbar-btn i {
  font-size: 1.08em;
}
.ccs-detail-page .toolbar-btn:hover,
.ccs-detail-page .toolbar-btn:focus {
  background: #eef3fb;
  border-color: #9fb2d2;
  transform: translateY(-1px) scale(1.02);
}
.ccs-detail-page .toolbar-btn:disabled {
  background: #f1f3f7 !important;
  border-color: #c5ccd8 !important;
  color: #9aa7bb !important;
  cursor: not-allowed;
  box-shadow: none;
  opacity: 0.8;
}
.ccs-detail-page .toolbar-btn-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: var(--top-toolbar-btn-height);
  min-height: var(--top-toolbar-btn-height);
  padding: 0;
  width: 30px;
  border-radius: 8px;
  font-size: var(--top-toolbar-icon-font-size);
  line-height: 1;
  background: #fff;
  border: 1px solid #b9c7de;
  color: #2a4a7a;
}
.ccs-detail-page .toolbar-btn.primary {
  background: #2564b3;
  border-color: #2564b3;
  color: #fff;
}
.ccs-detail-page .toolbar-btn.success {
  border-color: #9fd6b3;
  color: #1f7a45;
}
.ccs-detail-page .ccs-panel {
  flex: 1 1 auto;
  min-height: 0;
  border: none;
  border-radius: 0;
  background: transparent;
  box-shadow: none;
  margin-top: 2px !important;
}
.ccs-detail-page .ccs-panel > .p-1 {
  display: flex;
  flex-direction: column;
  min-height: 0;
  height: 100%;
  padding: 0 !important;
}
.ccs-detail-page .ccs-tabs {
  margin-top: 2px;
  margin-bottom: 0;
  display: flex !important;
  gap: 2px;
  flex-wrap: nowrap;
  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;
  border: 1px solid #cfd7e6;
  border-bottom: none;
  border-radius: 8px 8px 0 0;
  padding: 2px 4px 0;
  background: #edf2fb;
  box-shadow: none;
}
.ccs-detail-page .ccs-tabs .nav-item {
  flex: 0 0 auto;
  display: block !important;
}
.ccs-detail-page .ccs-tabs .nav-link {
  display: inline-flex !important;
  align-items: center;
  height: 26px;
  line-height: 1.15;
  padding: 3px 10px;
  font-size: 0.82rem;
  font-weight: 600;
  color: #204a87;
  border: 1px solid transparent;
  border-radius: 6px;
  background: transparent;
}
.ccs-detail-page .ccs-tabs .nav-link.active {
  color: #111827;
  background: var(--tab-active);
  border-color: #b9c7de #b9c7de #edf2fb;
  font-weight: 700;
}
.ccs-detail-page .ccs-form {
  flex: 1 1 auto;
  min-height: 0;
  overflow: auto;
  border: 1px solid #cfd7e6;
  border-top: none;
  border-radius: 0 0 8px 8px;
  background: #fff;
  box-shadow: none;
  padding: 4px 8px 8px 8px;
}
.ccs-detail-page .tab-pane {
  padding: 0;
}
.ccs-detail-page .mf-container {
  min-height: 180px;
  padding: 0;
  border: none;
  border-radius: 0;
  background: transparent;
}
.ccs-detail-page .tab-pane[data-form="1"] > .mf-container {
  border: none;
  border-radius: 0;
  background: transparent;
}
.ccs-detail-page #cc000054-master-form {
  min-height: 190px !important;
  border: 1px solid var(--panel-border);
  border-radius: 8px;
  background: var(--panel-bg);
  box-shadow: none;
  margin-bottom: 2px;
}
.ccs-detail-page .mf-label {
  font-size: 13px !important;
  font-weight: 400 !important;
  color: var(--label-color);
}
.ccs-detail-page .mf-field .mf-view,
.ccs-detail-page .mf-field .mf-edit {
  box-sizing: border-box;
  border-radius: 0 !important;
  font-size: 13px !important;
}
.ccs-detail-page .mf-field .mf-view {
  padding: 0 4px !important;
  border: 1px solid var(--field-border) !important;
  background: #fff !important;
  color: #0f172a;
}
.ccs-detail-page .mf-field .mf-view.mf-lk-view {
  display: grid !important;
  grid-template-columns: minmax(52px, 38%) 1fr;
  gap: 0;
  padding: 0 !important;
}
.ccs-detail-page .mf-lk-view .mf-lk-code,
.ccs-detail-page .mf-lk-view .mf-lk-name {
  display: block;
  min-height: 100%;
  line-height: 18px;
  padding: 0 4px;
  border: none;
}
.ccs-detail-page .mf-lk-view .mf-lk-code {
  border-right: 1px solid var(--field-border);
}
.ccs-detail-page .mf-field .mf-edit.mf-input {
  padding: 0 6px !important;
  border: 1px solid var(--field-border) !important;
  background: #fff !important;
  color: #0f172a !important;
  box-shadow: none !important;
}
.ccs-detail-page .mf-field .mf-lk-edit-name {
  padding: 0 6px !important;
  border: 1px solid var(--field-border) !important;
  border-left: none !important;
  border-radius: 0 !important;
  font-size: 12px !important;
  background: #f8faff !important;
  color: #0f172a !important;
  box-shadow: none !important;
}
.ccs-detail-page .mf-field .mf-edit.mf-input:focus {
  border-color: #5b8def !important;
  box-shadow: 0 0 0 2px rgba(91, 141, 239, 0.15) !important;
}
.ccs-detail-page .tab-local-controls {
  display: none !important;
}
.ccs-detail-page .ccs-subgrid-box {
  border: 1px solid #cfd7e6;
  border-radius: 8px;
  background: #f8fbff;
  padding: 4px 4px 2px;
}
.ccs-detail-page .tab-icon-toolbar {
  display: flex;
  gap: 4px;
  align-items: center;
  margin: 0 0 4px 0;
}
.ccs-detail-page .tab-icon-toolbar .btn-icon {
  width: 30px;
  height: 30px;
  min-height: 30px;
  padding: 0;
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}
.ccs-detail-page .tab-icon-toolbar .btn-icon i { font-size: 16px; }
.ccs-detail-page .tab-icon-toolbar .ccs-tool-add { color: #118a3f; border-color: #9fd6b3; }
.ccs-detail-page .tab-icon-toolbar .ccs-tool-del { color: #cc3a3a; border-color: #efb3b3; }
.ccs-detail-page .tab-icon-toolbar .ccs-tool-save { color: #1d62d8; border-color: #abc4f8; }
.ccs-detail-page .tab-icon-toolbar .ccs-tool-cancel { color: #6b7280; border-color: #d1d5db; }
.ccs-detail-page .tab-icon-toolbar .ccs-tool-refresh { color: #2a4a7a; border-color: #b9c7de; }
.ccs-detail-page .tab-icon-toolbar .btn-icon:disabled {
  opacity: .45;
  cursor: not-allowed;
}
.ccs-detail-page .tab-icon-toolbar .ccs-tool-text {
  height: 30px;
  min-height: 30px;
  padding: 0 10px;
  border-radius: 8px;
  font-size: 13px;
  line-height: 1;
  color: #2a4a7a;
  border-color: #b9c7de;
  background: #fff;
}
.ccs-detail-page .tab-icon-toolbar .ccs-tool-text:hover {
  background: #f8fbff;
}
.ccs-detail-page .table-responsive {
  border: 1px solid #cfd7e6;
  border-radius: 0;
  background: #fff;
  padding: 0;
}
.ccs-detail-page .table tbody td {
  border-color: #cfd7e6 !important;
}
.ccs-detail-page .table tbody tr.selected td,
.ccs-detail-page .table tbody tr.table-active td {
  background: #dbeafe !important;
}
.ccs-detail-page .table {
  border: 1px solid #cfd7e6;
  border-radius: 0 !important;
  margin-bottom: 0;
  table-layout: fixed;
  font-size: 0.85rem;
}
.ccs-detail-page .table thead th {
  background: #f2f6ff;
  color: #204a87;
  border-color: #b7c2d4 !important;
  border-bottom: 1px solid #b7c2d4 !important;
  border-right: 1px solid #b7c2d4 !important;
  padding: 3px 6px !important;
  position: relative;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: clip;
}
.ccs-detail-page .table tbody td {
  border-top: 1px solid #c4cede !important;
  border-bottom: 1px solid #c4cede !important;
  border-right: 1px solid #c4cede !important;
  padding: 2px 4px !important;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: clip;
}
.ccs-detail-page .table thead th:last-child,
.ccs-detail-page .table tbody td:last-child {
  border-right: none !important;
}
.ccs-detail-page .table thead th .col-resizer {
  position: absolute;
  top: 0;
  right: -3px;
  width: 6px;
  height: 100%;
  cursor: col-resize;
  user-select: none;
}
.ccs-detail-page .table thead th .col-resizer::after {
  content: '';
  position: absolute;
  left: 2px;
  top: 2px;
  bottom: 2px;
  width: 1px;
  background: transparent;
}
.ccs-detail-page .table thead th:hover .col-resizer::after {
  background: rgba(31, 61, 120, 0.35);
}
/* Sub-grid style aligned with MatInfo customer-part table */
.ccs-detail-page .ccs-subgrid-wrap {
  border: 1px solid #d8e0ee;
  border-radius: 0;
  background: #fff;
  overflow: auto;
}
.ccs-detail-page .ccs-subgrid-table {
  width: max-content;
  min-width: 0;
  border-collapse: collapse;
  font-size: 0.82rem;
  table-layout: fixed;
}
.ccs-detail-page .ccs-subgrid-table thead th {
  background: #f2f6ff;
  color: #204a87;
  text-align: left;
  padding: 3px 6px !important;
  border-bottom: 1px solid #b7c2d4 !important;
  border-right: 1px solid #b7c2d4 !important;
  white-space: nowrap;
  height: 26px;
  position: relative;
}
.ccs-detail-page .ccs-subgrid-table thead th:last-child {
  border-right: none !important;
}
.ccs-detail-page .ccs-subgrid-table tbody td {
  padding: 2px 6px !important;
  border-bottom: 1px solid #c4cede !important;
  border-right: 1px solid #c4cede !important;
  border-top: 1px solid #c4cede !important;
  white-space: nowrap;
  height: 24px;
}
.ccs-detail-page .ccs-subgrid-table tbody td:last-child {
  border-right: none !important;
}
.ccs-detail-page .ccs-subgrid-table tbody tr:hover {
  background: #f9fbff;
}
.ccs-detail-page .ccs-subgrid-table .cell-view {
  display: block;
  width: 100%;
  border: none !important;
  background: transparent !important;
  padding: 0 !important;
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: clip;
}
.ccs-detail-page .ccs-subgrid-table .cell-edit {
  width: 100%;
  height: 22px;
  min-height: 22px;
  padding: 1px 4px;
  border: 1px solid #cfd7e6;
  border-radius: 4px;
  background: #fff;
  font-size: 0.82rem;
}
.ccs-detail-page .ccs-subgrid-table thead th .col-resizer {
  position: absolute;
  top: 0;
  right: -2px;
  width: 6px;
  height: 100%;
  cursor: col-resize;
  user-select: none;
}
.ccs-detail-page .ccs-subgrid-table thead th .col-resizer::after {
  content: "";
  position: absolute;
  top: 20%;
  right: 2px;
  width: 1px;
  height: 60%;
  background: #c7d3e6;
  opacity: 0;
  transition: opacity 0.12s;
}
.ccs-detail-page .ccs-subgrid-table thead th:hover .col-resizer::after {
  opacity: 1;
}
body.ccs-editing .ccs-detail-page .ccs-tabs .nav-link.active {
  background: #1e4db7;
  color: #fff;
  border-color: #1e4db7;
}
body.ccs-editing .ccs-detail-page .mf-container[data-editing="1"] .mf-edit:not([readonly]):not([disabled]),
body.ccs-editing .ccs-detail-page .mf-container[data-editing="1"] .mf-lk-edit-name:not([readonly]):not([disabled]) {
  background: #fff7cc !important;
  border-color: #f59e0b !important;
}
.ss-check-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 4px;
  padding: 4px 0;
}
.ss-check-grid label {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0;
  font-size: 14px;
}
#cc000054DetailAddModal .modal-dialog {
  max-width: 340px;
}
#cc000054DetailAddModal .modal-content {
  border-radius: 4px;
  border: 1px solid #b8b8b8;
  box-shadow: 0 8px 24px rgba(0,0,0,0.18);
}
#cc000054DetailAddModal .modal-header {
  padding: 8px 10px;
}
#cc000054DetailAddModal .modal-title {
  font-size: 16px;
  font-weight: 500;
}
.ccs-add-modal-body {
  padding: 10px 10px 8px;
}
.ccs-add-row {
  display: grid;
  grid-template-columns: 72px 1fr;
  gap: 6px;
  align-items: center;
  margin-bottom: 6px;
}
.ccs-add-label {
  text-align: right;
  margin: 0;
  font-size: 14px;
}
.ccs-add-inline {
  display: grid;
  grid-template-columns: 1fr 100px;
  gap: 6px;
}
.ccs-add-code-select,
.ccs-add-short,
#detailAddCompanyName {
  height: 28px;
  border-radius: 0;
  font-size: 14px;
}
#cc000054DetailAddModal .modal-footer {
  padding: 6px 10px 10px;
  border-top: 0;
}
#cc000054DetailAddModal .modal-footer .btn {
  min-width: 72px;
  border-radius: 2px;
}
#cc000054DetailQueryModal .modal-dialog {
  max-width: 620px;
}
#cc000054DetailQueryModal .form-control-sm,
#cc000054DetailQueryModal .form-select-sm {
  height: 32px;
}
#cc000054DetailQueryModal .modal-footer .btn {
  min-width: 72px;
}
.ccs-query-modal-body {
  padding: 10px 12px 6px;
}
.ccs-query-grid {
  display: grid;
  grid-template-columns: 170px 1fr;
  gap: 8px 10px;
  align-items: center;
}
.ccs-query-label {
  text-align: right;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.2;
}
.ccs-query-inline3 {
  display: grid;
  grid-template-columns: 110px minmax(0, 1fr);
  gap: 6px;
}
</style>
<script src="~/js/ccsUpdateLog.js" asp-append-version="true"></script>

<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>
