@model dynamic

<div class="action-rail">
  <!-- 原有按鈕 -->
  <button type="button" class="fab" data-action="importOrder">匯入訂單</button>
  <button type="button" class="fab" data-action="recalc">重算</button>
  <button type="button" class="fab" data-action="lock">Lock</button>
  <button type="button" class="fab fab-red" data-action="clearDetails" id="btnClearDetails">清除單身</button>
  <button type="button" class="fab" data-action="toIssue">轉領料單</button>
  <button type="button" class="fab" data-action="print">列印工單</button>
  <button type="button" class="fab" data-action="unlock">解除Lock</button>

  <!-- 新增：功能展開按鈕 (移到最下面) -->
  <button type="button" class="fab fab-blue fab-menu-toggle" id="btnMenuToggle">
    <span class="menu-text">⚙️ 功能</span>
    <span class="arrow">▼</span>
  </button>
  <div class="fab-submenu" id="fabSubmenu">
    <button type="button" class="fab fab-sub" data-action="test1">功能 1</button>
    <button type="button" class="fab fab-sub" data-action="test2">功能 2</button>
    <button type="button" class="fab fab-sub" data-action="test3">功能 3</button>
    <button type="button" class="fab fab-sub" data-action="test4">功能 4</button>
    <button type="button" class="fab fab-sub" data-action="test5">功能 5</button>
    <button type="button" class="fab fab-sub" data-action="test6">功能 6</button>
    <button type="button" class="fab fab-sub" data-action="test7">功能 7</button>
    <button type="button" class="fab fab-sub" data-action="test8">功能 8</button>
  </div>
</div>

<style>
/* 功能選單樣式 */
.fab-menu-toggle {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: space-between;
  /* 確保與其他按鈕一致的樣式 */
  min-width: var(--fab-width);
  padding: 10px 12px;
  font-weight: 700;
  border-radius: 10px;
  box-shadow: 0 6px 16px rgba(0,0,0,.2);
}

.fab-menu-toggle .menu-text {
  flex: 0 1 auto;
  text-align: left;
  white-space: nowrap;
}

.fab-menu-toggle .arrow {
  display: inline-block;
  transition: transform 0.3s ease;
  font-size: 0.85em; /* 調整前: 1em (約16px) → 調整後: 0.85em (約13.6px) */
  margin-left: auto;
  padding-left: 6px;
  flex-shrink: 0;
}

.fab-menu-toggle.open .arrow {
  transform: rotate(180deg);
}

.fab-submenu {
  display: none;
  flex-direction: column;
  gap: 8px;
  padding-left: 0;
  margin-left: 0;
}

.fab-submenu.open {
  display: flex;
  margin-top: 8px;
  margin-bottom: 0;
}

.fab-sub {
  /* 與主按鈕保持相同的基礎樣式 */
  position: relative;
  min-width: 88px;
  padding: 7px 10px;
  font-size: 0.9em;
  font-weight: 600;
  background: #5a9bd5;
  color: #fff;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,.15);
  border: 0;
  transition: all 0.18s;
}

.fab-sub:hover {
  filter: brightness(1.05);
  transform: translateY(-1px);
  box-shadow: 0 6px 14px rgba(0,0,0,.2);
}
</style>

<script>
// 功能選單展開/收合
document.getElementById('btnMenuToggle')?.addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();

  const submenu = document.getElementById('fabSubmenu');
  const toggle = this;

  if (submenu.classList.contains('open')) {
    submenu.classList.remove('open');
    toggle.classList.remove('open');
  } else {
    submenu.classList.add('open');
    toggle.classList.add('open');
  }
});

// 測試按鈕的處理
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.fab-sub[data-action^="test"]');
  if (!btn) return;

  const action = btn.dataset.action;
  Swal.fire({
    icon: 'info',
    title: '測試按鈕',
    text: `你點擊了：${btn.textContent.trim()}`
  });
});
</script>

<script>
// ---- 共用：狀態名稱對照與抓狀態碼（先 DOM，抓不到才打 API） ----
function statusName(code){
  const map = {0:'作業中', 1:'已確認', 2:'作廢中', 4:'已結案'}; // 依你實際定義調整
  return map[Number(code)] ?? `代碼:${code}`;
}

async function getStatusCode(paperNum){
  // 嘗試從頁面讀 hidden/input
  const el = document.querySelector('[name="Finished"],[data-bind="Finished"],[name="Status"],[data-bind="Status"]');
  const v  = el?.value ?? el?.textContent;
  const n  = Number(v);
  if (Number.isFinite(n)) return n;

  // 撈不到再打單頭 API
  const r = await fetch(`/api/FMEdIssueMain/${encodeURIComponent(paperNum)}`);
  if (!r.ok) return null;
  const m = await r.json();
  const code = m.Finished ?? m.Status;
  return (code === undefined || code === null) ? null : Number(code);
}

// ---- 事件代理：所有 action 都走這裡 ----
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.fab[data-action]');
  if (!btn) return;

  const action = btn.dataset.action;

  // 取共同參數
  let paper, paperId;
  try {
    paper   = getPaperNum?.();                                  // 你現有的 helper
    paperId = (PAGE?.detailTable || '').trim().replace(/^dbo\./i, '');
  } catch (err) {
    console.error('[param error]', err);
    return Swal.fire({icon:'error', title:'前端函式未定義', text: String(err)});
  }

  if (!paper)  return Swal.fire({icon:'info',  title:'沒有單號'});
  if (!paperId && action === 'clearDetails') // 清除用得到
    return Swal.fire({icon:'info', title:'缺少單身表名（PaperId）'});

  switch (action) {
    case 'clearDetails': {
      e.preventDefault(); e.stopPropagation();

      // 用「數字狀態碼」判斷是否可清
      const BLOCK_CODES = [1, 2, 3, 4]; // 已確認/作廢中/已審核/已結案（依實際調整）
      const code = await getStatusCode(paper);
      console.log('[status code]', code);

      if (code != null && BLOCK_CODES.includes(code)) {
        return Swal.fire({
          icon:'warning',
          title:'此狀態不可清除',
          html:`單據狀態：<b>${statusName(code)}</b>`
        });
      }

      const { isConfirmed } = await Swal.fire({
        icon:'warning',
        title:'確定要清除這張單的所有單身嗎？',
        html:`單號：<b>${paper}</b><br>表：<code>${paperId}</code>`,
        showCancelButton:true, confirmButtonText:'清除', cancelButtonText:'取消'
      });
      if (!isConfirmed) return;

      try {
        const payload = { Key: 'FMEdIssueClearLayer', Args: { PaperNum: paper } };
        console.log('[fetch] POST /api/StoredProc/exec', payload);

        const resp = await fetch('/api/StoredProc/exec', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const raw = await resp.text();
        console.log('[fetch resp]', resp.status, raw);

        let data; try { data = JSON.parse(raw); } catch { data = { ok:false, error: raw }; }

        if (resp.ok && data.ok) {
          const msg = (data.rows != null) ? `已清除 ${data.rows} 筆` : '清除完成';
          await Swal.fire({icon:'success', title: msg, timer:900, showConfirmButton:false});
          location.reload();
        } else {
          Swal.fire({icon:'error', title:'清除失敗', text: data.error || `HTTP ${resp.status}`});
        }
      } catch (e2) {
        console.error('[fetch error]', e2);
        Swal.fire({icon:'error', title:'網路錯誤', text: String(e2)});
      }
      break;
    }

    case 'importOrder': {
      e.preventDefault(); e.stopPropagation();
      // 開啟 OrderDetailPicker 彈窗（匯入訂單明細）
      const picker = window['OrderDetailPicker_issueDetailPicker'];
      if (!picker) {
        return Swal.fire({icon:'error', title:'找不到匯入視窗', text:'OrderDetailPicker 未載入'});
      }

      // 從單頭取得料號和版序
      let partNum = '';
      let revision = '';
      try {
        // 嘗試從頁面欄位抓取料號和版序（只取 input/textarea/select 的值）
        const partNumEl = document.querySelector('input[name="PartNum"], textarea[name="PartNum"], select[name="PartNum"]');
        const revisionEl = document.querySelector('input[name="Revision"], textarea[name="Revision"], select[name="Revision"]');

        partNum = (partNumEl?.value || '').trim();
        revision = (revisionEl?.value || '').trim();

        console.log('[importOrder] 取得欄位值:', { partNum, revision });
      } catch (err) {
        console.warn('[importOrder] 無法取得料號版序', err);
      }

      picker.open({
        paperNum: paper,
        partNum: partNum.trim(),
        revision: revision.trim()
      });
      break;
    }

    case 'recalc': {
      e.preventDefault(); e.stopPropagation();

      const { isConfirmed } = await Swal.fire({
        icon: 'question',
        title: '確定要重算嗎？',
        html: `單號：<b>${paper}</b>`,
        showCancelButton: true,
        confirmButtonText: '重算',
        cancelButtonText: '取消'
      });

      if (!isConfirmed) return;

      try {
        const payload = {
          Key: 'FMEdIssueTotalPcsDLL',
          Args: {
            DLLPaperNum: paper,
            iNoReComputeBackQnty: 0
          }
        };

        console.log('[重算] POST /api/StoredProc/exec', payload);

        const resp = await fetch('/api/StoredProc/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const raw = await resp.text();
        console.log('[重算 resp]', resp.status, raw);

        let data;
        try { data = JSON.parse(raw); } catch { data = { ok: false, error: raw }; }

        if (resp.ok && data.ok) {
          await Swal.fire({
            icon: 'success',
            title: '重算完成',
            timer: 1500,
            showConfirmButton: false
          });
          location.reload();
        } else {
          Swal.fire({
            icon: 'error',
            title: '重算失敗',
            text: data.error || `HTTP ${resp.status}`
          });
        }
      } catch (e2) {
        console.error('[重算 error]', e2);
        Swal.fire({
          icon: 'error',
          title: '網路錯誤',
          text: String(e2)
        });
      }
      break;
    }

    case 'lock': {
      e.preventDefault(); e.stopPropagation();

      const { isConfirmed } = await Swal.fire({
        icon: 'warning',
        title: '確定要 Lock 嗎？',
        html: `單號：<b>${paper}</b>`,
        showCancelButton: true,
        confirmButtonText: 'Lock',
        cancelButtonText: '取消',
        confirmButtonColor: '#dc3545'
      });

      if (!isConfirmed) return;

      try {
        const payload = {
          Key: 'FMEdIssueLock',
          Args: { PaperNum: paper }
        };

        console.log('[Lock] POST /api/StoredProc/exec', payload);

        const resp = await fetch('/api/StoredProc/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const raw = await resp.text();
        console.log('[Lock resp]', resp.status, raw);

        let data;
        try { data = JSON.parse(raw); } catch { data = { ok: false, error: raw }; }

        if (resp.ok && data.ok) {
          await Swal.fire({
            icon: 'success',
            title: 'Lock 完成',
            timer: 1500,
            showConfirmButton: false
          });
          location.reload();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Lock 失敗',
            text: data.error || `HTTP ${resp.status}`
          });
        }
      } catch (e2) {
        console.error('[Lock error]', e2);
        Swal.fire({
          icon: 'error',
          title: '網路錯誤',
          text: String(e2)
        });
      }
      break;
    }

    case 'unlock': {
      e.preventDefault(); e.stopPropagation();

      const { isConfirmed } = await Swal.fire({
        icon: 'question',
        title: '確定要解除 Lock 嗎？',
        html: `單號：<b>${paper}</b>`,
        showCancelButton: true,
        confirmButtonText: '解除 Lock',
        cancelButtonText: '取消'
      });

      if (!isConfirmed) return;

      try {
        const payload = {
          Key: 'FMEdIssueUnLock',
          Args: { PaperNum: paper }
        };

        console.log('[解除Lock] POST /api/StoredProc/exec', payload);

        const resp = await fetch('/api/StoredProc/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const raw = await resp.text();
        console.log('[解除Lock resp]', resp.status, raw);

        let data;
        try { data = JSON.parse(raw); } catch { data = { ok: false, error: raw }; }

        if (resp.ok && data.ok) {
          await Swal.fire({
            icon: 'success',
            title: '解除 Lock 完成',
            timer: 1500,
            showConfirmButton: false
          });
          location.reload();
        } else {
          Swal.fire({
            icon: 'error',
            title: '解除 Lock 失敗',
            text: data.error || `HTTP ${resp.status}`
          });
        }
      } catch (e2) {
        console.error('[解除Lock error]', e2);
        Swal.fire({
          icon: 'error',
          title: '網路錯誤',
          text: String(e2)
        });
      }
      break;
    }

    case 'toIssue':
    case 'print': {
      Swal.fire({ icon:'info', title:'尚未實作', text:`功能：${action}` });
      break;
    }
  }
});
</script>
