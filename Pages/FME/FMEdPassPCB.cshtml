@page "/FMEdPassPCB"
@model PcbErpApi.Pages.FME.FMEdPassPCBModel
@{
    ViewData["Title"] = "單批過帳";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<div class="pass-pcb-container">
    <!-- 頂部工具列 -->
    <div class="toolbar-section">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-success btn-sm" id="btnConfirm" title="確認過帳">
                <i class="bi bi-check-lg"></i> 確 認
            </button>
            <button type="button" class="btn btn-secondary btn-sm" id="btnCancel" title="取消">
                <i class="bi bi-x-lg"></i> 取消
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnRefresh" title="重新整理">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
        <div class="btn-group me-2">
            <button type="button" class="btn btn-outline-info btn-sm" id="btnShowAttachment" title="顯示附件">
                <i class="bi bi-paperclip"></i> 顯示附件
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" id="btnImportParam" title="匯入參數明細">
                <i class="bi bi-download"></i> 匯入參數明細
            </button>
        </div>
        <div class="paper-info ms-auto">
            <span class="me-3"><strong>單號：</strong><span id="lblPaperNum">@Model.PaperNum</span></span>
            <span><strong>項次：</strong><span id="lblItem">1</span></span>
        </div>
    </div>

    <!-- 頁籤區域 -->
    <ul class="nav nav-tabs" id="passPcbTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-lot" data-bs-toggle="tab" data-bs-target="#pane-lot" type="button" role="tab">
                單批過帳
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-param" data-bs-toggle="tab" data-bs-target="#pane-param" type="button" role="tab">
                製程參數
            </button>
        </li>
    </ul>

    <div class="tab-content" id="passPcbTabContent">
        <!-- 單批過帳頁籤 -->
        <div class="tab-pane fade show active" id="pane-lot" role="tabpanel">
            <div class="row g-3">
                <!-- 左側：批號資訊區 -->
                <div class="col-md-7">
                    <!-- 批號輸入區 -->
                    <div class="card mb-3">
                        <div class="card-body py-2">
                            <div class="row g-2 align-items-center">
                                <div class="col-auto">
                                    <label class="col-form-label">原始批號</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control form-control-sm" id="txtLotNum" placeholder="輸入批號...">
                                </div>
                                <div class="col-auto">
                                    <button type="button" class="btn btn-primary btn-sm" id="btnImport">
                                        <i class="bi bi-box-arrow-in-down"></i> 匯入
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <span class="text-muted">排 版 數</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 批號詳細資訊 -->
                    <div class="card mb-3">
                        <div class="card-body py-2">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label form-label-sm mb-0">料 號</label>
                                    <input type="text" class="form-control form-control-sm bg-light" id="txtPartNum" readonly>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label form-label-sm mb-0">版 序</label>
                                    <input type="text" class="form-control form-control-sm bg-light" id="txtRevision" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label form-label-sm mb-0">允收X報數</label>
                                    <input type="text" class="form-control form-control-sm bg-warning" id="txtXOutQnty" readonly>
                                </div>
                            </div>
                            <div class="row g-2 mt-1">
                                <div class="col-md-4">
                                    <label class="form-label form-label-sm mb-0">目前製程</label>
                                    <input type="text" class="form-control form-control-sm bg-light" id="txtProcName" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label form-label-sm mb-0">下站製程</label>
                                    <input type="text" class="form-control form-control-sm bg-light" id="txtAftProcName" readonly>
                                </div>
                            </div>
                            <div class="row g-2 mt-1">
                                <div class="col-md-4">
                                    <label class="form-label form-label-sm mb-0">階 段</label>
                                    <input type="text" class="form-control form-control-sm bg-light" id="txtLayerName" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label form-label-sm mb-0">過帳階段</label>
                                    <input type="text" class="form-control form-control-sm bg-light" id="txtAftLayerName" readonly>
                                </div>
                            </div>
                            <div class="row g-2 mt-1">
                                <div class="col-md-4">
                                    <label class="form-label form-label-sm mb-0">型 狀</label>
                                    <input type="text" class="form-control form-control-sm bg-light" id="txtPopName" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label form-label-sm mb-0">過帳型狀</label>
                                    <input type="text" class="form-control form-control-sm bg-light" id="txtAftPopName" readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 數量輸入區 -->
                    <div class="card mb-3">
                        <div class="card-body py-2">
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <label class="form-label form-label-sm mb-0">原始數量</label>
                                    <input type="number" class="form-control form-control-sm bg-light" id="txtQnty" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label form-label-sm mb-0">整報沖銷單報數</label>
                                    <input type="number" class="form-control form-control-sm" id="txtScrapStrXOutQnty" value="0">
                                </div>
                            </div>
                            <div class="row g-2 mt-1">
                                <div class="col-md-3">
                                    <label class="form-label form-label-sm mb-0 text-primary fw-bold">過帳良品數</label>
                                    <input type="number" class="form-control form-control-sm border-primary" id="txtPQnty" value="0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label form-label-sm mb-0 text-danger fw-bold">整片報廢數</label>
                                    <input type="number" class="form-control form-control-sm border-danger" id="txtSQnty" value="0">
                                </div>
                            </div>
                            <div class="row g-2 mt-1">
                                <div class="col-md-3">
                                    <label class="form-label form-label-sm mb-0">產品類別</label>
                                    <input type="text" class="form-control form-control-sm bg-warning" id="txtPoType" readonly>
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-12">
                                    <label class="form-label form-label-sm mb-0">備註</label>
                                    <textarea class="form-control form-control-sm" id="txtNotes" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右側：多報明細區 -->
                <div class="col-md-5">
                    <div class="card h-100">
                        <div class="card-header py-1 d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-list-check"></i> 多報明細檔(單X報廢)</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-success btn-sm" id="btnAddXOut" title="新增">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" id="btnDelXOut" title="刪除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                <table class="table table-sm table-bordered table-hover mb-0" id="tblXOut">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 50px;">項次</th>
                                            <th>數量</th>
                                            <th>原始數量</th>
                                            <th style="width: 80px;">整片報廢</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 動態載入 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 報廢點數明細區 -->
            <div class="card mt-3" id="pnlDefect">
                <div class="card-header py-1 d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-exclamation-triangle"></i> 報廢點數明細</span>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-success btn-sm" id="btnAddDefect" title="新增">
                            <i class="bi bi-plus"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="btnDelDefect" title="刪除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 150px; overflow-y: auto;">
                        <table class="table table-sm table-bordered table-hover mb-0" id="tblDefect">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 50px;">序號</th>
                                    <th>不良類別</th>
                                    <th>不良代碼</th>
                                    <th>責任製程</th>
                                    <th style="width: 80px;">數量</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 動態載入 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 選擇批號區 -->
            <div class="card mt-3">
                <div class="card-header py-1 d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-search"></i> 選擇批號</span>
                    <span class="badge bg-secondary" id="lblBatchInfo">批號</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm table-bordered table-hover mb-0" id="tblSelectLot">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 50px;">項次</th>
                                    <th>批號(F5)</th>
                                    <th>階段</th>
                                    <th>原始數量</th>
                                    <th>過帳數</th>
                                    <th>報廢數</th>
                                    <th>留存數</th>
                                    <th>本站新增單報數</th>
                                    <th>DateCode</th>
                                    <th>完成良品PCS數</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 動態載入 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 製程參數頁籤 -->
        <div class="tab-pane fade" id="pane-param" role="tabpanel">
            <div class="card">
                <div class="card-header py-1 d-flex justify-content-between align-items-center">
                    <div>
                        <label class="me-2">單號</label>
                        <input type="text" class="form-control form-control-sm d-inline-block" style="width: 150px;" id="txtParamPaperNum" readonly>
                        <label class="ms-3 me-2">項次</label>
                        <input type="text" class="form-control form-control-sm d-inline-block" style="width: 80px;" id="txtParamItem" readonly>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="btnParamImport">
                            <i class="bi bi-download"></i> 匯入
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" id="btnParamClear">
                            <i class="bi bi-eraser"></i> 清除
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-bordered table-hover mb-0" id="tblProcParam">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>參數名稱</th>
                                    <th>參數值</th>
                                    <th>單位</th>
                                    <th>備註</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 動態載入 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
<style>
    .pass-pcb-container {
        padding: 10px 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .toolbar-section {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 10px;
    }

    .paper-info {
        font-size: 0.9rem;
    }

    .form-label-sm {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .card-header {
        background-color: #f8f9fa;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .table th {
        font-size: 0.8rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .table td {
        font-size: 0.85rem;
        vertical-align: middle;
    }

    .table tbody tr:hover {
        background-color: #e7f1ff;
    }

    .table tbody tr.selected {
        background-color: #cfe2ff;
    }

    .nav-tabs .nav-link {
        font-size: 0.9rem;
        padding: 0.4rem 1rem;
    }

    .form-control-sm {
        font-size: 0.85rem;
    }

    #txtLotNum {
        background-color: #fffacd;
    }

    .bg-warning {
        background-color: #fff3cd !important;
    }

    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 1;
    }
</style>
}

@section Scripts {
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    // 全域變數 - 作業型畫面，不預先建立單號
    let lotInfo = null;  // 匯入的批號資訊
    let currentUserId = '@Model.UserId';

    $(document).ready(function () {
        // 初始化
        initPage();
        // 事件綁定
        bindEvents();
    });

    function initPage() {
        // 作業型畫面：進入時清空表單，等待使用者輸入批號
        clearForm();
        $('#txtLotNum').focus();
    }

    function bindEvents() {
        // 匯入按鈕
        $('#btnImport').click(function () {
            importLot();
        });

        // 批號輸入框 Enter
        $('#txtLotNum').keydown(function (e) {
            if (e.keyCode === 13) {
                e.preventDefault();
                importLot();
            }
        });

        // 確認過帳
        $('#btnConfirm').click(function () {
            executePass();
        });

        // 取消 (清除表單)
        $('#btnCancel').click(function () {
            if (lotInfo && confirm('確定要取消並清除目前資料嗎？')) {
                clearForm();
                $('#txtLotNum').focus();
            }
        });

        // 新增多報明細
        $('#btnAddXOut').click(function () {
            addXOutRow();
        });

        // 刪除多報明細
        $('#btnDelXOut').click(function () {
            deleteSelectedXOut();
        });

        // 新增報廢明細
        $('#btnAddDefect').click(function () {
            addDefectRow();
        });

        // 刪除報廢明細
        $('#btnDelDefect').click(function () {
            deleteSelectedDefect();
        });

        // 表格行選擇
        $('#tblXOut tbody, #tblDefect tbody, #tblSelectLot tbody').on('click', 'tr', function () {
            $(this).siblings().removeClass('selected');
            $(this).addClass('selected');
        });

        // 數量變更自動計算
        $('#txtPQnty, #txtSQnty').change(function () {
            calculateQuantities();
        });
    }

    // 匯入批號 - 查詢批號資訊並顯示
    function importLot() {
        let lotNum = $('#txtLotNum').val().trim();
        if (!lotNum) {
            alert('請輸入批號');
            $('#txtLotNum').focus();
            return;
        }

        // 呼叫 API 查詢批號資訊
        $.ajax({
            url: '/api/FMEdPassPCB/lotinfo',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                lotNum: lotNum,
                userId: currentUserId
            }),
            success: function (resp) {
                if (resp.success && resp.lotInfo) {
                    lotInfo = resp.lotInfo;
                    fillLotInfo(resp.lotInfo);
                    $('#txtPQnty').focus();
                } else {
                    alert(resp.message || '無此批號!!');
                    $('#txtLotNum').focus().select();
                }
            },
            error: function (xhr) {
                alert('查詢失敗: ' + (xhr.responseJSON?.message || xhr.responseText));
                $('#txtLotNum').focus().select();
            }
        });
    }

    // 填入批號資訊到表單
    // FMEdPassChoiceLotPCB SP 回傳欄位:
    // LotNum, PartNum, Revision, ProcCode, LayerId, POP, Qnty, StockId,
    // AftProc, AftLayer, AftPOP, PQnty, SQnty, UQnty,
    // IsShowPQnty, IsXOut, AftProcType, POType, DateCode, GoodPCS, etc.
    function fillLotInfo(info) {
        // Debug: 顯示所有回傳欄位
        console.log('=== lotInfo 回傳資料 (from FMEdPassChoiceLotPCB) ===');
        console.log(JSON.stringify(info, null, 2));
        console.log('所有欄位名稱:', Object.keys(info));

        // 使用忽略大小寫的方式取值
        function getVal(obj, key) {
            if (!obj) return '';
            var lowerKey = key.toLowerCase();
            for (var k in obj) {
                if (k.toLowerCase() === lowerKey) return obj[k] || '';
            }
            return '';
        }
        function getNumVal(obj, key) {
            var v = getVal(obj, key);
            return v === '' ? 0 : parseFloat(v) || 0;
        }
        function getIntVal(obj, key) {
            var v = getVal(obj, key);
            return v === '' ? 0 : parseInt(v) || 0;
        }

        // 料號、版序 (SP 回傳: PartNum, Revision)
        $('#txtPartNum').val(getVal(info, 'PartNum') || getVal(info, 'PartNo'));
        $('#txtRevision').val(getVal(info, 'Revision') || getVal(info, 'Rev') || getVal(info, 'RevNum'));

        // 目前製程 (SP 回傳: ProcCode, 需透過 Lookup 取得 ProcName)
        // SP 本身可能不會回傳 ProcName，但會回傳 ProcCode
        var procCode = getVal(info, 'ProcCode');
        var procName = getVal(info, 'ProcName') || procCode;
        $('#txtProcName').val(procName);

        // 下站製程 (SP 回傳: AftProc, AftProcName 透過 Lookup)
        var aftProc = getVal(info, 'AftProc');
        var aftProcName = getVal(info, 'AftProcName') || aftProc;
        $('#txtAftProcName').val(aftProcName);

        // 階段 (SP 回傳: LayerId, LayerName 透過 Lookup)
        var layerId = getVal(info, 'LayerId');
        var layerName = getVal(info, 'LayerName') || layerId;
        $('#txtLayerName').val(layerName);

        // 過帳階段 (SP 回傳: AftLayer, AftLayerName 透過 Lookup)
        var aftLayer = getVal(info, 'AftLayer');
        var aftLayerName = getVal(info, 'AftLayerName') || aftLayer;
        $('#txtAftLayerName').val(aftLayerName);

        // 型狀 (SP 回傳: POP, PnPName 透過 Lookup)
        var pop = getVal(info, 'POP');
        var popName = getVal(info, 'PnPName') || getVal(info, 'POPName') || pop;
        $('#txtPopName').val(popName);

        // 過帳型狀 (SP 回傳: AftPOP, AftPOPName 透過 Lookup)
        var aftPOP = getVal(info, 'AftPOP');
        var aftPopName = getVal(info, 'AftPOPName') || aftPOP;
        $('#txtAftPopName').val(aftPopName);

        // 原始數量 (SP 回傳: Qnty - 這是 RestQnty/存量)
        var qnty = getNumVal(info, 'Qnty') || getNumVal(info, 'RestQnty') || getNumVal(info, 'Qty') || getNumVal(info, 'BalQnty');
        $('#txtQnty').val(qnty);

        // X報數 (目前 SP 可能沒有直接回傳，先嘗試)
        $('#txtXOutQnty').val(getNumVal(info, 'XOutQnty') || getNumVal(info, 'XOut') || 0);

        // 產品類別 (SP 回傳: POType)
        var poType = getIntVal(info, 'POType');
        var poTypeText = poType === 0 ? '正常' : (poType === 1 ? '樣品' : (poType === 2 ? '試產' : poType));
        $('#txtPoType').val(poTypeText);

        // 預設過帳數 (SP 回傳: IsShowPQnty, PQnty)
        // Delphi 原始邏輯 (PassPCB.pas 第 2102-2105 行):
        //   if IsShowPQnty = 1 then PQnty := SP.PQnty else PQnty := 0
        var isShowPQnty = getIntVal(info, 'IsShowPQnty');
        if (isShowPQnty === 1) {
            // 使用 SP 回傳的 PQnty
            $('#txtPQnty').val(getNumVal(info, 'PQnty'));
        } else {
            // 依 Delphi 原始邏輯，IsShowPQnty != 1 時，過帳數預設為 0
            $('#txtPQnty').val(0);
        }
        // 報廢數 = SP 的 SQnty (PassPCB.pas 第 2113 行)
        $('#txtSQnty').val(getNumVal(info, 'SQnty'));

        // 顯示/隱藏報廢明細區塊 (SP 回傳: IsXOut, AftProcType)
        var isXOut = getIntVal(info, 'IsXOut');
        var aftProcType = getIntVal(info, 'AftProcType');
        if (isXOut === 1 || aftProcType === 990) {
            $('#pnlDefect').show();
        } else {
            $('#pnlDefect').hide();
        }

        // DateCode
        var dateCode = getVal(info, 'DateCode');
        if (dateCode) {
            console.log('DateCode:', dateCode);
        }

        // 完成良品PCS數
        var goodPCS = getIntVal(info, 'GoodPCS');
        console.log('GoodPCS:', goodPCS);
    }

    // 執行過帳 - 呼叫 SP，SP 會自動產生單號
    function executePass() {
        // 驗證
        if (!lotInfo) {
            alert('請先匯入批號');
            $('#txtLotNum').focus();
            return;
        }

        var lotNum = $('#txtLotNum').val().trim();
        if (!lotNum) {
            alert('請先匯入批號');
            $('#txtLotNum').focus();
            return;
        }

        // 收集畫面資料
        var passData = {
            lotNum: lotNum,
            userId: currentUserId,
            pQnty: parseFloat($('#txtPQnty').val()) || 0,
            sQnty: parseFloat($('#txtSQnty').val()) || 0,
            uQnty: 0,
            scrapStrXOutQnty: parseFloat($('#txtScrapStrXOutQnty').val()) || 0,
            notes: $('#txtNotes').val(),
            // 從 lotInfo 帶入的資料
            partNum: lotInfo.PartNum || lotInfo.partNum,
            revision: lotInfo.Revision || lotInfo.revision,
            procCode: lotInfo.ProcCode || lotInfo.procCode,
            layerId: lotInfo.LayerId || lotInfo.layerId,
            pop: lotInfo.POP || lotInfo.pop,
            aftProc: lotInfo.AftProc || lotInfo.aftProc,
            aftLayer: lotInfo.AftLayer || lotInfo.aftLayer,
            aftPop: lotInfo.AftPOP || lotInfo.aftPop,
            stockId: lotInfo.StockId || lotInfo.stockId,
            // 多報明細
            xOutList: collectXOutData(),
            // 報廢明細
            defectList: collectDefectData()
        };

        // 呼叫過帳 API
        $.ajax({
            url: '/api/FMEdPassPCB/execute',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(passData),
            success: function (resp) {
                if (resp.success) {
                    var msg = resp.message || '過帳完成';
                    if (resp.paperNum) {
                        msg += '\n單號: ' + resp.paperNum;
                    }
                    alert(msg);
                    // 清空表單，準備下一筆
                    clearForm();
                    $('#txtLotNum').focus();
                } else {
                    alert(resp.message || '過帳失敗');
                }
            },
            error: function (xhr) {
                alert('過帳失敗: ' + (xhr.responseJSON?.message || xhr.responseText));
            }
        });
    }

    // 收集多報明細資料
    function collectXOutData() {
        var list = [];
        $('#tblXOut tbody tr').each(function (idx) {
            var qnty = parseFloat($(this).find('input[type="number"]').val()) || 0;
            var isFullScrap = $(this).find('input[type="checkbox"]').is(':checked') ? 1 : 0;
            if (qnty > 0) {
                list.push({ item: idx + 1, qnty: qnty, isFullScrap: isFullScrap });
            }
        });
        return list;
    }

    // 收集報廢明細資料
    function collectDefectData() {
        var list = [];
        $('#tblDefect tbody tr').each(function (idx) {
            var inputs = $(this).find('input');
            var classId = inputs.eq(0).val();
            var defectId = inputs.eq(1).val();
            var dutyProc = inputs.eq(2).val();
            var qnty = parseFloat(inputs.eq(3).val()) || 0;
            if (qnty > 0) {
                list.push({ serialNum: idx + 1, classId: classId, defectId: defectId, dutyProc: dutyProc, qnty: qnty });
            }
        });
        return list;
    }

    // 渲染多報明細表格
    function renderXOutTable(list) {
        var tbody = $('#tblXOut tbody');
        tbody.empty();
        if (list && list.length > 0) {
            list.forEach(function (item, idx) {
                var tr = $('<tr>');
                tr.append($('<td>').text(item.Item || item.item || idx + 1));
                tr.append($('<td>').append($('<input type="number" class="form-control form-control-sm">').val(item.Qnty || item.qnty || 0)));
                tr.append($('<td>').text(item.OrgQnty || item.orgQnty || 0));
                tr.append($('<td>').append($('<input type="checkbox" class="form-check-input">').prop('checked', (item.IsFullScrap || item.isFullScrap) === 1)));
                tbody.append(tr);
            });
        }
    }

    // 渲染報廢明細表格
    function renderDefectTable(list) {
        var tbody = $('#tblDefect tbody');
        tbody.empty();
        if (list && list.length > 0) {
            list.forEach(function (item, idx) {
                var tr = $('<tr>');
                tr.append($('<td>').text(item.SerialNum || item.serialNum || idx + 1));
                tr.append($('<td>').append($('<input type="text" class="form-control form-control-sm">').val(item.ClassId || item.classId || '')));
                tr.append($('<td>').append($('<input type="text" class="form-control form-control-sm">').val(item.DefectId || item.defectId || '')));
                tr.append($('<td>').append($('<input type="text" class="form-control form-control-sm">').val(item.DutyProc || item.dutyProc || '')));
                tr.append($('<td>').append($('<input type="number" class="form-control form-control-sm">').val(item.Qnty || item.qnty || 0)));
                tbody.append(tr);
            });
        }
    }

    // 新增多報明細行
    function addXOutRow() {
        var tbody = $('#tblXOut tbody');
        var newItem = tbody.find('tr').length + 1;
        var tr = $('<tr class="selected">');
        tr.append($('<td>').text(newItem));
        tr.append($('<td>').append($('<input type="number" class="form-control form-control-sm">').val(0)));
        tr.append($('<td>').text(0));
        tr.append($('<td>').append($('<input type="checkbox" class="form-check-input">')));
        tbody.find('tr').removeClass('selected');
        tbody.append(tr);
    }

    // 刪除選中的多報明細
    function deleteSelectedXOut() {
        $('#tblXOut tbody tr.selected').remove();
        $('#tblXOut tbody tr').each(function (idx) {
            $(this).find('td:first').text(idx + 1);
        });
    }

    // 新增報廢明細行
    function addDefectRow() {
        var tbody = $('#tblDefect tbody');
        var newSerial = tbody.find('tr').length + 1;
        var tr = $('<tr class="selected">');
        tr.append($('<td>').text(newSerial));
        tr.append($('<td>').append($('<input type="text" class="form-control form-control-sm">')));
        tr.append($('<td>').append($('<input type="text" class="form-control form-control-sm">')));
        tr.append($('<td>').append($('<input type="text" class="form-control form-control-sm">')));
        tr.append($('<td>').append($('<input type="number" class="form-control form-control-sm">').val(0)));
        tbody.find('tr').removeClass('selected');
        tbody.append(tr);
    }

    // 刪除選中的報廢明細
    function deleteSelectedDefect() {
        $('#tblDefect tbody tr.selected').remove();
        $('#tblDefect tbody tr').each(function (idx) {
            $(this).find('td:first').text(idx + 1);
        });
    }

    // 清除表單
    function clearForm() {
        $('#txtLotNum').val('');
        $('#txtPartNum').val('');
        $('#txtRevision').val('');
        $('#txtProcName').val('');
        $('#txtAftProcName').val('');
        $('#txtLayerName').val('');
        $('#txtAftLayerName').val('');
        $('#txtPopName').val('');
        $('#txtAftPopName').val('');
        $('#txtQnty').val(0);
        $('#txtPQnty').val(0);
        $('#txtSQnty').val(0);
        $('#txtXOutQnty').val(0);
        $('#txtScrapStrXOutQnty').val(0);
        $('#txtNotes').val('');
        $('#tblXOut tbody').empty();
        $('#tblDefect tbody').empty();
        $('#tblSelectLot tbody').empty();
        $('#lblPaperNum').text('(過帳後產生)');
        $('#lblItem').text('1');
        lotInfo = null;
    }

    // 計算數量
    function calculateQuantities() {
        var qnty = parseFloat($('#txtQnty').val()) || 0;
        var pQnty = parseFloat($('#txtPQnty').val()) || 0;
        var sQnty = parseFloat($('#txtSQnty').val()) || 0;
        // 可加入驗證: pQnty + sQnty 不可超過 qnty
    }
</script>
}
