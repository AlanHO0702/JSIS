@page "/EMOdTmpRoute"
@model PcbErpApi.Pages.EMOdTmpRoute.IndexModel
@{
    ViewData["Title"] = "途程主檔";
    Layout = "_Layout";
}

@section Styles {
<style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    .container-fluid { height: calc(100vh - 30px); display: flex; flex-direction: column; padding: 0.5rem 0.75rem; box-sizing: border-box; }

    .route-main-container {
        display: flex; flex: 1; min-height: 0; gap: 5px; margin-top: 0;
    }

    /* 左側 Master Grid */
    .master-panel {
        flex: 0 0 420px; display: flex; flex-direction: column; min-height: 0;
        border: 1px solid #dee2e6; border-radius: 8px; background: #fff;
        box-shadow: 0 2px 12px 0 #c3d4e6; overflow: hidden;
    }
    .master-panel .table-fix-wrapper {
        flex: 1; overflow-y: auto; overflow-x: auto; white-space: nowrap;
    }
    .master-panel table { table-layout: fixed; border-collapse: collapse; }
    .master-panel thead th {
        position: sticky; top: 0; z-index: 2;
        background: #f8f9fa; border-bottom: 2px solid #dee2e6;
        padding: 6px 10px; font-size: 13px; font-weight: 600;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .master-panel tbody td {
        padding: 4px 10px; font-size: 13px; border-bottom: 1px solid #f0f0f0;
        cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .master-panel thead th .th-resize {
        position: absolute; right: 0; top: 0; width: 5px; height: 100%;
        cursor: col-resize; user-select: none;
    }
    .master-panel thead th .th-resize:hover { background: #adb5bd; }
    .master-panel tbody tr:hover { background: #f0f8ff; }
    .master-panel tbody tr.selected { background: #e6f2ff; font-weight: 600; }

    /* 右側 Detail Grid */
    .detail-panel {
        flex: 1; display: flex; flex-direction: column; min-height: 0;
        border: 1px solid #dee2e6; border-radius: 8px; background: #fff;
        box-shadow: 0 2px 12px 0 #c3d4e6; overflow: hidden;
    }
    .detail-panel-header {
        padding: 6px 10px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;
        font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px;
    }
    .detail-panel .table-fix-wrapper {
        flex: 1; overflow-y: auto; overflow-x: auto; white-space: nowrap;
    }
    .detail-panel table { table-layout: fixed; border-collapse: collapse; }
    .detail-panel thead th {
        position: sticky; top: 0; z-index: 2;
        background: #f8f9fa; border-bottom: 2px solid #dee2e6;
        padding: 6px 10px; font-size: 13px; font-weight: 600;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .detail-panel tbody td {
        padding: 4px 10px; font-size: 13px; border-bottom: 1px solid #f0f0f0;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .detail-panel thead th .th-resize {
        position: absolute; right: 0; top: 0; width: 5px; height: 100%;
        cursor: col-resize; user-select: none;
    }
    .detail-panel thead th .th-resize:hover { background: #adb5bd; }
    .detail-panel tbody tr:hover { background: #f0f8ff; }
    .detail-panel tbody tr.selected { background: #e6f2ff; }

    /* 備註區塊 */
    .note-panel {
        flex-shrink: 0; border-top: 1px solid #dee2e6; background: #fff;
        display: flex; flex-direction: column;
    }
    .note-panel-header {
        padding: 4px 10px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;
        font-size: 12px; font-weight: 600; color: #555;
    }
    .note-panel textarea {
        flex: 1; border: none; resize: none; padding: 6px 10px;
        font-size: 13px; font-family: inherit; outline: none;
        background: #fffef0;
    }
    .note-panel textarea:read-only { background: #f8f9fa; color: #555; }

    /* Splitter */
    .v-splitter {
        width: 5px; cursor: col-resize; background: #e9ecef; flex-shrink: 0;
        border-radius: 2px; transition: background 0.2s;
    }
    .v-splitter:hover { background: #adb5bd; }
    .h-splitter {
        height: 5px; cursor: row-resize; background: #e9ecef; flex-shrink: 0;
        border-radius: 2px; transition: background 0.2s;
    }
    .h-splitter:hover { background: #adb5bd; }

    /* Toolbar */
    .route-toolbar {
        display: flex; align-items: center; gap: 6px; padding: 6px 10px;
        background: #f8f9fa; border-bottom: 1px solid #dee2e6; flex-shrink: 0;
        flex-wrap: wrap;
    }
    .toolbar-btn {
        display: inline-flex; align-items: center; gap: 4px;
        padding: 4px 12px; border: 1px solid #ced4da; border-radius: 4px;
        background: #fff; font-size: 13px; cursor: pointer; transition: all 0.15s;
        white-space: nowrap;
    }
    .toolbar-btn:hover { background: #e9ecef; border-color: #adb5bd; }
    .toolbar-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .toolbar-btn.primary { background: #0d6efd; color: #fff; border-color: #0d6efd; }
    .toolbar-btn.primary:hover { background: #0b5ed7; }
    .toolbar-btn.success { background: #198754; color: #fff; border-color: #198754; }
    .toolbar-btn.success:hover { background: #157347; }
    .toolbar-btn.danger { background: #dc3545; color: #fff; border-color: #dc3545; }
    .toolbar-btn.danger:hover { background: #bb2d3b; }
    .route-toolbar .toolbar-sep { width: 1px; height: 24px; background: #ced4da; }
    .route-toolbar .toolbar-label { font-size: 13px; color: #666; }
    .route-toolbar input[type="text"] {
        padding: 3px 8px; border: 1px solid #ced4da; border-radius: 4px;
        font-size: 13px; width: 120px;
    }

    /* Bottom bar */
    .master-bottom-bar {
        display: flex; align-items: center; gap: 6px;
        padding: 6px 10px; background: #f8f9fa;
        border-top: 1px solid #dee2e6; flex-shrink: 0;
    }
    .master-bottom-bar .record-count { font-size: 12px; color: #666; margin-left: auto; }
    .detail-bottom-bar {
        display: flex; align-items: center; gap: 6px;
        padding: 4px 10px; background: #f8f9fa;
        border-top: 1px solid #dee2e6; flex-shrink: 0;
    }
    .detail-bottom-bar .record-count { font-size: 12px; color: #666; margin-left: auto; }

    /* 途程設定 Modal (Multi-Select) */
    .routeset-modal .modal-dialog { max-width: 90vw; width: 820px; }
    .routeset-modal .modal-body { padding: 0; display: flex; flex-direction: column; max-height: 70vh; overflow: hidden; }
    .routeset-toolbar {
        display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
        padding: 8px 12px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;
    }
    .routeset-toolbar label { font-size: 13px; font-weight: 600; margin: 0; }
    .routeset-toolbar input[type="text"] {
        padding: 3px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px; width: 100px;
    }

    /* Multi-Select 雙列表 */
    .multi-select-container {
        display: flex; flex: 1; min-height: 0; gap: 0;
    }
    .ms-list-panel {
        flex: 1; display: flex; flex-direction: column; min-height: 0;
        border: 1px solid #dee2e6;
    }
    .ms-list-header {
        padding: 6px 10px; background: #e9ecef; font-size: 13px; font-weight: 600;
        border-bottom: 1px solid #dee2e6;
    }
    .ms-list-body {
        flex: 1; overflow: auto;
    }
    .ms-list-body table { width: 100%; border-collapse: collapse; }
    .ms-list-body thead th {
        position: sticky; top: 0; z-index: 2;
        background: #f8f9fa; border-bottom: 1px solid #dee2e6;
        padding: 4px 8px; font-size: 12px; font-weight: 600;
    }
    .ms-list-body tbody td {
        padding: 3px 8px; font-size: 12px; border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
    }
    .ms-list-body tbody tr:hover { background: #f0f8ff; }
    .ms-list-body tbody tr.selected { background: #cfe2ff; }
    .ms-buttons {
        display: flex; flex-direction: column; justify-content: center;
        gap: 6px; padding: 0 8px;
    }
    .ms-buttons button {
        padding: 4px 12px; border: 1px solid #ced4da; border-radius: 4px;
        background: #fff; font-size: 18px; cursor: pointer; line-height: 1;
    }
    .ms-buttons button:hover { background: #e9ecef; }
    .ms-move-btns {
        display: flex; gap: 4px; padding: 4px 8px; background: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
    .ms-move-btns button {
        flex: 1; padding: 3px 6px; border: 1px solid #ced4da; border-radius: 4px;
        background: #fff; font-size: 12px; cursor: pointer;
    }
    .ms-move-btns button:hover { background: #e9ecef; }

    /* Query Modal */
    .query-row { margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .query-row label { width: 80px; font-size: 13px; text-align: right; }
    .query-row input, .query-row select {
        flex: 1; padding: 3px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;
    }

    /* Scrollbar */
    .master-panel .table-fix-wrapper::-webkit-scrollbar,
    .detail-panel .table-fix-wrapper::-webkit-scrollbar,
    .ms-list-body::-webkit-scrollbar { width: 8px; height: 8px; }
    .master-panel .table-fix-wrapper::-webkit-scrollbar-track,
    .detail-panel .table-fix-wrapper::-webkit-scrollbar-track,
    .ms-list-body::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    .master-panel .table-fix-wrapper::-webkit-scrollbar-thumb,
    .detail-panel .table-fix-wrapper::-webkit-scrollbar-thumb,
    .ms-list-body::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
</style>
}

<div class="container-fluid">
    <!-- Toolbar -->
    <div class="route-toolbar">
        <button class="toolbar-btn" id="btnModeToggle" title="切換瀏覽/編輯模式"><i class="bi bi-eye"></i> 瀏覽模式</button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn" id="btnAddRow" title="新增範本" style="display:none;"><i class="bi bi-plus-lg"></i></button>
        <button class="toolbar-btn" id="btnDelRow" title="刪除範本" style="display:none;"><i class="bi bi-dash-lg"></i></button>
        <div class="toolbar-sep" id="sepAddDel" style="display:none;"></div>
        <button class="toolbar-btn primary" id="btnChange" title="異動途程"><i class="bi bi-gear"></i> 異動</button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn success" id="btnSaveAs" title="複製"><i class="bi bi-files"></i> 複製</button>
        <span class="toolbar-label">複製代碼:</span>
        <input type="text" id="edtTmpIdNew" placeholder="輸入新代碼" maxlength="12" />
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn" id="btnQuery" title="條件查詢"><i class="bi bi-search"></i> 查詢</button>
        <span class="toolbar-label" id="recordCountMas" style="margin-left:auto;">0 / 0</span>
    </div>

    <!-- Main content: Master + Detail -->
    <div class="route-main-container">
        <!-- 左側: Master Grid (途程範本列表) -->
        <div class="master-panel" id="masterPanel">
            <div class="table-fix-wrapper">
                <table id="masterGrid">
                    <thead><tr id="masterHead"></tr></thead>
                    <tbody id="masterBody"></tbody>
                </table>
            </div>
            <div class="master-bottom-bar">
                <button class="toolbar-btn success" id="btnApprove" title="送審"><i class="bi bi-check-circle"></i> 送審</button>
                <button class="toolbar-btn danger" id="btnReject" title="退審"><i class="bi bi-x-circle"></i> 退審</button>
                <button class="toolbar-btn" id="btnSaveLayout" title="儲存欄寬">儲存欄寬</button>
                <span class="record-count" id="masterRecordCount">0 / 0</span>
            </div>
        </div>

        <!-- Vertical Splitter -->
        <div class="v-splitter" id="vSplitter1"></div>

        <!-- 右側: Detail Panel (途程明細 + 備註) -->
        <div class="detail-panel" id="detailPanel">
            <div class="detail-panel-header">
                <span>途程明細</span>
                <span id="detailTmpIdLabel" style="color:#0d6efd;"></span>
            </div>
            <div class="table-fix-wrapper" id="detailTableWrapper">
                <table id="detailGrid">
                    <thead><tr id="detailHead"></tr></thead>
                    <tbody id="detailBody"></tbody>
                </table>
            </div>
            <!-- 水平分割線 -->
            <div class="h-splitter" id="hSplitter1"></div>
            <!-- 備註區塊 -->
            <div class="note-panel" id="notePanel" style="height:120px;">
                <div class="note-panel-header">備註</div>
                <textarea id="txtDtlNote" readonly placeholder="選擇明細列後可編輯備註..."></textarea>
            </div>
            <div class="detail-bottom-bar">
                <span class="record-count" id="detailRecordCount">0 / 0</span>
            </div>
        </div>
    </div>
</div>

<!-- 途程設定 Modal (對應 Delphi TdlgTmpRouteSet) -->
<div class="modal fade routeset-modal" id="routeSetModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title"><i class="bi bi-list-ol"></i> 途程設定</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 查詢條件 -->
                <div class="routeset-toolbar">
                    <label>製程代碼:</label>
                    <input type="text" id="rsEdtBProc" placeholder="起始" />
                    <label>~</label>
                    <input type="text" id="rsEdtEProc" placeholder="結束" />
                    <label>代碼含:</label>
                    <input type="text" id="rsEdtProcLike" placeholder="含..." />
                    <label>名稱含:</label>
                    <input type="text" id="rsEdtProcNameLike" placeholder="含..." />
                    <button class="toolbar-btn primary" id="btnRsSearch"><i class="bi bi-search"></i> 查詢</button>
                </div>
                <!-- Multi-Select 雙列表 -->
                <div class="multi-select-container">
                    <!-- 可用製程 (Source) -->
                    <div class="ms-list-panel">
                        <div class="ms-list-header">可用製程</div>
                        <div class="ms-list-body" id="msSourceBody">
                            <table>
                                <thead><tr><th style="width:100px;">製程代碼</th><th>製程名稱</th></tr></thead>
                                <tbody id="msSourceList"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- 操作按鈕 -->
                    <div class="ms-buttons">
                        <button id="btnMsAdd" title="加入">&gt;</button>
                        <button id="btnMsRemove" title="移除">&lt;</button>
                        <button id="btnMsAddAll" title="全部加入">&gt;&gt;</button>
                        <button id="btnMsRemoveAll" title="全部移除">&lt;&lt;</button>
                    </div>
                    <!-- 已選製程 (Target) -->
                    <div class="ms-list-panel">
                        <div class="ms-list-header">已選製程 (順序即途程順序)</div>
                        <div class="ms-list-body" id="msTargetBody">
                            <table>
                                <thead><tr><th style="width:40px;">序</th><th style="width:100px;">製程代碼</th><th>製程名稱</th></tr></thead>
                                <tbody id="msTargetList"></tbody>
                            </table>
                        </div>
                        <div class="ms-move-btns">
                            <button id="btnMsUp"><i class="bi bi-arrow-up"></i> 上移</button>
                            <button id="btnMsDown"><i class="bi bi-arrow-down"></i> 下移</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary btn-sm" id="btnRouteSetOk">確定</button>
            </div>
        </div>
    </div>
</div>

<!-- 查詢條件 Modal -->
<div class="modal fade" id="queryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title"><i class="bi bi-search"></i> 條件查詢</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="query-row">
                    <label>途程代碼:</label>
                    <input type="text" id="qryTmpId" />
                </div>
                <div class="query-row">
                    <label>備　　註:</label>
                    <input type="text" id="qryNotes" />
                </div>
                <div class="query-row">
                    <label>狀　　態:</label>
                    <select id="qryStatus">
                        <option value="">全部</option>
                        <option value="0">設定中</option>
                        <option value="1">使用中</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary btn-sm" id="btnQueryOk">確定</button>
            </div>
        </div>
    </div>
</div>

<!-- 新增主檔 Modal -->
<div class="modal fade" id="insertModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title"><i class="bi bi-plus-circle"></i> 新增途程範本</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="query-row">
                    <label>途程代碼:</label>
                    <input type="text" id="insNewTmpId" maxlength="12" />
                </div>
                <div class="query-row">
                    <label>備　　註:</label>
                    <input type="text" id="insNotes" />
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary btn-sm" id="btnInsertOk">確定</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="~/js/EMOdTmpRoute.js" asp-append-version="true"></script>
}