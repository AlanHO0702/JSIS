@model dynamic

<script>
(() => {
  window.ActionRailCustomHandlers = window.ActionRailCustomHandlers || {};

  const readPaperNum = (ctx) => {
    const v = (ctx?.paperNum || window._paperNum || '').toString().trim();
    if (v) return v;
    if (typeof window.getPaperNum === 'function') {
      try { return (window.getPaperNum() || '').toString().trim(); } catch { /* ignore */ }
    }
    return '';
  };

  const withJwtHeaders = (init = {}) => {
    const jwt = localStorage.getItem('jwtId');
    const headers = Object.assign({}, init.headers || {});
    if (jwt) headers['X-JWTID'] = jwt;
    return { ...init, headers };
  };

  const outAddr = async (ctx) => {
    const paperNum = readPaperNum(ctx);
    const paperId = 'SPOdOrderMain';
    if (!paperNum) return Swal.fire({ icon: 'info', title: '沒有單號' });

    // 1) 先載入出貨地址選項
    const resp = await fetch(`/api/OrderSubButton/GetOutAddrOptions?paperId=${encodeURIComponent(paperId)}&paperNum=${encodeURIComponent(paperNum)}`);
    const data = await resp.json();
    if (!data.ok) return Swal.fire({ icon: 'error', title: '載入失敗', text: data.error });

    // 2) 顯示選擇視窗
    const options = (data.list || []).map(x =>
      `<option value="${x.Addr}" data-title="${x.Title}">${x.Addr}</option>`
    ).join('');

    const { value: addr } = await Swal.fire({
      title: data.label || '出貨地址',
      html: `<select id="addrSel" class="swal2-select">${options}</select>`,
      showCancelButton: true,
      confirmButtonText: '確定',
      cancelButtonText: '取消',
      preConfirm: () => {
        const sel = document.getElementById('addrSel');
        return sel ? {
          addr: sel.value,
          title: sel.options[sel.selectedIndex]?.dataset?.title || ''
        } : null;
      }
    });
    if (!addr) return;

    // 3) 更新到主檔
    const updateResp = await fetch('/api/OrderSubButton/UpdateOutAddr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ paperId, paperNum, addr: addr.addr, title: addr.title })
    });
    const updateData = await updateResp.json();
    if (!updateData.ok) return Swal.fire({ icon: 'error', title: '更新失敗', text: updateData.error });

    await Swal.fire({ icon: 'success', title: '更新完成', timer: 1000, showConfirmButton: false });

    const addrField = document.querySelector('input[name="TransPlace"], input[name="OutAddr"], textarea[name="TransPlace"], textarea[name="OutAddr"]');
    const titleField = document.querySelector('input[name="PkgTitle"], input[name="ShipTo"], textarea[name="PkgTitle"], textarea[name="ShipTo"]');
    if (addrField) addrField.value = addr.addr;
    if (titleField) titleField.value = addr.title;

    const addrValueEl = document.querySelector('[data-field="OutAddr"] span, [data-field="TransPlace"] span');
    const titleValueEl = document.querySelector('[data-field="ShipTo"] span, [data-field="PkgTitle"] span');
    if (addrValueEl) addrValueEl.textContent = addr.addr;
    if (titleValueEl) titleValueEl.textContent = addr.title;

    [addrField, titleField, addrValueEl, titleValueEl].forEach(el => {
      if (!el) return;
      el.style.transition = 'background-color 0.5s';
      el.style.backgroundColor = '#fff8c4';
      setTimeout(() => el.style.backgroundColor = '', 800);
    });
  };

  const orderTailCancel = async (ctx) => {
    const paperNum = readPaperNum(ctx);
    const paperId = (ctx?.headerTable || 'SPOdOrderMain').toString().trim() || 'SPOdOrderMain';
    if (!paperNum) return Swal.fire({ icon: 'info', title: '沒有單號' });

    const showPlus = /^MPHdOrderMain$/i.test(paperId);
    const { value: form } = await Swal.fire({
      title: '尾數取消',
      html: `
        <div class="swal2-tailcancel">
          <div style="display:flex; gap:12px; justify-content:center; margin-bottom:8px;">
            <label style="display:flex; gap:6px; align-items:center;">
              <input type="radio" name="tcMode" value="all" checked>全部尾數取消
            </label>
            <label style="display:flex; gap:6px; align-items:center;">
              <input type="radio" name="tcMode" value="single">單筆尾數取消
            </label>
          </div>
          <div style="display:flex; gap:8px; align-items:center; justify-content:center; margin-bottom:8px;">
            <label style="min-width:50px; text-align:right;">項次</label>
            <input id="tcItem" class="swal2-input" style="width:120px; margin:0;" placeholder="項次" disabled>
          </div>
          <div style="display:flex; gap:8px; align-items:center; justify-content:center; margin-bottom:8px;">
            <label style="min-width:50px; text-align:right;">原因</label>
            <input id="tcNotes" class="swal2-input" style="width:200px; margin:0;" placeholder="取消原因(可空白)">
          </div>
          <div style="display:flex; gap:8px; align-items:center; justify-content:center; margin-bottom:8px;">
            <label style="display:flex; gap:6px; align-items:center;">
              <input type="checkbox" id="tcRecompute" checked>重算金額
            </label>
          </div>
          ${showPlus ? `
          <div style="display:flex; gap:8px; align-items:center; justify-content:center;">
            <label style="display:flex; gap:6px; align-items:center;">
              <input type="checkbox" id="tcPlus">來源請購單一併尾數取消
            </label>
          </div>` : ''}
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: '確定',
      cancelButtonText: '取消',
      focusConfirm: false,
      didOpen: () => {
        const itemInput = document.getElementById('tcItem');
        document.querySelectorAll('input[name="tcMode"]').forEach(r => {
          r.addEventListener('change', () => {
            const mode = document.querySelector('input[name="tcMode"]:checked')?.value || 'all';
            if (itemInput) itemInput.disabled = mode !== 'single';
          });
        });
      },
      preConfirm: () => {
        const mode = document.querySelector('input[name="tcMode"]:checked')?.value || 'all';
        const itemRaw = document.getElementById('tcItem')?.value || '';
        const notes = document.getElementById('tcNotes')?.value || '';
        const recompute = !!document.getElementById('tcRecompute')?.checked;
        const plusCancel = !!document.getElementById('tcPlus')?.checked;

        if (mode === 'single') {
          const v = itemRaw.trim();
          if (!v) {
            Swal.showValidationMessage('項次必須輸入');
            return false;
          }
          if (!/^\d+$/.test(v)) {
            Swal.showValidationMessage('項次輸入不符');
            return false;
          }
          return { mode, item: parseInt(v, 10), notes, recompute, plusCancel };
        }

        return { mode, item: 1, notes, recompute, plusCancel };
      }
    });
    if (!form) return;

    const modeLabel = form.mode === 'single' ? '單筆' : '全部';
    const confirm = await Swal.fire({
      icon: 'question',
      title: `確定${modeLabel}尾數取消?`,
      showCancelButton: true,
      confirmButtonText: '確定',
      cancelButtonText: '取消'
    });
    if (!confirm.isConfirmed) return;

    const resp = await fetch('/api/OrderSubButton/OrderTailCancel', withJwtHeaders({
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        paperId,
        paperNum,
        mode: form.mode,
        item: form.item,
        reCompute: form.recompute ? 1 : 0,
        notes: form.notes || '',
        plusCancel: form.plusCancel || false
      })
    }));
    const data = await resp.json();
    if (!data.ok) return Swal.fire({ icon: 'error', title: '執行失敗', text: data.error || '' });

    const doneMsg = data.plusDone ? '尾數取消完成，來源請購項目已處理' : '尾數取消完成';
    await Swal.fire({ icon: 'success', title: doneMsg, timer: 1200, showConfirmButton: false });
  };

  window.ActionRailCustomHandlers['SA000002'] = {
    // 依 CURdOCXItemCustButton.ButtonName 對應
    btnC6: outAddr,
    btnC8: orderTailCancel
  };
})();
</script>
