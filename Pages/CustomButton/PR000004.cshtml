@*
    PR000004 - 應收沖帳單
    對應 Delphi: StrikeSelectDLL.pas / StrikeSelectDLL.dfm
    自訂按鈕功能:
      - 選擇可沖帳之憑證加入應付帳款沖帳單
      - 支援多選 (左右選擇器模式)
      - 支援條件篩選
      - 顯示選中憑證的詳細資料
    介面：上下分割（上70%下30%），上半部左右分割（左70%右30%）
*@
@model dynamic

<!-- 可沖帳之憑證選擇 -->
<style>
  /* 隱藏 number input 的上下箭頭按鈕 */
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type="number"] {
    -moz-appearance: textfield;
  }
  .form-control,
  .form-control-sm {
    padding-top: 1px;
    padding-bottom: 1px;
    min-height: 0;
    height: auto;
    line-height: 1;
  }

  /* 降低 modal 背景遮罩的暗度 */
  .modal-backdrop.show { opacity: 0.2; }

  #strike-sel-modal .paper-search-dialog { --bs-modal-width: 1200px; --bs-modal-margin: 0; margin-top: 6vh; }
  #strike-sel-modal .paper-search-modal { height: calc(92vh); display: flex; flex-direction: column; }
  #strike-sel-modal.modal.show { align-items: flex-start; }
  #strike-sel-modal .modal-header { padding: 6px 12px; cursor: move; user-select: none; }
  #strike-sel-modal .modal-header :is(button, input, select, textarea, a) { cursor: default; }
  #strike-sel-modal .modal-title { font-size: 16px; line-height: 1.2; }
  #strike-sel-modal .modal-body { flex: 1 1 auto; display: flex; flex-direction: column; min-height: 0; overflow: hidden; padding: 8px 12px; }
  #strike-sel-modal .modal-footer { position: sticky; bottom: 0; background: #fff; z-index: 3; display: flex; align-items: center; gap: 12px; padding: 6px 12px; }

  /* 搜尋條件 */
  #strike-sel-modal .paper-search-form {
    display: flex; flex-direction: column; gap: 6px;
    position: relative; padding-right: 100px; margin-bottom: 8px;
  }
  #strike-sel-modal .paper-search-form .ps-grid {
    display: grid;
    grid-template-columns: repeat(4, 260px);
    grid-template-rows: repeat(3, minmax(0, auto));
    grid-auto-flow: column;
    gap: 4px 10px;
    justify-content: start; align-items: start;
  }
  #strike-sel-modal .paper-search-form .ps-field { display: flex; align-items: center; gap: 6px; min-width: 0; }
  #strike-sel-modal .paper-search-form .ps-label {
    white-space: nowrap; margin: 0; flex: 0 0 90px;
    text-align: right; font-size: var(--field-label-size); line-height: 1.2;
  }
  #strike-sel-modal .paper-search-form .ps-control {
    flex: 1 1 auto; min-width: 0; font-size: var(--field-value-size);
    height: 24px; padding: 2px 6px; border: 1px solid #ced4da; border-radius: 4px;
  }
  #strike-sel-modal .paper-search-form .ps-control:disabled {
    background-color: #e9ecef; color: #495057; cursor: not-allowed;
  }
  #strike-sel-modal .paper-search-form .ps-actions {
    display: flex; justify-content: flex-end; align-items: center;
    position: absolute; top: 0; right: 0; margin: 0;
  }

  /* 上下分割容器 */
  #strike-sel-modal .strike-split-container {
    flex: 1 1 0;
    min-height: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  #strike-sel-modal .strike-top-section {
    flex: 7 1 0;
    min-height: 0;
    display: flex;
    flex-direction: column;
  }
  #strike-sel-modal .strike-bottom-section {
    flex: 3 1 0;
    min-height: 0;
    display: flex;
    flex-direction: column;
  }

  /* 多選區域（上半部） */
  #strike-sel-modal .paper-search-picker {
    flex: 1 1 auto;
    min-height: 0;
    display: flex;
    gap: 4px;
    margin-left: 0;
    margin-right: 0;
  }
  #strike-sel-modal .paper-search-picker > div { padding-left: 0; padding-right: 0; }
  #strike-sel-modal .paper-search-col { display: flex; flex-direction: column; min-width: 0; }
  #strike-sel-modal .paper-search-col-left { flex: 7 1 0; }
  #strike-sel-modal .paper-search-col-right { flex: 3 1 0; }
  #strike-sel-modal .paper-search-title-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 4px; }
  #strike-sel-modal .paper-search-title { font-weight: 600; color: #475569; font-size: 13px; }
  #strike-sel-modal .paper-search-count { font-size: 12px; color: #64748b; }
  #strike-sel-modal .paper-search-scroll { flex: 1 1 0; min-height: 0; overflow: auto; border: 1px solid #e5e7eb; border-radius: 8px; }
  #strike-sel-modal .paper-search-transfer { flex: 0 0 56px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: .6rem; }
  #strike-sel-modal .paper-search-transfer .btn {
    width: 28px; height: 28px; padding: 0;
    border: 1px solid currentColor; border-radius: 6px;
    display: inline-flex; align-items: center; justify-content: center;
  }
  #strike-sel-modal .paper-search-transfer .btn:hover { border-color: currentColor; box-shadow: none; }
  #strike-sel-modal .paper-search-transfer .material-symbols-outlined { font-size: 28px; line-height: 1; }

  /* 憑證明細區域（下半部） */
  #strike-sel-modal .certif-detail-section {
    border-top: 2px solid #e5e7eb;
    padding-top: 8px;
  }
  #strike-sel-modal .certif-detail-title {
    font-weight: 600;
    color: #475569;
    font-size: 13px;
    margin-bottom: 4px;
  }
  #strike-sel-modal .certif-detail-scroll {
    flex: 1 1 0;
    min-height: 0;
    overflow: auto;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
  }

  /* 表格樣式 */
  #strike-sel-modal thead th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; }
  #strike-sel-modal table { border-collapse: collapse; width: 100%; }
  #strike-sel-modal th, #strike-sel-modal td { border: 1px solid #dee2e6; vertical-align: middle; }
  #strike-sel-modal .paper-search-scroll th,
  #strike-sel-modal .paper-search-scroll td,
  #strike-sel-modal .certif-detail-scroll th,
  #strike-sel-modal .certif-detail-scroll td {
    white-space: nowrap;
    font-size: var(--field-value-size);
    padding: 2px 6px;
    line-height: 1.15;
  }
  #strike-sel-modal .paper-search-scroll thead th,
  #strike-sel-modal .certif-detail-scroll thead th {
    position: sticky;
    top: 0;
    background: #f8fafc;
    z-index: 2;
    font-size: var(--field-label-size);
  }
  #strike-sel-modal .paper-search-scroll tbody tr { cursor: pointer; }
  #strike-sel-modal .paper-search-scroll tbody tr.selected,
  #strike-sel-modal .paper-search-scroll tbody tr.selected > td { background: #dbeafe !important; }
  #strike-sel-modal .certif-detail-scroll tbody tr.stop-payment { color: #dc2626; }

  /* 底部統計 */
  #strike-sel-modal .ps-summary { display: flex; gap: 20px; font-size: 13px; margin-left: auto; margin-right: 12px; }
  #strike-sel-modal .ps-summary-item { display: flex; gap: 6px; }
  #strike-sel-modal .ps-summary-label { color: #475569; font-weight: 600; }
  #strike-sel-modal .ps-summary-value { color: #1e293b; font-weight: 700; }

  /* Tab pane 顯示控制 - 修正頁籤切換時的隱藏問題 */
  #strike-sel-modal .tab-pane.show.active {
    display: flex !important;
  }
  #strike-sel-modal .tab-pane[data-flex="column"] {
    flex-direction: column;
  }
  #strike-sel-modal .tab-pane[data-flex="row"] {
    flex-direction: row;
  }

  @@media (max-width: 991.98px) {
    #strike-sel-modal .paper-search-dialog { --bs-modal-width: 100vw; --bs-modal-margin: 0; }
    #strike-sel-modal .paper-search-modal { border-radius: 0; }
  }
</style>

<!-- 搜尋按鈕 -->
<div class="modal fade" id="strike-sel-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl paper-search-dialog">
    <div class="modal-content paper-search-modal">
      <div class="modal-header">
        <h5 class="modal-title">可沖帳之憑證</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- 搜尋條件 -->
        <form class="paper-search-form">
          <div class="ps-grid">
            <div class="ps-field">
              <label class="ps-label">客戶名稱</label>
              <select class="ps-control" id="strike-sel-company" disabled></select>
            </div>
            <div class="ps-field">
              <label class="ps-label">帳款型態</label>
              <select class="ps-control" id="strike-sel-isin" disabled></select>
            </div>
            <div class="ps-field">
              <label class="ps-label">公司別</label>
              <select class="ps-control" id="strike-sel-useid" disabled></select>
            </div>

            <div class="ps-field">
              <label class="ps-label">立帳日期</label>
              <input type="date" class="ps-control" id="strike-sel-paper-date">
            </div>
            <div class="ps-field">
              <label class="ps-label">收付日期</label>
              <input type="date" class="ps-control" id="strike-sel-expect-date">
            </div>
            <div class="ps-field">
              <label class="ps-label">帳款號碼</label>
              <input type="text" class="ps-control" id="strike-sel-paper-num">
            </div>

            <div class="ps-field">
              <label class="ps-label">幣別</label>
              <select class="ps-control" id="strike-sel-money"></select>
            </div>
            <div class="ps-field" id="strike-sel-depart-field" style="display: none;">
              <label class="ps-label">部門</label>
              <select class="ps-control" id="strike-sel-depart"></select>
            </div>
          </div>
          <div class="ps-actions">
            <button type="button" class="btn btn-primary btn-sm" id="strike-sel-btn-find">資料重取</button>
          </div>
        </form>

        <!-- 上下分割容器 -->
        <div class="strike-split-container">
          <!-- 上半部：可選區域 -->
          <div class="strike-top-section">
            <div class="row paper-search-picker">
              <!-- 左側：可沖帳之憑證 -->
              <div class="paper-search-col paper-search-col-left">
                <div class="paper-search-title-row">
                  <div class="paper-search-title">可沖帳之憑證</div>
                  <div class="paper-search-count" id="strike-sel-source-count">0</div>
                </div>
                <div class="paper-search-scroll">
                  <table class="table table-sm table-striped mb-0">
                    <thead>
                      <tr>
                        <th>帳款編號</th>
                        <th>帳款日期</th>
                        <th>客戶編號</th>
                        <th>簡稱</th>
                        <th>剩餘原幣金額</th>
                        <th>剩餘金額</th>
                        <th>付款日</th>
                        <th>發票號碼</th>
                        <th>幣別</th>
                        <th>匯率</th>
                      </tr>
                    </thead>
                    <tbody id="strike-sel-source-body"></tbody>
                  </table>
                </div>
              </div>

              <!-- 中間按鈕 -->
              <div class="paper-search-transfer">
                <button class="btn btn-outline-primary" type="button" id="strike-sel-btn-add" title="加入選定">
                  <span class="material-symbols-outlined">keyboard_arrow_right</span>
                </button>
                <button class="btn btn-outline-primary" type="button" id="strike-sel-btn-add-all" title="全部加入">
                  <span class="material-symbols-outlined">keyboard_double_arrow_right</span>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="strike-sel-btn-remove" title="移除選定">
                  <span class="material-symbols-outlined">keyboard_arrow_left</span>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="strike-sel-btn-remove-all" title="全部移除">
                  <span class="material-symbols-outlined">keyboard_double_arrow_left</span>
                </button>
              </div>

              <!-- 右側：選定沖帳之憑證 -->
              <div class="paper-search-col paper-search-col-right">
                <div class="paper-search-title-row">
                  <div class="paper-search-title">選定沖帳之憑證</div>
                  <div class="paper-search-count" id="strike-sel-target-count">0</div>
                </div>
                <div class="paper-search-scroll">
                  <table class="table table-sm table-striped mb-0">
                    <thead>
                      <tr>
                        <th>帳款編號</th>
                        <th>帳款日期</th>
                        <th>客戶編號</th>
                        <th>簡稱</th>
                        <th>剩餘原幣金額</th>
                        <th>剩餘金額</th>
                        <th>付款日</th>
                        <th>發票號碼</th>
                        <th>幣別</th>
                        <th>匯率</th>
                      </tr>
                    </thead>
                    <tbody id="strike-sel-target-body"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- 下半部：憑證明細 -->
          <div class="strike-bottom-section certif-detail-section">
            <div class="certif-detail-title">憑證明細</div>
            <div class="certif-detail-scroll">
              <table class="table table-sm table-striped mb-0">
                <thead>
                  <tr>
                    <th>憑證單號</th>
                    <th>單據日期</th>
                    <th>是發票</th>
                    <th>發票號碼</th>
                    <th>摘要/客戶訂單號碼,最終客戶</th>
                    <th>幣別</th>
                    <th>匯率</th>
                    <th>原幣總金額</th>
                    <th>原幣已沖金額</th>
                    <th>總金額</th>
                    <th>已沖金額</th>
                    <th>發票種類</th>
                    <th>稅式代號</th>
                    <th>付款方式</th>
                    <th>付款日期</th>
                    <th>單據種類</th>
                    <th>代扣類別</th>
                  </tr>
                </thead>
                <tbody id="strike-sel-certif-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 底部區域 -->
      <div class="modal-footer">
        <div class="ps-summary">
          <div class="ps-summary-item">
            <span class="ps-summary-label">合計總金額：</span>
            <span class="ps-summary-value" id="strike-sel-total-amount">0</span>
          </div>
          <div class="ps-summary-item">
            <span class="ps-summary-label">合計原幣總額：</span>
            <span class="ps-summary-value" id="strike-sel-total-amount-og">0</span>
          </div>
        </div>
        <button type="button" class="btn btn-success" id="strike-sel-btn-ok">確定</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
    window.ActionRailCustomHandlers = window.ActionRailCustomHandlers || {};
    window.ActionRailCustomHandlers['PR000004'] = {};

    const ITEM_ID = 'APRdStrikeMain';
    const DOM_PREFIX = 'strike-sel';

    // 狀態管理
    const state = {
        paperNum: '',
        useId: '',
        companyId: '',
        isIn: '',
        strikeMode: 0,
        moneyCode: '',
        sourceRows: [],
        targetRows: [],
        selectedSourceIndices: new Set(),
        selectedTargetIndices: new Set(),
        currentSelectedPaperNum: '',  // 當前選中的憑證號碼（用於顯示明細）
        certifRows: [],
        showDepart: false,
        existingDetailPaperNums: []  // 紀錄已存在於資料庫的明細憑證號碼
    };

    // DOM 元素
    const els = {};
    const elIds = [
        'modal', 'company', 'paper-date', 'paper-num', 'expect-date', 'money',
        'isin', 'useid', 'depart', 'btn-find', 'source-body', 'target-body',
        'certif-body', 'btn-add', 'btn-add-all', 'btn-remove', 'btn-remove-all',
        'total-amount', 'total-amount-og', 'btn-ok', 'depart-field',
        'source-count', 'target-count'
    ];

    const readPaperNum = (ctx) => {
        const v = (ctx?.paperNum || window._paperNum || '').toString().trim();
        if (v) return v;
        if (typeof window.getPaperNum === 'function') {
            try { return (window.getPaperNum() || '').toString().trim(); } catch { /* ignore */ }
        }
        return '';
    };

    const withJwtHeaders = (init = {}) => {
        const jwt = localStorage.getItem('jwtId');
        const headers = Object.assign({}, init.headers || {});
        if (jwt) headers['X-JWTID'] = jwt;
        return { ...init, headers };
    };

    const notify = async (type, message) => {
        if (window.Swal) {
            const icon = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
            await window.Swal.fire({ icon, title: message });
            return;
        }
        alert(message);
    };

    const formatDate = (val) => {
        if (!val) return '';
        const d = new Date(val);
        if (isNaN(d.getTime())) return '';
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const formatNumber = (val) => {
        if (val === null || val === undefined || val === '') return '0';
        const n = parseFloat(val);
        return isNaN(n) ? '0' : n.toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    };

    const initElements = () => {
        elIds.forEach(id => {
            els[id] = document.getElementById(`${DOM_PREFIX}-${id}`);
        });
    };

    // Modal 處理
    let modal = null;
    let manualBackdrop = null;

    const forceShowModal = () => {
        if (!els.modal) return;
        els.modal.classList.add('show');
        els.modal.style.display = 'block';
        els.modal.style.zIndex = '1055';
        els.modal.removeAttribute('aria-hidden');
        els.modal.setAttribute('aria-modal', 'true');
        if (!manualBackdrop) {
            manualBackdrop = document.createElement('div');
            manualBackdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(manualBackdrop);
        }
    };

    const forceHideModal = () => {
        if (!els.modal) return;
        els.modal.classList.remove('show');
        els.modal.style.display = 'none';
        els.modal.setAttribute('aria-hidden', 'true');
        els.modal.removeAttribute('aria-modal');
        if (manualBackdrop) {
            manualBackdrop.remove();
            manualBackdrop = null;
        }
    };

    const showModal = () => {
        if (modal) {
            modal.show();
            if (!els.modal.classList.contains('show')) {
                forceShowModal();
            }
            return;
        }
        forceShowModal();
    };

    const hideModal = () => {
        if (modal) {
            modal.hide();
            return;
        }
        forceHideModal();
    };

    // 載入下拉選項
    const loadOptions = async () => {
        // 帳款型態
        const isInResp = await fetch('/api/StrikeSelect/IsInOptions', withJwtHeaders());
        if (isInResp.ok) {
            const rows = await isInResp.json();
            els.isin.innerHTML = '<option value=""></option>' + (rows || []).map(r =>
                `<option value="${r.value}">${r.value} ${r.text}</option>`
            ).join('');
        }

        // 公司別
        const useIdResp = await fetch('/api/StrikeSelect/UseIdOptions', withJwtHeaders());
        if (useIdResp.ok) {
            const rows = await useIdResp.json();
            els.useid.innerHTML = '<option value=""></option>' + (rows || []).map(r =>
                `<option value="${r.value}">${r.value} ${r.text}</option>`
            ).join('');
        }

        // 客戶名稱
        const companyResp = await fetch('/api/StrikeSelect/CompanyOptions', withJwtHeaders());
        if (companyResp.ok) {
            const rows = await companyResp.json();
            els.company.innerHTML = '<option value=""></option>' + (rows || []).map(r =>
                `<option value="${r.value}">${r.value} ${r.text}</option>`
            ).join('');
        }

        // 幣別（含「不限」選項）
        const moneyResp = await fetch('/api/StrikeSelect/MoneyOptions', withJwtHeaders());
        if (moneyResp.ok) {
            const rows = await moneyResp.json();
            els.money.innerHTML = '<option value=""></option>' + (rows || []).map(r =>
                `<option value="${r.value}">${r.text}</option>`
            ).join('');
        }

        // 部門
        const departResp = await fetch('/api/StrikeSelect/DepartOptions', withJwtHeaders());
        if (departResp.ok) {
            const rows = await departResp.json();
            els.depart.innerHTML = '<option value=""></option>' + (rows || []).map(r =>
                `<option value="${r.value}">${r.value} ${r.text}</option>`
            ).join('');
        }
    };

    // 載入主檔資料
    const loadMainData = async (paperNum) => {
        const resp = await fetch(`/api/StrikeSelect/GetMainData?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
        if (!resp.ok) {
            await notify('error', '載入主檔資料失敗');
            return false;
        }
        const data = await resp.json();
        if (!data.ok) {
            if (data.error) await notify('warning', data.error);
            return false;
        }

        state.useId = data.useId || '';
        state.companyId = (data.companyId || '').trim();  // 去除空格
        state.isIn = data.isIn?.toString() || '';
        state.strikeMode = data.strikeMode || 0;
        state.moneyCode = data.moneyCode?.toString() || '';
        state.showDepart = data.showDepart || false;

        // 設定預設值
        if (state.companyId) els.company.value = state.companyId;
        if (state.useId) els.useid.value = state.useId;
        if (state.isIn) els.isin.value = state.isIn;

        // 設定幣別預設值
        if (state.moneyCode && state.moneyCode !== '0') {
            els.money.value = state.moneyCode;
        } else {
            els.money.value = '255';  // 不限
        }

        // 控制部門欄位可見性
        if (state.showDepart) {
            els['depart-field'].style.display = '';
        } else {
            els['depart-field'].style.display = 'none';
        }

        return true;
    };

    // 載入已選取的資料
    const loadSelectedData = async (paperNum) => {
        const resp = await fetch(`/api/StrikeSelect/GetSelected?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
        if (!resp.ok) return;
        const data = await resp.json();
        if (data.ok && Array.isArray(data.rows)) {
            state.existingDetailPaperNums = data.rows.map(r => r.PaperNum);
        }
    };

    // 查詢可選憑證
    const doSearch = async () => {
        const condition = {
            isIn: els.isin.value,
            useId: els.useid.value,
            companyId: (els.company.value || '').trim(),  // 去除空格
            paperDate: els['paper-date'].value,
            expectDate: els['expect-date'].value,
            paperNum: els['paper-num'].value,
            moneyCode: els.money.value,
            departId: els.depart.value,
            mainPaperNum: state.paperNum,
            excludePaperNums: state.existingDetailPaperNums
        };

        // 清空左側和右側顯示
        state.sourceRows = [];
        state.targetRows = [];
        state.selectedSourceIndices.clear();
        state.selectedTargetIndices.clear();
        state.currentSelectedPaperNum = '';
        state.certifRows = [];
        renderSourceTable();
        renderTargetTable();
        renderCertifTable();
        updateSummary();

        const resp = await fetch('/api/StrikeSelect/Search', withJwtHeaders({
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(condition)
        }));

        if (!resp.ok) {
            await notify('error', '查詢失敗');
            return;
        }

        const data = await resp.json();
        if (!data.ok) {
            await notify('error', data.error || '查詢失敗');
            return;
        }

        state.sourceRows = data.rows || [];

        renderSourceTable();
        updateSummary();
    };

    // 載入憑證明細
    const loadCertifDetail = async (paperNum) => {
        if (!paperNum) {
            state.certifRows = [];
            renderCertifTable();
            return;
        }

        const resp = await fetch(`/api/StrikeSelect/GetCertifDetail?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
        if (!resp.ok) {
            state.certifRows = [];
            renderCertifTable();
            return;
        }

        const data = await resp.json();
        if (data.ok && Array.isArray(data.rows)) {
            state.certifRows = data.rows;
        } else {
            state.certifRows = [];
        }
        renderCertifTable();
    };

    // 更新表格行樣式（不重建 DOM）
    const updateRowStyles = (bodyElement, selectedIndices) => {
        if (!bodyElement) return;
        const rows = bodyElement.querySelectorAll('tr');
        rows.forEach((tr, idx) => {
            if (selectedIndices.has(idx)) {
                tr.classList.add('selected');
            } else {
                tr.classList.remove('selected');
            }
        });
    };

    // 渲染來源/目標表格
    const renderTable = (bodyElement, dataRows, selectedIndices) => {
        if (!bodyElement) return;

        bodyElement.innerHTML = dataRows.map((r, idx) => `
            <tr data-index="${idx}" class="${selectedIndices.has(idx) ? 'selected' : ''}">
                <td>${r.PaperNum || ''}</td>
                <td>${formatDate(r.PaperDate)}</td>
                <td>${r.CompanyId || ''}</td>
                <td>${r.ShortName || ''}</td>
                <td style="text-align:right;">${formatNumber(r.RestAmountOg)}</td>
                <td style="text-align:right;">${formatNumber(r.RestAmount)}</td>
                <td>${formatDate(r.ExpectDate)}</td>
                <td>${r.Notes || ''}</td>
                <td>${r.MoneyName || ''}</td>
                <td>${r.RateToNT || ''}</td>
            </tr>
        `).join('');
    };

    const renderSourceTable = () => {
        renderTable(els['source-body'], state.sourceRows, state.selectedSourceIndices);
    };

    const renderTargetTable = () => {
        renderTable(els['target-body'], state.targetRows, state.selectedTargetIndices);
    };

    // 渲染憑證明細表格
    const renderCertifTable = () => {
        if (!els['certif-body']) return;

        els['certif-body'].innerHTML = state.certifRows.map((r, idx) => {
            const isStop = r.IsStop === 1;
            const rowClass = isStop ? 'stop-payment' : '';
            return `
            <tr data-index="${idx}" class="${rowClass}">
                <td>${r.PaperNum || ''}</td>
                <td>${formatDate(r.PaperDate)}</td>
                <td>${r.IsInvoice === 1 ? '是' : '否'}</td>
                <td>${r.InvoiceNum || ''}</td>
                <td>${r.ItemSpec || ''}</td>
                <td>${r.MoneyCodeName || ''}</td>
                <td>${r.RateToNT || ''}</td>
                <td style="text-align:right;">${formatNumber(r.TotalAmountOg)}</td>
                <td style="text-align:right;">${formatNumber(r.FinishAmountOg)}</td>
                <td style="text-align:right;">${formatNumber(r.TotalAmount)}</td>
                <td style="text-align:right;">${formatNumber(r.FinishAmount)}</td>
                <td>${r.InvoiceTypeName || ''}</td>
                <td>${r.TaxTypeName || ''}</td>
                <td>${r.PayWayName || ''}</td>
                <td>${formatDate(r.ExpectDate)}</td>
                <td>${r.CertifTypeName || ''}</td>
                <td>${r.TaxCutTypeName || ''}</td>
            </tr>
        `;
        }).join('');
    };

    // 更新合計與計數
    const updateSummary = () => {
        let total = 0;
        let totalOg = 0;
        state.targetRows.forEach(r => {
            total += parseFloat(r.RestAmount) || 0;
            totalOg += parseFloat(r.RestAmountOg) || 0;
        });
        els['total-amount'].textContent = formatNumber(total);
        els['total-amount-og'].textContent = formatNumber(totalOg);
        if (els['source-count']) els['source-count'].textContent = state.sourceRows.length;
        if (els['target-count']) els['target-count'].textContent = state.targetRows.length;
        // 根據右側是否有資料來控制確定按鈕的啟用狀態
        if (els['btn-ok']) {
            if (state.targetRows.length > 0) {
                els['btn-ok'].disabled = false;
                els['btn-ok'].classList.remove('disabled');
            } else {
                els['btn-ok'].disabled = true;
                els['btn-ok'].classList.add('disabled');
            }
        }
    };

    // 加入選定
    const addSelected = () => {
        const toAdd = [];
        state.selectedSourceIndices.forEach(idx => {
            const row = state.sourceRows[idx];
            if (row && !state.targetRows.some(t => t.PaperNum === row.PaperNum)) {
                toAdd.push({ ...row });
            }
        });

        // 檢查是否會超過可沖金額
        let totalToAdd = 0;
        toAdd.forEach(r => {
            totalToAdd += parseFloat(r.RestAmountOg) || 0;
        });

        if (totalToAdd < 0) {
            notify('warning', '選擇金額超過可沖帳金額!!');
            return;
        }

        state.targetRows.push(...toAdd);

        // 從來源移除已加入的項目
        const remaining = state.sourceRows.filter((_, idx) => !state.selectedSourceIndices.has(idx));
        state.sourceRows = remaining;
        state.selectedSourceIndices.clear();

        renderSourceTable();
        renderTargetTable();
        updateSummary();
    };

    // 全部加入
    const addAll = () => {
        state.sourceRows.forEach(row => {
            if (!state.targetRows.some(t => t.PaperNum === row.PaperNum)) {
                state.targetRows.push({ ...row });
            }
        });
        state.sourceRows = [];
        state.selectedSourceIndices.clear();

        renderSourceTable();
        renderTargetTable();
        updateSummary();
    };

    // 移除選擇
    const removeSelected = () => {
        const toRemove = [];
        state.selectedTargetIndices.forEach(idx => {
            const row = state.targetRows[idx];
            if (row) toRemove.push({ ...row });
        });

        const remaining = state.targetRows.filter((_, idx) => !state.selectedTargetIndices.has(idx));
        state.targetRows = remaining;
        state.selectedTargetIndices.clear();

        state.sourceRows.push(...toRemove);

        renderSourceTable();
        renderTargetTable();
        updateSummary();
    };

    // 全部移除
    const removeAll = () => {
        state.sourceRows.push(...state.targetRows);
        state.targetRows = [];
        state.selectedTargetIndices.clear();

        renderSourceTable();
        renderTargetTable();
        updateSummary();
    };

    // 確定按鈕
    // 完成確認後的共用流程（關閉 modal → 刷新 → 開啟沖帳明細）
    const finishConfirmFlow = async () => {
        // 關閉 modal
        hideModal();

        // 刷新單頭和單身的資料
        if (typeof window.__refreshHeaderData === "function") {
            try { await window.__refreshHeaderData(); } catch {}
        }
        if (typeof window.__refreshMultiTab === "function") {
            try { await window.__refreshMultiTab(); } catch {}
        }

        // 自動開啟沖帳明細維護
        const openDtl = window.ActionRailCustomHandlers?.['PR000004']?.btnC2;
        if (typeof openDtl === 'function') {
            try { await openDtl({ paperNum: state.paperNum }); } catch (e) { console.error('Auto open strike detail error:', e); }
        }
        if (window.Swal) Swal.close();
    };

    // 顯示外幣匯率確認對話框 (對應 Delphi StrikeOtherAmountSelect)
    const showOtherOgRateDialog = async (ogData) => {
        // 取得幣別名稱（從已載入的幣別選項中查找）
        let moneyDisplayName = ogData.moneyName || '';
        const moneyOpt = els.money?.querySelector(`option[value="${ogData.moneyCode}"]`);
        if (moneyOpt) moneyDisplayName = moneyOpt.textContent;

        const result = await Swal.fire({
            title: '沖帳幣別匯率確認',
            html: `
                <div style="text-align: left; font-size: 14px;">
                    <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <label style="width: 60px; text-align: right;">幣別:</label>
                        <input type="text" id="swal-og-money" class="swal2-input" value="${moneyDisplayName}" readonly
                               style="margin: 0; width: 180px; background: #e9ecef; font-size: 14px; height: 32px; padding: 4px 8px;" />
                    </div>
                    <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <label style="width: 60px; text-align: right;">匯率:</label>
                        <input type="text" id="swal-og-rate" class="swal2-input" value="${ogData.currentRate || 0}"
                               style="margin: 0; width: 180px; font-size: 14px; height: 32px; padding: 4px 8px;" />
                    </div>
                    <div style="display: flex; justify-content: flex-start; padding-left: 68px;">
                        <button type="button" id="swal-og-fetch-rate" class="btn btn-sm btn-outline-secondary">取用三旬匯率</button>
                    </div>
                </div>`,
            showCancelButton: true,
            confirmButtonText: '確定',
            cancelButtonText: '取消',
            didOpen: () => {
                const fetchBtn = document.getElementById('swal-og-fetch-rate');
                if (fetchBtn) {
                    fetchBtn.addEventListener('click', async () => {
                        try {
                            const resp = await fetch(`/api/StrikeSelect/GetHistoricalRate?moneyCode=${ogData.moneyCode}`, withJwtHeaders());
                            if (resp.ok) {
                                const d = await resp.json();
                                if (d.ok && d.rate) {
                                    document.getElementById('swal-og-rate').value = d.rate;
                                }
                            }
                        } catch (e) {
                            console.error('Fetch historical rate error:', e);
                        }
                    });
                }
            },
            preConfirm: () => {
                const rateVal = document.getElementById('swal-og-rate')?.value;
                const parsed = parseFloat(rateVal);
                if (isNaN(parsed) || rateVal.trim() === '') {
                    Swal.showValidationMessage('匯率格式不符!!');
                    return false;
                }
                return parsed;
            }
        });

        return result;
    };

    const doConfirm = async () => {
        if (state.targetRows.length === 0) {
            await notify('info', '請選擇要加入的憑證');
            return;
        }

        // 確認後立刻顯示載入提示
        if (window.Swal) Swal.fire({ title: '沖帳明細維護開啟中...', allowOutsideClick: false, allowEscapeKey: false, showConfirmButton: false, didOpen: () => Swal.showLoading() });

        try {
            const resp = await fetch('/api/StrikeSelect/Confirm', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paperNum: state.paperNum,
                    rows: state.targetRows.map(r => r.PaperNum)
                })
            }));

            const raw = await resp.text();
            let data;
            try { data = JSON.parse(raw); } catch { data = { ok: false, error: raw }; }

            if (!resp.ok || !data.ok) {
                if (window.Swal) Swal.close();
                await Swal.fire({ icon: 'error', title: '匯入失敗', text: data.error || `HTTP ${resp.status}` });
                return;
            }

            // 檢查是否需要外幣匯率確認 (對應 Delphi APRdStrikeUseOtherOg)
            if (data.needOtherOg) {
                if (window.Swal) Swal.close();

                const ogResult = await showOtherOgRateDialog(data);

                if (!ogResult.isConfirmed || ogResult.value === false) {
                    // 使用者取消，不繼續（來源已寫入但 Status 未更新，對應 Delphi 的 ModalResult:=mrNone）
                    return;
                }

                // 使用者確認匯率，送出更新
                if (window.Swal) Swal.fire({ title: '匯率更新中...', allowOutsideClick: false, allowEscapeKey: false, showConfirmButton: false, didOpen: () => Swal.showLoading() });

                const ogResp = await fetch('/api/StrikeSelect/ConfirmOtherOgRate', withJwtHeaders({
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paperNum: state.paperNum,
                        newRate: ogResult.value
                    })
                }));

                const ogRaw = await ogResp.text();
                let ogData2;
                try { ogData2 = JSON.parse(ogRaw); } catch { ogData2 = { ok: false, error: ogRaw }; }

                if (!ogResp.ok || !ogData2.ok) {
                    if (window.Swal) Swal.close();
                    await Swal.fire({ icon: 'error', title: '匯率更新失敗', text: ogData2.error || `HTTP ${ogResp.status}` });
                    return;
                }
            }

            await finishConfirmFlow();
        } catch (err) {
            if (window.Swal) Swal.close();
            console.error('Confirm error:', err);
            await Swal.fire({ icon: 'error', title: '執行錯誤', text: err.message });
        }
    };

    // 清除表單
    const clearForm = () => {
        els.company.value = '';
        els['paper-date'].value = '';
        els['paper-num'].value = '';
        els['expect-date'].value = '';
        els.money.value = '';
        els.depart.value = '';

        state.sourceRows = [];
        state.targetRows = [];
        state.selectedSourceIndices.clear();
        state.selectedTargetIndices.clear();
        state.currentSelectedPaperNum = '';
        state.certifRows = [];

        renderSourceTable();
        renderTargetTable();
        renderCertifTable();
        updateSummary();
    };

    // 事件是否已綁定的標記
    let eventsBound = false;

    // 開啟對話框
    const openStrikeSelect = async (ctx) => {
        if (!els.modal || !eventsBound) {
            initEvents();
        }

        const paperNum = readPaperNum(ctx);
        if (!paperNum) {
            return Swal.fire({ icon: 'info', title: '沒有單號' });
        }

        state.paperNum = paperNum;
        clearForm();

        try {
            await loadOptions();
            const success = await loadMainData(paperNum);
            if (!success) {
                return;
            }
            await loadSelectedData(paperNum);
            showModal();
        } catch (err) {
            console.error('openStrikeSelect error:', err);
            await Swal.fire({ icon: 'error', title: '載入失敗', text: err.message });
        }
    };

    // 綁定表格事件
    const bindTableEvents = () => {
        if (!els['source-body'] || !els['target-body']) return;

        // 來源表格點擊事件
        els['source-body'].addEventListener('click', (e) => {
            const tr = e.target.closest('tr');
            if (!tr) return;
            const idx = parseInt(tr.dataset.index, 10);
            if (isNaN(idx)) return;

            if (e.ctrlKey || e.metaKey) {
                if (state.selectedSourceIndices.has(idx)) {
                    state.selectedSourceIndices.delete(idx);
                } else {
                    state.selectedSourceIndices.add(idx);
                }
            } else if (e.shiftKey && state.selectedSourceIndices.size > 0) {
                const lastIdx = Math.max(...state.selectedSourceIndices);
                const minIdx = Math.min(idx, lastIdx);
                const maxIdx = Math.max(idx, lastIdx);
                for (let i = minIdx; i <= maxIdx; i++) {
                    state.selectedSourceIndices.add(i);
                }
            } else {
                state.selectedSourceIndices.clear();
                state.selectedSourceIndices.add(idx);
            }

            // 更新憑證明細
            const row = state.sourceRows[idx];
            if (row && row.PaperNum !== state.currentSelectedPaperNum) {
                state.currentSelectedPaperNum = row.PaperNum;
                loadCertifDetail(row.PaperNum);
            }

            // 只更新樣式，不重建 DOM
            updateRowStyles(els['source-body'], state.selectedSourceIndices);
        });

        // 目標表格點擊事件
        els['target-body'].addEventListener('click', (e) => {
            const tr = e.target.closest('tr');
            if (!tr) return;
            const idx = parseInt(tr.dataset.index, 10);
            if (isNaN(idx)) return;

            if (e.ctrlKey || e.metaKey) {
                if (state.selectedTargetIndices.has(idx)) {
                    state.selectedTargetIndices.delete(idx);
                } else {
                    state.selectedTargetIndices.add(idx);
                }
            } else if (e.shiftKey && state.selectedTargetIndices.size > 0) {
                const lastIdx = Math.max(...state.selectedTargetIndices);
                const minIdx = Math.min(idx, lastIdx);
                const maxIdx = Math.max(idx, lastIdx);
                for (let i = minIdx; i <= maxIdx; i++) {
                    state.selectedTargetIndices.add(i);
                }
            } else {
                state.selectedTargetIndices.clear();
                state.selectedTargetIndices.add(idx);
            }

            // 更新憑證明細
            const row = state.targetRows[idx];
            if (row && row.PaperNum !== state.currentSelectedPaperNum) {
                state.currentSelectedPaperNum = row.PaperNum;
                loadCertifDetail(row.PaperNum);
            }

            // 只更新樣式，不重建 DOM
            updateRowStyles(els['target-body'], state.selectedTargetIndices);
        });

        // 雙擊快速加入/移除
        els['source-body'].addEventListener('dblclick', (e) => {
            const tr = e.target.closest('tr');
            if (!tr) return;
            const idx = parseInt(tr.dataset.index, 10);
            if (isNaN(idx)) return;
            state.selectedSourceIndices.clear();
            state.selectedSourceIndices.add(idx);
            addSelected();
        });

        els['target-body'].addEventListener('dblclick', (e) => {
            const tr = e.target.closest('tr');
            if (!tr) return;
            const idx = parseInt(tr.dataset.index, 10);
            if (isNaN(idx)) return;
            state.selectedTargetIndices.clear();
            state.selectedTargetIndices.add(idx);
            removeSelected();
        });
    };

    // 初始化事件
    const initEvents = () => {
        initElements();

        if (!els.modal) return;
        if (eventsBound) return;
        eventsBound = true;

        // Modal 初始化
        if (window.bootstrap?.Modal) {
            modal = window.bootstrap.Modal.getOrCreateInstance(els.modal, { backdrop: 'static' });
        }

        // 拖曳功能
        const headerEl = els.modal.querySelector('.modal-header');
        const dialogEl = els.modal.querySelector('.modal-dialog');
        if (headerEl && dialogEl) {
            let dragging = false;
            let startX = 0, startY = 0, origX = 0, origY = 0;

            headerEl.addEventListener('mousedown', (e) => {
                dragging = true;
                const rect = dialogEl.getBoundingClientRect();
                startX = e.clientX;
                startY = e.clientY;
                origX = rect.left;
                origY = rect.top;
                dialogEl.style.position = 'fixed';
                dialogEl.style.left = `${origX}px`;
                dialogEl.style.top = `${origY}px`;
                dialogEl.style.transform = 'none';
                dialogEl.style.margin = '0';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!dragging) return;
                dialogEl.style.left = `${origX + e.clientX - startX}px`;
                dialogEl.style.top = `${origY + e.clientY - startY}px`;
            });

            document.addEventListener('mouseup', () => { dragging = false; });
        }

        // 按鈕事件
        els['btn-find']?.addEventListener('click', doSearch);
        els['btn-add']?.addEventListener('click', addSelected);
        els['btn-add-all']?.addEventListener('click', addAll);
        els['btn-remove']?.addEventListener('click', removeSelected);
        els['btn-remove-all']?.addEventListener('click', removeAll);
        els['btn-ok']?.addEventListener('click', doConfirm);

        // 綁定表格事件
        bindTableEvents();

        // Modal 關閉事件
        els.modal.addEventListener('hidden.bs.modal', () => {
            forceHideModal();
        });
        els.modal.querySelectorAll('[data-bs-dismiss="modal"], .btn-close').forEach((btn) => {
            btn.addEventListener('click', () => {
                if (!modal) forceHideModal();
            });
        });
    };

    // DOM 載入後初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEvents);
    } else {
        initEvents();
    }

    // 註冊按鈕處理函式
    window.ActionRailCustomHandlers['PR000004'].btnC6 = openStrikeSelect;  // 可沖帳之憑證選擇

    // 全域函式呼叫（供其他作業調用）
    window.StrikeSelectHandler = {
        open: openStrikeSelect
    };
})();
</script>

<!-- 沖帳明細維護 Modal -->
<div class="modal fade" id="strike-dtl-modal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content" style="display: flex; flex-direction: column; height: 100%;">
      <div class="modal-header" style="cursor: move; user-select: none; padding: 2px 8px;">
        <h5 class="modal-title" style="font-size: 16px;">沖帳明細維護</h5>
        <button type="button" class="btn-close" id="strike-dtl-btn-close-x" aria-label="Close"></button>
      </div>

      <div class="modal-body" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 4px 12px;">
        <!-- 工具列 -->
        <div id="strike-dtl-toolbar" style="display: flex; gap: 16px; padding: 1px 8px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; margin-top: 1px; margin-bottom: 1px; flex-wrap: wrap; align-items: center;">
          <div style="display: flex; align-items: center; gap: 6px;">
            <label style="font-size: 13px; white-space: nowrap;">沖銷匯率:</label>
            <input type="text" id="strike-dtl-rate-strike" readonly style="width: 100px; font-size: 13px; padding: 2px 6px;" />
          </div>
          <div id="strike-dtl-rate-pr-field" style="display: none; align-items: center; gap: 6px;">
            <label style="font-size: 13px; white-space: nowrap;">帳單即期匯率:</label>
            <input type="text" id="strike-dtl-rate-pr" readonly style="width: 100px; font-size: 13px; padding: 2px 6px;" />
          </div>
          <div id="strike-dtl-money-code-field" style="display: none; align-items: center; gap: 6px;">
            <label style="font-size: 13px; white-space: nowrap;">幣別:</label>
            <select id="strike-dtl-money-code" disabled style="width: 150px; font-size: 13px; padding: 2px 6px;">
              <option value="">請選擇</option>
            </select>
          </div>
          <div style="display: flex; align-items: center; gap: 6px;">
            <label style="font-size: 13px; white-space: nowrap;">沖帳模式:</label>
            <select id="strike-dtl-strike-mode" style="width: 120px; font-size: 13px; padding: 2px 6px;">
              <option value="0">外幣</option>
              <option value="1">本位幣</option>
            </select>
          </div>
          <button type="button" class="btn btn-sm btn-primary" id="strike-dtl-btn-advance">預收付沖帳</button>
          <button type="button" class="btn btn-sm btn-primary" id="strike-dtl-btn-other">對沖帳</button>
          <span id="strike-dtl-lbl-discount" style="color: blue; font-size: 13px; display: none;"></span>
          <span id="strike-dtl-lbl-check" style="color: red; font-size: 13px;"></span>
        </div>

        <!-- 主要內容區 (上下分割) -->
        <div style="flex: 1; display: flex; flex-direction: column; min-height: 0; gap: 2px;">
          <!-- 上半部：沖帳明細 (50%) -->
          <div id="strike-dtl-detail-section" style="flex: 1 1 0; display: flex; flex-direction: column; min-height: 0; border: 1px solid #dee2e6; border-radius: 4px;">
            <ul class="nav nav-tabs" id="strike-dtl-detail-navtabs">
              <li class="nav-item">
                <a class="nav-link active" data-tab-target="#strike-dtl-cash" href="#strike-dtl-cash">現金沖帳</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-tab-target="#strike-dtl-bank" href="#strike-dtl-bank">銀存沖帳</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-tab-target="#strike-dtl-bill" href="#strike-dtl-bill">票據沖帳</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-tab-target="#strike-dtl-other" href="#strike-dtl-other">其他扣款沖帳</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-tab-target="#strike-dtl-debit" href="#strike-dtl-debit">抵扣款明細</a>
              </li>
            </ul>

            <div class="tab-content" id="strike-dtl-detail-tabs" style="flex: 1; min-height: 0; overflow: auto;">
              <!-- 現金沖帳 -->
              <div class="tab-pane fade show active" id="strike-dtl-cash" data-flex="column" style="height: 100%;">
                <div class="strike-toolbar">
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="post" data-target="cash">&#10003;</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="cancel" data-target="cash">&#10007;</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="refresh" data-target="cash">&#8635;</button>
                </div>
                <div style="padding: 12px;">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-size: 14px;">現金金額:</label>
                    <input type="number" id="strike-dtl-cash-amount" step="0.01" style="width: 200px; font-size: 14px; padding: 4px 8px;" />
                  </div>
                </div>
              </div>

              <!-- 銀存沖帳 -->
              <div class="tab-pane fade" id="strike-dtl-bank" data-flex="column" style="height: 100%;">
                <div class="strike-toolbar">
                  <button type="button" class="btn btn-sm btn-outline-primary" data-action="insert" data-target="bank">+</button>
                  <button type="button" class="btn btn-sm btn-outline-danger" data-action="delete" data-target="bank">-</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="post" data-target="bank">&#10003;</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="cancel" data-target="bank">&#10007;</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="refresh" data-target="bank">&#8635;</button>
                </div>
                <div style="flex: 1; overflow: auto;">
                  <table class="table table-sm table-bordered mb-0" style="font-size: 14px;">
                    <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 1;">
                      <tr>
                        <th>項次</th>
                        <th>是預約</th>
                        <th>預約日期</th>
                        <th>銀行代碼</th>
                        <th>銀行名稱</th>
                        <th>帳戶號碼</th>
                        <th>金額</th>
                      </tr>
                    </thead>
                    <tbody id="strike-dtl-tbody-bank"></tbody>
                  </table>
                </div>
              </div>

              <!-- 票據沖帳 -->
              <div class="tab-pane fade" id="strike-dtl-bill" data-flex="column" style="height: 100%;">
                <div class="strike-toolbar">
                  <button type="button" class="btn btn-sm btn-outline-primary" data-action="insert" data-target="bill">+</button>
                  <button type="button" class="btn btn-sm btn-outline-danger" data-action="delete" data-target="bill">-</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="post" data-target="bill">&#10003;</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="cancel" data-target="bill">&#10007;</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="refresh" data-target="bill">&#8635;</button>
                </div>
                <div style="flex: 1; overflow: auto;">
                  <table class="table table-sm table-bordered mb-0" style="font-size: 14px;">
                    <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 1;">
                      <tr>
                        <th>項次</th>
                        <th>付款銀行</th>
                        <th>銀行名稱</th>
                        <th>付款帳號</th>
                        <th>票別</th>
                        <th>票別名稱</th>
                        <th class="bill-col-billcode" style="display:none;">票據代號</th>
                        <th>票據號碼</th>
                        <th id="bill-th-amount">金額</th>
                        <th>原幣金額</th>
                        <th>票據科目</th>
                        <th>科目名稱</th>
                        <th>劃線</th>
                        <th>抬頭</th>
                        <th>禁背</th>
                        <th>到期日</th>
                        <th>收款銀行</th>
                        <th>銀行名稱</th>
                        <th>收款帳號</th>
                      </tr>
                    </thead>
                    <tbody id="strike-dtl-tbody-bill"></tbody>
                  </table>
                </div>
              </div>

              <!-- 其他扣款沖帳 -->
              <div class="tab-pane fade" id="strike-dtl-other" role="tabpanel">
                <div class="row g-0">
                  <!-- 左側：科目明細 -->
                  <div class="col-12 col-lg-6 border-end">
                    <div class="strike-toolbar">
                      <button type="button" class="btn btn-sm btn-outline-primary" data-action="insert" data-target="other">+</button>
                      <button type="button" class="btn btn-sm btn-outline-danger" data-action="delete" data-target="other">-</button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" data-action="post" data-target="other">&#10003;</button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" data-action="cancel" data-target="other">&#10007;</button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" data-action="refresh" data-target="other">&#8635;</button>
                      <button type="button" class="btn btn-sm btn-info" id="strike-dtl-btn-else-insert">差額認列</button>
                    </div>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                      <table class="table table-sm table-hover mb-0" style="font-size: 14px;">
                        <thead class="sticky-top">
                          <tr>
                            <th width="50px">項次</th>
                            <th width="120px">科目</th>
                            <th width="150px">科目名稱</th>
                            <th width="120px">子科目</th>
                            <th width="150px">子科目名稱</th>
                            <th width="120px">原幣金額</th>
                            <th width="100px">是超收項目</th>
                            <th width="150px">備註</th>
                          </tr>
                        </thead>
                        <tbody id="strike-dtl-tbody-other"></tbody>
                      </table>
                    </div>
                  </div>

                  <!-- 右側：手續費(本位幣) -->
                  <div class="col-12 col-lg-6" id="strike-dtl-post-panel">
                    <div class="py-0 px-1 border-bottom bg-light">
                      <strong>手續費(本位幣)</strong>
                    </div>
                    <div class="strike-toolbar">
                      <button type="button" class="btn btn-sm btn-outline-primary" data-action="insert" data-target="post">+</button>
                      <button type="button" class="btn btn-sm btn-outline-danger" data-action="delete" data-target="post">-</button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" data-action="post" data-target="post">&#10003;</button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" data-action="cancel" data-target="post">&#10007;</button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" data-action="refresh" data-target="post">&#8635;</button>
                    </div>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                      <table class="table table-sm table-hover mb-0" style="font-size: 14px;">
                        <thead class="sticky-top">
                          <tr>
                            <th width="50px">項次</th>
                            <th width="120px">郵資科目</th>
                            <th width="150px">科目名稱</th>
                            <th width="120px">子科目</th>
                            <th width="150px">子科目名稱</th>
                            <th width="150px">郵資銀行</th>
                            <th width="200px">銀行名稱</th>
                            <th width="150px">郵資帳戶</th>
                            <th width="120px">金額</th>
                          </tr>
                        </thead>
                        <tbody id="strike-dtl-tbody-post"></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 抵扣款明細 -->
              <div class="tab-pane fade" id="strike-dtl-debit" data-flex="column" style="height: 100%;">
                <div class="strike-toolbar">
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="post" data-target="debit">&#10003;</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="cancel" data-target="debit">&#10007;</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="refresh" data-target="debit">&#8635;</button>
                  <button type="button" class="btn btn-sm btn-primary" id="strike-dtl-btn-debit-search">折讓搜尋</button>
                  <button type="button" class="btn btn-sm btn-warning" id="strike-dtl-btn-debit-clear">清除折讓明細</button>
                </div>
                <div style="flex: 1; overflow: auto;">
                  <table class="table table-sm table-bordered mb-0" style="font-size: 14px;">
                    <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 1;">
                      <tr>
                        <th>項次</th>
                        <th>立帳單號</th>
                        <th>折讓單號</th>
                        <th>原始匯率</th>
                        <th>剩餘原幣</th>
                        <th>剩餘金額</th>
                        <th>冲銷原幣</th>
                        <th>冲銷金額</th>
                        <th>發票號碼</th>
                      </tr>
                    </thead>
                    <tbody id="strike-dtl-tbody-debit"></tbody>
                  </table>
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 20px; font-size: 14px; padding: 6px 8px; background: #f8f9fa; border-top: 1px solid #dee2e6; flex-shrink: 0;">
              <span><strong>已輸入金額總計:</strong></span>
              <span>現金: <span id="strike-dtl-txt-use-cash">0</span></span>
              <span>銀存: <span id="strike-dtl-txt-use-bank">0</span></span>
              <span>票據: <span id="strike-dtl-txt-use-bill">0</span></span>
              <span>其他: <span id="strike-dtl-txt-use-other">0</span></span>
              <span>扣款: <span id="strike-dtl-txt-use-debit">0</span></span>
            </div>
          </div>

          <!-- 下半部：沖帳來源 (50%) -->
          <div id="strike-dtl-source-section" style="flex: 1 1 0; display: flex; flex-direction: column; min-height: 0; border: 1px solid #dee2e6; border-radius: 4px;">
            <ul class="nav nav-tabs" id="strike-dtl-source-navtabs">
              <li class="nav-item">
                <a class="nav-link active" data-tab-target="#strike-dtl-source-og" href="#strike-dtl-source-og">(原幣)沖帳帳款</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-tab-target="#strike-dtl-source" href="#strike-dtl-source">(本位幣)沖帳帳款</a>
              </li>
              <li class="nav-item" id="nav-item-source-calc" style="display: none;">
                <a class="nav-link" data-tab-target="#strike-dtl-source-calc" href="#strike-dtl-source-calc">
                  <span id="source-calc-tab-title">兌換對照</span>
                </a>
              </li>
            </ul>

            <div class="tab-content" id="strike-dtl-source-tabs" style="flex: 1; min-height: 0; overflow: auto;">
              <!-- (原幣)沖帳帳款 -->
              <div class="tab-pane fade show active" id="strike-dtl-source-og" data-flex="column" style="height: 100%;">
                <div class="strike-toolbar">
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="post" data-target="source">&#10003;</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="cancel" data-target="source">&#10007;</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="refresh" data-target="source">&#8635;</button>
                  <span style="font-size: 14px; padding: 2px 20px">剩餘金額合計: <span id="strike-dtl-lbl-og-sum">0</span></span>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="move-up" data-target="source-og" style="font-size: 11px; padding: 0px 8px;">上移</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="move-down" data-target="source-og" style="font-size: 11px; padding: 0px 8px;">下移</button>
                  <button type="button" class="btn btn-sm btn-info btn-spe-full" data-source="og" style="display: none; font-size: 11px; padding: 0px 8px;">補滿原值</button>
                </div>
                <div style="flex: 1; overflow: auto;">
                  <table class="table table-sm table-bordered mb-0" style="font-size: 14px;">
                    <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 1;">
                      <tr>
                        <th>立帳單號</th>
                        <th>傳票號碼</th>
                        <th>原始匯率</th>
                        <th>憑證單號</th>
                        <th>發票號碼</th>
                        <th>剩餘原幣</th>
                        <th>現金沖銷</th>
                        <th>銀存沖銷</th>
                        <th>票據沖銷</th>
                        <th>其他沖銷</th>
                        <th>折讓沖銷</th>
                        <th>沖銷金額</th>
                      </tr>
                    </thead>
                    <tbody id="strike-dtl-tbody-source-og"></tbody>
                  </table>
                </div>
              </div>

              <!-- (本位幣)沖帳帳款 -->
              <div class="tab-pane fade" id="strike-dtl-source" data-flex="column" style="height: 100%;">
                <div class="strike-toolbar">
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="post" data-target="source">&#10003;</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="cancel" data-target="source">&#10007;</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="refresh" data-target="source">&#8635;</button>
                  <span style="font-size: 14px;">剩餘金額合計: <span id="strike-dtl-lbl-sum">0</span></span>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="move-up" data-target="source" style="font-size: 11px; padding: 2px 8px;">上移</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="move-down" data-target="source" style="font-size: 11px; padding: 2px 8px;">下移</button>
                  <button type="button" class="btn btn-sm btn-info btn-spe-full" data-source="local" style="display: none; font-size: 11px; padding: 0px 8px;">補滿原值</button>
                </div>
                <div style="flex: 1; overflow: auto;">
                  <table class="table table-sm table-bordered mb-0" style="font-size: 14px;">
                    <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 1;">
                      <tr>
                        <th>立帳單號</th>
                        <th>傳票號碼</th>
                        <th>原始匯率</th>
                        <th>憑證單號</th>
                        <th>發票號碼</th>
                        <th>剩餘金額</th>
                        <th>現金沖銷</th>
                        <th>銀存沖銷</th>
                        <th>票據沖銷</th>
                        <th>其他沖銷</th>
                        <th>折讓沖銷</th>
                        <th>沖銷金額</th>
                      </tr>
                    </thead>
                    <tbody id="strike-dtl-tbody-source"></tbody>
                  </table>
                </div>
              </div>

              <!-- 兌換對照 -->
              <div class="tab-pane fade" id="strike-dtl-source-calc" data-flex="column" style="height: 100%;">
                <div style="padding: 4px 8px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 14px;">剩餘金額合計: <span id="strike-dtl-lbl-og-other-sum">0</span></span>
                  <div class="strike-toolbar">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-action="move-up" data-target="source-calc" style="font-size: 11px; padding: 2px 8px;">上移</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-action="move-down" data-target="source-calc" style="font-size: 11px; padding: 2px 8px;">下移</button>
                  </div>
                </div>
                <div style="flex: 1; overflow: auto;">
                  <table class="table table-sm table-bordered mb-0" style="font-size: 14px;">
                    <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 1;">
                      <tr>
                        <th>來源單號</th>
                        <th>憑單號碼</th>
                        <th>剩餘金額</th>
                        <th>現金金額</th>
                        <th>銀存金額</th>
                        <th>票據金額</th>
                        <th>其他金額</th>
                      </tr>
                    </thead>
                    <tbody id="strike-dtl-tbody-source-calc"></tbody>
                  </table>
                </div>
              </div>
            </div>
            <div style="display: flex; font-size: 14px; padding: 4px 8px; background: #f0f4f8; border-top: 1px solid #dee2e6; flex-shrink: 0;">
              <span>分配總計: <span id="strike-dtl-src-footer-total" style="min-width: 100px; display: inline-block; text-align: right;">0</span></span>
            </div>
          </div>
        </div>

        <!-- 總計顯示 -->
        <div style="padding: 8px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; margin-top: 8px;">
          <div style="display: flex; gap: 20px; font-size: 14px;">
            <span>未沖原幣餘額: <span id="strike-dtl-txt-rest-calc-og">0</span></span>
            <span>沖銷原幣總計: <span id="strike-dtl-txt-sum-amount-og">0</span></span>
            <span>沖銷本位幣(目前匯率)總計: <span id="strike-dtl-txt-sum-amount">0</span></span>
            <span>沖銷本位幣(原始匯率)總計: <span id="strike-dtl-txt-strike-amount">0</span></span>
          </div>
        </div>
      </div>

      <div class="modal-footer" style="padding: 8px 16px;">
        <button type="button" class="btn btn-success btn-lg" id="strike-dtl-btn-save">確定</button>
        <button type="button" class="btn btn-secondary btn-lg" id="strike-dtl-btn-cancel">取消</button>
      </div>
    </div>
  </div>
</div>

<style>
  .amount-red { color: red; }

  /* 統一按鈕列樣式 */
  #strike-dtl-modal .strike-toolbar {
    padding: 0px 0px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
  }

  #strike-dtl-modal .table th, #strike-dtl-modal .table td {
    vertical-align: middle;
    white-space: nowrap;
  }
  #strike-dtl-modal .text-end { text-align: right; }

  /* 統一頁籤樣式 - 依照模板風格 */
  #strike-dtl-modal .nav-tabs {
    border-bottom: none;
    margin-bottom: 0;
    padding-left: 2px;
    flex-shrink: 0;
  }
  #strike-dtl-modal .nav-tabs .nav-link {
    color: #4a6fa8;
    border: 1px solid #bccdea;
    border-radius: 8px 8px 0 0;
    padding: var(--tab-pad-y) var(--tab-pad-x);
    background: #e8eff9;
    transition: color 0.2s ease-in-out, background 0.2s ease-in-out, border-color 0.2s ease-in-out;
    font-size: var(--field-label-size);
    font-weight: 500;
  }
  #strike-dtl-modal .nav-tabs .nav-item:not(:first-child) .nav-link {
    margin-left: -1px;
  }
  #strike-dtl-modal .nav-tabs .nav-link:hover {
    background-color: #d0dcf2;
    border-color: #adbfdf;
    color: #3b5d92;
  }
  #strike-dtl-modal .nav-tabs .nav-link.active {
    color: #1b3f8a;
    background-color: #ffffff;
    border-color: #7da3df;
    box-shadow: 0 -2px 8px 0 rgba(14, 53, 95, 0.12);
    font-weight: 700;
    position: relative;
    z-index: 1;
  }

  /* 修復 tab-content 和 tab-pane 的高度問題 */
  #strike-dtl-modal .tab-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }
  #strike-dtl-modal .tab-pane {
    display: none;
    flex: 1;
    min-height: 0;
  }
  #strike-dtl-modal .tab-pane.show.active {
    display: flex !important;
    flex-direction: column !important;
  }

  /* 調窄各頁籤欄位高度（現金沖帳除外） */
  #strike-dtl-bank th, #strike-dtl-bank td,
  #strike-dtl-bill th, #strike-dtl-bill td,
  #strike-dtl-other th, #strike-dtl-other td,
  #strike-dtl-debit th, #strike-dtl-debit td,
  #strike-dtl-source-og th, #strike-dtl-source-og td,
  #strike-dtl-source th, #strike-dtl-source td {
    padding-top: 1px;
    padding-bottom: 1px;
  }
  #strike-dtl-bank .form-control-sm,
  #strike-dtl-bill .form-control-sm,
  #strike-dtl-other .form-control-sm,
  #strike-dtl-debit .form-control-sm,
  #strike-dtl-source-og .form-control-sm,
  #strike-dtl-source .form-control-sm {
    height: 20px;
  }

  /* 讓表格中的輸入框寬度跟隨欄位寬度 */
  #strike-dtl-modal .table td input.form-control,
  #strike-dtl-modal .table td input.form-control-sm {
    width: 100%;
    box-sizing: border-box;
  }

  /* 欄位拖拽調整寬度 */
  #strike-dtl-modal thead th { position: relative; user-select: none; }
  #strike-dtl-modal thead th .col-resizer {
    position: absolute;
    top: 0; right: 0; bottom: 0;
    width: 6px;
    cursor: col-resize;
    z-index: 2;
  }
  #strike-dtl-modal thead th .col-resizer:hover,
  #strike-dtl-modal thead th .col-resizer.active { background: #adc8e6; }
</style>

<script>
// strikedetail.js - 沖帳明細維護
(() => {
    window.ActionRailCustomHandlers = window.ActionRailCustomHandlers || {};
    window.ActionRailCustomHandlers['PR000004'] = window.ActionRailCustomHandlers['PR000004'] || {};

    const ITEM_ID = 'APRdStrikeMain';
    const DOM_PREFIX = 'strike-dtl';

    // 全域變數
    let paperNum = '';
    let isIn = 0;
    let strikeMode = 0; // 0:外幣, 1:本位幣
    let specialMode = 0;
    let autoCount = 0;
    let oriAmount = 0;
    let iSALMode = 0; // 0:一般, 1:出納已收款(隱藏現金tab), 2:出納收款(現金tab唯讀)
    let enableSAL = 0; // 0:停用SAL模式, 1:啟用SAL模式 (由呼叫端傳入)

    // 資料暫存
    let lastAmountData = null; // 最近一次 APRdStrikeCalcAllAmount 回傳資料
    let sourceData = [];
    let sourceCalcData = [];
    let bankData = [];
    let billData = [];
    let otherDtlData = [];
    let postData = [];
    let debitData = [];

    // 目前選中的行索引（other/post 表格用於直接行選擇刪除）
    const selectedRows = {};

    // 下拉選單選項資料
    let accIdOptions = [];
    let subAccIdOptions = {};
    let bankOptions = [];
    let accountOptions = {};

    // 票據沖帳下拉選單選項資料
    let billPayBankOptions = [];
    let billRecvBankOptions = [];
    let billTypeOptions = [];
    let billCodeOptions = {};  // keyed by bankId (PayBankId)
    let billAccIdOptions = [];
    let billAccountOptions = {};  // keyed by bankId

    // DOM 元素
    const els = {};

    const readPaperNum = (ctx) => {
        const v = (ctx?.paperNum || window._paperNum || '').toString().trim();
        if (v) return v;
        if (typeof window.getPaperNum === 'function') {
            try { return (window.getPaperNum() || '').toString().trim(); } catch { /* ignore */ }
        }
        return '';
    };

    const withJwtHeaders = (init = {}) => {
        const jwt = localStorage.getItem('jwtId');
        const headers = Object.assign({}, init.headers || {});
        if (jwt) headers['X-JWTID'] = jwt;
        return { ...init, headers };
    };

    const notify = async (type, message) => {
        if (window.Swal) {
            const icon = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
            await window.Swal.fire({ icon, title: message });
            return;
        }
        alert(message);
    };

    const formatDate = (val) => {
        if (!val) return '';
        const d = new Date(val);
        if (isNaN(d.getTime())) return '';
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const formatNumber = (val) => {
        if (val === null || val === undefined || val === '') return '0';
        const n = parseFloat(val);
        return isNaN(n) ? '0' : n.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    // datalist 前綴過濾配置（LIKE '輸入值%' 而非 '%輸入值%'）
    const datalistConfig = {
        'BankId': {
            getOptions: () => bankOptions,
            renderOption: (opt) => `<option value="${opt.BankId}">${opt.BankId} - ${opt.Name}</option>`,
            keyField: 'BankId'
        },
        'AccountId': {
            getOptions: (input) => {
                const bankId = input.closest('tr')?.querySelector('[data-field="BankId"]')?.value || '';
                return accountOptions[bankId] || [];
            },
            renderOption: (opt) => `<option value="${opt.AccountId}">${opt.AccountId} - ${opt.ShortName || ''}</option>`,
            keyField: 'AccountId'
        },
        'PayBankId': {
            getOptions: () => billPayBankOptions,
            renderOption: (opt) => `<option value="${opt.BankId}">${opt.BankId} - ${opt.Name}</option>`,
            keyField: 'BankId'
        },
        'PayAccountId': {
            getOptions: (input) => {
                const bankId = input.closest('tr')?.querySelector('[data-field="PayBankId"]')?.value || '';
                return billAccountOptions[bankId] || [];
            },
            renderOption: (opt) => `<option value="${opt.AccountId}">${opt.AccountId} - ${opt.SaveTypeName || ''}</option>`,
            keyField: 'AccountId'
        },
        'RecvBankId': {
            getOptions: () => billRecvBankOptions,
            renderOption: (opt) => `<option value="${opt.BankId}">${opt.BankId} - ${opt.Name}</option>`,
            keyField: 'BankId'
        },
        'RecvAccountId': {
            getOptions: (input) => {
                const bankId = input.closest('tr')?.querySelector('[data-field="RecvBankId"]')?.value || '';
                return billAccountOptions[bankId] || [];
            },
            renderOption: (opt) => `<option value="${opt.AccountId}">${opt.AccountId} - ${opt.SaveTypeName || ''}</option>`,
            keyField: 'AccountId'
        },
        'BillTypeId': {
            getOptions: () => billTypeOptions,
            renderOption: (opt) => `<option value="${opt.BillTypeId}">${opt.BillTypeId} - ${opt.BillTypeName}</option>`,
            keyField: 'BillTypeId'
        },
        'BillAccId': {
            getOptions: () => billAccIdOptions,
            renderOption: (opt) => `<option value="${opt.AccId}">${opt.AccId} - ${opt.AccIdName}</option>`,
            keyField: 'AccId'
        },
        'AccId': {
            getOptions: () => accIdOptions,
            renderOption: (opt) => `<option value="${opt.AccId}">${opt.AccId} - ${opt.AccIdName}</option>`,
            keyField: 'AccId'
        },
        'SubAccId': {
            getOptions: (input) => {
                const accId = input.closest('tr')?.querySelector('[data-field="AccId"]')?.value || '';
                return subAccIdOptions[accId] || [];
            },
            renderOption: (opt) => `<option value="${opt.SubAccId}">${opt.SubAccId} - ${opt.SubAccName}</option>`,
            keyField: 'SubAccId'
        },
        'PostAccId': {
            getOptions: () => accIdOptions,
            renderOption: (opt) => `<option value="${opt.AccId}">${opt.AccId} - ${opt.AccIdName}</option>`,
            keyField: 'AccId'
        },
        'PostSubAccId': {
            getOptions: (input) => {
                const accId = input.closest('tr')?.querySelector('[data-field="PostAccId"]')?.value || '';
                return subAccIdOptions[accId] || [];
            },
            renderOption: (opt) => `<option value="${opt.SubAccId}">${opt.SubAccId} - ${opt.SubAccName}</option>`,
            keyField: 'SubAccId'
        },
        'PostBankId': {
            getOptions: () => bankOptions,
            renderOption: (opt) => `<option value="${opt.BankId}">${opt.BankId} - ${opt.Name}</option>`,
            keyField: 'BankId'
        },
        'PostAccountId': {
            getOptions: (input) => {
                const bankId = input.closest('tr')?.querySelector('[data-field="PostBankId"]')?.value || '';
                return accountOptions[bankId] || [];
            },
            renderOption: (opt) => `<option value="${opt.AccountId}">${opt.AccountId} - ${opt.ShortName || ''}</option>`,
            keyField: 'AccountId'
        }
    };

    // 通用的 datalist 前綴過濾綁定函式
    const bindDatalistPrefixFilter = (container) => {
        const inputs = container.querySelectorAll('.combo-select[list]');
        inputs.forEach(input => {
            const field = input.getAttribute('data-field');
            const config = datalistConfig[field];
            if (!config) return;

            input.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase();
                const datalist = document.getElementById(e.target.getAttribute('list'));
                if (!datalist) return;

                const allOptions = config.getOptions(e.target);
                const filtered = value
                    ? allOptions.filter(opt => (opt[config.keyField] || '').toString().toLowerCase().startsWith(value))
                    : allOptions;

                datalist.innerHTML = filtered.map(config.renderOption).join('');
            });
        });
    };

    const initElements = () => {
        const elIds = [
            'modal', 'toolbar', 'rate-strike', 'rate-pr', 'money-code', 'strike-mode',
            'btn-advance', 'btn-other', 'btn-debit-search', 'btn-debit-clear', 'btn-else-insert', 'btn-gen-bill-num', 'lbl-check', 'cash-amount',
            'tbody-bank', 'tbody-bill', 'tbody-other', 'tbody-post', 'tbody-debit',
            'tbody-source-og', 'tbody-source', 'tbody-source-calc',
            'lbl-og-sum', 'lbl-sum', 'lbl-og-other-sum',
            'txt-use-cash', 'txt-use-bank', 'txt-use-bill', 'txt-use-other', 'txt-use-debit',
            'txt-sum-amount-og', 'txt-sum-amount', 'txt-strike-amount', 'txt-rest-calc-og',
            'src-footer-total',
            'btn-save', 'btn-cancel'
        ];

        elIds.forEach(id => {
            const el = document.getElementById(`${DOM_PREFIX}-${id}`);
            if (el) els[id] = el;
        });
    };

    // Modal 處理
    let modal = null;
    let manualBackdrop = null;

    const forceShowModal = () => {
        if (!els.modal) return;
        els.modal.classList.add('show');
        els.modal.style.display = 'block';
        els.modal.style.zIndex = '1055';
        els.modal.removeAttribute('aria-hidden');
        els.modal.setAttribute('aria-modal', 'true');
        if (!manualBackdrop) {
            manualBackdrop = document.createElement('div');
            manualBackdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(manualBackdrop);
        }
    };

    const forceHideModal = () => {
        if (!els.modal) return;
        els.modal.classList.remove('show');
        els.modal.style.display = 'none';
        els.modal.setAttribute('aria-hidden', 'true');
        els.modal.removeAttribute('aria-modal');
        if (manualBackdrop) {
            manualBackdrop.remove();
            manualBackdrop = null;
        }
    };

    const showModal = () => {
        if (modal) {
            modal.show();
            if (!els.modal.classList.contains('show')) {
                forceShowModal();
            }
            return;
        }
        forceShowModal();
    };

    const hideModal = () => {
        if (modal) {
            modal.hide();
            return;
        }
        forceHideModal();
    };

    // 載入主檔資料
    const loadMasterData = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/GetDetailMasterData?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
            if (!resp.ok) {
                await notify('error', '載入資料失敗');
                return false;
            }

            const data = await resp.json();
            if (!data.ok) {
                await notify('error', data.error || '載入資料失敗');
                return false;
            }

            const master = data.data;

            // 設定基本資料
            if (els['rate-strike']) els['rate-strike'].value = master.RateToNTStrike || 0;
            if (els['rate-pr']) els['rate-pr'].value = master.RateToNT || 0;
            if (els['strike-mode']) els['strike-mode'].value = master.StrikeMode || 0;
            if (els['cash-amount']) els['cash-amount'].value = master.CashAmountOg || 0;

            strikeMode = master.StrikeMode || 0;
            isIn = master.IsIn || 0;
            oriAmount = master.CashAmountOg || 0;

            // 票據 BillCode 欄位: isIn=1 時顯示
            document.querySelectorAll('.bill-col-billcode').forEach(el => {
                el.style.display = isIn === 1 ? '' : 'none';
            });

            // 檢查預收付或對沖
            await checkHaveAdvOrOther();

            // 檢查是否顯示「兌換對照」頁籤 (對應 Delphi iOpenCalc 檢查)
            await checkShowCalcTab();

            // 載入 SAL 模式
            await loadSALMode();

            // 載入多國語言欄位標題
            await loadFieldCaptions();

            // 先載入下拉選單選項資料
            await Promise.all([
                loadAccIdOptions(),
                loadBankOptions(),
                loadBillPayBankOptions(),
                loadBillRecvBankOptions(),
                loadBillTypeOptions(),
                loadBillAccIdOptions()
            ]);

            // 載入各項資料
            await Promise.all([
                loadSourceData(),
                loadBankData(),
                loadBillData(),
                loadOtherDtlData(),
                loadPostData(),
                loadDebitData()
            ]);

            // 啟用自動計算
            autoCount = 1;
            await executeAutoCalc('', '', '', 1, -1);

            // 第一次進入時載入「已輸入金額總計」
            await loadAllAmountData();
            // 初始設定現金總計顯示 (後續只在現金沖帳儲存時更新)
            updateAmountDisplay('txt-use-cash', oriAmount);

            return true;
        } catch (err) {
            console.error('loadMasterData error:', err);
            await notify('error', '載入資料失敗: ' + err.message);
            return false;
        }
    };

    // 檢查預收付或對沖
    const checkHaveAdvOrOther = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/CheckHaveAdv?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
            if (!resp.ok) return;

            const data = await resp.json();
            if (data.ok) {
                let msg = '';
                if (data.data.isAdv) msg += ' 預收付可使用';
                if (data.data.isOther) msg += ' 對沖可使用';
                if (els['lbl-check']) els['lbl-check'].textContent = msg;

                // 預設折扣顯示
                const lblDiscount = document.getElementById('strike-dtl-lbl-discount');
                if (lblDiscount) {
                    const discount = data.data.discount;
                    if (discount) {
                        lblDiscount.textContent = `預設折扣: ${discount}`;
                        lblDiscount.style.display = 'inline';
                    } else {
                        lblDiscount.style.display = 'none';
                    }
                }
            }
        } catch (err) {
            console.error('checkHaveAdvOrOther error:', err);
        }
    };

    // 檢查是否顯示「兌換對照」頁籤 (對應 Delphi qryOtherOg 檢查邏輯)
    const checkShowCalcTab = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/CheckShowCalcTab?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
            if (!resp.ok) {
                console.warn('checkShowCalcTab request failed');
                return;
            }

            const data = await resp.json();
            if (data.ok && data.showCalcTab) {
                // SpecialMode = 1: 顯示「兌換對照」頁籤
                const navItem = document.getElementById('nav-item-source-calc');
                if (navItem) {
                    navItem.style.display = '';
                }

                // 更新頁籤標題 (如果有提供 useMoneyName)
                if (data.tabCaption) {
                    const tabTitle = document.getElementById('source-calc-tab-title');
                    if (tabTitle) {
                        tabTitle.textContent = data.tabCaption;
                    }
                }

                // 顯示「帳單即期匯率」和「幣別」欄位 (對應 Delphi: 當 iOpenCalc=1 時保持顯示 pnlTop_2)
                const ratePrField = document.getElementById('strike-dtl-rate-pr-field');
                const moneyCodeField = document.getElementById('strike-dtl-money-code-field');
                if (ratePrField) {
                    ratePrField.style.display = 'flex';
                }
                if (moneyCodeField) {
                    moneyCodeField.style.display = 'flex';
                }

                // 禁用「沖帳模式」下拉選單 (對應 Delphi: cboStrikeMode.Enabled:=False)
                const strikeModeSelect = document.getElementById('strike-dtl-strike-mode');
                if (strikeModeSelect) {
                    strikeModeSelect.disabled = true;
                }

                // 載入並設定幣別資訊
                if (data.moneyName) {
                    const moneyCodeSelect = document.getElementById('strike-dtl-money-code');
                    if (moneyCodeSelect) {
                        // 獲取主檔幣別資訊
                        const masterResp = await fetch(`/api/StrikeSelect/GetDetailMasterData?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
                        if (masterResp.ok) {
                            const masterData = await masterResp.json();
                            if (masterData.ok && masterData.data.MoneyCode) {
                                // 清空並設定幣別選項
                                const moneyResp = await fetch('/api/StrikeSelect/MoneyOptions', withJwtHeaders());
                                if (moneyResp.ok) {
                                    const moneyOptions = await moneyResp.json();
                                    moneyCodeSelect.innerHTML = moneyOptions.map(opt =>
                                        `<option value="${opt.value}">${opt.text}</option>`
                                    ).join('');
                                    moneyCodeSelect.value = masterData.data.MoneyCode;
                                }
                            }
                        }
                    }
                }

                // 設定 specialMode 標記
                specialMode = data.specialMode || 0;

                // specialMode=1 時顯示補滿原值按鈕
                if (specialMode === 1) {
                    document.querySelectorAll('.btn-spe-full').forEach(btn => {
                        btn.style.display = 'inline-block';
                    });
                }

                // 載入兌換對照資料
                if (specialMode === 1) {
                    await loadSourceCalcData();
                }
            } else {
                // SpecialMode = 0: 隱藏「兌換對照」頁籤
                const navItem = document.getElementById('nav-item-source-calc');
                if (navItem) {
                    navItem.style.display = 'none';
                }

                // 隱藏「帳單即期匯率」和「幣別」欄位 (對應 Delphi: pnlTop_2.Visible:=False)
                const ratePrField = document.getElementById('strike-dtl-rate-pr-field');
                const moneyCodeField = document.getElementById('strike-dtl-money-code-field');
                if (ratePrField) {
                    ratePrField.style.display = 'none';
                }
                if (moneyCodeField) {
                    moneyCodeField.style.display = 'none';
                }

                // 啟用「沖帳模式」下拉選單
                const strikeModeSelect = document.getElementById('strike-dtl-strike-mode');
                if (strikeModeSelect) {
                    strikeModeSelect.disabled = false;
                }

                specialMode = 0;

                // 隱藏補滿原值按鈕
                document.querySelectorAll('.btn-spe-full').forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        } catch (err) {
            console.error('checkShowCalcTab error:', err);
        }
    };

    // 載入 SAL 模式 (出納收款模式)
    const loadSALMode = async () => {
        // enableSAL 為 0 時停用 SAL 模式功能，並還原先前 SAL 模式修改過的 DOM 狀態
        if (enableSAL !== 1) {
            iSALMode = 0;
            const navTabs = document.getElementById('strike-dtl-detail-navtabs');
            if (navTabs) {
                const cashTab = navTabs.querySelector('[data-tab-target="#strike-dtl-cash"]');
                const bankTab = navTabs.querySelector('[data-tab-target="#strike-dtl-bank"]');
                const billTab = navTabs.querySelector('[data-tab-target="#strike-dtl-bill"]');
                if (cashTab) {
                    cashTab.closest('.nav-item').style.display = '';
                    cashTab.textContent = '現金沖帳';
                }
                if (bankTab) bankTab.closest('.nav-item').style.display = '';
                if (billTab) billTab.closest('.nav-item').style.display = '';
            }
            if (els['cash-amount']) els['cash-amount'].readOnly = false;
            const useBankSpan = document.getElementById('strike-dtl-txt-use-bank')?.parentElement;
            const useBillSpan = document.getElementById('strike-dtl-txt-use-bill')?.parentElement;
            if (useBankSpan) useBankSpan.style.display = '';
            if (useBillSpan) useBillSpan.style.display = '';
            const modalTitle = els.modal?.querySelector('.modal-title');
            if (modalTitle) modalTitle.textContent = '沖帳明細維護';
            return;
        }
        try {
            const resp = await fetch(`/api/StrikeSelect/GetSALMode?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
            if (!resp.ok) return;

            const data = await resp.json();
            if (!data.ok) return;

            iSALMode = data.iSALMode || 0;
            const navTabs = document.getElementById('strike-dtl-detail-navtabs');
            if (!navTabs) return;

            const tabLinks = navTabs.querySelectorAll('.nav-link');
            const cashTab = navTabs.querySelector('[data-tab-target="#strike-dtl-cash"]');
            const bankTab = navTabs.querySelector('[data-tab-target="#strike-dtl-bank"]');
            const billTab = navTabs.querySelector('[data-tab-target="#strike-dtl-bill"]');

            if (iSALMode === 2) {
                // 出納收款模式：現金沖帳 tab 標題改「出納收款金額」，現金金額 readonly
                if (cashTab) cashTab.textContent = '出納收款金額';
                if (els['cash-amount']) els['cash-amount'].readOnly = true;
            }

            if (iSALMode === 1) {
                // 出納已收款：隱藏現金沖帳 tab
                if (cashTab) cashTab.closest('.nav-item').style.display = 'none';
            }

            if (iSALMode >= 1) {
                // 隱藏銀存/票據沖帳 tab
                if (bankTab) bankTab.closest('.nav-item').style.display = 'none';
                if (billTab) billTab.closest('.nav-item').style.display = 'none';

                // 隱藏相關金額欄位
                const useBankSpan = document.getElementById('strike-dtl-txt-use-bank')?.parentElement;
                const useBillSpan = document.getElementById('strike-dtl-txt-use-bill')?.parentElement;
                if (useBankSpan) useBankSpan.style.display = 'none';
                if (useBillSpan) useBillSpan.style.display = 'none';

                // 修改標題文字
                const modalTitle = els.modal?.querySelector('.modal-title');
                if (modalTitle) modalTitle.textContent = '出納收款明細維護';
            }
        } catch (err) {
            console.error('loadSALMode error:', err);
        }
    };

    // 載入多國語言欄位標題
    const loadFieldCaptions = async () => {
        try {
            const resp = await fetch('/api/StrikeSelect/GetFieldCaptions', withJwtHeaders());
            if (!resp.ok) return;

            const data = await resp.json();
            if (!data.ok || !data.captions || data.captions.length === 0) return;

            // 建立 fieldName -> displayLabel 對照表
            const captionMap = {};
            data.captions.forEach(c => { captionMap[c.fieldName] = c.displayLabel; });

            // 動態替換標題和 label 文字
            const navTabs = document.getElementById('strike-dtl-detail-navtabs');
            if (navTabs) {
                const cashTab = navTabs.querySelector('[data-tab-target="#strike-dtl-cash"]');
                const bankTab = navTabs.querySelector('[data-tab-target="#strike-dtl-bank"]');
                const billTab = navTabs.querySelector('[data-tab-target="#strike-dtl-bill"]');
                const otherTab = navTabs.querySelector('[data-tab-target="#strike-dtl-other"]');
                const debitTab = navTabs.querySelector('[data-tab-target="#strike-dtl-debit"]');

                if (captionMap['CashTab'] && cashTab) cashTab.textContent = captionMap['CashTab'];
                if (captionMap['BankTab'] && bankTab) bankTab.textContent = captionMap['BankTab'];
                if (captionMap['BillTab'] && billTab) billTab.textContent = captionMap['BillTab'];
                if (captionMap['OtherTab'] && otherTab) otherTab.textContent = captionMap['OtherTab'];
                if (captionMap['DebitTab'] && debitTab) debitTab.textContent = captionMap['DebitTab'];
            }

            const sourceNavTabs = document.getElementById('strike-dtl-source-navtabs');
            if (sourceNavTabs) {
                const ogTab = sourceNavTabs.querySelector('[data-tab-target="#strike-dtl-source-og"]');
                const localTab = sourceNavTabs.querySelector('[data-tab-target="#strike-dtl-source"]');
                if (captionMap['SourceOgTab'] && ogTab) ogTab.textContent = captionMap['SourceOgTab'];
                if (captionMap['SourceTab'] && localTab) localTab.textContent = captionMap['SourceTab'];
            }

            // 替換 modal 標題
            if (captionMap['FormTitle']) {
                const modalTitle = els.modal?.querySelector('.modal-title');
                if (modalTitle && iSALMode < 1) modalTitle.textContent = captionMap['FormTitle'];
            }
        } catch (err) {
            console.error('loadFieldCaptions error:', err);
        }
    };

    // 載入兌換對照來源資料 (SpecialMode=1 時使用)
    const loadSourceCalcData = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/GetDetailSourceCalcData?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
            if (!resp.ok) return;

            const data = await resp.json();
            if (data.ok) {
                sourceCalcData = data.rows || [];
                renderSourceCalcTable();
            }
        } catch (err) {
            console.error('loadSourceCalcData error:', err);
        }
    };

    // 載入沖帳來源資料
    const loadSourceData = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/GetDetailSourceData?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
            if (!resp.ok) return;

            const data = await resp.json();
            if (data.ok) {
                sourceData = data.rows || [];
                renderSourceTable();
                updateSourceSum();
            }
        } catch (err) {
            console.error('loadSourceData error:', err);
        }
    };

    // 渲染沖帳來源表格
    const renderSourceTable = () => {
        if (!els['tbody-source-og'] || !els['tbody-source']) return;

        const renderRow = (item, index) => `
            <tr data-index="${index}" data-sournum="${item.SourNum || ''}" data-item="${item.Item || ''}" data-certifnum="${item.CertifNum || ''}">
                <td>${item.SourNum || ''}</td>
                <td>${item.JourId || ''}</td>
                <td class="text-end">${(parseFloat(item.RateToNT) || 0).toLocaleString('zh-TW', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}</td>
                <td>${item.CertifNum || ''}</td>
                <td>${item.Notes || ''}</td>
                <td class="text-end">${formatNumber(item.RestAmountOg)}</td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="CashAmountOg" value="${item.CashAmountOg || 0}" step="0.01" /></td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="BankAmountOg" value="${item.BankAmountOg || 0}" step="0.01" /></td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="BillAmountOg" value="${item.BillAmountOg || 0}" step="0.01" /></td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="OtherAmountOg" value="${item.OtherAmountOg || 0}" step="0.01" /></td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="CutAmountOg" value="${item.CutAmountOg || 0}" step="0.01" /></td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="StrikeAmountOg" value="${item.StrikeAmountOg || 0}" step="0.01" /></td>
            </tr>
        `;

        els['tbody-source-og'].innerHTML = sourceData.map((item, idx) => renderRow(item, idx)).join('');

        const renderRowNT = (item, index) => `
            <tr data-index="${index}" data-sournum="${item.SourNum || ''}" data-item="${item.Item || ''}" data-certifnum="${item.CertifNum || ''}">
                <td>${item.SourNum || ''}</td>
                <td>${item.JourId || ''}</td>
                <td class="text-end">${(parseFloat(item.RateToNT) || 0).toLocaleString('zh-TW', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}</td>
                <td>${item.CertifNum || ''}</td>
                <td>${item.Notes || ''}</td>
                <td class="text-end">${formatNumber(item.RestAmount)}</td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="CashAmount" value="${item.CashAmount || 0}" step="0.01" /></td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="BankAmount" value="${item.BankAmount || 0}" step="0.01" /></td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="BillAmount" value="${item.BillAmount || 0}" step="0.01" /></td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="OtherAmount" value="${item.OtherAmount || 0}" step="0.01" /></td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="CutAmount" value="${item.CutAmount || 0}" step="0.01" /></td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="StrikeAmount" value="${item.StrikeAmount || 0}" step="0.01" /></td>
            </tr>
        `;

        els['tbody-source'].innerHTML = sourceData.map((item, idx) => renderRowNT(item, idx)).join('');

        // 綁定雙擊事件
        bindSourceRowEvents();
    };

    // 渲染兌換對照表格 (對應 Delphi tblSourceCalc)
    const renderSourceCalcTable = () => {
        if (!els['tbody-source-calc']) return;

        const renderRow = (item, index) => `
            <tr data-index="${index}" data-sournum="${item.SourNum || ''}" data-item="${item.Item || ''}">
                <td>${item.SourNum || ''}</td>
                <td>${item.CertifNum || ''}</td>
                <td class="text-end">${formatNumber(item.RestAmountOg)}</td>
                <td class="text-end">${formatNumber(item.CalcCashAmountOg)}</td>
                <td class="text-end">${formatNumber(item.CalcBankAmountOg)}</td>
                <td class="text-end">${formatNumber(item.CalcBillAmountOg)}</td>
                <td class="text-end">${formatNumber(item.CalcOtherAmountOg)}</td>
            </tr>
        `;

        els['tbody-source-calc'].innerHTML = sourceCalcData.map((item, idx) => renderRow(item, idx)).join('');

        // 綁定雙擊事件
        bindSourceCalcRowEvents();
    };

    // 綁定兌換對照表格事件
    const bindSourceCalcRowEvents = () => {
        const handleDblClick = async (e) => {
            const td = e.target.closest('td');
            const tr = e.target.closest('tr');
            if (!td || !tr) return;

            // 取得點擊的欄位索引
            const cellIndex = Array.from(tr.children).indexOf(td);
            const sourNum = tr.dataset.sournum;
            const item = parseInt(tr.dataset.item);
            const certifNum = tr.dataset.certifnum || '';

            // 根據欄位索引決定要更新的欄位
            // 兌換對照表格欄位索引對應：0=來源單號, 1=憑單號碼, 2=剩餘金額
            // 3=現金金額(cash), 4=銀存金額(bank), 5=票據金額(bill), 6=其他金額(other)
            let sourceField = '';
            if (cellIndex === 3) sourceField = 'cash';      // 現金金額
            else if (cellIndex === 4) sourceField = 'bank'; // 銀存金額
            else if (cellIndex === 5) sourceField = 'bill'; // 票據金額
            else if (cellIndex === 6) sourceField = 'other'; // 其他金額
            else return; // 其他欄位不處理

            if (sourNum && sourceField) {
                await executeAutoCalc(sourceField, sourNum, certifNum, item, 2); // iPage = 2 表示兌換對照頁
            }
        };

        // 單擊選中行
        const handleClick = (e) => {
            const tr = e.target.closest('tr');
            if (!tr) return;

            const idx = parseInt(tr.dataset.index);
            selectedRows['source'] = idx;

            if (els['tbody-source-calc']) {
                els['tbody-source-calc'].querySelectorAll('tr.table-active').forEach(r => r.classList.remove('table-active'));
                tr.classList.add('table-active');
            }
        };

        if (els['tbody-source-calc']) {
            els['tbody-source-calc'].removeEventListener('dblclick', handleDblClick);
            els['tbody-source-calc'].addEventListener('dblclick', handleDblClick);
            els['tbody-source-calc'].querySelectorAll('tr').forEach(tr => {
                tr.addEventListener('click', handleClick);
            });
        }
    };

    // 綁定來源表格事件
    const bindSourceRowEvents = () => {
        const handleDblClick = async (e) => {
            const td = e.target.closest('td');
            const tr = e.target.closest('tr');
            if (!td || !tr) return;

            // 取得點擊的欄位索引
            const cellIndex = Array.from(tr.children).indexOf(td);
            const sourNum = tr.dataset.sournum;
            const item = parseInt(tr.dataset.item);
            const certifNum = tr.dataset.certifnum || '';

            // 根據欄位索引決定要更新的欄位
            // 欄位索引對應：0=立帳單號, 1=傳票號碼, 2=原始匯率, 3=憑證單號, 4=發票號碼, 5=剩餘金額
            // 6=現金沖銷(cash), 7=銀存沖銷(bank), 8=票據沖銷(bill), 9=其他沖銷(other), 10=折讓沖銷(cut), 11=沖銷金額(strike)
            let sourceField = '';
            if (cellIndex === 6) sourceField = 'cash';      //現金沖銷
            else if (cellIndex === 7) sourceField = 'bank'; // 銀存沖銷
            else if (cellIndex === 8) sourceField = 'bill'; // 票據沖銷
            else if (cellIndex === 9) sourceField = 'other'; // 其他沖銷
            else if (cellIndex === 10) sourceField = 'cut'; // 折讓沖銷
            else return; // 其他欄位不處理

            if (sourNum && sourceField) {
                await executeAutoCalc(sourceField, sourNum, certifNum, item, strikeMode);
            }
        };

        // 單擊選中行
        const handleClick = (e) => {
            const tr = e.target.closest('tr');
            if (!tr || e.target.tagName === 'INPUT') return;

            const idx = parseInt(tr.dataset.index);
            selectedRows['source'] = idx;

            // 同步高亮兩個表格的對應行
            [els['tbody-source-og'], els['tbody-source']].forEach(tbody => {
                if (!tbody) return;
                tbody.querySelectorAll('tr.table-active').forEach(r => r.classList.remove('table-active'));
                const targetTr = tbody.querySelector(`tr[data-index="${idx}"]`);
                if (targetTr) targetTr.classList.add('table-active');
            });
        };

        if (els['tbody-source-og']) {
            els['tbody-source-og'].querySelectorAll('tr').forEach(tr => {
                tr.addEventListener('dblclick', handleDblClick);
                tr.addEventListener('click', handleClick);
            });
        }

        if (els['tbody-source']) {
            els['tbody-source'].querySelectorAll('tr').forEach(tr => {
                tr.addEventListener('dblclick', handleDblClick);
                tr.addEventListener('click', handleClick);
            });
        }
    };

    // 更新來源剩餘金額合計 (本地計算，footer 分配總計由 loadAllAmountData 從 SP 更新)
    const updateSourceSum = () => {
        let sumOgRest = 0, sumRest = 0;
        sourceData.forEach(item => {
            sumOgRest += item.RestAmountOg || 0;
            sumRest += item.RestAmount || 0;
        });
        if (els['lbl-og-sum']) els['lbl-og-sum'].textContent = formatNumber(sumOgRest);
        if (els['lbl-sum']) els['lbl-sum'].textContent = formatNumber(sumRest);

        // 兌換對照剩餘合計
        let calcRest = 0;
        sourceCalcData.forEach(item => { calcRest += item.RestAmountOg || 0; });
        if (els['lbl-og-other-sum']) els['lbl-og-other-sum'].textContent = formatNumber(calcRest);
    };

    // 載入銀存資料
    const loadBankData = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/GetDetailBankData?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
            if (!resp.ok) return;

            const data = await resp.json();
            if (data.ok) {
                bankData = data.rows || [];

                // 預先載入已選擇銀行的帳戶選項
                const bankIds = [...new Set(
                    bankData.map(item => item.BankId)
                        .filter(Boolean)
                        .map(id => (id || '').toString().trim())
                )];
                await Promise.all(bankIds.map(bankId => loadAccountOptions(bankId)));

                renderBankTable();
            }
        } catch (err) {
            console.error('loadBankData error:', err);
        }
    };

    // 渲染銀存表格
    const renderBankTable = () => {
        if (!els['tbody-bank']) return;

        els['tbody-bank'].innerHTML = bankData.map((item, idx) => `
            <tr data-index="${idx}">
                <td>${idx + 1}</td>
                <td><input type="checkbox" class="form-check-input" data-field="PreCharged" ${item.PreCharged === 1 ? 'checked' : ''} /></td>
                <td><input type="date" class="form-control form-control-sm" data-field="PreChargeDate" value="${formatDate(item.PreChargeDate)}" /></td>
                <td>
                    <input type="text" class="form-control form-control-sm combo-select"
                           data-field="BankId" data-index="${idx}"
                           value="${item.BankId || ''}"
                           list="strike-bank-id-list-${idx}"
                           autocomplete="off" />
                    <datalist id="strike-bank-id-list-${idx}">
                        ${bankOptions.map(opt => `<option value="${opt.BankId}">${opt.BankId} - ${opt.Name}</option>`).join('')}
                    </datalist>
                </td>
                <td class="strike-bank-name">${item.BankName || ''}</td>
                <td>
                    <input type="text" class="form-control form-control-sm combo-select"
                           data-field="AccountId" data-index="${idx}"
                           value="${item.AccountId || ''}"
                           list="strike-account-id-list-${idx}"
                           autocomplete="off" />
                    <datalist id="strike-account-id-list-${idx}">
                        ${renderAccountDatalistOptions(item.BankId, item.AccountId)}
                    </datalist>
                </td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="AmountOg" value="${item.AmountOg || 0}" step="0.01" /></td>
            </tr>
        `).join('');

        // 綁定銀行變更事件
        bindStrikeBankChangeEvents();
        // 綁定行選擇事件
        selectedRows['bank'] = null;
        bindRowSelection('bank');
        // 綁定 datalist 前綴過濾
        bindDatalistPrefixFilter(els['tbody-bank']);
    };

    // 綁定銀存銀行變更事件（BankId blur → 更新銀行名稱 + 聯動帳戶 datalist）
    const bindStrikeBankChangeEvents = () => {
        const inputs = els['tbody-bank'].querySelectorAll('[data-field="BankId"]');
        inputs.forEach(input => {
            input.addEventListener('blur', async (e) => {
                const idx = e.target.getAttribute('data-index');
                const bankId = e.target.value.trim();
                const row = e.target.closest('tr');

                // 更新銀行名稱
                const option = bankOptions.find(opt => (opt.BankId || '').trim() === bankId);
                const nameCell = row.querySelector('.strike-bank-name');
                if (nameCell) {
                    nameCell.textContent = option ? option.Name : '';
                }

                // 更新資料
                if (bankData[idx]) {
                    bankData[idx].BankId = bankId;
                    bankData[idx].BankName = option ? option.Name : '';
                }

                // 載入帳戶選項並更新 datalist
                if (bankId) {
                    delete accountOptions[bankId];
                    await loadAccountOptions(bankId);
                    const datalist = document.getElementById(`strike-account-id-list-${idx}`);
                    if (datalist) {
                        datalist.innerHTML = renderAccountDatalistOptions(bankId, '');
                    }
                }
            });
        });
    };

    // 載入票據資料
    const loadBillData = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/GetDetailBillData?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
            if (!resp.ok) return;

            const data = await resp.json();
            if (data.ok) {
                billData = data.rows || [];

                // 預先載入所有已選擇銀行的帳戶選項
                const bankIds = [...new Set(
                    billData.flatMap(item => [item.PayBankId, item.RecvBankId])
                        .filter(Boolean)
                        .map(id => (id || '').toString().trim())
                )];
                await Promise.all(bankIds.map(bankId => loadBillAccountIdOptions(bankId)));

                // 預先載入所有付款銀行的票別代號選項
                const payBankIds = [...new Set(
                    billData.map(item => item.PayBankId)
                        .filter(Boolean)
                        .map(id => (id || '').toString().trim())
                )];
                await Promise.all(payBankIds.map(bankId => loadBillCodeOptions(bankId)));

                renderBillTable();
            }
        } catch (err) {
            console.error('loadBillData error:', err);
        }
    };

    // 載入票據付款銀行選項
    const loadBillPayBankOptions = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/GetBillPayBankOptions?isIn=${encodeURIComponent(isIn)}`, withJwtHeaders());
            if (!resp.ok) return;
            const data = await resp.json();
            if (data.ok) billPayBankOptions = data.rows || [];
        } catch (err) { console.error('loadBillPayBankOptions error:', err); }
    };

    // 載入票據收款銀行選項
    const loadBillRecvBankOptions = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/GetBillRecvBankOptions?isIn=${encodeURIComponent(isIn)}`, withJwtHeaders());
            if (!resp.ok) return;
            const data = await resp.json();
            if (data.ok) billRecvBankOptions = data.rows || [];
        } catch (err) { console.error('loadBillRecvBankOptions error:', err); }
    };

    // 載入票別選項
    const loadBillTypeOptions = async () => {
        try {
            const resp = await fetch('/api/StrikeSelect/GetBillTypeOptions', withJwtHeaders());
            if (!resp.ok) return;
            const data = await resp.json();
            if (data.ok) billTypeOptions = data.rows || [];
        } catch (err) { console.error('loadBillTypeOptions error:', err); }
    };

    // 載入票別代號選項（按付款銀行）
    const loadBillCodeOptions = async (bankId) => {
        if (!bankId || billCodeOptions[bankId]) return;
        try {
            const resp = await fetch(`/api/StrikeSelect/GetBillCodeOptions?bankId=${encodeURIComponent(bankId)}&isIn=${encodeURIComponent(isIn)}`, withJwtHeaders());
            if (!resp.ok) return;
            const data = await resp.json();
            if (data.ok) billCodeOptions[bankId] = data.rows || [];
        } catch (err) { console.error('loadBillCodeOptions error:', err); }
    };

    // 載入票據科目選項
    const loadBillAccIdOptions = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/GetBillAccIdOptions?isIn=${encodeURIComponent(isIn)}`, withJwtHeaders());
            if (!resp.ok) return;
            const data = await resp.json();
            if (data.ok) billAccIdOptions = data.rows || [];
        } catch (err) { console.error('loadBillAccIdOptions error:', err); }
    };

    // 載入票據帳戶選項（按銀行）
    const loadBillAccountIdOptions = async (bankId) => {
        if (!bankId || billAccountOptions[bankId]) return;
        try {
            const resp = await fetch(`/api/StrikeSelect/GetBillAccountIdOptions?bankId=${encodeURIComponent(bankId)}&isIn=${encodeURIComponent(isIn)}`, withJwtHeaders());
            if (!resp.ok) return;
            const data = await resp.json();
            if (data.ok) billAccountOptions[bankId] = data.rows || [];
        } catch (err) { console.error('loadBillAccountIdOptions error:', err); }
    };

    // 渲染票據帳戶 datalist 選項
    const renderBillAccountDatalistOptions = (bankId) => {
        const options = billAccountOptions[(bankId || '').toString().trim()] || [];
        return options.map(opt =>
            `<option value="${opt.AccountId}">${opt.AccountId} - ${opt.SaveTypeName || ''}</option>`
        ).join('');
    };

    // 渲染票據表格
    const renderBillTable = () => {
        if (!els['tbody-bill']) return;

        els['tbody-bill'].innerHTML = billData.map((item, idx) => `
            <tr data-index="${idx}">
                <td class="text-center">${item.Item || (idx + 1)}</td>
                <td>
                    <input type="text" class="form-control form-control-sm combo-select"
                           data-field="PayBankId" data-index="${idx}"
                           value="${item.PayBankId || ''}"
                           list="bill-pay-bank-list-${idx}"
                           autocomplete="off" />
                    <datalist id="bill-pay-bank-list-${idx}">
                        ${billPayBankOptions.map(opt => `<option value="${opt.BankId}">${opt.BankId} - ${opt.Name}</option>`).join('')}
                    </datalist>
                </td>
                <td class="bill-pay-bank-name">${item.PayBankName || item.BankNamePay || ''}</td>
                <td>
                    <input type="text" class="form-control form-control-sm combo-select"
                           data-field="PayAccountId" data-index="${idx}"
                           value="${item.PayAccountId || ''}"
                           list="bill-pay-account-list-${idx}"
                           autocomplete="off" />
                    <datalist id="bill-pay-account-list-${idx}">
                        ${renderBillAccountDatalistOptions(item.PayBankId)}
                    </datalist>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm combo-select"
                           data-field="BillTypeId" data-index="${idx}"
                           value="${item.BillTypeId || ''}"
                           list="bill-type-list-${idx}"
                           autocomplete="off" />
                    <datalist id="bill-type-list-${idx}">
                        ${billTypeOptions.map(opt => `<option value="${opt.BillTypeId}">${opt.BillTypeId} - ${opt.BillTypeName}</option>`).join('')}
                    </datalist>
                </td>
                <td class="bill-type-name">${item.BillTypeName || ''}</td>
                <td class="bill-col-billcode" style="${isIn === 0 ? 'display:none;' : ''}">
                    <input type="text" class="form-control form-control-sm combo-select"
                           data-field="BillCode" data-index="${idx}"
                           value="${item.BillCode || ''}"
                           list="bill-code-list-${idx}"
                           autocomplete="off" />
                    <datalist id="bill-code-list-${idx}">
                        ${(billCodeOptions[item.PayBankId] || []).map(opt => `<option value="${opt.BillCode}">${opt.BillCode} - ${opt.BillCodeName || ''}</option>`).join('')}
                    </datalist>
                </td>
                <td><input type="text" class="form-control form-control-sm" data-field="BillId" value="${item.BillId || ''}" /></td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="Amount" value="${item.Amount || 0}" step="0.01" /></td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="AmountOg" value="${item.AmountOg || 0}" step="0.01" /></td>
                <td>
                    <input type="text" class="form-control form-control-sm combo-select"
                           data-field="BillAccId" data-index="${idx}"
                           value="${item.BillAccId || ''}"
                           list="bill-acc-id-list-${idx}"
                           autocomplete="off" />
                    <datalist id="bill-acc-id-list-${idx}">
                        ${billAccIdOptions.map(opt => `<option value="${opt.AccId}">${opt.AccId} - ${opt.AccIdName}</option>`).join('')}
                    </datalist>
                </td>
                <td class="bill-acc-id-name">${item.BillAccIdName || ''}</td>
                <td class="text-center"><input type="checkbox" class="form-check-input" data-field="ParaLine" ${(item.ParaLine || 0) ? 'checked' : ''} /></td>
                <td class="text-center"><input type="checkbox" class="form-check-input" data-field="Title" ${(item.Title || 0) ? 'checked' : ''} /></td>
                <td class="text-center"><input type="checkbox" class="form-check-input" data-field="Inhibit" ${(item.Inhibit || 0) ? 'checked' : ''} /></td>
                <td><input type="date" class="form-control form-control-sm" data-field="DueDate" value="${formatDate(item.DueDate)}" /></td>
                <td>
                    <input type="text" class="form-control form-control-sm combo-select"
                           data-field="RecvBankId" data-index="${idx}"
                           value="${item.RecvBankId || ''}"
                           list="bill-recv-bank-list-${idx}"
                           autocomplete="off" />
                    <datalist id="bill-recv-bank-list-${idx}">
                        ${billRecvBankOptions.map(opt => `<option value="${opt.BankId}">${opt.BankId} - ${opt.Name}</option>`).join('')}
                    </datalist>
                </td>
                <td class="bill-recv-bank-name">${item.RecvBankName || item.BankNameRecv || ''}</td>
                <td>
                    <input type="text" class="form-control form-control-sm combo-select"
                           data-field="RecvAccountId" data-index="${idx}"
                           value="${item.RecvAccountId || ''}"
                           list="bill-recv-account-list-${idx}"
                           autocomplete="off" />
                    <datalist id="bill-recv-account-list-${idx}">
                        ${renderBillAccountDatalistOptions(item.RecvBankId)}
                    </datalist>
                </td>
            </tr>
        `).join('');

        // 綁定事件
        bindBillChangeEvents();
        // 綁定行選擇事件
        selectedRows['bill'] = null;
        bindRowSelection('bill');
        // 綁定 datalist 前綴過濾
        bindDatalistPrefixFilter(els['tbody-bill']);
    };

    // 綁定票據欄位變更事件
    const bindBillChangeEvents = () => {
        // PayBankId blur - 更新付款銀行名稱，載入付款帳號選項
        els['tbody-bill'].querySelectorAll('[data-field="PayBankId"]').forEach(input => {
            input.addEventListener('blur', async (e) => {
                const idx = e.target.getAttribute('data-index');
                const bankId = e.target.value.trim();
                const row = e.target.closest('tr');

                const option = billPayBankOptions.find(opt => (opt.BankId || '').trim() === bankId);
                const nameCell = row.querySelector('.bill-pay-bank-name');
                if (nameCell) nameCell.textContent = option ? option.Name : '';

                if (billData[idx]) {
                    billData[idx].PayBankId = bankId;
                    billData[idx].BankNamePay = option ? option.Name : '';
                }

                if (bankId) {
                    delete billAccountOptions[bankId];  // 清除快取，確保重新 fetch
                    delete billCodeOptions[bankId];
                    await Promise.all([loadBillAccountIdOptions(bankId), loadBillCodeOptions(bankId)]);
                    const datalist = document.getElementById(`bill-pay-account-list-${idx}`);
                    if (datalist) datalist.innerHTML = renderBillAccountDatalistOptions(bankId);

                    // 更新 BillCode datalist
                    const billCodeDatalist = document.getElementById(`bill-code-list-${idx}`);
                    if (billCodeDatalist) {
                        billCodeDatalist.innerHTML = (billCodeOptions[bankId] || []).map(opt =>
                            `<option value="${opt.BillCode}">${opt.BillCode} - ${opt.BillCodeName || ''}</option>`
                        ).join('');
                    }
                }

                // 自動觸發票號生成
                await tryGenerateBillNumber(idx);
            });
        });

        // PayAccountId blur
        els['tbody-bill'].querySelectorAll('[data-field="PayAccountId"]').forEach(input => {
            input.addEventListener('blur', (e) => {
                const idx = e.target.getAttribute('data-index');
                if (billData[idx]) billData[idx].PayAccountId = e.target.value.trim();
            });
        });

        // BillTypeId blur - 更新票別名稱，自動觸發票號生成
        els['tbody-bill'].querySelectorAll('[data-field="BillTypeId"]').forEach(input => {
            input.addEventListener('blur', async (e) => {
                const idx = e.target.getAttribute('data-index');
                const billTypeId = e.target.value.trim();
                const row = e.target.closest('tr');

                const option = billTypeOptions.find(opt => opt.BillTypeId?.toString() === billTypeId);
                const nameCell = row.querySelector('.bill-type-name');
                if (nameCell) nameCell.textContent = option ? option.BillTypeName : '';

                if (billData[idx]) {
                    billData[idx].BillTypeId = billTypeId;
                    billData[idx].BillTypeName = option ? option.BillTypeName : '';
                }

                // 自動觸發票號生成
                await tryGenerateBillNumber(idx);
            });
        });

        // BillCode blur - 更新資料，自動觸發票號生成
        els['tbody-bill'].querySelectorAll('[data-field="BillCode"]').forEach(input => {
            input.addEventListener('blur', async (e) => {
                const idx = e.target.getAttribute('data-index');
                if (billData[idx]) billData[idx].BillCode = e.target.value.trim();
                await tryGenerateBillNumber(idx);
            });
        });

        // BillAccId blur - 更新科目名稱
        els['tbody-bill'].querySelectorAll('[data-field="BillAccId"]').forEach(input => {
            input.addEventListener('blur', (e) => {
                const idx = e.target.getAttribute('data-index');
                const accId = e.target.value.trim();
                const row = e.target.closest('tr');

                const option = billAccIdOptions.find(opt => (opt.AccId || '').trim() === accId);
                const nameCell = row.querySelector('.bill-acc-id-name');
                if (nameCell) nameCell.textContent = option ? option.AccIdName : '';

                if (billData[idx]) {
                    billData[idx].BillAccId = accId;
                    billData[idx].BillAccIdName = option ? option.AccIdName : '';
                }
            });
        });

        // RecvBankId blur - 更新收款銀行名稱，載入收款帳號選項
        els['tbody-bill'].querySelectorAll('[data-field="RecvBankId"]').forEach(input => {
            input.addEventListener('blur', async (e) => {
                const idx = e.target.getAttribute('data-index');
                const bankId = e.target.value.trim();
                const row = e.target.closest('tr');

                const option = billRecvBankOptions.find(opt => (opt.BankId || '').trim() === bankId);
                const nameCell = row.querySelector('.bill-recv-bank-name');
                if (nameCell) nameCell.textContent = option ? option.Name : '';

                if (billData[idx]) {
                    billData[idx].RecvBankId = bankId;
                    billData[idx].BankNameRecv = option ? option.Name : '';
                }

                if (bankId) {
                    delete billAccountOptions[bankId];  // 清除快取，確保重新 fetch
                    await loadBillAccountIdOptions(bankId);
                    const datalist = document.getElementById(`bill-recv-account-list-${idx}`);
                    if (datalist) datalist.innerHTML = renderBillAccountDatalistOptions(bankId);
                }
            });
        });

        // RecvAccountId blur
        els['tbody-bill'].querySelectorAll('[data-field="RecvAccountId"]').forEach(input => {
            input.addEventListener('blur', (e) => {
                const idx = e.target.getAttribute('data-index');
                if (billData[idx]) billData[idx].RecvAccountId = e.target.value.trim();
            });
        });
    };

    // 自動觸發票號生成 (PayBankId/BillTypeId/BillCode 任一變更時)
    const tryGenerateBillNumber = async (idx) => {
        const item = billData[idx];
        if (!item || !item.PayBankId || !item.BillTypeId) return;
        try {
            const resp = await fetch('/api/StrikeSelect/GenerateBillNumber', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paperNum: paperNum,
                    billType: item.BillTypeId
                })
            }));
            const data = await resp.json();
            if (data.ok && data.billNum) {
                item.BillId = data.billNum;
                const billIdInput = els['tbody-bill']?.querySelector(`tr[data-index="${idx}"] [data-field="BillId"]`);
                if (billIdInput) billIdInput.value = data.billNum;
            }
        } catch (err) {
            console.error('tryGenerateBillNumber error:', err);
        }
    };

    // 載入科目選項
    const loadAccIdOptions = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/GetAccIdOptions`, withJwtHeaders());
            if (!resp.ok) return;
            const data = await resp.json();
            if (data.ok) {
                accIdOptions = data.rows || [];
            }
        } catch (err) {
            console.error('loadAccIdOptions error:', err);
        }
    };

    // 載入子科目選項
    const loadSubAccIdOptions = async (accId) => {
        if (!accId || subAccIdOptions[accId]) return;
        try {
            const resp = await fetch(`/api/StrikeSelect/GetSubAccIdOptions?accId=${encodeURIComponent(accId)}`, withJwtHeaders());
            if (!resp.ok) return;
            const data = await resp.json();
            if (data.ok) {
                subAccIdOptions[accId] = data.rows || [];
            }
        } catch (err) {
            console.error('loadSubAccIdOptions error:', err);
        }
    };

    // 載入銀行選項
    const loadBankOptions = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/GetBankOptions`, withJwtHeaders());
            if (!resp.ok) return;
            const data = await resp.json();
            if (data.ok) {
                bankOptions = data.rows || [];
            }
        } catch (err) {
            console.error('loadBankOptions error:', err);
        }
    };

    // 載入帳戶選項
    const loadAccountOptions = async (bankId) => {
        if (!bankId || accountOptions[bankId]) return;
        try {
            const resp = await fetch(`/api/StrikeSelect/GetAccountOptions?bankId=${encodeURIComponent(bankId)}`, withJwtHeaders());
            if (!resp.ok) return;
            const data = await resp.json();
            if (data.ok) {
                accountOptions[bankId] = data.rows || [];
            }
        } catch (err) {
            console.error('loadAccountOptions error:', err);
        }
    };

    // 渲染子科目 datalist 選項
    const renderSubAccIdDatalistOptions = (accId, selectedSubAccId) => {
        const options = subAccIdOptions[accId] || [];
        return options.map(opt =>
            `<option value="${opt.SubAccId}">${opt.SubAccId} - ${opt.SubAccName}</option>`
        ).join('');
    };

    // 渲染帳戶 datalist 選項
    const renderAccountDatalistOptions = (bankId, selectedAccountId) => {
        const options = accountOptions[bankId] || [];
        return options.map(opt =>
            `<option value="${opt.AccountId}">${opt.AccountId} - ${opt.ShortName || ''}</option>`
        ).join('');
    };

    // 綁定科目變更事件
    const bindOtherAccIdChangeEvents = () => {
        const inputs = els['tbody-other'].querySelectorAll('[data-field="AccId"]');
        inputs.forEach(input => {
            // blur 事件處理 - 當失去焦點時更新名稱
            input.addEventListener('blur', async (e) => {
                const idx = e.target.getAttribute('data-index');
                const accId = e.target.value.trim();
                const row = e.target.closest('tr');

                // 更新科目名稱
                const option = accIdOptions.find(opt => opt.AccId === accId);
                const nameCell = row.querySelector('.acc-id-name');
                if (nameCell) {
                    nameCell.textContent = option ? option.AccIdName : '';
                }

                // 更新資料
                if (otherDtlData[idx]) {
                    otherDtlData[idx].AccId = accId;
                    otherDtlData[idx].AccIdName = option ? option.AccIdName : '';
                }

                // 載入子科目選項
                if (accId) {
                    await loadSubAccIdOptions(accId);
                    const subAccInput = row.querySelector('[data-field="SubAccId"]');
                    const datalistId = `sub-acc-id-list-${idx}`;
                    const datalist = document.getElementById(datalistId);
                    if (datalist) {
                        datalist.innerHTML = renderSubAccIdDatalistOptions(accId, '');
                    }
                }
            });
        });

        const subInputs = els['tbody-other'].querySelectorAll('[data-field="SubAccId"]');
        subInputs.forEach(input => {
            // blur 事件處理 - 當失去焦點時更新名稱
            input.addEventListener('blur', (e) => {
                const idx = e.target.getAttribute('data-index');
                const subAccId = e.target.value.trim();
                const row = e.target.closest('tr');
                const accIdInput = row.querySelector('[data-field="AccId"]');
                const accId = accIdInput ? accIdInput.value.trim() : '';

                // 更新子科目名稱
                const options = subAccIdOptions[accId] || [];
                const option = options.find(opt => opt.SubAccId === subAccId);
                const nameCell = row.querySelector('.sub-acc-name');
                if (nameCell) {
                    nameCell.textContent = option ? option.SubAccName : '';
                }

                // 更新資料
                if (otherDtlData[idx]) {
                    otherDtlData[idx].SubAccId = subAccId;
                    otherDtlData[idx].SubAccName = option ? option.SubAccName : '';
                }
            });
        });
    };

    // 綁定手續費科目變更事件
    const bindPostAccIdChangeEvents = () => {
        const inputs = els['tbody-post'].querySelectorAll('[data-field="PostAccId"]');
        inputs.forEach(input => {
            // blur 事件處理 - 當失去焦點時更新名稱
            input.addEventListener('blur', async (e) => {
                const idx = e.target.getAttribute('data-index');
                const accId = e.target.value.trim();
                const row = e.target.closest('tr');

                // 更新科目名稱
                const option = accIdOptions.find(opt => opt.AccId === accId);
                const nameCell = row.querySelector('.acc-id-name');
                if (nameCell) {
                    nameCell.textContent = option ? option.AccIdName : '';
                }

                // 更新資料
                if (postData[idx]) {
                    postData[idx].PostAccId = accId;
                    postData[idx].AccIdName = option ? option.AccIdName : '';
                }

                // 載入子科目選項
                if (accId) {
                    await loadSubAccIdOptions(accId);
                    const subAccInput = row.querySelector('[data-field="PostSubAccId"]');
                    const datalistId = `post-sub-acc-id-list-${idx}`;
                    const datalist = document.getElementById(datalistId);
                    if (datalist) {
                        datalist.innerHTML = renderSubAccIdDatalistOptions(accId, '');
                    }
                }
            });
        });

        const subInputs = els['tbody-post'].querySelectorAll('[data-field="PostSubAccId"]');
        subInputs.forEach(input => {
            // blur 事件處理 - 當失去焦點時更新名稱
            input.addEventListener('blur', (e) => {
                const idx = e.target.getAttribute('data-index');
                const subAccId = e.target.value.trim();
                const row = e.target.closest('tr');
                const accIdInput = row.querySelector('[data-field="PostAccId"]');
                const accId = accIdInput ? accIdInput.value.trim() : '';

                // 更新子科目名稱
                const options = subAccIdOptions[accId] || [];
                const option = options.find(opt => opt.SubAccId === subAccId);
                const nameCell = row.querySelector('.sub-acc-name');
                if (nameCell) {
                    nameCell.textContent = option ? option.SubAccName : '';
                }

                // 更新資料
                if (postData[idx]) {
                    postData[idx].PostSubAccId = subAccId;
                    postData[idx].SubAccName = option ? option.SubAccName : '';
                }
            });
        });
    };

    // 綁定銀行變更事件
    const bindPostBankChangeEvents = () => {
        const inputs = els['tbody-post'].querySelectorAll('[data-field="PostBankId"]');
        inputs.forEach(input => {
            // blur 事件處理 - 當失去焦點時更新名稱
            input.addEventListener('blur', async (e) => {
                const idx = e.target.getAttribute('data-index');
                const bankId = e.target.value.trim();
                const row = e.target.closest('tr');

                // 更新銀行名稱 (注意: BankId 可能有尾隨空格，需要 trim)
                const option = bankOptions.find(opt => (opt.BankId || '').trim() === bankId);
                const nameCell = row.querySelector('.bank-name');
                if (nameCell) {
                    nameCell.textContent = option ? option.Name : '';
                }

                // 更新資料
                if (postData[idx]) {
                    postData[idx].PostBankId = bankId;
                    postData[idx].PostBankName = option ? option.Name : '';
                }

                // 載入帳戶選項
                if (bankId) {
                    await loadAccountOptions(bankId);
                    const accountInput = row.querySelector('[data-field="PostAccountId"]');
                    const datalistId = `account-id-list-${idx}`;
                    const datalist = document.getElementById(datalistId);
                    if (datalist) {
                        datalist.innerHTML = renderAccountDatalistOptions(bankId, '');
                    }
                }
            });
        });

        const accountInputs = els['tbody-post'].querySelectorAll('[data-field="PostAccountId"]');
        accountInputs.forEach(input => {
            // blur 事件處理
            input.addEventListener('blur', (e) => {
                const idx = e.target.getAttribute('data-index');
                const accountId = e.target.value.trim();

                // 更新資料
                if (postData[idx]) {
                    postData[idx].PostAccountId = accountId;
                }
            });
        });
    };

    // 載入其他扣款資料（左側：科目明細）
    const loadOtherDtlData = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/GetDetailOtherData?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
            if (!resp.ok) return;

            const data = await resp.json();
            if (data.ok) {
                otherDtlData = data.rows || [];

                // 預先載入所有已選擇科目的子科目選項
                const accIds = [...new Set(otherDtlData.map(item => item.AccId).filter(id => id))];
                await Promise.all(accIds.map(accId => loadSubAccIdOptions(accId)));

                renderOtherDtlTable();
            }
        } catch (err) {
            console.error('loadOtherDtlData error:', err);
        }
    };

    // 綁定行點擊選擇事件（用於 other/post 等無 checkbox 的表格）
    const bindRowSelection = (target) => {
        const tbodyId = `${DOM_PREFIX}-tbody-${target}`;
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;

        tbody.querySelectorAll('tr[data-index]').forEach(tr => {
            tr.addEventListener('click', () => {
                tbody.querySelectorAll('tr.table-active').forEach(r => r.classList.remove('table-active'));
                tr.classList.add('table-active');
                selectedRows[target] = parseInt(tr.dataset.index);
            });
        });
    };

    // 渲染其他扣款表格（左側：科目明細）
    const renderOtherDtlTable = () => {
        if (!els['tbody-other']) return;

        els['tbody-other'].innerHTML = otherDtlData.map((item, idx) => `
            <tr data-index="${idx}">
                <td class="text-center">${item.Item || (idx + 1)}</td>
                <td>
                    <input
                        type="text"
                        class="form-control form-control-sm combo-select"
                        data-field="AccId"
                        data-index="${idx}"
                        value="${item.AccId || ''}"
                        list="acc-id-list-${idx}"
                        placeholder="輸入或選擇科目"
                        autocomplete="off"
                    />
                    <datalist id="acc-id-list-${idx}">
                        ${accIdOptions.map(opt => `<option value="${opt.AccId}">${opt.AccId} - ${opt.AccIdName}</option>`).join('')}
                    </datalist>
                </td>
                <td class="acc-id-name">${item.AccIdName || ''}</td>
                <td>
                    <input
                        type="text"
                        class="form-control form-control-sm combo-select"
                        data-field="SubAccId"
                        data-index="${idx}"
                        value="${item.SubAccId || ''}"
                        list="sub-acc-id-list-${idx}"
                        placeholder="輸入或選擇子科目"
                        autocomplete="off"
                    />
                    <datalist id="sub-acc-id-list-${idx}">
                        ${renderSubAccIdDatalistOptions(item.AccId, item.SubAccId)}
                    </datalist>
                </td>
                <td class="sub-acc-name">${item.SubAccName || ''}</td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="AmountOg" value="${item.AmountOg || 0}" step="0.01" /></td>
                <td class="text-center"><input type="checkbox" class="form-check-input" data-field="IsReverse" ${item.IsReverse === 1 ? 'checked' : ''} /></td>
                <td><input type="text" class="form-control form-control-sm" data-field="Notes" value="${item.Notes || ''}" /></td>
            </tr>
        `).join('');

        // 綁定科目變更事件
        bindOtherAccIdChangeEvents();
        // 綁定行選擇事件
        selectedRows['other'] = null;
        bindRowSelection('other');
        // 綁定 datalist 前綴過濾
        bindDatalistPrefixFilter(els['tbody-other']);
    };

    // 載入手續費資料（右側：手續費本位幣）
    const loadPostData = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/GetDetailPostData?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
            if (!resp.ok) return;

            const data = await resp.json();
            if (data.ok) {
                postData = data.rows || [];

                // 預先載入所有已選擇科目的子科目選項
                const accIds = [...new Set(postData.map(item => item.PostAccId).filter(id => id))];
                await Promise.all(accIds.map(accId => loadSubAccIdOptions(accId)));

                // 預先載入所有已選擇銀行的帳戶選項
                const bankIds = [...new Set(postData.map(item => item.PostBankId).filter(id => id))];
                await Promise.all(bankIds.map(bankId => loadAccountOptions(bankId)));

                renderPostTable();
            }
        } catch (err) {
            console.error('loadPostData error:', err);
        }
    };

    // 渲染手續費表格（右側：手續費本位幣）
    const renderPostTable = () => {
        if (!els['tbody-post']) return;

        els['tbody-post'].innerHTML = postData.map((item, idx) => `
            <tr data-index="${idx}">
                <td class="text-center">${item.Item || (idx + 1)}</td>
                <td>
                    <input
                        type="text"
                        class="form-control form-control-sm combo-select"
                        data-field="PostAccId"
                        data-index="${idx}"
                        value="${item.PostAccId || ''}"
                        list="post-acc-id-list-${idx}"
                        placeholder="輸入或選擇科目"
                        autocomplete="off"
                    />
                    <datalist id="post-acc-id-list-${idx}">
                        ${accIdOptions.map(opt => `<option value="${opt.AccId}">${opt.AccId} - ${opt.AccIdName}</option>`).join('')}
                    </datalist>
                </td>
                <td class="acc-id-name">${item.AccIdName || ''}</td>
                <td>
                    <input
                        type="text"
                        class="form-control form-control-sm combo-select"
                        data-field="PostSubAccId"
                        data-index="${idx}"
                        value="${item.PostSubAccId || ''}"
                        list="post-sub-acc-id-list-${idx}"
                        placeholder="輸入或選擇子科目"
                        autocomplete="off"
                    />
                    <datalist id="post-sub-acc-id-list-${idx}">
                        ${renderSubAccIdDatalistOptions(item.PostAccId, item.PostSubAccId)}
                    </datalist>
                </td>
                <td class="sub-acc-name">${item.SubAccName || ''}</td>
                <td>
                    <input
                        type="text"
                        class="form-control form-control-sm combo-select"
                        data-field="PostBankId"
                        data-index="${idx}"
                        value="${item.PostBankId || ''}"
                        list="bank-id-list-${idx}"
                        placeholder="輸入或選擇銀行"
                        autocomplete="off"
                    />
                    <datalist id="bank-id-list-${idx}">
                        ${bankOptions.map(opt => `<option value="${opt.BankId}">${opt.BankId} - ${opt.Name}</option>`).join('')}
                    </datalist>
                </td>
                <td class="bank-name">${item.PostBankName || ''}</td>
                <td>
                    <input
                        type="text"
                        class="form-control form-control-sm combo-select"
                        data-field="PostAccountId"
                        data-index="${idx}"
                        value="${item.PostAccountId || ''}"
                        list="account-id-list-${idx}"
                        placeholder="輸入或選擇帳戶"
                        autocomplete="off"
                    />
                    <datalist id="account-id-list-${idx}">
                        ${renderAccountDatalistOptions(item.PostBankId, item.PostAccountId)}
                    </datalist>
                </td>
                <td><input type="number" class="form-control form-control-sm text-end" data-field="PostAmount" value="${item.PostAmount || 0}" step="0.01" /></td>
            </tr>
        `).join('');

        // 綁定科目變更事件
        bindPostAccIdChangeEvents();
        // 綁定銀行變更事件
        bindPostBankChangeEvents();
        // 綁定行選擇事件
        selectedRows['post'] = null;
        bindRowSelection('post');
        // 綁定 datalist 前綴過濾
        bindDatalistPrefixFilter(els['tbody-post']);
    };

    // 載入抵扣款明細資料
    const loadDebitData = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/GetDetailDebitData?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
            if (!resp.ok) return;

            const data = await resp.json();
            if (data.ok) {
                debitData = data.rows || [];
                renderDebitTable();
            }
        } catch (err) {
            console.error('loadDebitData error:', err);
        }
    };

    // 渲染抵扣款明細表格
    const renderDebitTable = () => {
        if (!els['tbody-debit']) return;

        els['tbody-debit'].innerHTML = debitData.map((item, idx) => `
            <tr data-index="${idx}" data-sournum="${item.SourNum || ''}" data-item="${item.Item || ''}" data-certifnum="${item.CertifNum || ''}">
                <td class="text-end">${item.Item || ''}</td>
                <td>${item.PaperNum || ''}</td>
                <td>${item.SourNum || ''}</td>
                <td class="text-end">${formatNumber(item.RateToNT)}</td>
                <td class="text-end">${formatNumber(item.RestAmountOg)}</td>
                <td class="text-end">${formatNumber(item.RestAmount)}</td>
                <td class="text-end">${formatNumber(item.CutAmountOg)}</td>
                <td class="text-end">${formatNumber(item.CutAmount)}</td>
                <td>${item.InvoiceNum || ''}</td>
            </tr>
        `).join('');

        // 綁定雙擊事件
        els['tbody-debit'].querySelectorAll('tr').forEach(tr => {
            tr.addEventListener('dblclick', async () => {
                const sourNum = tr.dataset.sournum;
                const item = parseInt(tr.dataset.item);
                const certifNum = tr.dataset.certifnum || '';
                if (sourNum) {
                    await executeAutoCalc('cut', sourNum, certifNum, item, -1);
                }
            });
        });
    };

    // 執行自動計算（自動分配金額到來源資料）
    // 雙擊下半部的金額欄位時，會將上半部對應頁籤的金額總額分配到這筆來源資料
    // 如果這筆剩餘金額不夠就分配到下一筆，最多不能超過剩餘金額
    const executeAutoCalc = async (fieldName, sourNum, certifNum, item, sourceType) => {
        if (autoCount !== 1) return;

        try {
            const resp = await fetch('/api/StrikeSelect/DetailAutoCalc', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paperNum: paperNum,
                    sourNum: sourNum || '',
                    item: item || 1,
                    certifNum: certifNum || '',
                    sourceField: fieldName || '',
                    sourceType: sourceType
                })
            }));

            if (resp.ok) {
                const data = await resp.json();
                if (data.ok) {
                    // 重新載入來源表格以顯示自動分配後的金額
                    await loadSourceData();
                    // 對應 Delphi: AutoCalc 結束後呼叫 Execute 更新已輸入金額總計
                    await loadAllAmountData();
                }
            }
        } catch (err) {
            console.error('executeAutoCalc error:', err);
        }
    };

    // 載入所有金額資料 (對應 Delphi Execute -> qryAllAmount / APRdStrikeCalcAllAmount)
    const loadAllAmountData = async () => {
        try {
            const resp = await fetch(`/api/StrikeSelect/GetDetailAllAmount?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
            if (!resp.ok) return;

            const data = await resp.json();
            if (data.ok) {
                const a = data.data;

                // 更新上半部 footer: 已輸入金額總計 (對應 Delphi pnlButtomSum)
                // 注意：現金總計不在此更新，只在上半部「現金沖帳」頁籤儲存時才更新
                updateAmountDisplay('txt-use-bank', a.UseBankAmount);
                updateAmountDisplay('txt-use-bill', a.UseBillAmount);
                updateAmountDisplay('txt-use-other', a.UseOtherAmount);
                updateAmountDisplay('txt-use-debit', a.UseDebitAmount);

                // 逐項比較：已輸入金額 > 來源分配金額時，該項顯示紅色 (對應 Delphi Execute)
                // 根據 strikeMode / specialMode 決定比較對象
                let fCash, fBank, fBill, fOther;
                if (strikeMode === 0) {
                    if (specialMode === 1) {
                        fCash  = a.CalcCashAmountOg || 0;
                        fBank  = a.CalcBankAmountOg || 0;
                        fBill  = a.CalcBillAmountOg || 0;
                        fOther = a.CalcOtherAmountOg || 0;
                    } else {
                        fCash  = a.CashAmountOg || 0;
                        fBank  = a.BankAmountOg || 0;
                        fBill  = a.BillAmountOg || 0;
                        fOther = a.OtherAmountOg || 0;
                    }
                } else {
                    fCash  = a.CashAmount || 0;
                    fBank  = a.BankAmount || 0;
                    fBill  = a.BillAmount || 0;
                    fOther = a.OtherAmount || 0;
                }

                const cashDisplayVal = parseFloat(els['txt-use-cash']?.textContent?.replace(/,/g, '') || '0') || 0;
                const setRedIf = (id, used, limit) => {
                    const el = els[id];
                    if (!el) return;
                    if (used > limit) el.classList.add('amount-red');
                    else el.classList.remove('amount-red');
                };
                setRedIf('txt-use-cash',  cashDisplayVal,        fCash);
                setRedIf('txt-use-bank',  a.UseBankAmount || 0,  fBank);
                setRedIf('txt-use-bill',  a.UseBillAmount || 0,  fBill);
                setRedIf('txt-use-other', a.UseOtherAmount || 0, fOther);

                // 更新底部總計 (對應 Delphi pnlOk)
                if (els['txt-sum-amount-og']) els['txt-sum-amount-og'].textContent = formatNumber(a.SUMAmountOg);
                if (els['txt-sum-amount']) els['txt-sum-amount'].textContent = formatNumber(a.SUMAmount);
                if (els['txt-strike-amount']) els['txt-strike-amount'].textContent = formatNumber(a.StrikeAmount);
                if (els['txt-rest-calc-og']) els['txt-rest-calc-og'].textContent = formatNumber(a.RestCalcOg);

                // 儲存金額資料供分配總計 footer 使用
                lastAmountData = a;
                // 更新下半部 footer: 分配總計 (對應 Delphi pnlMidSum1/pnlMidSum2/pnlMidSum3)
                updateSourceFooterTotal();
            }
        } catch (err) {
            console.error('loadAllAmountData error:', err);
        }
    };

    // 更新下半部 footer 分配總計 (根據當前 source 頁籤顯示對應沖銷金額合計)
    const updateSourceFooterTotal = () => {
        if (!els['src-footer-total'] || !lastAmountData) return;

        const a = lastAmountData;
        // 取得當前 source 頁籤
        const sourceNavTabs = document.getElementById('strike-dtl-source-navtabs');
        const activeLink = sourceNavTabs?.querySelector('.nav-link.active');
        const activeTab = activeLink?.getAttribute('data-tab-target') || '';

        let total = 0;
        if (activeTab === '#strike-dtl-source-calc') {
            // 兌換對照頁籤: 加總 CalcCashAmountOg + CalcBankAmountOg + CalcBillAmountOg + CalcOtherAmountOg
            total = (a.CalcCashAmountOg || 0) + (a.CalcBankAmountOg || 0) + (a.CalcBillAmountOg || 0) + (a.CalcOtherAmountOg || 0);
        } else if (activeTab === '#strike-dtl-source') {
            // (本位幣)頁籤: 加總各項本位幣沖銷金額
            sourceData.forEach(item => { total += item.StrikeAmount || 0; });
        } else {
            // (原幣)頁籤 (預設): 加總各項原幣沖銷金額
            sourceData.forEach(item => { total += item.StrikeAmountOg || 0; });
        }
        els['src-footer-total'].textContent = formatNumber(total);
    };

    // 更新金額顯示
    const updateAmountDisplay = (elementId, useAmount) => {
        const el = els[elementId];
        if (!el) return;

        el.textContent = formatNumber(useAmount);
    };

    // 儲存沖帳資料
    const saveStrikeData = async () => {
        try {
            const resp = await fetch('/api/StrikeSelect/SaveDetailStrike', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paperNum: paperNum })
            }));

            const data = await resp.json();

            if (!resp.ok || !data.ok) {
                if (data.needHandle) {
                    // 需要處理超溢/短溢
                    await notify('warning', data.message || '需要處理超溢/短溢');
                    // TODO: 開啟處理對話框
                    return;
                }

                await notify('error', data.message || '儲存失敗');
                return;
            }
            
            // 執行確認後彙總處理 (APRdStrikeSubInsSum)
            try {
                await fetch('/api/StrikeSelect/ExecuteSubInsSum', withJwtHeaders({
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paperNum: paperNum })
                }));
            } catch (subErr) {
                console.error('ExecuteSubInsSum error:', subErr);
            }

            hideModal();

            // 刷新資料
            if (typeof window.__refreshHeaderData === "function") {
                try { await window.__refreshHeaderData(); } catch {}
            }
            if (typeof window.__refreshMultiTab === "function") {
                try { await window.__refreshMultiTab(); } catch {}
            }
        } catch (err) {
            console.error('saveStrikeData error:', err);
            await notify('error', '儲存失敗: ' + err.message);
        }
    };

    // 確認對話框
    const confirmAction = async (message) => {
        if (window.Swal) {
            const result = await window.Swal.fire({
                icon: 'question',
                title: message,
                showCancelButton: true,
                confirmButtonText: '確定',
                cancelButtonText: '取消'
            });
            return result.isConfirmed;
        }
        return confirm(message);
    };

    // 按鈕動作處理
    const handleButtonAction = async (action, target) => {
        switch (action) {
            case 'insert':
                await insertRow(target);
                break;
            case 'delete':
                await deleteRow(target);
                break;
            case 'post':
                await saveTableData(target);
                break;
            case 'cancel':
                await cancelTableChanges(target);
                break;
            case 'refresh':
                await refreshTableData(target);
                break;
            case 'move-up':
                await moveRow(target, 1);
                break;
            case 'move-down':
                await moveRow(target, 0);
                break;
        }
    };

    // 上移/下移功能
    const moveRow = async (target, direction) => {
        // 取得對應的表格和選中的行
        let tbody, targetData, sourceTable;

        switch (target) {
            case 'source':
            case 'source-og':
                tbody = els['tbody-source'];
                targetData = sourceData;
                sourceTable = 'APRdStrikeSourceInv';
                break;
            case 'source-calc':
                tbody = els['tbody-source-calc'];
                targetData = sourceData;
                sourceTable = 'APRdStrikeSourceCalcInv';
                break;
            default:
                await notify('info', '此頁籤不支援排序');
                return;
        }

        // 確認有選中的行
        const selectedIdx = selectedRows['source'] ?? selectedRows[target];
        if (selectedIdx == null || selectedIdx < 0) {
            await notify('info', '請先選擇要移動的資料');
            return;
        }

        // 取得選中行的 SourNum
        const selectedRow = targetData[selectedIdx];
        if (!selectedRow) {
            await notify('info', '找不到選中的資料');
            return;
        }
        const sortSerial = selectedRow.SortSerial;
        if (sortSerial == null) {
            await notify('info', '找不到排序序號');
            return;
        }

        // 檢查邊界
        if (direction === 1 && selectedIdx === 0) {
            await notify('info', '已經是第一筆');
            return;
        }
        if (direction === 0 && selectedIdx === targetData.length - 1) {
            await notify('info', '已經是最後一筆');
            return;
        }

        try {
            const resp = await fetch('/api/StrikeSelect/MoveRow', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sourceTable: sourceTable,
                    paperNum: paperNum,
                    item: sortSerial,
                    direction: direction
                })
            }));

            const data = await resp.json();
            if (!data.ok) {
                await Swal.fire({ icon: 'error', title: '移動失敗', text: data.error });
                return;
            }

            // 重新載入資料
            await loadSourceData();

            // 更新選中行的索引
            const newIdx = direction === 1 ? selectedIdx - 1 : selectedIdx + 1; // 1=上移, 0=下移
            selectedRows['source'] = newIdx;

            // 重新渲染並保持選中狀態
            renderSourceTable();

            // 高亮移動後的選中行
            [els['tbody-source-og'], els['tbody-source']].forEach(tbody => {
                if (!tbody) return;
                const tr = tbody.querySelector(`tr[data-index="${newIdx}"]`);
                if (tr) tr.classList.add('table-active');
            });
        } catch (err) {
            console.error('MoveRow error:', err);
            await Swal.fire({ icon: 'error', title: '移動失敗', text: err.message });
        }
    };

    // 新增一筆資料
    const insertRow = async (target) => {
        let targetData, renderFunc;

        switch (target) {
            case 'bank':
                targetData = bankData;
                renderFunc = renderBankTable;
                break;
            case 'bill':
                targetData = billData;
                renderFunc = renderBillTable;
                break;
            case 'other':
                targetData = otherDtlData;
                renderFunc = renderOtherDtlTable;
                break;
            case 'post':
                targetData = postData;
                renderFunc = renderPostTable;
                break;
            default:
                return;
        }

        // 新增一筆空白資料
        targetData.push({});
        renderFunc();
    };

    // 刪除選中的資料
    const deleteRow = async (target) => {
        let targetData, renderFunc;

        switch (target) {
            case 'bank':
                targetData = bankData;
                renderFunc = renderBankTable;
                break;
            case 'bill':
                targetData = billData;
                renderFunc = renderBillTable;
                break;
            case 'other':
                targetData = otherDtlData;
                renderFunc = renderOtherDtlTable;
                break;
            case 'post':
                targetData = postData;
                renderFunc = renderPostTable;
                break;
            default:
                return;
        }

        // 點擊哪一筆就刪哪一筆
        if (selectedRows[target] == null) return;
        targetData.splice(selectedRows[target], 1);
        selectedRows[target] = null;
        renderFunc();
    };

    // 儲存表格資料
    const saveTableData = async (target) => {
        try {
            let apiPath, dataToSave;

            switch (target) {
                case 'cash':
                    const cashAmount = parseFloat(els['cash-amount'].value) || 0;
                    await saveCashAmount(cashAmount);
                    return;
                case 'bank':
                    apiPath = 'SaveDetailBank';
                    dataToSave = collectTableData('bank');
                    break;
                case 'bill':
                    apiPath = 'SaveDetailBill';
                    dataToSave = collectTableData('bill');
                    break;
                case 'other':
                    apiPath = 'SaveDetailOther';
                    dataToSave = collectTableData('other');
                    break;
                case 'post':
                    apiPath = 'SaveDetailPost';
                    dataToSave = collectTableData('post');
                    break;
                case 'debit':
                    apiPath = 'SaveDetailDebit';
                    dataToSave = collectTableData('debit');
                    break;
                case 'source':
                    apiPath = 'SaveDetailSource';
                    dataToSave = collectTableData('source');
                    break;
                default:
                    return;
            }

            const resp = await fetch(`/api/StrikeSelect/${apiPath}`, withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paperNum: paperNum,
                    rows: dataToSave
                })
            }));

            if (resp.ok) {
                const data = await resp.json();
                if (!data.ok) {
                    await notify('error', data.error || '儲存失敗');
                } else {
                    // 儲存成功後更新資料
                    if (target === 'source') {
                        // 下半部儲存時：先更新沖銷金額（重新載入來源資料）再更新分配總計
                        await loadSourceData();
                        await loadAllAmountData();
                    } else {
                        // 對應 Delphi tblStrikeBankAfterPost: AutoCalc(SourceStr,'','',1,-1)
                        // 上半部頁籤儲存後，觸發自動分配到下半部來源對應欄位（從第一筆開始）
                        const fieldMap = { bank: 'bank', bill: 'bill', other: 'other', debit: 'cut' };
                        const autoCalcField = fieldMap[target];
                        if (autoCalcField) {
                            await executeAutoCalc(autoCalcField, '', '', 1, -1);
                        } else {
                            await loadAllAmountData();
                        }
                    }
                }
            } else {
                await notify('error', '儲存失敗');
            }
        } catch (err) {
            console.error('saveTableData error:', err);
            await notify('error', '儲存失敗: ' + err.message);
        }
    };

    // 收集表格資料
    const collectTableData = (target) => {
        const rows = [];
        let tbody, targetData;

        switch (target) {
            case 'bank':
                tbody = els['tbody-bank'];
                targetData = bankData;
                break;
            case 'bill':
                tbody = els['tbody-bill'];
                targetData = billData;
                break;
            case 'other':
                tbody = els['tbody-other'];
                targetData = otherDtlData;
                break;
            case 'post':
                tbody = els['tbody-post'];
                targetData = postData;
                break;
            case 'debit':
                tbody = els['tbody-debit'];
                targetData = debitData;
                break;
            case 'source':
                tbody = els['tbody-source'];
                targetData = sourceData;
                break;
        }

        if (!tbody) return rows;

        tbody.querySelectorAll('tr').forEach((tr, idx) => {
            const rowData = { ...targetData[idx] };

            // 處理非checkbox的input
            tr.querySelectorAll('input:not([type="checkbox"]), select, textarea').forEach(input => {
                const field = input.dataset.field || input.name;
                if (field) {
                    rowData[field] = input.value;
                }
            });

            // 處理checkbox (data-field的checkbox，不包括選擇用的checkbox)
            tr.querySelectorAll('input[type="checkbox"][data-field]').forEach(input => {
                const field = input.dataset.field;
                if (field) {
                    rowData[field] = input.checked ? 1 : 0;
                }
            });

            rows.push(rowData);
        });

        // source 頁籤：同時從 source-og（原幣）收集輸入值
        if (target === 'source' && els['tbody-source-og']) {
            els['tbody-source-og'].querySelectorAll('tr').forEach((tr, idx) => {
                if (!rows[idx]) return;
                tr.querySelectorAll('input:not([type="checkbox"]), select, textarea').forEach(input => {
                    const field = input.dataset.field || input.name;
                    if (field) {
                        rows[idx][field] = input.value;
                    }
                });
            });
        }
        return rows;
    };

    // 取消變更
    const cancelTableChanges = async (target) => {
        if (target === 'cash') {
            // 現金沖帳：還原為原始金額，不呼叫 API
            if (els['cash-amount']) {
                els['cash-amount'].value = oriAmount;
            }
            return;
        }
        await refreshTableData(target);
    };

    // 重新整理表格資料
    const refreshTableData = async (target) => {
        switch (target) {
            case 'cash':
                await loadMasterData();
                break;
            case 'bank':
                await loadBankData();
                break;
            case 'bill':
                await loadBillData();
                break;
            case 'other':
                await loadOtherDtlData();
                break;
            case 'post':
                await loadPostData();
                break;
            case 'debit':
                await loadDebitData();
                break;
            case 'source':
                await loadSourceData();
                break;
        }
    };

    // 初始化事件
    let eventsBound = false;

    const initEvents = () => {
        initElements();

        if (!els.modal || eventsBound) return;
        eventsBound = true;

        // Modal 初始化
        if (window.bootstrap?.Modal) {
            modal = window.bootstrap.Modal.getOrCreateInstance(els.modal, { backdrop: 'static' });
        }

        // 按鈕事件
        if (els['btn-save']) {
            els['btn-save'].addEventListener('click', saveStrikeData);
        }

        // 取消/關閉共用邏輯
        const handleCancel = async () => {
            if (confirm('確定要取消嗎？未儲存的資料將會遺失。')) {
                // 清除暫存資料 (APRdStrikeOtherClear)
                try {
                    await fetch('/api/StrikeSelect/ClearOtherTemp', withJwtHeaders({
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paperNum: paperNum })
                    }));
                } catch (clearErr) {
                    console.error('ClearOtherTemp error:', clearErr);
                }
                hideModal();
            }
        };

        if (els['btn-cancel']) {
            els['btn-cancel'].addEventListener('click', handleCancel);
        }

        // 右上角 X 按鈕也執行取消邏輯
        const btnCloseX = document.getElementById('strike-dtl-btn-close-x');
        if (btnCloseX) {
            btnCloseX.addEventListener('click', handleCancel);
        }

        // 現金金額變更：不再自動儲存，改由 ✓ 按鈕 (post) 手動儲存
        // 取消 (✗) 按鈕才能正確還原為原始值
        // (原 Delphi edtCashAmountOgExit → SaveCash 在 Web 版改為手動觸發)

        // 沖帳模式變更
        if (els['strike-mode']) {
            els['strike-mode'].addEventListener('change', async () => {
                strikeMode = parseInt(els['strike-mode'].value);
                await changeStrikeMode();
            });
        }

        // 預收付沖帳按鈕
        if (els['btn-advance']) {
            els['btn-advance'].addEventListener('click', () => {
                openAdvanceStrike();
            });
        }

        // 補滿原值按鈕
        document.querySelectorAll('.btn-spe-full').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!paperNum) return;
                try {
                    const resp = await fetch('/api/StrikeSelect/AutoFillOriginal', withJwtHeaders({
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paperNum: paperNum })
                    }));
                    const data = await resp.json();
                    if (data.ok) {
                        await loadSourceData();
                        await notify('success', '補滿原值完成');
                    } else {
                        await notify('error', data.error || '補滿原值失敗');
                    }
                } catch (err) {
                    console.error('AutoFillOriginal error:', err);
                    await notify('error', '補滿原值失敗: ' + err.message);
                }
            });
        });

        // 對沖帳按鈕
        if (els['btn-other']) {
            els['btn-other'].addEventListener('click', () => {
                if (window.OtherStrikeHandler && typeof window.OtherStrikeHandler.open === 'function') {
                    window.OtherStrikeHandler.open(paperNum);
                }
            });
        }

        // 票號自動生成按鈕 (對應 Delphi APRdBillNum)
        if (els['btn-gen-bill-num']) {
            els['btn-gen-bill-num'].addEventListener('click', async () => {
                if (!paperNum) {
                    await notify('info', '沒有單號');
                    return;
                }

                // 確認有選中的票據行
                const selectedIdx = selectedRows['bill'];
                if (selectedIdx == null || selectedIdx < 0) {
                    await notify('info', '請先選擇要生成票號的票據資料');
                    return;
                }

                const selectedRow = billData[selectedIdx];
                if (!selectedRow) {
                    await notify('info', '找不到選中的票據資料');
                    return;
                }

                // 取得票別
                const billType = selectedRow.BillType || '';
                if (!billType) {
                    await notify('info', '請先選擇票別');
                    return;
                }

                try {
                    const resp = await fetch('/api/StrikeSelect/GenerateBillNumber', withJwtHeaders({
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            paperNum: paperNum,
                            billType: billType
                        })
                    }));

                    const data = await resp.json();
                    if (!data.ok) {
                        await Swal.fire({ icon: 'error', title: '生成票號失敗', text: data.error });
                        return;
                    }

                    // 更新票據號碼到選中行
                    if (data.billNum) {
                        billData[selectedIdx].BillNum = data.billNum;
                        renderBillTable();
                        await notify('success', `已生成票號: ${data.billNum}`);
                    } else {
                        await notify('info', '未能生成票號');
                    }
                } catch (err) {
                    console.error('GenerateBillNumber error:', err);
                    await Swal.fire({ icon: 'error', title: '生成票號失敗', text: err.message });
                }
            });
        }

        // 折讓搜尋按鈕
        if (els['btn-debit-search']) {
            els['btn-debit-search'].addEventListener('click', () => {
                if (window.DebitSearchHandler && typeof window.DebitSearchHandler.open === 'function') {
                    window.DebitSearchHandler.open(paperNum);
                }
            });
        }

        // 清除折讓明細按鈕
        if (els['btn-debit-clear']) {
            els['btn-debit-clear'].addEventListener('click', async () => {
                if (!paperNum) {
                    await notify('info', '沒有單號');
                    return;
                }

                const result = await Swal.fire({
                    icon: 'warning',
                    title: '確定要清除所有折讓明細嗎？',
                    text: '此操作將清除所有折讓沖銷金額和明細記錄',
                    showCancelButton: true,
                    confirmButtonText: '確定清除',
                    cancelButtonText: '取消'
                });

                if (!result.isConfirmed) return;

                try {
                    const resp = await fetch('/api/StrikeSelect/ClearDebitData', withJwtHeaders({
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paperNum: paperNum })
                    }));

                    const data = await resp.json();
                    if (!data.ok) {
                        await Swal.fire({ icon: 'error', title: '清除失敗', text: data.error });
                        return;
                    }

                    await loadDebitData();
                    await executeAutoCalc('', '', '', 1, -1);
                } catch (err) {
                    console.error('ClearDebitData error:', err);
                    await Swal.fire({ icon: 'error', title: '清除失敗', text: err.message });
                }
            });
        }

        // 差額認列按鈕 (對應 Delphi btnElseClick)
        if (els['btn-else-insert']) {
            els['btn-else-insert'].addEventListener('click', async () => {
                if (!paperNum) {
                    await notify('info', '沒有單號');
                    return;
                }

                try {
                    // 執行差額認列 SP
                    const resp = await fetch('/api/StrikeSelect/ElseInsert', withJwtHeaders({
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paperNum: paperNum })
                    }));

                    const data = await resp.json();
                    if (!data.ok) {
                        await Swal.fire({ icon: 'error', title: '差額認列失敗', text: data.error });
                        return;
                    }

                    // 更新其他扣款資料
                    if (data.rows) {
                        otherDtlData = data.rows;

                        // 預先載入所有已選擇科目的子科目選項
                        const accIds = [...new Set(otherDtlData.map(item => item.AccId).filter(id => id))];
                        await Promise.all(accIds.map(accId => loadSubAccIdOptions(accId)));

                        renderOtherDtlTable();
                    }
                } catch (err) {
                    console.error('ElseInsert error:', err);
                    await Swal.fire({ icon: 'error', title: '差額認列失敗', text: err.message });
                }
            });
        }

        // 綁定所有 data-action 按鈕事件
        if (els.modal) {
            els.modal.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    const target = btn.dataset.target;
                    handleButtonAction(action, target);
                });
            });
        }

        // 自定義 Tab 切換處理函數
        const handleTabSwitch = (navtabsId, tabContentId, onSwitch) => {
            const navtabs = document.getElementById(navtabsId);
            const tabContent = document.getElementById(tabContentId);
            if (!navtabs || !tabContent) {
                console.warn('handleTabSwitch: navtabs or tabContent not found');
                return;
            }

            const links = navtabs.querySelectorAll('a[data-tab-target]');

            links.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();

                    const targetId = link.getAttribute('data-tab-target').substring(1);
                    const targetPane = document.getElementById(targetId);

                    if (!targetPane) {
                        console.warn('Target pane not found:', targetId);
                        return;
                    }

                    // 移除所有 active 狀態
                    navtabs.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    tabContent.querySelectorAll('.tab-pane').forEach(p => {
                        p.classList.remove('show', 'active');
                    });

                    // 添加 active 狀態到選中的項目
                    link.classList.add('active');
                    targetPane.classList.add('show', 'active');

                    // 切換後回呼
                    if (typeof onSwitch === 'function') onSwitch();
                });
            });
        };

        // 直接設置頁籤切換事件（不再等 shown.bs.modal 事件）
        handleTabSwitch('strike-dtl-source-navtabs', 'strike-dtl-source-tabs', updateSourceFooterTotal);
        handleTabSwitch('strike-dtl-detail-navtabs', 'strike-dtl-detail-tabs');

        // 初始化所有表格欄位拖拽調整寬度
        (() => {
            const dtlModal = document.getElementById('strike-dtl-modal');
            if (!dtlModal) return;

            // 在每個 th 裡加入拖拽把手
            dtlModal.querySelectorAll('table').forEach(table => {
                table.querySelectorAll('thead th').forEach(th => {
                    if (th.querySelector('.col-resizer')) return;
                    const r = document.createElement('span');
                    r.className = 'col-resizer';
                    th.appendChild(r);
                });
            });

            // 共享拖拽狀態
            let dragging = false, startX = 0, startW = 0, activeTh = null, activeResizer = null;

            dtlModal.addEventListener('mousedown', (e) => {
                const resizer = e.target.closest('.col-resizer');
                if (!resizer) return;
                e.preventDefault();
                activeTh = resizer.parentElement;
                activeResizer = resizer;
                startX = e.pageX;
                startW = activeTh.getBoundingClientRect().width;
                dragging = true;
                resizer.classList.add('active');
                document.body.style.cursor = 'col-resize';
            });

            document.addEventListener('mousemove', (e) => {
                if (!dragging || !activeTh) return;
                e.preventDefault();
                activeTh.style.width = Math.max(40, startW + (e.pageX - startX)) + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (!dragging) return;
                dragging = false;
                activeResizer?.classList.remove('active');
                activeTh = null;
                activeResizer = null;
                document.body.style.cursor = '';
            });
        })();

        // Modal 事件
        if (els.modal) {
            // Modal 關閉事件
            els.modal.addEventListener('hidden.bs.modal', () => {
                forceHideModal();
            });

            els.modal.querySelectorAll('[data-bs-dismiss="modal"], .btn-close').forEach((btn) => {
                btn.addEventListener('click', () => {
                    if (!modal) forceHideModal();
                });
            });
        }
    };

    // 儲存現金金額 (對應 Delphi SaveCash: tblMaster.Post → AutoCalc)
    const saveCashAmount = async (newAmount) => {
        try {
            // 對應 Delphi tblMaster.Post → 更新 APRdStrikeMain.CashAmountOg
            const resp = await fetch('/api/StrikeSelect/SaveDetailCash', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paperNum: paperNum,
                    cashAmountOg: newAmount
                })
            }));

            if (resp.ok) {
                const data = await resp.json();
                if (data.ok) {
                    oriAmount = newAmount;
                    // 儲存成功：更新已輸入金額總計的現金顯示
                    updateAmountDisplay('txt-use-cash', newAmount);
                    // 觸發自動分配到下半部來源的現金沖銷欄位
                    await executeAutoCalc('cash', '', '', 1, -1);
                } else {
                    await notify('error', data.error || '儲存現金金額失敗');
                }
            }
        } catch (err) {
            console.error('saveCashAmount error:', err);
            await notify('error', '儲存現金金額失敗: ' + err.message);
        }
    };

    // 變更沖帳模式
    const changeStrikeMode = async () => {
        try {
            const resp = await fetch('/api/StrikeSelect/ChangeDetailMode', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paperNum: paperNum,
                    strikeMode: strikeMode
                })
            }));

            if (resp.ok) {
                const data = await resp.json();
                if (data.ok) {
                    await loadSourceData();
                    await loadBillData();
                }
            }

            // 手續費面板顯隱控制
            const postPanel = document.getElementById('strike-dtl-post-panel');
            if (postPanel) {
                postPanel.style.display = (strikeMode === 0) ? 'none' : '';
            }

            // 票據 Amount 標籤文字
            const billThAmount = document.getElementById('bill-th-amount');
            if (billThAmount) {
                billThAmount.textContent = (strikeMode === 0) ? '台幣金額' : '金額';
            }
        } catch (err) {
            console.error('changeStrikeMode error:', err);
        }
    };

    // 開啟沖帳明細對話框
    const openStrikeDetail = async (ctx) => {
        if (!els.modal || !eventsBound) {
            initEvents();
        }

        paperNum = readPaperNum(ctx);
        if (!paperNum) {
            await notify('info', '沒有單號');
            return;
        }

        // 讀取 enableSAL 參數 (1:啟用SAL模式, 0:停用)
        enableSAL = (ctx?.enableSAL !== undefined) ? Number(ctx.enableSAL) : 0;

        try {
            const success = await loadMasterData();
            if (!success) return;

            showModal();
        } catch (err) {
            console.error('openStrikeDetail error:', err);
            await notify('error', '開啟失敗: ' + err.message);
        }
    };

    // DOM 載入後初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEvents);
    } else {
        initEvents();
    }

    // 註冊按鈕處理函式
    window.ActionRailCustomHandlers['PR000004'].btnC2 = openStrikeDetail;

    // 匯出重新載入抵扣款明細函式 (供折讓搜尋確認後使用)
    window.reloadDebitData = async () => {
        await loadDebitData();
        await executeAutoCalc('', '', '', 1, -1);

        // 折讓搜尋後自動分配 (DebitAutoSet)
        try {
            const resp = await fetch('/api/StrikeSelect/DebitAutoSend', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paperNum: paperNum })
            }));
            const data = await resp.json();
            if (data.ok && data.autoSet) {
                await executeAutoCalc('CutAmountOg', '', '', 1, -1);
            }
        } catch (err) {
            console.error('DebitAutoSend error:', err);
        }
    };

    // ========== 預收付沖帳功能 ==========

    // 預收付沖帳狀態
    const advanceState = {
        rows: [],
        selectedIndex: -1
    };

    // 開啟預收付沖帳對話框
    const openAdvanceStrike = async () => {
        if (!paperNum) {
            await notify('info', '沒有單號');
            return;
        }

        try {
            // 載入主檔資料
            const mainResp = await fetch(`/api/StrikeSelect/GetAdvanceMainData?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
            if (!mainResp.ok) {
                await notify('error', '無法取得主檔資料');
                return;
            }
            const mainData = await mainResp.json();
            if (!mainData.ok) {
                await notify('error', mainData.error || '無法取得主檔資料');
                return;
            }

            // 設定顯示值
            const advStrikeMode = document.getElementById('adv-strike-mode');
            const advStrikeRate = document.getElementById('adv-strike-rate');
            if (advStrikeMode) advStrikeMode.textContent = mainData.strikeModeName || '-';
            if (advStrikeRate) advStrikeRate.textContent = formatNumber(mainData.rateToNTStrike);

            // 載入清單資料
            await loadAdvanceList();

            // 顯示 Modal
            const advModal = document.getElementById('advance-strike-modal');
            if (advModal) {
                advModal.classList.add('show');
                advModal.style.display = 'block';
                advModal.style.zIndex = '1060';
                advModal.removeAttribute('aria-hidden');
                advModal.setAttribute('aria-modal', 'true');

                // 創建背景遮罩
                let advBackdrop = document.getElementById('adv-modal-backdrop');
                if (!advBackdrop) {
                    advBackdrop = document.createElement('div');
                    advBackdrop.id = 'adv-modal-backdrop';
                    advBackdrop.className = 'modal-backdrop fade show';
                    advBackdrop.style.zIndex = '1059';
                    document.body.appendChild(advBackdrop);
                }
            }
        } catch (err) {
            console.error('openAdvanceStrike error:', err);
            await notify('error', '開啟失敗: ' + err.message);
        }
    };

    // 關閉預收付沖帳對話框
    const closeAdvanceStrike = () => {
        const advModal = document.getElementById('advance-strike-modal');
        if (advModal) {
            advModal.classList.remove('show');
            advModal.style.display = 'none';
            advModal.setAttribute('aria-hidden', 'true');
            advModal.removeAttribute('aria-modal');
        }
        const advBackdrop = document.getElementById('adv-modal-backdrop');
        if (advBackdrop) {
            advBackdrop.remove();
        }
    };

    // 載入預收付沖帳清單
    const loadAdvanceList = async () => {
        const resp = await fetch(`/api/StrikeSelect/GetAdvanceList?paperNum=${encodeURIComponent(paperNum)}`, withJwtHeaders());
        if (!resp.ok) {
            await notify('error', '無法取得清單資料');
            return;
        }
        const data = await resp.json();
        if (!data.ok) {
            await notify('error', data.error || '無法取得清單資料');
            return;
        }

        advanceState.rows = data.rows || [];
        advanceState.selectedIndex = -1;
        renderAdvanceGrid();
    };

    // 渲染預收付沖帳表格
    const renderAdvanceGrid = () => {
        const tbody = document.getElementById('adv-grid-body');
        if (!tbody) return;

        if (advanceState.rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">沒有可沖帳的預收付單</td></tr>';
            return;
        }

        tbody.innerHTML = advanceState.rows.map((row, idx) => `
            <tr data-idx="${idx}" class="${idx === advanceState.selectedIndex ? 'selected' : ''}">
                <td>${row.SourNum || ''}</td>
                <td>${formatDate(row.PaperDate)}</td>
                <td>${row.MoneyName || ''}</td>
                <td class="text-end">${formatNumber(row.TotalAmountOg)}</td>
                <td class="text-end">${formatNumber(row.TotalAmount)}</td>
                <td class="editable-cell text-end">
                    <input type="text" class="adv-strike-amount-og form-control form-control-sm text-end" value="${formatNumber(row.StrikeAmountOg)}" data-idx="${idx}">
                </td>
                <td class="editable-cell text-end">
                    <input type="text" class="adv-strike-amount form-control form-control-sm text-end" value="${formatNumber(row.StrikeAmount)}" data-idx="${idx}">
                </td>
                <td class="editable-cell text-end">
                    <input type="text" class="adv-ori-amount-og form-control form-control-sm text-end" value="${formatNumber(row.OriAmountOg)}" data-idx="${idx}">
                </td>
            </tr>
        `).join('');

        // 綁定行點擊事件
        tbody.querySelectorAll('tr[data-idx]').forEach(tr => {
            tr.addEventListener('click', (e) => {
                if (e.target.tagName === 'INPUT') return;
                const idx = parseInt(tr.dataset.idx);
                advanceState.selectedIndex = idx;
                tbody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
                tr.classList.add('selected');
            });

            tr.addEventListener('dblclick', async (e) => {
                if (e.target.tagName === 'INPUT') return;
                const idx = parseInt(tr.dataset.idx);
                await calculateAdvanceRow(idx);
            });
        });

        // 綁定輸入框事件
        tbody.querySelectorAll('.adv-strike-amount-og, .adv-strike-amount, .adv-ori-amount-og').forEach(input => {
            input.addEventListener('blur', async (e) => {
                const idx = parseInt(e.target.dataset.idx);
                const newValue = parseAdvNumber(e.target.value);
                const row = advanceState.rows[idx];

                if (e.target.classList.contains('adv-strike-amount-og')) {
                    row.StrikeAmountOg = newValue;
                } else if (e.target.classList.contains('adv-strike-amount')) {
                    row.StrikeAmount = newValue;
                } else if (e.target.classList.contains('adv-ori-amount-og')) {
                    row.OriAmountOg = newValue;
                }

                e.target.value = formatNumber(newValue);
                await updateAdvanceRowAmount(idx);
            });
        });
    };

    // 解析數字
    const parseAdvNumber = (val) => {
        if (val === null || val === undefined || val === '') return 0;
        const n = parseFloat(val.toString().replace(/,/g, ''));
        return isNaN(n) ? 0 : n;
    };

    // 計算單筆沖帳金額 (雙擊)
    const calculateAdvanceRow = async (idx) => {
        const row = advanceState.rows[idx];
        try {
            const resp = await fetch('/api/StrikeSelect/CalculateAdvance', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paperNum: paperNum,
                    sourNum: row.SourNum
                })
            }));

            const data = await resp.json();
            if (!data.ok) {
                await notify('error', data.error || '計算失敗');
                return;
            }

            advanceState.rows[idx].StrikeAmountOg = data.strikeAmountOg;
            advanceState.rows[idx].StrikeAmount = data.strikeAmount;
            advanceState.rows[idx].OriAmountOg = data.oriAmountOg;

            renderAdvanceGrid();
        } catch (ex) {
            await notify('error', '計算失敗: ' + ex.message);
        }
    };

    // 更新單筆金額
    const updateAdvanceRowAmount = async (idx) => {
        const row = advanceState.rows[idx];
        try {
            await fetch('/api/StrikeSelect/UpdateAdvanceAmount', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paperNum: paperNum,
                    sourNum: row.SourNum,
                    strikeAmountOg: row.StrikeAmountOg || 0,
                    strikeAmount: row.StrikeAmount || 0,
                    oriAmountOg: row.OriAmountOg || 0
                })
            }));
        } catch (ex) {
            console.error('updateAdvanceRowAmount error:', ex);
        }
    };

    // 刪除選定 (清除沖帳金額)
    const deleteAdvanceSelected = async () => {
        if (advanceState.selectedIndex < 0) {
            await notify('info', '請先選擇一筆資料');
            return;
        }

        advanceState.rows[advanceState.selectedIndex].StrikeAmountOg = 0;
        advanceState.rows[advanceState.selectedIndex].StrikeAmount = 0;
        advanceState.rows[advanceState.selectedIndex].OriAmountOg = 0;

        await updateAdvanceRowAmount(advanceState.selectedIndex);
        renderAdvanceGrid();
    };

    // 確定儲存預收付沖帳
    const confirmAdvance = async () => {
        try {
            const resp = await fetch('/api/StrikeSelect/ConfirmAdvance', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paperNum: paperNum
                })
            }));

            const data = await resp.json();
            if (!data.ok) {
                await notify('error', data.error || '儲存失敗');
                return;
            }

            if (data.hasAdvance) {
                await notify('success', `已處理 ${data.processedCount} 筆預收付沖帳`);
            } else {
                await notify('info', '沒有選擇預收付沖帳');
            }

            closeAdvanceStrike();

            // 重新載入沖帳明細資料
            await loadSourceData();
            await loadOtherDtlData();
            await executeAutoCalc('', '', '', 1, -1);
        } catch (ex) {
            await notify('error', '儲存失敗: ' + ex.message);
        }
    };

    // 初始化預收付沖帳事件 (在 DOM 載入後執行)
    const initAdvanceEvents = () => {
        const advModal = document.getElementById('advance-strike-modal');
        if (!advModal) return;

        // 關閉按鈕
        advModal.querySelectorAll('.btn-close, [data-bs-dismiss="modal"]').forEach(btn => {
            btn.addEventListener('click', closeAdvanceStrike);
        });

        // 刪除按鈕 (-)
        const advBtnDelete = document.getElementById('adv-btn-delete');
        if (advBtnDelete) {
            advBtnDelete.addEventListener('click', deleteAdvanceSelected);
        }

        // 確認按鈕 (打勾) - 儲存當前編輯
        const advBtnPost = document.getElementById('adv-btn-post');
        if (advBtnPost) {
            advBtnPost.addEventListener('click', async () => {
                // 觸發所有輸入框的 blur 事件來儲存
                const inputs = document.querySelectorAll('#adv-grid-body input');
                inputs.forEach(input => input.blur());
            });
        }

        // 取消按鈕 (打叉) - 重新載入資料
        const advBtnCancel = document.getElementById('adv-btn-cancel');
        if (advBtnCancel) {
            advBtnCancel.addEventListener('click', loadAdvanceList);
        }

        // 重新整理按鈕
        const advBtnRefresh = document.getElementById('adv-btn-refresh');
        if (advBtnRefresh) {
            advBtnRefresh.addEventListener('click', loadAdvanceList);
        }

        // 確定按鈕 (底部)
        const advBtnOk = document.getElementById('adv-btn-ok');
        if (advBtnOk) {
            advBtnOk.addEventListener('click', confirmAdvance);
        }

        // 拖曳功能
        const headerEl = advModal.querySelector('.modal-header');
        const dialogEl = advModal.querySelector('.modal-dialog');
        if (headerEl && dialogEl) {
            let dragging = false;
            let startX = 0, startY = 0, origX = 0, origY = 0;

            headerEl.addEventListener('mousedown', (e) => {
                // 排除按鈕和關閉按鈕
                if (e.target.closest('button') || e.target.closest('input') || e.target.closest('select')) return;

                dragging = true;
                const rect = dialogEl.getBoundingClientRect();
                startX = e.clientX;
                startY = e.clientY;
                origX = rect.left;
                origY = rect.top;
                dialogEl.style.position = 'fixed';
                dialogEl.style.left = `${origX}px`;
                dialogEl.style.top = `${origY}px`;
                dialogEl.style.transform = 'none';
                dialogEl.style.margin = '0';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!dragging) return;
                dialogEl.style.left = `${origX + e.clientX - startX}px`;
                dialogEl.style.top = `${origY + e.clientY - startY}px`;
            });

            document.addEventListener('mouseup', () => { dragging = false; });
        }
    };

    // 確保預收付沖帳事件在 DOM 載入後初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAdvanceEvents);
    } else {
        initAdvanceEvents();
    }

    // 全域函式
    window.StrikeDetailHandler = {
        open: openStrikeDetail
    };

    // paperSearch 確認後自動開啟沖帳明細維護
    window.__paperSearchAfterConfirm = async ({ paperNum }) => {
        const openDtl = window.ActionRailCustomHandlers?.['PR000004']?.btnC2;
        if (typeof openDtl === 'function') {
            try { await openDtl({ paperNum }); } catch (e) { console.error('Auto open strike detail after paperSearch error:', e); }
            if (window.Swal) Swal.close();
        }
    };
})();
</script>

<!-- 預收付沖帳 Modal -->
<style>
    #advance-strike-modal .advance-strike-dialog { --bs-modal-width: 900px; --bs-modal-margin: 0; margin-top: 6vh; }
    #advance-strike-modal .advance-strike-content { height: calc(55vh); display: flex; flex-direction: column; }
    #advance-strike-modal.modal.show { align-items: flex-start; }
    #advance-strike-modal .modal-header { padding: 6px 12px; cursor: move; user-select: none; background: #f8fafc; }
    #advance-strike-modal .modal-header :is(button, input, select, textarea, a) { cursor: default; }
    #advance-strike-modal .modal-title { font-size: 16px; line-height: 1.2; font-weight: 600; }
    #advance-strike-modal .modal-body { flex: 1 1 auto; display: flex; flex-direction: column; min-height: 0; overflow: hidden; padding: 12px; }
    #advance-strike-modal .modal-footer { position: sticky; bottom: 0; background: #fff; z-index: 3; display: flex; align-items: center; gap: 12px; padding: 8px 12px; border-top: 1px solid #e5e7eb; }

    #advance-strike-modal .info-section {
        display: flex;
        gap: 24px;
        padding: 8px 12px;
        background: #f1f5f9;
        border-radius: 6px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }
    #advance-strike-modal .info-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #advance-strike-modal .info-label {
        font-weight: 600;
        color: #475569;
        font-size: 13px;
    }
    #advance-strike-modal .info-value {
        color: #1e293b;
        font-size: 13px;
        padding: 2px 8px;
        background: #fff;
        border-radius: 4px;
        border: 1px solid #e2e8f0;
    }

    #advance-strike-modal .grid-section {
        flex: 1 1 0;
        min-height: 0;
        overflow: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
    }
    #advance-strike-modal table {
        border-collapse: collapse;
        width: 100%;
    }
    #advance-strike-modal th, #advance-strike-modal td {
        border: 1px solid #dee2e6;
        vertical-align: middle;
        white-space: nowrap;
        font-size: var(--field-value-size, 13px);
        padding: 4px 8px;
        line-height: 1.3;
    }
    #advance-strike-modal thead th {
        position: sticky;
        top: 0;
        background: #f8fafc;
        z-index: 2;
        font-size: var(--field-label-size, 12px);
        font-weight: 600;
        text-align: center;
    }
    #advance-strike-modal tbody tr {
        cursor: pointer;
    }
    #advance-strike-modal tbody tr:hover {
        background: #f1f5f9;
    }
    #advance-strike-modal tbody tr.selected {
        background: #dbeafe !important;
    }

    #advance-strike-modal .editable-cell {
        background: #fff;
    }
    #advance-strike-modal .editable-cell input {
        border: 1px solid #cbd5e1;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 13px;
        text-align: right;
        width: 100%;
        box-sizing: border-box;
    }
    #advance-strike-modal .editable-cell input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    #advance-strike-modal .hint-text {
        font-size: 12px;
        color: #64748b;
        margin-top: 8px;
    }

    @@media (max-width: 991.98px) {
        #advance-strike-modal .advance-strike-dialog { --bs-modal-width: 100vw; --bs-modal-margin: 0; }
        #advance-strike-modal .advance-strike-content { border-radius: 0; }
    }
</style>

<div class="modal fade" id="advance-strike-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl advance-strike-dialog">
        <div class="modal-content advance-strike-content">
            <div class="modal-header">
                <h5 class="modal-title">預收付單查詢</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 資訊區域 -->
                <div class="info-section">
                    <div class="info-item">
                        <span class="info-label">目前沖銷模式：</span>
                        <span class="info-value" id="adv-strike-mode">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">目前沖銷匯率：</span>
                        <span class="info-value" id="adv-strike-rate">-</span>
                    </div>
                </div>

                <!-- 導覽列 -->
                <div style="padding: 4px 8px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; margin-bottom: 8px; display: flex; gap: 4px;">
                    <button type="button" class="btn btn-sm btn-outline-danger" id="adv-btn-delete" title="刪除">-</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="adv-btn-post" title="確認">&#10003;</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="adv-btn-cancel" title="取消">&#10007;</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="adv-btn-refresh" title="重新整理">&#8635;</button>
                </div>

                <!-- 表格區域 -->
                <div class="grid-section">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th style="width: 140px;">對沖帳編號</th>
                                <th style="width: 100px;">對沖帳日期</th>
                                <th style="width: 80px;">幣別</th>
                                <th style="width: 120px;">原幣金額</th>
                                <th style="width: 120px;">金額</th>
                                <th style="width: 120px;">沖帳原幣金額</th>
                                <th style="width: 120px;">沖帳金額</th>
                            </tr>
                        </thead>
                        <tbody id="adv-grid-body"></tbody>
                    </table>
                </div>

                <div class="hint-text">
                    提示：雙擊資料列可自動計算沖帳金額，或直接編輯「沖帳原幣金額」、「沖帳金額」欄位
                </div>
            </div>

            <!-- 底部區域 -->
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="adv-btn-ok">確定</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>

<!-- 對沖帳 Modal -->
<style>
    #other-strike-modal .other-strike-dialog { --bs-modal-width: 900px; --bs-modal-margin: 0; margin-top: 6vh; }
    #other-strike-modal .other-strike-content { height: calc(55vh); display: flex; flex-direction: column; }
    #other-strike-modal.modal.show { align-items: flex-start; }
    #other-strike-modal .modal-header { padding: 6px 12px; cursor: move; user-select: none; background: #f8fafc; }
    #other-strike-modal .modal-header :is(button, input, select, textarea, a) { cursor: default; }
    #other-strike-modal .modal-title { font-size: 16px; line-height: 1.2; font-weight: 600; }
    #other-strike-modal .modal-body { flex: 1 1 auto; display: flex; flex-direction: column; min-height: 0; overflow: hidden; padding: 12px; }
    #other-strike-modal .modal-footer { position: sticky; bottom: 0; background: #fff; z-index: 3; display: flex; align-items: center; gap: 12px; padding: 8px 12px; border-top: 1px solid #e5e7eb; }

    #other-strike-modal .info-section {
        display: flex;
        gap: 24px;
        padding: 8px 12px;
        background: #f1f5f9;
        border-radius: 6px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }
    #other-strike-modal .info-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #other-strike-modal .info-label {
        font-weight: 600;
        color: #475569;
        font-size: 13px;
    }
    #other-strike-modal .info-value {
        color: #1e293b;
        font-size: 13px;
        padding: 2px 8px;
        background: #fff;
        border-radius: 4px;
        border: 1px solid #e2e8f0;
    }

    #other-strike-modal .grid-section {
        flex: 1 1 0;
        min-height: 0;
        overflow: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
    }
    #other-strike-modal table {
        border-collapse: collapse;
        width: 100%;
    }
    #other-strike-modal th, #other-strike-modal td {
        border: 1px solid #dee2e6;
        vertical-align: middle;
        white-space: nowrap;
        font-size: var(--field-value-size, 13px);
        padding: 4px 8px;
        line-height: 1.3;
    }
    #other-strike-modal thead th {
        position: sticky;
        top: 0;
        background: #f8fafc;
        z-index: 2;
        font-size: var(--field-label-size, 12px);
        font-weight: 600;
        text-align: center;
    }
    #other-strike-modal tbody tr {
        cursor: pointer;
    }
    #other-strike-modal tbody tr:hover {
        background: #f1f5f9;
    }
    #other-strike-modal tbody tr.selected {
        background: #dbeafe !important;
    }

    #other-strike-modal .editable-cell {
        background: #fff;
    }
    #other-strike-modal .editable-cell input {
        border: 1px solid #cbd5e1;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 13px;
        text-align: right;
        width: 100%;
        box-sizing: border-box;
    }
    #other-strike-modal .editable-cell input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    #other-strike-modal .hint-text {
        font-size: 12px;
        color: #64748b;
        margin-top: 8px;
    }

    @@media (max-width: 991.98px) {
        #other-strike-modal .other-strike-dialog { --bs-modal-width: 100vw; --bs-modal-margin: 0; }
        #other-strike-modal .other-strike-content { border-radius: 0; }
    }
</style>

<div class="modal fade" id="other-strike-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl other-strike-dialog">
        <div class="modal-content other-strike-content">
            <div class="modal-header">
                <h5 class="modal-title">沖帳單查詢</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 資訊區域 -->
                <div class="info-section">
                    <div class="info-item">
                        <span class="info-label">目前沖銷模式：</span>
                        <span class="info-value" id="other-strike-mode">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">目前沖銷匯率：</span>
                        <span class="info-value" id="other-strike-rate">-</span>
                    </div>
                </div>

                <!-- 導覽列 -->
                <div style="padding: 4px 8px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; margin-bottom: 8px; display: flex; gap: 4px;">
                    <button type="button" class="btn btn-sm btn-outline-danger" id="other-btn-delete" title="刪除">-</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="other-btn-post" title="確認">&#10003;</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="other-btn-cancel" title="取消">&#10007;</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="other-btn-refresh" title="重新整理">&#8635;</button>
                </div>

                <!-- 表格區域 -->
                <div class="grid-section">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th style="width: 140px;">對沖帳編號</th>
                                <th style="width: 100px;">對沖帳日期</th>
                                <th style="width: 120px;">原幣金額</th>
                                <th style="width: 120px;">金額</th>
                                <th style="width: 80px;">幣別</th>
                                <th style="width: 120px;">沖帳原幣金額</th>
                                <th style="width: 120px;">沖帳金額</th>
                            </tr>
                        </thead>
                        <tbody id="other-grid-body"></tbody>
                    </table>
                </div>

                <div class="hint-text">
                    提示：雙擊資料列可自動計算沖帳金額，或直接編輯「沖帳原幣金額」、「沖帳金額」欄位
                </div>
            </div>

            <!-- 底部區域 -->
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="other-btn-ok">確定</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>

<script>
// otherStrike.js - 對沖帳功能
(() => {
    // 確保 ActionRailCustomHandlers 存在
    window.ActionRailCustomHandlers = window.ActionRailCustomHandlers || {};
    window.ActionRailCustomHandlers['PR000004'] = window.ActionRailCustomHandlers['PR000004'] || {};

    // 對沖帳狀態
    const otherState = {
        paperNum: '',
        rows: [],
        selectedIndex: -1
    };

    const withJwtHeaders = (init = {}) => {
        const jwt = localStorage.getItem('jwtId');
        const headers = Object.assign({}, init.headers || {});
        if (jwt) headers['X-JWTID'] = jwt;
        return { ...init, headers };
    };

    const notify = async (type, message) => {
        if (window.Swal) {
            const icon = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
            await window.Swal.fire({ icon, title: message });
            return;
        }
        alert(message);
    };

    const formatDate = (val) => {
        if (!val) return '';
        const d = new Date(val);
        if (isNaN(d.getTime())) return '';
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const formatNumber = (val) => {
        if (val === null || val === undefined || val === '') return '0';
        const n = parseFloat(val);
        return isNaN(n) ? '0' : n.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    const parseNumber = (val) => {
        if (val === null || val === undefined || val === '') return 0;
        const n = parseFloat(val.toString().replace(/,/g, ''));
        return isNaN(n) ? 0 : n;
    };

    // 開啟對沖帳對話框
    const openOtherStrike = async (mainPaperNum) => {
        if (!mainPaperNum) {
            await notify('info', '沒有單號');
            return;
        }

        otherState.paperNum = mainPaperNum;

        try {
            // 載入主檔資料
            const mainResp = await fetch(`/api/StrikeSelect/GetOtherStrikeMainData?paperNum=${encodeURIComponent(mainPaperNum)}`, withJwtHeaders());
            if (!mainResp.ok) {
                await notify('error', '無法取得主檔資料');
                return;
            }
            const mainData = await mainResp.json();
            if (!mainData.ok) {
                await notify('error', mainData.error || '無法取得主檔資料');
                return;
            }

            // 設定顯示值
            const otherStrikeMode = document.getElementById('other-strike-mode');
            const otherStrikeRate = document.getElementById('other-strike-rate');
            if (otherStrikeMode) otherStrikeMode.textContent = mainData.strikeModeName || '-';
            if (otherStrikeRate) otherStrikeRate.textContent = formatNumber(mainData.rateToNTStrike);

            // 載入清單資料
            await loadOtherList();

            // 顯示 Modal
            const otherModal = document.getElementById('other-strike-modal');
            if (otherModal) {
                otherModal.classList.add('show');
                otherModal.style.display = 'block';
                otherModal.style.zIndex = '1060';
                otherModal.removeAttribute('aria-hidden');
                otherModal.setAttribute('aria-modal', 'true');

                // 創建背景遮罩
                let otherBackdrop = document.getElementById('other-modal-backdrop');
                if (!otherBackdrop) {
                    otherBackdrop = document.createElement('div');
                    otherBackdrop.id = 'other-modal-backdrop';
                    otherBackdrop.className = 'modal-backdrop fade show';
                    otherBackdrop.style.zIndex = '1059';
                    document.body.appendChild(otherBackdrop);
                }
            }
        } catch (err) {
            console.error('openOtherStrike error:', err);
            await notify('error', '開啟失敗: ' + err.message);
        }
    };

    // 關閉對沖帳對話框
    const closeOtherStrike = () => {
        const otherModal = document.getElementById('other-strike-modal');
        if (otherModal) {
            otherModal.classList.remove('show');
            otherModal.style.display = 'none';
            otherModal.setAttribute('aria-hidden', 'true');
            otherModal.removeAttribute('aria-modal');
        }
        const otherBackdrop = document.getElementById('other-modal-backdrop');
        if (otherBackdrop) {
            otherBackdrop.remove();
        }
    };

    // 載入對沖帳清單
    const loadOtherList = async () => {
        const resp = await fetch(`/api/StrikeSelect/GetOtherStrikeList?paperNum=${encodeURIComponent(otherState.paperNum)}`, withJwtHeaders());
        if (!resp.ok) {
            await notify('error', '無法取得清單資料');
            return;
        }
        const data = await resp.json();
        if (!data.ok) {
            await notify('error', data.error || '無法取得清單資料');
            return;
        }

        otherState.rows = data.rows || [];
        otherState.selectedIndex = -1;
        renderOtherGrid();
    };

    // 渲染對沖帳表格
    const renderOtherGrid = () => {
        const tbody = document.getElementById('other-grid-body');
        if (!tbody) return;

        if (otherState.rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">沒有可對沖帳的單據</td></tr>';
            return;
        }

        tbody.innerHTML = otherState.rows.map((row, idx) => `
            <tr data-idx="${idx}" class="${idx === otherState.selectedIndex ? 'selected' : ''}">
                <td>${row.SourNum || ''}</td>
                <td>${formatDate(row.PaperDate)}</td>
                <td class="text-end">${formatNumber(row.TotalAmountOg)}</td>
                <td class="text-end">${formatNumber(row.TotalAmount)}</td>
                <td>${row.MoneyName || ''}</td>
                <td class="editable-cell text-end">
                    <input type="text" class="other-strike-amount-og form-control form-control-sm text-end" value="${formatNumber(row.StrikeAmountOg)}" data-idx="${idx}">
                </td>
                <td class="editable-cell text-end">
                    <input type="text" class="other-strike-amount form-control form-control-sm text-end" value="${formatNumber(row.StrikeAmount)}" data-idx="${idx}">
                </td>
                <td class="editable-cell text-end">
                    <input type="text" class="other-ori-amount-og form-control form-control-sm text-end" value="${formatNumber(row.OriAmountOg)}" data-idx="${idx}">
                </td>
            </tr>
        `).join('');

        // 綁定行點擊事件
        tbody.querySelectorAll('tr[data-idx]').forEach(tr => {
            tr.addEventListener('click', (e) => {
                if (e.target.tagName === 'INPUT') return;
                const idx = parseInt(tr.dataset.idx);
                otherState.selectedIndex = idx;
                tbody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
                tr.classList.add('selected');
            });

            tr.addEventListener('dblclick', async (e) => {
                if (e.target.tagName === 'INPUT') return;
                const idx = parseInt(tr.dataset.idx);
                await calculateOtherRow(idx);
            });
        });

        // 綁定輸入框事件
        tbody.querySelectorAll('.other-strike-amount-og, .other-strike-amount, .other-ori-amount-og').forEach(input => {
            input.addEventListener('blur', async (e) => {
                const idx = parseInt(e.target.dataset.idx);
                const newValue = parseNumber(e.target.value);
                const row = otherState.rows[idx];

                if (e.target.classList.contains('other-strike-amount-og')) {
                    row.StrikeAmountOg = newValue;
                } else if (e.target.classList.contains('other-strike-amount')) {
                    row.StrikeAmount = newValue;
                } else if (e.target.classList.contains('other-ori-amount-og')) {
                    row.OriAmountOg = newValue;
                }

                e.target.value = formatNumber(newValue);
                await updateOtherRowAmount(idx);
            });
        });
    };

    // 計算單筆沖帳金額 (雙擊)
    const calculateOtherRow = async (idx) => {
        const row = otherState.rows[idx];
        try {
            const resp = await fetch('/api/StrikeSelect/CalculateOtherStrike', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paperNum: otherState.paperNum,
                    sourNum: row.SourNum
                })
            }));

            const data = await resp.json();
            if (!data.ok) {
                await notify('error', data.error || '計算失敗');
                return;
            }

            otherState.rows[idx].StrikeAmountOg = data.strikeAmountOg;
            otherState.rows[idx].StrikeAmount = data.strikeAmount;
            otherState.rows[idx].OriAmountOg = data.oriAmountOg;

            renderOtherGrid();
        } catch (ex) {
            await notify('error', '計算失敗: ' + ex.message);
        }
    };

    // 更新單筆金額
    const updateOtherRowAmount = async (idx) => {
        const row = otherState.rows[idx];
        try {
            await fetch('/api/StrikeSelect/UpdateOtherStrikeAmount', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paperNum: otherState.paperNum,
                    sourNum: row.SourNum,
                    strikeAmountOg: row.StrikeAmountOg || 0,
                    strikeAmount: row.StrikeAmount || 0,
                    oriAmountOg: row.OriAmountOg || 0
                })
            }));
        } catch (ex) {
            console.error('updateOtherRowAmount error:', ex);
        }
    };

    // 刪除選定 (清除沖帳金額)
    const deleteOtherSelected = async () => {
        if (otherState.selectedIndex < 0) {
            await notify('info', '請先選擇一筆資料');
            return;
        }

        otherState.rows[otherState.selectedIndex].StrikeAmountOg = 0;
        otherState.rows[otherState.selectedIndex].StrikeAmount = 0;
        otherState.rows[otherState.selectedIndex].OriAmountOg = 0;

        await updateOtherRowAmount(otherState.selectedIndex);
        renderOtherGrid();
    };

    // 確定儲存對沖帳
    const confirmOther = async () => {
        try {
            const resp = await fetch('/api/StrikeSelect/ConfirmOtherStrike', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paperNum: otherState.paperNum
                })
            }));

            const data = await resp.json();
            if (!data.ok) {
                await notify('error', data.error || '儲存失敗');
                return;
            }

            if (data.hasOtherStrike) {
                await notify('success', `已處理 ${data.processedCount} 筆對沖帳`);
            } else {
                await notify('info', '沒有選擇對沖帳');
            }

            closeOtherStrike();

            // 重新載入沖帳明細資料 (如果有相關函數)
            if (typeof window.StrikeDetailHandler?.refreshData === 'function') {
                await window.StrikeDetailHandler.refreshData();
            }
        } catch (ex) {
            await notify('error', '儲存失敗: ' + ex.message);
        }
    };

    // 初始化對沖帳事件
    const initOtherEvents = () => {
        const otherModal = document.getElementById('other-strike-modal');
        if (!otherModal) return;

        // 關閉按鈕
        otherModal.querySelectorAll('.btn-close, [data-bs-dismiss="modal"]').forEach(btn => {
            btn.addEventListener('click', closeOtherStrike);
        });

        // 刪除按鈕 (-)
        const otherBtnDelete = document.getElementById('other-btn-delete');
        if (otherBtnDelete) {
            otherBtnDelete.addEventListener('click', deleteOtherSelected);
        }

        // 確認按鈕 (打勾) - 儲存當前編輯
        const otherBtnPost = document.getElementById('other-btn-post');
        if (otherBtnPost) {
            otherBtnPost.addEventListener('click', async () => {
                // 觸發所有輸入框的 blur 事件來儲存
                const inputs = document.querySelectorAll('#other-grid-body input');
                inputs.forEach(input => input.blur());
            });
        }

        // 取消按鈕 (打叉) - 重新載入資料
        const otherBtnCancel = document.getElementById('other-btn-cancel');
        if (otherBtnCancel) {
            otherBtnCancel.addEventListener('click', loadOtherList);
        }

        // 重新整理按鈕
        const otherBtnRefresh = document.getElementById('other-btn-refresh');
        if (otherBtnRefresh) {
            otherBtnRefresh.addEventListener('click', loadOtherList);
        }

        // 確定按鈕 (底部)
        const otherBtnOk = document.getElementById('other-btn-ok');
        if (otherBtnOk) {
            otherBtnOk.addEventListener('click', confirmOther);
        }

        // 拖曳功能
        const headerEl = otherModal.querySelector('.modal-header');
        const dialogEl = otherModal.querySelector('.modal-dialog');
        if (headerEl && dialogEl) {
            let dragging = false;
            let startX = 0, startY = 0, origX = 0, origY = 0;

            headerEl.addEventListener('mousedown', (e) => {
                // 排除按鈕和關閉按���
                if (e.target.closest('button') || e.target.closest('input') || e.target.closest('select')) return;

                dragging = true;
                const rect = dialogEl.getBoundingClientRect();
                startX = e.clientX;
                startY = e.clientY;
                origX = rect.left;
                origY = rect.top;
                dialogEl.style.position = 'fixed';
                dialogEl.style.left = `${origX}px`;
                dialogEl.style.top = `${origY}px`;
                dialogEl.style.transform = 'none';
                dialogEl.style.margin = '0';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!dragging) return;
                dialogEl.style.left = `${origX + e.clientX - startX}px`;
                dialogEl.style.top = `${origY + e.clientY - startY}px`;
            });

            document.addEventListener('mouseup', () => { dragging = false; });
        }
    };

    // 確保對沖帳事件在 DOM 載入後初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initOtherEvents);
    } else {
        initOtherEvents();
    }

    // 匯出到全域函式，供「對沖帳」按鈕調用
    window.OtherStrikeHandler = {
        open: openOtherStrike
    };
})();
</script>

<!-- ========== 折讓搜尋 Modal (對應 Delphi StrikeSelectDebit) ========== -->
<style>
  #debit-search-modal .paper-search-dialog { --bs-modal-width: 1100px; --bs-modal-margin: 0; margin-top: 6vh; }
  #debit-search-modal .paper-search-modal { height: calc(80vh); display: flex; flex-direction: column; }
  #debit-search-modal.modal.show { align-items: flex-start; }
  #debit-search-modal .modal-header { padding: 6px 12px; cursor: move; user-select: none; }
  #debit-search-modal .modal-header :is(button, input, select, textarea, a) { cursor: default; }
  #debit-search-modal .modal-title { font-size: 16px; line-height: 1.2; }
  #debit-search-modal .modal-body { flex: 1 1 auto; display: flex; flex-direction: column; min-height: 0; overflow: hidden; padding: 8px 12px; }
  #debit-search-modal .modal-footer { position: sticky; bottom: 0; background: #fff; z-index: 3; display: flex; align-items: center; gap: 12px; padding: 6px 12px; }

  /* 搜尋條件 */
  #debit-search-modal .paper-search-form {
    display: flex; flex-direction: column; gap: 6px;
    position: relative; padding-right: 100px; margin-bottom: 8px;
  }
  #debit-search-modal .paper-search-form .ps-grid {
    display: grid;
    grid-template-columns: repeat(2, 280px);
    grid-template-rows: repeat(2, minmax(0, auto));
    grid-auto-flow: column;
    gap: 4px 10px;
    justify-content: start; align-items: start;
  }
  #debit-search-modal .paper-search-form .ps-field { display: flex; align-items: center; gap: 6px; min-width: 0; }
  #debit-search-modal .paper-search-form .ps-label {
    white-space: nowrap; margin: 0; flex: 0 0 90px;
    text-align: right; font-size: var(--field-label-size); line-height: 1.2;
  }
  #debit-search-modal .paper-search-form .ps-control {
    flex: 1 1 auto; min-width: 0; font-size: var(--field-value-size);
    height: 24px; padding: 2px 6px; border: 1px solid #ced4da; border-radius: 4px;
  }
  #debit-search-modal .paper-search-form .ps-actions {
    display: flex; justify-content: flex-end; align-items: center;
    position: absolute; top: 0; right: 0; margin: 0;
  }

  /* 多選區域 */
  #debit-search-modal .paper-search-picker {
    flex: 1 1 auto;
    min-height: 0;
    display: flex;
    gap: 4px;
  }
  #debit-search-modal .paper-search-col { display: flex; flex-direction: column; min-width: 0; }
  #debit-search-modal .paper-search-col-left { flex: 6 1 0; }
  #debit-search-modal .paper-search-col-right { flex: 4 1 0; }
  #debit-search-modal .paper-search-title-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 4px; }
  #debit-search-modal .paper-search-title { font-weight: 600; color: #475569; font-size: 13px; }
  #debit-search-modal .paper-search-count { font-size: 12px; color: #64748b; }
  #debit-search-modal .paper-search-scroll { flex: 1 1 0; min-height: 0; overflow: auto; border: 1px solid #e5e7eb; border-radius: 8px; }
  #debit-search-modal .paper-search-transfer { flex: 0 0 56px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: .6rem; }
  #debit-search-modal .paper-search-transfer .btn {
    width: 28px; height: 28px; padding: 0;
    border: 1px solid currentColor; border-radius: 6px;
    display: inline-flex; align-items: center; justify-content: center;
  }
  #debit-search-modal .paper-search-transfer .btn:hover { border-color: currentColor; box-shadow: none; }
  #debit-search-modal .paper-search-transfer .material-symbols-outlined { font-size: 28px; line-height: 1; }

  /* 表格樣式 */
  #debit-search-modal thead th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; }
  #debit-search-modal table { border-collapse: collapse; width: 100%; }
  #debit-search-modal th, #debit-search-modal td { border: 1px solid #dee2e6; vertical-align: middle; }
  #debit-search-modal .paper-search-scroll th,
  #debit-search-modal .paper-search-scroll td {
    white-space: nowrap;
    font-size: var(--field-value-size);
    padding: 2px 6px;
    line-height: 1.15;
  }
  #debit-search-modal .paper-search-scroll thead th {
    position: sticky;
    top: 0;
    background: #f8fafc;
    z-index: 2;
    font-size: var(--field-label-size);
  }
  #debit-search-modal .paper-search-scroll tbody tr { cursor: pointer; }
  #debit-search-modal .paper-search-scroll tbody tr.selected,
  #debit-search-modal .paper-search-scroll tbody tr.selected > td { background: #dbeafe !important; }

  /* 底部統計 */
  #debit-search-modal .ps-summary { display: flex; gap: 20px; font-size: 13px; margin-left: auto; margin-right: 12px; }
  #debit-search-modal .ps-summary-item { display: flex; gap: 6px; }
  #debit-search-modal .ps-summary-label { color: #475569; font-weight: 600; }
  #debit-search-modal .ps-summary-value { color: #1e293b; font-weight: 700; }

  @@media (max-width: 991.98px) {
    #debit-search-modal .paper-search-dialog { --bs-modal-width: 100vw; --bs-modal-margin: 0; }
    #debit-search-modal .paper-search-modal { border-radius: 0; }
  }
</style>

<div class="modal fade" id="debit-search-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl paper-search-dialog">
    <div class="modal-content paper-search-modal">
      <div class="modal-header">
        <h5 class="modal-title">沖帳單查詢</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- 搜尋條件 -->
        <form class="paper-search-form">
          <div class="ps-grid">
            <div class="ps-field">
              <label class="ps-label">折讓立帳日期</label>
              <input type="date" class="ps-control" id="debit-search-paper-date">
            </div>
            <div class="ps-field">
              <label class="ps-label">收付日期</label>
              <input type="date" class="ps-control" id="debit-search-expect-date">
            </div>
            <div class="ps-field">
              <label class="ps-label">折讓立帳單號</label>
              <input type="text" class="ps-control" id="debit-search-paper-num">
            </div>
          </div>
          <div class="ps-actions">
            <button type="button" class="btn btn-primary btn-sm" id="debit-search-btn-find">資料重取</button>
          </div>
        </form>

        <!-- 多選區域 -->
        <div class="paper-search-picker">
          <!-- 左側：可選用之折讓 -->
          <div class="paper-search-col paper-search-col-left">
            <div class="paper-search-title-row">
              <div class="paper-search-title">可選用之折讓</div>
              <div class="paper-search-count" id="debit-search-source-count">0</div>
            </div>
            <div class="paper-search-scroll">
              <table class="table table-sm table-striped mb-0">
                <thead>
                  <tr>
                    <th>來源</th>
                    <th>折讓單號</th>
                    <th>折讓日期</th>
                    <th>立帳日期</th>
                    <th>發票號碼</th>
                    <th>原幣餘額</th>
                    <th>幣別</th>
                    <th>本幣餘額</th>
                    <th>客戶編號</th>
                    <th>客戶簡稱</th>
                    <th>立帳單號</th>
                    <th>付款日期</th>
                  </tr>
                </thead>
                <tbody id="debit-search-source-body"></tbody>
              </table>
            </div>
          </div>

          <!-- 中間按鈕 -->
          <div class="paper-search-transfer">
            <button class="btn btn-outline-primary" type="button" id="debit-search-btn-add" title="加入選定">
              <span class="material-symbols-outlined">keyboard_arrow_right</span>
            </button>
            <button class="btn btn-outline-primary" type="button" id="debit-search-btn-add-all" title="全部加入">
              <span class="material-symbols-outlined">keyboard_double_arrow_right</span>
            </button>
            <button class="btn btn-outline-secondary" type="button" id="debit-search-btn-remove" title="移除選定">
              <span class="material-symbols-outlined">keyboard_arrow_left</span>
            </button>
            <button class="btn btn-outline-secondary" type="button" id="debit-search-btn-remove-all" title="全部移除">
              <span class="material-symbols-outlined">keyboard_double_arrow_left</span>
            </button>
          </div>

          <!-- 右側：選定之折讓 -->
          <div class="paper-search-col paper-search-col-right">
            <div class="paper-search-title-row">
              <div class="paper-search-title">選定之折讓</div>
              <div class="paper-search-count" id="debit-search-target-count">0</div>
            </div>
            <div class="paper-search-scroll">
              <table class="table table-sm table-striped mb-0">
                <thead>
                  <tr>
                    <th>來源</th>
                    <th>折讓單號</th>
                    <th>折讓日期</th>
                    <th>立帳日期</th>
                    <th>發票號碼</th>
                    <th>原幣餘額</th>
                    <th>幣別</th>
                    <th>本幣餘額</th>
                    <th>客戶編號</th>
                    <th>客戶簡稱</th>
                    <th>立帳單號</th>
                    <th>付款日期</th>
                  </tr>
                </thead>
                <tbody id="debit-search-target-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 底部區域 -->
      <div class="modal-footer">
        <div class="ps-summary">
          <div class="ps-summary-item">
            <span class="ps-summary-label">合計原幣金額：</span>
            <span class="ps-summary-value" id="debit-search-total-og">0</span>
          </div>
          <div class="ps-summary-item">
            <span class="ps-summary-label">合計本幣金額：</span>
            <span class="ps-summary-value" id="debit-search-total">0</span>
          </div>
        </div>
        <button type="button" class="btn btn-success" id="debit-search-btn-ok">確定</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<script>
// debit-search.js - 折讓搜尋 (對應 Delphi StrikeSelectDebit)
(() => {
    const DOM_PREFIX = 'debit-search';

    // 狀態管理
    const state = {
        strikePaperNum: '',  // 沖帳單號 (主檔單號)
        sourceRows: [],
        targetRows: [],
        selectedSourceIndices: new Set(),
        selectedTargetIndices: new Set()
    };

    // DOM 元素
    const els = {};
    const elIds = [
        'modal', 'paper-date', 'expect-date', 'paper-num',
        'btn-find', 'source-body', 'target-body',
        'btn-add', 'btn-add-all', 'btn-remove', 'btn-remove-all',
        'total-og', 'total', 'btn-ok',
        'source-count', 'target-count'
    ];

    const withJwtHeaders = (init = {}) => {
        const jwt = localStorage.getItem('jwtId');
        const headers = Object.assign({}, init.headers || {});
        if (jwt) headers['X-JWTID'] = jwt;
        return { ...init, headers };
    };

    const notify = async (type, message) => {
        if (window.Swal) {
            const icon = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
            await window.Swal.fire({ icon, title: message });
            return;
        }
        alert(message);
    };

    const formatDate = (val) => {
        if (!val) return '';
        const d = new Date(val);
        if (isNaN(d.getTime())) return '';
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const formatNumber = (val) => {
        if (val === null || val === undefined || val === '') return '0';
        const n = parseFloat(val);
        return isNaN(n) ? '0' : n.toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    };

    const initElements = () => {
        elIds.forEach(id => {
            els[id] = document.getElementById(`${DOM_PREFIX}-${id}`);
        });
    };

    // Modal 處理
    let modal = null;
    let manualBackdrop = null;

    const forceShowModal = () => {
        if (!els.modal) return;
        els.modal.classList.add('show');
        els.modal.style.display = 'block';
        els.modal.style.zIndex = '1065';
        els.modal.removeAttribute('aria-hidden');
        els.modal.setAttribute('aria-modal', 'true');
        if (!manualBackdrop) {
            manualBackdrop = document.createElement('div');
            manualBackdrop.className = 'modal-backdrop fade show';
            manualBackdrop.style.zIndex = '1064';
            document.body.appendChild(manualBackdrop);
        }
    };

    const forceHideModal = () => {
        if (!els.modal) return;
        els.modal.classList.remove('show');
        els.modal.style.display = 'none';
        els.modal.setAttribute('aria-hidden', 'true');
        els.modal.removeAttribute('aria-modal');
        if (manualBackdrop) {
            manualBackdrop.remove();
            manualBackdrop = null;
        }
    };

    const showModal = () => {
        if (modal) {
            modal.show();
            if (!els.modal.classList.contains('show')) {
                forceShowModal();
            }
            return;
        }
        forceShowModal();
    };

    const hideModal = () => {
        if (modal) {
            modal.hide();
            return;
        }
        forceHideModal();
    };

    // 查詢折讓單
    const doSearch = async () => {
        const condition = {
            strikePaperNum: state.strikePaperNum,
            debitDate: els['paper-date'].value,
            expectDate: els['expect-date'].value,
            debitNum: els['paper-num'].value
        };

        // 清空來源列表，保留目標列表
        state.sourceRows = [];
        state.selectedSourceIndices.clear();
        renderSourceTable();
        updateSummary();

        const resp = await fetch('/api/StrikeSelect/SearchDebit', withJwtHeaders({
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(condition)
        }));

        if (!resp.ok) {
            await notify('error', '查詢失敗');
            return;
        }

        const data = await resp.json();
        if (!data.ok) {
            await notify('error', data.error || '查詢失敗');
            return;
        }

        // 排除已在目標列表中的項目
        const targetPaperNums = new Set(state.targetRows.map(r => r.PaperNum));
        state.sourceRows = (data.rows || []).filter(r => !targetPaperNums.has(r.PaperNum));

        renderSourceTable();
        updateSummary();
    };

    // 渲染表格
    const renderTable = (bodyElement, dataRows, selectedIndices) => {
        if (!bodyElement) return;

        bodyElement.innerHTML = dataRows.map((r, idx) => `
            <tr data-index="${idx}" class="${selectedIndices.has(idx) ? 'selected' : ''}">
                <td>${r.Notes || ''}</td>
                <td>${r.PaperNum || ''}</td>
                <td>${formatDate(r.PaperDate)}</td>
                <td>${formatDate(r.PRDate)}</td>
                <td>${r.InvoiceNum || ''}</td>
                <td style="text-align:right;">${formatNumber(r.TotalAmountOg)}</td>
                <td>${r.MoneyName || ''}</td>
                <td style="text-align:right;">${formatNumber(r.TotalAmount)}</td>
                <td>${r.CompanyId || ''}</td>
                <td>${r.ShortName || ''}</td>
                <td>${r.PRNum || ''}</td>
                <td>${formatDate(r.ExpectDate)}</td>
            </tr>
        `).join('');
    };

    const renderSourceTable = () => {
        renderTable(els['source-body'], state.sourceRows, state.selectedSourceIndices);
        if (els['source-count']) els['source-count'].textContent = state.sourceRows.length;
    };

    const renderTargetTable = () => {
        renderTable(els['target-body'], state.targetRows, state.selectedTargetIndices);
        if (els['target-count']) els['target-count'].textContent = state.targetRows.length;
    };

    // 更新行樣式
    const updateRowStyles = (bodyElement, selectedIndices) => {
        if (!bodyElement) return;
        const rows = bodyElement.querySelectorAll('tr');
        rows.forEach((tr, idx) => {
            if (selectedIndices.has(idx)) {
                tr.classList.add('selected');
            } else {
                tr.classList.remove('selected');
            }
        });
    };

    // 更新合計
    const updateSummary = () => {
        let totalOg = 0;
        let total = 0;
        state.targetRows.forEach(r => {
            totalOg += parseFloat(r.TotalAmountOg) || 0;
            total += parseFloat(r.TotalAmount) || 0;
        });
        els['total-og'].textContent = formatNumber(totalOg);
        els['total'].textContent = formatNumber(total);
        // 根據右側是否有資料來控制確定按鈕的啟用狀態
        if (els['btn-ok']) {
            if (state.targetRows.length > 0) {
                els['btn-ok'].disabled = false;
                els['btn-ok'].classList.remove('disabled');
            } else {
                els['btn-ok'].disabled = true;
                els['btn-ok'].classList.add('disabled');
            }
        }
    };

    // 加入選定
    const addSelected = () => {
        const toAdd = [];
        state.selectedSourceIndices.forEach(idx => {
            const row = state.sourceRows[idx];
            if (row && !state.targetRows.some(t => t.PaperNum === row.PaperNum)) {
                toAdd.push({ ...row });
            }
        });

        state.targetRows.push(...toAdd);

        // 從來源移除已加入的項目
        const remaining = state.sourceRows.filter((_, idx) => !state.selectedSourceIndices.has(idx));
        state.sourceRows = remaining;
        state.selectedSourceIndices.clear();

        renderSourceTable();
        renderTargetTable();
        updateSummary();
    };

    // 全部加入
    const addAll = () => {
        state.sourceRows.forEach(row => {
            if (!state.targetRows.some(t => t.PaperNum === row.PaperNum)) {
                state.targetRows.push({ ...row });
            }
        });
        state.sourceRows = [];
        state.selectedSourceIndices.clear();

        renderSourceTable();
        renderTargetTable();
        updateSummary();
    };

    // 移除選定
    const removeSelected = () => {
        const toRemove = [];
        state.selectedTargetIndices.forEach(idx => {
            const row = state.targetRows[idx];
            if (row) toRemove.push({ ...row });
        });

        const remaining = state.targetRows.filter((_, idx) => !state.selectedTargetIndices.has(idx));
        state.targetRows = remaining;
        state.selectedTargetIndices.clear();

        state.sourceRows.push(...toRemove);

        renderSourceTable();
        renderTargetTable();
        updateSummary();
    };

    // 全部移除
    const removeAll = () => {
        state.sourceRows.push(...state.targetRows);
        state.targetRows = [];
        state.selectedTargetIndices.clear();

        renderSourceTable();
        renderTargetTable();
        updateSummary();
    };

    // 確定按鈕
    const doConfirm = async () => {
        if (state.targetRows.length === 0) {
            await notify('info', '請選擇要加入的折讓單');
            return;
        }

        try {
            const resp = await fetch('/api/StrikeSelect/ConfirmDebit', withJwtHeaders({
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paperNum: state.strikePaperNum,
                    rows: state.targetRows.map(r => ({
                        sourNum: r.PaperNum,
                        notes: r.Notes || ''
                    }))
                })
            }));

            const raw = await resp.text();
            let data;
            try { data = JSON.parse(raw); } catch { data = { ok: false, error: raw }; }

            if (!resp.ok || !data.ok) {
                await Swal.fire({ icon: 'error', title: '匯入失敗', text: data.error || `HTTP ${resp.status}` });
                return;
            }

            // 關閉 modal
            hideModal();

            // 重新載入抵扣款明細
            if (typeof window.reloadDebitData === 'function') {
                await window.reloadDebitData();
            }

        } catch (err) {
            console.error('ConfirmDebit error:', err);
            await Swal.fire({ icon: 'error', title: '執行錯誤', text: err.message });
        }
    };

    // 清除表單
    const clearForm = () => {
        els['paper-date'].value = '';
        els['paper-num'].value = '';
        els['expect-date'].value = '';

        state.sourceRows = [];
        state.targetRows = [];
        state.selectedSourceIndices.clear();
        state.selectedTargetIndices.clear();

        renderSourceTable();
        renderTargetTable();
        updateSummary();
    };

    // 綁定表格事件
    const bindTableEvents = () => {
        if (!els['source-body'] || !els['target-body']) return;

        // 來源表格點擊事件
        els['source-body'].addEventListener('click', (e) => {
            const tr = e.target.closest('tr');
            if (!tr) return;
            const idx = parseInt(tr.dataset.index, 10);
            if (isNaN(idx)) return;

            if (e.ctrlKey || e.metaKey) {
                if (state.selectedSourceIndices.has(idx)) {
                    state.selectedSourceIndices.delete(idx);
                } else {
                    state.selectedSourceIndices.add(idx);
                }
            } else if (e.shiftKey && state.selectedSourceIndices.size > 0) {
                const lastIdx = Math.max(...state.selectedSourceIndices);
                const minIdx = Math.min(idx, lastIdx);
                const maxIdx = Math.max(idx, lastIdx);
                for (let i = minIdx; i <= maxIdx; i++) {
                    state.selectedSourceIndices.add(i);
                }
            } else {
                state.selectedSourceIndices.clear();
                state.selectedSourceIndices.add(idx);
            }

            updateRowStyles(els['source-body'], state.selectedSourceIndices);
        });

        // 目標表格點擊事件
        els['target-body'].addEventListener('click', (e) => {
            const tr = e.target.closest('tr');
            if (!tr) return;
            const idx = parseInt(tr.dataset.index, 10);
            if (isNaN(idx)) return;

            if (e.ctrlKey || e.metaKey) {
                if (state.selectedTargetIndices.has(idx)) {
                    state.selectedTargetIndices.delete(idx);
                } else {
                    state.selectedTargetIndices.add(idx);
                }
            } else if (e.shiftKey && state.selectedTargetIndices.size > 0) {
                const lastIdx = Math.max(...state.selectedTargetIndices);
                const minIdx = Math.min(idx, lastIdx);
                const maxIdx = Math.max(idx, lastIdx);
                for (let i = minIdx; i <= maxIdx; i++) {
                    state.selectedTargetIndices.add(i);
                }
            } else {
                state.selectedTargetIndices.clear();
                state.selectedTargetIndices.add(idx);
            }

            updateRowStyles(els['target-body'], state.selectedTargetIndices);
        });

        // 雙擊快速加入/移除
        els['source-body'].addEventListener('dblclick', (e) => {
            const tr = e.target.closest('tr');
            if (!tr) return;
            const idx = parseInt(tr.dataset.index, 10);
            if (isNaN(idx)) return;
            state.selectedSourceIndices.clear();
            state.selectedSourceIndices.add(idx);
            addSelected();
        });

        els['target-body'].addEventListener('dblclick', (e) => {
            const tr = e.target.closest('tr');
            if (!tr) return;
            const idx = parseInt(tr.dataset.index, 10);
            if (isNaN(idx)) return;
            state.selectedTargetIndices.clear();
            state.selectedTargetIndices.add(idx);
            removeSelected();
        });
    };

    // 事件是否已綁定的標記
    let eventsBound = false;

    // 初始化事件
    const initEvents = () => {
        initElements();

        if (!els.modal) return;
        if (eventsBound) return;
        eventsBound = true;

        // Modal 初始化
        if (window.bootstrap?.Modal) {
            modal = window.bootstrap.Modal.getOrCreateInstance(els.modal, { backdrop: 'static' });
        }

        // 拖曳功能
        const headerEl = els.modal.querySelector('.modal-header');
        const dialogEl = els.modal.querySelector('.modal-dialog');
        if (headerEl && dialogEl) {
            let dragging = false;
            let startX = 0, startY = 0, origX = 0, origY = 0;

            headerEl.addEventListener('mousedown', (e) => {
                if (e.target.closest('button')) return;
                dragging = true;
                const rect = dialogEl.getBoundingClientRect();
                startX = e.clientX;
                startY = e.clientY;
                origX = rect.left;
                origY = rect.top;
                dialogEl.style.position = 'fixed';
                dialogEl.style.left = `${origX}px`;
                dialogEl.style.top = `${origY}px`;
                dialogEl.style.transform = 'none';
                dialogEl.style.margin = '0';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!dragging) return;
                dialogEl.style.left = `${origX + e.clientX - startX}px`;
                dialogEl.style.top = `${origY + e.clientY - startY}px`;
            });

            document.addEventListener('mouseup', () => { dragging = false; });
        }

        // 按鈕事件
        els['btn-find']?.addEventListener('click', doSearch);
        els['btn-add']?.addEventListener('click', addSelected);
        els['btn-add-all']?.addEventListener('click', addAll);
        els['btn-remove']?.addEventListener('click', removeSelected);
        els['btn-remove-all']?.addEventListener('click', removeAll);
        els['btn-ok']?.addEventListener('click', doConfirm);

        // 綁定表格事件
        bindTableEvents();

        // Modal 關閉事件
        els.modal.addEventListener('hidden.bs.modal', () => {
            forceHideModal();
        });
        els.modal.querySelectorAll('[data-bs-dismiss="modal"], .btn-close').forEach((btn) => {
            btn.addEventListener('click', () => {
                if (!modal) forceHideModal();
            });
        });
    };

    // 開啟對話框
    const openDebitSearch = async (strikePaperNum) => {
        if (!els.modal || !eventsBound) {
            initEvents();
        }

        if (!strikePaperNum) {
            await notify('info', '沒有單號');
            return;
        }

        state.strikePaperNum = strikePaperNum;
        clearForm();
        showModal();
    };

    // DOM 載入後初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEvents);
    } else {
        initEvents();
    }

    // 匯出到全域函式
    window.DebitSearchHandler = {
        open: openDebitSearch
    };
})();
</script>

<!-- ==================== 等收/超收處理 Modal (StrikeHandle) ==================== -->
<style>
  #strike-handle-modal .modal-dialog { max-width: 450px; }
  #strike-handle-modal .modal-body { padding: 20px; }
  #strike-handle-modal .handle-info { margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 8px; }
  #strike-handle-modal .handle-info-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
  #strike-handle-modal .handle-info-row:last-child { margin-bottom: 0; }
  #strike-handle-modal .handle-info-label { color: #6c757d; }
  #strike-handle-modal .handle-info-value { font-weight: 600; }
  #strike-handle-modal .handle-info-value.positive { color: #198754; }
  #strike-handle-modal .handle-info-value.negative { color: #dc3545; }
  #strike-handle-modal .handle-options { margin-top: 16px; }
  #strike-handle-modal .handle-option { display: flex; align-items: flex-start; padding: 12px; margin-bottom: 8px; border: 1px solid #dee2e6; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
  #strike-handle-modal .handle-option:hover { background: #f8f9fa; border-color: #adb5bd; }
  #strike-handle-modal .handle-option.selected { background: #e7f1ff; border-color: #0d6efd; }
  #strike-handle-modal .handle-option input[type="radio"] { margin-top: 3px; margin-right: 12px; }
  #strike-handle-modal .handle-option-content { flex: 1; }
  #strike-handle-modal .handle-option-title { font-weight: 600; margin-bottom: 4px; }
  #strike-handle-modal .handle-option-desc { font-size: 13px; color: #6c757d; }
</style>

<div class="modal fade" id="strike-handle-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">沖帳差額處理</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="handle-info">
          <div class="handle-info-row">
            <span class="handle-info-label">沖銷金額合計</span>
            <span class="handle-info-value" id="strike-handle-total-strike">0</span>
          </div>
          <div class="handle-info-row">
            <span class="handle-info-label">實收金額合計</span>
            <span class="handle-info-value" id="strike-handle-total-paid">0</span>
          </div>
          <div class="handle-info-row">
            <span class="handle-info-label">差額</span>
            <span class="handle-info-value" id="strike-handle-difference">0</span>
          </div>
        </div>
        <div class="handle-options">
          <label class="handle-option" data-value="1">
            <input type="radio" name="handle-type" value="1">
            <div class="handle-option-content">
              <div class="handle-option-title">放棄差額</div>
              <div class="handle-option-desc">差額不處理，直接確認沖帳</div>
            </div>
          </label>
          <label class="handle-option" data-value="2">
            <input type="radio" name="handle-type" value="2">
            <div class="handle-option-content">
              <div class="handle-option-title">轉入其他科目</div>
              <div class="handle-option-desc">將差額轉入指定會計科目</div>
            </div>
          </label>
          <label class="handle-option" data-value="3">
            <input type="radio" name="handle-type" value="3">
            <div class="handle-option-content">
              <div class="handle-option-title">等收處理</div>
              <div class="handle-option-desc">保留差額待下次沖帳</div>
            </div>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="strike-handle-btn-ok">確定</button>
      </div>
    </div>
  </div>
</div>

<!-- ==================== 超收科目選定 Modal (StrikeHandle2) ==================== -->
<style>
  #strike-handle2-modal .modal-dialog { max-width: 450px; }
  #strike-handle2-modal .modal-body { padding: 20px; }
  #strike-handle2-modal .form-group { margin-bottom: 16px; }
  #strike-handle2-modal .form-label { font-weight: 600; margin-bottom: 6px; display: block; }
  #strike-handle2-modal .form-select { width: 100%; }
  #strike-handle2-modal .amount-display { padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 16px; }
  #strike-handle2-modal .amount-display-label { color: #6c757d; margin-bottom: 4px; }
  #strike-handle2-modal .amount-display-value { font-size: 20px; font-weight: 700; color: #198754; }
</style>

<div class="modal fade" id="strike-handle2-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">選擇轉入科目</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="amount-display">
          <div class="amount-display-label">轉入金額</div>
          <div class="amount-display-value" id="strike-handle2-amount">0</div>
        </div>
        <div class="form-group">
          <label class="form-label">會計科目</label>
          <select class="form-select" id="strike-handle2-acc-id">
            <option value="">請選擇...</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">子目</label>
          <select class="form-select" id="strike-handle2-sub-acc-id">
            <option value="">請選擇...</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="strike-handle2-btn-ok">確定</button>
      </div>
    </div>
  </div>
</div>

<script>
// ==================== 等收/超收處理 Handler (StrikeHandle) ====================
(function() {
    'use strict';

    let modal = null;
    let modal2 = null;
    let state = {
        paperNum: '',
        difference: 0,
        totalStrike: 0,
        totalPaid: 0,
        selectedType: 0,
        callback: null
    };

    const els = {};

    const initElements = () => {
        els.modal = document.getElementById('strike-handle-modal');
        els.modal2 = document.getElementById('strike-handle2-modal');
        els['total-strike'] = document.getElementById('strike-handle-total-strike');
        els['total-paid'] = document.getElementById('strike-handle-total-paid');
        els['difference'] = document.getElementById('strike-handle-difference');
        els['btn-ok'] = document.getElementById('strike-handle-btn-ok');
        els['acc-id'] = document.getElementById('strike-handle2-acc-id');
        els['sub-acc-id'] = document.getElementById('strike-handle2-sub-acc-id');
        els['amount'] = document.getElementById('strike-handle2-amount');
        els['btn-ok2'] = document.getElementById('strike-handle2-btn-ok');
    };

    const formatNumber = (num) => {
        return new Intl.NumberFormat('zh-TW').format(num || 0);
    };

    const showModal = () => {
        if (!modal && window.bootstrap?.Modal) {
            modal = window.bootstrap.Modal.getOrCreateInstance(els.modal, { backdrop: 'static' });
        }
        modal?.show();
    };

    const hideModal = () => {
        modal?.hide();
    };

    const showModal2 = () => {
        if (!modal2 && window.bootstrap?.Modal) {
            modal2 = window.bootstrap.Modal.getOrCreateInstance(els.modal2, { backdrop: 'static' });
        }
        modal2?.show();
    };

    const hideModal2 = () => {
        modal2?.hide();
    };

    // 載入會計科目選項
    const loadAccountOptions = async () => {
        try {
            const resp = await fetch('/api/StrikeSelect/GetOverpaymentAccountOptions');
            const data = await resp.json();

            if (!data.ok) {
                console.error('載入會計科目失敗:', data.error);
                return;
            }

            els['acc-id'].innerHTML = '<option value="">請選擇...</option>';
            data.accounts.forEach(acc => {
                const opt = document.createElement('option');
                opt.value = acc.value;
                opt.textContent = acc.text;
                els['acc-id'].appendChild(opt);
            });
        } catch (err) {
            console.error('載入會計科目錯誤:', err);
        }
    };

    // 載入子目選項
    const loadSubAccountOptions = async (accId) => {
        els['sub-acc-id'].innerHTML = '<option value="">請選擇...</option>';

        if (!accId) return;

        try {
            const resp = await fetch(`/api/StrikeSelect/GetSubAccountOptions?accId=${encodeURIComponent(accId)}`);
            const data = await resp.json();

            if (!data.ok) {
                console.error('載入子目失敗:', data.error);
                return;
            }

            data.subAccounts.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub.value;
                opt.textContent = sub.text;
                els['sub-acc-id'].appendChild(opt);
            });
        } catch (err) {
            console.error('載入子目錯誤:', err);
        }
    };

    // 執行處理
    const executeHandle = async (handleType, accId = '', subAccId = '') => {
        try {
            const resp = await fetch('/api/StrikeSelect/HandleOverPayment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paperNum: state.paperNum,
                    handleType,
                    amount: Math.abs(state.difference),
                    accId,
                    subAccId
                })
            });

            const data = await resp.json();

            if (!data.ok) {
                await Swal.fire({ icon: 'error', title: '處理失敗', text: data.error });
                return false;
            }

            return true;
        } catch (err) {
            console.error('執行處理錯誤:', err);
            await Swal.fire({ icon: 'error', title: '執行錯誤', text: err.message });
            return false;
        }
    };

    // 初始化事件
    let eventsBound = false;
    const initEvents = () => {
        initElements();

        if (!els.modal) return;
        if (eventsBound) return;
        eventsBound = true;

        // Modal 初始化
        if (window.bootstrap?.Modal) {
            modal = window.bootstrap.Modal.getOrCreateInstance(els.modal, { backdrop: 'static' });
            modal2 = window.bootstrap.Modal.getOrCreateInstance(els.modal2, { backdrop: 'static' });
        }

        // 選項點擊事件
        els.modal.querySelectorAll('.handle-option').forEach(opt => {
            opt.addEventListener('click', () => {
                els.modal.querySelectorAll('.handle-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                opt.querySelector('input[type="radio"]').checked = true;
                state.selectedType = parseInt(opt.dataset.value, 10);
            });
        });

        // 確定按鈕
        els['btn-ok']?.addEventListener('click', async () => {
            if (!state.selectedType) {
                await Swal.fire({ icon: 'warning', title: '請選擇處理方式' });
                return;
            }

            if (state.selectedType === 2) {
                // 轉入其他科目 - 開啟科目選定對話框
                hideModal();
                els['amount'].textContent = formatNumber(Math.abs(state.difference));
                await loadAccountOptions();
                showModal2();
            } else {
                // 放棄差額或等收處理 - 直接執行
                const success = await executeHandle(state.selectedType);
                if (success) {
                    hideModal();
                    if (state.callback) state.callback(true);
                }
            }
        });

        // 科目選擇變更時載入子目
        els['acc-id']?.addEventListener('change', (e) => {
            loadSubAccountOptions(e.target.value);
        });

        // 科目選定確認按鈕
        els['btn-ok2']?.addEventListener('click', async () => {
            const accId = els['acc-id'].value;
            const subAccId = els['sub-acc-id'].value;

            if (!accId) {
                await Swal.fire({ icon: 'warning', title: '請選擇會計科目' });
                return;
            }

            const success = await executeHandle(2, accId, subAccId);
            if (success) {
                hideModal2();
                if (state.callback) state.callback(true);
            }
        });
    };

    // 檢查並開啟對話框
    const checkAndOpen = async (paperNum, callback) => {
        if (!els.modal || !eventsBound) {
            initEvents();
        }

        if (!paperNum) {
            if (callback) callback(true); // 沒有單號，直接繼續
            return;
        }

        state.paperNum = paperNum;
        state.callback = callback;
        state.selectedType = 0;

        // 重設選項狀態
        els.modal.querySelectorAll('.handle-option').forEach(o => {
            o.classList.remove('selected');
            o.querySelector('input[type="radio"]').checked = false;
        });

        try {
            const resp = await fetch('/api/StrikeSelect/CheckOverPayment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paperNum })
            });

            const data = await resp.json();

            if (!data.ok) {
                await Swal.fire({ icon: 'error', title: '檢查失敗', text: data.error });
                return;
            }

            if (!data.needHandle) {
                // 不需要處理差額，直接繼續
                if (callback) callback(true);
                return;
            }

            // 顯示差額資訊
            state.difference = data.difference;
            state.totalStrike = data.totalStrike;
            state.totalPaid = data.totalPaid;

            els['total-strike'].textContent = formatNumber(data.totalStrike);
            els['total-paid'].textContent = formatNumber(data.totalPaid);

            const diffEl = els['difference'];
            diffEl.textContent = formatNumber(data.difference);
            diffEl.classList.remove('positive', 'negative');
            diffEl.classList.add(data.difference > 0 ? 'positive' : 'negative');

            showModal();

        } catch (err) {
            console.error('CheckOverPayment error:', err);
            await Swal.fire({ icon: 'error', title: '執行錯誤', text: err.message });
        }
    };

    // DOM 載入後初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEvents);
    } else {
        initEvents();
    }

    // 匯出到全域函式
    window.StrikeHandleHandler = {
        checkAndOpen: checkAndOpen
    };
})();
</script>
