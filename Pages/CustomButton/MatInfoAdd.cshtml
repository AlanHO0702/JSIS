@model dynamic

<style>
  .matinfo-add-modal .modal-dialog {
    max-width: 640px;
    margin-top: 12px;
  }
  .matinfo-add-modal .modal-content {
    overflow: visible;
  }
  .matinfo-add-modal .modal-body {
    overflow: hidden;
  }
  .matinfo-add-container {
    max-width: 600px;
    margin: 0 auto;
    width: 100%;
  }
  .matinfo-add-header {
    font-weight: 700;
    color: #1d3b6b;
  }
  .matinfo-add-top {
    display: grid;
    grid-template-columns: 1fr 180px;
    gap: 6px;
    align-items: start;
  }
  .matinfo-add-fields {
    display: grid;
    gap: 6px;
    max-width: 100%;
    margin: 0;
    margin-left: 36px;
    width: 100%;
  }
  .matinfo-add-grid {
    border: 1px solid #d8e0ee;
    border-radius: 6px;
    overflow-x: hidden;
    overflow-y: auto;
    margin-top: 12px;
    height: 200px;
    max-width: 100%;
    margin-left: 0;
    margin-right: 0;
  }
  .matinfo-add-row {
    display: grid;
    grid-template-columns: 80px 280px;
    gap: 6px;
    align-items: center;
  }
  .matinfo-add-row label {
    min-width: 80px;
  }
  .matinfo-add-row label {
    text-align: right;
    color: #1d3b6b;
    font-size: 0.82rem;
  }
  .matinfo-add-row input,
  .matinfo-add-row select {
    height: 24px;
    padding: 1px 6px;
    border: 1px solid #cfd7e6;
    border-radius: 4px;
    font-size: 0.82rem;
    width: 100%;
  }
  .matinfo-add-row input.field-sm,
  .matinfo-add-row select.field-sm {
    width: 120px;
  }
  .matinfo-add-row input.field-md,
  .matinfo-add-row select.field-md {
    width: 160px;
  }
  #matinfo-add-encode {
    width: 290px;
  }
  .matinfo-add-row-group {
    display: grid;
    grid-template-columns: 120px 160px;
    gap: 6px;
    align-items: center;
    width: 100%;
  }
  .field-sm { width: 120px; }
  .field-md { width: 160px; }
  .field-lg { width: 100%; }
  .matinfo-add-actions {
    display: grid;
    gap: 8px;
    min-width: 180px;
  }
  .matinfo-add-actions .toolbar-btn {
    width: 100%;
    justify-content: center;
    font-size: 0.86rem;
    padding: 6px 8px;
    white-space: normal;
    line-height: 1.2;
  }
  .matinfo-add-grid table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82rem;
    min-width: 0;
    table-layout: fixed;
  }
  .matinfo-add-grid th,
  .matinfo-add-grid td {
  .matinfo-add-grid th:nth-child(5),
  .matinfo-add-grid th:nth-child(6),
  .matinfo-add-grid th:nth-child(7),
  .matinfo-add-grid td:nth-child(5),
  .matinfo-add-grid td:nth-child(6),
  .matinfo-add-grid td:nth-child(7) {
    text-align: center;
  }
  .matinfo-add-grid td:nth-child(5) input[type="checkbox"],
  .matinfo-add-grid td:nth-child(6) input[type="checkbox"],
  .matinfo-add-grid td:nth-child(7) input[type="checkbox"] {
    margin: 0 auto;
    display: block;
  }
    padding: 2px 3px;
    border-bottom: 1px solid #eef2f8;
    white-space: nowrap;
    vertical-align: middle;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .matinfo-add-grid th:nth-child(1),
  .matinfo-add-grid td:nth-child(1) {
    width: 100px;
  }
  .matinfo-add-grid th:nth-child(2),
  .matinfo-add-grid td:nth-child(2) {
    width: 100px;
  }
  .matinfo-add-grid th:nth-child(3),
  .matinfo-add-grid td:nth-child(3) {
    width: 60px;
  }
  .matinfo-add-grid th:nth-child(4),
  .matinfo-add-grid td:nth-child(4) {
    width: 110px;
  }
  .matinfo-add-grid th:nth-child(5),
  .matinfo-add-grid td:nth-child(5) {
    width: 70px;
  }
  .matinfo-add-grid th:nth-child(6),
  .matinfo-add-grid td:nth-child(6) {
    width: 70px;
  }
  .matinfo-add-grid th:nth-child(7),
  .matinfo-add-grid td:nth-child(7) {
    width: 90px;
  }
  .matinfo-add-grid thead th:nth-child(5),
  .matinfo-add-grid thead th:nth-child(6),
  .matinfo-add-grid thead th:nth-child(7) {
    white-space: normal;
    line-height: 1.1;
    font-size: 0.76rem;
  }
  .matinfo-add-grid td:nth-child(1) select {
    min-width: 0;
  }
  .matinfo-add-grid thead th {
    background: #f7f9ff;
    color: #1d3b6b;
    font-weight: 600;
  }
  .matinfo-add-grid input[type="checkbox"] {
    transform: scale(1.05);
  }
  .matinfo-add-grid select {
    width: 100%;
    max-width: 100%;
    min-width: 0;
    height: 24px;
    padding: 1px 4px;
    border: 1px solid #cfd7e6;
    border-radius: 4px;
    font-size: 0.8rem;
  }
  .matinfo-add-bottom {
    display: grid;
    gap: 6px;
    margin-top: 6px;
    max-width: 100%;
    margin-left: 0;
    margin-right: 0;
  }
  .matinfo-add-drag {
    cursor: move;
  }
  .matinfo-add-bottom-right {
    display: grid;
    grid-template-columns: 120px 200px;
    column-gap: 6px;
    align-items: start;
    max-width: 100%;
    margin-left: 0;
    margin-right: 0;
    justify-content: start;
  }
  .matinfo-add-gen-btn-wrap {
    grid-column: 1;
    align-self: start;
    margin-left: 12px;
  }
  .matinfo-add-gen {
    display: grid;
    grid-template-columns: 200px auto;
    align-items: center;
    gap: 6px;
  }
  .matinfo-add-gen-row {
    grid-column: 2;
    display: grid;
    grid-template-columns: 80px 200px;
    gap: 6px;
    align-items: center;
  }
  .matinfo-add-gen-row label {
    text-align: right;
    color: #1d3b6b;
    font-size: 0.82rem;
  }
  .matinfo-add-row-span {
    grid-column: 2;
  }
  .matinfo-add-row.matinfo-add-row-span {
    grid-template-columns: 80px 200px;
  }
  .matinfo-add-bottom-right .matinfo-add-row input.field-md,
  .matinfo-add-bottom-right .matinfo-add-row select.field-md,
  .matinfo-add-bottom-right .matinfo-add-gen input.field-md {
    width: 200px;
  }
  .matinfo-add-bottom-right .toolbar-btn {
    border: 1px solid #cfd7e6;
    justify-content: flex-start;
    padding-left: 8px;
  }
  .matinfo-add-bottom-right .toolbar-btn .bi {
    margin-right: 4px;
  }
  .matinfo-add-note {
    font-size: 0.78rem;
    color: #6b7280;
    margin-left: 0;
    white-space: nowrap;
  }
  .matinfo-add-footer {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  .matinfo-add-footer .toolbar-btn {
    padding: 6px 14px;
  }
</style>

<div class="modal fade matinfo-add-modal" id="matinfo-add-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header matinfo-add-drag">
        <h5 class="modal-title matinfo-add-header">新增</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="matinfo-add-container">
          <div class="matinfo-add-top">
            <div class="matinfo-add-fields">
              <div class="matinfo-add-row">
                <label for="matinfo-add-setclass">分類</label>
                <div class="matinfo-add-row-group">
                <select id="matinfo-add-setclass" class="field-sm"></select>
                <input id="matinfo-add-classname" class="field-md" readonly>
                </div>
              </div>
              <div class="matinfo-add-row">
                <label for="matinfo-add-encode">編碼方式</label>
              <input id="matinfo-add-encode" class="field-md" readonly>
              </div>
              <div class="matinfo-add-row">
                <label for="matinfo-add-refpn">參考料號</label>
                <div class="matinfo-add-row-group">
                  <select id="matinfo-add-refpn" class="field-sm"></select>
                  <input id="matinfo-add-refpn-name" class="field-md" readonly>
                </div>
              </div>
            </div>
            <div class="matinfo-add-actions">
              <button type="button" class="btn toolbar-btn" id="matinfo-add-inq">查詢屬性已編出料號</button>
              <button type="button" class="btn toolbar-btn" id="matinfo-add-import">帶入參考料號的屬性值</button>
            </div>
          </div>

          <div class="matinfo-add-grid">
            <table>
              <thead>
                <tr>
                <th style="width: 100px;">選擇資料</th>
                <th style="width: 100px;">名稱</th>
                <th style="width: 70px;">屬性</th>
                <th style="width: 110px;">屬性名稱</th>
                <th style="width: 70px;">手動給值</th>
                <th style="width: 70px;">需要有值</th>
                <th style="width: 90px;">顯示品名</th>
                </tr>
              </thead>
              <tbody id="matinfo-add-grid-body">
                <tr>
                  <td colspan="7">請先選擇分類</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="matinfo-add-bottom matinfo-add-bottom-right">
          <div class="matinfo-add-gen-btn-wrap">
            <button type="button" class="btn toolbar-btn" id="matinfo-add-gennum-btn">
              <i class="bi bi-printer"></i>產生料號
            </button>
          </div>
          <div class="matinfo-add-gen-row">
            <label for="matinfo-add-gennum">料號</label>
            <div class="matinfo-add-gen">
              <input id="matinfo-add-gennum" class="field-md">
              <span class="matinfo-add-note">（請在產生料號後才輸入品名）</span>
            </div>
          </div>
            <div class="matinfo-add-row matinfo-add-row-span">
              <label for="matinfo-add-matname">品名</label>
              <input id="matinfo-add-matname" class="field-md">
            </div>
            <div class="matinfo-add-row matinfo-add-row-span">
              <label for="matinfo-add-unit">計量單位</label>
              <select id="matinfo-add-unit" class="field-md"></select>
            </div>
            <div class="matinfo-add-row matinfo-add-row-span">
              <label for="matinfo-add-pncount">料號數</label>
              <input id="matinfo-add-pncount" class="field-md" value="1">
            </div>
            <div class="matinfo-add-row matinfo-add-row-span">
              <label for="matinfo-add-mergepn">併版料號</label>
              <input id="matinfo-add-mergepn" class="field-md">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer matinfo-add-footer">
        <button type="button" class="btn toolbar-btn success" id="matinfo-add-ok">確定</button>
        <button type="button" class="btn toolbar-btn danger" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  window.MatInfoAddHandler = window.MatInfoAddHandler || {};

  const modalEl = document.getElementById("matinfo-add-modal");
  if (!modalEl) return;
  const modal = window.bootstrap?.Modal ? window.bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: "static" }) : null;
  let manualBackdrop = null;
  const dialogEl = modalEl.querySelector(".modal-dialog");
  const headerEl = modalEl.querySelector(".modal-header");

  const forceShowModal = () => {
    if (!modalEl) return;
    modalEl.classList.add("show");
    modalEl.style.display = "block";
    modalEl.style.zIndex = "1055";
    modalEl.removeAttribute("aria-hidden");
    modalEl.setAttribute("aria-modal", "true");
    if (!manualBackdrop) {
      manualBackdrop = document.createElement("div");
      manualBackdrop.className = "modal-backdrop fade show";
      document.body.appendChild(manualBackdrop);
    }
    if (dialogEl) {
      dialogEl.style.position = "fixed";
      dialogEl.style.left = "50%";
      dialogEl.style.top = "70px";
      dialogEl.style.transform = "translateX(-50%)";
      dialogEl.style.margin = "0";
    }
  };

  const forceHideModal = () => {
    if (!modalEl) return;
    modalEl.classList.remove("show");
    modalEl.style.display = "none";
    modalEl.setAttribute("aria-hidden", "true");
    modalEl.removeAttribute("aria-modal");
    if (manualBackdrop) {
      manualBackdrop.remove();
      manualBackdrop = null;
    }
  };

  const showModal = () => {
    if (modal) {
      modal.show();
      if (!modalEl.classList.contains("show")) {
        forceShowModal();
      }
      return;
    }
    forceShowModal();
  };

  const hideModal = () => {
    if (modal) {
      modal.hide();
      return;
    }
    forceHideModal();
  };

  const elSetClass = document.getElementById("matinfo-add-setclass");
  const elEncode = document.getElementById("matinfo-add-encode");
  const elClassName = document.getElementById("matinfo-add-classname");
  const elRefPn = document.getElementById("matinfo-add-refpn");
  const elRefPnName = document.getElementById("matinfo-add-refpn-name");
  const elGridBody = document.getElementById("matinfo-add-grid-body");
  const elGenNum = document.getElementById("matinfo-add-gennum");
  const elMatName = document.getElementById("matinfo-add-matname");
  const elUnit = document.getElementById("matinfo-add-unit");
  const elPnCount = document.getElementById("matinfo-add-pncount");
  const elMergePn = document.getElementById("matinfo-add-mergepn");
  const btnGenNum = document.getElementById("matinfo-add-gennum-btn");
  const btnImport = document.getElementById("matinfo-add-import");
  const btnInq = document.getElementById("matinfo-add-inq");
  const btnOk = document.getElementById("matinfo-add-ok");

  const state = {
    spid: null,
    rows: [],
    powerType: 2,
    status: 1,
    mb: 0,
    setClass: "",
    enCode: "",
    units: [],
    dtlCache: {},
    clearDefaults: false,
    isTmpPN2Real: 0,
    currOldPN: ""
  };

  const notify = async (type, message) => {
    if (window.Swal) {
      const icon = type === "error" ? "error" : (type === "success" ? "success" : "info");
      await window.Swal.fire({ icon, title: message });
      return;
    }
    alert(message);
  };

  const withJwtHeaders = (init = {}) => {
    const jwt = localStorage.getItem("jwtId");
    const headers = Object.assign({}, init.headers || {});
    if (jwt) headers["X-JWTID"] = jwt;
    return { ...init, headers };
  };

  const getUserId = () => {
    return (localStorage.getItem("erpLoginUserId") || window._userId || "Admin").toString().trim();
  };

  const getPowerMeta = (itemId) => {
    const id = (itemId || "").toUpperCase();
    if (id === "MG000008" || id === "CPN00006") return { powerType: 2, status: 1, mb: 0 };
    if (id === "MG000002" || id === "CPN00007") return { powerType: 4, status: 1, mb: 1 };
    return { powerType: 2, status: 1, mb: 0 };
  };

  const clearForm = () => {
    elSetClass.innerHTML = "";
    elEncode.value = "";
    if (elClassName) elClassName.value = "";
    elRefPn.innerHTML = "";
    if (elRefPnName) elRefPnName.value = "";
    elGridBody.innerHTML = "<tr><td colspan=\"7\">請先選擇分類</td></tr>";
    elGenNum.value = "";
    elMatName.value = "";
    elUnit.innerHTML = "";
    elPnCount.value = "1";
    elMergePn.value = "";
    state.spid = null;
    state.rows = [];
    state.setClass = "";
    state.enCode = "";
    state.units = [];
    state.dtlCache = {};
    state.isTmpPN2Real = 0;
    state.currOldPN = "";
  };

  const buildMatName = () => {
    return state.rows
      .filter(r => (r.iShowName ?? r.ISHOWNAME ?? r.iShowName) == 1)
      .map(r => r.DtlNumName || r.dtlNumName || "")
      .filter(Boolean)
      .join(" ");
  };

  const getMissingRequired = () => {
    return state.rows.filter((row, idx) => {
      const isMust = (row.IsMust ?? row.ismust ?? 0) == 1;
      let dtlNumId = (row.DtlNumId ?? row.dtlNumId ?? "").toString().trim();
      if (!dtlNumId) {
        const select = elGridBody.querySelector(`select.matinfo-add-dtl[data-idx="${idx}"]`);
        if (select instanceof HTMLSelectElement) {
          dtlNumId = select.value.trim();
          if (dtlNumId) row.DtlNumId = dtlNumId;
        }
      }
      return isMust && !dtlNumId;
    });
  };

  const updateGrid = () => {
    if (!state.rows.length) {
      elGridBody.innerHTML = "<tr><td colspan=\"7\">沒有屬性資料</td></tr>";
      return;
    }
    elGridBody.innerHTML = state.rows.map((row, idx) => {
      const isHand = (row.IsHand ?? row.ishand ?? 0) == 1;
      const isMust = (row.IsMust ?? row.ismust ?? 0) == 1;
      const showName = (row.iShowName ?? row.ishowname ?? 0) == 1;
      const dtlNumId = row.DtlNumId ?? row.dtlNumId ?? "";
      const dtlNumName = row.DtlNumName ?? row.dtlNumName ?? "";
      const numId = row.NumId ?? row.numId ?? "";
      const numName = row.NumName ?? row.numName ?? "";
      const cacheKey = `${state.setClass}|${numId}`;
      const options = state.dtlCache[cacheKey] || [];
      const selectOptions = options.length
        ? options.map((opt) => {
            const value = opt.DtlNumId ?? opt.dtlNumId ?? "";
            const label = opt.DtlNumName ?? opt.dtlNumName ?? value;
            const selected = value === dtlNumId ? "selected" : "";
            return `<option value=\"${value}\" ${selected}>${value} ${label}</option>`;
          }).join("")
        : (dtlNumId ? `<option value=\"${dtlNumId}\">${dtlNumId}</option>` : "");
      return `
        <tr>
          <td>
            <select class="matinfo-add-dtl" data-idx="${idx}" data-numid="${numId}">
              <option value=""></option>
              ${selectOptions}
            </select>
          </td>
          <td>${dtlNumName}</td>
          <td>${numId}</td>
          <td>${numName}</td>
          <td><input type=\"checkbox\" ${isHand ? "checked" : ""} disabled></td>
          <td><input type=\"checkbox\" ${isMust ? "checked" : ""} disabled></td>
          <td><input type=\"checkbox\" data-idx=\"${idx}\" class=\"matinfo-add-showname\" ${showName ? "checked" : ""}></td>
        </tr>
      `;
    }).join("");
  };

  const readResultValue = (payload) => {
    if (!payload) return "";
    if (payload.result) return payload.result;
    if (Array.isArray(payload) && payload.length) {
      return payload[0].Result ?? payload[0].result ?? "";
    }
    if (payload.rows && payload.rows.length) {
      return payload.rows[0].Result ?? payload.rows[0].result ?? "";
    }
    return "";
  };

  const loadMatClass = async () => {
    elSetClass.innerHTML = "";
    const resp = await fetch(`/api/MatInfoAdd/MatClass?isForEMO=${state.status}&mb=${state.mb}`, withJwtHeaders());
    if (!resp.ok) {
      await notify("error", await resp.text());
      return;
    }
    const rows = await resp.json();
    const list = Array.isArray(rows) ? rows : [];
    elSetClass.innerHTML = "<option value=\"\"></option>" + list.map((row) => {
      const value = row.MatClass ?? row.matClass ?? "";
      const name = row.ClassName ?? row.className ?? "";
      const unit = row.DefaultUnit ?? row.defaultUnit ?? "";
      return `<option value=\"${value}\" data-unit=\"${unit}\" data-name=\"${name}\">${value}</option>`;
    }).join("");
  };

  const loadReferencePn = async (setClass) => {
    elRefPn.innerHTML = "";
    const resp = await fetch(`/api/MatInfoAdd/ReferencePN?matClass=${encodeURIComponent(setClass || "")}`, withJwtHeaders());
    if (!resp.ok) {
      await notify("error", await resp.text());
      return;
    }
    const rows = await resp.json();
    const list = Array.isArray(rows) ? rows : [];
    elRefPn.innerHTML = "<option value=\"\"></option>" + list.map((row) => {
      const partNum = row.PartNum ?? row.partNum ?? "";
      const matName = row.MatName ?? row.matName ?? "";
      return `<option value=\"${partNum}\" data-name=\"${matName}\">${partNum}</option>`;
    }).join("");
  };

  const loadUnits = async () => {
    const resp = await fetch("/api/MatInfoAdd/Units", withJwtHeaders());
    if (!resp.ok) {
      await notify("error", await resp.text());
      return;
    }
    const rows = await resp.json();
    state.units = Array.isArray(rows) ? rows : [];
  };

  const setUnitOptions = (defaultUnit) => {
    if (!state.units.length) {
      elUnit.innerHTML = defaultUnit ? `<option value=\"${defaultUnit}\">${defaultUnit}</option>` : "<option value=\"\"></option>";
      return;
    }
    const options = state.units.map((row) => {
      const value = row.Unit ?? row.unit ?? "";
      const name = row.Notes ?? row.notes ?? "";
      const selected = defaultUnit && value === defaultUnit ? "selected" : "";
      return `<option value=\"${value}\" ${selected}>${value} ${name}</option>`;
    });
    if (defaultUnit && !state.units.some((u) => (u.Unit ?? u.unit) === defaultUnit)) {
      options.unshift(`<option value=\"${defaultUnit}\" selected>${defaultUnit}</option>`);
    }
    elUnit.innerHTML = options.join("");
  };

  const loadDtlOptions = async (setClass, numId) => {
    const cacheKey = `${setClass}|${numId}`;
    if (state.dtlCache[cacheKey]) return state.dtlCache[cacheKey];
    const resp = await fetch(`/api/MatInfoAdd/DtlNumOptions?setClass=${encodeURIComponent(setClass)}&numId=${encodeURIComponent(numId)}`, withJwtHeaders());
    if (!resp.ok) {
      await notify("error", await resp.text());
      return [];
    }
    const rows = await resp.json();
    const list = Array.isArray(rows) ? rows : [];
    state.dtlCache[cacheKey] = list;
    return list;
  };

  const prefetchDtlOptions = async () => {
    const keys = new Set();
    state.rows.forEach((row) => {
      const numId = row.NumId ?? row.numId ?? "";
      if (numId) keys.add(numId);
    });
    for (const numId of keys) {
      await loadDtlOptions(state.setClass, numId);
    }
  };

  const fillSelectOptions = (selectEl, options, currentValue) => {
    if (!selectEl) return;
    const html = options.map((opt) => {
      const value = opt.DtlNumId ?? opt.dtlNumId ?? "";
      const label = opt.DtlNumName ?? opt.dtlNumName ?? value;
      const selected = value === currentValue ? "selected" : "";
      return `<option value=\"${value}\" ${selected}>${value} ${label}</option>`;
    }).join("");
    selectEl.innerHTML = `<option value=""></option>` + (html || (currentValue ? `<option value=\"${currentValue}\">${currentValue}</option>` : ""));
  };

  const updateAddData = async (row) => {
    if (!state.spid) return;
    const resp = await fetch("/api/MatInfoAdd/UpdateAddData", withJwtHeaders({
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        Spid: state.spid,
        SetClass: state.setClass,
        NumId: row.NumId ?? row.numId ?? "",
        DtlNumId: row.DtlNumId ?? row.dtlNumId ?? ""
      })
    }));
    if (!resp.ok) {
      await notify("error", await resp.text());
      return false;
    }
    const payload = await resp.json();
    row.DtlNumName = payload.DtlNumName ?? row.DtlNumName;
    row.EnCode = payload.EnCode ?? row.EnCode;
    return true;
  };

  const loadAddData = async (setClass, currOldPn, spid, clearDefaults) => {
    if (!setClass) return;
    const qs = new URLSearchParams();
    qs.set("setClass", setClass);
    if (currOldPn) qs.set("currOldPN", currOldPn);
    if (spid) qs.set("spid", spid.toString());
    const resp = await fetch(`/api/MatInfoAdd/AddData?${qs.toString()}`, withJwtHeaders());
    if (!resp.ok) {
      await notify("error", await resp.text());
      return;
    }
    const payload = await resp.json();
    state.spid = payload.spid ?? state.spid;
    state.rows = Array.isArray(payload.rows) ? payload.rows : [];
    state.enCode = payload.enCode ?? "";
    elEncode.value = state.enCode;
    if (clearDefaults) {
      state.rows.forEach((row) => {
        row.DtlNumId = "";
        row.DtlNumName = "";
      });
    }
    await prefetchDtlOptions();
    updateGrid();
  };

  const applySetClass = async (setClass, clearDefaults) => {
    if (!setClass) return;
    elSetClass.value = setClass;
    state.setClass = setClass;
    const opt = elSetClass.selectedOptions[0];
    const defaultUnit = opt ? (opt.getAttribute("data-unit") || "") : "";
    const className = opt ? (opt.getAttribute("data-name") || "") : "";
    if (elClassName) elClassName.value = className;
    setUnitOptions(defaultUnit);
    await loadAddData(setClass, state.currOldPN, null, clearDefaults);
    await loadReferencePn(setClass);
  };

  const refreshAddData = async () => {
    if (!state.setClass || !state.spid) return;
    await loadAddData(state.setClass, "", state.spid, false);
  };

  elSetClass.addEventListener("change", async () => {
    const setClass = elSetClass.value.trim();
    await applySetClass(setClass, true);
  });

  elRefPn.addEventListener("change", () => {
    const opt = elRefPn.selectedOptions[0];
    const name = opt ? (opt.getAttribute("data-name") || "") : "";
    if (elRefPnName) elRefPnName.value = name;
  });

  elGridBody.addEventListener("change", async (e) => {
    const target = e.target;
    if (target instanceof HTMLInputElement && target.classList.contains("matinfo-add-showname")) {
      const idx = Number(target.dataset.idx || "-1");
      if (idx < 0 || idx >= state.rows.length) return;
      state.rows[idx].iShowName = target.checked ? 1 : 0;
      return;
    }
    if (target instanceof HTMLSelectElement && target.classList.contains("matinfo-add-dtl")) {
      const idx = Number(target.dataset.idx || "-1");
      if (idx < 0 || idx >= state.rows.length) return;
      state.rows[idx].DtlNumId = target.value;
      await updateAddData(state.rows[idx]);
      updateGrid();
    }
  });

  elGridBody.addEventListener("focusin", async (e) => {
    const target = e.target;
    if (!(target instanceof HTMLSelectElement)) return;
    if (!target.classList.contains("matinfo-add-dtl")) return;
    const idx = Number(target.dataset.idx || "-1");
    if (idx < 0 || idx >= state.rows.length) return;
    const row = state.rows[idx];
    const numId = row.NumId ?? row.numId ?? "";
    if (!numId || !state.setClass) return;
    const options = await loadDtlOptions(state.setClass, numId);
    fillSelectOptions(target, options, row.DtlNumId ?? row.dtlNumId ?? "");
  });

  btnGenNum?.addEventListener("click", async () => {
    if (!state.setClass) {
      await notify("error", "請先輸入分類");
      return;
    }
    if (!state.spid) {
      await notify("error", "請先選擇分類");
      return;
    }
    const missing = getMissingRequired();
    if (missing.length) {
      const names = missing.map((row) => row.NumName ?? row.numName ?? row.NumId ?? row.numId ?? "").filter(Boolean).join("、");
      await notify("error", names ? `請先輸入需要有值的資料：${names}` : "請先輸入需要有值的資料");
      return;
    }
    const resp = await fetch("/api/MatInfoAdd/GenNum", withJwtHeaders({
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ Spid: state.spid, SetClass: state.setClass, Status: state.status })
    }));
    if (!resp.ok) {
      await notify("error", await resp.text());
      return;
    }
    const payload = await resp.json();
    const result = readResultValue(payload);
    if (result) elGenNum.value = result;
    else {
      await notify("error", "未產生料號，請確認分類與編碼方式設定");
    }
    if (!elMatName.value) elMatName.value = buildMatName();
  });

  btnImport?.addEventListener("click", async () => {
    if (!state.setClass) {
      await notify("error", "請先輸入分類");
      return;
    }
    const refPn = elRefPn.value.trim();
    if (!refPn) {
      await notify("error", "請先輸入參考料號");
      return;
    }
    if (!state.spid) {
      await notify("error", "請先選擇分類");
      return;
    }
    const resp = await fetch("/api/MatInfoAdd/ImportProp", withJwtHeaders({
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ SetClass: state.setClass, ReferencePN: refPn, Spid: state.spid })
    }));
    if (!resp.ok) {
      await notify("error", await resp.text());
      return;
    }
    await refreshAddData();
    await notify("success", "帶入完成");
  });

  btnInq?.addEventListener("click", async () => {
    if (!state.spid) {
      await notify("error", "請先選擇分類");
      return;
    }
    const userId = getUserId();
    const globalId = `${userId}${Date.now()}`;
    const resp = await fetch("/api/MatInfoAdd/DoCall", withJwtHeaders({
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ GlobalId: globalId, Spid: state.spid, PowerType: state.powerType })
    }));
    if (!resp.ok) {
      await notify("error", await resp.text());
      return;
    }
    await notify("success", "已送出查詢");
  });

  const submitAdd = async (partNum, userId, globalId) => {
    const payload = {
      PartNum: partNum,
      SetClass: state.setClass,
      MatName: elMatName.value.trim(),
      MB: state.mb,
      Status: state.status,
      UserId: userId,
      ReferencePN: elRefPn.value.trim(),
      Spid: state.spid,
      Unit: elUnit.value.trim(),
      IsTmpPN2Real: state.isTmpPN2Real,
      MergePartNum: elMergePn.value.trim(),
      CurrOldPN: state.currOldPN,
      GlobalId4Add: globalId,
      AccountType: "",
      PartNumAddForJH: "0",
      JH_B: 0,
      JH_C: 0,
      MultiBuToJH_B: "",
      MultiBuToJH_C: ""
    };
    const resp = await fetch("/api/MatInfoAdd/Add", withJwtHeaders({
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }));
    if (!resp.ok) {
      await notify("error", await resp.text());
      return false;
    }
    return true;
  };

  const checkAdd = async (partNum) => {
    const resp = await fetch("/api/MatInfoAdd/CheckAdd", withJwtHeaders({
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ PartNum: partNum, MatClass: state.setClass })
    }));
    if (!resp.ok) {
      await notify("error", await resp.text());
      return null;
    }
    const data = await resp.json();
    const result = data.Result ?? data.result ?? data?.rows?.[0]?.Result ?? 0;
    return Number(result);
  };

  btnOk?.addEventListener("click", async () => {
    const partNum = elGenNum.value.trim();
    if (!state.setClass) {
      await notify("error", "分類不得為空值");
      return;
    }
    if (!partNum) {
      await notify("error", "料號不得為空值");
      return;
    }
    if (!elUnit.value.trim()) {
      await notify("error", "計量單位不得為空值");
      return;
    }
    if (!elMatName.value.trim()) {
      await notify("error", "請先輸入品名");
      return;
    }
    const userId = getUserId();
    const globalId = `${userId}${Date.now()}`;

    const repeat = Math.max(1, Number(elPnCount.value || "1"));
    const needLoop = repeat > 1 && state.enCode.includes("~");
    if (!needLoop) {
      const chk = await checkAdd(partNum);
      if (chk === 2) {
        await notify("error", "已有此臨時料號，請以轉正式作業進行");
        return;
      }
      if (chk && chk !== 0) {
        await notify("error", "料號已存在，請重新編碼");
        return;
      }
      if (!await submitAdd(partNum, userId, globalId)) return;
    } else {
      for (let i = 0; i < repeat; i += 1) {
        let nextPartNum = partNum;
        if (i > 0) {
          const resp = await fetch("/api/MatInfoAdd/GenNum", withJwtHeaders({
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ Spid: state.spid, SetClass: state.setClass, Status: state.status })
          }));
          if (!resp.ok) {
            await notify("error", await resp.text());
            return;
          }
          const payload = await resp.json();
          nextPartNum = readResultValue(payload);
        }
        if (!nextPartNum) continue;
        const chk = await checkAdd(nextPartNum);
        if (chk && chk !== 0) {
          await notify("error", "料號已存在，請重新編碼");
          return;
        }
        const ok = await submitAdd(nextPartNum, userId, globalId);
        if (!ok) return;
      }
    }

    await notify("success", "新增完成");
    hideModal();
    document.dispatchEvent(new CustomEvent("matinfo:add:done"));
  });

  window.MatInfoAddHandler.open = async (ctx = {}) => {
    clearForm();
    const meta = getPowerMeta(ctx.itemId);
    state.powerType = meta.powerType;
    state.status = meta.status;
    state.mb = meta.mb;
    state.isTmpPN2Real = ctx.mode === "tmpToFormal" ? 1 : 0;
    state.currOldPN = (ctx.currOldPN || "").toString().trim();
    if (typeof ctx.mb === "number") state.mb = ctx.mb;
    const titleEl = modalEl.querySelector(".modal-title");
    if (titleEl) titleEl.textContent = state.isTmpPN2Real ? "轉正式" : "新增";
    try {
      await loadUnits();
      await loadMatClass();
    } catch {
      // ignore load failure to still open UI
    }
    if (ctx.setClass) {
      await applySetClass(ctx.setClass, !state.isTmpPN2Real);
    }
    if (ctx.matName) elMatName.value = ctx.matName;
    if (ctx.unit) {
      const unitValue = ctx.unit.toString().trim();
      if (unitValue) {
        if (![...elUnit.options].some((opt) => opt.value === unitValue)) {
          const opt = document.createElement("option");
          opt.value = unitValue;
          opt.textContent = unitValue;
          elUnit.appendChild(opt);
        }
        elUnit.value = unitValue;
      }
    }
    showModal();
  };

  if (headerEl && dialogEl) {
    let dragging = false;
    let startX = 0;
    let startY = 0;
    let origX = 0;
    let origY = 0;
    headerEl.addEventListener("mousedown", (e) => {
      dragging = true;
      const rect = dialogEl.getBoundingClientRect();
      startX = e.clientX;
      startY = e.clientY;
      origX = rect.left;
      origY = rect.top;
      dialogEl.style.position = "fixed";
      dialogEl.style.left = `${origX}px`;
      dialogEl.style.top = `${origY}px`;
      dialogEl.style.transform = "none";
      dialogEl.style.margin = "0";
      e.preventDefault();
    });
    document.addEventListener("mousemove", (e) => {
      if (!dragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      dialogEl.style.left = `${origX + dx}px`;
      dialogEl.style.top = `${origY + dy}px`;
    });
    document.addEventListener("mouseup", () => {
      dragging = false;
    });
  }

  modalEl.addEventListener("hidden.bs.modal", () => {
    forceHideModal();
  });
  modalEl.querySelectorAll('[data-bs-dismiss="modal"], .btn-close').forEach((btn) => {
    btn.addEventListener("click", () => {
      if (!modal) forceHideModal();
    });
  });
})();
</script>

