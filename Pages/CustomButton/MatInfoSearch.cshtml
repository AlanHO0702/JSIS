@model dynamic

<style>
  .matinfo-search-modal .modal-dialog {
    max-width: 720px;
    margin-top: 6px;
  }
  .matinfo-search-modal .modal-content {
    overflow: visible;
  }
  .matinfo-search-modal .modal-body {
    overflow: hidden;
  }
  .matinfo-search-container {
    width: 100%;
    margin: 0 auto;
  }
  .matinfo-search-header {
    font-weight: 700;
    color: #1d3b6b;
  }
  .matinfo-search-drag {
    cursor: move;
  }
  .matinfo-search-form {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px 12px;
  }
  .matinfo-search-field {
    display: grid;
    grid-template-columns: 90px 1fr;
    gap: 6px;
    align-items: center;
  }
  .matinfo-search-field label {
    text-align: right;
    color: #1d3b6b;
    font-size: 0.82rem;
    white-space: nowrap;
  }
  .matinfo-search-field input,
  .matinfo-search-field select {
    height: 22px;
    padding: 1px 4px;
    border: 1px solid #cfd7e6;
    border-radius: 4px;
    font-size: 0.8rem;
    width: 100%;
    min-width: 0;
    white-space: nowrap;
  }
  .matinfo-search-field .field-inline {
    display: grid;
    grid-template-columns: 120px 120px;
    gap: 6px;
  }
  .matinfo-search-grid {
    margin-top: 6px;
    border: none;
    border-radius: 0;
    overflow-x: auto;
    overflow-y: auto;
    height: 120px;
  }
  .matinfo-search-grid table {
    width: 100%;
    min-width: 480px;
    border-collapse: collapse;
    font-size: 0.8rem;
  }
  .matinfo-search-grid th,
  .matinfo-search-grid td {
    padding: 4px 6px;
    border-bottom: 1px solid #eef2f8;
    white-space: nowrap;
    vertical-align: middle;
  }
  .matinfo-search-grid thead th {
    background: #f7f9ff;
    color: #1d3b6b;
    font-weight: 600;
  }
  .matinfo-search-grid select {
    width: 100%;
    height: 22px;
    border: 1px solid #cfd7e6;
    border-radius: 4px;
    font-size: 0.78rem;
    padding: 1px 4px;
    white-space: nowrap;
  }
  .matinfo-search-footer {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  .matinfo-search-footer .toolbar-btn {
    padding: 6px 14px;
  }
  @@media (max-width: 900px) {
    .matinfo-search-form {
      grid-template-columns: 1fr;
    }
    .matinfo-search-field .field-inline {
      grid-template-columns: 1fr 1fr;
    }
  }
</style>

<div class="modal fade matinfo-search-modal" id="matinfo-search-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header matinfo-search-drag">
        <h5 class="modal-title matinfo-search-header">查詢</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="matinfo-search-container">
          <div class="matinfo-search-form">
            <div class="matinfo-search-field">
              <label>料號(模糊)</label>
              <input id="matinfo-search-partnum-like">
            </div>
            <div class="matinfo-search-field">
              <label>品名(模糊)</label>
              <input id="matinfo-search-matname">
            </div>
            <div class="matinfo-search-field">
              <label>料號</label>
              <div class="field-inline">
                <input id="matinfo-search-partnum-b" placeholder="起">
                <input id="matinfo-search-partnum-e" placeholder="迄">
              </div>
            </div>
            <div class="matinfo-search-field">
              <label>規格/機種</label>
              <input id="matinfo-search-enggauge">
            </div>
            <div class="matinfo-search-field">
              <label>圖號(模糊)</label>
              <input id="matinfo-search-mapno">
            </div>
            <div class="matinfo-search-field">
              <label>舊料號(模糊)</label>
              <input id="matinfo-search-oldpartnum">
            </div>
            <div class="matinfo-search-field">
              <label>規格表單號</label>
              <input id="matinfo-search-papernum">
            </div>
            <div class="matinfo-search-field">
              <label>客戶料號</label>
              <input id="matinfo-search-customerpn">
            </div>
            <div class="matinfo-search-field">
              <label>商品條碼</label>
              <input id="matinfo-search-barcode">
            </div>
            <div class="matinfo-search-field">
              <label>來源臨時料號</label>
              <input id="matinfo-search-fromtmp">
            </div>
            <div class="matinfo-search-field">
              <label>臨時轉正式料號</label>
              <input id="matinfo-search-newpartnum">
            </div>
            <div class="matinfo-search-field">
              <label>狀態</label>
              <select id="matinfo-search-status">
                <option value="all">不限</option>
                <option value="0">臨時</option>
                <option value="1">正式</option>
              </select>
            </div>
            <div class="matinfo-search-field">
              <label>已轉正式</label>
              <select id="matinfo-search-istrans">
                <option value="all">不限</option>
                <option value="0">未轉正式</option>
                <option value="1">已轉正式</option>
              </select>
            </div>
            <div class="matinfo-search-field">
              <label>已轉工程</label>
              <select id="matinfo-search-isemo">
                <option value="all">不限</option>
                <option value="0">未轉工程</option>
                <option value="1">已轉工程</option>
              </select>
            </div>
            <div class="matinfo-search-field">
              <label>料號/原料</label>
              <select id="matinfo-search-material">
                <option value="all">不限</option>
                <option value="0">品號</option>
                <option value="1">原料</option>
              </select>
            </div>
            <div class="matinfo-search-field">
              <label>未轉廠</label>
              <select id="matinfo-search-istrantoc">
                <option value="all">不限</option>
                <option value="0">未轉廠</option>
                <option value="1">已轉廠</option>
              </select>
            </div>
            <div class="matinfo-search-field">
              <label>非挪入</label>
              <select id="matinfo-search-istranfrom">
                <option value="all">不限</option>
                <option value="0">非挪入</option>
                <option value="1">是挪入</option>
              </select>
            </div>
            <div class="matinfo-search-field">
              <label>主分類</label>
              <select id="matinfo-search-setclass"></select>
            </div>
            <div class="matinfo-search-field">
              <label>自訂分類一</label>
              <input id="matinfo-search-matclass1">
            </div>
            <div class="matinfo-search-field">
              <label>自訂分類二</label>
              <input id="matinfo-search-matclass2">
            </div>
            <div class="matinfo-search-field">
              <label>狀態碼</label>
              <input id="matinfo-search-ipnstatus">
            </div>
            <div class="matinfo-search-field">
              <label>轉廠別</label>
              <input id="matinfo-search-tranfac">
            </div>
            <div class="matinfo-search-field">
              <label>建檔人</label>
              <select id="matinfo-search-user"></select>
            </div>
            <div class="matinfo-search-field">
              <label>建檔時間</label>
              <div class="field-inline">
                <input id="matinfo-search-date-b" type="date">
                <input id="matinfo-search-date-e" type="date">
              </div>
            </div>
          </div>

          <div class="matinfo-search-grid">
            <table>
              <thead>
                <tr>
                  <th style="width: 60px;">屬性</th>
                  <th style="width: 140px;">屬性名稱</th>
                  <th style="width: 160px;">選擇資料_起</th>
                  <th style="width: 160px;">選擇資料_迄</th>
                </tr>
              </thead>
              <tbody id="matinfo-search-grid-body">
                <tr>
                  <td colspan="4">請先選擇分類</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer matinfo-search-footer">
        <button type="button" class="btn toolbar-btn success" id="matinfo-search-ok">查詢</button>
        <button type="button" class="btn toolbar-btn danger" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  window.MatInfoSearchHandler = window.MatInfoSearchHandler || {};

  const modalEl = document.getElementById("matinfo-search-modal");
  if (!modalEl) return;
  const modal = window.bootstrap?.Modal ? window.bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: "static" }) : null;
  let manualBackdrop = null;
  const dialogEl = modalEl.querySelector(".modal-dialog");

  const forceShowModal = () => {
    modalEl.classList.add("show");
    modalEl.style.display = "block";
    modalEl.style.zIndex = "1055";
    modalEl.removeAttribute("aria-hidden");
    modalEl.setAttribute("aria-modal", "true");
    if (!manualBackdrop) {
      manualBackdrop = document.createElement("div");
      manualBackdrop.className = "modal-backdrop fade show";
      document.body.appendChild(manualBackdrop);
    }
    if (dialogEl) {
      dialogEl.style.position = "fixed";
      dialogEl.style.left = "50%";
      dialogEl.style.top = "70px";
      dialogEl.style.transform = "translateX(-50%)";
      dialogEl.style.margin = "0";
    }
  };

  const forceHideModal = () => {
    modalEl.classList.remove("show");
    modalEl.style.display = "none";
    modalEl.setAttribute("aria-hidden", "true");
    modalEl.removeAttribute("aria-modal");
    if (manualBackdrop) {
      manualBackdrop.remove();
      manualBackdrop = null;
    }
  };

  const showModal = () => {
    if (modal) {
      modal.show();
      if (!modalEl.classList.contains("show")) {
        forceShowModal();
      }
      return;
    }
    forceShowModal();
  };

  const hideModal = () => {
    if (modal) {
      modal.hide();
      return;
    }
    forceHideModal();
  };

  const elSetClass = document.getElementById("matinfo-search-setclass");
  const elMaterial = document.getElementById("matinfo-search-material");
  const elGridBody = document.getElementById("matinfo-search-grid-body");
  const elUser = document.getElementById("matinfo-search-user");
  const btnOk = document.getElementById("matinfo-search-ok");
  const headerEl = modalEl.querySelector(".modal-header");

  const state = {
    spid: null,
    rows: [],
    setClass: "",
    dtlCache: {}
  };

  const notify = async (type, message) => {
    if (window.Swal) {
      const icon = type === "error" ? "error" : (type === "success" ? "success" : "info");
      await window.Swal.fire({ icon, title: message });
      return;
    }
    alert(message);
  };

  const withJwtHeaders = (init = {}) => {
    const jwt = localStorage.getItem("jwtId");
    const headers = Object.assign({}, init.headers || {});
    if (jwt) headers["X-JWTID"] = jwt;
    return { ...init, headers };
  };

  const getPowerMeta = (itemId) => {
    const id = (itemId || "").toUpperCase();
    if (id === "MG000008" || id === "CPN00006") return { mb: 0 };
    if (id === "MG000002" || id === "CPN00007") return { mb: 1 };
    return { mb: null };
  };

  const clearForm = () => {
    modalEl.querySelectorAll("input, select").forEach((el) => {
      if (el.tagName === "SELECT") el.value = el.options[0]?.value ?? "";
      else el.value = "";
    });
    state.spid = null;
    state.rows = [];
    state.setClass = "";
    state.dtlCache = {};
    if (elGridBody) elGridBody.innerHTML = "<tr><td colspan=\"4\">請先選擇分類</td></tr>";
  };

  const toIntOrNull = (value) => {
    if (value === null || value === undefined) return null;
    const v = value.toString().trim();
    if (!v || v === "all") return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  };

  const loadMatClass = async (mbValue) => {
    elSetClass.innerHTML = "";
    const qs = new URLSearchParams();
    if (mbValue === 0 || mbValue === 1) qs.set("mb", mbValue.toString());
    const resp = await fetch(`/api/MatInfoSearch/MatClass?${qs.toString()}`, withJwtHeaders());
    if (!resp.ok) {
      await notify("error", await resp.text());
      return;
    }
    const rows = await resp.json();
    const list = Array.isArray(rows) ? rows : [];
    elSetClass.innerHTML = "<option value=\"\"></option>" + list.map((row) => {
      const value = row.MatClass ?? row.matClass ?? "";
      const name = row.ClassName ?? row.className ?? "";
      return `<option value=\"${value}\">${value} ${name}</option>`;
    }).join("");
  };

  const loadUsers = async () => {
    elUser.innerHTML = "<option value=\"\"></option>";
    const resp = await fetch("/api/MatInfoSearch/Users", withJwtHeaders());
    if (!resp.ok) return;
    const rows = await resp.json();
    const list = Array.isArray(rows) ? rows : [];
    elUser.innerHTML += list.map((row) => {
      const value = row.UserId ?? row.userId ?? "";
      const name = row.UserName ?? row.userName ?? "";
      return `<option value=\"${value}\">${value} ${name}</option>`;
    }).join("");
  };

  const loadSetClassData = async (setClass) => {
    if (!setClass) return;
    const resp = await fetch(`/api/MatInfoSearch/SetClassData?setClass=${encodeURIComponent(setClass)}`, withJwtHeaders());
    if (!resp.ok) {
      await notify("error", await resp.text());
      return;
    }
    const payload = await resp.json();
    state.spid = payload.spid ?? null;
    state.rows = Array.isArray(payload.rows) ? payload.rows : [];
    state.setClass = setClass;
    updateGrid();
  };

  const loadDtlOptions = async (setClass, numId) => {
    const cacheKey = `${setClass}|${numId}`;
    if (state.dtlCache[cacheKey]) return state.dtlCache[cacheKey];
    const resp = await fetch(`/api/MatInfoSearch/DtlNumOptions?setClass=${encodeURIComponent(setClass)}&numId=${encodeURIComponent(numId)}`, withJwtHeaders());
    if (!resp.ok) return [];
    const rows = await resp.json();
    const list = Array.isArray(rows) ? rows : [];
    state.dtlCache[cacheKey] = list;
    return list;
  };

  const fillSelectOptions = (selectEl, options, currentValue) => {
    if (!selectEl) return;
    const html = options.map((opt) => {
      const value = opt.DtlNumId ?? opt.dtlNumId ?? "";
      const label = opt.DtlNumName ?? opt.dtlNumName ?? value;
      const selected = value === currentValue ? "selected" : "";
      return `<option value=\"${value}\" ${selected}>${value} ${label}</option>`;
    }).join("");
    selectEl.innerHTML = `<option value=""></option>` + (html || (currentValue ? `<option value=\"${currentValue}\">${currentValue}</option>` : ""));
  };

  const updateGrid = () => {
    if (!elGridBody) return;
    if (!state.rows.length) {
      elGridBody.innerHTML = "<tr><td colspan=\"4\">沒有屬性資料</td></tr>";
      return;
    }
    elGridBody.innerHTML = state.rows.map((row, idx) => {
      const numId = row.NumId ?? row.numId ?? "";
      const numName = row.NumName ?? row.numName ?? "";
      const dtlB = row.DtlNumId_B ?? row.dtlNumId_B ?? "";
      const dtlE = row.DtlNumId_E ?? row.dtlNumId_E ?? "";
      return `
        <tr>
          <td>${numId}</td>
          <td>${numName}</td>
          <td>
            <select class="matinfo-search-dtl matinfo-search-dtl-b" data-idx="${idx}" data-numid="${numId}" data-kind="B">
              <option value=""></option>
              ${dtlB ? `<option value=\"${dtlB}\" selected>${dtlB}</option>` : ""}
            </select>
          </td>
          <td>
            <select class="matinfo-search-dtl matinfo-search-dtl-e" data-idx="${idx}" data-numid="${numId}" data-kind="E">
              <option value=""></option>
              ${dtlE ? `<option value=\"${dtlE}\" selected>${dtlE}</option>` : ""}
            </select>
          </td>
        </tr>
      `;
    }).join("");
  };

  elSetClass.addEventListener("change", async () => {
    const setClass = elSetClass.value.trim();
    state.setClass = setClass;
    await loadSetClassData(setClass);
  });

  elMaterial.addEventListener("change", async () => {
    const mb = toIntOrNull(elMaterial.value);
    await loadMatClass(mb);
    state.setClass = "";
    state.rows = [];
    if (elGridBody) elGridBody.innerHTML = "<tr><td colspan=\"4\">請先選擇分類</td></tr>";
  });

  if (elGridBody) {
    elGridBody.addEventListener("focusin", async (e) => {
      const target = e.target;
      if (!(target instanceof HTMLSelectElement)) return;
      if (!target.classList.contains("matinfo-search-dtl")) return;
      const idx = Number(target.dataset.idx || "-1");
      if (idx < 0 || idx >= state.rows.length) return;
      const numId = target.dataset.numid || "";
      if (!numId || !state.setClass) return;
      const options = await loadDtlOptions(state.setClass, numId);
      const row = state.rows[idx];
      const currentValue = target.dataset.kind === "E"
        ? (row.DtlNumId_E ?? row.dtlNumId_E ?? "")
        : (row.DtlNumId_B ?? row.dtlNumId_B ?? "");
      fillSelectOptions(target, options, currentValue);
    });

    elGridBody.addEventListener("change", (e) => {
      const target = e.target;
      if (!(target instanceof HTMLSelectElement)) return;
      if (!target.classList.contains("matinfo-search-dtl")) return;
      const idx = Number(target.dataset.idx || "-1");
      if (idx < 0 || idx >= state.rows.length) return;
      const row = state.rows[idx];
      if (target.dataset.kind === "E") row.DtlNumId_E = target.value;
      else row.DtlNumId_B = target.value;
      if (!row.DtlNumId_E && row.DtlNumId_B) {
        row.DtlNumId_E = row.DtlNumId_B;
        const selectE = elGridBody.querySelector(`select.matinfo-search-dtl-e[data-idx="${idx}"]`);
        if (selectE) selectE.value = row.DtlNumId_E;
      }
    });
  }

  btnOk?.addEventListener("click", async () => {
    const payload = {
      Limit: 0,
      PartNumLike: document.getElementById("matinfo-search-partnum-like")?.value.trim(),
      PartNumB: document.getElementById("matinfo-search-partnum-b")?.value.trim(),
      PartNumE: document.getElementById("matinfo-search-partnum-e")?.value.trim(),
      MatName: document.getElementById("matinfo-search-matname")?.value.trim(),
      MapNo: document.getElementById("matinfo-search-mapno")?.value.trim(),
      OldPartNum: document.getElementById("matinfo-search-oldpartnum")?.value.trim(),
      EngGauge: document.getElementById("matinfo-search-enggauge")?.value.trim(),
      PaperNum: document.getElementById("matinfo-search-papernum")?.value.trim(),
      CustomerPN: document.getElementById("matinfo-search-customerpn")?.value.trim(),
      Barcode: document.getElementById("matinfo-search-barcode")?.value.trim(),
      FromTmpPartNum: document.getElementById("matinfo-search-fromtmp")?.value.trim(),
      NewPartNum: document.getElementById("matinfo-search-newpartnum")?.value.trim(),
      SetClass: elSetClass.value.trim(),
      MatClass1: document.getElementById("matinfo-search-matclass1")?.value.trim(),
      MatClass2: document.getElementById("matinfo-search-matclass2")?.value.trim(),
      UserId: elUser.value.trim(),
      Status: toIntOrNull(document.getElementById("matinfo-search-status")?.value),
      IsTrans: toIntOrNull(document.getElementById("matinfo-search-istrans")?.value),
      IsEMO: toIntOrNull(document.getElementById("matinfo-search-isemo")?.value),
      MB: toIntOrNull(document.getElementById("matinfo-search-material")?.value),
      iPNStatus: toIntOrNull(document.getElementById("matinfo-search-ipnstatus")?.value),
      TranFacType: toIntOrNull(document.getElementById("matinfo-search-tranfac")?.value),
      IsTranToC: toIntOrNull(document.getElementById("matinfo-search-istrantoc")?.value),
      IsTranFrom: toIntOrNull(document.getElementById("matinfo-search-istranfrom")?.value),
      BuildDateStart: document.getElementById("matinfo-search-date-b")?.value || null,
      BuildDateEnd: document.getElementById("matinfo-search-date-e")?.value || null,
      AddData: state.rows
        .map((row) => ({
          NumId: row.NumId ?? row.numId ?? "",
          DtlNumId_B: row.DtlNumId_B ?? row.dtlNumId_B ?? "",
          DtlNumId_E: row.DtlNumId_E ?? row.dtlNumId_E ?? ""
        }))
        .filter(r => r.DtlNumId_B || r.DtlNumId_E)
    };

    const resp = await fetch("/api/MatInfoSearch/Search", withJwtHeaders({
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }));
    if (!resp.ok) {
      await notify("error", await resp.text());
      return;
    }
    const data = await resp.json();
    const rows = data?.data ?? [];
    document.dispatchEvent(new CustomEvent("matinfo:search:done", { detail: { rows } }));
    hideModal();
  });

  window.MatInfoSearchHandler.open = async (ctx = {}) => {
    clearForm();
    if (ctx.dictTableName) {
      window._dictTableName = ctx.dictTableName;
    }
    const meta = getPowerMeta(ctx.itemId);
    if (meta.mb === 0 || meta.mb === 1) {
      elMaterial.value = meta.mb.toString();
      elMaterial.disabled = true;
    } else {
      elMaterial.disabled = false;
    }
    await loadUsers();
    await loadMatClass(meta.mb);
    showModal();
  };
  if (headerEl && dialogEl) {
    let dragging = false;
    let startX = 0;
    let startY = 0;
    let origX = 0;
    let origY = 0;
    headerEl.addEventListener("mousedown", (e) => {
      dragging = true;
      const rect = dialogEl.getBoundingClientRect();
      startX = e.clientX;
      startY = e.clientY;
      origX = rect.left;
      origY = rect.top;
      dialogEl.style.position = "fixed";
      dialogEl.style.left = `${origX}px`;
      dialogEl.style.top = `${origY}px`;
      dialogEl.style.transform = "none";
      dialogEl.style.margin = "0";
      e.preventDefault();
    });
    document.addEventListener("mousemove", (e) => {
      if (!dragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      dialogEl.style.left = `${origX + dx}px`;
      dialogEl.style.top = `${origY + dy}px`;
    });
    document.addEventListener("mouseup", () => {
      dragging = false;
    });
  }
  modalEl.addEventListener("hidden.bs.modal", () => {
    forceHideModal();
  });
  modalEl.querySelectorAll('[data-bs-dismiss="modal"], .btn-close').forEach((btn) => {
    btn.addEventListener("click", () => {
      if (!modal) forceHideModal();
    });
  });
})();
</script>
