@page "/SPO/SPO00015"
@model PcbErpApi.Pages.SPO.SPO00015Model
@{
    Layout = "_InquiryTemplate";
    ViewData["Title"] = Model.PageTitle;
    ViewData["ShowInqRail"] = false;
}

@section InqHeader {
  <div class="spo15-toolbar">
    <div class="btn-toolbar spo15-toolbar-actions" role="group" aria-label="銷貨發票查詢操作">
      <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btnSPO15First" title="第一筆" aria-label="第一筆"><i class="bi bi-chevron-bar-left"></i></button>
      <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btnSPO15Prev" title="上一筆" aria-label="上一筆"><i class="bi bi-chevron-left"></i></button>
      <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btnSPO15Next" title="下一筆" aria-label="下一筆"><i class="bi bi-chevron-right"></i></button>
      <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btnSPO15Last" title="最後一筆" aria-label="最後一筆"><i class="bi bi-chevron-bar-right"></i></button>
      <div id="spo15CountBox" class="toolbar-count-box mode-view">
        <div id="spo15Mode" class="count-line">瀏覽模式</div>
        <div id="spo15Count" class="count-line">@(Model.Items.Count > 0 ? 1 : 0) / @Model.TotalCount</div>
      </div>
      <button type="button" class="btn toolbar-btn" id="btnSPO15Query"><i class="bi bi-search"></i>查詢</button>
      <button type="button" class="btn toolbar-btn" id="btnSPO15Switch"><i class="bi bi-arrow-left-right"></i>切換</button>
      <button type="button" class="btn toolbar-btn" id="btnSPO15Excel"><i class="bi bi-file-earmark-excel"></i>Excel</button>
    </div>
  </div>
}

<script>
  window._itemId = "SPO00015";
  window._dictTableName = "SPOdV_InvoiceInq";
</script>

<!-- Query Modal (same template as 銷售訂單) -->
<div class="modal fade" id="queryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    @await Html.PartialAsync("~/Pages/Shared/_QueryPanelPartial.cshtml", (object)(new List<object>()))
  </div>
</div>
@await Html.PartialAsync("~/Pages/Shared/_QueryFieldModals.cshtml")

<div class="inq-table-wrap">
  <table class="table table-sm table-hover align-middle inq-table">
    <thead>
      <tr>
        <th data-field="InvoiceNum">發票號碼</th>
        <th data-field="PaperNum">銷貨單號</th>
        <th data-field="PaperDate">發票日期</th>
        <th data-field="CustomerId">客戶代碼</th>
        <th data-field="ShortName">客戶名稱</th>
        <th data-field="FinishedName">狀態</th>
        <th data-field="MoneyName">幣別</th>
        <th data-field="RateToNT">匯率</th>
        <th data-field="Item">項次</th>
        <th data-field="PartNum">品號</th>
        <th data-field="UOMQnty">UOMQty</th>
        <th data-field="Qnty">數量</th>
        <th data-field="UnitPrice">單價</th>
        <th data-field="SubTotal">小計</th>
        <th data-field="SourNum">來源單號</th>
        <th data-field="SourItem">來源項次</th>
        <th data-field="ChargeTypeName">費用別</th>
        <th data-field="InvoiceTypeName">發票類別</th>
        <th data-field="PayWayName">付款方式</th>
        <th data-field="ExpectDate">預計收款日</th>
        <th data-field="MainSubTotal">主檔小計</th>
        <th data-field="Tax">稅額</th>
        <th data-field="Total">總額</th>
        <th data-field="TotalAmountOg">原幣總額</th>
        <th data-field="PaperId">單據別</th>
        <th data-field="FinishAmount">已收款</th>
        <th data-field="FinishAmountOg">原幣已收</th>
      </tr>
    </thead>
    <tbody>
    @if (Model.Items.Count == 0)
    {
      <tr>
        <td colspan="27" class="text-center text-muted py-2">沒有資料</td>
      </tr>
    }
    else
    {
      foreach (var row in Model.Items)
      {
        string Get(string name)
        {
            return row.TryGetValue(name, out var v) ? (v?.ToString() ?? "") : "";
        }
        <tr data-paper-id="@Get("PaperId")" data-paper-num="@Get("PaperNum")">
          <td>@Get("InvoiceNum")</td>
          <td>@Get("PaperNum")</td>
          <td>@Get("PaperDate")</td>
          <td>@Get("CustomerId")</td>
          <td>@Get("ShortName")</td>
          <td>@Get("FinishedName")</td>
          <td>@Get("MoneyName")</td>
          <td>@Get("RateToNT")</td>
          <td>@Get("Item")</td>
          <td>@Get("PartNum")</td>
          <td>@Get("UOMQnty")</td>
          <td>@Get("Qnty")</td>
          <td>@Get("UnitPrice")</td>
          <td>@Get("SubTotal")</td>
          <td>@Get("SourNum")</td>
          <td>@Get("SourItem")</td>
          <td>@Get("ChargeTypeName")</td>
          <td>@Get("InvoiceTypeName")</td>
          <td>@Get("PayWayName")</td>
          <td>@Get("ExpectDate")</td>
          <td>@Get("MainSubTotal")</td>
          <td>@Get("Tax")</td>
          <td>@Get("Total")</td>
          <td>@Get("TotalAmountOg")</td>
          <td>@Get("PaperId")</td>
          <td>@Get("FinishAmount")</td>
          <td>@Get("FinishAmountOg")</td>
        </tr>
      }
    }
    </tbody>
  </table>
</div>

@if (Model.TotalPages > 1)
{
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-1 mt-2">
    <div class="d-flex align-items-center gap-1">
      <a class="btn btn-outline-secondary btn-sm @(Model.PageNumber <= 1 ? "disabled" : "")"
         href="@(Model.PageNumber <= 1 ? "#" : BuildPageUrl(Model.PageNumber - 1))">上一頁</a>
      <span>Page: <strong>@Model.PageNumber</strong> / <span>@Model.TotalPages</span></span>
      <a class="btn btn-outline-secondary btn-sm @(Model.PageNumber >= Model.TotalPages ? "disabled" : "")"
         href="@(Model.PageNumber >= Model.TotalPages ? "#" : BuildPageUrl(Model.PageNumber + 1))">下一頁</a>
    </div>
    <div class="text-muted">Total: @Model.TotalCount</div>
  </div>
}

@functions{
    string BuildPageUrl(int page)
    {
        var map = ViewContext.HttpContext.Request.Query.ToDictionary(k => k.Key, v => v.Value.ToString(), StringComparer.OrdinalIgnoreCase);
        map["page"] = page.ToString();
        map["pageSize"] = Model.PageSize.ToString();
        var qs = Microsoft.AspNetCore.Http.QueryString.Create(map).ToString();
        return qs;
    }
}

<style>
  .inq-table-wrap {
    border: 1px solid #d8dee8;
    border-radius: 8px;
    background: #fff;
    padding: 6px;
    overflow-x: auto;
  }
  .inq-table th,
  .inq-table td {
    white-space: nowrap;
    font-size: 0.82rem;
    padding: 4px 6px;
  }
  .inq-table th {
    background: #f3f7ff;
    color: #2056ac;
    font-weight: 600;
  }
  .inq-table th.inq-sort-asc::after {
    content: " ▲";
    font-size: 0.7em;
    color: #1f3a8a;
  }
  .inq-table th.inq-sort-desc::after {
    content: " ▼";
    font-size: 0.7em;
    color: #1f3a8a;
  }
  .inq-table tbody tr {
    cursor: pointer;
  }
  .inq-table tbody tr.table-active td {
    background: var(--bs-table-active-bg);
  }

  .spo15-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    border: 1px solid #d8dee8;
    border-radius: 10px;
    background: var(--section-bg-toolbar, #f6f7f9);
  }
  .spo15-toolbar-actions {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }
  .toolbar-count-box {
    display: inline-flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 30px;
    min-width: 74px;
    padding: 2px 8px;
    border-radius: 6px;
    font-weight: 700;
    line-height: 1.05;
    color: #fff;
    background: #1e4db7;
    user-select: none;
    font-size: 0.85rem;
  }
  .toolbar-btn {
    height: 32px;
    padding: 0 8px;
    font-size: 0.82rem;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    border: 1px solid #cfd7e6;
    border-radius: 8px;
    background: #fff;
    color: #1f3a8a;
  }
  .toolbar-btn:hover {
    background: #e9f1ff;
    border-color: #9fbaf0;
  }
  .toolbar-btn-icon {
    width: 28px;
    min-width: 28px;
    padding: 0;
    justify-content: center;
  }
</style>

<script>
  const queryModalEl = document.getElementById("queryModal");
  const queryForm = document.getElementById("searchForm");
  const queryFieldGrid = queryForm?.querySelector(".query-field-grid");

  document.getElementById("btnSPO15Excel")?.addEventListener("click", () => {
    const url = new URL(window.location.href);
    url.searchParams.set("handler", "Export");
    window.location.href = url.toString();
  });

  document.getElementById("btnSPO15Query")?.addEventListener("click", () => {
    if (queryModalEl && window.bootstrap) {
      const modal = bootstrap.Modal.getOrCreateInstance(queryModalEl);
      modal.show();
    }
  });

  queryForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    const url = new URL(window.location.origin + window.location.pathname);

    const currentPageSize = new URLSearchParams(window.location.search).get("pageSize");
    if (currentPageSize) url.searchParams.set("pageSize", currentPageSize);
    url.searchParams.set("page", "1");

    queryFieldGrid?.querySelectorAll('.query-input').forEach(input => {
      const val = input.value?.trim() ?? "";
      const key = input.name || input.dataset.key || "";
      if (!key) return;
      if (val) url.searchParams.set(key, val);
      else url.searchParams.delete(key);
    });

    queryFieldGrid?.querySelectorAll('.query-op').forEach(select => {
      const op = select.value?.trim() ?? "";
      const key = select.name?.replace(/^Cond_/, "") ?? "";
      const input = key ? queryFieldGrid.querySelector(`.query-input[name="${CSS.escape(key)}"]`) : null;
      const hasValue = !!(input && (input.value ?? "").toString().trim() !== "");
      if (key && op && op !== "=" && hasValue) {
        url.searchParams.set(`Cond_${key}`, op);
      } else if (key) {
        url.searchParams.delete(`Cond_${key}`);
      }
    });

    window.location.href = url.toString();
  });

  const rows = Array.from(document.querySelectorAll(".inq-table tbody tr"))
    .filter(r => !r.querySelector("td[colspan]"));
  let selectedIndex = rows.length > 0 ? 0 : -1;

  const applyHeaderSort = () => {
    const url = new URL(window.location.href);
    const sortBy = (url.searchParams.get("sortBy") || "").toString();
    const sortDir = (url.searchParams.get("sortDir") || "asc").toLowerCase();
    const headers = Array.from(document.querySelectorAll(".inq-table thead th[data-field]"));
    headers.forEach(th => {
      th.classList.remove("inq-sort-asc", "inq-sort-desc");
      const field = th.getAttribute("data-field") || "";
      if (field && field.toLowerCase() === sortBy.toLowerCase()) {
        th.classList.add(sortDir === "desc" ? "inq-sort-desc" : "inq-sort-asc");
      }
      th.style.cursor = field ? "pointer" : "";
    });
  };

  const bindHeaderSort = () => {
    const headers = Array.from(document.querySelectorAll(".inq-table thead th[data-field]"));
    headers.forEach(th => {
      th.addEventListener("click", () => {
        const field = th.getAttribute("data-field");
        if (!field) return;
        const url = new URL(window.location.href);
        const curBy = (url.searchParams.get("sortBy") || "").toString();
        const curDir = (url.searchParams.get("sortDir") || "asc").toLowerCase();
        const nextDir = (curBy.toLowerCase() === field.toLowerCase() && curDir === "asc") ? "desc" : "asc";
        url.searchParams.set("sortBy", field);
        url.searchParams.set("sortDir", nextDir);
        url.searchParams.set("page", "1");
        window.location.href = url.toString();
      });
    });
  };

  const updateCount = () => {
    const countEl = document.getElementById("spo15Count");
    if (!countEl) return;
    const cur = selectedIndex >= 0 ? (selectedIndex + 1) : 0;
    countEl.textContent = `${cur} / @Model.TotalCount`;
  };

  const selectRow = (idx) => {
    if (rows.length === 0) return;
    const safe = Math.max(0, Math.min(rows.length - 1, idx));
    rows.forEach(r => r.classList.remove("table-active"));
    rows[safe].classList.add("table-active");
    selectedIndex = safe;
    updateCount();
    rows[safe].scrollIntoView({ block: "nearest" });
  };

  rows.forEach((tr, i) => {
    tr.addEventListener("click", () => selectRow(i));
  });

  document.getElementById("btnSPO15First")?.addEventListener("click", () => selectRow(0));
  document.getElementById("btnSPO15Prev")?.addEventListener("click", () => selectRow(selectedIndex - 1));
  document.getElementById("btnSPO15Next")?.addEventListener("click", () => selectRow(selectedIndex + 1));
  document.getElementById("btnSPO15Last")?.addEventListener("click", () => selectRow(rows.length - 1));

  bindHeaderSort();
  applyHeaderSort();

  const currentUserId = "@Model.CurrentUserId";
  const currentUseId = "@Model.CurrentUseId";
  document.getElementById("btnSPO15Switch")?.addEventListener("click", async () => {
    if (selectedIndex < 0 || !rows[selectedIndex]) return alert("請先選擇一筆資料");
    const tr = rows[selectedIndex];
    const pid = tr.getAttribute("data-paper-id");
    const pnum = tr.getAttribute("data-paper-num");
    if (!pid || !pnum) return alert("找不到單據資訊");
    try {
      const res = await fetch("/api/Flow/ResolveItemIdByFromType", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paperId: pid, paperNum: pnum, userId: currentUserId, useId: currentUseId })
      });
      if (res.ok) {
        const data = await res.json();
        const itemId = data.itemId || pid;
        window.open(`/DynamicTemplate/Paper/${encodeURIComponent(itemId)}/${encodeURIComponent(pnum)}`, "_blank");
        return;
      }
    } catch {}
    window.open(`/DynamicTemplate/Paper/${encodeURIComponent(pid)}/${encodeURIComponent(pnum)}`, "_blank");
  });

  if (rows.length > 0) selectRow(0);
</script>
