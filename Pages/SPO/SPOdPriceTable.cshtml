@page "/SPO/SPO00013"
@model PcbErpApi.Pages.SPO.SPO00013Model
@{
    Layout = "_Layout";
    var cfg = Model.Config;
    ViewData["Title"] = string.IsNullOrWhiteSpace(Model.ItemName)
        ? "SPO00013 銷售價格表"
        : $"SPO00013 {Model.ItemName}";
}

@if (cfg == null)
{
    <div class="alert alert-warning mt-3">
        無法載入銷售價格表 (SPO00013) 設定：@Model.LoadError
    </div>
}
else
{
    <div id="mdCustomButtonBar" class="d-flex gap-2 flex-wrap">@Model.CustomButtonsHtml</div>
    @await Html.PartialAsync("~/Pages/Shared/_MasterDetailTemplate.cshtml", cfg)
}

@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", Model.FieldDictList, ViewData)
<script src="~/js/fieldDictModal.js"></script>

@if (cfg != null)
{
<script>
(() => {
  const domId = '@(cfg.DomId ?? "md_spo00013")';
  const detailBodyId = `${domId}-d-body`;

  const parseSerial = (td) => {
    if (!td) return null;
    const edit = td.querySelector('.cell-edit');
    const view = td.querySelector('.cell-view');
    const raw = (edit?.value ?? edit?.dataset.raw ?? view?.textContent ?? "").trim();
    const num = parseInt(raw, 10);
    return Number.isNaN(num) ? null : num;
  };

  const nextSerial = () => {
    const body = document.getElementById(detailBodyId);
    if (!body) return 1;
    let max = 0;
    body.querySelectorAll('td[data-field="SerialNum"]').forEach(td => {
      const n = parseSerial(td);
      if (n !== null && n > max) max = n;
    });
    return max + 1;
  };

  const fillSerial = (tr) => {
    if (!tr) return;
    const input = tr.querySelector('input[name="SerialNum"]');
    if (!input || (input.value ?? "").trim() !== "") return;
    const val = nextSerial();
    input.value = val;
    if (!input.defaultValue) input.defaultValue = String(val);
    const span = tr.querySelector('td[data-field="SerialNum"] .cell-view');
    if (span) span.textContent = val;
  };

  const wireObserver = () => {
    const body = document.getElementById(detailBodyId);
    if (!body) return;

    const applyAll = () => {
      body.querySelectorAll('tr[data-state="added"]').forEach(fillSerial);
    };

    applyAll();
    const obs = new MutationObserver(() => applyAll());
    obs.observe(body, { childList: true });
  };

  document.addEventListener('DOMContentLoaded', wireObserver);
  document.addEventListener('md-master-selected', () => setTimeout(wireObserver, 0));
})();
</script>
}
