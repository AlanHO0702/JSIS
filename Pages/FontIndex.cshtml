@page "/FontIndex"
@model PcbErpApi.Pages.FontIndexModel
@{
    var level0 = Model.Level0Items;
    var level1Map = Model.Level1Map;
    var level2List = Model.GetCurrentLevel2();
    Layout = "_Layout";
    ViewData["Title"] = "ä¸»é¸å–®";

    var pageMap = new Dictionary<string, string> {
        {"SPO00003", "/SPO/SPO00003"}, // éŠ·å”®è¨‚å–®æŸ¥è©¢
        {"SPO00013","/SPO/SPO00013" },  // éŠ·å”®åƒ¹æ ¼è¡¨
        {"SPO00040", "/SPO/SPO00040"},// éŠ·å”®åƒ¹æ ¼è¡¨(å–®ä¸€grid)
        {"MPH00052", "/MPH/MPH00052"},// æ¡è³¼åƒ¹æ ¼è¡¨(å–®ä¸€grid)
        {"CUR00012", "/CUR/CURdSysParams"},
        {"CURH0003", "/CUR/CURdV_SysProcess"},
        {"CUR00004", "/CUR/NoticeBoard"},
        {"MP000022", "/CCS/MP000022"},
        {"MG000006", "/CPN/MGNdSetNum"},
        {"MG000008", "/CPN/MG000008"},
        {"CPN00006", "/CPN/CPN00006"},
        {"MG000002", "/CPN/MG000002"},
        {"CPN00007", "/CPN/CPN00007"},
        {"CFW00005", "/AJN/AJNdDepart"},
        {"CPN00009", "/CPN/MGNdSpecDemand"},
        {"AA000008", "/AJN/AJNdAccListEdit"},
        {"AJN00069", "/AJN/AJNdSysSummary"},
        {"EMO00004", "/EMOdProdInfo" },
        {"EMO00018", "/EMOdProdInfo?mode=view" },  // å·¥ç¨‹è³‡æ–™æŸ¥è©¢
        {"AJ000005", "/AJN/AJNdBalance"},
        {"AJN00001", "/AJN/AJNdBalanceSet"},
        // å…¶å®ƒåŠŸèƒ½è«‹è‡ªè¡ŒåŠ å…¥...
    };

    Dictionary<int, int> systemMap = new()
    {
        {1, 1},   // éŠ·å”®å®¢æˆ¶
        {2, 2},   // åŸç‰©æ–™å» å•†
        {3, 3},   // è£½ç¨‹å§”å¤–å» å•†
        {4, 4},   // è£½ä»¤å§”å¤–å» å•†
        {5, 5},   // é€²å‡ºå£å» å•†
        {6, 6},   // å…¶å®ƒå» å•†
        {7, 7},   // ç¶“éŠ·å•†
        {9, 9},   // è‡¨æ™‚å®¢æˆ¶
        {103, 1}  // å®¢æˆ¶æˆä¿¡é¡åº¦è¨­å®š -> è¦–ç‚ºéŠ·å”®å®¢æˆ¶
    };

    int? ResolveCompanySystem(object? powerTypeObj)
    {
        try
        {
            if (powerTypeObj == null) return null;
            var valStr = powerTypeObj.ToString();
            if (string.IsNullOrWhiteSpace(valStr)) return null;
            if (!int.TryParse(valStr, out var pt)) return null;
            return systemMap.TryGetValue(pt, out var sys) ? sys : null;
        }
        catch { return null; }
    }

    string? ResolveCompanyLink(dynamic item)
    {
        try
        {
            var cls = (item?.ClassName ?? string.Empty).ToString().Trim();
            if (!cls.Equals("CCSdCompanyDLL.dll", StringComparison.OrdinalIgnoreCase))
                return null;
            var sysId = ResolveCompanySystem(item?.PowerType);
            if (!sysId.HasValue) return null;
            return $"/CCS/CC000054/{sysId.Value}";
        }
        catch { return null; }
    }

    string ResolveItemHint(PcbErpApi.Models.CurdSysItem item)
    {
        if (pageMap.TryGetValue(item.ItemId, out var hardPath) && !string.IsNullOrWhiteSpace(hardPath))
            return hardPath;

        var companyLink = ResolveCompanyLink(item);
        if (!string.IsNullOrWhiteSpace(companyLink))
            return companyLink;

        var ocx = item.Ocxtemplete?.Trim().ToLowerInvariant() ?? "";

        if (item.ItemType == 6)
        {
            if (ocx.Contains("jsdpaper3ldll")) return "Paper3L";
            if (ocx.Contains("jsdpaperorgdll")) return "Paper";
            if (ocx.Contains("jsdsinglegriddll")) return "SingleGrid";
            if (ocx.Contains("jsdgriddll")) return "MultiGrid";
            if (ocx.Contains("jsdmasdtldll")) return "MasterDetail";
            if (ocx.Contains("jsdmasmultidtldll")) return "MasterMultiDetail";
        }

        if (item.ItemType == 2 && item.OutputType == 0) return "Report(Direct)";
        if (item.ItemType == 2 && item.OutputType == 6) return "Report(Generic)";

        return "æœªè¨­å®š";
    }
    
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<style>
body {
    background: #f4f6fb;
    font-family: "Noto Sans TC", "Microsoft JhengHei", Arial, sans-serif;
    overflow-y: hidden;
    height: 100vh;
}
.erp-sidebar {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 10px #0001;
    padding: 8px 12px 8px 16px;
    height: calc(100vh - 60px);
    display: flex;
    flex-direction: column;
}
.erp-sidebar h4 {
    color: #333;
    font-weight: bold;
    margin-bottom: 2px;
    font-size: 1rem;
    letter-spacing: 2px;
    flex-shrink: 0;
    text-align: center;
}
.erp-nav-group {
    overflow-y: auto;
    overflow-x: hidden;
    flex: 1;
    padding-left: 0;
}
.erp-nav-group li {
    margin-bottom: 0px;
}
.erp-nav-group a {
    display: flex;
    align-items: center;
    border-radius: 6px;
    padding: 1px 8px;
    color: #2766b5;
    font-weight: 500;
    font-size: 0.9rem;
    background: transparent;
    transition: background 0.13s, color 0.13s;
    text-decoration: none;
    line-height: 1.1;
}
.erp-nav-group a:hover, .erp-nav-group a.active {
    background: #e7f1fd;
    color: #124684;
    text-decoration: none;
}
.erp-nav-group .icon {
    font-size: 1.1rem;
    margin-right: 6px;
    color: #60a4e0;
}
.erp-card {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 2px 10px #0001;
    padding: 6px 16px 12px 16px;
    height: calc(100vh - 60px);
    display: flex;
    flex-direction: column;
}
.erp-list-title {
    font-weight: bold;
    color: #333;
    letter-spacing: 2px;
    font-size: 1rem;
    margin-bottom: 0.3rem;
    margin-top: 0.2rem;
    flex-shrink: 0;
    text-align: center;
}
.erp-list-group {
    overflow-y: auto;
    overflow-x: hidden;
    flex: 1;
}
.erp-list-group .list-group-item {
    border: none;
    padding: 2px 10px;
    font-size: 0.88rem;
    transition: background 0.1s;
    background: transparent;
    cursor: pointer;
    line-height: 1.2;
}
.erp-list-group .list-group-item:hover {
    background: #f0f8ff;
}
.erp-list-group .list-group-item a,
#favorite-list a {
    color: #333 !important;
    text-decoration: none !important;
    transition: color 0.15s, text-decoration 0.15s;
}
.erp-list-group .list-group-item a:hover,
#favorite-list a:hover {
    color: #155cb5 !important;
    text-decoration: underline !important;
}

.system-graph-frame{
    background: #f8fbff;
    border: 1px solid #e5eaf2;
    border-radius: 12px;
    padding: 10px;
}
#systemGraphImg{
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    display: block;
}
/* æˆ‘çš„æœ€æ„›å€å¡Šå°ˆç”¨ï¼šå»åº•ç·šï¼Œhoverå†å‡ºç¾ */
#favorite-list a {
    color: #2766b5;
    text-decoration: none;
    transition: color 0.15s, text-decoration 0.15s;
}
#favorite-list a:hover {
    color: #155cb5;
    text-decoration: underline;
}
/* æ‹–æ›³ç›¸é—œæ¨£å¼ */
.draggable-item {
    cursor: grab;
}
.draggable-item:active {
    cursor: grabbing;
}
.draggable-item.dragging {
    opacity: 0.5;
    background: #e3f0ff;
}
.favorite-drop-zone {
    transition: all 0.2s ease;
}
.favorite-drop-hint {
    color: #999;
    text-align: center;
    padding: 20px;
    font-size: 0.95rem;
    flex-shrink: 0;
}
.favorite-drop-zone.drag-over {
    background: #e7f1fd;
    border: 2px dashed #2766b5;
    border-radius: 8px;
}
#systemGraphPanel {
    flex-shrink: 0;
    margin-bottom: 12px;
}
/* ç•¶é¡¯ç¤ºç³»çµ±æµç¨‹åœ–æ™‚ï¼Œéš±è—åŠŸèƒ½åˆ—è¡¨æ¨™é¡Œå’Œåˆ†éš”ç·š */
.erp-card.show-graph #functionListTitleBar {
    display: none !important;
}
.erp-card.show-graph #functionListDivider {
    display: none !important;
}
.system-graph-frame {
    background: #f8fbff;
    border: 1px solid #e5eaf2;
    border-radius: 12px;
    padding: 10px;
}
#systemGraphImg {
    width: 100%;
    max-height: calc((100vh - 60px) * 0.78);
    display: block;
    object-fit: fill;
}
/* å¾…è¾¦äº‹é …çµ±è¨ˆæ¨£å¼ */
.todo-stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
}
.todo-stat-item {
    display: flex;
    align-items: center;
    padding: 4px 8px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.2s;
    cursor: pointer;
    border: 1px solid transparent;
}
.todo-stat-item:hover {
    background: #fff;
    border-color: #e0e6ed;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transform: translateY(-1px);
}
.todo-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 6px;
    flex-shrink: 0;
}
.todo-icon svg {
    width: 18px;
    height: 18px;
}
.todo-info {
    flex: 1;
    min-width: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.todo-label {
    font-size: 0.82rem;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.todo-count {
    font-size: 0.95rem;
    font-weight: bold;
    color: #333;
    margin-left: 3px;
    flex-shrink: 0;
}
/* ç¸®å°åˆ—è¡¨é …ç›®ä¸­çš„æŒ‰éˆ• */
.erp-list-group .btn-sm {
    padding: 2px 6px;
    font-size: 0.78rem;
    line-height: 1.4;
    min-height: 22px;
}
/* å¿«é€Ÿå•Ÿå‹•ç›¸é—œæ¨£å¼ */
#quickStartTableBody tr {
    cursor: pointer;
    transition: background-color 0.15s ease;
}
#quickStartTableBody tr:hover {
    background-color: #e7f1fd !important;
}
.table-hover #quickStartTableBody tr.selected,
#quickStartTableBody tr.selected {
    background-color: #b8d9f7 !important;
}
.table-hover #quickStartTableBody tr.selected:hover,
#quickStartTableBody tr.selected:hover {
    background-color: #b8d9f7 !important;
}
</style>

<div class="container" style="padding: 0.5rem 0.75rem;">
    <div class="row gx-4">
        <!-- å·¦å´ç³»çµ±æ¨¡çµ„ -->
        <div class="col-12 col-md-3 mb-4">
            <div class="erp-sidebar">
                <h4>ç³»çµ±æ¨¡çµ„</h4>
                <hr style="margin: 0 0 8px 0; border-top: 2px solid #555;">
                <ul class="erp-nav-group" style="list-style: none; padding-left: 0;">
                    @foreach (var mod0 in level0)
                    {
                        var level1Id = $"level1-{mod0.ItemId}";
                        var shouldExpand = level1Map.ContainsKey(mod0.ItemId) && level1Map[mod0.ItemId].Any(x => x.ItemId == Model.SelectedLevel1Id);
                        <li>
                            <a href="javascript:void(0)" onclick="toggleChildren('@level1Id','@mod0.ItemId','@mod0.ItemName')">
                                <span class="icon">ğŸ“</span>
                                <span style="white-space:nowrap; font-size: 0.9rem;">
                                    <span style="display: inline-block; min-width: 26px; font-family: 'Consolas', 'Courier New', monospace; font-weight: bold; margin-right: 6px;">@mod0.ItemId</span>=<span style="margin-left: 6px;">@mod0.ItemName</span>
                                </span>
                            </a>
                            @if (level1Map.ContainsKey(mod0.ItemId))
                            {
                                <ul id="@level1Id" class="ms-3 mt-0 mb-0" style="display: @(shouldExpand ? "block" : "none"); list-style:none;">
                                    @foreach (var mod1 in level1Map[mod0.ItemId])
                                    {
                                        <li>
                                            <a asp-page="/FontIndex" asp-route-level1Id="@mod1.ItemId" style="color: #548bc7; font-size:0.88rem; font-weight:400; margin:0; padding: 1px 0;">
                                                <span class="icon">â¡ï¸</span>@mod1.ItemName
                                            </a>
                                        </li>
                                    }
                                </ul>
                            }
                        </li>
                    }
                </ul>
            </div>
        </div>

        <!-- ä¸­é–“ï¼šåŠŸèƒ½åˆ—è¡¨ + å¾…è¾¦äº‹é … -->
        <div class="col-12 col-md-5 mb-4">
            <!-- åŠŸèƒ½åˆ—è¡¨ -->
            <div class="erp-card mb-2" style="height: calc((100vh - 60px) * 0.84 - 8px);">
                <div class="d-flex align-items-center justify-content-center mb-1" id="functionListTitleBar">
                    <h4 class="erp-list-title mb-0">åŠŸèƒ½åˆ—è¡¨</h4>
                    <div class="d-flex align-items-center" id="systemGraphTitleBar" style="display:none;">
                        <div id="systemGraphTitle" class="text-secondary fw-semibold me-2" style="font-size: 0.95rem;"></div>
                        <a id="systemGraphOpen" class="btn btn-sm btn-outline-primary" href="#" target="_blank" rel="noopener" style="display:none;">é–‹æ–°è¦–çª—</a>
                    </div>
                </div>
                <hr id="functionListDivider" style="margin: 0 0 8px 0; border-top: 2px solid #555;">

                <div id="systemGraphPanel" class="mb-1" style="display:none;">
                    <div class="system-graph-frame">
                        <img id="systemGraphImg" alt="ç³»çµ±æµç¨‹åœ–" style="display:none;" />
                        <div id="systemGraphEmpty" class="text-secondary small" style="display:none;">å°šæœªæä¾›æµç¨‹åœ–</div>
                    </div>
                </div>

                @if (level2List.Any())
                {
                   <ul id="level2-list" class="list-group erp-list-group">
                    @foreach (var item in level2List)
                    {
                        if (item.ItemType == 4)
                        {
                            <li class="list-group-item p-0" id="li-@item.ItemId">
                                <hr style="border: none; border-top: 2px dotted #000; margin: 4px 0; background: transparent; height: 0;" />
                            </li>
                        }
                        else
                        {
                            var ocx = item.Ocxtemplete?.Trim().ToLowerInvariant() ?? "";
                            var link = pageMap.ContainsKey(item.ItemId)
                             ? pageMap[item.ItemId]
                             : ResolveCompanyLink(item) // å…¬å¸/å» å•†ä¸»æª”æ¨£æ¿
                             ?? (item.ItemType == 2 && item.OutputType == 0 ? $"/Report/Direct/{item.ItemId}"
                                : item.ItemType == 6 && ocx.Contains("jsdpaper3ldll") ? $"/DynamicTemplate/Paper3L/{item.ItemId}"
                                : item.ItemType == 6 && ocx.Contains("jsdpaperorgdll") ? $"/DynamicTemplate/Paper/{item.ItemId}"
                                : item.ItemType == 6 && ocx.Contains("jsdsinglegriddll") ? $"/CUR/SingleGrid/{item.ItemId}"
                                : item.ItemType == 6 && ocx.Contains("jsdgriddll") ? $"/CUR/MultiGrid/{item.ItemId}"
                                : item.ItemType == 6 && ocx.Contains("jsdmasdtldll") ? $"/CUR/MasterDetail/{item.ItemId}"
                                : item.ItemType == 6 && ocx.Contains("jsdmasmultidtldll") ? $"/CUR/MasterMultiDetail/{item.ItemId}"
                                : null);

                            var hint = ResolveItemHint(item);

                            <li class="list-group-item d-flex justify-content-between align-items-center draggable-item"
                                id="li-@item.ItemId"
                                draggable="true"
                                data-itemid="@item.ItemId"
                                data-itemname="@item.ItemName"
                                data-superid="@item.SuperId"
                                data-classname="@(item.ClassName ?? string.Empty)"
                                data-powertype="@(item.PowerType?.ToString() ?? string.Empty)"
                                data-itemtype="@item.ItemType"
                                data-link="@(link ?? "")">

                            @if (!string.IsNullOrEmpty(link)) {
                                <a href="@link" title="@hint" style="flex:1; display: flex; align-items: center;">
                                    <span style="display: inline-block; width: 90px; flex-shrink: 0; font-family: 'Consolas', monospace; font-weight: 500;">@item.ItemId</span>
                                    <span style="flex: 1;">@item.ItemName</span>
                                </a>
                            } else {
                                <a href="javascript:void(0)" title="@hint" class="dyn-link" data-itemid="@item.ItemId" data-itemname="@item.ItemName" data-superid="@item.SuperId" style="flex:1; display: flex; align-items: center;" onclick="resolveAndGo('@item.ItemId','@item.ItemName','@item.SuperId')">
                                    <span style="display: inline-block; width: 90px; flex-shrink: 0; font-family: 'Consolas', monospace; font-weight: 500;">@item.ItemId</span>
                                    <span style="flex: 1;">@item.ItemName</span>
                                </a>
                            }
                                <button class="btn btn-outline-primary btn-sm" title="é–‹å•Ÿæ–°è¦–çª—" onclick="openInNewWindow('@item.ItemId','@item.ItemName','@item.SuperId','@(item.ClassName ?? string.Empty)','@(item.PowerType?.ToString() ?? string.Empty)')">â§‰</button>
                            </li>
                        }
                    }
                    </ul>
                }
                else
                {
                    <p class="text-secondary mt-4">è«‹å¾å·¦å´å±•é–‹æ¨¡çµ„ä¸¦é¸æ“‡å­æ¨¡çµ„æŸ¥çœ‹åŠŸèƒ½</p>
                }
            </div>

            <!-- å¾…è¾¦äº‹é … -->
            <div class="erp-card" style="height: calc((100vh - 60px) * 0.16 ); padding: 10px 8px 10px 8px;">
                <div class="todo-stats-grid">
                    <div class="todo-stat-item" onclick="goToPendingApprovals()">
                        <div class="todo-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="todo-info">
                            <div class="todo-label">ç°½æ ¸å¾…å¯©</div>
                            <div class="todo-count" id="todo-pending-sign">0</div>
                        </div>
                    </div>

                    <div class="todo-stat-item" onclick="goToMessages()">
                        <div class="todo-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="17" cy="7" r="3" fill="#ff4757"/>
                            </svg>
                        </div>
                        <div class="todo-info">
                            <div class="todo-label">è¨Šæ¯æœªè®€</div>
                            <div class="todo-count" id="todo-messages">0</div>
                        </div>
                    </div>

                    <div class="todo-stat-item" onclick="goToWorkingList()">
                        <div class="todo-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="todo-info">
                            <div class="todo-label">æœªå®Œæˆå–®æ“š</div>
                            <div class="todo-count" id="todo-pending-docs">0</div>
                        </div>
                    </div>

                    <div class="todo-stat-item" onclick="goToPendingNotifications()">
                        <div class="todo-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="18" cy="6" r="3" fill="#ff4757"/>
                            </svg>
                        </div>
                        <div class="todo-info">
                            <div class="todo-label">ç°½æ ¸é€šçŸ¥</div>
                            <div class="todo-count" id="todo-notifications">0</div>
                        </div>
                    </div>

                    <div class="todo-stat-item" onclick="goToMessageSend()">
                        <div class="todo-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M3 12l18-9-9 18-3-9-9-3z" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="todo-info">
                            <div class="todo-label">è¨Šæ¯ç™¼é€</div>
                        </div>
                    </div>

                    <div class="todo-stat-item" onclick="goToNoticeBoard()">
                        <div class="todo-icon" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke="#ff6b6b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9 15h2v2H9v-2z" fill="#ff6b6b"/>
                            </svg>
                        </div>
                        <div class="todo-info">
                            <div class="todo-label">ä½ˆå‘Šæ¬„</div>
                            <div class="todo-count" id="todo-announcements">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³å´æˆ‘çš„æœ€æ„› + å•Ÿå‹•ç¨‹å¼ -->
        <div class="col-12 col-md-4 mb-4">
            <!-- æˆ‘çš„æœ€æ„› -->
            <div class="erp-card favorite-drop-zone mb-2" id="favorite-drop-zone" style="height: calc((100vh - 60px) * 0.84 - 8px);">
                <h5 class="erp-list-title mb-0">â˜… æˆ‘çš„æœ€æ„›</h5>
                <hr style="margin: 6px 0 8px 0; border-top: 2px solid #555;">
                <div id="favorite-drop-hint" class="favorite-drop-hint">æ‹–æ›³åŠŸèƒ½é …ç›®åˆ°æ­¤è™•åŠ å…¥æˆ‘çš„æœ€æ„›</div>
                <ul id="favorite-list" class="list-group erp-list-group"></ul>
            </div>

            <!-- å•Ÿå‹•ç¨‹å¼ -->
            <div class="erp-card" style="height: calc((100vh - 60px) * 0.16); padding: 10px 12px;">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <input type="text" id="quickStartInput" class="form-control form-control-sm"
                           placeholder="åŠŸèƒ½ä»£ç¢¼"
                           autocomplete="off"
                           style="font-size: 0.9rem; padding: 4px 8px; height: 32px; width: 130px; font-family: 'Consolas', monospace;">
                    <button type="button" id="quickStartNameBtn" class="btn btn-outline-secondary btn-sm"
                            style="flex: 1; font-size: 0.9rem; padding: 4px 12px; height: 32px; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    </button>
                </div>
                <button type="button" id="quickStartLaunchBtn" class="btn btn-outline-secondary btn-sm w-100"
                        style="font-size: 0.85rem; padding: 5px 12px;">
                    å•Ÿå‹•ç¨‹å¼
                </button>
            </div>
        </div>
    </div>
</div>

<!-- åç¨±æŸ¥è©¢ Modal -->
<div class="modal fade" id="quickStartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="width: 450px; max-width: 450px;">
        <div class="modal-content">
            <div class="modal-header" style="padding: 10px 16px;">
                <h5 class="modal-title" style="font-size: 1rem;">åç¨±æŸ¥è©¢</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 12px 16px; height: 500px; display: flex; flex-direction: column;">
                <!-- å³æ™‚ç¯©é¸ -->
                <div class="row mb-3 gx-2">
                    <div class="col-6">
                        <label class="form-label" style="font-size: 0.85rem; margin-bottom: 4px;">ItemId</label>
                        <input type="text" id="quickStartFilterInput" class="form-control form-control-sm"
                               placeholder="å³æ™‚ç¯©é¸"
                               autocomplete="off"
                               style="font-size: 0.9rem;">
                    </div>
                    <div class="col-6">
                        <label class="form-label" style="font-size: 0.85rem; margin-bottom: 4px;">ProgramName</label>
                        <input type="text" id="quickStartFilterInput2" class="form-control form-control-sm"
                               placeholder="å³æ™‚ç¯©é¸"
                               autocomplete="off"
                               style="font-size: 0.9rem;">
                    </div>
                </div>

                <!-- è³‡æ–™åˆ—è¡¨ -->
                <div id="quickStartListContainer" style="border: 1px solid #d1d5db; border-radius: 6px; flex: 1; overflow-y: auto; background: #fff; margin-bottom: 12px;">
                    <table class="table table-sm table-hover mb-0" style="font-size: 0.85rem;">
                        <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 1;">
                            <tr>
                                <th style="width: 100px; padding: 6px 8px;">ItemId</th>
                                <th style="padding: 6px 8px;">ProgramName</th>
                            </tr>
                        </thead>
                        <tbody id="quickStartTableBody">
                            <tr>
                                <td colspan="2" class="text-center text-muted" style="padding: 20px;">è¼‰å…¥ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- æŸ¥è©¢å€å¡Š -->
                <div class="d-flex gap-2">
                    <input type="text" id="quickStartSearchInput" class="form-control form-control-sm"
                           placeholder="æ¨¡ç³ŠæŸ¥è©¢"
                           autocomplete="off"
                           style="font-size: 0.9rem; flex: 1;">
                    <button type="button" id="quickStartSearchBtn" class="btn btn-primary btn-sm"
                            style="font-size: 0.9rem; padding: 4px 16px;">
                        æŸ¥è©¢
                    </button>
                </div>
            </div>
            <div class="modal-footer" style="padding: 10px 16px;">
                <button type="button" id="quickStartConfirmBtn" class="btn btn-primary btn-sm" style="font-size: 0.9rem;">ç¢ºå®š</button>
                <button type="button" class="btn btn-danger btn-sm" data-bs-dismiss="modal" style="font-size: 0.9rem;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<script>
    const pageMap = {
    "SPO00003": "/SPO/SPO00003",
    "SPO00013": "/SPO/SPO00013",
    "SPO00040": "/SPO/SPO00040",
    "MPH00052": "/MPH/MPH00052",
    "CUR00012": "/CUR/CURdSysParams",
    "CURH0003": "/CUR/CURdV_SysProcess",
    "CUR00004": "/CUR/NoticeBoard",
    "FPE00004": "/EMOdProcInfo/Index",
    "QC000209": "/FQCdProcInfo/Index",
    "MP000022": "/CCS/MP000022",
    "MG000006": "/CPN/MGNdSetNum",
    "MG000008": "/CPN/MG000008",
    "CPN00006": "/CPN/CPN00006",
    "MG000002": "/CPN/MG000002",
    "CPN00007": "/CPN/CPN00007",
    "CFW00005": "/AJN/AJNdDepart",
    "CPN00009": "/CPN/MGNdSpecDemand",
    "AA000008": "/AJN/AJNdAccListEdit",
    "AJN00069": "/AJN/AJNdSysSummary",
    "EMO00004":  "/EMOdProdInfo",
    "EMO00018":  "/EMOdProdInfo?mode=view",  // å·¥ç¨‹è³‡æ–™æŸ¥è©¢
    "AJ000005": "/AJN/AJNdBalance",
    "AJN00001": "/AJN/AJNdBalanceSet",
    // å…¶å®ƒåŠŸèƒ½è‡ªè¡Œè£œä¸Š
    };

    function getSystemIdFromPowerType(ptRaw) {
        if (ptRaw === null || ptRaw === undefined) return null;
        const num = parseInt(ptRaw, 10);
        if (Number.isNaN(num)) return null;
        const map = {
            1: 1,  // éŠ·å”®å®¢æˆ¶
            2: 2,  // åŸç‰©æ–™å» å•†
            3: 3,  // è£½ç¨‹å§”å¤–å» å•†
            4: 4,  // è£½ä»¤å§”å¤–å» å•†
            5: 5,  // é€²å‡ºå£å» å•†
            6: 6,  // å…¶å®ƒå» å•†
            7: 7,  // ç¶“éŠ·å•†
            9: 9,  // è‡¨æ™‚å®¢æˆ¶
            103: 1 // å®¢æˆ¶æˆä¿¡é¡åº¦ -> è¦–ç‚ºéŠ·å”®å®¢æˆ¶
        };
        return map[num] ?? null;
    }

    function resolveCompanyLinkFromMeta(meta) {
        if (!meta) return null;
        const cls = String(meta.className ?? meta.ClassName ?? "").trim().toLowerCase();
        if (cls !== "ccsdcompanydll.dll") return null;
        const pt = meta.powerType ?? meta.PowerType;
        const sysId = getSystemIdFromPowerType(pt);
        if (!sysId) return null;
        return `/CCS/CC000054/${sysId}`;
    }

    const itemHintCache = new Map();

    function getTemplateNameFromMeta(meta, itemId) {
        const hard = pageMap[itemId];
        if (hard) return hard;

        const companyLink = resolveCompanyLinkFromMeta(meta);
        if (companyLink) return companyLink;

        const itemType = Number(meta?.itemType ?? meta?.ItemType);
        const outputType = Number(meta?.outputType ?? meta?.OutputType);

        const pickStr = (obj, keys) => {
            for (const k of keys) {
                if (obj && obj[k] !== undefined && obj[k] !== null) return obj[k];
            }
            return '';
        };
        const ocxRaw = pickStr(meta, [
            'ocxtemplete', 'Ocxtemplete', 'OCXTemplete', 'ocxTemplete', 'OCXTemplete',
            'ocxTemplate', 'OCXTemplate', 'ocxtemplate', 'OCXTEMPLATE',
            'OCX', 'ocx'
        ]);
        const ocx = String(ocxRaw).trim().toLowerCase();

        if (itemType === 6) {
            if (ocx.includes('jsdpaper3ldll')) return 'Paper3L';
            if (ocx.includes('jsdpaperorgdll')) return 'Paper';
            if (ocx.includes('jsdsinglegriddll')) return 'SingleGrid';
            if (ocx.includes('jsdgriddll')) return 'MultiGrid';
            if (ocx.includes('jsdmasdtldll')) return 'MasterDetail';
            if (ocx.includes('jsdmasmultidtldll')) return 'MasterMultiDetail';
        }

        if (itemType === 2 && outputType === 0) return 'Report(Direct)';
        if (itemType === 2 && outputType === 6) return 'Report(Generic)';

        return 'æœªè¨­å®š';
    }

    function getLocalHint(itemId, className, powerType) {
        const hard = pageMap[itemId];
        if (hard) return hard;
        const localMeta = { ClassName: className, PowerType: powerType };
        const companyLink = resolveCompanyLinkFromMeta(localMeta);
        return companyLink || null;
    }

    async function getItemHint(itemId, className, powerType) {
        const key = `${itemId}|${className ?? ''}|${powerType ?? ''}`;
        if (itemHintCache.has(key)) return itemHintCache.get(key);

        const local = getLocalHint(itemId, className, powerType);
        if (local) {
            itemHintCache.set(key, local);
            return local;
        }

        try {
            const res = await fetch(`/api/report/item-meta/${itemId}`);
            if (!res.ok) throw new Error('meta not found');
            const meta = await res.json();
            const hint = getTemplateNameFromMeta(meta, itemId);
            itemHintCache.set(key, hint);
            return hint;
        } catch {
            const hint = 'æœªè¨­å®š';
            itemHintCache.set(key, hint);
            return hint;
        }
    }

    async function loadHintOnHover(el, itemId, className, powerType) {
        if (!el) return;
        el.title = await getItemHint(itemId, className, powerType);
    }

    const selectedLevel1Id = "@Model.SelectedLevel1Id";

    async function resolveAndGo(itemId, itemName, superId, className, powerType) {
        console.debug('resolveAndGo click', { itemId, itemName, superId });
        const hard = pageMap[itemId];
        if (hard) { location.href = hard; return; }

        // å…ˆå˜—è©¦æœ¬åœ° className/powerType æ˜ å°„ï¼ˆæˆ‘çš„æœ€æ„›å¯å¸¶é€²ä¾†ï¼‰
        const localMeta = { ClassName: className, PowerType: powerType };
        const localLink = resolveCompanyLinkFromMeta(localMeta);
        if (localLink) { location.href = localLink; return; }

        try {
            const metaUrl = `/api/report/item-meta/${itemId}`;
            console.debug('fetch meta', metaUrl);
            const res = await fetch(metaUrl);
            if (!res.ok) throw new Error('not found');
            const meta = await res.json();

            // è‹¥æœ‰å¾ my favorites è§¸ç™¼ï¼Œè£œé½Šä¸¦å›å­˜ class/power/superIdï¼Œé¿å…ä¸‹æ¬¡ç¼ºè³‡æ–™
            try {
                const favs = getFavorites();
                const idx = favs.findIndex(f => f.itemId === itemId);
                if (idx >= 0) {
                    const mClass = meta.ClassName ?? meta.className ?? '';
                    const mPower = meta.PowerType ?? meta.powerType ?? '';
                    const mSuper = meta.SuperId ?? meta.superId ?? superId ?? '';
                    favs[idx].className = mClass?.toString() ?? '';
                    favs[idx].powerType = mPower?.toString() ?? '';
                    favs[idx].superId = mSuper?.toString() ?? favs[idx].superId ?? '';
                    setFavorites(favs);
                }
            } catch (err) { console.warn('favorite meta backfill failed', err); }

            const companyLink = resolveCompanyLinkFromMeta(meta);
            if (companyLink) { location.href = companyLink; return; }

            const itemType = Number(meta.itemType ?? meta.ItemType);
            const outputType = Number(meta.outputType ?? meta.OutputType);
            const pickStr = (obj, keys) => {
                for (const k of keys) {
                    if (obj && obj[k] !== undefined && obj[k] !== null) return obj[k];
                }
                return '';
            };
            const ocxRaw = pickStr(meta, [
                'ocxtemplete','Ocxtemplete','OCXTemplete','ocxTemplete','OCXTemplete',
                'ocxTemplate','OCXTemplate','ocxtemplate','OCXTEMPLATE',
                'OCX','ocx'
            ]);
            const ocx = String(ocxRaw).trim().toLowerCase();
            let url = '';
            if (itemType === 2 && outputType === 0) url = `/Report/Direct/${itemId}`;
            else if (itemType === 2 && outputType === 6) url = `/Report/Generic/${itemId}`;
            else if (itemType === 6 && (ocx === 'jsdpaper3ldll.dll' || ocx.includes('jsdpaper3ldll'))) url = `/DynamicTemplate/Paper3L/${itemId}`;
            else if (itemType === 6 && (ocx === 'jsdpaperorgdll.dll' || ocx.includes('jsdpaperorgdll'))) url = `/DynamicTemplate/Paper/${itemId}`;
            else if (itemType === 6 && (ocx === 'jsdsinglegriddll.dll' || ocx.includes('jsdsinglegriddll'))) url = `/CUR/SingleGrid/${itemId}`;
            else if (itemType === 6 && (ocx === 'jsdgriddll.dll' || ocx.includes('jsdgriddll'))) url = `/CUR/MultiGrid/${itemId}`;
            else if (itemType === 6 && (ocx === 'jsdmasdtldll.dll' || ocx.includes('jsdmasdtldll'))) url = `/CUR/MasterDetail/${itemId}`;
            else if (itemType === 6 && (ocx === 'jsdmasmultidtldll.dll' || ocx.includes('jsdmasmultidtldll'))) url = `/CUR/MasterMultiDetail/${itemId}`;

            if (url) { location.href = url; return; }
            if (superId) { location.href = `?level1Id=${superId}`; return; }
        } catch (err) {
            console.warn('resolveAndGo meta error', err);
        }
        if (superId) {
            location.href = `?level1Id=${superId}`;
        } else {
            alert(`æ‰¾ä¸åˆ°å°æ‡‰çš„é é¢: ${itemId}`);
        }
    }
    function showSystemGraph(systemId, systemName) {
        const panel = document.getElementById('systemGraphPanel');
        const titleBar = document.getElementById('systemGraphTitleBar');
        const functionListTitleBar = document.getElementById('functionListTitleBar');
        const img = document.getElementById('systemGraphImg');
        const empty = document.getElementById('systemGraphEmpty');
        const title = document.getElementById('systemGraphTitle');
        const open = document.getElementById('systemGraphOpen');
        const list = document.getElementById('level2-list');
        if (!panel || !img || !empty || !title || !open || !titleBar) return;

        const sid = (systemId || '').toString().trim();
        if (!sid) return;

        panel.style.display = 'block';

        // çµ¦å®¹å™¨æ·»åŠ  show-graph é¡ä¾†éš±è—æ¨™é¡Œ
        const card = panel.closest('.erp-card');
        if (card) card.classList.add('show-graph');

        // é¡¯ç¤ºæµç¨‹åœ–æ™‚ï¼ŒåŠŸèƒ½æ¸…å–®ä¹Ÿè¦éš±è—
        if (list) list.style.display = 'none';

        const nameParam = (systemName || '').toString().trim();
        const url = `/api/SystemGraph/${encodeURIComponent(sid)}?name=${encodeURIComponent(nameParam)}&t=${Date.now()}`;
        open.href = url;
        open.style.display = 'none';
        img.style.display = 'none';
        empty.style.display = 'none';

        img.onload = () => {
            img.style.display = 'block';
            empty.style.display = 'none';
            // åœ–ç‰‡å¯é»æ“Šé–‹æ–°è¦–çª—
            img.style.cursor = 'pointer';
            img.onclick = () => window.open(url, '_blank');
        };
        img.onerror = () => {
            img.style.display = 'none';
            open.style.display = 'none';
            empty.style.display = 'block';
        };
        img.src = url;
    }

    window.toggleChildren = function (id, systemId, systemName) {
        const el = document.getElementById(id);
        if (el) el.style.display = el.style.display === "none" ? "block" : "none";
        if (systemId) showSystemGraph(systemId, systemName);
    };

    // ç¢ºä¿å‹•æ…‹é€£çµæœ‰äº‹ä»¶ï¼ˆè‹¥ inline onclick è¢«ç€è¦½å™¨é˜»æ“‹æˆ–å¤±æ•ˆï¼‰
    document.addEventListener('DOMContentLoaded', () => {
        document.addEventListener('click', (ev) => {
            const link = ev.target.closest('.dyn-link');
            if (!link) return;
            ev.preventDefault();
            const itemId = link.dataset.itemid || link.getAttribute('data-itemid');
            const itemName = link.dataset.itemname || link.getAttribute('data-itemname');
            const superId = link.dataset.superid || link.getAttribute('data-superid');
            const cls = link.dataset.classname || link.getAttribute('data-classname') || "";
            const pt = link.dataset.powertype || link.getAttribute('data-powertype') || "";
            resolveAndGo(itemId, itemName, superId, cls, pt);
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const addItemEl = document.getElementById('addItemModal');
        const editItemEl = document.getElementById('editItemModal');
        let addItemModal = addItemEl ? new bootstrap.Modal(addItemEl) : null;
        let editItemModal = editItemEl ? new bootstrap.Modal(editItemEl) : null;

        window.openEditModal = function (itemId, itemName, superId, itemType) {
            document.getElementById('editItemId').value = itemId;
            document.getElementById('editItemName').value = itemName;
            document.getElementById('editSuperId').value = superId;
            document.getElementById('editItemType').value = itemType;
            document.getElementById('editAlert').classList.add('d-none');
            if (editItemModal) editItemModal.show();
        };

    });
    function getFavorites() {
    return JSON.parse(localStorage.getItem('erpFavorites') || '[]');
        }

        function setFavorites(favs) {
            localStorage.setItem('erpFavorites', JSON.stringify(favs));
        }

        function addToFavorite(itemId, itemName, superId, className, powerType, itemType) {
            let favs = getFavorites();
            if (!favs.find(x => x.itemId === itemId)) {
                favs.push({ itemId, itemName, superId, className, powerType, itemType });
                setFavorites(favs);
                renderFavorites();
            }
        }

        function removeFavorite(itemId) {
            let favs = getFavorites().filter(x => x.itemId !== itemId);
            setFavorites(favs);
            renderFavorites();
        }

        function renderFavorites() {
        const list = document.getElementById('favorite-list');
        const hint = document.getElementById('favorite-drop-hint');
        const favs = getFavorites();
        list.innerHTML = '';

        // é¡¯ç¤ºæˆ–éš±è—æç¤ºæ–‡å­—
        if (hint) {
            hint.style.display = favs.length === 0 ? 'block' : 'none';
        }

        favs.forEach(f => {
            let li = document.createElement('li');
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.setAttribute('data-itemid', f.itemId);
            li.setAttribute('data-itemname', f.itemName);
            li.setAttribute('data-superid', f.superId || '');
            li.setAttribute('data-classname', f.className || '');
            li.setAttribute('data-powertype', f.powerType || '');
            li.setAttribute('data-itemtype', f.itemType || '');
            const hard = pageMap[f.itemId];
            const localHint = getLocalHint(f.itemId, f.className, f.powerType);
            // é»æ“Šåœ¨åŸè¦–çª—é–‹å•Ÿï¼ŒæŒ‰éˆ•é–‹å•Ÿæ–°è¦–çª—
            const linkHtml = hard
                ? `<a href="${hard}" title="${hard}" style="cursor:pointer;flex:1;display:flex;align-items:center;">
                    <span style="display:inline-block;width:90px;flex-shrink:0;font-family:'Consolas',monospace;font-weight:500;">${f.itemId}</span>
                    <span style="flex:1;">${f.itemName}</span>
                  </a>`
                : `<a href="javascript:void(0)" title="${localHint || 'æœªè¨­å®š'}" onmouseenter="loadHintOnHover(this,'${f.itemId}','${f.className || ''}','${f.powerType || ''}')" style="cursor:pointer;flex:1;display:flex;align-items:center;" onclick="resolveAndGo('${f.itemId}','${f.itemName}','${f.superId || ''}','${f.className || ''}','${f.powerType || ''}')">
                    <span style="display:inline-block;width:90px;flex-shrink:0;font-family:'Consolas',monospace;font-weight:500;">${f.itemId}</span>
                    <span style="flex:1;">${f.itemName}</span>
                  </a>`;
            li.innerHTML = `${linkHtml}
                <button class="btn btn-outline-primary btn-sm" title="é–‹å•Ÿæ–°è¦–çª—" onclick="openInNewWindow('${f.itemId}','${f.itemName}','${f.superId || ''}','${f.className || ''}','${f.powerType || ''}')">â§‰</button>
                <button class="btn btn-outline-danger btn-sm ms-1" title="ç§»é™¤" onclick="removeFavorite('${f.itemId}')">âœ•</button>`;
            list.appendChild(li);
        });
        enableFavoriteSortable();
    }

        function enableFavoriteSortable() {
            new Sortable(document.getElementById('favorite-list'), {
                animation: 150,
                onEnd: function (evt) {
                    // é‡æ–°å–å¾—æ’åºå¾Œçš„æ‰€æœ‰ itemId
                    const ids = Array.from(document.querySelectorAll('#favorite-list li')).map(li => li.dataset.itemid);
                    // ä¾ç…§æ–°æ’åºå­˜å› localStorage
                    let favs = getFavorites();
                    let newFavs = [];
                    ids.forEach(id => {
                        let found = favs.find(x => x.itemId === id);
                        if (found) newFavs.push(found);
                    });
                    setFavorites(newFavs);
                    renderFavorites(); // é‡æ–° render ä¿è­‰é †åºåŒæ­¥
                }
            });
        }
        // é–‹å•Ÿæ–°è¦–çª—çš„å‡½æ•¸ (ç”¨æ–¼æˆ‘çš„æœ€æ„›é …ç›®)
        async function openInNewWindow(itemId, itemName, superId, className, powerType) {
            const hard = pageMap[itemId];
            if (hard) {
                window.open(hard, '_blank');
                return;
            }

            const localMeta = { ClassName: className, PowerType: powerType };
            const localLink = resolveCompanyLinkFromMeta(localMeta);
            if (localLink) {
                window.open(localLink, '_blank');
                return;
            }

            try {
                const metaUrl = `/api/report/item-meta/${itemId}`;
                const res = await fetch(metaUrl);
                if (!res.ok) throw new Error('not found');
                const meta = await res.json();

                const companyLink = resolveCompanyLinkFromMeta(meta);
                if (companyLink) {
                    window.open(companyLink, '_blank');
                    return;
                }

                const itemType = Number(meta.itemType ?? meta.ItemType);
                const outputType = Number(meta.outputType ?? meta.OutputType);
                const pickStr = (obj, keys) => {
                    for (const k of keys) {
                        if (obj && obj[k] !== undefined && obj[k] !== null) return obj[k];
                    }
                    return '';
                };
                const ocxRaw = pickStr(meta, [
                    'ocxtemplete','Ocxtemplete','OCXTemplete','ocxTemplete','OCXTemplete',
                    'ocxTemplate','OCXTemplate','ocxtemplate','OCXTEMPLATE',
                    'OCX','ocx'
                ]);
                const ocx = String(ocxRaw).trim().toLowerCase();
                let url = '';
                if (itemType === 2 && outputType === 0) url = `/Report/Direct/${itemId}`;
                else if (itemType === 2 && outputType === 6) url = `/Report/Generic/${itemId}`;
                else if (itemType === 6 && (ocx === 'jsdpaper3ldll.dll' || ocx.includes('jsdpaper3ldll'))) url = `/DynamicTemplate/Paper3L/${itemId}`;
                else if (itemType === 6 && (ocx === 'jsdpaperorgdll.dll' || ocx.includes('jsdpaperorgdll'))) url = `/DynamicTemplate/Paper/${itemId}`;
                else if (itemType === 6 && (ocx === 'jsdsinglegriddll.dll' || ocx.includes('jsdsinglegriddll'))) url = `/CUR/SingleGrid/${itemId}`;
                else if (itemType === 6 && (ocx === 'jsdgriddll.dll' || ocx.includes('jsdgriddll'))) url = `/CUR/MultiGrid/${itemId}`;
                else if (itemType === 6 && (ocx === 'jsdmasdtldll.dll' || ocx.includes('jsdmasdtldll'))) url = `/CUR/MasterDetail/${itemId}`;
                else if (itemType === 6 && (ocx === 'jsdmasmultidtldll.dll' || ocx.includes('jsdmasmultidtldll'))) url = `/CUR/MasterMultiDetail/${itemId}`;

                if (url) {
                    window.open(url, '_blank');
                    return;
                }
            } catch (err) {
                console.warn('openInNewWindow meta error', err);
            }
            alert(`æ‰¾ä¸åˆ°å°æ‡‰çš„é é¢: ${itemId}`);
        }

        // æ‹–æ›³åŠŸèƒ½
        function initDragAndDrop() {
            const dropZone = document.getElementById('favorite-drop-zone');
            const level2List = document.getElementById('level2-list');

            if (!dropZone) return;

            // ä½¿ç”¨äº‹ä»¶å§”æ´¾è™•ç†æ‹–æ›³äº‹ä»¶ (åœ¨ document å±¤ç´šæ•æ‰)
            document.addEventListener('dragstart', handleDragStart, false);
            document.addEventListener('dragend', handleDragEnd, false);

            // Drop zone äº‹ä»¶
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('dragenter', handleDragEnter);
            dropZone.addEventListener('dragleave', handleDragLeave);
            dropZone.addEventListener('drop', handleDrop);
        }

        function handleDragStart(e) {
            // æ‰¾åˆ°æœ€è¿‘çš„ .draggable-item å…ƒç´ 
            const item = e.target.closest('.draggable-item');
            if (!item) return;

            item.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', JSON.stringify({
                itemId: item.dataset.itemid,
                itemName: item.dataset.itemname,
                superId: item.dataset.superid || '',
                className: item.dataset.classname || '',
                powerType: item.dataset.powertype || '',
                itemType: item.dataset.itemtype || ''
            }));
        }

        function handleDragEnd(e) {
            const item = e.target.closest('.draggable-item');
            if (item) item.classList.remove('dragging');
            document.getElementById('favorite-drop-zone')?.classList.remove('drag-over');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            document.getElementById('favorite-drop-zone')?.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            // æª¢æŸ¥æ˜¯å¦çœŸçš„é›¢é–‹ drop zone (ä¸æ˜¯é€²å…¥å­å…ƒç´ )
            const dropZone = document.getElementById('favorite-drop-zone');
            if (dropZone && !dropZone.contains(e.relatedTarget)) {
                dropZone.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('favorite-drop-zone')?.classList.remove('drag-over');

            try {
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                if (data.itemId) {
                    addToFavorite(data.itemId, data.itemName, data.superId, data.className, data.powerType, data.itemType);
                }
            } catch (err) {
                console.warn('handleDrop error', err);
            }
        }

        // ä½¿ç”¨ AJAX æ›´æ–°ä¸­é–“å€å¡Šï¼Œé¿å…å·¦å´æ¨¡çµ„é‡æ–°è¼‰å…¥
        async function loadLevel2Content(level1Id) {
            try {
                const response = await fetch(`/FontIndex?level1Id=${level1Id}`);
                if (!response.ok) throw new Error('Failed to load content');

                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // åªæ›´æ–°ä¸­é–“å€å¡Šçš„å…§å®¹
                const newContent = doc.querySelector('.col-12.col-md-5 .erp-card');
                const currentCard = document.querySelector('.col-12.col-md-5 .erp-card');

                if (newContent && currentCard) {
                    currentCard.innerHTML = newContent.innerHTML;

                    // ç§»é™¤ show-graph é¡ï¼Œé¡¯ç¤ºåŠŸèƒ½åˆ—è¡¨æ¨™é¡Œ
                    currentCard.classList.remove('show-graph');

                    // é‡æ–°ç¶å®šæ‹–æ›³äº‹ä»¶
                    document.querySelectorAll('.draggable-item').forEach(item => {
                        item.setAttribute('draggable', 'true');
                    });

                    // æ›´æ–° URL ä½†ä¸é‡æ–°è¼‰å…¥é é¢
                    window.history.pushState({level1Id}, '', `/FontIndex?level1Id=${level1Id}`);
                }
            } catch (error) {
                console.error('Error loading content:', error);
            }
        }

        // è·³è½‰åˆ°ç°½æ ¸å¾…å¯©é é¢
        function goToPendingApprovals() {
            const userId = localStorage.getItem('erpLoginUserId') || 'admin';
            window.location.href = `/PendingApprovals?userId=${encodeURIComponent(userId)}`;
        }

        function goToPendingNotifications() {
            const userId = localStorage.getItem('erpLoginUserId') || 'admin';
            window.location.href = `/PendingNotifications?userId=${encodeURIComponent(userId)}`;
        }

        function goToMessages() {
            const userId = localStorage.getItem('erpLoginUserId') || 'admin';
            window.location.href = `/Messages?userId=${encodeURIComponent(userId)}`;
        }
        function goToWorkingList() {
            const userId = localStorage.getItem('erpLoginUserId') || 'admin';
            const useId = localStorage.getItem('erpLoginBUId') || '';
            const url = `/WorkingList?userId=${encodeURIComponent(userId)}&useId=${encodeURIComponent(useId)}`;
            window.location.href = url;
        }
        function goToMessageSend() {
            const userId = localStorage.getItem('erpLoginUserId') || 'admin';
            window.location.href = `/MessageSend?userId=${encodeURIComponent(userId)}`;
        }

        function goToNoticeBoard() {
            const userId = localStorage.getItem('erpLoginUserId') || 'admin';
            window.location.href = `/NoticeBoardList?userId=${encodeURIComponent(userId)}`;
        }

        // è¼‰å…¥å¾…è¾¦äº‹é …çµ±è¨ˆ
        async function loadTodoStats() {
            try {
                // å¾ localStorage å–å¾— userId å’Œ useId
                const userId = localStorage.getItem('erpLoginUserId') || 'admin';
                const useId = localStorage.getItem('erpLoginBUId') || '';
                const response = await fetch(`/api/TodoStats?userId=${encodeURIComponent(userId)}&useId=${encodeURIComponent(useId)}`);

                if (!response.ok) {
                    throw new Error('Failed to load todo stats');
                }

                const data = await response.json();

                document.getElementById('todo-pending-sign').textContent = data.pendingSign || 0;
                document.getElementById('todo-messages').textContent = data.messages || 0;
                document.getElementById('todo-notifications').textContent = data.notifications || 0;
                document.getElementById('todo-pending-docs').textContent = data.pendingDocs || 0;
                document.getElementById('todo-announcements').textContent = data.announcements || 0;
            } catch (error) {
                console.error('Error loading todo stats:', error);
                // å¦‚æœ API èª¿ç”¨å¤±æ•—ï¼Œé¡¯ç¤º 0
                document.getElementById('todo-pending-sign').textContent = '0';
                document.getElementById('todo-messages').textContent = '0';
                document.getElementById('todo-notifications').textContent = '0';
                document.getElementById('todo-pending-docs').textContent = '0';
                document.getElementById('todo-announcements').textContent = '0';
            }
        }

        // ===============================
        // å¿«é€Ÿå•Ÿå‹•åŠŸèƒ½
        // ===============================
        (function initQuickStart() {
            let allItems = [];
            let filteredItems = [];
            let selectedRow = null;
            let modal = null;

            const input = document.getElementById('quickStartInput');
            const nameBtn = document.getElementById('quickStartNameBtn');
            const launchBtn = document.getElementById('quickStartLaunchBtn');
            const modalEl = document.getElementById('quickStartModal');
            const filterInput1 = document.getElementById('quickStartFilterInput');
            const filterInput2 = document.getElementById('quickStartFilterInput2');
            const searchInput = document.getElementById('quickStartSearchInput');
            const searchBtn = document.getElementById('quickStartSearchBtn');
            const confirmBtn = document.getElementById('quickStartConfirmBtn');
            const tableBody = document.getElementById('quickStartTableBody');

            if (!input || !nameBtn || !modalEl) return;

            modal = new bootstrap.Modal(modalEl);

            // ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†è¡¨æ ¼è¡Œé»æ“Š
            if (tableBody) {
                tableBody.addEventListener('click', function(e) {
                    const row = e.target.closest('tr');
                    if (!row || !row.dataset.itemid) return;

                    // ç§»é™¤ä¹‹å‰çš„é¸ä¸­ç‹€æ…‹ï¼ˆåŒ…æ‹¬æ¨£å¼ï¼‰
                    tableBody.querySelectorAll('tr').forEach(r => {
                        r.classList.remove('selected');
                        r.style.backgroundColor = '';
                        // ä¹Ÿæ¸…é™¤æ‰€æœ‰ td çš„èƒŒæ™¯è‰²
                        r.querySelectorAll('td').forEach(td => {
                            td.style.backgroundColor = '';
                        });
                    });

                    // æ·»åŠ é¸ä¸­ç‹€æ…‹ï¼ˆåŒæ™‚è¨­ç½® tr å’Œ tdï¼‰
                    row.classList.add('selected');
                    row.style.backgroundColor = '#b8d9f7';
                    row.querySelectorAll('td').forEach(td => {
                        td.style.backgroundColor = '#b8d9f7';
                    });
                    selectedRow = row;
                });

                // è™•ç† hover æ•ˆæœï¼ˆä¿æŒé¸ä¸­é …çš„é¡è‰²ï¼‰
                tableBody.addEventListener('mouseover', function(e) {
                    const row = e.target.closest('tr');
                    if (!row || !row.dataset.itemid) return;

                    if (!row.classList.contains('selected')) {
                        row.style.backgroundColor = '#e7f1fd';
                        row.querySelectorAll('td').forEach(td => {
                            td.style.backgroundColor = '#e7f1fd';
                        });
                    }
                });

                tableBody.addEventListener('mouseout', function(e) {
                    const row = e.target.closest('tr');
                    if (!row || !row.dataset.itemid) return;

                    if (!row.classList.contains('selected')) {
                        row.style.backgroundColor = '';
                        row.querySelectorAll('td').forEach(td => {
                            td.style.backgroundColor = '';
                        });
                    }
                });

                // é›™æ“Šå¡«å…¥ä¸¦é—œé–‰
                tableBody.addEventListener('dblclick', function(e) {
                    const row = e.target.closest('tr');
                    if (!row || !row.dataset.itemid) return;

                    const itemId = row.dataset.itemid;
                    const programName = row.dataset.programname;
                    input.value = itemId;
                    nameBtn.textContent = programName;
                    modal.hide();
                });
            }

            // è¼‰å…¥æ‰€æœ‰é …ç›®
            async function loadAllItems() {
                try {
                    const userId = localStorage.getItem('erpLoginUserId') || '';
                    const response = await fetch(`/api/QuickLaunch/Items?userId=${encodeURIComponent(userId)}`);
                    if (!response.ok) throw new Error('Failed to load items');
                    allItems = await response.json();
                    filteredItems = [...allItems];
                    return true;
                } catch (error) {
                    console.error('Error loading items:', error);
                    allItems = [];
                    filteredItems = [];
                    return false;
                }
            }

            // æ¸²æŸ“è¡¨æ ¼
            function renderTable(items) {
                selectedRow = null;

                if (!items || items.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted" style="padding: 20px;">ç„¡è³‡æ–™</td></tr>';
                    return;
                }

                let html = '';
                items.forEach((item, index) => {
                    html += `<tr data-index="${index}" data-itemid="${item.itemId}" data-programname="${item.programName || ''}">
                        <td style="padding: 6px 8px; font-family: 'Consolas', monospace;">${item.itemId}</td>
                        <td style="padding: 6px 8px;">${item.programName || ''}</td>
                    </tr>`;
                });

                tableBody.innerHTML = html;
            }

            // å³æ™‚ç¯©é¸
            function applyFilter() {
                const filter1 = (filterInput1?.value || '').trim().toUpperCase();
                const filter2 = (filterInput2?.value || '').trim().toUpperCase();

                if (!filter1 && !filter2) {
                    filteredItems = [...allItems];
                } else {
                    filteredItems = allItems.filter(item => {
                        const itemId = (item.itemId || '').toUpperCase();
                        const programName = (item.programName || '').toUpperCase();

                        const match1 = !filter1 || itemId.includes(filter1);
                        const match2 = !filter2 || programName.includes(filter2);

                        return match1 && match2;
                    });
                }

                renderTable(filteredItems);
            }

            // æ¨¡ç³ŠæŸ¥è©¢
            function applySearch() {
                const searchText = (searchInput?.value || '').trim().toUpperCase();

                if (!searchText) {
                    filteredItems = [...allItems];
                } else {
                    filteredItems = allItems.filter(item => {
                        const itemId = (item.itemId || '').toUpperCase();
                        const programName = (item.programName || '').toUpperCase();
                        return itemId.includes(searchText) || programName.includes(searchText);
                    });
                }

                // æ¸…ç©ºå³æ™‚ç¯©é¸
                if (filterInput1) filterInput1.value = '';
                if (filterInput2) filterInput2.value = '';

                renderTable(filteredItems);
            }

            // ç¢ºèªé¸æ“‡
            function confirmSelection() {
                if (!selectedRow) {
                    if (window.Swal) {
                        Swal.fire({ icon: 'warning', title: 'è«‹å…ˆé¸æ“‡é …ç›®', timer: 1500, showConfirmButton: false });
                    }
                    return;
                }

                const itemId = selectedRow.dataset.itemid;
                const programName = selectedRow.dataset.programname;

                input.value = itemId;
                nameBtn.textContent = programName;
                modal.hide();
            }

            // å•Ÿå‹•é …ç›®
            async function launchItem(itemId) {
                itemId = itemId.trim();
                if (!itemId) {
                    if (window.Swal) {
                        Swal.fire({ icon: 'error', title: 'è«‹å…ˆè¼¸å…¥åŠŸèƒ½ä»£ç¢¼', timer: 2000, showConfirmButton: false });
                    }
                    return;
                }

                try {
                    const response = await fetch(`/api/QuickLaunch/Item/${encodeURIComponent(itemId)}`);

                    if (!response.ok) {
                        if (response.status === 404) {
                            if (window.Swal) {
                                Swal.fire({ icon: 'error', title: 'æ‚¨è¼¸å…¥çš„åŠŸèƒ½ä»£ç¢¼ä¸åœ¨æ‚¨çš„æ¬Šé™ç¯„åœå…§', timer: 2000, showConfirmButton: false });
                            }
                        } else {
                            throw new Error('Failed to get item info');
                        }
                        return;
                    }

                    const item = await response.json();

                    // ä½¿ç”¨ç¾æœ‰çš„ resolveAndGo å‡½æ•¸ä¾†å•Ÿå‹•
                    await resolveAndGo(
                        item.itemId,
                        item.programName,
                        item.superId || '',
                        item.className || '',
                        item.powerType || ''
                    );

                } catch (error) {
                    console.error('Error launching item:', error);
                    if (window.Swal) {
                        Swal.fire({ icon: 'error', title: 'å•Ÿå‹•å¤±æ•—', text: error.message, timer: 2000, showConfirmButton: false });
                    }
                }
            }

            // æ›´æ–°åç¨±æŒ‰éˆ•
            let updateNameTimer = null;
            async function updateNameButton() {
                const itemId = input.value.trim().toUpperCase();
                if (!itemId) {
                    nameBtn.textContent = '';
                    return;
                }

                try {
                    const response = await fetch(`/api/QuickLaunch/Item/${encodeURIComponent(itemId)}`);
                    if (response.ok) {
                        const item = await response.json();
                        nameBtn.textContent = item.programName || '';
                    } else {
                        nameBtn.textContent = '';
                    }
                } catch (error) {
                    nameBtn.textContent = '';
                }
            }

            // é˜²æŠ–æ›´æ–°åç¨±
            function debouncedUpdateName() {
                if (updateNameTimer) {
                    clearTimeout(updateNameTimer);
                }
                updateNameTimer = setTimeout(() => {
                    updateNameButton();
                }, 500);
            }

            // äº‹ä»¶ç¶å®š
            if (nameBtn) {
                nameBtn.addEventListener('click', async function() {
                    // è¼‰å…¥ä¸¦é¡¯ç¤ºå°è©±æ¡†
                    const loaded = await loadAllItems();
                    if (loaded) {
                        filteredItems = [...allItems];
                        renderTable(filteredItems);
                        selectedRow = null;
                        if (filterInput1) filterInput1.value = '';
                        if (filterInput2) filterInput2.value = '';
                        if (searchInput) searchInput.value = '';
                        modal.show();
                    } else {
                        if (window.Swal) {
                            Swal.fire({ icon: 'error', title: 'è¼‰å…¥è³‡æ–™å¤±æ•—', timer: 2000, showConfirmButton: false });
                        }
                    }
                });
            }

            if (input) {
                // è¼¸å…¥æ™‚å¯¦æ™‚æ›´æ–°ï¼ˆå¸¶é˜²æŠ–ï¼‰
                input.addEventListener('input', debouncedUpdateName);

                // å¤±å»ç„¦é»æ™‚ç«‹å³æ›´æ–°
                input.addEventListener('blur', function() {
                    if (updateNameTimer) {
                        clearTimeout(updateNameTimer);
                    }
                    updateNameButton();
                });

                // æŒ‰ Enter æ™‚ç«‹å³æ›´æ–°
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (updateNameTimer) {
                            clearTimeout(updateNameTimer);
                        }
                        updateNameButton();
                    }
                });
            }

            if (launchBtn) {
                launchBtn.addEventListener('click', function() {
                    const itemId = input.value.trim();
                    if (itemId) {
                        launchItem(itemId);
                    }
                });
            }

            if (filterInput1) {
                filterInput1.addEventListener('input', applyFilter);
            }

            if (filterInput2) {
                filterInput2.addEventListener('input', applyFilter);
            }

            if (searchBtn) {
                searchBtn.addEventListener('click', applySearch);
            }

            if (searchInput) {
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        applySearch();
                    }
                });
            }

            if (confirmBtn) {
                confirmBtn.addEventListener('click', confirmSelection);
            }

            // åˆå§‹åŒ–è¼‰å…¥
            loadAllItems();
        })();

        document.addEventListener('DOMContentLoaded', function() {
            renderFavorites();
            initDragAndDrop();
            loadTodoStats();

            // ç¢ºä¿åŠŸèƒ½åˆ—è¡¨é é¢é¡¯ç¤ºæ¨™é¡Œï¼ˆç§»é™¤å¯èƒ½æ®˜ç•™çš„ show-graph é¡ï¼‰
            const functionList = document.getElementById('level2-list');
            const card = document.querySelector('.col-12.col-md-5 .erp-card');
            if (functionList && functionList.children.length > 0 && card) {
                card.classList.remove('show-graph');
            }

            // æ””æˆªå·¦å´æ¨¡çµ„çš„é€£çµé»æ“Šï¼Œä½¿ç”¨ AJAX æ›´æ–°
            document.addEventListener('click', function(e) {
                const link = e.target.closest('.erp-nav-group a[href*="level1Id"]');
                if (link) {
                    e.preventDefault();
                    const url = new URL(link.href);
                    const level1Id = url.searchParams.get('level1Id');
                    if (level1Id) {
                        loadLevel2Content(level1Id);
                    }
                }
            });

            // è™•ç†ç€è¦½å™¨çš„ä¸Šä¸€é /ä¸‹ä¸€é 
            window.addEventListener('popstate', function(e) {
                if (e.state && e.state.level1Id) {
                    loadLevel2Content(e.state.level1Id);
                }
            });
        });

    // fallback: ensure dyn-link click is always handled (capture phase), even if earlier listeners failed
    (function ensureDynLinkHandler() {
        if (window.__dynLinkHandlerBound) return;
        window.__dynLinkHandlerBound = true;
        const handler = (ev) => {
            const link = ev.target.closest('.dyn-link');
            if (!link) return;
            ev.preventDefault();
            const itemId = link.dataset.itemid || link.getAttribute('data-itemid');
            const itemName = link.dataset.itemname || link.getAttribute('data-itemname');
            const superId = link.dataset.superid || link.getAttribute('data-superid');
            const cls = link.dataset.classname || link.getAttribute('data-classname') || "";
            const pt = link.dataset.powertype || link.getAttribute('data-powertype') || "";
            console.debug('dyn-link click (fallback)', { itemId, itemName, superId });
            resolveAndGo(itemId, itemName, superId, cls, pt);
        };
        document.addEventListener('click', handler, true);
    })();

</script>
