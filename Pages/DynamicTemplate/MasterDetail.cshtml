@page "/CUR/MasterDetail/{itemId}"
@using WebRazor.Models
@using PcbErpApi.Models
@model PcbErpApi.Pages.CUR.MasterDetailModel
@{
    Layout = "_Layout";
    var cfg = Model.Config;

    var toolbarButtonVisibility = ViewData["ToolbarButtonVisibility"] as Dictionary<string, bool>
        ?? new Dictionary<string, bool>(StringComparer.OrdinalIgnoreCase);
    bool IsToolbarVisible(string name) => toolbarButtonVisibility.TryGetValue(name, out var visible) && visible;
    var showBtnInq = IsToolbarVisible("btnInq");
    ViewData["ShowBtnInq"] = showBtnInq;
}

@if (cfg == null)
{
    <div class="alert alert-warning mt-3">找不到 MASTER/DETAIL 設定資料。</div>
}
else
{
    <script>
        window._mdItemId = '@Model.ItemId';
        window._mdTableName = '@(cfg.MasterTable ?? "")';
    </script>
    <div id="mdCustomButtonBar" class="d-flex gap-2 flex-wrap">@Model.CustomButtonsHtml</div>
    @await Html.PartialAsync("_MasterDetailTemplate", cfg)
}

@if (ViewData["QueryFieldModalsRendered"] == null)
{
    @await Html.PartialAsync("~/Pages/Shared/_QueryFieldModals.cshtml")
}

@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", Model.FieldDictList, ViewData)

<!-- CondRunSp Modal -->
<div class="modal fade" id="condRunSpModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog cond-runsp-dialog">
    <div class="modal-content cond-runsp-modal">
      <div class="modal-header">
        <h5 class="modal-title">輸入條件</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form class="cond-runsp-form"></form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success crs-confirm">確定</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<!-- PaperSearch Modal -->
<div class="modal fade" id="paperSearchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl paper-search-dialog">
    <div class="modal-content paper-search-modal">
      <div class="modal-header">
        <h5 class="modal-title">查詢並挑選</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form class="mb-3 paper-search-form"></form>
        <div class="row paper-search-picker">
          <div class="col-5 paper-search-col">
            <div class="paper-search-title-row">
              <div class="paper-search-title">可選擇的項目</div>
              <div class="paper-search-count ps-count-available">0</div>
            </div>
            <div class="paper-search-scroll">
              <table class="table table-sm table-striped mb-0 paper-search-available">
                <thead><tr></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="col-2 paper-search-transfer">
            <button class="btn btn-outline-primary ps-right" type="button" aria-label="右移">
              <span class="material-symbols-outlined" aria-hidden="true">keyboard_arrow_right</span>
            </button>
            <button class="btn btn-outline-primary ps-right-all" type="button" aria-label="全部右移">
              <span class="material-symbols-outlined" aria-hidden="true">keyboard_double_arrow_right</span>
            </button>
            <button class="btn btn-outline-secondary ps-left" type="button" aria-label="左移">
              <span class="material-symbols-outlined" aria-hidden="true">keyboard_arrow_left</span>
            </button>
            <button class="btn btn-outline-secondary ps-left-all" type="button" aria-label="全部左移">
              <span class="material-symbols-outlined" aria-hidden="true">keyboard_double_arrow_left</span>
            </button>
          </div>
          <div class="col-5 paper-search-col">
            <div class="paper-search-title-row">
              <div class="paper-search-title">已選入的項目</div>
              <div class="paper-search-count ps-count-selected">0</div>
            </div>
            <div class="paper-search-scroll">
              <table class="table table-sm table-striped mb-0 paper-search-selected">
                <thead><tr></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <label class="ps-replace form-check d-none">
          <input type="checkbox" id="paperSearchReplace" class="form-check-input">
          <span class="form-check-label">取代已存在的項目</span>
        </label>
        <button class="btn btn-success ps-confirm">確定新增</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<style>
  #condRunSpModal .cond-runsp-dialog { --bs-modal-width: 520px; }
  #condRunSpModal .cond-runsp-modal { display: flex; flex-direction: column; }
  #condRunSpModal .modal-body { padding: 16px 18px; }
  #condRunSpModal .cond-runsp-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  #condRunSpModal .crs-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px 12px;
  }
  #condRunSpModal .crs-field {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #condRunSpModal .crs-label {
    white-space: nowrap;
    margin: 0;
    flex: 0 0 90px;
    text-align: right;
    font-size: var(--field-label-size);
  }
  #condRunSpModal .crs-control {
    flex: 1 1 auto;
    min-width: 0;
    font-size: var(--field-value-size);
  }

  /* PaperSearch Modal Styles */
  #paperSearchModal .paper-search-dialog { --bs-modal-width: 1200px; --bs-modal-margin: 0; margin-top: 12vh; }
  #paperSearchModal .paper-search-modal { height: calc(88vh); display: flex; flex-direction: column; }
  #paperSearchModal.modal.show { align-items: flex-start; }
  #paperSearchModal .modal-header { padding: 6px 12px; cursor: move; user-select: none; }
  #paperSearchModal .modal-header :is(button, input, select, textarea, a) { cursor: default; }
  #paperSearchModal .modal-title { font-size: 16px; line-height: 1.2; }
  #paperSearchModal .modal-body { flex: 1 1 auto; display: flex; flex-direction: column; min-height: 0; overflow: hidden; padding: 8px 12px; }
  #paperSearchModal .modal-footer { position: sticky; bottom: 0; background: #fff; z-index: 3; display: flex; align-items: center; gap: 12px; padding-top: 6px; padding-bottom: 6px; }
  #paperSearchModal .modal-footer .ps-replace { margin-left: auto; margin-right: auto; }
  #paperSearchModal .paper-search-picker { flex: 1 1 auto; min-height: 0; display: flex; gap: 4px; margin-left: 0; margin-right: 0; }
  #paperSearchModal .paper-search-picker > div { padding-left: 0; padding-right: 0; }
  #paperSearchModal .paper-search-col { display: flex; flex-direction: column; min-width: 0; }
  #paperSearchModal .paper-search-title-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  #paperSearchModal .paper-search-title { font-weight: 600; color: #475569; font-size: 13px; }
  #paperSearchModal .paper-search-count { font-size: 12px; color: #64748b; }
  #paperSearchModal .paper-search-col:first-child { flex: 0 0 58%; }
  #paperSearchModal .paper-search-col:last-child { flex: 1 1 0; }
  #paperSearchModal .paper-search-scroll { flex: 1 1 0; min-height: 0; overflow: auto; border: 1px solid #e5e7eb; border-radius: 8px; }
  #paperSearchModal .paper-search-transfer { flex: 0 0 56px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: .6rem; }
  #paperSearchModal .paper-search-transfer .btn { width: 28px; height: 28px; padding: 0; border: 1px solid currentColor; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center; }
  #paperSearchModal .paper-search-transfer .btn:hover { border-color: currentColor; box-shadow: none; }
  #paperSearchModal .paper-search-transfer .material-symbols-outlined { font-size: 28px; line-height: 1; }
  #paperSearchModal thead th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; }
  #paperSearchModal table { border-collapse: collapse; }
  #paperSearchModal th, #paperSearchModal td { border: 1px solid #dee2e6; vertical-align: middle; }
  #paperSearchModal .paper-search-scroll th, #paperSearchModal .paper-search-scroll td { white-space: nowrap; }
  #paperSearchModal .paper-search-form { display: flex; flex-direction: column; gap: 6px; position: relative; padding-right: 120px; }
  #paperSearchModal .paper-search-form .ps-grid { display: grid; grid-template-columns: repeat(4, 300px); grid-template-rows: repeat(3, minmax(0, auto)); grid-auto-flow: column; grid-auto-rows: minmax(0, auto); gap: 4px 10px; justify-content: start; align-items: start; }
  #paperSearchModal .paper-search-form .ps-field { display: flex; align-items: center; gap: 6px; min-width: 0; }
  #paperSearchModal .paper-search-form .ps-label { white-space: nowrap; margin: 0; flex: 0 0 100px; text-align: right; font-size: var(--field-label-size); line-height: 1.2; }
  #paperSearchModal .paper-search-form .ps-control { flex: 0 0 200px; min-width: 0; font-size: var(--field-value-size); height: 24px; padding-top: 2px; padding-bottom: 2px; }
  #paperSearchModal .paper-search-form .ps-control.form-control { min-height: 24px; height: 24px; padding: 2px 6px; line-height: 1.2; }
  #paperSearchModal .paper-search-scroll table, #paperSearchModal .paper-search-scroll th, #paperSearchModal .paper-search-scroll td { font-size: var(--field-value-size); }
  #paperSearchModal .paper-search-scroll td { padding-top: 2px; padding-bottom: 2px; line-height: 1.15; }
  #paperSearchModal .paper-search-scroll tbody tr { cursor: pointer; }
  #paperSearchModal .paper-search-scroll tbody tr.ps-row-selected, #paperSearchModal .paper-search-scroll tbody tr.ps-row-selected > td { background: #dbeafe !important; }
  #paperSearchModal .paper-search-scroll tbody tr.ps-row-selected { --bs-table-bg-type: #dbeafe; --bs-table-accent-bg: #dbeafe; }
  #paperSearchModal .paper-search-form .ps-actions { display: flex; justify-content: flex-end; align-items: center; position: absolute; top: 0; right: 0; margin: 0; }
  #paperSearchModal .paper-search-form .ps-tab-content { margin-top: 2px; }
  #paperSearchModal .paper-search-form .nav-tabs .nav-link { padding: 4px 8px; }
  #paperSearchModal .ps-fetch.is-loading { pointer-events: none; opacity: .8; }
  #paperSearchModal .ps-fetch .spin { display: inline-block; margin-right: 6px; animation: ps-spin 0.8s linear infinite; }
  @@keyframes ps-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  @@media (max-width: 991.98px){
    #paperSearchModal .paper-search-dialog { --bs-modal-width: 100vw; --bs-modal-margin: 0; }
    #paperSearchModal .paper-search-modal { border-radius: 0; }
  }
</style>

<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const bar = document.getElementById('mdCustomButtonBar');
  const domId = '@(cfg?.DomId ?? string.Empty)';
  const itemId = '@Model.ItemId';
  let lastMasterRow = null;
  let lastDetailRow = null;

  // move bar into template header area (to the right of Edit/Save)
  const moveBar = () => {
    if (!bar) return;
    const editBtn = document.getElementById(`${domId}-btnEdit`);
    const slot = document.getElementById(`${domId}-custom-slot`);
    const toolbar = slot?.nextElementSibling || document.querySelector(`#${domId} .btn-toolbar`);
    if (!editBtn || !slot) { return; }
    bar.classList.add('d-flex','align-items-center','gap-2','flex-wrap');
    if (slot) {
      slot.style.order = '2';
      slot.classList.add('ms-3');
    }
    if (toolbar) {
      toolbar.style.order = '1';
    }
    slot.appendChild(bar);
  };
  moveBar();
  setTimeout(moveBar, 0);

  document.addEventListener('md-master-selected', (ev) => {
    if (ev?.detail?.domId !== domId) return;
    if (ev?.detail?.rowData) lastMasterRow = ev.detail.rowData;
  });
  document.addEventListener('md-detail-selected', (ev) => {
    if (ev?.detail?.domId !== domId) return;
    if (ev?.detail?.rowData) lastDetailRow = ev.detail.rowData;
  });

  if (bar) {
    const withJwtHeaders = (init = {}) => {
      const jwt = localStorage.getItem("jwtId");
      const headers = Object.assign({}, init.headers || {});
      if (jwt) headers["X-JWTID"] = jwt;
      return { ...init, headers };
    };

    const hasDateOnlyMask = (mask) => {
      const m = (mask || "").toString().toLowerCase();
      if (!m) return false;
      const isDate = m.includes("yyyy") && m.includes("mm") && m.includes("dd");
      const hasTime = m.includes("hh") || m.includes("ss") || m.includes("tt");
      return isDate && !hasTime;
    };

    const parseDateValue = (value) => {
      if (!value) return null;
      if (value instanceof Date && !isNaN(value)) return value;
      const s = String(value).trim();
      if (!s) return null;
      if (/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s.slice(0, 10));
      if (/^\d{4}[/.]\d{1,2}[/.]\d{1,2}$/.test(s)) {
        const [y, m, d] = s.split(/[/.]/).map(Number);
        if (y && m && d) return new Date(y, m - 1, d);
      }
      const d = new Date(s);
      return isNaN(d) ? null : d;
    };

    const formatDateByMask = (value, mask) => {
      const dt = parseDateValue(value);
      if (!dt) return value;
      const y = dt.getFullYear();
      const m = String(dt.getMonth() + 1).padStart(2, "0");
      const d = String(dt.getDate()).padStart(2, "0");
      if (mask?.includes("-")) return `${y}-${m}-${d}`;
      return `${y}/${m}/${d}`;
    };

    const applyEditMask = (value, editMask) => {
      if (hasDateOnlyMask(editMask)) return formatDateByMask(value, editMask);
      return value;
    };

    const normalizeKey = (name) => (name || "").replace(/^@@+/, "").toLowerCase();

    const getRowFieldValue = (row, field) => {
      if (!row || !field) return "";
      const key = String(field).toLowerCase();
      const hit = Object.keys(row).find(k => String(k).toLowerCase() === key);
      const val = hit ? row[hit] : "";
      return val == null ? "" : String(val).trim();
    };

    const pickPaperNum = (row) => {
      if (!row) return "";
      const direct = getRowFieldValue(row, "PaperNum");
      if (direct) return direct;
      const cfg = window._mdConfigs?.[domId] || {};
      const keyFields = (cfg.MasterKeyFields && cfg.MasterKeyFields.length)
        ? cfg.MasterKeyFields
        : (cfg.KeyMap || []).map(k => k.Master).filter(Boolean);
      for (const k of keyFields) {
        const val = getRowFieldValue(row, k);
        if (val) return val;
      }
      const keys = Object.keys(row);
      const findBy = (re) => {
        const k = keys.find(name => re.test(String(name)));
        return k ? getRowFieldValue(row, k) : "";
      };
      return findBy(/paper.*num/i)
        || findBy(/doc.*num/i)
        || findBy(/bill.*num/i)
        || findBy(/order.*num/i)
        || "";
    };

    const getDefaultFromTableKind = (tableKind, fieldName) => {
      const kind = (tableKind || "").toString().trim().toLowerCase();
      if (!kind || !fieldName) return "";
      if (kind === "master1" || kind === "master") return getRowFieldValue(lastMasterRow, fieldName);
      if (kind === "detail1" || kind === "detail") return getRowFieldValue(lastDetailRow, fieldName);
      return "";
    };

    const condRunSp = (() => {
      const modalEl = document.getElementById("condRunSpModal");
      if (modalEl && modalEl.parentElement !== document.body) {
        document.body.appendChild(modalEl);
      }
      const formEl = modalEl?.querySelector(".cond-runsp-form");
      const btnConfirm = modalEl?.querySelector(".crs-confirm");
      const titleEl = modalEl?.querySelector(".modal-title");

      const state = {
        itemId: "",
        buttonName: "",
        paperNum: "",
        searchParams: [],
        inputs: {}
      };

      const loadParamOptions = async (itemId, buttonName, paramName, superValue) => {
        const extra = superValue ? `&superValue=${encodeURIComponent(superValue)}` : "";
        const url = `/api/PaperSearch/ParamOptionsV2?itemId=${encodeURIComponent(itemId)}&buttonName=${encodeURIComponent(buttonName)}&paramName=${encodeURIComponent(paramName)}${extra}`;
        const res = await fetch(url, withJwtHeaders());
        if (!res.ok) throw new Error(await res.text());
        return await res.json();
      };

      const getSuperValueCrs = (p) => {
        const rawSuperId = (p.SuperId || p.superId || "").toString().trim().replace(/^@@+/, "");
        const superKey = normalizeKey(rawSuperId);
        if (!superKey) return "";
        const superInput = formEl?.querySelector(`[data-param="${superKey}"]`);
        if (superInput && (superInput.value ?? "") !== "") return superInput.value ?? "";

        const superParam = (state.searchParams || []).find(sp => normalizeKey(sp.ParamName || sp.paramName) === superKey);
        if (!superParam) return "";
        const tk = superParam.TableKind ?? superParam.tableKind;
        const pv = superParam.ParamValue ?? superParam.paramValue;
        const fromKind = pv ? getDefaultFromTableKind(tk, pv) : "";
        return fromKind || (superParam.DefaultValue ?? superParam.defaultValue ?? "");
      };

      const buildForm = async (itemId, buttonName) => {
        if (!formEl) return;
        formEl.innerHTML = "";
        const visibleParams = (state.searchParams || []).filter(p => {
          return Number(p.iVisible ?? p.IVisible ?? 0) === 1;
        });

        if (!visibleParams.length) {
          formEl.innerHTML = '<div class="text-muted small">（沒有可輸入的條件）</div>';
          return;
        }

        const grid = document.createElement("div");
        grid.className = "crs-grid";
        formEl.appendChild(grid);

        for (const p of visibleParams) {
          const name = normalizeKey(p.ParamName || p.paramName);
          if (!name) continue;

          const wrap = document.createElement("div");
          wrap.className = "crs-field";
          const label = document.createElement("label");
          label.className = "form-label crs-label";
          label.textContent = p.DisplayName || p.displayName || name;
          wrap.appendChild(label);

          const controlType = Number(p.ControlType ?? p.controlType ?? 0);
          const tableKind = p.TableKind ?? p.tableKind;
          const paramValue = p.ParamValue ?? p.paramValue;
          let headerDefault = "";
          if (paramValue) {
            headerDefault = getDefaultFromTableKind(tableKind, paramValue);
          }

          if (controlType === 1) {
            const select = document.createElement("select");
            select.className = "form-select form-select-sm crs-control";
            select.setAttribute("data-param", name);
            const emptyOpt = document.createElement("option");
            emptyOpt.value = "";
            emptyOpt.textContent = "";
            select.appendChild(emptyOpt);
            wrap.appendChild(select);
            try {
              const superValue = getSuperValueCrs(p);
              const options = await loadParamOptions(itemId, buttonName, p.ParamName || p.paramName, superValue);
              if (Array.isArray(options)) {
                options.forEach(opt => {
                  const o = document.createElement("option");
                  const val = opt.value ?? opt.Value ?? "";
                  const text = opt.text ?? opt.Text ?? "";
                  o.value = val;
                  o.textContent = text ? `${val} ${text}`.trim() : val;
                  if (text && text !== val) o.title = text;
                  select.appendChild(o);
                });
              }
              const defVal = headerDefault || (p.DefaultValue ?? p.defaultValue ?? "");
              if (defVal != null && defVal !== "") {
                select.value = applyEditMask(defVal, p.EditMask ?? p.editMask);
              }
            } catch (err) {
              console.warn("load param options failed", err);
            }
          } else {
            const input = document.createElement("input");
            input.className = "form-control form-control-sm crs-control";
            input.type = "text";
            input.setAttribute("data-param", name);
            const defVal = headerDefault || (p.DefaultValue ?? p.defaultValue);
            if (defVal != null && defVal !== "") {
              input.value = applyEditMask(defVal, p.EditMask ?? p.editMask);
            }
            const readOnly = Number(p.iReadOnly ?? p.IReadOnly ?? 0) === 1;
            if (readOnly) input.readOnly = true;
            wrap.appendChild(input);
          }

          grid.appendChild(wrap);
        }
      };

      const collectInputs = () => {
        const values = {};
        (state.searchParams || []).forEach(p => {
          const name = normalizeKey(p.ParamName || p.paramName);
          if (!name) return;
          const input = formEl?.querySelector(`[data-param="${name}"]`);
          if (input) {
            values[name] = input.value ?? "";
            return;
          }
          const tableKind = p.TableKind ?? p.tableKind;
          const paramValue = p.ParamValue ?? p.paramValue;
          const fromKind = paramValue ? getDefaultFromTableKind(tableKind, paramValue) : "";
          const defVal = fromKind || (p.DefaultValue ?? p.defaultValue ?? p.ParamValue ?? p.paramValue);
          values[name] = defVal == null ? "" : defVal;
        });
        if (values.useid != null && String(values.useid).trim() === "") {
          values.useid = window.DEFAULT_USEID || window._useId || "A001";
        }
        state.inputs = values;
        return values;
      };

      const setConfirmLoading = (loading) => {
        if (!btnConfirm) return;
        btnConfirm.disabled = loading;
        btnConfirm.textContent = loading ? "執行中..." : "確定";
      };

      const runSp = async () => {
        setConfirmLoading(true);
        const payload = {
          itemId: state.itemId,
          buttonName: state.buttonName,
          paperNum: state.paperNum,
          params: collectInputs()
        };
        try {
          const res = await fetch("/api/PaperSearch/RunSpExec", withJwtHeaders({
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          }));
          const raw = await res.text();
          let data; try { data = JSON.parse(raw); } catch { data = { ok: false, error: raw }; }
          if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
          localStorage.setItem("afterSave", "1");
          location.reload();
        } catch (err) {
          alert(`執行失敗: ${err?.message || err}`);
        } finally {
          setConfirmLoading(false);
        }
      };

      const open = async (ctx, meta) => {
        if (!modalEl) return;
        state.itemId = ctx.itemId || "";
        state.buttonName = ctx.buttonName || "";
        state.paperNum = ctx.paperNum || "";

        const configUrl = `/api/PaperSearch/Config?itemId=${encodeURIComponent(state.itemId)}&buttonName=${encodeURIComponent(state.buttonName)}`;
        const res = await fetch(configUrl, withJwtHeaders());
        if (!res.ok) {
          alert(await res.text());
          return;
        }
        const cfg = await res.json();
        state.searchParams = cfg.searchParams || cfg.SearchParams || [];

        const caption = meta.dialogCaption || cfg.dialogCaption || cfg.DialogCaption || ctx.caption || "輸入條件";
        if (titleEl) titleEl.textContent = caption;

        await buildForm(state.itemId, state.buttonName);
        if (window.bootstrap) {
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        }
      };

      btnConfirm?.addEventListener("click", (e) => { e.preventDefault(); runSp(); });

      return { open };
    })();

    const paperSearch = (() => {
      const modalEl = document.getElementById("paperSearchModal");
      if (modalEl && modalEl.parentElement !== document.body) {
        document.body.appendChild(modalEl);
      }
      const formEl = modalEl?.querySelector(".paper-search-form");
      const availTable = modalEl?.querySelector(".paper-search-available");
      const selTable = modalEl?.querySelector(".paper-search-selected");
      const btnRight = modalEl?.querySelector(".ps-right");
      const btnLeft = modalEl?.querySelector(".ps-left");
      const btnRightAll = modalEl?.querySelector(".ps-right-all");
      const btnLeftAll = modalEl?.querySelector(".ps-left-all");
      const btnConfirm = modalEl?.querySelector(".ps-confirm");
      const ckReplace = modalEl?.querySelector("#paperSearchReplace");
      const titleEl = modalEl?.querySelector(".modal-title");
      const dialogEl = modalEl?.querySelector(".modal-dialog");
      const headerEl = modalEl?.querySelector(".modal-header");

      const state = {
        itemId: "",
        buttonName: "",
        paperNum: "",
        allowSelCount: 0,
        replaceExists: 0,
        dict: [],
        searchParams: [],
        insertKeys: [],
        inputs: {},
        available: [],
        selected: [],
        editableFields: new Set(),
        selectedAvailIdx: new Set(),
        selectedSelIdx: new Set()
      };

      const enableDrag = () => {
        if (!modalEl || !dialogEl || !headerEl) return;
        let dragging = false;
        let startX = 0, startY = 0, startLeft = 0, startTop = 0;
        const resetDialogStyle = () => {
          dialogEl.style.position = '';
          dialogEl.style.left = '';
          dialogEl.style.top = '';
          dialogEl.style.margin = '';
          dialogEl.style.transform = '';
        };
        const begin = (ev) => {
          const isMouse = ev.pointerType === 'mouse' || ev.pointerType === undefined;
          if (isMouse && ev.button !== 0) return;
          if (ev.target?.closest('button, input, select, textarea, a')) return;
          const rect = dialogEl.getBoundingClientRect();
          dialogEl.style.position = 'fixed';
          dialogEl.style.margin = '0';
          dialogEl.style.left = `${rect.left}px`;
          dialogEl.style.top = `${rect.top}px`;
          dialogEl.style.transform = 'none';
          startX = ev.clientX;
          startY = ev.clientY;
          startLeft = rect.left;
          startTop = rect.top;
          dragging = true;
          if (headerEl.setPointerCapture && ev.pointerId !== undefined) {
            headerEl.setPointerCapture(ev.pointerId);
          }
          ev.preventDefault();
        };
        const move = (ev) => {
          if (!dragging) return;
          const dx = ev.clientX - startX;
          const dy = ev.clientY - startY;
          const w = dialogEl.offsetWidth || dialogEl.getBoundingClientRect().width;
          const h = dialogEl.offsetHeight || dialogEl.getBoundingClientRect().height;
          let left = startLeft + dx;
          let top = startTop + dy;
          const keepVisibleX = 120;
          const keepVisibleY = 80;
          const minLeft = -(w - keepVisibleX);
          const maxLeft = window.innerWidth - keepVisibleX;
          const minTop = -(h - keepVisibleY);
          const maxTop = window.innerHeight - keepVisibleY;
          left = Math.min(Math.max(minLeft, left), maxLeft);
          top = Math.min(Math.max(minTop, top), maxTop);
          dialogEl.style.left = `${left}px`;
          dialogEl.style.top = `${top}px`;
        };
        const end = () => { dragging = false; };
        headerEl.addEventListener('pointerdown', begin);
        headerEl.addEventListener('pointermove', move);
        headerEl.addEventListener('pointerup', end);
        headerEl.addEventListener('pointercancel', end);
        modalEl.addEventListener('hidden.bs.modal', resetDialogStyle);
        modalEl.addEventListener('show.bs.modal', resetDialogStyle);
      };
      enableDrag();

      const toNumber = (v, fallback = 0) => {
        const n = parseInt(v, 10);
        return Number.isFinite(n) ? n : fallback;
      };

      const getRowValue = (row, field) => {
        if (!row) return "";
        const key = normalizeKey(field);
        const hit = Object.keys(row).find(k => k.toLowerCase() === key);
        if (!hit) return "";
        const val = row[hit];
        return val == null ? "" : val;
      };

      const clearTable = (table) => {
        const head = table?.querySelector("thead tr");
        const body = table?.querySelector("tbody");
        if (head) head.innerHTML = '';
        if (body) body.innerHTML = "";
      };

      const buildHeads = () => {
        const headHtml = (state.dict || []).map(c => {
          const w = Math.max(40, Number(c.DisplaySize ?? 120));
          return `<th data-field="${c.FieldName}" style="min-width:${w}px;width:${w}px;">${c.DisplayLabel ?? ""}</th>`;
        }).join("");
        availTable?.querySelector("thead tr")?.insertAdjacentHTML("beforeend", headHtml);
        selTable?.querySelector("thead tr")?.insertAdjacentHTML("beforeend", headHtml);
      };

      const fmtCell = (val, col) => {
        if (val == null) return "";
        if ((col.DataType || "").toString().toLowerCase().includes("date")) {
          const d = new Date(val);
          if (!Number.isNaN(d.getTime())) return d.toISOString().slice(0, 10);
        }
        if ((col.DataType || "").toString().toLowerCase().includes("number")) {
          const n = Number(String(val).replace(/,/g, ""));
          if (!Number.isNaN(n)) return n.toLocaleString();
        }
        return String(val);
      };

      const renderRows = () => {
        const cols = state.dict || [];
        const availBody = availTable?.querySelector("tbody");
        const selBody = selTable?.querySelector("tbody");
        if (!availBody || !selBody) return;

        const availHtml = state.available.map(r => {
          const isSelected = state.selectedAvailIdx.has(r.idx);
          const tds = cols.map(c => {
            const v = getRowValue(r.data, c.FieldName);
            const cls = (c.DataType || "").toString().toLowerCase().includes("number") ? "text-end" : "";
            return `<td class="${cls}">${fmtCell(v, c)}</td>`;
          }).join("");
          const selClass = isSelected ? " ps-row-selected" : "";
          return `<tr data-idx="${r.idx}" class="${selClass}">${tds}</tr>`;
        }).join("");

        const selHtml = state.selected.map(r => {
          const isSelected = state.selectedSelIdx.has(r.idx);
          const tds = cols.map(c => {
            const v = getRowValue(r.data, c.FieldName);
            const cls = (c.DataType || "").toString().toLowerCase().includes("number") ? "text-end" : "";
            return `<td class="${cls}">${fmtCell(v, c)}</td>`;
          }).join("");
          const selClass = isSelected ? " ps-row-selected" : "";
          return `<tr data-idx="${r.idx}" class="${selClass}">${tds}</tr>`;
        }).join("");

        availBody.innerHTML = availHtml;
        selBody.innerHTML = selHtml;

        const availCountEl = modalEl?.querySelector(".ps-count-available");
        const selCountEl = modalEl?.querySelector(".ps-count-selected");
        if (availCountEl) availCountEl.textContent = `總數${state.available.length}筆`;
        if (selCountEl) selCountEl.textContent = `總數${state.selected.length}筆`;
      };

      const moveRight = () => {
        if (!availTable) return;
        const picked = Array.from(state.selectedAvailIdx);
        if (!picked.length) return;
        if (state.allowSelCount > 0 && (state.selected.length + picked.length) > state.allowSelCount) {
          alert(`最多只能選 ${state.allowSelCount} 筆`);
          return;
        }
        picked.forEach(idx => {
          const row = state.available.find(x => x.idx === idx);
          if (!row) return;
          state.selected.push(row);
          state.available = state.available.filter(x => x.idx !== idx);
        });
        state.selectedAvailIdx.clear();
        renderRows();
      };

      const moveLeft = () => {
        if (!selTable) return;
        const picked = Array.from(state.selectedSelIdx);
        if (!picked.length) return;
        picked.forEach(idx => {
          const row = state.selected.find(x => x.idx === idx);
          if (!row) return;
          state.available.push(row);
          state.selected = state.selected.filter(x => x.idx !== idx);
        });
        state.selectedSelIdx.clear();
        renderRows();
      };

      const moveAllRight = () => {
        if (state.allowSelCount > 0 && (state.selected.length + state.available.length) > state.allowSelCount) {
          alert(`最多只能選 ${state.allowSelCount} 筆`);
          return;
        }
        if (!state.available.length) return;
        state.selected = state.selected.concat(state.available);
        state.available = [];
        state.selectedAvailIdx.clear();
        renderRows();
      };

      const moveAllLeft = () => {
        if (!state.selected.length) return;
        state.available = state.available.concat(state.selected);
        state.selected = [];
        state.selectedSelIdx.clear();
        renderRows();
      };

      const psCollectInputs = () => {
        const values = {};
        (state.searchParams || []).forEach(p => {
          const name = normalizeKey(p.ParamName || p.paramName);
          if (!name) return;
          const input = formEl?.querySelector(`[data-param="${name}"]`);
          if (input) {
            values[name] = input.value ?? "";
            return;
          }
          const tableKind = p.TableKind ?? p.tableKind;
          const paramValue = p.ParamValue ?? p.paramValue;
          const fromKind = paramValue ? getDefaultFromTableKind(tableKind, paramValue) : "";
          const defVal = fromKind || (p.DefaultValue ?? p.defaultValue ?? p.ParamValue ?? p.paramValue);
          values[name] = defVal == null ? "" : defVal;
        });
        if (values.useid != null && String(values.useid).trim() === "") {
          values.useid = window.DEFAULT_USEID || window._useId || "A001";
        }
        state.inputs = values;
        return values;
      };

      const readSelectedRows = () => {
        const rows = state.selected.map(r => ({ ...r.data }));
        if (!selTable) return rows;
        selTable.querySelectorAll("tbody tr").forEach((tr, idx) => {
          const row = rows[idx] || {};
          tr.querySelectorAll("input[data-field]").forEach(inp => {
            const field = inp.getAttribute("data-field");
            if (!field) return;
            row[field] = inp.value;
          });
          rows[idx] = row;
        });
        return rows;
      };

      const loadDict = async (table) => {
        if (!table) throw new Error("MultiSelectDD is required");
        const url = `/api/TableFieldLayout/DictFields?table=${encodeURIComponent(table)}&lang=TW`;
        const res = await fetch(url, withJwtHeaders());
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("DictFields payload is not array");
        state.dict = data.filter(x => (x.Visible ?? x.visible) === 1 || (x.Visible ?? x.visible) === true).map(c => ({
          FieldName: c.FieldName ?? c.fieldName,
          DisplayLabel: c.DisplayLabel ?? c.displayLabel,
          DisplaySize: c.DisplaySize ?? c.displaySize,
          DataType: c.DataType ?? c.dataType
        }));
        return state.dict;
      };

      const loadParamOptionsPaperSearch = async (itemId, buttonName, paramName, superValue) => {
        const extra = superValue ? `&superValue=${encodeURIComponent(superValue)}` : "";
        const url = `/api/PaperSearch/ParamOptionsV2?itemId=${encodeURIComponent(itemId)}&buttonName=${encodeURIComponent(buttonName)}&paramName=${encodeURIComponent(paramName)}${extra}`;
        const res = await fetch(url, withJwtHeaders());
        if (!res.ok) throw new Error(await res.text());
        return await res.json();
      };

      const getSuperValuePaperSearch = (p) => {
        const rawSuperId = (p.SuperId || p.superId || "").toString().trim().replace(/^@@+/, "");
        const superKey = normalizeKey(rawSuperId);
        if (!superKey) return "";
        const superInput = formEl?.querySelector(`[data-param="${superKey}"]`);
        if (superInput && (superInput.value ?? "") !== "") return superInput.value ?? "";
        const superParam = (state.searchParams || []).find(sp => normalizeKey(sp.ParamName || sp.paramName) === superKey);
        if (!superParam) return "";
        const tk = superParam.TableKind ?? superParam.tableKind;
        const pv = superParam.ParamValue ?? superParam.paramValue;
        const fromKind = pv ? getDefaultFromTableKind(tk, pv) : "";
        return fromKind || (superParam.DefaultValue ?? superParam.defaultValue ?? "");
      };

      const buildFormPaperSearch = async (itemId, buttonName) => {
        if (!formEl) return;
        formEl.innerHTML = "";
        const visibleParams = (state.searchParams || []).filter(p => {
          return Number(p.iVisible ?? p.IVisible ?? 0) === 1;
        });
        const grid = document.createElement("div");
        grid.className = "ps-grid";
        formEl.appendChild(grid);

        for (const p of visibleParams) {
          const name = normalizeKey(p.ParamName || p.paramName);
          if (!name) continue;
          const wrap = document.createElement("div");
          wrap.className = "ps-field";
          const label = document.createElement("label");
          label.className = "form-label ps-label";
          label.textContent = p.DisplayName || p.displayName || name;
          wrap.appendChild(label);

          const controlType = Number(p.ControlType ?? p.controlType ?? 0);
          const tableKind = p.TableKind ?? p.tableKind;
          const paramValue = p.ParamValue ?? p.paramValue;
          let headerDefault = "";
          if (paramValue) {
            headerDefault = getDefaultFromTableKind(tableKind, paramValue);
          }
          if (controlType === 1) {
            const select = document.createElement("select");
            select.className = "form-select form-select-sm ps-control";
            select.setAttribute("data-param", name);
            const emptyOpt = document.createElement("option");
            emptyOpt.value = "";
            emptyOpt.textContent = "";
            select.appendChild(emptyOpt);
            wrap.appendChild(select);
            try {
              const superValue = getSuperValuePaperSearch(p);
              const options = await loadParamOptionsPaperSearch(itemId, buttonName, p.ParamName || p.paramName, superValue);
              if (Array.isArray(options)) {
                options.forEach(opt => {
                  const o = document.createElement("option");
                  const val = opt.value ?? opt.Value ?? "";
                  const text = opt.text ?? opt.Text ?? "";
                  o.value = val;
                  o.textContent = text ? `${val} ${text}`.trim() : val;
                  if (text && text !== val) o.title = text;
                  select.appendChild(o);
                });
              }
              const defVal = headerDefault || (p.DefaultValue ?? p.defaultValue ?? "");
              if (defVal != null && defVal !== "") {
                select.value = applyEditMask(defVal, p.EditMask ?? p.editMask);
              }
            } catch (err) {
              console.warn("load param options failed", err);
            }
          } else {
            const input = document.createElement("input");
            input.className = "form-control form-control-sm ps-control";
            input.type = "text";
            input.setAttribute("data-param", name);
            const defVal = headerDefault || (p.DefaultValue ?? p.defaultValue);
            if (defVal != null && defVal !== "") {
              input.value = applyEditMask(defVal, p.EditMask ?? p.editMask);
            }
            const readOnly = Number(p.iReadOnly ?? p.IReadOnly ?? 0) === 1;
            if (readOnly) input.readOnly = true;
            wrap.appendChild(input);
          }
          grid.appendChild(wrap);
        }

        const fetchWrap = document.createElement("div");
        fetchWrap.className = "ps-actions";
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-primary ps-fetch";
        btn.textContent = "資料重取";
        fetchWrap.appendChild(btn);
        formEl.appendChild(fetchWrap);
      };

      const setFetchLoading = (loading) => {
        const btn = formEl?.querySelector(".ps-fetch");
        if (!btn) return;
        if (loading) {
          btn.classList.add("is-loading");
          btn.setAttribute("aria-busy", "true");
          btn.innerHTML = '<span class="spin">↻</span>查詢中...';
        } else {
          btn.classList.remove("is-loading");
          btn.removeAttribute("aria-busy");
          btn.textContent = "資料重取";
        }
      };

      const fetchSearch = async () => {
        setFetchLoading(true);
        const payload = {
          itemId: state.itemId,
          buttonName: state.buttonName,
          paperNum: state.paperNum,
          params: psCollectInputs()
        };
        try {
          const res = await fetch("/api/PaperSearch/Search", withJwtHeaders({
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          }));
          const raw = await res.text();
          let data; try { data = JSON.parse(raw); } catch { data = { ok: false, error: raw }; }
          if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
          const available = Array.isArray(data.data) ? data.data : [];
          const selected = Array.isArray(data.selected) ? data.selected : [];
          state.available = available.map((r, i) => ({ idx: i, data: r }));
          state.selected = selected.map((r, i) => ({ idx: i, data: r }));
          state.selectedAvailIdx.clear();
          state.selectedSelIdx.clear();
          renderRows();
        } finally {
          setFetchLoading(false);
        }
      };

      const confirmInsert = async () => {
        psCollectInputs();
        const rows = readSelectedRows();
        if (!rows.length) {
          alert("尚未選擇任何項目");
          return;
        }
        const payload = {
          itemId: state.itemId,
          buttonName: state.buttonName,
          paperNum: state.paperNum,
          replace: !!ckReplace?.checked,
          inputs: state.inputs,
          rows
        };
        const res = await fetch("/api/PaperSearch/Confirm", withJwtHeaders({
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }));
        const raw = await res.text();
        let data; try { data = JSON.parse(raw); } catch { data = { ok: false, error: raw }; }
        if (!res.ok || !data.ok) {
          alert(`匯入失敗: ${data.error || `HTTP ${res.status}`}`);
          return;
        }
        if (window.bootstrap && modalEl) {
          try { bootstrap.Modal.getOrCreateInstance(modalEl).hide(); } catch {}
        }
        // 通用回呼：供 PR000004 等自訂按鈕頁面在 paperSearch 確認後執行額外動作
        if (typeof window.__paperSearchAfterConfirm === "function") {
          try { await window.__paperSearchAfterConfirm({ paperNum: state.paperNum }); } catch (e) { console.error('paperSearchAfterConfirm error:', e); }
        }
        localStorage.setItem("afterSave", "1");
        const refresh = window.MasterDetailRefresh && window.MasterDetailRefresh[domId];
        if (typeof refresh === "function") {
          await refresh();
          return;
        }
        location.reload();
      };

      const open = async (ctx, meta) => {
        if (!modalEl) return;
        state.itemId = ctx.itemId || "";
        state.buttonName = ctx.buttonName || "";
        state.paperNum = ctx.paperNum || "";
        state.allowSelCount = toNumber(meta.allowSelCount, 0);
        state.replaceExists = toNumber(meta.replaceExists, 0);
        state.editableFields = new Set();

        const configUrl = `/api/PaperSearch/Config?itemId=${encodeURIComponent(state.itemId)}&buttonName=${encodeURIComponent(state.buttonName)}`;
        const res = await fetch(configUrl, withJwtHeaders());
        if (!res.ok) {
          alert(await res.text());
          return;
        }
        const cfg = await res.json();
        state.searchParams = cfg.searchParams || cfg.SearchParams || [];
        state.insertKeys = cfg.insertKeys || cfg.InsertKeys || [];

        state.editableFields = new Set(
          (state.insertKeys || [])
            .filter(k => Number(k.PositionType ?? k.positionType) === 0)
            .map(k => normalizeKey(k.KeyFieldName || k.keyFieldName))
            .filter(k => k)
        );

        const caption = meta.dialogCaption || cfg.dialogCaption || cfg.DialogCaption || ctx.caption || "查詢並挑選";
        if (titleEl) titleEl.textContent = caption;
        if (ckReplace) ckReplace.checked = false;
        if (state.replaceExists) ckReplace?.closest(".ps-replace")?.classList.remove("d-none");
        else ckReplace?.closest(".ps-replace")?.classList.add("d-none");

        clearTable(availTable);
        clearTable(selTable);
        await loadDict(meta.multiSelectDd || cfg.multiSelectDd || cfg.MultiSelectDd || "");
        buildHeads();
        await buildFormPaperSearch(state.itemId, state.buttonName);
        state.available = [];
        state.selected = [];
        state.selectedAvailIdx.clear();
        state.selectedSelIdx.clear();
        renderRows();

        if (window.bootstrap) {
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        }
      };

      const toggleRowSelection = (tr, set) => {
        const idx = Number(tr.dataset.idx);
        if (!Number.isFinite(idx)) return;
        if (set.has(idx)) set.delete(idx);
        else set.add(idx);
        tr.classList.toggle("ps-row-selected");
      };

      availTable?.addEventListener("click", (ev) => {
        if (ev.detail > 1) return;
        if (ev.target?.closest("input, select, textarea, button, a")) return;
        const tr = ev.target?.closest("tbody tr");
        if (!tr) return;
        toggleRowSelection(tr, state.selectedAvailIdx);
      });

      selTable?.addEventListener("click", (ev) => {
        if (ev.detail > 1) return;
        if (ev.target?.closest("input, select, textarea, button, a")) return;
        const tr = ev.target?.closest("tbody tr");
        if (!tr) return;
        toggleRowSelection(tr, state.selectedSelIdx);
      });

      availTable?.addEventListener("dblclick", (ev) => {
        if (ev.target?.closest("input, select, textarea, button, a")) return;
        const tr = ev.target?.closest("tbody tr");
        if (!tr) return;
        const idx = Number(tr.dataset.idx);
        if (!Number.isFinite(idx)) return;
        if (!state.selectedAvailIdx.has(idx)) {
          state.selectedAvailIdx.add(idx);
          tr.classList.add("ps-row-selected");
        }
        moveRight();
      });

      selTable?.addEventListener("dblclick", (ev) => {
        if (ev.target?.closest("input, select, textarea, button, a")) return;
        const tr = ev.target?.closest("tbody tr");
        if (!tr) return;
        const idx = Number(tr.dataset.idx);
        if (!Number.isFinite(idx)) return;
        if (!state.selectedSelIdx.has(idx)) {
          state.selectedSelIdx.add(idx);
          tr.classList.add("ps-row-selected");
        }
        moveLeft();
      });

      btnRight?.addEventListener("click", moveRight);
      btnLeft?.addEventListener("click", moveLeft);
      btnRightAll?.addEventListener("click", moveAllRight);
      btnLeftAll?.addEventListener("click", moveAllLeft);
      btnConfirm?.addEventListener("click", (e) => { e.preventDefault(); confirmInsert(); });
      modalEl?.addEventListener("click", (ev) => {
        const btn = ev.target.closest(".ps-fetch");
        if (!btn) return;
        ev.preventDefault();
        fetchSearch().catch(err => alert(`查詢失敗: ${err?.message || err}`));
      });

      return { open };
    })();

    const runCustomButton = async (btn) => {
      const name = btn.dataset.buttonName || btn.dataset.customBtn || "";
      if (!name) return;
      const handlers = window.MasterDetailCustomHandlers || {};
      const handler = handlers[name];
      const ctx = {
        buttonName: name,
        itemId,
        domId,
        masterRow: lastMasterRow,
        detailRow: lastDetailRow,
        paperNum: pickPaperNum(lastMasterRow)
      };
      const needInEdit = (btn.dataset.bNeedInEdit || "").toString();
      if (needInEdit === "1" && !window._mdEditing) {
        alert("此按鈕僅能在編輯模式使用，請先點「修改」切換到編輯模式。");
        return;
      }
      if (typeof handler === 'function') {
        try {
          handler(ctx);
        } catch (err) {
          alert('按鈕執行錯誤: ' + (err?.message || err));
        }
        return;
      }

      const searchTemplate = (btn.dataset.searchTemplate || "").toString().trim().toLowerCase();
      const designType = parseInt(btn.dataset.designType || "0", 10);
      if (searchTemplate === "jsdcondrunspdll.dll") {
        if (designType === 1) {
          if (!ctx.paperNum) {
            alert("找不到單號(PaperNum)，請先選取主檔資料。");
            return;
          }
          await condRunSp.open(ctx, { dialogCaption: btn.dataset.dialogCaption || "" });
          return;
        }
      }

      if (searchTemplate === "jsdpapersearchdll.dll") {
        if (designType !== 1) {
          alert("此按鈕 SearchTemplate=JSdPaperSearchDLL.dll，但 DesignType 不是 1，請調整按鈕設定。");
          return;
        }
        try {
          const meta = {
            dialogCaption: btn.dataset.dialogCaption || "",
            allowSelCount: btn.dataset.allowSelCount || 0,
            replaceExists: btn.dataset.replaceExists || 0,
            multiSelectDd: btn.dataset.multiSelectDd || ""
          };
          await paperSearch.open(ctx, meta);
        } catch (err) {
          console.error("paper search template error", err);
          alert(`執行失敗: ${err?.message || err}`);
        }
        return;
      }

      if (designType === 3) {
        try {
          const resp = await fetch('/api/StoredProc/execByButton', withJwtHeaders({
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              itemId: ctx.itemId,
              buttonName: ctx.buttonName,
              paperNum: ctx.paperNum,
              args: {
                opKind: window._mdEditing ? 1 : 0,
                masterRow: lastMasterRow || null,
                detailRow: lastDetailRow || null
              }
            })
          }));
          const raw = await resp.text();
          let data; try { data = JSON.parse(raw); } catch { data = { ok: false, error: raw }; }
          if (resp.ok && data.ok) {
            localStorage.setItem("afterSave", "1");
            const refresh = window.MasterDetailRefresh && window.MasterDetailRefresh[domId];
            if (typeof refresh === "function") {
              await refresh();
              return;
            }
            location.reload();
            return;
          }
          alert(`執行失敗: ${data.error || `HTTP ${resp.status}`}`);
        } catch (err) {
          alert(`執行失敗: ${err?.message || err}`);
        }
        return;
      }

      alert(`尚未實作按鈕: ${name}`);
    };

    bar.querySelectorAll('[data-custom-btn]').forEach(btn => {
      btn.addEventListener('click', () => runCustomButton(btn));
    });
  }
});
</script>
