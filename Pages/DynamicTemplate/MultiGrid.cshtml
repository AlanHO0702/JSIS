@page "/CUR/MultiGrid/{itemId}"
@model PcbErpApi.Pages.CUR.MultiGridModel
@{
    Layout = "_Layout";
    var tabs = Model.Tabs ?? new List<PcbErpApi.Pages.CUR.MultiGridModel.GridTabViewModel>();
    var activeKey = Model.ActiveTabKey;
}

<link rel="stylesheet" href="~/css/grid-toolbar.css" />

<div class="container py-4">
    @if (!string.IsNullOrWhiteSpace(ViewData["LoadError"] as string))
    {
        <div class="alert alert-warning">@ViewData["LoadError"]</div>
    }

    @if (tabs.Count == 0)
    {
        <div class="alert alert-info">找不到對應的表格設定。</div>
    }
    else
    {
        <div class="mb-2 btn-tight-group">
            <button type="button" class="btn btn-primary btn-sm" id="btnMgEdit">編輯</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnMgAdd">新增</button>
            <button type="button" class="btn btn-success btn-sm" id="btnMgSave">儲存</button>
            <button type="button" class="btn btn-danger btn-sm" id="btnMgDelete">刪除</button>
        </div>

        <ul class="nav nav-tabs flex-wrap mb-2" role="tablist">
            @foreach (var tab in tabs)
            {
                var isActive = string.Equals(tab.TabKey, activeKey, StringComparison.OrdinalIgnoreCase);
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(isActive ? "active" : "")"
                            id="tab-@tab.TabKey-tab"
                            data-mg-tab="@tab.TabKey"
                            data-dict-table="@tab.DictTableName"
                            data-bs-toggle="tab"
                            data-bs-target="#tab-@tab.TabKey"
                            type="button" role="tab"
                            aria-controls="tab-@tab.TabKey"
                            aria-selected="@(isActive ? "true" : "false")">
                        @tab.DisplayName
                    </button>
                </li>
            }
        </ul>

        <div class="tab-content pt-1">
            @foreach (var tab in tabs)
            {
                var isActive = string.Equals(tab.TabKey, activeKey, StringComparison.OrdinalIgnoreCase);
                <div class="tab-pane fade @(isActive ? "show active" : "")" id="tab-@tab.TabKey" role="tabpanel" aria-labelledby="tab-@tab.TabKey-tab">
                    <partial name="~/Pages/Shared/_MultiGridTab.cshtml" model="tab" />
                </div>
            }
        </div>
    }
</div>

<script src="~/js/gridToolbarTemplate.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const btnEdit = document.getElementById('btnMgEdit');
    const btnAdd = document.getElementById('btnMgAdd');
    const btnSave = document.getElementById('btnMgSave');
    const btnDelete = document.getElementById('btnMgDelete');
    let isEdit = false;

    const getActiveGrid = () => document.querySelector('.tab-pane.show.active table[id^="grid-"]');

    const ensureEditMode = () => {
        if (!isEdit) toggleEdit();
    };

    const toggleEdit = () => {
        const grid = getActiveGrid();
        if (!grid) return;
        isEdit = !isEdit;
        if (btnEdit) btnEdit.textContent = isEdit ? '檢視' : '編輯';

        grid.querySelectorAll('tbody tr').forEach(tr => {
            tr.querySelectorAll('td').forEach(td => {
                const span = td.querySelector('.cell-view');
                const inp = td.querySelector('.cell-edit');
                if (!span || !inp) return;
                if (isEdit) {
                    span.classList.add('d-none');
                    inp.classList.remove('d-none');
                    inp.defaultValue = inp.type === 'checkbox' ? (inp.checked ? '1' : '0') : inp.value;
                    if (inp.dataset.readonly === '1') {
                        inp.classList.add('readonly-cell');
                        inp.setAttribute('readonly', 'readonly');
                        inp.setAttribute('tabindex', '-1');
                    } else {
                        inp.classList.remove('readonly-cell');
                        inp.removeAttribute('readonly');
                        inp.removeAttribute('tabindex');
                    }
                } else {
                    if (inp.type === 'checkbox') {
                        inp.dataset.raw = inp.checked ? '1' : '0';
                        let viewChk = span.querySelector('input[type="checkbox"]');
                        if (!viewChk) {
                            viewChk = document.createElement('input');
                            viewChk.type = 'checkbox';
                            viewChk.disabled = true;
                            viewChk.tabIndex = -1;
                            viewChk.className = 'form-check-input';
                            span.innerHTML = '';
                            span.appendChild(viewChk);
                        }
                        viewChk.checked = !!inp.checked;
                    } else {
                        inp.dataset.raw = inp.value;
                        span.textContent = inp.value;
                    }
                    span.classList.remove('d-none');
                    inp.classList.add('d-none');
                }
            });
        });
    };

    const addRow = () => {
        const grid = getActiveGrid();
        if (!grid) return;
        ensureEditMode();
        const tbody = grid.querySelector('tbody');
        if (!tbody) return;
        const template = tbody.querySelector('tr');
        if (!template) { alert('沒有範本列，無法新增'); return; }

        const keyFieldsRaw = (grid.dataset.keyFields || '').split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
        const keyDefaults = {};
        keyFieldsRaw.forEach(k => {
            const match = Array.from(template.querySelectorAll('.cell-edit')).find(i => (i.name || '').toLowerCase() === k);
            if (match) keyDefaults[k] = match.value || match.dataset.raw || '';
        });

        const clone = template.cloneNode(true);
        clone.dataset.state = 'added';
        clone.classList.add('table-warning');

        clone.querySelectorAll('.cell-edit').forEach(inp => {
            const name = inp.name || '';
            const nameLower = name.toLowerCase();
            const isKey = keyFieldsRaw.includes(nameLower);
            const isReadOnly = inp.dataset.readonly === '1';
            // 對可編輯的鍵欄位預設空值，讓使用者自行輸入；唯讀鍵保留原值
            const val = (isKey && !isReadOnly) ? '' : (keyFieldsRaw.includes(nameLower) ? (keyDefaults[nameLower] || '') : '');
            inp.value = val;
            inp.defaultValue = val;
            inp.dataset.raw = val;
            if (isEdit) {
                inp.classList.remove('d-none');
                if (isReadOnly || (isKey && val !== '')) {
                    inp.classList.add('readonly-cell');
                    inp.setAttribute('readonly', 'readonly');
                    inp.setAttribute('tabindex', '-1');
                } else {
                    inp.classList.remove('readonly-cell');
                    inp.removeAttribute('readonly');
                    inp.removeAttribute('tabindex');
                }
            }
        });
        clone.querySelectorAll('.cell-view').forEach(span => {
            span.textContent = '';
            if (isEdit) span.classList.add('d-none');
        });

        // 隱藏鍵欄位可能不存在可見欄位
        keyFieldsRaw.forEach(k => {
            const exists = Array.from(clone.querySelectorAll('.cell-edit')).some(i => (i.name || '').toLowerCase() === k);
            if (!exists) {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.className = 'cell-edit d-none readonly-cell key-field-hidden';
                hidden.name = k;
                hidden.value = keyDefaults[k] || '';
                hidden.dataset.raw = keyDefaults[k] || '';
                hidden.dataset.readonly = '1';
                clone.appendChild(hidden);
            }
        });

        if (tbody.firstChild) tbody.insertBefore(clone, tbody.firstChild);
        else tbody.appendChild(clone);
        return clone;
    };

    const cancelAdd = () => {
        const grid = getActiveGrid();
        if (!grid) return;
        grid.querySelectorAll('tbody tr[data-state="added"]').forEach(tr => tr.remove());
    };

    // 行選取：點擊任何 grid 的 tr 即標記 table-primary，供刪除使用
    document.addEventListener('click', (e) => {
        const tr = e.target.closest('table[id^="grid-"] tbody tr');
        if (!tr) return;
        const tbody = tr.closest('tbody');
        if (!tbody) return;
        tbody.querySelectorAll('tr').forEach(r => r.classList.remove('table-primary'));
        tr.classList.add('table-primary');
    });

    const collectChanges = (grid, onlyAdded = false, includeDeleted = false) => {
        const changes = [];
        const keyFieldsRaw = (grid?.dataset.keyFields || '').split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
        grid?.querySelectorAll('tbody tr').forEach(tr => {
            const isAdded = tr.dataset.state === 'added';
            const isDeleted = tr.dataset.state === 'deleted';
            if (includeDeleted && isDeleted) {
                const row = {};
                keyFieldsRaw.forEach(kf => {
                    const match = Array.from(tr.querySelectorAll('.cell-edit')).find(i => (i.name || '').toLowerCase() === kf);
                    if (match) row[match.name] = match.type === 'checkbox' ? (match.checked ? '1' : '0') : (match.value ?? '');
                });
                row.__delete = true;
                changes.push(row);
                return;
            }
            let hasDiff = isAdded;
            const row = {};
            tr.querySelectorAll('.cell-edit').forEach(inp => {
                const name = inp.name;
                if (!name) return;
                const oldVal = inp.defaultValue ?? '';
                const newVal = inp.type === 'checkbox' ? (inp.checked ? '1' : '0') : (inp.value ?? '');
                if (inp.dataset.readonly !== '1' && newVal !== oldVal) hasDiff = true;
                row[name] = newVal;
            });
            keyFieldsRaw.forEach(kf => {
                const match = Array.from(tr.querySelectorAll('.cell-edit')).find(i => (i.name || '').toLowerCase() === kf);
                if (match) row[match.name] = match.type === 'checkbox' ? (match.checked ? '1' : '0') : (match.value ?? '');
            });
            if (onlyAdded) {
                if (isAdded) changes.push(row);
            } else {
                if (hasDiff) changes.push(row);
            }
        });
        return changes;
    };

    const saveChanges = async (onlyAdded = false, includeDeleted = false) => {
        const grid = getActiveGrid();
        if (!grid) return;
        const changes = collectChanges(grid, onlyAdded, includeDeleted);
        if (changes.length === 0) { if (!onlyAdded) toggleEdit(); return; }
        const tableName = grid.dataset.tableName || grid.dataset.dictTable;
        if (!tableName) { alert('缺少 TableName'); return; }
        const resp = await fetch('/api/CommonTable/SaveTableChanges', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ TableName: tableName, Data: changes })
        });
        if (resp.ok) {
            alert('儲存成功');
            toggleEdit();
        } else {
            alert('儲存失敗: ' + await resp.text());
        }
    };

    const getSelectedRow = () => {
        const grid = getActiveGrid();
        if (!grid) return null;
        return grid.querySelector('tbody tr.table-primary');
    };

    const deleteSelectedRow = async () => {
        const grid = getActiveGrid();
        if (!grid) return;
        const sel = getSelectedRow();
        if (!sel) { alert('請先選擇要刪除的資料列'); return; }
        if (!confirm('確定要刪除這筆資料嗎？')) return;
        sel.dataset.state = 'deleted';
        sel.classList.remove('table-warning');
        sel.classList.add('table-danger');
        await saveChanges(false, true);
    };

    document.querySelectorAll('[data-mg-tab]').forEach(btn => {
        btn.addEventListener('shown.bs.tab', (ev) => {
            const key = ev.target?.dataset?.mgTab;
            if (!key) return;
            const url = new URL(window.location.href);
            url.searchParams.set('tab', key);
            history.replaceState({}, '', url);
            const dict = ev.target?.dataset?.dictTable;
            if (dict) window._dictTableName = dict;
        });
        if (btn.classList.contains('active')) {
            const dict = btn.dataset?.dictTable;
            if (dict) window._dictTableName = dict;
        }
    });

    window.createGridController({
        name: 'multiGrid',
        btnToggle: btnEdit,
        btnAdd,
        btnSave,
        btnDelete,
        customToggle: toggleEdit,
        customAdd: () => addRow(),
        customSave: () => saveChanges(false),
        onCancelPending: () => cancelAdd(),
        onDelete: () => {
            // 若有未儲存新增，取消；否則刪除選取列
            const grid = getActiveGrid();
            const pending = grid?.querySelector('tbody tr[data-state=\"added\"]');
            if (pending) { cancelAdd(); return; }
            return deleteSelectedRow();
        }
    });
});
</script>

@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", null, ViewData)
<script src="~/js/fieldDictModal.js"></script>
