@page "/CUR/MultiGrid/{itemId}"
@model PcbErpApi.Pages.CUR.MultiGridModel
@using System.Text.Json
@{
    Layout = "_Layout";
    var tabs = Model.Tabs ?? new List<PcbErpApi.Pages.CUR.MultiGridModel.GridTabViewModel>();
    var activeKey = Model.ActiveTabKey;
    var enableRowDelete = true;
}

@if (!string.IsNullOrWhiteSpace(ViewData["LoadError"] as string))
{
    <div class="alert alert-warning">@ViewData["LoadError"]</div>
}

@if (tabs.Count == 0)
{
    <div class="alert alert-info">找不到對應的表格設定。</div>
}
else
{
<div class="table-wrapper">
  <div class="card shadow-sm border-0">
    <div class="card-body">

      <div class="top-toolbar multigrid-toolbar">
        <div class="toolbar-icon-row" role="group" aria-label="row-nav-and-actions">
          <button id="mgFirst" type="button" class="btn toolbar-btn toolbar-btn-icon" title="第一筆" aria-label="第一筆"><i class="bi bi-chevron-bar-left toolbar-icon"></i></button>
          <button id="mgPrev" type="button" class="btn toolbar-btn toolbar-btn-icon" title="上一筆" aria-label="上一筆"><i class="bi bi-chevron-left toolbar-icon"></i></button>
          <button id="mgNext" type="button" class="btn toolbar-btn toolbar-btn-icon" title="下一筆" aria-label="下一筆"><i class="bi bi-chevron-right toolbar-icon"></i></button>
          <button id="mgLast" type="button" class="btn toolbar-btn toolbar-btn-icon" title="最後一筆" aria-label="最後一筆"><i class="bi bi-chevron-bar-right toolbar-icon"></i></button>
          <button id="mgAdd" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add" title="新增" aria-label="新增" disabled><span class="toolbar-icon">+</span></button>
          <button id="mgDelete" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-del" title="刪除" aria-label="刪除" disabled @(enableRowDelete ? "" : "data-lock='1'")><span class="toolbar-icon">-</span></button>
          <button id="mgSave" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add toolbar-btn-check" title="儲存" aria-label="儲存" disabled><span class="toolbar-icon">✓</span></button>
          <button id="mgCancel" type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-cancel toolbar-btn-check" title="取消" aria-label="取消" disabled><span class="toolbar-icon">&times;</span></button>
        </div>
        <div class="toolbar-main">
          <div class="d-flex gap-2 flex-wrap align-items-center">
            <div id="multiGridCountBox" class="toolbar-count-box mode-view">
              <div id="multiGridMode" class="count-line">瀏覽模式</div>
              <div id="multiGridCount" class="count-line">0 / 0</div>
            </div>
            <button id="btnEditToggle" type="button" class="btn toolbar-btn">
              <i class="bi bi-pencil-square"></i>修改
            </button>
          </div>
        </div>
        <div class="d-flex justify-content-end gap-2"></div>
      </div>

      <ul class="nav nav-tabs flex-wrap mb-0" role="tablist">
        @foreach (var tab in tabs)
        {
          var isActive = string.Equals(tab.TabKey, activeKey, StringComparison.OrdinalIgnoreCase);
          <li class="nav-item" role="presentation">
            <button class="nav-link @(isActive ? "active" : "")"
                    id="tab-@tab.TabKey-tab"
                    data-mg-tab="@tab.TabKey"
                    data-dict-table="@tab.DictTableName"
                    data-bs-toggle="tab"
                    data-bs-target="#tab-@tab.TabKey"
                    type="button" role="tab"
                    aria-controls="tab-@tab.TabKey"
                    aria-selected="@(isActive ? "true" : "false")">
              @tab.DisplayName
            </button>
          </li>
        }
      </ul>

      <div class="tab-content pt-0">
        @foreach (var tab in tabs)
        {
          var isActive = string.Equals(tab.TabKey, activeKey, StringComparison.OrdinalIgnoreCase);
          <div class="tab-pane fade @(isActive ? "show active" : "")" id="tab-@tab.TabKey" role="tabpanel" aria-labelledby="tab-@tab.TabKey-tab">
            <partial name="~/Pages/Shared/_MultiGridTab.cshtml" model="tab" />
          </div>
        }
      </div>

    </div>
  </div>
</div>
}

<style>
.table-fix-wrapper{flex:1;overflow:auto;background:#fff;border:1px solid #dee2e6;border-radius:.5rem;white-space:nowrap;min-height:0}
 .table-wrapper{--mg-row-h:20px}
 .table-wrapper{height:calc(100vh - var(--app-toolbar-height, 56px));display:flex;flex-direction:column}
 .table-wrapper>.card{flex:1;display:flex;flex-direction:column;min-height:0}
 .table-wrapper>.card>.card-body{flex:1;display:flex;flex-direction:column;min-height:0;padding-top:12px;padding-bottom:8px}
 table.table{table-layout:auto;border-collapse:collapse!important;font-size:.85rem;width:auto!important;min-width:0}
table th,table td{vertical-align:middle!important;border:1px solid #dee2e6!important;padding:0!important;white-space:nowrap;height:var(--mg-row-h)}
table th{padding:2px 6px!important}
.table-hover tbody tr:hover{background:#f1f5ff!important}
.cell-view,.cell-edit{display:block;width:100%;height:var(--mg-row-h)!important;min-height:var(--mg-row-h)!important;max-height:var(--mg-row-h)!important;font-size:.85rem;line-height:16px!important;box-sizing:border-box;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding:2px 6px!important}
.cell-view{text-align:inherit;border:none!important;background:transparent!important}
.cell-edit.form-control{height:var(--mg-row-h)!important;min-height:var(--mg-row-h)!important;max-height:var(--mg-row-h)!important;padding:2px 6px!important;font-size:inherit!important;line-height:16px!important;text-align:inherit!important;border:none!important;border-radius:0!important;box-sizing:border-box!important;background:transparent!important;vertical-align:middle!important;margin:0!important}
.table-wrapper .grid-table .form-check-input{
  width:18px!important;
  min-width:18px!important;
  max-width:18px!important;
  height:18px!important;
  min-height:18px!important;
  max-height:18px!important;
  padding:0!important;
  margin:0 auto!important;
  display:inline-block;
}
.table-wrapper .grid-table td.cell-checkbox{
  text-align:center;
  padding:0 !important;
  line-height:var(--mg-row-h);
}
.table-wrapper .grid-table td.cell-checkbox .cell-view{
  display:flex !important;
  align-items:center;
  justify-content:center;
  width:100%;
  height:var(--mg-row-h);
  line-height:var(--mg-row-h);
  padding:0 !important;
}
.table-wrapper .grid-table td.cell-checkbox .cell-view.d-none{ display:none !important; }
.table-wrapper .grid-table td.cell-checkbox .cell-edit:not([type="checkbox"]){
  display:inline-block;
  width:100%;
  height:var(--mg-row-h);
  line-height:var(--mg-row-h);
  padding:0 !important;
}
.table-wrapper .grid-table td.cell-checkbox .cell-edit[type="checkbox"]{
  display:inline-block;
  width:18px !important;
  height:18px !important;
  min-height:18px !important;
  max-height:18px !important;
  line-height:18px !important;
  padding:0 !important;
  margin:0 auto !important;
  vertical-align:middle;
}
.cell-number{text-align:right}
.cell-text{text-align:left}
table.table tbody td{background:#f3f3f3!important}
.edit-mode table.table tbody td{background:#fff!important}
.edit-mode table.table tbody td.readonly-td{background:#f3f3f3!important}
.readonly-cell{color:#555!important;border:none!important;cursor:not-allowed!important;pointer-events:none!important;user-select:none!important}
.table-fix-wrapper::-webkit-scrollbar{height:10px;width:10px}
.table-fix-wrapper::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:6px}
.table-fix-wrapper::-webkit-scrollbar-thumb:hover{background:#9ca3af}
table.grid-table tbody tr:hover {background-color: #f9f2d7 !important; cursor: pointer;}
table.grid-table tbody tr.selected-row {background-color: #fff3cd !important; transition: background-color .15s;}
table th{position:relative;}
.col-resizer{position:absolute;top:0;right:-3px;width:6px;cursor:col-resize;user-select:none;height:100%;}
.top-toolbar{display:flex;align-items:center;gap:6px;flex-wrap:wrap;width:100%;margin-bottom:14px;border-radius:10px;background:#f6f7f9;border:1px solid #d8dee8;padding:6px 8px;box-shadow:0 1px 2px rgba(20,40,80,0.06)}
.multigrid-toolbar{--top-toolbar-icon-font-size: 20px;}
.top-toolbar .toolbar-icon-row{display:flex;gap:4px;align-items:center}
.top-toolbar .toolbar-main{display:flex;align-items:center;gap:6px;flex-wrap:nowrap;flex:1 1 0;min-width:0}
.toolbar-btn{display:flex;align-items:center;gap:4px;background:#fff;color:#2a4a7a;border:1px solid #b9c7de;border-radius:11px;font-size:var(--top-toolbar-font-size);font-weight:500;padding:5px 10px;box-shadow:none;transition:background .18s, transform .11s, border-color .18s, color .18s;cursor:pointer}
.toolbar-btn:hover,.toolbar-btn:focus{background:#eef3fb;border-color:#9fb2d2;transform:translateY(-1px) scale(1.02)}
.toolbar-btn.primary{background:#2564b3;border-color:#2564b3;color:#fff;box-shadow:0 2px 8px rgba(37,100,179,0.25)}
.toolbar-btn.primary:hover,.toolbar-btn.primary:focus{background:#215aa2;border-color:#215aa2;color:#fff}
.toolbar-btn i{font-size:1.08em}
.top-toolbar .toolbar-btn{font-size:var(--top-toolbar-font-size);height:var(--top-toolbar-btn-height);min-height:var(--top-toolbar-btn-height);padding:0 6px;line-height:1}
.top-toolbar .toolbar-btn-icon{display:inline-flex;align-items:center;justify-content:center;height:var(--top-toolbar-btn-height);min-height:var(--top-toolbar-btn-height);padding:0;width:30px;border-radius:8px;font-size:var(--top-toolbar-icon-font-size);line-height:1;background:#f3f5f8;border:1px solid #c9d2df;color:#5a6a82;box-shadow:none}
.top-toolbar .toolbar-icon{display:inline-block;font-size:var(--top-toolbar-icon-font-size);line-height:1}
.top-toolbar .toolbar-btn-icon i{font-size:var(--top-toolbar-icon-font-size);line-height:1}
.top-toolbar .toolbar-btn:disabled{background:#f1f3f7;border-color:#c5ccd8;color:#9aa7bb;cursor:not-allowed;box-shadow:none;opacity:0.8}
.top-toolbar .toolbar-btn-icon.toolbar-btn-add{background:#f7fcf9;border-color:#7ccfa1;color:#1f7a45}
.top-toolbar .toolbar-btn-icon.toolbar-btn-del,
.top-toolbar .toolbar-btn-icon.toolbar-btn-cancel{background:#fff4f4;border-color:#e08a8a;color:#b33939}
.top-toolbar .toolbar-btn-check,.top-toolbar .toolbar-btn-cancel{font-size:18px}
.toolbar-count-box{display:inline-flex;flex-direction:column;justify-content:center;align-items:center;height:var(--top-toolbar-btn-height, 36px);min-width:74px;padding:2px 8px;border-radius:6px;font-weight:700;line-height:1.05;color:#fff;user-select:none}
.toolbar-count-box .count-line{font-size:0.75rem}
.toolbar-count-box.mode-view{background:#1e4db7}
.toolbar-count-box.mode-edit{background:#f00000}
.checkbox-dark {
  accent-color: #2c3e50;
  border-color: #2c3e50 !important;
  box-shadow: none !important;
}
.tab-content{flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden}
.tab-pane{flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden}
.tab-pane .card{flex:1;display:flex;flex-direction:column;min-height:0}
.tab-pane .card-body{flex:1;display:flex;flex-direction:column;min-height:0}
.table-wrapper .nav-tabs{margin-bottom:0}
.table-wrapper .nav-tabs .nav-link{
  border-radius:8px 8px 0 0 !important;
  padding:var(--tab-pad-y) var(--tab-pad-x);
  font-size:var(--field-label-size);
  font-weight:500;
  color:#4a6fa8;
  background:#dde7f7;
  border:1px solid #bccdea;
  border-bottom-color:#aabedd;
}
.table-wrapper .nav-tabs .nav-link.active{
  background:#ffffff;
  color:#1b3f8a;
  border-color:#7da3df #7da3df #fff #7da3df !important;
  box-shadow:0 3px 10px 0 rgba(14,53,95,0.18);
  font-weight:750;
}
.table-wrapper .nav-tabs .nav-link:not(.active):hover{
  background:#d0dcf2;
  color:#3b5d92;
}
.table-wrapper .tab-content{padding-top:2px}
</style>

<script src="~/js/gridToolbarTemplate.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const editBtn = document.getElementById('btnEditToggle');
    const mgFirst = document.getElementById('mgFirst');
    const mgPrev = document.getElementById('mgPrev');
    const mgNext = document.getElementById('mgNext');
    const mgLast = document.getElementById('mgLast');
    const mgAdd = document.getElementById('mgAdd');
    const mgDelete = document.getElementById('mgDelete');
    const mgSave = document.getElementById('mgSave');
    const mgCancel = document.getElementById('mgCancel');
    const wrapper = document.querySelector('.table-wrapper');
    const modeEl = document.getElementById('multiGridMode');
    const countEl = document.getElementById('multiGridCount');
    const countBox = document.getElementById('multiGridCountBox');
    let isEdit = false;
    let isDirty = false;

    const getActiveGrid = () => document.querySelector('.tab-pane.show.active table[id^="grid-"]');
    const getActivePane = () => document.querySelector('.tab-pane.show.active');

    const setModePanel = (editing) => {
        if (!modeEl) return;
        modeEl.textContent = editing ? '編輯模式' : '瀏覽模式';
        if (wrapper) {
            wrapper.classList.toggle('edit-mode', editing);
        }
        if (countBox) {
            countBox.classList.toggle('mode-edit', editing);
            countBox.classList.toggle('mode-view', !editing);
        }
        if (editBtn) {
            editBtn.innerHTML = editing
                ? '<i class="bi bi-eye"></i>瀏覽'
                : '<i class="bi bi-pencil-square"></i>修改';
        }
        if (mgAdd) mgAdd.disabled = !editing;
        if (mgSave) mgSave.disabled = !editing || !isDirty;
        if (mgCancel) mgCancel.disabled = !editing || !isDirty;
        if (mgDelete) {
            const locked = mgDelete.dataset.lock === '1';
            mgDelete.disabled = !editing || locked;
        }
        if (mgFirst) mgFirst.disabled = false;
        if (mgPrev) mgPrev.disabled = false;
        if (mgNext) mgNext.disabled = false;
        if (mgLast) mgLast.disabled = false;
    };

    const updateCountPanel = () => {
        if (!countEl) return;
        const grid = getActiveGrid();
        if (!grid) {
            countEl.textContent = '0 / 0';
            return;
        }
        const rows = grid.querySelectorAll('tbody tr');
        const total = grid.dataset.totalCount || rows.length;
        const selected = grid.querySelector('tbody tr.selected-row');
        const idx = selected ? Array.from(rows).indexOf(selected) + 1 : 0;
        countEl.textContent = `${idx} / ${total}`;
    };

    const setDirty = (dirty) => {
        isDirty = !!dirty;
        if (!isEdit) return;
        if (mgSave) mgSave.disabled = !isDirty;
        if (mgCancel) mgCancel.disabled = !isDirty;
    };

    const selectRow = (tr) => {
        if (!tr) return;
        const grid = getActiveGrid();
        if (grid) {
            grid.querySelectorAll('tbody tr').forEach(r => r.classList.remove('selected-row', 'table-primary'));
        }
        tr.classList.add('selected-row', 'table-primary');
        updateCountPanel();
    };

    const ensureEditMode = () => {
        if (!isEdit) toggleEdit();
    };

    const toggleEdit = () => {
        const grid = getActiveGrid();
        if (!grid) return;
        isEdit = !isEdit;
        setModePanel(isEdit);

        grid.querySelectorAll('tbody tr').forEach(tr => {
            tr.querySelectorAll('td').forEach(td => {
                const span = td.querySelector('.cell-view');
                const inp = td.querySelector('.cell-edit');
                if (!span || !inp) return;
                if (isEdit) {
                    inp.defaultValue = inp.type === 'checkbox' ? (inp.checked ? '1' : '0') : inp.value;
                    if (inp.dataset.readonly === '1') {
                        inp.classList.add('readonly-cell');
                        inp.setAttribute('readonly', 'readonly');
                        inp.setAttribute('tabindex', '-1');
                        span.classList.remove('d-none');
                        inp.classList.add('d-none');
                        span.classList.add('readonly-cell');
                    } else {
                        span.classList.add('d-none');
                        inp.classList.remove('d-none');
                        inp.classList.remove('readonly-cell');
                        inp.removeAttribute('readonly');
                        inp.removeAttribute('tabindex');
                    }
                } else {
                    if (inp.type === 'checkbox') {
                        inp.dataset.raw = inp.checked ? '1' : '0';
                        let viewChk = span.querySelector('input[type="checkbox"]');
                        if (!viewChk) {
                            viewChk = document.createElement('input');
                            viewChk.type = 'checkbox';
                            viewChk.disabled = true;
                            viewChk.tabIndex = -1;
                            viewChk.className = 'form-check-input checkbox-dark';
                            span.innerHTML = '';
                            span.appendChild(viewChk);
                        }
                        viewChk.checked = !!inp.checked;
                    } else {
                        inp.dataset.raw = inp.value;
                        if (inp.dataset.readonly === '1' && (inp.value ?? '') === '') {
                            // Preserve lookup display text for read-only, non-physical fields.
                        } else {
                            span.textContent = inp.value;
                        }
                    }
                    span.classList.remove('d-none');
                    inp.classList.add('d-none');
                }
            });
        });
    };

    const addRow = () => {
        const grid = getActiveGrid();
        if (!grid) return;
        ensureEditMode();
        const tbody = grid.querySelector('tbody');
        if (!tbody) return;
        const template = tbody.querySelector('tr');
        if (!template) { alert('沒有範本列，無法新增'); return; }

        const keyFieldsRaw = (grid.dataset.keyFields || '').split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
        const keyDefaults = {};
        keyFieldsRaw.forEach(k => {
            const match = Array.from(template.querySelectorAll('.cell-edit')).find(i => (i.name || '').toLowerCase() === k);
            if (match) keyDefaults[k] = match.value || match.dataset.raw || '';
        });

        const clone = template.cloneNode(true);
        clone.dataset.state = 'added';
        clone.classList.add('table-warning');

        clone.querySelectorAll('.cell-edit').forEach(inp => {
            const name = inp.name || '';
            const nameLower = name.toLowerCase();
            const isKey = keyFieldsRaw.includes(nameLower);
            const isReadOnly = inp.dataset.readonly === '1';
            const val = (isKey && !isReadOnly) ? '' : (keyFieldsRaw.includes(nameLower) ? (keyDefaults[nameLower] || '') : '');
            inp.value = val;
            inp.defaultValue = val;
            inp.dataset.raw = val;
            if (isEdit) {
                inp.classList.remove('d-none');
                if (isReadOnly || (isKey && val !== '')) {
                    inp.classList.add('readonly-cell');
                    inp.setAttribute('readonly', 'readonly');
                    inp.setAttribute('tabindex', '-1');
                } else {
                    inp.classList.remove('readonly-cell');
                    inp.removeAttribute('readonly');
                    inp.removeAttribute('tabindex');
                }
            }
        });
        clone.querySelectorAll('.cell-view').forEach(span => {
            span.textContent = '';
            if (isEdit) span.classList.add('d-none');
        });

        keyFieldsRaw.forEach(k => {
            const exists = Array.from(clone.querySelectorAll('.cell-edit')).some(i => (i.name || '').toLowerCase() === k);
            if (!exists) {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.className = 'cell-edit d-none readonly-cell key-field-hidden';
                hidden.name = k;
                hidden.value = keyDefaults[k] || '';
                hidden.dataset.raw = keyDefaults[k] || '';
                hidden.dataset.readonly = '1';
                clone.appendChild(hidden);
            }
        });

        if (tbody.firstChild) tbody.insertBefore(clone, tbody.firstChild);
        else tbody.appendChild(clone);
        setDirty(true);
        return clone;
    };

    const cancelAdd = () => {
        const grid = getActiveGrid();
        if (!grid) return;
        grid.querySelectorAll('tbody tr[data-state="added"]').forEach(tr => tr.remove());
    };

    // 行選取：點擊任何 grid 的 tr 即標記
    document.addEventListener('click', (e) => {
        const tr = e.target.closest('table[id^="grid-"] tbody tr');
        if (!tr) return;
        selectRow(tr);
    });

    const collectChanges = (grid, onlyAdded = false, includeDeleted = false) => {
        const changes = [];
        const keyFieldsRaw = (grid?.dataset.keyFields || '').split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
        grid?.querySelectorAll('tbody tr').forEach(tr => {
            const isAdded = tr.dataset.state === 'added';
            const isDeleted = tr.dataset.state === 'deleted';
            if (includeDeleted && isDeleted) {
                const row = {};
                keyFieldsRaw.forEach(kf => {
                    const match = Array.from(tr.querySelectorAll('.cell-edit')).find(i => (i.name || '').toLowerCase() === kf);
                    if (match) row[match.name] = match.type === 'checkbox' ? (match.checked ? '1' : '0') : (match.value ?? '');
                });
                row.__delete = true;
                changes.push(row);
                return;
            }
            let hasDiff = isAdded;
            const row = {};
            tr.querySelectorAll('.cell-edit').forEach(inp => {
                const name = inp.name;
                if (!name) return;
                const oldVal = inp.defaultValue ?? '';
                const newVal = inp.type === 'checkbox' ? (inp.checked ? '1' : '0') : (inp.value ?? '');
                if (inp.dataset.readonly !== '1' && newVal !== oldVal) hasDiff = true;
                row[name] = newVal;
            });
            keyFieldsRaw.forEach(kf => {
                const match = Array.from(tr.querySelectorAll('.cell-edit')).find(i => (i.name || '').toLowerCase() === kf);
                if (match) row[match.name] = match.type === 'checkbox' ? (match.checked ? '1' : '0') : (match.value ?? '');
            });
            if (onlyAdded) {
                if (isAdded) changes.push(row);
            } else {
                if (hasDiff) changes.push(row);
            }
        });
        return changes;
    };

    const saveChanges = async (onlyAdded = false, includeDeleted = false) => {
        const grid = getActiveGrid();
        if (!grid) return;
        const changes = collectChanges(grid, onlyAdded, includeDeleted);
        if (changes.length === 0) { if (!onlyAdded) toggleEdit(); return; }
        const tableName = grid.dataset.tableName || grid.dataset.dictTable;
        if (!tableName) { alert('缺少 TableName'); return; }
        const resp = await fetch('/api/CommonTable/SaveTableChanges', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ TableName: tableName, Data: changes })
        });
        if (resp.ok) {
            setDirty(false);
            // 重新載入頁面以刷新資料
            window.location.reload();
        } else {
            alert('儲存失敗: ' + await resp.text());
        }
    };

    const getSelectedRow = () => {
        const grid = getActiveGrid();
        if (!grid) return null;
        return grid.querySelector('tbody tr.selected-row');
    };

    const deleteSelectedRow = async () => {
        const grid = getActiveGrid();
        if (!grid) return;
        const sel = getSelectedRow();
        if (!sel) { alert('請先選擇要刪除的資料列'); return; }
        if (!confirm('確定要刪除這筆資料嗎？')) return;
        sel.dataset.state = 'deleted';
        sel.classList.remove('table-warning');
        sel.classList.add('table-danger');
        await saveChanges(false, true);
    };

    // 導航按鈕
    const navigateRow = (direction) => {
        const grid = getActiveGrid();
        if (!grid) return;
        const rows = Array.from(grid.querySelectorAll('tbody tr'));
        if (rows.length === 0) return;
        const current = grid.querySelector('tbody tr.selected-row');
        let idx = current ? rows.indexOf(current) : -1;

        switch(direction) {
            case 'first': idx = 0; break;
            case 'prev': idx = Math.max(0, idx - 1); break;
            case 'next': idx = Math.min(rows.length - 1, idx + 1); break;
            case 'last': idx = rows.length - 1; break;
        }
        selectRow(rows[idx]);
    };

    mgFirst?.addEventListener('click', () => navigateRow('first'));
    mgPrev?.addEventListener('click', () => navigateRow('prev'));
    mgNext?.addEventListener('click', () => navigateRow('next'));
    mgLast?.addEventListener('click', () => navigateRow('last'));

    // 編輯按鈕
    editBtn?.addEventListener('click', () => toggleEdit());

    // 新增按鈕
    mgAdd?.addEventListener('click', () => addRow());

    // 儲存按鈕
    mgSave?.addEventListener('click', () => saveChanges(false));

    // 刪除按鈕
    mgDelete?.addEventListener('click', () => {
        const grid = getActiveGrid();
        const pending = grid?.querySelector('tbody tr[data-state="added"]');
        if (pending) { cancelAdd(); setDirty(false); return; }
        deleteSelectedRow();
    });

    // 取消按鈕
    mgCancel?.addEventListener('click', async () => {
        cancelAdd();
        if (isEdit) toggleEdit();
        setDirty(false);
    });

    // Tab 切換時更新狀態
    document.querySelectorAll('[data-mg-tab]').forEach(btn => {
        btn.addEventListener('shown.bs.tab', (ev) => {
            const key = ev.target?.dataset?.mgTab;
            if (!key) return;
            const url = new URL(window.location.href);
            url.searchParams.set('tab', key);
            history.replaceState({}, '', url);
            const dict = ev.target?.dataset?.dictTable;
            if (dict) window._dictTableName = dict;
            updateCountPanel();
            // 如果有編輯模式，切換後保持編輯狀態
            if (isEdit) {
                const grid = getActiveGrid();
                if (grid) {
                    grid.querySelectorAll('tbody tr').forEach(tr => {
                        tr.querySelectorAll('td').forEach(td => {
                            const span = td.querySelector('.cell-view');
                            const inp = td.querySelector('.cell-edit');
                            if (span && inp) {
                                span.classList.add('d-none');
                                inp.classList.remove('d-none');
                            }
                        });
                    });
                }
            }
        });
        if (btn.classList.contains('active')) {
            const dict = btn.dataset?.dictTable;
            if (dict) window._dictTableName = dict;
        }
    });

    // 監聽輸入變化以標記 dirty
    document.addEventListener('input', (e) => {
        if (e.target.closest('.cell-edit')) {
            setDirty(true);
        }
    });

    // 初始化狀態面板
    setModePanel(false);
    updateCountPanel();
});
</script>

@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", null, ViewData)
<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>
