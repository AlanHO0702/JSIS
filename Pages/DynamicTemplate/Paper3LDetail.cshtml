@page "/DynamicTemplate/Paper3L/{itemId}/{paperNum}"
@model PcbErpApi.Pages.DynamicTemplate.Paper3LDetailModel
@{
    Layout = "_Layout";
    ViewData["Title"] = string.IsNullOrWhiteSpace(Model.ItemName) ? Model.ItemId : $"{Model.ItemId} {Model.ItemName}";
    ViewData["TableTitle"] = Model.PageTitle;
    ViewData["DictTableName"] = Model.DictTableName;
    ViewData["HeaderRealTableName"] = Model.MasterTable;
    ViewData["AddApiUrl"] = $"/api/DynamicTable/AddPaper/{Model.MasterDictTable}";
    ViewData["SubRouteTemplate"] = Model.DetailRouteTemplate;
    ViewData["QueryRedirectUrl"] = Url.Page("/DynamicTemplate/Paper3L", new { itemId = Model.ItemId }) ?? "/DynamicTemplate/Paper3L";
    ViewData["DeleteApiUrl"] = Model.MasterDictTable;
    ViewData["ReportSpName"] = Model.ReportSpName ?? "";
    ViewData["ActionRailPartial"] = Model.ActionRailPartial;
    ViewData["QueryFields"] = Model.QueryFields;
}

<div class="erp-detail-container">
    @await Html.PartialAsync("~/Pages/Shared/_DetailHeaderSection.cshtml", Model)
    <script>window.__multiTabAutoSelectFirstRow = true;</script>
    @await Html.PartialAsync("~/Pages/Shared/_MultiTabDetail.cshtml")
    @await Html.PartialAsync("~/Pages/Shared/_Paper3LSubDetail1.cshtml")
</div>
@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", Model.FieldDictList, ViewData)
<script>window._itemId = "@(Model.ItemId ?? "")";</script>

@if ((Model.CustomButtons?.Count > 0))
{
    <style>
    :root{
      --fab-left: 12px;
      --fab-width: 120px;
      --fab-gap: 14px;
      --rail-reserve: calc(var(--fab-left) + var(--fab-width) + var(--fab-gap));
    }

    .erp-detail-container{
        margin: 0 !important;
        padding: 2px 8px !important;
        padding-left: calc(var(--rail-reserve)) !important;
        background: var(--page-bg) !important;
    }

    #topToolbar{
        margin-left: calc(-1 * var(--rail-reserve) + 12px) !important;
        padding-left: 0 !important;
        justify-content: flex-start !important;
        position: sticky;
        top: calc(var(--app-toolbar-height, 56px) + 4px);
        z-index: 1200;
    }
    #topToolbar > .ms-2, #topToolbar .btn-toolbar{ margin-left: 0 !important; }

    #headerTabs{ position: relative; z-index: 1; margin-left: 0 !important; }
    .multi-tab-detail{ margin-left: 0 !important; padding-left: 0 !important; }
    </style>
}

<script>window._dictTableName = "@(string.IsNullOrWhiteSpace(Model.DetailDictTable) ? Model.DictTableName : Model.DetailDictTable)";</script>
<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>

<style>
/* =====================================================
   Paper3LDetail 專用樣式：整頁不滾動，單身區塊自己有捲軸
   ===================================================== */

/* 鎖定整頁不滾動 */
html.paper3l-page,
html.paper3l-page body,
html.paper3l-page body.with-toolbar {
    height: 100% !important;
    max-height: 100vh !important;
    overflow: hidden !important;
}

/* 主容器：使用 flex 佈局分配空間 */
html.paper3l-page .erp-detail-container {
    display: flex !important;
    flex-direction: column !important;
    height: calc(100vh - var(--app-toolbar-height, 56px)) !important;
    min-height: 0 !important;
    max-height: calc(100vh - var(--app-toolbar-height, 56px)) !important;
    overflow: hidden !important;
}

/* Toolbar：在 flex 容器內關閉 sticky，改用正常定位，並對齊左側按鈕，延伸到全寬 */
html.paper3l-page .erp-detail-container #topToolbar {
    position: relative !important;
    top: auto !important;
    flex-shrink: 0 !important;
    flex-grow: 0 !important;
    margin-left: calc(-1 * var(--rail-reserve, 146px) + 12px) !important;
    padding-left: 0 !important;
    width: calc(100% + var(--rail-reserve, 146px) - 20px) !important;
    max-width: none !important;
}

/* 單頭區域（action-rail、header form）：固定高度，不伸縮 */
html.paper3l-page .erp-detail-container .action-rail,
html.paper3l-page .erp-detail-container form.erp-header-form {
    flex-shrink: 0 !important;
    flex-grow: 0 !important;
}

/* 單身區域（multi-tab-detail）：限制高度，給第三階更多空間 */
html.paper3l-page .erp-detail-container .multi-tab-detail {
    flex: 0 1 auto !important;
    min-height: 0 !important;
    max-height: 35vh !important;
    overflow: hidden !important;
    display: flex !important;
    flex-direction: column !important;
}

/* Tab 標籤列：固定不滾動 */
html.paper3l-page .multi-tab-detail .nav-tabs {
    flex-shrink: 0 !important;
}

/* Tab 內容區：填滿空間，自己有捲軸 */
html.paper3l-page .multi-tab-detail .tab-content {
    flex: 1 1 auto !important;
    min-height: 0 !important;
    overflow: hidden !important;
    position: relative !important;
}

/* 隱藏非活動的分頁，避免高度疊加 */
html.paper3l-page .multi-tab-detail .tab-pane {
    display: none !important;
}

html.paper3l-page .multi-tab-detail .tab-pane.show.active {
    display: block !important;
    height: 100% !important;
}

/* table-container：填滿 tab-pane */
html.paper3l-page .multi-tab-detail .table-container {
    height: 100% !important;
}

/* 表格 wrapper：填滿並可捲動，讓表頭固定 */
html.paper3l-page .multi-tab-detail .erp-table-wrapper {
    height: 100% !important;
    max-height: none !important;
    overflow: auto !important;
}

/* 第三階明細：獨立區塊，填滿剩餘空間，可捲動 */
html.paper3l-page .erp-detail-container .paper3l-subdetail {
    flex: 1 1 auto !important;
    min-height: 120px !important;
    overflow: auto !important;
    margin-top: 4px !important;
    border-top: 1px solid #d6dbe5;
}

/* 左側自訂按鈕區：縮小高度和間距，起始位置對齊單頭區塊 */
html.paper3l-page .action-rail {
    gap: 1px !important;
}

html.paper3l-page .action-rail .fab {
    padding: 5px 8px !important;
    font-size: 0.88rem !important;
    min-height: 0 !important;
}
</style>

<script>
// 為 html 加上特定 class，讓樣式只影響此頁面
document.documentElement.classList.add('paper3l-page');
</script>
