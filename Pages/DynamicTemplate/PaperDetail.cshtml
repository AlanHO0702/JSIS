@page "/DynamicTemplate/Paper/{itemId}/{paperNum}"
@model PcbErpApi.Pages.DynamicTemplate.PaperDetailModel
@{
    Layout = "_Layout";
    ViewData["Title"] = string.IsNullOrWhiteSpace(Model.ItemName) ? Model.ItemId : $"{Model.ItemId} {Model.ItemName}";
    ViewData["TableTitle"] = Model.PageTitle;
    ViewData["DictTableName"] = Model.DictTableName;
    ViewData["HeaderRealTableName"] = Model.MasterTable;
    ViewData["AddApiUrl"] = $"/api/DynamicTable/AddPaper/{Model.MasterDictTable}";
    ViewData["SubRouteTemplate"] = Model.DetailRouteTemplate;
    ViewData["QueryRedirectUrl"] = Url.Page("/DynamicTemplate/Paper", new { itemId = Model.ItemId }) ?? "/DynamicTemplate/Paper";
    ViewData["DeleteApiUrl"] = Model.MasterDictTable;
    ViewData["ReportSpName"] = Model.ReportSpName ?? "";
    ViewData["ActionRailPartial"] = Model.ActionRailPartial;
    ViewData["QueryFields"] = Model.QueryFields;
}

<div class="erp-detail-container">
    @await Html.PartialAsync("~/Pages/Shared/_DetailHeaderSection.cshtml", Model)
    @await Html.PartialAsync("~/Pages/Shared/_MultiTabDetail.cshtml")

    <!-- 特殊介面容器（由 specialUI.js 動態填充內容） -->
    <div id="specialUIContainer"></div>
</div>
@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", Model.FieldDictList, ViewData)
<script>window._itemId = "@(Model.ItemId ?? "")";</script>

@if ((Model.CustomButtons?.Count > 0))
{
    <style>
    /* PaperDetail 使用 Action Rail（左側自訂按鈕）時，需預留左側空間，避免單頭/頁籤被擋住 */
    :root{
      --fab-left: 12px;
      --fab-width: 120px;
      --fab-gap: 14px;
      --rail-reserve: calc(var(--fab-left) + var(--fab-width) + var(--fab-gap));
    }

    .erp-detail-container{
        margin: 0 !important;
        padding: 2px 8px !important;
        padding-left: calc(var(--rail-reserve)) !important;
        background: var(--page-bg) !important;
    }

    /* toolbar 往回補，維持視覺對齊，並延伸到全寬 */
    #topToolbar{
        margin-left: calc(-1 * var(--rail-reserve) + 12px) !important;
        padding-left: 0 !important;
        justify-content: flex-start !important;
        position: sticky;
        top: calc(var(--app-toolbar-height, 56px) + 4px);
        z-index: 1200;
        width: calc(100% + var(--rail-reserve) - 20px) !important;
        max-width: none !important;
    }
    #topToolbar > .ms-2, #topToolbar .btn-toolbar{ margin-left: 0 !important; }

    /* 確保頁籤不會被左側按鈕擋住 */
    #headerTabs{ position: relative; z-index: 1; margin-left: 0 !important; }
    .multi-tab-detail{ margin-left: 0 !important; padding-left: 0 !important; }

    /* 左側自訂按鈕區：縮小高度和間距 */
    .action-rail {
        gap: 1px !important;
    }
    .action-rail .fab {
        padding: 5px 8px !important;
        font-size: 0.88rem !important;
        min-height: 0 !important;
    }
    </style>
}

@using PcbErpApi.Models
@if (string.Equals(Model.ItemId, "SA000002", StringComparison.OrdinalIgnoreCase))
{
    @await Html.PartialAsync("_OrderDetailPicker",
        new DetailPickerConfig
        {
            ModalId = "detailPicker",
            PaperNum = Model.PaperNum,
            FetchApi = "/api/OrderDetailSearch/fetch",
            InsertApi = "/api/OrderDetailSearch/insert",
            DictTableName = "SPOdOCXOrderPOChice",
            DictUrlBase = "/DataDict/EditList"
        })
}

<script>window._dictTableName = "@(string.IsNullOrWhiteSpace(Model.DetailDictTable) ? Model.DictTableName : Model.DetailDictTable)";</script>
<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>
<script src="~/js/specialUI.js" asp-append-version="true"></script>

<style>
/* =====================================================
   PaperDetail 專用樣式：整頁不滾動，單身區塊自己有捲軸
   ===================================================== */

/* 鎖定整頁不滾動 */
html.paper-page,
html.paper-page body,
html.paper-page body.with-toolbar {
    height: 100% !important;
    max-height: 100vh !important;
    overflow: hidden !important;
}

/* 主容器：使用 flex 佈局分配空間 */
html.paper-page .erp-detail-container {
    display: flex !important;
    flex-direction: column !important;
    height: calc(100vh - var(--app-toolbar-height, 56px)) !important;
    min-height: 0 !important;
    max-height: calc(100vh - var(--app-toolbar-height, 56px)) !important;
    overflow: hidden !important;
}

/* Toolbar：在 flex 容器內關閉 sticky */
html.paper-page .erp-detail-container #topToolbar {
    position: relative !important;
    top: auto !important;
    flex-shrink: 0 !important;
    flex-grow: 0 !important;
}

/* 單頭區域：固定高度，不伸縮 */
html.paper-page .erp-detail-container .action-rail,
html.paper-page .erp-detail-container form.erp-header-form {
    flex-shrink: 0 !important;
    flex-grow: 0 !important;
}

/* 單身區域：填滿剩餘空間 */
html.paper-page .erp-detail-container .multi-tab-detail {
    flex: 1 1 auto !important;
    min-height: 0 !important;
    overflow: hidden !important;
    display: flex !important;
    flex-direction: column !important;
}

/* Tab 標籤列：固定不滾動 */
html.paper-page .multi-tab-detail .nav-tabs {
    flex-shrink: 0 !important;
}

/* Tab 內容區：填滿空間，自己有捲軸 */
html.paper-page .multi-tab-detail .tab-content {
    flex: 1 1 auto !important;
    min-height: 0 !important;
    overflow: hidden !important;
    position: relative !important;
}

/* 隱藏非活動的分頁，避免高度疊加 */
html.paper-page .multi-tab-detail .tab-pane {
    display: none !important;
}

html.paper-page .multi-tab-detail .tab-pane.show.active {
    display: block !important;
    height: 100% !important;
}

/* table-container：填滿 tab-pane */
html.paper-page .multi-tab-detail .table-container {
    height: 100% !important;
}

/* 表格 wrapper：填滿並可捲動，讓表頭固定 */
html.paper-page .multi-tab-detail .erp-table-wrapper {
    height: 100% !important;
    max-height: none !important;
    overflow: auto !important;
}
</style>

<script>
// 為 html 加上特定 class，讓樣式只影響此頁面
document.documentElement.classList.add('paper-page');
</script>

<script>
    // 載入特殊介面
    window._specialUIConfig = {
        itemId: "@(Model.ItemId ?? "")",
        specialUIType: "@(Model.SpecialUIType ?? "")",
        specialUIConfig: @Html.Raw(string.IsNullOrWhiteSpace(Model.SpecialUIConfig) ? "null" : Model.SpecialUIConfig),
        detailTableName: "@(Model.DetailDictTable ?? Model.DictTableName ?? "")",
        masterTableName: "@(Model.MasterTable ?? "")",
        paperNum: "@(Model.PaperNum ?? "")"
    };

    $(document).ready(function() {
        if (window.loadSpecialUI && window._specialUIConfig.specialUIType) {
            window.loadSpecialUI(
                window._specialUIConfig.itemId,
                window._specialUIConfig.specialUIType,
                window._specialUIConfig.specialUIConfig,
                window._specialUIConfig.detailTableName,
                window._specialUIConfig.masterTableName,
                window._specialUIConfig.paperNum
            );
        }
    });
</script>
