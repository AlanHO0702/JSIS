@page "/NoticeBoardList"
@model PcbErpApi.Pages.NoticeBoardListModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "佈告欄清單";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<style>
body {
    background: #f4f6fb;
    font-family: "Noto Sans TC", "Microsoft JhengHei", Arial, sans-serif;
}
.page-container {
    padding: 0.5rem;
    height: calc(100vh - 60px);
    display: flex;
    flex-direction: column;
}
.grid-container {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    padding: 1rem;
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
.grid-wrapper {
    flex: 1;
    overflow: auto;
    border: 1px solid #d0d0d0;
    border-radius: 0;
}
.notice-grid {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #d0d0d0;
}
.notice-grid thead {
    background: #f0f0f0;
    position: sticky;
    top: 0;
    z-index: 10;
}
.notice-grid th {
    padding: 0.4rem 0.6rem;
    text-align: left;
    font-weight: 600;
    color: #333;
    border: 1px solid #d0d0d0;
    white-space: nowrap;
    background: #f0f0f0;
    line-height: 1.3;
}
.notice-grid td {
    padding: 0.4rem 0.6rem;
    border: 1px solid #d0d0d0;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.3;
}
.notice-grid tbody tr {
    cursor: pointer;
    transition: background-color 0.2s;
}
.notice-grid tbody tr:hover {
    background-color: #f8f9fa;
}
.notice-grid tbody tr.selected {
    background-color: #e7f1fd;
}
.notice-grid tbody tr.unread {
    font-weight: 500;
}
.detail-panel {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    padding: 1rem;
    margin-top: 0.5rem;
    max-height: 400px;
    overflow-y: auto;
}
.detail-title {
    font-size: 1rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e0e0e0;
}
.detail-content {
    color: #555;
    line-height: 1.6;
    white-space: pre-wrap;
    font-size: 0.9rem;
}
.badge-new {
    background: #ff6b6b;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    margin-left: 0.5rem;
}
.date-range {
    color: #6c757d;
    font-size: 0.9rem;
}
</style>

<div class="page-container">
    <div class="grid-container">
        <div class="grid-wrapper">
            <table class="notice-grid" id="noticeTable">
                <thead>
                    <tr>
                        <th style="width: 80px;">序號</th>
                        <th style="width: 120px;">發佈人</th>
                        <th style="width: 150px;">建立日期</th>
                        <th>主題</th>
                        <th style="width: 200px;">有效期間</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Rows.Rows.Count > 0)
                    {
                        foreach (System.Data.DataRow row in Model.Rows.Rows)
                        {
                            var serialNum = row["SerialNum"]?.ToString() ?? "";
                            var postUserId = row["PostUserId"]?.ToString() ?? "";

                            // 檢查是否有 Lk_UserName 或 UserName 欄位
                            var userName = postUserId;
                            if (Model.Rows.Columns.Contains("Lk_UserName"))
                            {
                                userName = row["Lk_UserName"]?.ToString() ?? postUserId;
                            }
                            else if (Model.Rows.Columns.Contains("UserName"))
                            {
                                userName = row["UserName"]?.ToString() ?? postUserId;
                            }

                            var buildDate = row["BuildDate"] != DBNull.Value
                                ? Convert.ToDateTime(row["BuildDate"]).ToString("yyyy/MM/dd HH:mm")
                                : "";
                            var subjects = row["Subjects"]?.ToString() ?? "";
                            var boardText = row["BoardText"]?.ToString() ?? "";
                            var beginDate = row["BeginDate"] != DBNull.Value
                                ? Convert.ToDateTime(row["BeginDate"]).ToString("yyyy/MM/dd")
                                : "";
                            var endDate = row["EndDate"] != DBNull.Value
                                ? Convert.ToDateTime(row["EndDate"]).ToString("yyyy/MM/dd")
                                : "";
                            var dateRange = $"{beginDate} ~ {endDate}";

                            <tr class="notice-row"
                                data-serial="@serialNum"
                                data-subject="@subjects"
                                data-content="@boardText"
                                onclick="selectNotice(this)">
                                <td>@serialNum</td>
                                <td>@userName</td>
                                <td>@buildDate</td>
                                <td>@subjects</td>
                                <td class="date-range">@dateRange</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center text-secondary py-4">
                                目前沒有佈告欄資料
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="detail-panel" id="detailPanel" style="display: none;">
        <div class="detail-title" id="detailTitle"></div>
        <div class="detail-content" id="detailContent"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let currentSelectedRow = null;
    const userId = localStorage.getItem('erpLoginUserId') || 'admin';

    function selectNotice(row) {
        // 取消之前選取的行
        if (currentSelectedRow) {
            currentSelectedRow.classList.remove('selected');
        }

        // 選取新的行
        row.classList.add('selected');
        currentSelectedRow = row;

        // 顯示詳細內容
        const subject = row.dataset.subject;
        const content = row.dataset.content;
        const serialNum = row.dataset.serial;

        document.getElementById('detailTitle').textContent = subject;
        document.getElementById('detailContent').textContent = content;
        document.getElementById('detailPanel').style.display = 'block';

        // 標記為已讀
        markAsRead(serialNum);

        // 移除未讀樣式
        row.classList.remove('unread');
    }

    async function markAsRead(serialNum) {
        try {
            const response = await fetch('/NoticeBoardList?handler=MarkAsRead', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({
                    serialNum: parseInt(serialNum),
                    userId: userId
                })
            });

            if (response.ok) {
                console.log('標記已讀成功');
            }
        } catch (error) {
            console.error('標記已讀失敗:', error);
        }
    }

    // 頁面載入時,選擇第一筆資料
    document.addEventListener('DOMContentLoaded', function() {
        const firstRow = document.querySelector('.notice-row');
        if (firstRow) {
            selectNotice(firstRow);
        }
    });
</script>
