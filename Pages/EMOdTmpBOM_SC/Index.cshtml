@page "/EMOdTmpBOM_SC"
@model PcbErpApi.Pages.EMOdTmpBOM_SC.IndexModel
@{
    ViewData["Title"] = "組合模型";
    Layout = "_Layout";
}

@section Styles {
<style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    .container-fluid { height: 98vh; display: flex; flex-direction: column; padding: 0.75rem; box-sizing: border-box; }

    .bom-main-container {
        display: flex; flex: 1; min-height: 0; gap: 5px; margin-top: 0;
    }

    /* 左側 Master Grid */
    .master-panel {
        flex: 0 0 450px; display: flex; flex-direction: column; min-height: 0;
        border: 1px solid #dee2e6; border-radius: 8px; background: #fff;
        box-shadow: 0 2px 12px 0 #c3d4e6; overflow: hidden;
    }
    .master-panel .table-fix-wrapper {
        flex: 1; overflow: auto; white-space: nowrap;
    }
    .master-panel table { table-layout: auto; width: 100%; border-collapse: collapse; }
    .master-panel thead th {
        position: sticky; top: 0; z-index: 2;
        background: #f8f9fa; border-bottom: 2px solid #dee2e6;
        padding: 6px 10px; font-size: 13px; font-weight: 600; cursor: pointer;
        white-space: nowrap;
    }
    .master-panel tbody td { padding: 4px 10px; font-size: 13px; border-bottom: 1px solid #f0f0f0; cursor: pointer; white-space: nowrap; }
    .master-panel tbody tr:hover { background: #f0f8ff; }
    .master-panel tbody tr.selected { background: #e6f2ff; font-weight: 600; }

    /* 右側 Detail 區域 */
    .detail-panel {
        flex: 1; display: flex; flex-direction: column; min-height: 0;
        border: 1px solid #dee2e6; border-radius: 8px; background: #fff;
        box-shadow: 0 2px 12px 0 #c3d4e6; overflow: hidden;
    }

    /* TreeView */
    .tree-container {
        flex: 1; overflow: auto; padding: 8px; min-height: 0;
    }
    .tree-node-item {
        padding: 5px 8px; margin: 2px 0; cursor: pointer; border-radius: 4px;
        font-size: 13px; user-select: none; display: flex; align-items: center; gap: 4px;
    }
    .tree-node-item:hover { background: #f0f8ff; }
    .tree-node-item.selected { background: #e6f2ff; border-left: 3px solid #2564b3; }
    .tree-children { margin-left: 20px; }
    .tree-toggle {
        display: inline-flex; align-items: center; justify-content: center;
        width: 16px; height: 16px; cursor: pointer; flex-shrink: 0;
        border: none; background: none; padding: 0;
    }
    .tree-toggle::before {
        content: ''; display: block; width: 0; height: 0;
        border-top: 5px solid transparent; border-bottom: 5px solid transparent;
        border-left: 7px solid #555; transition: transform 0.15s;
    }
    .tree-toggle.expanded::before {
        transform: rotate(90deg);
    }
    .tree-toggle:hover::before { border-left-color: #222; }
    .tree-node-icon { flex-shrink: 0; width: 18px; text-align: center; }

    /* Detail Grid */
    .detail-grid-container {
        flex: 0 0 220px; overflow: auto;
        border-top: 2px solid #dee2e6;
    }
    .detail-grid-container table { table-layout: auto; width: 100%; border-collapse: collapse; }
    .detail-grid-container thead th {
        position: sticky; top: 0; z-index: 2;
        background: #f8f9fa; border-bottom: 2px solid #dee2e6;
        padding: 4px 8px; font-size: 12px; font-weight: 600; white-space: nowrap;
    }
    .detail-grid-container tbody td { padding: 3px 8px; font-size: 12px; border-bottom: 1px solid #f0f0f0; white-space: nowrap; }
    .detail-grid-container tbody tr:hover { background: #f0f8ff; }
    .detail-grid-container tbody tr.selected { background: #e6f2ff; }

    /* Splitter */
    .h-splitter {
        height: 5px; cursor: row-resize; background: #e9ecef; flex-shrink: 0;
        border-radius: 2px; transition: background 0.2s;
    }
    .h-splitter:hover { background: #adb5bd; }

    /* Toolbar */
    .bom-toolbar {
        display: flex; align-items: center; gap: 6px; padding: 6px 10px;
        background: #f8f9fa; border-bottom: 1px solid #dee2e6; flex-shrink: 0;
    }
    .bom-toolbar .toolbar-btn {
        display: inline-flex; align-items: center; gap: 4px;
        padding: 4px 12px; border: 1px solid #ced4da; border-radius: 4px;
        background: #fff; font-size: 13px; cursor: pointer; transition: all 0.15s;
        white-space: nowrap;
    }
    .bom-toolbar .toolbar-btn:hover { background: #e9ecef; border-color: #adb5bd; }
    .bom-toolbar .toolbar-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .bom-toolbar .toolbar-btn.primary { background: #0d6efd; color: #fff; border-color: #0d6efd; }
    .bom-toolbar .toolbar-btn.primary:hover { background: #0b5ed7; }
    .bom-toolbar .toolbar-btn.success { background: #198754; color: #fff; border-color: #198754; }
    .bom-toolbar .toolbar-btn.success:hover { background: #157347; }
    .bom-toolbar .toolbar-sep { width: 1px; height: 24px; background: #ced4da; }
    .bom-toolbar .toolbar-label { font-size: 13px; color: #666; }
    .bom-toolbar input[type="text"] {
        padding: 3px 8px; border: 1px solid #ced4da; border-radius: 4px;
        font-size: 13px; width: 120px;
    }
    .bom-mode-badge {
        padding: 2px 10px; border-radius: 10px; font-size: 12px; font-weight: 600;
    }
    .bom-mode-badge.browse { background: #d1ecf1; color: #0c5460; }
    .bom-mode-badge.edit { background: #fff3cd; color: #856404; }

    /* BOM Set Dialog (Modal) */
    .bomset-modal .modal-dialog { max-width: 90vw; width: 900px; }
    .bomset-modal .modal-body { padding: 0; }

    .bomset-toolbar {
        display: flex; align-items: center; gap: 8px; padding: 8px 12px;
        background: #f8f9fa; border-bottom: 1px solid #dee2e6;
    }
    .bomset-toolbar label { font-size: 13px; font-weight: 600; margin: 0; }
    .bomset-toolbar input[type="number"] {
        width: 70px; padding: 3px 6px; border: 1px solid #ced4da;
        border-radius: 4px; font-size: 13px; text-align: center;
    }
    .bomset-toolbar input[type="text"] {
        width: 120px; padding: 3px 6px; border: 1px solid #ced4da;
        border-radius: 4px; font-size: 13px;
    }

    /* Press buttons row */
    .press-buttons-row {
        display: flex; padding: 4px 8px; gap: 2px;
        background: #e9ecef; border-bottom: 1px solid #dee2e6;
        align-items: center; flex-shrink: 0;
    }
    .press-btn {
        padding: 4px 10px; border: 1px solid #6c757d; border-radius: 4px;
        background: #fff; font-size: 12px; cursor: pointer; white-space: nowrap;
        transition: all 0.15s; font-weight: 600;
    }
    .press-btn:hover { background: #e2e6ea; }
    .press-btn.active { background: #0d6efd; color: #fff; border-color: #0d6efd; }

    /* Visual layer editor area */
    .layer-editor-area {
        position: relative; min-height: 400px; overflow: auto;
        padding: 8px; background: #fafbfc;
    }

    /* Layer button in the visual editor */
    .layer-btn {
        position: absolute; border: 2px solid #495057; border-radius: 4px;
        background: #e3f2fd; font-size: 11px; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        user-select: none; transition: all 0.15s; text-align: center;
        word-break: break-all; padding: 2px;
    }
    .layer-btn:hover { border-color: #0d6efd; box-shadow: 0 0 4px rgba(13,110,253,0.3); }
    .layer-btn.selected {
        background: #bbdefb; border-color: #1976d2;
        box-shadow: 0 0 6px rgba(25,118,210,0.4);
    }
    .layer-btn.base-layer { background: #c8e6c9; border-color: #388e3c; }
    .layer-btn.base-layer.selected { background: #a5d6a7; border-color: #2e7d32; box-shadow: 0 0 6px rgba(46,125,50,0.4); }
    .layer-btn.combined { background: #e3f2fd; border-color: #1565c0; }
    .layer-btn.combined.selected { background: #90caf9; border-color: #0d47a1; }

    /* Context menu */
    .ctx-menu {
        position: fixed; z-index: 9999; background: #fff;
        border: 1px solid #dee2e6; border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 120px;
        padding: 4px 0; display: none;
    }
    .ctx-menu-item {
        padding: 6px 16px; cursor: pointer; font-size: 13px;
    }
    .ctx-menu-item:hover { background: #f0f8ff; }
    .ctx-menu-item.danger { color: #dc3545; }

    /* Scrollbar */
    .tree-container::-webkit-scrollbar,
    .master-panel .table-fix-wrapper::-webkit-scrollbar,
    .detail-grid-container::-webkit-scrollbar { width: 8px; height: 8px; }
    .tree-container::-webkit-scrollbar-track,
    .master-panel .table-fix-wrapper::-webkit-scrollbar-track,
    .detail-grid-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    .tree-container::-webkit-scrollbar-thumb,
    .master-panel .table-fix-wrapper::-webkit-scrollbar-thumb,
    .detail-grid-container::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
</style>
}

<div class="container-fluid">
    <!-- Toolbar -->
    <div class="bom-toolbar">
        <button class="toolbar-btn" id="btnBrowse" title="瀏覽模式"><i class="bi bi-eye"></i> 瀏覽</button>
        <button class="toolbar-btn" id="btnUpdate" title="編輯模式"><i class="bi bi-pencil-square"></i> 編輯</button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn primary" id="btnChange" title="異動 BOM 組合"><i class="bi bi-gear"></i> 異動</button>
        <button class="toolbar-btn" id="btnFormView" title="瀏覽 BOM 組合"><i class="bi bi-search"></i> 瀏覽組合</button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn success" id="btnSaveAs" title="複製範本"><i class="bi bi-files"></i> 複製</button>
        <span class="toolbar-label">另存代碼:</span>
        <input type="text" id="edtTmpIdNew" placeholder="輸入新代碼" maxlength="12" />
        <div class="toolbar-sep"></div>
        <span class="bom-mode-badge browse" id="modeIndicator">瀏覽模式</span>
        <span class="toolbar-label" id="recordCount" style="margin-left:auto;">0 / 0</span>
    </div>

    <!-- Main content -->
    <div class="bom-main-container">
        <!-- Left: Master Grid -->
        <div class="master-panel" id="masterPanel">
            <div class="table-fix-wrapper">
                <table id="masterGrid">
                    <thead><tr id="masterHead"></tr></thead>
                    <tbody id="masterBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Right: Tree + Detail Grid -->
        <div class="detail-panel">
            <div class="tree-container" id="treeContainer">
                <div style="color:#999; padding:20px; text-align:center;">請選擇左側範本以查看 BOM 組合</div>
            </div>
            <div class="h-splitter" id="hSplitter1"></div>
            <div class="detail-grid-container" id="detailGridContainer">
                <table id="detailGrid">
                    <thead><tr></tr></thead>
                    <tbody id="detailBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- BOM Set Modal -->
<div class="modal fade bomset-modal" id="bomSetModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title"><i class="bi bi-layers"></i> BOM 組合模型設定</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Toolbar -->
                <div class="bomset-toolbar">
                    <label>層數:</label>
                    <input type="number" id="spnLayer" min="2" max="50" value="12" />
                    <label>壓數:</label>
                    <input type="number" id="spnPress" min="2" max="50" value="6" />
                    <div style="flex:1"></div>
                    <label id="lblLayerName" style="display:none;">層別名稱:</label>
                    <input type="text" id="edtOriName" style="display:none;" placeholder="輸入名稱" />
                    <button class="toolbar-btn" id="btnRenameLayer" style="display:none;">修改</button>
                </div>
                <!-- Press stage buttons -->
                <div class="press-buttons-row" id="pressButtonsRow"></div>
                <!-- Visual editor -->
                <div class="layer-editor-area" id="layerEditorArea"></div>
            </div>
            <div class="modal-footer py-2" id="bomSetFooter">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary btn-sm" id="btnBomSetOk">確定</button>
            </div>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div class="ctx-menu" id="ctxMenu">
    <div class="ctx-menu-item danger" id="ctxRemove">移除</div>
    <div class="ctx-menu-item danger" id="ctxClearAll">全部清除</div>
</div>

@section Scripts {
<script src="~/js/EMOdTmpBOM_SC.js" asp-append-version="true"></script>
}
