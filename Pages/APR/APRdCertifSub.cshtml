@page "/APR/APRdCertifSub/{paperNum}"
@using PcbErpApi.Models
@model PcbErpApi.Pages.APR.APRdCertifSubModel
@{
    Layout = "_Layout";
    ViewData["Title"] = Model.PageTitle;
    ViewData["TableTitle"] = Model.PageTitle;

    // ✅ 關鍵：讓 _DetailHeaderSection 可以讀取到 ActionRailPartial
    ViewData["ActionRailPartial"] = Model.ActionRailPartial;
}

<!-- ========================================
     應收憑證單詳細頁
     套用 PaperDetail 模板：單頭 + 多頁籤單身
     ======================================== -->

<div class="erp-detail-container">
    <!-- 單頭區塊：使用 _DetailHeaderSection 模板 -->
    @await Html.PartialAsync("~/Pages/Shared/_DetailHeaderSection.cshtml", Model)

    <!-- 單身區塊：使用 _MultiTabDetail 模板（多頁籤） -->
    @await Html.PartialAsync("~/Pages/Shared/_MultiTabDetail.cshtml")
</div>

<!-- 欄位字典模態框 -->
@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", Model.FieldDictList, ViewData)

<script>window._itemId = "@(Model.ItemId ?? "")";</script>
<script>window._dictTableName = "@(Model.DetailDictTable ?? Model.DictTableName)";</script>

@* ✅ 當有左側自訂按鈕時，預留左側空間避免被擋住 *@
@if ((Model.CustomButtons?.Count > 0))
{
    <style>
    /* APRdCertifSub 使用 Action Rail（左側自訂按鈕）時，需預留左側空間，避免單頭/頁籤被擋住 */
    .erp-detail-container{
        margin-left: var(--rail-reserve) !important;
        margin-right: 3vw !important;
        padding: 12px 0 !important;
    }

    /* toolbar 往回補，維持視覺對齊 */
    #topToolbar{
        margin-left: calc(-1 * var(--rail-reserve)) !important;
        padding-left: 0 !important;
        justify-content: flex-start !important;
    }
    #topToolbar > .ms-2, #topToolbar .btn-toolbar{ margin-left: 0 !important; }

    /* 確保頁籤不會被左側按鈕擋住 */
    #headerTabs{ position: relative; z-index: 1; margin-left: 0 !important; }
    .multi-tab-detail{ margin-left: 0 !important; padding-left: 0 !important; }
    </style>
}

<!-- 引入共用 JavaScript 工具 -->
<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>

<!-- 引入通用 Hook 擴展機制 -->
<script src="~/js/templateHooks.js" asp-append-version="true"></script>

<!--
    ========================================
    應收憑證單專屬擴展 JavaScript Hook
    ========================================
    使用 TemplateHooks.register() 註冊 Hook，實現類似 Delphi inherited 的擴展功能
-->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ========================================
    // 註冊應收憑證單的 Hook
    // ========================================
    TemplateHooks.register('apr_certif', {
        // ========================================
        // 頁面初始化 Hook
        // ========================================
        onInit: function() {
            console.log('[APRdCertif] 頁面初始化');

            // 範例：設定特定欄位的預設值
            // const paperDateInput = document.querySelector('[name="PaperDate"]');
            // if (paperDateInput && !paperDateInput.value) {
            //     paperDateInput.value = new Date().toISOString().split('T')[0];
            // }
        },

        // ========================================
        // 確認前 Hook - 驗證資料（在 _DetailHeaderSection 的儲存按鈕觸發前）
        // ========================================
        beforeSave: function() {
            console.log('[APRdCertif] 確認前驗證');

            // 範例 1：驗證憑證金額不能為負數
            // const amountInput = document.querySelector('[name="Amount"]');
            // if (amountInput) {
            //     const amount = parseFloat(amountInput.value || '0');
            //     if (amount < 0) {
            //         TemplateHooks.utils.alert('憑證金額不能為負數');
            //         return false; // 中止儲存
            //     }
            // }

            // 範例 2：檢查客戶是否已選擇
            // const customerInput = document.querySelector('[name="CustomerId"]');
            // if (!customerInput || !customerInput.value) {
            //     TemplateHooks.utils.alert('請選擇客戶');
            //     return false;
            // }

            // 範例 3：確認對話框
            // if (!TemplateHooks.utils.confirm('確定要儲存應收憑證單嗎？')) {
            //     return false;
            // }

            return true; // 驗證通過，允許儲存
        },

        // ========================================
        // 確認後 Hook - 執行後續動作
        // ========================================
        afterSave: function() {
            console.log('[APRdCertif] 確認後處理');

            // 範例 1：顯示成功訊息
            // TemplateHooks.utils.alert('應收憑證單已儲存');

            // 範例 2：自動簽核
            // autoApproveVoucher();

            // 範例 3：發送通知
            // sendNotification();

            // 範例 4：更新相關資料
            // refreshRelatedData();
        },

        // ========================================
        // 新增明細前 Hook
        // ========================================
        beforeAdd: function() {
            console.log('[APRdCertif] 新增明細前驗證');

            // 範例：檢查單頭是否已儲存
            // const paperNum = window._paperNum;
            // if (!paperNum) {
            //     TemplateHooks.utils.alert('請先儲存單頭再新增明細');
            //     return false;
            // }

            return true;
        },

        // ========================================
        // 新增明細後 Hook
        // ========================================
        afterAdd: function(row) {
            console.log('[APRdCertif] 新增明細後處理', row);

            // 範例：設定新增列的預設值
            // const itemInput = row?.querySelector('[data-field="Item"]');
            // const amountInput = row?.querySelector('[data-field="Amount"]');
            // if (amountInput) {
            //     amountInput.value = '0';
            // }
        },

        // ========================================
        // 刪除明細前 Hook
        // ========================================
        beforeDelete: function() {
            console.log('[APRdCertif] 刪除明細前驗證');
            return TemplateHooks.utils.confirm('確定要刪除此筆分錄明細嗎？');
        },

        // ========================================
        // 刪除明細後 Hook
        // ========================================
        afterDelete: function() {
            console.log('[APRdCertif] 刪除明細後處理');
            // 可在此重新計算合計金額等
        },

        // ========================================
        // 自訂驗證 Hook
        // ========================================
        onValidate: function(data) {
            console.log('[APRdCertif] 自訂驗證', data);

            // 範例：驗證借貸平衡
            // const debitTotal = calculateTotal('Debit');
            // const creditTotal = calculateTotal('Credit');
            // if (debitTotal !== creditTotal) {
            //     TemplateHooks.utils.alert('借貸不平衡！');
            //     return false;
            // }

            return true;
        }
    });

    // ========================================
    // 自訂函數範例
    // ========================================

    // 自動簽核
    function autoApproveVoucher() {
        console.log('[APRdCertif] 執行自動簽核');
        // 實作自動簽核邏輯
        // fetch('/api/APRdCertif/AutoApprove', { ... })
    }

    // 發送通知
    function sendNotification() {
        console.log('[APRdCertif] 發送通知');
        // 實作通知邏輯
    }

    // 更新相關資料
    function refreshRelatedData() {
        console.log('[APRdCertif] 更新相關資料');
        // 實作資料更新邏輯
    }

    // 計算合計
    function calculateTotal(fieldName) {
        let total = 0;
        document.querySelectorAll(`.multi-tab-detail [data-field="${fieldName}"]`).forEach(input => {
            const value = parseFloat(input.value || '0');
            if (!isNaN(value)) {
                total += value;
            }
        });
        return total;
    }

    // ========================================
    // 整合模板 Hook（如果需要的話）
    // ========================================

    // 監聽單頭編輯模式切換事件
    window.addEventListener('headerEditModeChanged', (e) => {
        const isEdit = e?.detail?.isEdit;
        console.log('[APRdCertif] 編輯模式切換:', isEdit ? '編輯中' : '檢視中');

        // 可在此根據編輯模式做額外處理
    });

    // 監聽明細 Tab 切換事件（如果有多個明細）
    document.querySelectorAll('.multi-tab-detail .nav-link').forEach(tab => {
        tab.addEventListener('click', (e) => {
            const tabTitle = e.target.textContent.trim();
            console.log('[APRdCertif] 切換到明細 Tab:', tabTitle);
        });
    });
});
</script>

<!--
    ========================================
    樣式覆寫（如果需要的話）
    ========================================
-->
<style>
/* 可在此添加應收憑證單專屬的樣式覆寫 */

/* 範例：特定欄位標紅 */
/* .draggable-field[data-field="Amount"] label {
    color: #dc3545;
    font-weight: bold;
} */

/* 範例：調整明細表格欄位寬度 */
/* .multi-tab-detail .erp-table th[data-field="AccountCode"] {
    width: 150px;
} */
</style>