@page "/APR/APRdCertifMain"
@model PcbErpApi.Pages.APR.APRdCertifMainModel
@{
    Layout = "_Layout";
    // ✅ 與動態路徑相同：使用 ItemName 而不是 PageTitle
    ViewData["Title"] = string.IsNullOrWhiteSpace(Model.ItemName)
        ? Model.ItemId
        : $"{Model.ItemId} {Model.ItemName}";
    ViewData["TableTitle"] = "";
    ViewData["SubRouteTemplate"] = Model.DetailRouteTemplate;
    ViewData["AddApiUrl"] = $"/api/DynamicTable/AddPaper/{Model.DictTableName}";
    ViewData["DictTableName"] = Model.DictTableName;
    ViewData["PaginationVm"] = new PaginationModel
    {
        PageNumber = Model.PageNumber,
        TotalPages = Model.TotalPages,
        RouteUrl = Url.Page("/APR/APRdCertifMain") ?? "/APR/APRdCertifMain"
    };
    ViewData["QueryFields"] = Model.QueryFields;
}

<!-- 套用列表模板 -->
<partial name="~/Pages/Shared/_TableListPartial.cshtml" model="Model" view-data="ViewData" />

<!-- 欄位字典模態框 -->
@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", Model.FieldDictList, ViewData)

<script>
  window._dictTableName = "@Model.DictTableName";
  window._itemId = "@Model.ItemId";
</script>

<!-- 引入共用 JavaScript 工具 -->
<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>

<!-- 引入通用 Hook 擴展機制 -->
<script src="~/js/templateHooks.js" asp-append-version="true"></script>

<!--
    ========================================
    應收憑證單列表頁專屬擴展 JavaScript Hook
    ========================================
    可以在列表頁新增、刪除按鈕執行前後添加 Hook
-->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 註冊應收憑證單列表頁的 Hook
    TemplateHooks.register('apr_certif_list', {
        // ========================================
        // 新增前 Hook（在新增按鈕觸發前）
        // ========================================
        beforeAdd: function() {
            console.log('[APRdCertifMain] 新增前驗證');
            // 可在此檢查是否允許新增
            // 例如：檢查用戶權限、檢查是否達到上限等
            return true; // 回傳 false 會中止新增
        },

        // ========================================
        // 新增後 Hook（新增成功後，跳轉前）
        // ========================================
        afterAdd: function({ paperNum, data }) {
            console.log('[APRdCertifMain] 新增後處理', paperNum, data);
            // 可在此記錄日誌、發送通知等
        },

        // ========================================
        // 刪除前 Hook（在刪除按鈕觸發前）
        // ========================================
        beforeDelete: function({ selectedId }) {
            console.log('[APRdCertifMain] 刪除前驗證', selectedId);
            // 可在此執行額外驗證
            // 例如：檢查單據狀態、檢查是否已核准等
            // return false; // 回傳 false 會中止刪除
            return true;
        },

        // ========================================
        // 刪除後 Hook（刪除成功後）
        // ========================================
        afterDelete: function({ selectedId }) {
            console.log('[APRdCertifMain] 刪除後處理', selectedId);
            // 可在此執行清理工作、記錄日誌等
        }
    });
});
</script>