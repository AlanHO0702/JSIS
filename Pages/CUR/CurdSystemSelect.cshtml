@page
@using Microsoft.AspNetCore.Html
@model PcbErpApi.Pages.CUR.CURdSystemSelectModel
@{
    Layout = "_Layout";
    ViewData["CustomButtons"] = new HtmlString(@"
        <button type='button' class='btn btn-primary btn-sm' onclick='uploadImage()'>ä¸Šå‚³åœ–æª”</button>
        <button type='button' class='btn btn-outline-secondary btn-sm' onclick='viewImage()'>æª¢è¦–åœ–æª”</button>
        <button type='button' class='btn btn-outline-danger btn-sm' onclick='deleteImage()'>åˆªé™¤åœ–æª”</button>
        <button type='button' class='btn btn-success btn-sm' onclick='uploadManual()'>ä¸Šå‚³æ‰‹å†Š</button>
        <button type='button' class='btn btn-outline-info btn-sm' onclick='downloadManual()'>æª¢è¦–æ‰‹å†Š</button>
        <button type='button' class='btn btn-outline-danger btn-sm' onclick='deleteManual()'>åˆªé™¤æ‰‹å†Š</button>
    ");
}

<h3>ç³»çµ±æ¨¡çµ„è¨­å®š</h3>

<partial name="~/Pages/Shared/_TableSingleGrid.cshtml" model="Model" />

<!-- ğŸ”¹ é è¦½åœ–æª” Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">åœ–æª”é è¦½</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="previewImage" src="" alt="é è¦½åœ–æª”" style="max-width:100%; max-height:75vh; border:1px solid #ccc;">
      </div>
    </div>
  </div>
</div>

@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", ViewData["FieldDictList"], ViewData)
<script>window._dictTableName = 'CURdSystemSelect';</script>
<script src="~/js/fieldDictModal.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const table = document.querySelector('table');
  if (table) {
    table.addEventListener('click', e => {
      const tr = e.target.closest('tr');
      if (!tr) return;
      table.querySelectorAll('tr.table-active').forEach(x => x.classList.remove('table-active'));
      tr.classList.add('table-active');
    });
  }
});

function getSelectedSystemCode() {
  const tr = document.querySelector('tr.table-active');
  if (!tr) return null;
  return tr.children[0].innerText.trim();
}

// ========== åœ–æª” ==========
async function uploadImage() {
  const systemCode = getSelectedSystemCode();
  if (!systemCode) return alert('è«‹å…ˆé¸å–ç³»çµ±ä»£ç¢¼');
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.bmp';
  input.onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('SystemCode', systemCode);
    formData.append('File', file);
    const res = await fetch('/api/SystemGraph/Upload', { method: 'POST', body: formData });
    if (res.ok) { alert('ä¸Šå‚³æˆåŠŸ'); location.reload(); }
    else alert(await res.text());
  };
  input.click();
}

async function viewImage() {
  const tr = document.querySelector('tr.table-active');
  if (!tr) return alert('è«‹å…ˆé¸å–ç³»çµ±ä»£ç¢¼');

  // âœ… æ”¹æˆæ­£ç¢ºæ¬„ä½ç´¢å¼•ï¼ˆåœ–æª”åç¨±åœ¨ç¬¬8æ¬„ â†’ index 7ï¼‰
  const fileName = tr.children[7]?.innerText.trim();
  if (!fileName) return alert('æ²’æœ‰åœ–æª”åç¨±');

  document.getElementById('previewImage').src =
    `/api/SystemGraph/GetImage/${encodeURIComponent(fileName)}`;

  new bootstrap.Modal(document.getElementById('imagePreviewModal')).show();
}



async function deleteImage() {
  const systemCode = getSelectedSystemCode();
  if (!systemCode) return alert('è«‹å…ˆé¸å–ç³»çµ±ä»£ç¢¼');
  if (!confirm('ç¢ºå®šåˆªé™¤æ­¤åœ–æª”ï¼Ÿ')) return;
  const res = await fetch(`/api/SystemGraph/Delete?systemCode=${systemCode}`, { method: 'DELETE' });
  if (res.ok) { alert('åˆªé™¤æˆåŠŸ'); location.reload(); }
  else alert(await res.text());
}

// ========== æ‰‹å†Š ==========
async function uploadManual() {
  const systemCode = getSelectedSystemCode();
  if (!systemCode) return alert('è«‹å…ˆé¸å–ç³»çµ±ä»£ç¢¼');
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.doc,.docx';
  input.onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('SystemCode', systemCode);
    formData.append('File', file);
    const res = await fetch('/api/SystemGraph/UploadManual', { method: 'POST', body: formData });
    if (res.ok) { alert('ä¸Šå‚³æˆåŠŸ'); location.reload(); }
    else alert(await res.text());
  };
  input.click();
}

async function downloadManual() {
  const tr = document.querySelector('tr.table-active');
  if (!tr) return alert('è«‹å…ˆé¸å–ç³»çµ±ä»£ç¢¼');

  // âœ… æ‰‹å†Šåç¨±åœ¨ç¬¬9æ¬„ â†’ index 8
  const fileName = tr.children[8]?.innerText.trim();
  if (!fileName) return alert('æ²’æœ‰æ‰‹å†Šåç¨±');

  window.open(`/api/SystemGraph/GetManual/${encodeURIComponent(fileName)}`, '_blank');
}

async function deleteManual() {
  const systemCode = getSelectedSystemCode();
  if (!systemCode) return alert('è«‹å…ˆé¸å–ç³»çµ±ä»£ç¢¼');
  if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ‰‹å†Šï¼Ÿ')) return;
  const res = await fetch(`/api/SystemGraph/DeleteManual?systemCode=${systemCode}`, { method: 'DELETE' });
  if (res.ok) { alert('åˆªé™¤æˆåŠŸ'); location.reload(); }
  else alert(await res.text());
}
</script>

<style>
tr.table-active { background-color: #d6e4ff !important; }
</style>
