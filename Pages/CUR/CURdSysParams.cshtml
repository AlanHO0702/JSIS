@page
@model PcbErpApi.Pages.CUR.CURdSysParamsModel
@{
    Layout = "_Layout";
}

<h3 class="mb-3">系統參數設定</h3>

<partial name="~/Pages/Shared/_TableSingleGrid.cshtml" model="Model" />

@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", ViewData["FieldDictList"], ViewData)
<script>window._dictTableName = 'CURdSysParamsDLL';</script>
<script src="~/js/fieldDictModal.js"></script>

<!-- >>> Notes(說明) 詳細內容檢視 Modal -->
<div class="modal fade" id="notesViewerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-card-text me-2"></i>詳細內容
          <small class="text-muted ms-2" id="notesViewerTitle"></small>
        </h5>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="btnCopyNotes">
          <i class="bi bi-clipboard"></i> 複製
        </button>
        <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="notesViewerBody" class="notes-content"></div>
      </div>
    </div>
  </div>
</div>

<style>
  /* 大段文字可換行、保留原有換行與空白 */
  .notes-content{
    white-space: pre-wrap;
    word-break: break-word;
    font-size: 0.95rem;
    line-height: 1.6;
    min-height: 120px;
  }
</style>
<script>window.KEY_FIELDS = ['SystemId','ParamId'];</script>

<script>
(function () {
  // 目標欄位名稱（大小寫不拘）。預設只有 Notes，如要增加就在這裡加。
  const TARGET_FIELDS = ['notes'];

  // 事件代理：只要在 mainGrid 內雙擊符合欄位的 TD 就開啟
  document.addEventListener('dblclick', function (e) {
    const grid = document.getElementById('mainGrid');
    if (!grid) return;

    // 只在 mainGrid 裡面處理
    const td = e.target.closest('td');
    if (!td || !grid.contains(td)) return;

    // 非編輯模式才開（避免正在輸入還跳視窗）
    const wrapper = document.querySelector('.table-wrapper');
    const inEdit = wrapper && wrapper.classList.contains('edit-mode');
    if (inEdit) return;

    const field = (td.getAttribute('data-field') || '').toLowerCase();
    if (!TARGET_FIELDS.includes(field)) return;

    // 取該格的文字（優先讀 input 的值，沒有就看 span）
    const input = td.querySelector('.cell-edit');
    const span  = td.querySelector('.cell-view');
    const raw   = (input && input.value != null ? input.value : (span ? span.textContent : '')) || '';

    // 取一些上下文資訊（可有可無）
    const row   = td.closest('tr');
    const sysId = row ? (row.querySelector('td[data-field="SystemId"] .cell-view')?.textContent?.trim() || '') : '';
    const param = row ? (row.querySelector('td[data-field="ParamId"]  .cell-view')?.textContent?.trim() || '') : '';

    // 填入 Modal
    document.getElementById('notesViewerBody').textContent = raw;
    const titleEl = document.getElementById('notesViewerTitle');
    titleEl.textContent = [sysId, param].filter(Boolean).join(' / ');

    // 顯示 Modal
    const modal = new bootstrap.Modal(document.getElementById('notesViewerModal'));
    modal.show();
  });

  // 複製按鈕
  document.getElementById('btnCopyNotes')?.addEventListener('click', async () => {
    const txt = document.getElementById('notesViewerBody')?.textContent || '';
    try {
      await navigator.clipboard.writeText(txt);
      // 小提示（不依賴外部套件）
      const btn = document.getElementById('btnCopyNotes');
      const org = btn.innerHTML;
      btn.innerHTML = '<i class="bi bi-clipboard-check"></i> 已複製';
      setTimeout(() => btn.innerHTML = org, 1200);
    } catch {
      alert('無法複製，請手動選取文字。');
    }
  });
})();
</script>
