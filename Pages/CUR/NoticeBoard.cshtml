@page "/CUR/NoticeBoard"
@model PcbErpApi.Pages.CUR.NoticeBoardModel
@using System.Text.Json
@{
    Layout = "_Layout";
    ViewData["Title"] = "佈告欄維護";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<div class="container-fluid nb-page pt-2">

  <!-- 工具列 -->
  <div class="top-toolbar nb-toolbar">
    <div class="toolbar-icon-row" role="group">
      <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btn-first" title="第一筆"><i class="bi bi-chevron-bar-left toolbar-icon"></i></button>
      <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btn-prev"  title="上一筆"><i class="bi bi-chevron-left toolbar-icon"></i></button>
      <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btn-next"  title="下一筆"><i class="bi bi-chevron-right toolbar-icon"></i></button>
      <button type="button" class="btn toolbar-btn toolbar-btn-icon" id="btn-last"  title="最後一筆"><i class="bi bi-chevron-bar-right toolbar-icon"></i></button>
      <button type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add" id="btn-add"    title="新增"  disabled><span class="toolbar-icon">+</span></button>
      <button type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-del" id="btn-delete" title="刪除"  disabled><span class="toolbar-icon">-</span></button>
      <button type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-add toolbar-btn-check"    id="btn-save"   title="儲存"  disabled><span class="toolbar-icon">✓</span></button>
      <button type="button" class="btn toolbar-btn toolbar-btn-icon toolbar-btn-cancel toolbar-btn-check" id="btn-cancel" title="取消"  disabled><span class="toolbar-icon">&times;</span></button>
    </div>
    <div class="toolbar-main">
      <div class="d-flex gap-2 flex-wrap align-items-center">
        <div id="nb-countBox" class="toolbar-count-box mode-view">
          <div id="nb-modeLabel" class="count-line">瀏覽模式</div>
          <div id="nb-countLabel" class="count-line">0 / 0</div>
        </div>
        <button type="button" class="btn toolbar-btn" id="btn-edit">
          <i class="bi bi-pencil-square"></i>修改
        </button>
      </div>
    </div>
  </div>

  <!-- 公告維護 (Master) -->
  <div class="card shadow-sm mb-2">
    <div class="card-header nb-card-header fw-bold d-flex align-items-center gap-2">
      <span class="nb-area-indicator" id="ind-master"></span>公告維護
    </div>
    <div class="card-body p-0" style="max-height:300px;overflow:auto;">
      <table class="table table-sm table-hover table-bordered align-middle mb-0" id="tbl-master" data-dict-table="CURdNoticeBoard">
        <thead class="sticky-top nb-thead"><tr></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- 公告對象 + 主旨全文 -->
  <div class="row g-2">
    <div class="col-md-5">
      <div class="card shadow-sm h-100">
        <div class="card-header nb-card-header fw-bold d-flex align-items-center gap-2">
          <span class="nb-area-indicator" id="ind-detail"></span>公告對象
        </div>
        <div class="card-body p-0" style="max-height:220px;overflow:auto;">
          <table class="table table-sm table-bordered align-middle mb-0" id="tbl-detail" data-dict-table="CURdNoticeBoardUser">
            <thead class="sticky-top nb-thead"><tr></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-7">
      <div class="card shadow-sm h-100">
        <div class="card-header nb-card-header fw-bold">主旨全文</div>
        <div class="card-body" id="subject-full" style="min-height:220px;white-space:pre-line;font-size:.88rem;"></div>
      </div>
    </div>
  </div>

</div>

@await Html.PartialAsync("~/Pages/Shared/_FieldDictModal.cshtml", null, ViewData)

<!-- 編輯公告 Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalTitle">編輯公告</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">公告者代號</label>
            <input type="text" class="form-control" id="editPostUser">
          </div>
          <div class="col-md-8">
            <label class="form-label">主旨</label>
            <input type="text" class="form-control" id="editSubjects">
          </div>
          <div class="col-md-6">
            <label class="form-label">公告開始日</label>
            <input type="datetime-local" class="form-control" id="editBeginDate">
          </div>
          <div class="col-md-6">
            <label class="form-label">公告結束日</label>
            <input type="datetime-local" class="form-control" id="editEndDate">
          </div>
          <div class="col-12">
            <label class="form-label">主旨全文</label>
            <textarea class="form-control" rows="6" id="editBoardText"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="btn-save-edit">儲存</button>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  const masterTable = 'CURdNoticeBoard';
  const detailTable = 'CURdNoticeBoardUser';
  const masterTop   = 500;
  window._dictTableName = masterTable;
  document.body.dataset.dictTable = masterTable;

  const masterHead = document.querySelector('#tbl-master thead tr');
  const masterBody = document.querySelector('#tbl-master tbody');
  const detailHead = document.querySelector('#tbl-detail thead tr');
  const detailBody = document.querySelector('#tbl-detail tbody');
  const fullText   = document.getElementById('subject-full');
  const modeLabel  = document.getElementById('nb-modeLabel');
  const countLabel = document.getElementById('nb-countLabel');
  const countBox   = document.getElementById('nb-countBox');
  const indMaster  = document.getElementById('ind-master');
  const indDetail  = document.getElementById('ind-detail');

  const lookupCache = {};
  let masterDict       = [];
  let detailDict       = [];
  let masterRows       = [];
  let detailRows       = [];
  let currentMasterRow = null;
  let currentDetailRow = null;
  let currentTarget    = 'master';   // 'master' | 'detail'
  let isEdit           = false;
  let isNew            = false;
  let editModal;

  // 待存/待刪的 detail 列
  const pending = { toAdd: [], toDelete: [] };

  // ── 目標區域 ──────────────────────────────────────────────
  function setTarget(target) {
    currentTarget = target;
    indMaster.classList.toggle('active', target === 'master');
    indDetail.classList.toggle('active', target === 'detail');
    window._dictTableName = target === 'detail' ? detailTable : masterTable;
    document.body.dataset.dictTable = target === 'detail' ? detailTable : masterTable;
    updateCountPanel();
  }

  // ── 狀態面板 ──────────────────────────────────────────────
  function updateModePanel() {
    if (modeLabel) modeLabel.textContent = isEdit ? '編輯模式' : '瀏覽模式';
    if (countBox) {
      countBox.classList.toggle('mode-edit', isEdit);
      countBox.classList.toggle('mode-view', !isEdit);
    }
    const editBtn = document.getElementById('btn-edit');
    if (editBtn) {
      editBtn.innerHTML = isEdit
        ? '<i class="bi bi-eye"></i>瀏覽'
        : '<i class="bi bi-pencil-square"></i>修改';
    }
    updateActionButtons();
  }

  function updateActionButtons() {
    const hasPending = pending.toAdd.length > 0 || pending.toDelete.length > 0;
    document.getElementById('btn-add').disabled    = !isEdit;
    document.getElementById('btn-delete').disabled = !isEdit;
    document.getElementById('btn-save').disabled   = !(isEdit && currentTarget === 'detail' && hasPending);
    document.getElementById('btn-cancel').disabled = !isEdit;
  }

  function updateCountPanel() {
    if (!countLabel) return;
    const tbody = currentTarget === 'detail' ? detailBody : masterBody;
    const rows = Array.from(tbody?.querySelectorAll('tr') || []);
    const selected = tbody?.querySelector('tr.table-primary');
    const idx = selected ? rows.indexOf(selected) + 1 : 0;
    countLabel.textContent = `${idx} / ${rows.length}`;
  }

  // ── Lookup ────────────────────────────────────────────────
  async function loadLookupMap(f) {
    if (f.FieldName === 'ToUserId') return null;
    const defaults = { Lk_UserName: { table: 'CURdUsers', key: 'UserId', result: 'UserId,UserName' } };
    const table       = f.LookupTable       || defaults[f.FieldName]?.table;
    const keyField    = f.LookupKeyField    || defaults[f.FieldName]?.key;
    const resultField = f.LookupResultField || defaults[f.FieldName]?.result;
    const cacheKey    = `${table}|${keyField}|${resultField}|${f.FieldName}`;
    if (lookupCache[cacheKey]) return lookupCache[cacheKey];
    if (!table || !keyField || !resultField) return (lookupCache[cacheKey] = null);
    const rows = await fetch(`/api/TableFieldLayout/LookupData?table=${encodeURIComponent(table)}&key=${encodeURIComponent(keyField)}&result=${encodeURIComponent(resultField)}`).then(r => r.json());
    const map = {};
    const resultCols = rows.length ? Object.keys(rows[0]).filter(k => k.startsWith('result')) : [];
    rows.forEach(r => {
      let best = null;
      for (let i = resultCols.length - 1; i >= 0; i--) {
        const val = r[resultCols[i]];
        if (val !== null && val !== undefined && String(val).trim() !== '') { best = val; break; }
      }
      if (best === null && r.result0 !== undefined) best = r.result0;
      map[String(r.key).trim()] = best ?? '';
    });
    return (lookupCache[cacheKey] = map);
  }

  const fmtCell = (val, fmt, dataType) => {
    if (val == null || val === '') return '';
    const lt = (dataType || '').toLowerCase();
    if (lt.includes('date') || fmt?.toLowerCase().includes('yyyy')) {
      const d = new Date(val);
      if (!isNaN(d)) {
        const pad = n => String(n).padStart(2, '0');
        const hms = pad(d.getHours()) + pad(d.getMinutes()) + pad(d.getSeconds());
        const base = `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}`;
        return hms !== '000000' ? `${base} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}` : base;
      }
    }
    return String(val);
  };

  // ── Dict / Head / Body ────────────────────────────────────
  async function loadDict(table) {
    return fetch(`/api/TableFieldLayout/GetTableFieldsFull?table=${encodeURIComponent(table)}`).then(r => r.json());
  }

  function buildHead(rowEl, dict) {
    rowEl.innerHTML = '';
    dict.filter(f => (f.Visible ?? 1) === 1)
        .sort((a, b) => (a.SerialNum ?? 99999) - (b.SerialNum ?? 99999))
        .forEach(f => {
          const th = document.createElement('th');
          th.textContent = f.DisplayLabel || f.FieldName;
          const px = Number(f.DisplaySize || 0) * 10;
          if (px > 0) { th.style.width = px + 'px'; th.style.minWidth = px + 'px'; }
          rowEl.appendChild(th);
        });
  }

  async function buildBody(tbody, dict, rows, onClick) {
    tbody.innerHTML = '';
    const fields = dict.filter(f => (f.Visible ?? 1) === 1)
                       .sort((a, b) => (a.SerialNum ?? 99999) - (b.SerialNum ?? 99999));
    const lookupMaps = {};
    for (const f of fields) lookupMaps[f.FieldName] = await loadLookupMap(f);

    rows.forEach(r => {
      const tr = document.createElement('tr');
      fields.forEach(f => {
        const td = document.createElement('td');
        let raw = r[f.FieldName];
        const map = lookupMaps[f.FieldName];
        let lkv = raw;
        if ((raw == null || raw === '') && map) {
          lkv = f.FieldName === 'Lk_UserName' ? (r.PostUserId ?? r.ToUserId ?? raw)
              : f.LookupKeyField ? r[f.LookupKeyField] : raw;
        }
        const key    = lkv == null ? '' : String(lkv).trim();
        const mapped = map && key !== '' ? map[key] : null;
        let display  = mapped != null ? mapped : (raw ?? key);
        if ((display === '' || display == null) && f.FieldName?.toLowerCase().endsWith('name')) {
          const idf = f.FieldName.slice(0, -4) + 'Id';
          const ik  = (r[idf] ?? '') === '' ? '' : String(r[idf]).trim();
          display   = (lookupMaps[idf] && ik ? lookupMaps[idf][ik] : null) ?? r[idf] ?? display;
        }
        td.textContent = fmtCell(display, f.FormatStr, f.DataType);
        const px = Number(f.DisplaySize || 0) * 10;
        if (px > 0) { td.style.width = px + 'px'; td.style.minWidth = px + 'px'; }
        tr.appendChild(td);
      });
      if (onClick) tr.addEventListener('click', () => onClick(tr, r));
      tbody.appendChild(tr);
    });
  }

  // ── Master ────────────────────────────────────────────────
  async function reloadMaster(selectSerial) {
    masterRows = await fetch(`/api/CommonTable/TopRows?table=${encodeURIComponent(masterTable)}&top=${masterTop}`).then(r => r.json());
    await buildBody(masterBody, masterDict, masterRows, onMasterSelect);
    let targetTr = selectSerial != null
      ? masterBody.children[masterRows.findIndex(r => r.SerialNum == selectSerial)]
      : null;
    if (!targetTr) targetTr = masterBody.querySelector('tr');
    if (targetTr) targetTr.click();
    updateCountPanel();
  }

  async function onMasterSelect(tr, row) {
    masterBody.querySelectorAll('tr').forEach(x => x.classList.remove('table-primary'));
    tr.classList.add('table-primary');
    currentMasterRow = row;
    fullText.textContent = row.BoardText || row.Subjects || '';
    await loadDetail(row.SerialNum);
    if (currentTarget === 'master') updateCountPanel();
  }

  // ── Detail ────────────────────────────────────────────────
  async function loadDetail(serialNum) {
    detailRows = await fetch(`/api/CommonTable/ByKeys?table=${encodeURIComponent(detailTable)}&keyNames=SerialNum&keyValues=${encodeURIComponent(serialNum ?? '')}`).then(r => r.json());
    await buildBody(detailBody, detailDict, detailRows, onDetailSelect);
    if (currentTarget === 'detail') updateCountPanel();
    pending.toAdd = [];
    pending.toDelete = [];
    updateActionButtons();
  }

  function onDetailSelect(tr, row) {
    detailBody.querySelectorAll('tr').forEach(x => x.classList.remove('table-primary'));
    tr.classList.add('table-primary');
    currentDetailRow = row;
    setTarget('detail');
    updateCountPanel();
  }

  // ── Detail 新增列（inline）────────────────────────────────
  function addDetailRow() {
    if (!currentMasterRow) { alert('請先選取一筆公告'); return; }

    const fields = detailDict.filter(f => (f.Visible ?? 1) === 1)
                              .sort((a, b) => (a.SerialNum ?? 99999) - (b.SerialNum ?? 99999));
    const tr = document.createElement('tr');
    tr.classList.add('nb-row-new');
    tr.dataset.isNew = '1';

    fields.forEach(f => {
      const td = document.createElement('td');
      // 可輸入欄位（排除自動欄位 SerialNum）
      if (f.FieldName !== 'SerialNum') {
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.className = 'nb-cell-input';
        inp.dataset.field = f.FieldName;
        inp.placeholder = f.DisplayLabel || f.FieldName;
        td.appendChild(inp);
      }
      tr.appendChild(td);
    });

    tr.addEventListener('click', () => {
      detailBody.querySelectorAll('tr').forEach(x => x.classList.remove('table-primary'));
      tr.classList.add('table-primary');
      currentDetailRow = null;
      setTarget('detail');
    });

    detailBody.appendChild(tr);
    tr.querySelector('input')?.focus();
    pending.toAdd.push({ tr, serialNum: currentMasterRow.SerialNum });
    updateActionButtons();
  }

  // ── Detail 刪除列 ──────────────────────────────────────────
  function deleteDetailRow() {
    const selectedTr = detailBody.querySelector('tr.table-primary');
    if (!selectedTr) { alert('請先選取一筆公告對象'); return; }

    if (selectedTr.dataset.isNew) {
      // 移除尚未儲存的新列
      const idx = pending.toAdd.findIndex(item => item.tr === selectedTr);
      if (idx >= 0) pending.toAdd.splice(idx, 1);
      selectedTr.remove();
    } else {
      // 標記既有列待刪除
      const idx = Array.from(detailBody.children).indexOf(selectedTr);
      const row = detailRows[idx];
      if (row) {
        pending.toDelete.push(row);
        selectedTr.classList.add('nb-row-deleted');
        selectedTr.classList.remove('table-primary');
      }
    }
    currentDetailRow = null;
    updateActionButtons();
  }

  // ── Detail 儲存 ────────────────────────────────────────────
  async function saveDetailPending() {
    for (const item of pending.toAdd) {
      // 收集各 input 值
      const data = { SerialNum: item.serialNum };
      item.tr.querySelectorAll('input[data-field]').forEach(inp => {
        data[inp.dataset.field] = inp.value?.trim() ?? '';
      });
      // 至少 ToUserId 需要有值
      const hasValue = Object.entries(data).some(([k, v]) => k !== 'SerialNum' && v !== '');
      if (!hasValue) continue;
      const res = await fetch('/api/CommonTable/SaveTableChanges', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ TableName: detailTable, KeyFields: ['SerialNum', 'ToUserId'], Data: [data] })
      });
      if (!res.ok) { alert('新增失敗：' + res.status); return; }
    }
    for (const row of pending.toDelete) {
      const url = `/api/CommonTable/DeleteByKeys?table=${encodeURIComponent(detailTable)}&keyNames=SerialNum&keyNames=ToUserId&keyValues=${encodeURIComponent(row.SerialNum)}&keyValues=${encodeURIComponent(row.ToUserId)}`;
      const res = await fetch(url, { method: 'DELETE' });
      if (!res.ok) { alert('刪除失敗：' + res.status); return; }
    }
    await loadDetail(currentMasterRow?.SerialNum);
  }

  // ── Detail 取消 ────────────────────────────────────────────
  async function cancelDetailPending() {
    pending.toAdd.forEach(item => item.tr.remove());
    if (pending.toDelete.length > 0) await loadDetail(currentMasterRow?.SerialNum);
    else {
      pending.toAdd = [];
      pending.toDelete = [];
      detailBody.querySelectorAll('.nb-row-deleted').forEach(tr => tr.classList.remove('nb-row-deleted'));
      updateActionButtons();
    }
  }

  // ── Master 刪除 ────────────────────────────────────────────
  async function deleteMasterRow() {
    if (!currentMasterRow) { alert('請先選取一筆公告'); return; }
    if (!confirm(`確定要刪除「${currentMasterRow.Subjects || currentMasterRow.SerialNum}」嗎？`)) return;
    const url = `/api/CommonTable/DeleteByKeys?table=${encodeURIComponent(masterTable)}&keyNames=SerialNum&keyValues=${encodeURIComponent(currentMasterRow.SerialNum)}`;
    const res = await fetch(url, { method: 'DELETE' });
    if (!res.ok) { alert('刪除失敗：' + res.status); return; }
    currentMasterRow = null;
    await reloadMaster();
  }

  // ── 編輯 Modal ────────────────────────────────────────────
  function openEditModal(row, isNewRecord) {
    isNew = !!isNewRecord;
    document.getElementById('editModalTitle').textContent = isNew ? '新增公告' : '編輯公告';
    document.getElementById('editPostUser') .value = row?.PostUserId ?? '';
    document.getElementById('editSubjects') .value = row?.Subjects   ?? '';
    document.getElementById('editBeginDate').value = toInputDateTime(row?.BeginDate);
    document.getElementById('editEndDate')  .value = toInputDateTime(row?.EndDate);
    document.getElementById('editBoardText').value = row?.BoardText  ?? '';
    editModal.show();
  }

  async function onSaveEdit() {
    const data = {
      PostUserId: document.getElementById('editPostUser') .value?.trim(),
      Subjects:   document.getElementById('editSubjects') .value ?? '',
      BeginDate:  document.getElementById('editBeginDate').value || null,
      EndDate:    document.getElementById('editEndDate')  .value || null,
      BoardText:  document.getElementById('editBoardText').value ?? ''
    };
    if (!isNew && currentMasterRow?.SerialNum != null) data.SerialNum = currentMasterRow.SerialNum;
    const res = await fetch('/api/CommonTable/SaveTableChanges', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ TableName: masterTable, KeyFields: ['SerialNum'], Data: [data] })
    });
    if (!res.ok) { alert('儲存失敗：' + res.status); return; }
    const result = await res.json();
    if (result.success) { editModal.hide(); await reloadMaster(isNew ? null : currentMasterRow?.SerialNum); }
    else alert('儲存失敗：' + JSON.stringify(result));
  }

  // ── 導航 ──────────────────────────────────────────────────
  function navigateRow(direction) {
    const tbody = currentTarget === 'detail' ? detailBody : masterBody;
    const rows  = Array.from(tbody?.querySelectorAll('tr') || []);
    if (!rows.length) return;
    const cur = tbody.querySelector('tr.table-primary');
    let idx = cur ? rows.indexOf(cur) : -1;
    switch (direction) {
      case 'first': idx = 0; break;
      case 'prev':  idx = Math.max(0, idx - 1); break;
      case 'next':  idx = Math.min(rows.length - 1, idx + 1); break;
      case 'last':  idx = rows.length - 1; break;
    }
    if (rows[idx]) rows[idx].click();
  }

  function toInputDateTime(val) {
    if (!val) return '';
    const d = new Date(val);
    if (isNaN(d)) return '';
    const pad = n => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  // ── 初始化 ────────────────────────────────────────────────
  async function init() {
    masterDict = await loadDict(masterTable);
    detailDict = await loadDict(detailTable);
    buildHead(masterHead, masterDict);
    buildHead(detailHead, detailDict);
    await reloadMaster();

    editModal = new bootstrap.Modal(document.getElementById('editModal'));

    // 修改 / 瀏覽 切換
    document.getElementById('btn-edit').addEventListener('click', () => {
      isEdit = !isEdit;
      if (!isEdit) { cancelDetailPending(); }
      updateModePanel();
    });

    // 取消
    document.getElementById('btn-cancel').addEventListener('click', async () => {
      const hasPending = pending.toAdd.length > 0 || pending.toDelete.length > 0;
      if (currentTarget === 'detail' && hasPending) {
        await cancelDetailPending();
      } else {
        isEdit = false;
        updateModePanel();
      }
    });

    // 新增
    document.getElementById('btn-add').addEventListener('click', () => {
      if (!isEdit) return;
      if (currentTarget === 'master') openEditModal(null, true);
      else addDetailRow();
    });

    // 刪除
    document.getElementById('btn-delete').addEventListener('click', () => {
      if (!isEdit) return;
      if (currentTarget === 'master') deleteMasterRow();
      else deleteDetailRow();
    });

    // 儲存（detail 專用）
    document.getElementById('btn-save').addEventListener('click', () => {
      if (currentTarget === 'detail') saveDetailPending();
    });

    // 導航
    document.getElementById('btn-first').addEventListener('click', () => navigateRow('first'));
    document.getElementById('btn-prev') .addEventListener('click', () => navigateRow('prev'));
    document.getElementById('btn-next') .addEventListener('click', () => navigateRow('next'));
    document.getElementById('btn-last') .addEventListener('click', () => navigateRow('last'));

    // 雙擊 master 列 → 開啟編輯 Modal（編輯模式下）
    masterBody.addEventListener('dblclick', e => {
      const tr = e.target.closest('tr');
      if (!tr || !isEdit) return;
      const idx = Array.from(masterBody.children).indexOf(tr);
      if (idx >= 0 && masterRows[idx]) openEditModal(masterRows[idx], false);
    });

    // 點擊 master 區域 → 切換 target
    document.getElementById('tbl-master').addEventListener('click', () => {
      if (currentTarget !== 'master') setTarget('master');
    });

    // 點擊 detail 區域 → 切換 target
    document.getElementById('tbl-detail').addEventListener('click', () => {
      if (currentTarget !== 'detail') setTarget('detail');
    });

    // F3 → 更新 dictTableName，讓 fieldDictModal 取到正確的 table
    document.addEventListener('keydown', e => {
      if (e.key === 'F3') {
        window._dictTableName = currentTarget === 'detail' ? detailTable : masterTable;
        document.body.dataset.dictTable = window._dictTableName;
      }
    });

    document.getElementById('btn-save-edit').addEventListener('click', onSaveEdit);

    setTarget('master');
    updateModePanel();
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>

<script src="~/js/fieldDictModal.js" asp-append-version="true"></script>

<style>
/* ── 工具列 ─────────────────────────────────────────────── */
.top-toolbar {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  width: 100%;
  border-radius: 10px;
  background: #f6f7f9;
  border: 1px solid #d8dee8;
  padding: 6px 8px;
  box-shadow: 0 1px 2px rgba(20,40,80,.06);
  margin-bottom: 8px;
}
.top-toolbar .toolbar-icon-row { display:flex; gap:4px; align-items:center; }
.top-toolbar .toolbar-main { display:flex; align-items:center; gap:6px; flex:1 1 0; min-width:0; }
.toolbar-btn {
  display: inline-flex; align-items: center; gap: 4px;
  background: #fff; color: #2a4a7a;
  border: 1px solid #b9c7de; border-radius: 11px;
  font-size: .85rem; font-weight: 500;
  height: 36px; min-height: 36px; padding: 0 8px; line-height: 1;
  cursor: pointer; transition: background .15s, border-color .15s;
}
.toolbar-btn:hover { background:#eef3fb; border-color:#9fb2d2; }
.toolbar-btn:disabled { background:#f1f3f7!important; border-color:#c5ccd8!important; color:#9aa7bb!important; cursor:not-allowed; opacity:.8; }
.toolbar-btn-icon { width:30px; padding:0; border-radius:8px; font-size:20px; justify-content:center; }
.toolbar-icon { display:inline-block; font-size:20px; line-height:1; }
.toolbar-btn-icon i { font-size:20px; line-height:1; }
.toolbar-btn-icon.toolbar-btn-add:not(:disabled) { background:#f7fcf9; border-color:#7ccfa1; color:#1f7a45; }
.toolbar-btn-icon.toolbar-btn-del:not(:disabled),
.toolbar-btn-icon.toolbar-btn-cancel:not(:disabled) { background:#fff4f4; border-color:#e08a8a; color:#b33939; }
.toolbar-btn-check { font-size:18px; }
.toolbar-count-box {
  display:inline-flex; flex-direction:column; justify-content:center; align-items:center;
  min-width:64px; padding:4px 10px; border-radius:6px;
  font-weight:600; line-height:1.15; user-select:none;
}
.toolbar-count-box .count-line { font-size:.72rem; }
.toolbar-count-box .count-line:first-child { font-size:.68rem; opacity:.85; }
.toolbar-count-box.mode-view { background:#1e4db7; color:#fff; }
.toolbar-count-box.mode-edit { background:#f00000; color:#fff; }

/* ── 區域指示燈 ──────────────────────────────────────────── */
.nb-area-indicator {
  display: inline-block; width:8px; height:8px;
  border-radius: 50%; background:#ccc; flex-shrink:0;
  transition: background .2s;
}
.nb-area-indicator.active { background:#0d6efd; box-shadow:0 0 6px #0d6efd; }

/* ── 卡片標題 ────────────────────────────────────────────── */
.nb-card-header { font-size:.82rem; padding:4px 10px; }

/* ── 表格列高 ────────────────────────────────────────────── */
#tbl-master th, #tbl-master td,
#tbl-detail th, #tbl-detail td {
  white-space: nowrap;
  padding: 0.15rem 0.4rem;
  font-size: 0.82rem;
}

/* ── 表頭 ────────────────────────────────────────────────── */
.nb-thead th { background:#f0f4f8; color:#334155; position:sticky; top:0; z-index:2; }

/* ── Detail inline 新增列 ────────────────────────────────── */
.nb-row-new td { background:#fffbea !important; }
.nb-cell-input {
  width: 100%; border: none; border-bottom: 1px solid #aab;
  padding: 0 4px; height: 20px; font-size: .82rem;
  background: transparent; outline: none;
}
.nb-cell-input:focus { border-bottom-color: #1e4db7; background:#f0f6ff; }

/* ── Detail 待刪除列 ─────────────────────────────────────── */
.nb-row-deleted td {
  background: #fff0f0 !important;
  text-decoration: line-through;
  color: #999;
}
</style>
