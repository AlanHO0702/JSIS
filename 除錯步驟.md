# PCB 圖檔功能除錯步驟

## 🔍 問題現象
- ✅ 測試端點正常：`http://localhost:5290/test/panel`
- ❌ API 端點錯誤：`http://localhost:5290/api/mappreview/A01470005A/0/panel`
  - 返回佔位圖「無圖形資料 A01470005A/0/裁板圖」
- ❌ 分析端點錯誤：`http://localhost:5290/api/mappreview/analyze/A01470005A/0/panel`
  - 返回 `{"error":"MapData not found"}`

## 📋 除錯步驟

### 步驟 1：檢查資料庫資料是否存在

請執行以下 SQL 查詢：

```sql
-- 1. 檢查 EMOdProdMap 表是否有資料
SELECT COUNT(*) as TotalRecords FROM EMOdProdMap

-- 2. 查看前 10 筆資料
SELECT TOP 10
    PartNum,
    Revision,
    MapKindNo,
    SerialNum,
    MapName,
    LEN(MapData) as MapDataLength
FROM EMOdProdMap
ORDER BY PartNum, Revision

-- 3. 檢查特定料號是否存在
SELECT *
FROM EMOdProdMap
WHERE PartNum = 'A01470005A' AND Revision = '0'

-- 4. 如果上面沒有資料，嘗試模糊搜尋
SELECT TOP 10
    PartNum,
    Revision,
    MapKindNo,
    LEN(MapData) as MapDataLength
FROM EMOdProdMap
WHERE PartNum LIKE '%A01470005A%'
   OR PartNum LIKE '%01470005%'

-- 5. 列出所有 A 開頭的料號
SELECT TOP 20
    PartNum,
    Revision,
    MapKindNo,
    LEN(MapData) as MapDataLength
FROM EMOdProdMap
WHERE PartNum LIKE 'A%'
ORDER BY PartNum
```

### 步驟 2：確認資料格式

```sql
-- 查看 MapData 的前 500 個字元
SELECT TOP 1
    PartNum,
    Revision,
    MapKindNo,
    LEFT(MapData, 500) as MapDataSample,
    LEN(MapData) as TotalLength
FROM EMOdProdMap
WHERE MapData IS NOT NULL
  AND LEN(MapData) > 0
```

### 步驟 3：檢查表結構

```sql
-- 確認表結構
SELECT
    COLUMN_NAME,
    DATA_TYPE,
    CHARACTER_MAXIMUM_LENGTH,
    IS_NULLABLE
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'EMOdProdMap'
ORDER BY ORDINAL_POSITION
```

### 步驟 4：可能的問題

#### 問題 A：資料不存在
**症狀**：SQL 查詢返回 0 筆記錄

**解決方式**：
1. 確認您使用的料號和版次是否正確
2. 檢查是否連接到正確的資料庫
3. 使用其他已知存在的料號測試

#### 問題 B：欄位名稱不匹配
**症狀**：SQL 查詢報錯「Invalid column name」

**可能的欄位名稱**：
- `PartNum` 或 `PARTNUM` 或 `part_num`
- `Revision` 或 `REV` 或 `REVISION`
- `MapKindNo` 或 `MAP_KIND_NO` 或 `MapType`

**檢查方式**：
```sql
-- 列出所有欄位名稱
SELECT COLUMN_NAME
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'EMOdProdMap'
```

#### 問題 C：表名稱不匹配
**症狀**：SQL 查詢報錯「Invalid object name 'EMOdProdMap'」

**可能的表名稱**：
- `EMOdProdMap`
- `EMOD_PROD_MAP`
- `EmodProdMap`
- `dbo.EMOdProdMap`

**檢查方式**：
```sql
-- 列出所有表名
SELECT TABLE_SCHEMA, TABLE_NAME
FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_NAME LIKE '%Prod%Map%'
   OR TABLE_NAME LIKE '%EMO%'
```

#### 問題 D：主鍵欄位不匹配
**症狀**：有資料但查詢查不到

**檢查主鍵**：
```sql
-- 查看主鍵定義
SELECT
    KCU.COLUMN_NAME,
    KCU.ORDINAL_POSITION
FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE KCU
JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS TC
    ON KCU.CONSTRAINT_NAME = TC.CONSTRAINT_NAME
WHERE TC.TABLE_NAME = 'EMOdProdMap'
  AND TC.CONSTRAINT_TYPE = 'PRIMARY KEY'
ORDER BY KCU.ORDINAL_POSITION
```

### 步驟 5：使用正確的料號測試

從步驟 1 的查詢結果中，選擇一個**實際存在**的料號和版次，例如：

假設查詢結果顯示：
```
PartNum      | Revision | MapKindNo | MapDataLength
-------------|----------|-----------|---------------
TEST001      | A        | 1         | 1234
TEST001      | A        | 3         | 567
B12345       | 0        | 1         | 8901
```

則使用以下 URL 測試：
```
http://localhost:5290/api/mappreview/TEST001/A/panel
http://localhost:5290/api/mappreview/B12345/0/panel
```

### 步驟 6：檢查應用程式日誌

如果您正在執行應用程式，查看控制台輸出中的日誌訊息：

應該會看到類似以下的訊息：
```
info: PcbErpApi.Services.MapService[0]
      Querying MapData: PartNum=A01470005A, Revision=0, MapKind=1
info: PcbErpApi.Services.MapService[0]
      Record exists for PartNum/Revision: False
warn: PcbErpApi.Services.MapService[0]
      No data found. Available records: TEST001/A/1, TEST001/A/3, ...
```

這會告訴您：
1. 查詢的參數是什麼
2. 資料是否存在
3. 有哪些可用的資料

## 🎯 建議的測試流程

1. **執行步驟 1 的 SQL 查詢**
   - 確認資料表有資料
   - 找到一個實際存在的料號

2. **使用實際存在的料號測試**
   ```
   http://localhost:5290/api/mappreview/{實際料號}/{實際版次}/panel
   ```

3. **如果仍然失敗**
   - 執行步驟 3 檢查表結構
   - 執行步驟 4 的檢查清單
   - 比對欄位名稱是否匹配

4. **更新程式碼（如果需要）**
   - 如果欄位名稱不同，需要修改 `EmodProdMap.cs`
   - 如果表名稱不同，需要修改 `PcbErpContext.cs`

## 📝 回報問題時請提供

1. **SQL 查詢結果**
   ```sql
   SELECT TOP 5 PartNum, Revision, MapKindNo, LEN(MapData) as Len
   FROM EMOdProdMap
   ```

2. **表結構**
   ```sql
   SELECT COLUMN_NAME, DATA_TYPE
   FROM INFORMATION_SCHEMA.COLUMNS
   WHERE TABLE_NAME = 'EMOdProdMap'
   ```

3. **測試的 URL**
   ```
   http://localhost:5290/api/mappreview/???/???/panel
   ```

4. **應用程式日誌**（如果有的話）

## 💡 快速驗證腳本

執行以下完整的驗證腳本：

```sql
-- ===== 完整驗證腳本 =====

PRINT '===== 1. 檢查表是否存在 ====='
IF OBJECT_ID('EMOdProdMap', 'U') IS NOT NULL
    PRINT '✓ 表 EMOdProdMap 存在'
ELSE
    PRINT '✗ 表 EMOdProdMap 不存在'

PRINT ''
PRINT '===== 2. 記錄數量 ====='
SELECT COUNT(*) as TotalRecords FROM EMOdProdMap

PRINT ''
PRINT '===== 3. 前 5 筆資料 ====='
SELECT TOP 5
    PartNum,
    Revision,
    MapKindNo,
    SerialNum,
    LEN(MapData) as MapDataLength
FROM EMOdProdMap

PRINT ''
PRINT '===== 4. MapKindNo 分布 ====='
SELECT
    MapKindNo,
    COUNT(*) as Count
FROM EMOdProdMap
GROUP BY MapKindNo
ORDER BY MapKindNo

PRINT ''
PRINT '===== 5. 有 MapData 的記錄數 ====='
SELECT COUNT(*) as RecordsWithMapData
FROM EMOdProdMap
WHERE MapData IS NOT NULL AND LEN(MapData) > 0

PRINT ''
PRINT '===== 6. MapData 範例 ====='
SELECT TOP 1
    PartNum,
    Revision,
    MapKindNo,
    LEFT(MapData, 200) as MapDataSample
FROM EMOdProdMap
WHERE MapData IS NOT NULL AND LEN(MapData) > 0
```

執行這個腳本後，您會得到完整的診斷資訊！
